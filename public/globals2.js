var org;(function(org){var ssatguru;(function(ssatguru){var babylonjs;(function(babylonjs){var component;(function(component){var Axis=BABYLON.Axis;var Color3=BABYLON.Color3;var Matrix=BABYLON.Matrix;var Mesh=BABYLON.Mesh;var MeshBuilder=BABYLON.MeshBuilder;var Path2=BABYLON.Path2;var Quaternion=BABYLON.Quaternion;var Space=BABYLON.Space;var StandardMaterial=BABYLON.StandardMaterial;var Vector3=BABYLON.Vector3;var ActionType;(function(ActionType){ActionType[ActionType["TRANS"]=0]="TRANS";ActionType[ActionType["ROT"]=1]="ROT";ActionType[ActionType["SCALE"]=2]="SCALE";})(ActionType||(ActionType={}));/**
                 * Draws a transform widget at the mesh's location (its pivot location).
                 * The widget transforms(translates,rotates and scales) the mesh based on user
                 * interactions with the widget.
                 * The widget shows the mesh position and rotation at any time.
                 * The widget follows the mesh constantly.
                 * Note: An alternate approach would have been for the mesh to follow the widget.
                 * The problem with the alternate approach - syncing the transforms
                 * if the mesh was being transformed by entities other than the widget say physics
                 * or script for example.
                 *
                 */var EditControl=function(){//lhs-rhs issue. lhs mesh in rhs or rhs mesh in lhs
//private lhsRhs: boolean=false;
function EditControl(mesh,camera,canvas,scale,eulerian,pickWidth){var _this=this;this._local=true;this._snapT=false;this._snapR=false;this._transSnap=1;this._rotSnap=Math.PI/18;this._axesLen=0.4;this._axesScale=1;//how close to an axis should we get before we can pick it 
this._pickWidth=0.02;//axes visibility
this._visibility=0.75;this._ecMatrix=new Matrix();//edit control to camera vector
this._ecTOcamera=new Vector3(0,0,0);//how far away from camera should the edit control appear to be
this._distFromCamera=2;//vector from camera to edit control
this._cameraTOec=new Vector3(0,0,0);this._cameraNormal=new Vector3(0,0,0);this._prevState="";this._hidden=false;this._actionListener=null;this._actionStartListener=null;this._actionEndListener=null;this._pDown=false;this._pointerIsOver=false;this._editing=false;//rotate differently if camera is too close to the rotation plane
this._rotate2=false;this._transBy=new Vector3(0,0,0);this._snapTV=new Vector3(0,0,0);this._snapS=false;this._snapSV=new Vector3(0,0,0);this._scaleSnap=0.25;this._scale=new Vector3(0,0,0);this._localX=new Vector3(0,0,0);this._localY=new Vector3(0,0,0);this._localZ=new Vector3(0,0,0);this._eulerian=false;this._snapRA=0;this._transEnabled=false;this._rotEnabled=false;this._scaleEnabled=false;this._guideSize=180;this._tSnap=new Vector3(this._transSnap,this._transSnap,this._transSnap);//few temp vectors & matrix
this._tv1=new Vector3(0,0,0);this._tv2=new Vector3(0,0,0);this._tv3=new Vector3(0,0,0);this._tm=new Matrix();this._mesh=mesh;this._mainCamera=camera;this._canvas=canvas;if(scale!=null){this._axesScale=scale;}if(eulerian!==null){this._eulerian=eulerian;}else{this._eulerian=false;}this._checkQuaternion();if(pickWidth!=null){this._pickWidth=pickWidth;}this._scene=mesh.getScene();this._actHist=new ActHist(mesh,10);mesh.computeWorldMatrix(true);// Matteo ----------------------------
//this._centerMeshPivot(mesh);
// -----------------------------------
this._boundingDimesion=this._getBoundingDimension(mesh);this._setLocalAxes(mesh);//this.lhsRhs=this.check_LHS_RHS(mesh);
//build the edit control axes
this._ecRoot=new Mesh("EditControl",this._scene);this._ecRoot.metadata={isEditControl:true,isRealMesh:false};this._ecRoot.rotationQuaternion=Quaternion.Identity();this._ecRoot.visibility=0;this._ecRoot.isPickable=false;this._createMaterials(this._scene);var guideAxes=this._createCommonAxes();guideAxes.parent=this._ecRoot;guideAxes.metadata={isEditControl:true,isRealMesh:false};//build the pickplanes
var pickPlanes=this._createPickPlanes();pickPlanes.parent=this._ecRoot;pickPlanes.metadata={isEditControl:true,isRealMesh:false};this._pointerdown=function(evt){return _this._onPointerDown(evt);};this._pointerup=function(evt){return _this._onPointerUp(evt);};this._pointermove=function(evt){return _this._onPointerMove(evt);};//use canvas rather than scene to handle pointer events
//scene cannot have mutiple eventlisteners for an event
//with canvas one will have to do ones own pickinfo generattion.
canvas.addEventListener("pointerdown",this._pointerdown,false);canvas.addEventListener("pointerup",this._pointerup,false);canvas.addEventListener("pointermove",this._pointermove,false);this._renderer=function(){return _this._renderLoopProcess();};this._scene.registerBeforeRender(this._renderer);}// Test Matteo
EditControl.prototype._centerMeshPivot=function(mesh){var center=this._getMeshHierarchyCenter(mesh);if(center){//set pivot
var pivotAt=center.clone();var translation=mesh.position.subtract(pivotAt);mesh.setPivotMatrix(BABYLON.Matrix.Translation(translation.x,translation.y,translation.z));//mesh.setPivotMatrix(BABYLON.Matrix.Translation(-center.x, -center.y, -center.z));
}};EditControl.prototype._getMeshHierarchyCenter=function(mesh){if(mesh){var boundingBox=mesh.getHierarchyBoundingVectors(true);var size=boundingBox.max.subtract(boundingBox.min);var center=boundingBox.min.add(size.scale(0.5));return center;}return null;};// -----------------------------------------------------------------
//make sure that if eulerian is set to false then mesh's rotation is in quaternion
//throw error and exit if not so.
EditControl.prototype._checkQuaternion=function(){if(!this._eulerian){if(this._mesh.rotationQuaternion==null||this._mesh.rotationQuaternion==undefined){throw"Error: Eulerian is set to false but the mesh's rotationQuaternion is not set.";}}};EditControl.prototype._renderLoopProcess=function(){//sync the edit control position and rotation with that of mesh
this._ecRoot.position=this._mesh.getAbsolutePivotPoint();this._setECRotation();//scale the EditControl so it seems at the same distance from camera/user
this._setECScale();//rotate the free move,rotate,scale pick plane to face the camera/user
if(this._local){this._ecRoot.getWorldMatrix().invertToRef(this._ecMatrix);Vector3.TransformCoordinatesToRef(this._mainCamera.position,this._ecMatrix,this._ecTOcamera);//note pALL is child of ecRoot hence lookAt in local space
this._pALL.lookAt(this._ecTOcamera,0,0,0,Space.LOCAL);}else{this._mainCamera.position.subtractToRef(this._ecRoot.position,this._ecTOcamera);this._pALL.lookAt(this._mainCamera.position,0,0,0,Space.WORLD);}//rotate the rotation and planar guide to face the camera/user
if(this._rotEnabled){this._rotRotGuides();}else if(this._transEnabled)this._rotPlanarGuides(this._tXZ,this._tZY,this._tYX);else if(this._scaleEnabled)this._rotPlanarGuides(this._sXZ,this._sZY,this._sYX);//check pointer over axes only during pointer moves
//this.onPointerOver();
};/**
                     * sets rotaion of edit control to that of the mesh
                     */EditControl.prototype._setECRotation=function(){if(this._local){if(this._mesh.parent==null){if(this._eulerian){var rot=this._mesh.rotation;Quaternion.RotationYawPitchRollToRef(rot.y,rot.x,rot.z,this._ecRoot.rotationQuaternion);}else{this._ecRoot.rotationQuaternion.copyFrom(this._mesh.rotationQuaternion);}}else{if(this._isScaleUnEqual(this._mesh))return;this._mesh.getWorldMatrix().getRotationMatrixToRef(this._tm);Quaternion.FromRotationMatrixToRef(this._tm,this._ecRoot.rotationQuaternion);//this._ecRoot.rotationQuaternion.normalize();
}}};/**
                     * checks if any of the mesh's ancestors has non uniform scale
                     */EditControl.prototype._isScaleUnEqual=function(mesh){if(mesh.parent==null)return false;while(mesh.parent!=null){if(mesh.parent.scaling.x!=mesh.parent.scaling.y||mesh.parent.scaling.y!=mesh.parent.scaling.z){return true;}else{mesh=mesh.parent;}}return false;};EditControl.prototype._setECScale=function(){this._ecRoot.position.subtractToRef(this._mainCamera.position,this._cameraTOec);Vector3.FromFloatArrayToRef(this._mainCamera.getWorldMatrix().asArray(),8,this._cameraNormal);//get distance of edit control from the camera plane 
//project "camera to edit control" vector onto the camera normal
var parentOnNormal=Vector3.Dot(this._cameraTOec,this._cameraNormal)/this._cameraNormal.length();var s=Math.abs(parentOnNormal/this._distFromCamera);Vector3.FromFloatsToRef(s,s,s,this._ecRoot.scaling);//Vector3.FromFloatsToRef(s,s,s,this.pALL.scaling);
};//rotate the rotation guides so that they are facing the camera
EditControl.prototype._rotRotGuides=function(){var rotX=Math.atan(this._ecTOcamera.y/this._ecTOcamera.z);if(this._ecTOcamera.z>=0){this._rX.rotation.x=-rotX;}else{this._rX.rotation.x=-rotX-Math.PI;}var rotY=Math.atan(this._ecTOcamera.x/this._ecTOcamera.z);if(this._ecTOcamera.z>=0){this._rY.rotation.y=rotY;}else{this._rY.rotation.y=rotY+Math.PI;}var rotZ=Math.atan(this._ecTOcamera.x/this._ecTOcamera.y);if(this._ecTOcamera.y>=0){this._rZ.rotation.z=-rotZ;}else{this._rZ.rotation.z=-rotZ-Math.PI;}};/**
                     * rotate the planar guide so that they are facing the camera
                     */EditControl.prototype._rotPlanarGuides=function(XZ,ZY,YX){var ec=this._ecTOcamera;XZ.rotation.x=0;XZ.rotation.y=0;XZ.rotation.z=0;ZY.rotation.x=0;ZY.rotation.y=0;ZY.rotation.z=0;YX.rotation.x=0;YX.rotation.y=0;YX.rotation.z=0;if(ec.x<=0&&ec.y>=0&&ec.z>=0){XZ.rotation.z=3.14;YX.rotation.y=3.14;}else if(ec.x<=0&&ec.y>=0&&ec.z<=0){XZ.rotation.y=3.14;ZY.rotation.y=3.14;YX.rotation.y=3.14;}else if(ec.x>=0&&ec.y>=0&&ec.z<=0){XZ.rotation.x=3.14;ZY.rotation.y=3.14;}else if(ec.x>=0&&ec.y<=0&&ec.z>=0){ZY.rotation.z=3.14;YX.rotation.x=3.14;}else if(ec.x<=0&&ec.y<=0&&ec.z>=0){XZ.rotation.z=3.14;ZY.rotation.z=3.14;YX.rotation.z=3.14;}else if(ec.x<=0&&ec.y<=0&&ec.z<=0){XZ.rotation.y=3.14;ZY.rotation.x=3.14;YX.rotation.z=3.14;}else if(ec.x>=0&&ec.y<=0&&ec.z<=0){XZ.rotation.x=3.14;ZY.rotation.x=3.14;YX.rotation.x=3.14;}};EditControl.prototype.switchTo=function(mesh,eulerian){mesh.computeWorldMatrix(true);this._mesh=mesh;if(eulerian!=null){this._eulerian=eulerian;}this._checkQuaternion();this._setLocalAxes(mesh);this._actHist=new ActHist(mesh,10);this.refreshBoundingInfo();};EditControl.prototype.setUndoCount=function(c){this._actHist.setCapacity(c);};EditControl.prototype.undo=function(){var at=this._actHist.undo();this._mesh.computeWorldMatrix(true);this._setLocalAxes(this._mesh);this._callActionStartListener(at);this._callActionListener(at);this._callActionEndListener(at);};EditControl.prototype.redo=function(){var at=this._actHist.redo();this._mesh.computeWorldMatrix(true);this._setLocalAxes(this._mesh);this._callActionStartListener(at);this._callActionListener(at);this._callActionEndListener(at);};/**
                     * detach the edit control from the mesh and dispose off all
                     * resources created by the edit control
                     */EditControl.prototype.detach=function(){this._canvas.removeEventListener("pointerdown",this._pointerdown,false);this._canvas.removeEventListener("pointerup",this._pointerup,false);this._canvas.removeEventListener("pointermove",this._pointermove,false);this._scene.unregisterBeforeRender(this._renderer);this.removeAllActionListeners();this._disposeAll();};/**
                     * hide the edit control. use show() to unhide the control.
                     */EditControl.prototype.hide=function(){this._hidden=true;if(this._transEnabled){this._prevState="T";this.disableTranslation();}else if(this._rotEnabled){this._prevState="R";this.disableRotation();}else if(this._scaleEnabled){this._prevState="S";this.disableScaling();}this._hideCommonAxes();};EditControl.prototype._hideCommonAxes=function(){this._xaxis.visibility=0;this._yaxis.visibility=0;this._zaxis.visibility=0;};EditControl.prototype._showCommonAxes=function(){this._xaxis.visibility=this._visibility;this._yaxis.visibility=this._visibility;this._zaxis.visibility=this._visibility;};/**
                     * unhide the editcontrol hidden using the hide() method
                     */EditControl.prototype.show=function(){this._hidden=false;this._showCommonAxes();if(this._prevState=="T")this.enableTranslation();else if(this._prevState=="R")this.enableRotation();else if(this._prevState=="S")this.enableScaling();};/**
                     * check if the editcontrol was hidden using the hide() methods
                     */EditControl.prototype.isHidden=function(){return this._hidden;};EditControl.prototype._disposeAll=function(){this._ecRoot.dispose();this._disposeMaterials();this._actHist=null;};EditControl.prototype.addActionListener=function(actionListener){this._actionListener=actionListener;};EditControl.prototype.removeActionListener=function(){this._actionListener=null;};EditControl.prototype.addActionStartListener=function(actionStartListener){this._actionStartListener=actionStartListener;};EditControl.prototype.removeActionStartListener=function(){this._actionStartListener=null;};EditControl.prototype.addActionEndListener=function(actionEndListener){this._actionEndListener=actionEndListener;};EditControl.prototype.removeActionEndListener=function(){this._actionEndListener=null;};EditControl.prototype.removeAllActionListeners=function(){this._actionListener=null;this._actionStartListener=null;this._actionEndListener=null;};EditControl.prototype._onPointerDown=function(evt){var _this=this;evt.preventDefault();this._pDown=true;if(evt.button!=0)return;//TODO: do we really need to do a pick here?
//onPointerOver() has already done this.
var pickResult=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(mesh){if(_this._transEnabled){if(mesh==_this._tX||mesh==_this._tY||mesh==_this._tZ||mesh==_this._tXZ||mesh==_this._tZY||mesh==_this._tYX||mesh==_this._tAll)return true;}else if(_this._rotEnabled){if(mesh==_this._rX||mesh==_this._rY||mesh==_this._rZ||mesh==_this._rAll)return true;}else if(_this._scaleEnabled){if(mesh==_this._sX||mesh==_this._sY||mesh==_this._sZ||mesh==_this._sXZ||mesh==_this._sZY||mesh==_this._sYX||mesh==_this._sAll)return true;}return false;},null,this._mainCamera);if(pickResult.hit){//this.setAxesVisiblity(0);
this._axisPicked=pickResult.pickedMesh;var childs=this._axisPicked.getChildren();if(childs.length>0){childs[0].visibility=this._visibility;}else{this._axisPicked.visibility=this._visibility;}var name_1=this._axisPicked.name;if(name_1=="X")this._bXaxis.visibility=1;else if(name_1=="Y")this._bYaxis.visibility=1;else if(name_1=="Z")this._bZaxis.visibility=1;else if(name_1=="XZ"){this._bXaxis.visibility=1;this._bZaxis.visibility=1;}else if(name_1=="ZY"){this._bZaxis.visibility=1;this._bYaxis.visibility=1;}else if(name_1=="YX"){this._bYaxis.visibility=1;this._bXaxis.visibility=1;}else if(name_1=="ALL"){this._bXaxis.visibility=1;this._bYaxis.visibility=1;this._bZaxis.visibility=1;}this._setEditing(true);//lets find out where we are on the pickplane
this._pickedPlane=this._getPickPlane(this._axisPicked);if(this._pickedPlane!=null){this._prevPos=this._getPosOnPickPlane();}else{this._prevPos=null;}window.setTimeout(function(cam,can){return _this._detachCamera(cam,can);},0,this._mainCamera,this._canvas);}};EditControl.prototype._setEditing=function(editing){this._editing=editing;if(editing){this._setActionType();if(this._actionType==ActionType.ROT){this._snapRA=0;}this._callActionStartListener(this._actionType);}else{this._callActionEndListener(this._actionType);}};EditControl.prototype.isEditing=function(){return this._editing;};/**
                     * no camera movement during edit
                     */EditControl.prototype._detachCamera=function(cam,can){var camera=cam;var canvas=can;camera.detachControl(canvas);};EditControl.prototype.isPointerOver=function(){return this._pointerIsOver;};EditControl.prototype._onPointerOver=function(){var _this=this;//if(this.pDown) return;
var pickResult=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(mesh){if(_this._transEnabled){if(mesh==_this._tX||mesh==_this._tY||mesh==_this._tZ||mesh==_this._tXZ||mesh==_this._tZY||mesh==_this._tYX||mesh==_this._tAll)return true;}else if(_this._rotEnabled){if(mesh==_this._rX||mesh==_this._rY||mesh==_this._rZ||mesh==_this._rAll)return true;}else if(_this._scaleEnabled){if(mesh==_this._sX||mesh==_this._sY||mesh==_this._sZ||mesh==_this._sXZ||mesh==_this._sZY||mesh==_this._sYX||mesh==_this._sAll)return true;}return false;},null,this._mainCamera);if(pickResult.hit){//if we are still over the same axis mesh then don't do anything
if(pickResult.pickedMesh!=this._prevOverMesh){this._pointerIsOver=true;//if we moved directly from one axis mesh to this then clean up the prev axis mesh
this._clearPrevOverMesh();this._prevOverMesh=pickResult.pickedMesh;if(this._rotEnabled){this._savedCol=this._prevOverMesh.getChildren()[0].color;this._prevOverMesh.getChildren()[0].color=Color3.White();}else{var childs=this._prevOverMesh.getChildren();if(childs.length>0){this._savedMat=childs[0].material;childs[0].material=this._whiteMat;}else{this._savedMat=this._prevOverMesh.material;this._prevOverMesh.material=this._whiteMat;}}if(this._prevOverMesh.name=="X"){this._xaxis.color=Color3.White();}else if(this._prevOverMesh.name=="Y"){this._yaxis.color=Color3.White();}else if(this._prevOverMesh.name=="Z"){this._zaxis.color=Color3.White();}}}else{this._pointerIsOver=false;if(this._prevOverMesh!=null){this._restoreColor(this._prevOverMesh);this._prevOverMesh=null;}}};//clean up any axis we might have been howering over before
EditControl.prototype._clearPrevOverMesh=function(){if(this._prevOverMesh!=null){this._prevOverMesh.visibility=0;this._restoreColor(this._prevOverMesh);}};EditControl.prototype._restoreColor=function(mesh){switch(mesh.name){case"X":this._xaxis.color=Color3.Red();break;case"Y":this._yaxis.color=Color3.Green();break;case"Z":this._zaxis.color=Color3.Blue();break;}if(this._rotEnabled){mesh.getChildren()[0].color=this._savedCol;}else{var childs=mesh.getChildren();if(childs.length>0){childs[0].material=this._savedMat;}else{mesh.material=this._savedMat;}}};EditControl.prototype._onPointerUp=function(evt){this._pDown=false;if(this._editing){this._mainCamera.attachControl(this._canvas);this._setEditing(false);//this.setAxesVisiblity(1);
this._hideBaxis();if(this._prevOverMesh!=null){this._restoreColor(this._prevOverMesh);this._prevOverMesh=null;}this._actHist.add(this._actionType);}};EditControl.prototype._setActionType=function(){if(this._transEnabled){this._actionType=ActionType.TRANS;}else if(this._rotEnabled){this._actionType=ActionType.ROT;}else if(this._scaleEnabled){this._actionType=ActionType.SCALE;}};EditControl.prototype._callActionListener=function(at){//call actionListener if registered
if(this._actionListener!=null){this._actionListener(at);}};EditControl.prototype._callActionStartListener=function(at){//call actionListener if registered
if(this._actionStartListener!=null){this._actionStartListener(at);}};EditControl.prototype._callActionEndListener=function(at){//call actionListener if registered
if(this._actionEndListener!=null){this._actionEndListener(at);}};EditControl.prototype._onPointerMove=function(evt){if(!this._pDown){this._onPointerOver();return;}if(!this._editing)return;if(this._prevPos==null)return;var newPos=this._getPosOnPickPlane();if(newPos==null)return;if(this._rotEnabled){this._doRotation(this._mesh,this._axisPicked,newPos,this._prevPos);}else{var diff=newPos.subtract(this._prevPos);if(diff.x==0&&diff.y==0&&diff.z==0)return;if(this._transEnabled){this._doTranslation(diff);}else{if(this._scaleEnabled&&this._local)this._doScaling(diff);}}this._prevPos=newPos;this._callActionListener(this._actionType);};EditControl.prototype._getPickPlane=function(axis){var n=axis.name;if(this._transEnabled||this._scaleEnabled){if(n=="XZ")return this._pXZ;else if(n=="ZY")return this._pZY;else if(n=="YX")return this._pYX;else if(n=="ALL")return this._pALL;else{//get the position of camera in the edit control frame of reference
this._ecRoot.getWorldMatrix().invertToRef(this._ecMatrix);Vector3.TransformCoordinatesToRef(this._mainCamera.position,this._ecMatrix,this._ecTOcamera);var c=this._ecTOcamera;if(n==="X"){if(Math.abs(c.y)>Math.abs(c.z)){return this._pXZ;}else return this._pYX;}else if(n==="Z"){if(Math.abs(c.y)>Math.abs(c.x)){return this._pXZ;}else return this._pZY;}else if(n==="Y"){if(Math.abs(c.z)>Math.abs(c.x)){return this._pYX;}else return this._pZY;}}}else if(this._rotEnabled){this._rotate2=false;//get the position of camera in the edit control frame of reference
this._ecRoot.getWorldMatrix().invertToRef(this._ecMatrix);Vector3.TransformCoordinatesToRef(this._mainCamera.position,this._ecMatrix,this._ecTOcamera);var c=this._ecTOcamera;//if camera is too close to the rotation plane then use alternate rotation process
switch(n){case"X":if(Math.abs(c.x)<0.2){this._rotate2=true;return this._pALL;}else return this._pZY;case"Y":if(Math.abs(c.y)<0.2){this._rotate2=true;return this._pALL;}else return this._pXZ;case"Z":if(Math.abs(c.z)<0.2){this._rotate2=true;return this._pALL;}else return this._pYX;default:return this._pALL;}}else return null;};EditControl.prototype._doTranslation=function(diff){if(this._mesh.parent!=null&&this._isScaleUnEqual(this._mesh)){this._setLocalAxes(this._ecRoot);}else{this._setLocalAxes(this._mesh);}var n=this._axisPicked.name;if(n=="ALL"){//TODO when translating, the orientation of pALL keeps changing
//TODo this is not so with rotation or scaling
//TODO so for translation instead of pALL maybe we should use the camera view plane for picking
this._transBy=diff;}else{this._transBy.x=0;this._transBy.y=0;this._transBy.z=0;if(n=="X"||n=="XZ"||n=="YX"){if(this._local)this._transBy.x=Vector3.Dot(diff,this._localX)/this._localX.length();else this._transBy.x=diff.x;}if(n=="Y"||n=="ZY"||n=="YX"){if(this._local)this._transBy.y=Vector3.Dot(diff,this._localY)/this._localY.length();else this._transBy.y=diff.y;}if(n=="Z"||n=="XZ"||n=="ZY"){if(this._local)this._transBy.z=Vector3.Dot(diff,this._localZ)/this._localZ.length();else this._transBy.z=diff.z;}}this._transWithSnap(this._mesh,this._transBy,this._local);// bound the translation
if(this._transBoundsMin){this._mesh.position.x=Math.max(this._mesh.position.x,this._transBoundsMin.x);this._mesh.position.y=Math.max(this._mesh.position.y,this._transBoundsMin.y);this._mesh.position.z=Math.max(this._mesh.position.z,this._transBoundsMin.z);}if(this._transBoundsMax){this._mesh.position.x=Math.min(this._mesh.position.x,this._transBoundsMax.x);this._mesh.position.y=Math.min(this._mesh.position.y,this._transBoundsMax.y);this._mesh.position.z=Math.min(this._mesh.position.z,this._transBoundsMax.z);}this._mesh.computeWorldMatrix(true);};EditControl.prototype._transWithSnap=function(mesh,trans,local){if(this._snapT){var snapit=false;this._snapTV.addInPlace(trans);if(Math.abs(this._snapTV.x)>this._tSnap.x){if(this._snapTV.x>0)trans.x=this._tSnap.x;else trans.x=-this._tSnap.x;snapit=true;}if(Math.abs(this._snapTV.y)>this._tSnap.y){if(this._snapTV.y>0)trans.y=this._tSnap.y;else trans.y=-this._tSnap.y;snapit=true;}if(Math.abs(this._snapTV.z)>this._tSnap.z){if(this._snapTV.z>0)trans.z=this._tSnap.z;else trans.z=-this._tSnap.z;snapit=true;}if(snapit){if(Math.abs(trans.x)!==this._tSnap.x)trans.x=0;if(Math.abs(trans.y)!==this._tSnap.y)trans.y=0;if(Math.abs(trans.z)!==this._tSnap.z)trans.z=0;Vector3.FromFloatsToRef(0,0,0,this._snapTV);snapit=false;}else{return;}}if(local){//locallyTranslate moves the mesh wrt the absolute location not pivotlocation :(
//this.mesh.locallyTranslate(trans);
//
this._localX.normalizeToRef(this._tv1);this._localY.normalizeToRef(this._tv2);this._localZ.normalizeToRef(this._tv3);this._mesh.translate(this._tv1,trans.x,Space.WORLD);this._mesh.translate(this._tv2,trans.y,Space.WORLD);this._mesh.translate(this._tv3,trans.z,Space.WORLD);}else{if(this._mesh.parent==null){this._mesh.position.addInPlace(trans);}else{this._mesh.setAbsolutePosition(trans.addInPlace(this._mesh.absolutePosition));}}};EditControl.prototype._doScaling=function(diff){this._setLocalAxes(this._mesh);this._scale.x=0;this._scale.y=0;this._scale.z=0;var n=this._axisPicked.name;if(n=="X"||n=="XZ"||n=="YX"){this._scale.x=Vector3.Dot(diff,this._localX)/this._localX.length();if(this._mesh.scaling.x<0)this._scale.x=-this._scale.x;//if(this.lhsRhs) this.scale.x=-this.scale.x;
}if(n=="Y"||n=="ZY"||n=="YX"){this._scale.y=Vector3.Dot(diff,this._localY)/this._localY.length();if(this._mesh.scaling.y<0)this._scale.y=-this._scale.y;}if(n=="Z"||n=="XZ"||n=="ZY"){this._scale.z=Vector3.Dot(diff,this._localZ)/this._localZ.length();if(this._mesh.scaling.z<0)this._scale.z=-this._scale.z;}//as the mesh becomes large reduce the amount by which we scale.
var bbd=this._boundingDimesion;this._scale.x=this._scale.x/bbd.x;this._scale.y=this._scale.y/bbd.y;this._scale.z=this._scale.z/bbd.z;if(n=="ALL"){//project movement along camera up vector
//if up then scale up else scale down
var s=Vector3.Dot(diff,this._mainCamera.upVector);s=s/Math.max(bbd.x,bbd.y,bbd.z);this._scale.copyFromFloats(s,s,s);}else{var inPlane=false;if(n=="XZ"){inPlane=true;if(Math.abs(this._scale.x)>Math.abs(this._scale.z)){this._scale.z=this._scale.x;}else this._scale.x=this._scale.z;}else if(n=="ZY"){inPlane=true;if(Math.abs(this._scale.z)>Math.abs(this._scale.y)){this._scale.y=this._scale.z;}else this._scale.z=this._scale.y;}else if(n=="YX"){inPlane=true;if(Math.abs(this._scale.y)>Math.abs(this._scale.x)){this._scale.x=this._scale.y;}else this._scale.y=this._scale.x;}if(inPlane){//check if the mouse/pointer was moved towards camera or away from camera
//if towards then scale up else scale down
this._ecRoot.position.subtractToRef(this._mainCamera.position,this._cameraTOec);var s=Vector3.Dot(diff,this._cameraTOec);this._scale.x=Math.abs(this._scale.x);this._scale.y=Math.abs(this._scale.y);this._scale.z=Math.abs(this._scale.z);if(s>0){if(this._mesh.scaling.x>0)this._scale.x=-this._scale.x;//if(this.lhsRhs) this.scale.y=Math.abs(this.scale.y);
if(this._mesh.scaling.y>0)this._scale.y=-this._scale.y;if(this._mesh.scaling.z>0)this._scale.z=-this._scale.z;}else{//this.scale.x=Math.abs(this.scale.x);
//if(this.lhsRhs) this.scale.y=-Math.abs(this.scale.y);
//else this.scale.y=Math.abs(this.scale.y);
if(this._mesh.scaling.x<0)this._scale.x=-this._scale.x;if(this._mesh.scaling.y<0)this._scale.y=-this._scale.y;if(this._mesh.scaling.z<0)this._scale.z=-this._scale.z;}}}this._scaleWithSnap(this._mesh,this._scale);// bound the scale
if(this._scaleBoundsMin){this._mesh.scaling.x=Math.max(this._mesh.scaling.x,this._scaleBoundsMin.x);this._mesh.scaling.y=Math.max(this._mesh.scaling.y,this._scaleBoundsMin.y);this._mesh.scaling.z=Math.max(this._mesh.scaling.z,this._scaleBoundsMin.z);}if(this._scaleBoundsMax){this._mesh.scaling.x=Math.min(this._mesh.scaling.x,this._scaleBoundsMax.x);this._mesh.scaling.y=Math.min(this._mesh.scaling.y,this._scaleBoundsMax.y);this._mesh.scaling.z=Math.min(this._mesh.scaling.z,this._scaleBoundsMax.z);}};EditControl.prototype._scaleWithSnap=function(mesh,p){if(this._snapS){var snapit=false;this._snapSV.addInPlace(p);if(Math.abs(this._snapSV.x)>this._scaleSnap){if(p.x>0)p.x=this._scaleSnap;else p.x=-this._scaleSnap;snapit=true;}if(Math.abs(this._snapSV.y)>this._scaleSnap){if(p.y>0)p.y=this._scaleSnap;else p.y=-this._scaleSnap;snapit=true;}if(Math.abs(this._snapSV.z)>this._scaleSnap){if(p.z>0)p.z=this._scaleSnap;else p.z=-this._scaleSnap;snapit=true;}if(!snapit)return;if(Math.abs(p.x)!==this._scaleSnap&&p.x!==0)p.x=0;if(Math.abs(p.y)!==this._scaleSnap&&p.y!==0)p.y=0;if(Math.abs(p.z)!==this._scaleSnap&&p.z!==0)p.z=0;Vector3.FromFloatsToRef(0,0,0,this._snapSV);snapit=false;}mesh.scaling.addInPlace(p);};;;/*
                     * This would be called after rotation or scaling as the local axes direction or length might have changed
                     * We need to set the local axis as these are used in all three modes to figure out
                     * direction of mouse move wrt the axes
                     * TODO should use world pivotmatrix instead of worldmatrix - incase pivot axes were rotated?
                     */EditControl.prototype._setLocalAxes=function(mesh){var meshMatrix=mesh.getWorldMatrix();Vector3.FromFloatArrayToRef(meshMatrix.m,0,this._localX);Vector3.FromFloatArrayToRef(meshMatrix.m,4,this._localY);Vector3.FromFloatArrayToRef(meshMatrix.m,8,this._localZ);};EditControl.prototype._getBoundingDimension=function(mesh){var bb=mesh.getBoundingInfo().boundingBox;var bd=bb.maximum.subtract(bb.minimum);if(bd.x==0)bd.x=1;if(bd.y==0)bd.y=1;if(bd.z==0)bd.z=1;return bd;};/*
                     *
                     * For the sake of speed the editcontrol calculates bounding info only once.
                     * This is in the constructor.
                     * Now The boundingbox dimension can change if the mesh is baked.
                     * If the editcontrol is attached to the mesh when the mesh was baked then
                     * the scaling speed will be incorrect.
                     * Thus client application should call refreshBoundingInfo if it bakes the mesh.
                     *
                     */EditControl.prototype.refreshBoundingInfo=function(){this._boundingDimesion=this._getBoundingDimension(this._mesh);};EditControl.prototype._doRotation=function(mesh,axis,newPos,prevPos){//for now no rotation if parents have non uniform scale
if(this._local&&this._mesh.parent!=null&&this._isScaleUnEqual(mesh)){this._setLocalAxes(this._ecRoot);}else{this._setLocalAxes(mesh);}var angle=0;//rotation axis
var rAxis;if(axis==this._rX)rAxis=this._local?this._localX:Axis.X;else if(axis==this._rY)rAxis=this._local?this._localY:Axis.Y;else if(axis==this._rZ)rAxis=this._local?this._localZ:Axis.Z;this._ecRoot.position.subtractToRef(this._mainCamera.position,this._cameraTOec);/**
                         * A)first find the angle and the direction (clockwise or anticlockwise) by which the user was trying to rotate
                         * from the user(camera) perspective
                         */if(this._rotate2){angle=this._getAngle2(prevPos,newPos,this._mainCamera.position,this._cameraTOec,rAxis);//TODO check why we need to handle righ hand this way
if(this._scene.useRightHandedSystem)angle=-angle;}else{angle=this._getAngle(prevPos,newPos,mesh.getAbsolutePivotPoint(),this._cameraTOec);}/**
                         * B)then rotate based on users(camera) postion and orientation in the local/world space
                         *
                         */if(this._snapR){this._snapRA+=angle;angle=0;if(Math.abs(this._snapRA)>=this._rotSnap){if(this._snapRA>0)angle=this._rotSnap;else angle=-this._rotSnap;this._snapRA=0;}}if(angle!==0){this._cameraTOec.normalize();if(axis==this._rAll){mesh.rotate(this._cameraTOec,-angle,Space.WORLD);}else{if(Vector3.Dot(rAxis,this._cameraTOec)>=0)angle=-angle;mesh.rotate(rAxis,angle,Space.WORLD);}if(this._eulerian){mesh.rotation=mesh.rotationQuaternion.toEulerAngles();mesh.rotationQuaternion=null;}if(this._local){if(this._mesh.parent!=null&&this._isScaleUnEqual(mesh)){if(axis==this._rAll){this._ecRoot.rotate(this._cameraTOec,-angle,Space.WORLD);}else{this._ecRoot.rotate(rAxis,angle,Space.WORLD);}}}}};EditControl.prototype._getPosOnPickPlane=function(){var _this=this;var pickinfo=this._scene.pick(this._scene.pointerX,this._scene.pointerY,function(mesh){return mesh==_this._pickedPlane;},null,this._mainCamera);if(pickinfo.hit){return pickinfo.pickedPoint;}else{return null;}};EditControl.prototype._hideBaxis=function(){this._bXaxis.visibility=0;this._bYaxis.visibility=0;this._bZaxis.visibility=0;};EditControl.prototype._setAxesVisiblity=function(v){if(this._transEnabled){this._tEndX.visibility=v;this._tEndY.visibility=v;this._tEndZ.visibility=v;this._tEndXZ.visibility=v;this._tEndZY.visibility=v;this._tEndYX.visibility=v;this._tEndAll.visibility=v;}if(this._rotEnabled){this._rEndX.visibility=v;this._rEndY.visibility=v;this._rEndZ.visibility=v;this._rEndAll.visibility=v;}if(this._scaleEnabled){this._sEndX.visibility=v;this._sEndY.visibility=v;this._sEndZ.visibility=v;this._sEndXZ.visibility=v;this._sEndZY.visibility=v;this._sEndYX.visibility=v;this._sEndAll.visibility=v;}};EditControl.prototype.getRotationQuaternion=function(){return this._ecRoot.rotationQuaternion;};EditControl.prototype.getPosition=function(){return this._ecRoot.position;};EditControl.prototype.isTranslationEnabled=function(){return this._transEnabled;};EditControl.prototype.enableTranslation=function(){if(this._tX==null){this._createTransAxes();this._tCtl.parent=this._ecRoot;this._tCtl.metadata={isEditControl:true,isRealMesh:false};}this._clearPrevOverMesh();if(!this._transEnabled){this._tEndX.visibility=this._visibility;this._tEndY.visibility=this._visibility;this._tEndZ.visibility=this._visibility;this._tEndXZ.visibility=this._visibility;this._tEndZY.visibility=this._visibility;this._tEndYX.visibility=this._visibility;this._tEndAll.visibility=this._visibility;this._transEnabled=true;this.disableRotation();this.disableScaling();}};EditControl.prototype.disableTranslation=function(){if(this._transEnabled){this._tEndX.visibility=0;this._tEndY.visibility=0;this._tEndZ.visibility=0;this._tEndXZ.visibility=0;this._tEndZY.visibility=0;this._tEndYX.visibility=0;this._tEndAll.visibility=0;this._transEnabled=false;}};EditControl.prototype.isRotationEnabled=function(){return this._rotEnabled;};EditControl.prototype.returnEuler=function(euler){this._eulerian=euler;};EditControl.prototype.enableRotation=function(){//if(this.rX==null) {
if(this._rCtl==null){this._createRotAxes();this._rCtl.parent=this._ecRoot;this._rCtl.metadata={isEditControl:true,isRealMesh:false};}this._clearPrevOverMesh();if(!this._rotEnabled){this._rEndX.visibility=this._visibility;this._rEndY.visibility=this._visibility;this._rEndZ.visibility=this._visibility;this._rEndAll.visibility=this._visibility;this._rEndAll2.visibility=this._visibility;this._rotEnabled=true;this.disableTranslation();this.disableScaling();}};EditControl.prototype.disableRotation=function(){if(this._rotEnabled){this._rEndX.visibility=0;this._rEndY.visibility=0;this._rEndZ.visibility=0;this._rEndAll.visibility=0;this._rEndAll2.visibility=0;this._rotEnabled=false;}};EditControl.prototype.isScalingEnabled=function(){return this._scaleEnabled;};EditControl.prototype.enableScaling=function(){if(this._sX==null){this._createScaleAxes();this._sCtl.parent=this._ecRoot;this._sCtl.metadata={isEditControl:true,isRealMesh:false};}this._clearPrevOverMesh();if(!this._scaleEnabled){this._sEndX.visibility=this._visibility;this._sEndY.visibility=this._visibility;this._sEndZ.visibility=this._visibility;this._sEndXZ.visibility=this._visibility;this._sEndZY.visibility=this._visibility;this._sEndYX.visibility=this._visibility;this._sEndAll.visibility=this._visibility;this._scaleEnabled=true;this.disableTranslation();this.disableRotation();}};EditControl.prototype.disableScaling=function(){if(this._scaleEnabled){this._sEndX.visibility=0;this._sEndY.visibility=0;this._sEndZ.visibility=0;this._sEndXZ.visibility=0;this._sEndZY.visibility=0;this._sEndYX.visibility=0;this._sEndAll.visibility=0;this._scaleEnabled=false;}};EditControl.prototype.setScaleBounds=function(min,max){this._scaleBoundsMin=min?min:null;this._scaleBoundsMax=max?max:null;if(this._scaleBoundsMin!=null){if(this._scaleBoundsMin.x==0)this._scaleBoundsMin.x=0.00000001;if(this._scaleBoundsMin.y==0)this._scaleBoundsMin.y=0.00000001;if(this._scaleBoundsMin.z==0)this._scaleBoundsMin.z=0.00000001;}};EditControl.prototype.removeScaleBounds=function(){this._scaleBoundsMin=null;this._scaleBoundsMax=null;};EditControl.prototype.setTransBounds=function(min,max){this._transBoundsMin=min?min:null;this._transBoundsMax=max?max:null;};EditControl.prototype.removeTransBounds=function(){this._transBoundsMin=null;this._transBoundsMax=null;};EditControl.prototype.setRotBounds=function(min,max){this._rotBoundsMin=min?min:null;this._rotBoundsMax=max?max:null;};EditControl.prototype.removeRotBounds=function(){this._rotBoundsMin=null;this._rotBoundsMax=null;};/*
                     * create big and small axeses which will be shown in translate, rotate and scale mode.
                     *
                     */EditControl.prototype._createCommonAxes=function(){var guideAxes=new Mesh("guideCtl",this._scene);//the big axes, shown when an axis is selected
this._bXaxis=Mesh.CreateLines("bxAxis",[new Vector3(-100,0,0),new Vector3(100,0,0)],this._scene);this._bYaxis=Mesh.CreateLines("byAxis",[new Vector3(0,-100,0),new Vector3(0,100,0)],this._scene);this._bZaxis=Mesh.CreateLines("bzAxis",[new Vector3(0,0,-100),new Vector3(0,0,100)],this._scene);//lines are now pickable too
this._bXaxis.isPickable=false;this._bYaxis.isPickable=false;this._bZaxis.isPickable=false;this._bXaxis.parent=guideAxes;this._bYaxis.parent=guideAxes;this._bZaxis.parent=guideAxes;this._bXaxis.metadata={isEditControl:true,isRealMesh:false};this._bYaxis.metadata={isEditControl:true,isRealMesh:false};this._bZaxis.metadata={isEditControl:true,isRealMesh:false};this._bXaxis.color=Color3.Red();this._bYaxis.color=Color3.Green();this._bZaxis.color=Color3.Blue();this._hideBaxis();//the small axis
var al=this._axesLen*this._axesScale*0.75;this._xaxis=Mesh.CreateLines("xAxis",[new Vector3(0,0,0),new Vector3(al,0,0)],this._scene);this._yaxis=Mesh.CreateLines("yAxis",[new Vector3(0,0,0),new Vector3(0,al,0)],this._scene);this._zaxis=Mesh.CreateLines("zAxis",[new Vector3(0,0,0),new Vector3(0,0,al)],this._scene);//lines are now pickable too
this._xaxis.isPickable=false;this._yaxis.isPickable=false;this._zaxis.isPickable=false;this._xaxis.parent=guideAxes;this._yaxis.parent=guideAxes;this._zaxis.parent=guideAxes;this._xaxis.metadata={isEditControl:true,isRealMesh:false};this._yaxis.metadata={isEditControl:true,isRealMesh:false};this._zaxis.metadata={isEditControl:true,isRealMesh:false};this._xaxis.color=Color3.Red();this._yaxis.color=Color3.Green();this._zaxis.color=Color3.Blue();this._xaxis.renderingGroupId=1;this._yaxis.renderingGroupId=1;this._zaxis.renderingGroupId=1;return guideAxes;};EditControl.prototype._createPickPlanes=function(){this._pALL=Mesh.CreatePlane("pALL",5,this._scene);this._pXZ=Mesh.CreatePlane("pXZ",5,this._scene);this._pZY=Mesh.CreatePlane("pZY",5,this._scene);this._pYX=Mesh.CreatePlane("pYX",5,this._scene);this._pALL.isPickable=false;this._pXZ.isPickable=false;this._pZY.isPickable=false;this._pYX.isPickable=false;this._pALL.visibility=0;this._pXZ.visibility=0;this._pZY.visibility=0;this._pYX.visibility=0;this._pALL.renderingGroupId=1;this._pXZ.renderingGroupId=1;this._pZY.renderingGroupId=1;this._pYX.renderingGroupId=1;this._pALL.lookAt(this._mainCamera.position);this._pXZ.rotate(Axis.X,1.57);this._pZY.rotate(Axis.Y,1.57);var pickPlanes=new Mesh("pickPlanes",this._scene);this._pALL.parent=pickPlanes;this._pALL.metadata={isEditControl:true,isRealMesh:false};this._pXZ.parent=pickPlanes;this._pXZ.metadata={isEditControl:true,isRealMesh:false};this._pZY.parent=pickPlanes;this._pZY.metadata={isEditControl:true,isRealMesh:false};this._pYX.parent=pickPlanes;this._pYX.metadata={isEditControl:true,isRealMesh:false};return pickPlanes;};EditControl.prototype._createTransAxes=function(){var r=this._pickWidth*2*this._axesScale;var l=this._axesLen*this._axesScale;this._tCtl=new Mesh("tarnsCtl",this._scene);//pickable invisible boxes around axes lines
this._tX=this._extrudeBox(r/2,l);this._tX.name="X";this._tY=this._tX.clone("Y");this._tZ=this._tX.clone("Z");this._tXZ=MeshBuilder.CreatePlane("XZ",{size:r*2},this._scene);this._tZY=MeshBuilder.CreatePlane("ZY",{size:r*2},this._scene);this._tYX=MeshBuilder.CreatePlane("YX",{size:r*2},this._scene);//this.tZY=this.tXZ.clone("ZY");
//this.tYX=this.tXZ.clone("YX");
this._tXZ.rotation.x=1.57;this._tZY.rotation.y=-1.57;this._tXZ.position.x=r;this._tXZ.position.z=r;this._tZY.position.z=r;this._tZY.position.y=r;this._tYX.position.y=r;this._tYX.position.x=r;this._tXZ.bakeCurrentTransformIntoVertices();this._tZY.bakeCurrentTransformIntoVertices();this._tYX.bakeCurrentTransformIntoVertices();this._tAll=Mesh.CreateBox("ALL",r*2,this._scene);this._tX.parent=this._tCtl;this._tX.metadata={isEditControl:true,isRealMesh:false};this._tY.parent=this._tCtl;this._tY.metadata={isEditControl:true,isRealMesh:false};this._tZ.parent=this._tCtl;this._tZ.metadata={isEditControl:true,isRealMesh:false};this._tXZ.parent=this._tCtl;this._tXZ.metadata={isEditControl:true,isRealMesh:false};this._tZY.parent=this._tCtl;this._tZY.metadata={isEditControl:true,isRealMesh:false};this._tYX.parent=this._tCtl;this._tYX.metadata={isEditControl:true,isRealMesh:false};this._tAll.parent=this._tCtl;this._tAll.metadata={isEditControl:true,isRealMesh:false};this._tX.rotation.y=1.57;this._tY.rotation.x-=1.57;this._tX.visibility=0;this._tY.visibility=0;this._tZ.visibility=0;this._tXZ.visibility=0;this._tZY.visibility=0;this._tYX.visibility=0;this._tAll.visibility=0;//do not want clients picking this
//we will pick using mesh filter in scene.pick function
this._tX.isPickable=false;this._tY.isPickable=false;this._tZ.isPickable=false;this._tXZ.isPickable=false;this._tZY.isPickable=false;this._tYX.isPickable=false;this._tAll.isPickable=false;//non pickable but visible cones at end of axes lines
//cone length
var cl=l/5;//cone base radius
var cr=r;this._tEndX=Mesh.CreateCylinder("tEndX",cl,0,cr,6,1,this._scene);this._tEndY=this._tEndX.clone("tEndY");this._tEndZ=this._tEndX.clone("tEndZ");this._tEndXZ=this._createTriangle("XZ",cr*1.75,this._scene);this._tEndZY=this._tEndXZ.clone("ZY");this._tEndYX=this._tEndXZ.clone("YX");this._tEndAll=MeshBuilder.CreatePolyhedron("tEndAll",{type:1,size:cr/2},this._scene);this._tEndX.rotation.x=1.57;this._tEndY.rotation.x=1.57;this._tEndZ.rotation.x=1.57;this._tEndZY.rotation.z=1.57;this._tEndYX.rotation.x=-1.57;this._tEndXZ.position.x=r;this._tEndXZ.position.z=r;this._tEndZY.position.z=r;this._tEndZY.position.y=r;this._tEndYX.position.y=r;this._tEndYX.position.x=r;this._tEndX.parent=this._tX;this._tEndX.metadata={isEditControl:true,isRealMesh:false};this._tEndY.parent=this._tY;this._tEndY.metadata={isEditControl:true,isRealMesh:false};this._tEndZ.parent=this._tZ;this._tEndZ.metadata={isEditControl:true,isRealMesh:false};this._tEndXZ.parent=this._tXZ;this._tEndXZ.metadata={isEditControl:true,isRealMesh:false};this._tEndZY.parent=this._tZY;this._tEndZY.metadata={isEditControl:true,isRealMesh:false};this._tEndYX.parent=this._tYX;this._tEndYX.metadata={isEditControl:true,isRealMesh:false};this._tEndAll.parent=this._tAll;this._tEndAll.metadata={isEditControl:true,isRealMesh:false};this._tEndX.position.z=l-cl/2;this._tEndY.position.z=l-cl/2;this._tEndZ.position.z=l-cl/2;this._tEndX.material=this._redMat;this._tEndY.material=this._greenMat;this._tEndZ.material=this._blueMat;this._tEndXZ.material=this._greenMat;this._tEndZY.material=this._redMat;this._tEndYX.material=this._blueMat;this._tEndAll.material=this._yellowMat;this._tEndX.renderingGroupId=2;this._tEndY.renderingGroupId=2;this._tEndZ.renderingGroupId=2;this._tEndXZ.renderingGroupId=2;this._tEndZY.renderingGroupId=2;this._tEndYX.renderingGroupId=2;this._tEndAll.renderingGroupId=2;this._tEndX.isPickable=false;this._tEndY.isPickable=false;this._tEndZ.isPickable=false;this._tEndXZ.isPickable=false;this._tEndZY.isPickable=false;this._tEndYX.isPickable=false;this._tEndAll.isPickable=false;};EditControl.prototype._createTriangle=function(name,w,scene){console.log("_createTriangle "+w);var p=new Path2(w/2,-w/2).addLineTo(w/2,w/2).addLineTo(-w/2,w/2).addLineTo(w/2,-w/2);var s=new BABYLON.PolygonMeshBuilder(name,p,scene);var t=s.build();return t;};EditControl.prototype.setRotGuideFull=function(y){if(y)this._guideSize=360;else this._guideSize=180;if(this._rCtl!=null){this._rCtl.dispose();this._rAll.dispose();this._rCtl=null;this.enableRotation();}};EditControl.prototype._createRotAxes=function(){var d=this._axesLen*this._axesScale*2;this._rCtl=new Mesh("rotCtl",this._scene);//pickable invisible torus around the rotation circles
this._rX=this._createTube(d/2,this._guideSize);this._rX.name="X";this._rY=this._createTube(d/2,this._guideSize);this._rY.name="Y";this._rZ=this._createTube(d/2,this._guideSize);this._rZ.name="Z";this._rAll=this._createTube(d/1.75,360);this._rAll.name="ALL";this._rX.rotation.z=1.57;this._rZ.rotation.x=-1.57;this._rX.bakeCurrentTransformIntoVertices();this._rZ.bakeCurrentTransformIntoVertices();this._rAll.rotation.x=1.57;this._rX.parent=this._rCtl;this._rX.metadata={isEditControl:true,isRealMesh:false};this._rY.parent=this._rCtl;this._rY.metadata={isEditControl:true,isRealMesh:false};this._rZ.parent=this._rCtl;this._rZ.metadata={isEditControl:true,isRealMesh:false};this._rAll.parent=this._pALL;this._rAll.metadata={isEditControl:true,isRealMesh:false};this._rX.visibility=0;this._rY.visibility=0;this._rZ.visibility=0;this._rAll.visibility=0;//do not want clients picking this
//we will pick using mesh filter in scene.pick function
this._rX.isPickable=false;this._rY.isPickable=false;this._rZ.isPickable=false;this._rAll.isPickable=false;//non pickable but visible circles
var cl=d;this._rEndX=this._createCircle(cl/2,this._guideSize,false);this._rEndY=this._rEndX.clone("");this._rEndZ=this._rEndX.clone("");this._rEndAll=this._createCircle(cl/1.75,360,false);this._rEndAll2=this._createCircle(cl/2,360,false);this._rEndX.parent=this._rX;this._rEndX.metadata={isEditControl:true,isRealMesh:false};this._rEndY.parent=this._rY;this._rEndY.metadata={isEditControl:true,isRealMesh:false};this._rEndZ.parent=this._rZ;this._rEndZ.metadata={isEditControl:true,isRealMesh:false};this._rEndX.rotation.z=1.57;this._rEndZ.rotation.x=-1.57;this._rEndAll.parent=this._rAll;this._rEndAll.metadata={isEditControl:true,isRealMesh:false};this._rEndAll2.parent=this._rAll;this._rEndAll2.metadata={isEditControl:true,isRealMesh:false};this._rEndX.color=Color3.Red();this._rEndY.color=Color3.Green();this._rEndZ.color=Color3.Blue();this._rEndAll.color=Color3.Yellow();this._rEndAll2.color=Color3.Gray();this._rEndX.renderingGroupId=2;this._rEndY.renderingGroupId=2;this._rEndZ.renderingGroupId=2;this._rEndAll.renderingGroupId=2;this._rEndAll2.renderingGroupId=2;this._rEndX.isPickable=false;this._rEndY.isPickable=false;this._rEndZ.isPickable=false;this._rEndAll.isPickable=false;this._rEndAll2.isPickable=false;};EditControl.prototype._extrudeBox=function(w,l){var shape=[new Vector3(w,w,0),new Vector3(-w,w,0),new Vector3(-w,-w,0),new Vector3(w,-w,0),new Vector3(w,w,0)];var path=[new Vector3(0,0,0),new Vector3(0,0,l)];var box=Mesh.ExtrudeShape("",shape,path,1,0,2,this._scene);return box;};EditControl.prototype._createCircle=function(r,t,double){if(t===null)t=360;var points=[];var x;var z;var a=3.14/180;var p=0;for(var i=0;i<=t;i=i+5){x=r*Math.cos(i*a);if(i==90)z=r;else if(i==270)z=-r;else z=r*Math.sin(i*a);points[p]=new Vector3(x,0,z);p++;}if(double){r=r-0.04;for(var i=0;i<=t;i=i+5){x=r*Math.cos(i*a);if(i==90)z=r;else if(i==270)z=-r;else z=r*Math.sin(i*a);points[p]=new Vector3(x,0,z);p++;}}var circle=Mesh.CreateLines("",points,this._scene);return circle;};EditControl.prototype._createTube=function(r,t){if(t===null)t=360;var points=[];var x;var z;var a=3.14/180;var p=0;for(var i=0;i<=t;i=i+30){x=r*Math.cos(i*a);if(i==90)z=r;else if(i==270)z=-r;else z=r*Math.sin(i*a);points[p]=new Vector3(x,0,z);p++;}var tube=Mesh.CreateTube("",points,this._pickWidth*this._axesScale*2,3,null,BABYLON.Mesh.NO_CAP,this._scene);return tube;};EditControl.prototype._createScaleAxes=function(){var r=this._pickWidth*2*this._axesScale;var l=this._axesLen*this._axesScale;this._sCtl=new Mesh("sCtl",this._scene);//pickable , invisible part
this._sX=this._extrudeBox(r/2,l);this._sX.name="X";this._sY=this._sX.clone("Y");this._sZ=this._sX.clone("Z");this._sXZ=MeshBuilder.CreatePlane("XZ",{size:r*2},this._scene);this._sZY=MeshBuilder.CreatePlane("ZY",{size:r*2},this._scene);this._sYX=MeshBuilder.CreatePlane("YX",{size:r*2},this._scene);//this.sZY=this.sXZ.clone("ZY");
//this.sYX=this.sXZ.clone("YX");
this._sXZ.rotation.x=1.57;this._sZY.rotation.y=-1.57;this._sXZ.position.x=r;this._sXZ.position.z=r;this._sZY.position.z=r;this._sZY.position.y=r;this._sYX.position.y=r;this._sYX.position.x=r;this._sXZ.bakeCurrentTransformIntoVertices();this._sZY.bakeCurrentTransformIntoVertices();this._sYX.bakeCurrentTransformIntoVertices();this._sAll=Mesh.CreateBox("ALL",r*2,this._scene);this._sX.parent=this._sCtl;this._sX.metadata={isEditControl:true,isRealMesh:false};this._sY.parent=this._sCtl;this._sY.metadata={isEditControl:true,isRealMesh:false};this._sZ.parent=this._sCtl;this._sZ.metadata={isEditControl:true,isRealMesh:false};this._sAll.parent=this._sCtl;this._sAll.metadata={isEditControl:true,isRealMesh:false};this._sXZ.parent=this._sCtl;this._sXZ.metadata={isEditControl:true,isRealMesh:false};this._sZY.parent=this._sCtl;this._sZY.metadata={isEditControl:true,isRealMesh:false};this._sYX.parent=this._sCtl;this._sYX.metadata={isEditControl:true,isRealMesh:false};this._sX.rotation.y=1.57;this._sY.rotation.x-=1.57;this._sX.visibility=0;this._sY.visibility=0;this._sZ.visibility=0;this._sXZ.visibility=0;this._sZY.visibility=0;this._sYX.visibility=0;this._sAll.visibility=0;//do not want clients picking this
//we will pick using mesh filter in scene.pick function
this._sX.isPickable=false;this._sY.isPickable=false;this._sZ.isPickable=false;this._sXZ.isPickable=false;this._sZY.isPickable=false;this._sYX.isPickable=false;this._sAll.isPickable=false;//non pickable visible boxes at end of axes
var cr=r;this._sEndX=Mesh.CreateBox("",cr,this._scene);this._sEndY=this._sEndX.clone("");this._sEndZ=this._sEndX.clone("");this._sEndXZ=this._createTriangle("XZ",cr*1.75,this._scene);this._sEndZY=this._sEndXZ.clone("ZY");this._sEndYX=this._sEndXZ.clone("YX");this._sEndAll=MeshBuilder.CreatePolyhedron("sEndAll",{type:1,size:cr/2},this._scene);this._sEndZY.rotation.z=1.57;this._sEndYX.rotation.x=-1.57;this._sEndXZ.position.x=r;this._sEndXZ.position.z=r;this._sEndZY.position.z=r;this._sEndZY.position.y=r;this._sEndYX.position.y=r;this._sEndYX.position.x=r;this._sEndX.parent=this._sX;this._sEndX.metadata={isEditControl:true,isRealMesh:false};this._sEndY.parent=this._sY;this._sEndY.metadata={isEditControl:true,isRealMesh:false};this._sEndZ.parent=this._sZ;this._sEndZ.metadata={isEditControl:true,isRealMesh:false};this._sEndXZ.parent=this._sXZ;this._sEndXZ.metadata={isEditControl:true,isRealMesh:false};this._sEndZY.parent=this._sZY;this._sEndZY.metadata={isEditControl:true,isRealMesh:false};this._sEndYX.parent=this._sYX;this._sEndYX.metadata={isEditControl:true,isRealMesh:false};this._sEndAll.parent=this._sAll;this._sEndAll.metadata={isEditControl:true,isRealMesh:false};this._sEndX.position.z=l-cr/2;this._sEndY.position.z=l-cr/2;this._sEndZ.position.z=l-cr/2;this._sEndX.material=this._redMat;this._sEndY.material=this._greenMat;this._sEndZ.material=this._blueMat;this._sEndXZ.material=this._greenMat;this._sEndZY.material=this._redMat;this._sEndYX.material=this._blueMat;this._sEndAll.material=this._yellowMat;this._sEndX.renderingGroupId=2;this._sEndY.renderingGroupId=2;this._sEndZ.renderingGroupId=2;this._sEndXZ.renderingGroupId=2;this._sEndZY.renderingGroupId=2;this._sEndYX.renderingGroupId=2;this._sEndAll.renderingGroupId=2;this._sEndX.isPickable=false;this._sEndY.isPickable=false;this._sEndZ.isPickable=false;this._sEndXZ.isPickable=false;this._sEndZY.isPickable=false;this._sEndYX.isPickable=false;this._sEndAll.isPickable=false;};/**
                     * checks if a have left hand , right hand issue.
                     * In other words if a mesh is a LHS mesh in RHS system or
                     * a RHS mesh in LHS system
                     * The X axis will be reversed in such cases.
                     * thus Cross product of X and Y should be inverse of Z.
                     *
                     */EditControl.prototype._check_LHS_RHS=function(mesh){var actualZ=Vector3.Cross(this._localX,this._localY);//same direction or opposite direction of Z
if(Vector3.Dot(actualZ,this._localZ)<0)return true;else return false;};/**
                     * set how transparent the axes are
                     * 0 to 1
                     * 0 - completely transparent
                     * 1 - completely non transparent
                     * default is 0.75
                     */EditControl.prototype.setVisibility=function(v){this._visibility=v;};EditControl.prototype.setLocal=function(l){if(this._local==l)return;this._local=l;if(!l){this._ecRoot.rotationQuaternion=Quaternion.Identity();}};EditControl.prototype.isLocal=function(){return this._local;};EditControl.prototype.setTransSnap=function(s){this._snapT=s;};EditControl.prototype.setRotSnap=function(s){this._snapR=s;};EditControl.prototype.setScaleSnap=function(s){this._snapS=s;};EditControl.prototype.setTransSnapValue=function(t){this._tSnap.copyFromFloats(t,t,t);this._transSnap=t;};EditControl.prototype.setRotSnapValue=function(r){this._rotSnap=r;};/**
                     * use this to set the scale snap value
                     */EditControl.prototype.setScaleSnapValue=function(r){this._scaleSnap=r;};EditControl.prototype._getAngle2=function(p1,p2,cameraPos,c2ec,mN){/**
                         * A) find out if the camera is above , below, left, right of the rotation plane
                         */ //project "camera to ec" vector onto mesh normal to get distance to rotation plane
var d=Vector3.Dot(c2ec,mN);//scale mesh normal by above ammount to get vector to rotation plane
mN.scaleToRef(d,this._tv1);//get the point of intersection of vector from camera perpendicular to rotation plane
cameraPos.addToRef(this._tv1,this._tv2);var i=this._tv2;//save some typing
//find the co-ordinate of this point in the cameras frame of reference
this._mainCamera.getWorldMatrix().invertToRef(this._tm);Vector3.TransformCoordinatesToRef(this._tv2,this._tm,this._tv2);//find in which quadarant the point (and thus the rotation plane) is in the camera xy plane
var q=0;//(1=x y,2=-x y,3=-x -y,4=x -y)
if(i.x>=0&&i.y>=0)q=1;else if(i.x<=0&&i.y>=0)q=2;else if(i.x<=0&&i.y<=0)q=3;else if(i.x>=0&&i.y<=0)q=4;/**
                         * B) find out if the user moved pointer up,down, right, left
                         */ //find movement vector in camera frame of reference
Vector3.TransformCoordinatesToRef(p1,this._tm,this._tv1);Vector3.TransformCoordinatesToRef(p2,this._tm,this._tv2);this._tv2.subtractInPlace(this._tv1);var mv=this._tv2;//save some typing
//for now lets set the angle magnitutde same as amount by which the mouse moved
var angle=mv.length();var m="";//(u ,d ,r,l)
if(mv.x>=0&&mv.y>=0){if(mv.x>=mv.y)m="r";else m="u";}else if(mv.x<=0&&mv.y>=0){if(-mv.x>=mv.y)m="l";else m="u";}else if(mv.x<=0&&mv.y<=0){if(-mv.x>=-mv.y)m="l";else m="d";}else if(mv.x>=0&&mv.y<=0){if(mv.x>=-mv.y)m="r";else m="d";}/**
                         * C) decide if the user was trying to rotate clockwise (+1) or anti-clockwise(-1)
                         */var r=0;//if mouse moved down /up and rotation plane is on  right or left side of user
if(m=="d"){if(q==1||q==4)r=1;else r=-1;}else if(m=="u"){if(q==1||q==4)r=-1;else r=1;//if mouse moved right/left and  rotation plane is above or below user
}else if(m=="r"){if(q==2||q==1)r=1;else r=-1;}else if(m=="l"){if(q==2||q==1)r=-1;else r=1;}return r*angle;};/**
                     * finds the angle subtended from points p1 to p2 around the point p
                     * checks if the user was trying to rotate clockwise (+ve in LHS) or anticlockwise (-ve in LHS)
                     * to figure this check the orientation of the user(camera)to ec vector with the rotation normal vector
                     */EditControl.prototype._getAngle=function(p1,p2,p,c2ec){p1.subtractToRef(p,this._tv1);p2.subtractToRef(p,this._tv2);Vector3.CrossToRef(this._tv1,this._tv2,this._tv3);var angle=Math.asin(this._tv3.length()/(this._tv1.length()*this._tv2.length()));//camera looking down from front of plane or looking up from behind plane
if(Vector3.Dot(this._tv3,c2ec)>0){angle=-1*angle;}return angle;};EditControl.prototype._createMaterials=function(scene){this._redMat=EditControl._getStandardMaterial("redMat",Color3.Red(),scene);this._greenMat=EditControl._getStandardMaterial("greenMat",Color3.Green(),scene);this._blueMat=EditControl._getStandardMaterial("blueMat",Color3.Blue(),scene);this._whiteMat=EditControl._getStandardMaterial("whiteMat",Color3.White(),scene);this._yellowMat=EditControl._getStandardMaterial("whiteMat",Color3.Yellow(),scene);};EditControl.prototype._disposeMaterials=function(){this._redMat.dispose();this._greenMat.dispose();this._blueMat.dispose();this._whiteMat.dispose();this._yellowMat.dispose();};EditControl._getStandardMaterial=function(name,col,scene){var mat=new StandardMaterial(name,scene);mat.emissiveColor=col;mat.diffuseColor=Color3.Black();mat.specularColor=Color3.Black();mat.backFaceCulling=false;return mat;};return EditControl;}();component.EditControl=EditControl;var ActHist=function(){function ActHist(mesh,capacity){this.lastMax=10;this.acts=new Array();this.last=-1;this.current=-1;this.mesh=mesh;this.lastMax=capacity-1;this.add();}ActHist.prototype.setCapacity=function(c){if(c==0){console.error("capacity should be more than zero");return;}this.lastMax=c-1;this.last=-1;this.current=-1;this.acts=new Array();this.add();};ActHist.prototype.add=function(at){if(at===undefined)at=null;var act=new Act(this.mesh,at);if(this.current<this.last){this.acts.splice(this.current+1);this.last=this.current;}if(this.last==this.lastMax){this.acts.shift();this.acts.push(act);}else{this.acts.push(act);this.last++;this.current++;}};ActHist.prototype.undo=function(){if(this.current>0){var at=this.acts[this.current].getActionType();this.current--;this.acts[this.current].perform(this.mesh);return at;}};ActHist.prototype.redo=function(){if(this.current<this.last){this.current++;this.acts[this.current].perform(this.mesh);return this.acts[this.current].getActionType();}};return ActHist;}();component.ActHist=ActHist;var Act=function(){function Act(mesh,at){this._p=mesh.position.clone();//if (mesh.rotationQuaternion == null) {
if(mesh.rotationQuaternion==null){this._rQ=null;this._rE=mesh.rotation.clone();}else{this._rQ=mesh.rotationQuaternion.clone();this._rE=null;}this._s=mesh.scaling.clone();this._at=at;}Act.prototype.getActionType=function(){return this._at;};Act.prototype.perform=function(mesh){mesh.position.copyFrom(this._p);//check if we are doing euler or quaternion now
//also check what were we doing when the rotation value
//was captured and set value accordingly
if(mesh.rotationQuaternion==null){if(this._rE!=null){//mesh.rotation = this.rE.clone();
mesh.rotation.copyFrom(this._rE);}else{//mesh.rotation = this.r.toEulerAngles();
mesh.rotation.copyFrom(this._rQ.toEulerAngles());}}else{if(this._rQ!=null){mesh.rotationQuaternion.copyFrom(this._rQ);}else{//TODO use BABYLON.Quaternion.RotationYawPitchRoll(rot.y, rot.x, rot.z) instead of toQuaternion.
//mesh.rotationQuaternion.copyFrom(this.rE.toQuaternion());
mesh.rotationQuaternion.copyFrom(Quaternion.RotationYawPitchRoll(this._rE.y,this._rE.x,this._rE.z));}}mesh.scaling.copyFrom(this._s);};return Act;}();component.Act=Act;})(component=babylonjs.component||(babylonjs.component={}));})(babylonjs=ssatguru.babylonjs||(ssatguru.babylonjs={}));})(ssatguru=org.ssatguru||(org.ssatguru={}));})(org||(org={}));///<reference path="../typings/babylon.d.ts"/>
var ManipulationHelpers;(function(ManipulationHelpers){var Color3=BABYLON.Color3;var StandardMaterial=BABYLON.StandardMaterial;var Matrix=BABYLON.Matrix;var Mesh=BABYLON.Mesh;var Vector3=BABYLON.Vector3;var Quaternion=BABYLON.Quaternion;var VertexData=BABYLON.VertexData;var LinesMesh=BABYLON.LinesMesh;/**
     * This class create the visual geometry to display a manipulation radix in a viewport.
     * It also implements the logic to handler intersection, hover on feature.
     */var Radix=function(){/**
         * Create a new Radix instance. The length/radius members are optionals and the default value should suit most cases
         * @param scene the owner Scene
         * @param features the feature the radix must display
         * @param arrowLength the length of a row of an axis, include the rotation cylinder (if any), but always exclude the arrow cone
         * @param coneLength the length of the arrow cone. this is also the length taken for the rotation cylinder (if any)
         * @param coneRadius the radius of the arrow cone
         * @param planeSelectionLength the length of the selection plane
         */function Radix(scene,features,arrowLength,coneLength,coneRadius,planeSelectionLength){if(features===void 0){features=7/* ArrowsXYZ */|112/* AllPlanesSelection */|1792/* Rotations */;}this._scene=scene;this._arrowLength=arrowLength?arrowLength:1;this._coneLength=coneLength?coneLength:0.2;this._coneRadius=coneRadius?coneRadius:0.1;this._planeSelectionLength=planeSelectionLength?planeSelectionLength:this._arrowLength/5.0;this._wireSelectionThreshold=0.05;this._light1=new BABYLON.PointLight("ManipulatorLight",new BABYLON.Vector3(50,50,70),this._scene);this._light1.id="***SceneManipulatorLight***";this._light2=new BABYLON.PointLight("ManipulatorLight",new BABYLON.Vector3(-50,-50,-70),this._scene);this._light2.id="***SceneManipulatorLight***";this._xArrowColor=new Color3(Radix.pc,Radix.sc/2,Radix.sc);this._yArrowColor=new Color3(Radix.sc,Radix.pc,Radix.sc/2);this._zArrowColor=new Color3(Radix.sc/2,Radix.sc,Radix.pc);this._xyPlaneSelectionColor=new Color3(Radix.pc/1.1,Radix.pc/1.3,Radix.sc);this._xzPlaneSelectionColor=new Color3(Radix.pc/1.1,Radix.sc,Radix.pc/1.3);this._yzPlaneSelectionColor=new Color3(Radix.sc,Radix.pc/1.3,Radix.pc/1.1);var materials=[];materials.push({name:"arrowX",color:this.xArrowColor});materials.push({name:"arrowY",color:this.yArrowColor});materials.push({name:"arrowZ",color:this.zArrowColor});materials.push({name:"planeXY",color:this.xyPlaneSelectionColor});materials.push({name:"planeXZ",color:this.xzPlaneSelectionColor});materials.push({name:"planeYZ",color:this.yzPlaneSelectionColor});materials.push({name:"rotationX",color:this.xArrowColor.clone()});materials.push({name:"rotationY",color:this.yArrowColor.clone()});materials.push({name:"rotationZ",color:this.zArrowColor.clone()});this._materials=[];for(var _i=0,materials_1=materials;_i<materials_1.length;_i++){var matData=materials_1[_i];var mtl=new StandardMaterial(matData.name+"RadixMaterial",this._scene);mtl.diffuseColor=matData.color;this._materials[matData.name]=mtl;}this._features=features;this._rootMesh=new Mesh("radixRoot",this._scene);this._rootMesh.renderingGroupId=1;this.constructGraphicalObjects();}Object.defineProperty(Radix.prototype,"wireSelectionThreshold",{/**
             * Set/get the Wire Selection Threshold, set a bigger value to improve tolerance while picking a wire mesh
             */get:function(){return this._wireSelectionThreshold;},set:function(value){this._wireSelectionThreshold=value;var meshes=this._rootMesh.getChildMeshes(true,function(m){return m instanceof LinesMesh;});for(var _i=0,meshes_1=meshes;_i<meshes_1.length;_i++){var mesh=meshes_1[_i];var lm=mesh;if(lm){lm.intersectionThreshold=value;}}},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"xArrowColor",{/**
             * Get/set the colors of the X Arrow
             */get:function(){return this._xArrowColor;},set:function(value){this._xArrowColor=value;this.updateMaterial("arrowX",value);this.updateMaterial("rotationX",value);},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"yArrowColor",{/**
             * Get/set the colors of the Y Arrow
             */get:function(){return this._yArrowColor;},set:function(value){this._yArrowColor=value;this.updateMaterial("arrowY",value);this.updateMaterial("rotationY",value);},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"zArrowColor",{/**
             * Get/set the colors of the Z Arrow
             */get:function(){return this._zArrowColor;},set:function(value){this._zArrowColor=value;this.updateMaterial("arrowZ",value);this.updateMaterial("rotationZ",value);},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"xyPlaneSelectionColor",{/**
             * Get/set the colors of the XY Plane selection anchor
             */get:function(){return this._xyPlaneSelectionColor;},set:function(value){this._xyPlaneSelectionColor=value;},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"xzPlaneSelectionColor",{/**
             * Get/set the colors of the XZ Plane selection anchor
             */get:function(){return this._xzPlaneSelectionColor;},set:function(value){this._xzPlaneSelectionColor=value;},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"yzPlaneSelectionColor",{/**
             * Get/set the colors of the YZ Plane selection anchor
             */get:function(){return this._yzPlaneSelectionColor;},set:function(value){this._yzPlaneSelectionColor=value;},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"highlighted",{/**
             * Get/set the feature of the Radix that are/must be highlighted
             * @returns {}
             */get:function(){return this._highlighted;},set:function(value){this.updateMaterialFromHighlighted(1/* ArrowX */,value,"arrowX");this.updateMaterialFromHighlighted(2/* ArrowY */,value,"arrowY");this.updateMaterialFromHighlighted(4/* ArrowZ */,value,"arrowZ");this.updateMaterialFromHighlighted(16/* PlaneSelectionXY */,value,"planeXY");this.updateMaterialFromHighlighted(32/* PlaneSelectionXZ */,value,"planeXZ");this.updateMaterialFromHighlighted(64/* PlaneSelectionYZ */,value,"planeYZ");this.updateMaterialFromHighlighted(256/* RotationX */,value,"rotationX");this.updateMaterialFromHighlighted(512/* RotationY */,value,"rotationY");this.updateMaterialFromHighlighted(1024/* RotationZ */,value,"rotationZ");this._highlighted=value;},enumerable:true,configurable:true});Object.defineProperty(Radix.prototype,"features",{/**
             * Get the Radix Features that were selected upon creation
             */get:function(){return this._features;},enumerable:true,configurable:true});/**
         * make an intersection test between a point position in the viwport and the Radix, return the feature that is intersected, if any.
         * only the closer Radix Feature is picked.
         * @param pos the viewport position to create the picking ray from.
         */Radix.prototype.intersect=function(pos){var hit=0/* None */;var closest=Number.MAX_VALUE;// Arrows
if(this.hasFeature(1/* ArrowX */)){var dist=this.intersectMeshes(pos,"arrowX",closest);if(dist<closest){closest=dist;hit=1/* ArrowX */;}}if(this.hasFeature(2/* ArrowY */)){var dist=this.intersectMeshes(pos,"arrowY",closest);if(dist<closest){closest=dist;hit=2/* ArrowY */;}}if(this.hasFeature(4/* ArrowZ */)){var dist=this.intersectMeshes(pos,"arrowZ",closest);if(dist<closest){closest=dist;hit=4/* ArrowZ */;}}// Planes
if(this.hasFeature(16/* PlaneSelectionXY */)){var dist=this.intersectMeshes(pos,"planeXY",closest);if(dist<closest){closest=dist;hit=16/* PlaneSelectionXY */;}}if(this.hasFeature(32/* PlaneSelectionXZ */)){var dist=this.intersectMeshes(pos,"planeXZ",closest);if(dist<closest){closest=dist;hit=32/* PlaneSelectionXZ */;}}if(this.hasFeature(64/* PlaneSelectionYZ */)){var dist=this.intersectMeshes(pos,"planeYZ",closest);if(dist<closest){closest=dist;hit=64/* PlaneSelectionYZ */;}}// Rotation
if(this.hasFeature(256/* RotationX */)){var dist=this.intersectMeshes(pos,"rotationX",closest);if(dist<closest){closest=dist;hit=256/* RotationX */;}}if(this.hasFeature(512/* RotationY */)){var dist=this.intersectMeshes(pos,"rotationY",closest);if(dist<closest){closest=dist;hit=512/* RotationY */;}}if(this.hasFeature(1024/* RotationZ */)){var dist=this.intersectMeshes(pos,"rotationZ",closest);if(dist<closest){closest=dist;hit=1024/* RotationZ */;}}return hit;};/**
         * Set the world coordinate of where the Axis should be displayed
         * @param position the position
         * @param rotation the rotation quaternion
         * @param scale the scale (should be uniform)
         */Radix.prototype.setWorld=function(position,rotation,scale){this._rootMesh.position=position;this._rootMesh.rotationQuaternion=rotation;this._rootMesh.scaling=scale;};/**
         * Display the Radix on screen
         */Radix.prototype.show=function(){this.setVisibleState(this._rootMesh,true);};/**
         * Hide the Radix from the screen
         */Radix.prototype.hide=function(){this.setVisibleState(this._rootMesh,false);};Radix.prototype.setVisibleState=function(mesh,state){var _this=this;mesh.isVisible=state;mesh.getChildMeshes(true).forEach(function(m){return _this.setVisibleState(m,state);});};Radix.prototype.intersectMeshes=function(pos,startName,currentClosest){var meshes=this._rootMesh.getChildMeshes(true,function(m){return m.name.indexOf(startName)===0;});for(var _i=0,meshes_2=meshes;_i<meshes_2.length;_i++){var mesh=meshes_2[_i];var ray=this._scene.createPickingRay(pos.x,pos.y,mesh.getWorldMatrix(),this._scene.activeCamera);var pi=mesh.intersects(ray,false);if(pi.hit&&pi.distance<currentClosest){currentClosest=pi.distance;}}return currentClosest;};Radix.prototype.constructGraphicalObjects=function(){var hp=Math.PI/2;if(this.hasFeature(1/* ArrowX */)){this.constructArrow(1/* ArrowX */,"arrowX",Matrix.RotationZ(-hp));}if(this.hasFeature(2/* ArrowY */)){this.constructArrow(2/* ArrowY */,"arrowY",Matrix.Identity());}if(this.hasFeature(4/* ArrowZ */)){this.constructArrow(4/* ArrowZ */,"arrowZ",Matrix.RotationX(hp));}if(this.hasFeature(16/* PlaneSelectionXY */)){this.constructPlaneSelection(16/* PlaneSelectionXY */,"planeXY",Matrix.Identity());}if(this.hasFeature(32/* PlaneSelectionXZ */)){this.constructPlaneSelection(32/* PlaneSelectionXZ */,"planeXZ",Matrix.RotationX(hp));}if(this.hasFeature(64/* PlaneSelectionYZ */)){this.constructPlaneSelection(64/* PlaneSelectionYZ */,"planeYZ",Matrix.RotationY(-hp));}if(this.hasFeature(256/* RotationX */)){this.constructRotation(256/* RotationX */,"rotationX",Matrix.RotationZ(-hp));}if(this.hasFeature(512/* RotationY */)){this.constructRotation(512/* RotationY */,"rotationY",Matrix.Identity());}if(this.hasFeature(1024/* RotationZ */)){this.constructRotation(1024/* RotationZ */,"rotationZ",Matrix.RotationX(hp));}};Radix.prototype.constructArrow=function(feature,name,transform){var mtl=this.getMaterial(name);var hasRot;switch(feature){case 1/* ArrowX */:hasRot=this.hasFeature(256/* RotationX */);break;case 2/* ArrowY */:hasRot=this.hasFeature(512/* RotationY */);break;case 4/* ArrowZ */:hasRot=this.hasFeature(1024/* RotationZ */);break;}var rotation=Quaternion.FromRotationMatrix(transform);var points=new Array();points.push(0,hasRot?this._coneLength:0,0);points.push(0,this._arrowLength-this._coneLength,0);var wireMesh=new LinesMesh(name+"Wire",this._scene);wireMesh.rotationQuaternion=rotation;wireMesh.parent=this._rootMesh;wireMesh.color=mtl.diffuseColor;wireMesh.renderingGroupId=1;wireMesh.intersectionThreshold=this.wireSelectionThreshold;wireMesh.isPickable=false;var vd=new VertexData();vd.positions=points;vd.indices=[0,1];vd.applyToMesh(wireMesh);var arrow=Mesh.CreateCylinder(name+"Cone",this._coneLength,0,this._coneRadius,18,1,this._scene,false);arrow.position=Vector3.TransformCoordinates(new Vector3(0,this._arrowLength-this._coneLength/2,0),transform);arrow.rotationQuaternion=rotation;arrow.material=mtl;arrow.parent=this._rootMesh;arrow.renderingGroupId=1;arrow.isPickable=false;this.addSymbolicMeshToLit(arrow);};Radix.prototype.constructPlaneSelection=function(feature,name,transform){var mtl=this.getMaterial(name);var points=new Array();points.push(new Vector3(this._arrowLength-this._planeSelectionLength,this._arrowLength,0));points.push(new Vector3(this._arrowLength,this._arrowLength,0));points.push(new Vector3(this._arrowLength,this._arrowLength-this._planeSelectionLength,0));var wireMesh=Mesh.CreateLines(name+"Plane",points,this._scene);wireMesh.parent=this._rootMesh;wireMesh.color=mtl.diffuseColor;wireMesh.rotationQuaternion=Quaternion.FromRotationMatrix(transform);wireMesh.renderingGroupId=1;wireMesh.intersectionThreshold=this.wireSelectionThreshold;wireMesh.isPickable=false;};Radix.prototype.constructRotation=function(feature,name,transform){var mtl=this.getMaterial(name);var rotCyl=Mesh.CreateCylinder(name+"Cylinder",this._coneLength,this._coneRadius,this._coneRadius,18,1,this._scene,false);rotCyl.material=mtl;rotCyl.position=Vector3.TransformCoordinates(new Vector3(0,this._coneLength/2,0),transform);rotCyl.rotationQuaternion=Quaternion.FromRotationMatrix(transform);rotCyl.parent=this._rootMesh;rotCyl.renderingGroupId=1;rotCyl.isPickable=false;this.addSymbolicMeshToLit(rotCyl);};Radix.prototype.addSymbolicMeshToLit=function(mesh){var _this=this;this._light1.includedOnlyMeshes.push(mesh);this._light2.includedOnlyMeshes.push(mesh);this._scene.lights.map(function(l){if(l!==_this._light1&&l!==_this._light2)l.excludedMeshes.push(mesh);});};Radix.prototype.hasFeature=function(value){return(this._features&value)!==0;};Radix.prototype.hasHighlightedFeature=function(value){return(this._highlighted&value)!==0;};Radix.prototype.updateMaterial=function(name,color){var mtl=this.getMaterial(name);if(mtl){mtl.diffuseColor=color;}};Radix.prototype.updateMaterialFromHighlighted=function(feature,highlighted,name){if(!this.hasFeature(feature)){return;}if((this._highlighted&feature)!==(highlighted&feature)){var mtl=this.getMaterial(name);if((highlighted&feature)!==0){mtl.diffuseColor.r*=1.8;mtl.diffuseColor.g*=1.8;mtl.diffuseColor.b*=1.8;}else{mtl.diffuseColor.r/=1.8;mtl.diffuseColor.g/=1.8;mtl.diffuseColor.b/=1.8;}}};Radix.prototype.getMaterial=function(name){var mtl=this._materials[name];return mtl;};Radix.pc=0.6;Radix.sc=0.2;return Radix;}();ManipulationHelpers.Radix=Radix;})(ManipulationHelpers||(ManipulationHelpers={}));///<reference path="../typings/babylon.d.ts"/>
///<reference path="radix.ts"/>
var Vector4=BABYLON.Vector2;var ManipulationHelpers;(function(ManipulationHelpers){var Vector2=BABYLON.Vector2;var Vector3=BABYLON.Vector3;var Matrix=BABYLON.Matrix;var Plane=BABYLON.Plane;var AbstractMesh=BABYLON.AbstractMesh;var Quaternion=BABYLON.Quaternion;var PointerEventTypes=BABYLON.PointerEventTypes;/**
     * This class is used to manipulated a single node.
     * Right now only node of type AbstractMesh is support.
     * In the future, manipulation on multiple selection could be possible.
     *
     * A manipulation start when left clicking and moving the mouse. It can be cancelled if the right mouse button is clicked before releasing the left one (this feature is only possible if noPreventContextMenu is false).
     * Per default translation is peformed when manipulating the arrow (axis or cone) or the plane anchor. If you press the shift key it will switch to rotation manipulation. The Shift key can be toggle while manipulating, the current manipulation is accept and a new one starts.
     *
     * You can set the rotation/translationStep (in radian) to enable snapping.
     *
     * The current implementation of this class creates a radix with all the features selected.
     */var ManipulatorInteractionHelper=function(){function ManipulatorInteractionHelper(scene){var _this=this;this.noPreventContextMenu=false;this._flags=0;this._rotationFactor=1;this._scene=scene;this._radix=new ManipulationHelpers.Radix(scene);this._shiftKeyState=false;this._scene.onBeforeRenderObservable.add(function(e,s){return _this.onBeforeRender(e,s);});this._scene.onPointerObservable.add(function(e,s){return _this.onPointer(e,s);},-1,true);window.oncontextmenu=function(ev){if(!_this.noPreventContextMenu){ev.preventDefault();}};}/**
         * Attach a node to manipulate. Right now, only manipulation on a single node is supported, but this api will allow manipulation on a multiple selection in the future.
         * @param node
         */ManipulatorInteractionHelper.prototype.attachManipulatedNode=function(node){this._manipulatedNode=node;this._radix.show();};/**
         * Detach the node to manipulate. Right now, only manipulation on a single node is supported, but this api will allow manipulation on a multiple selection in the future.
         */ManipulatorInteractionHelper.prototype.detachManipulatedNode=function(node){this._manipulatedNode=null;this._radix.hide();};ManipulatorInteractionHelper.prototype.onBeforeRender=function(scene,state){this.renderManipulator();};ManipulatorInteractionHelper.prototype.onPointer=function(e,state){if(!this._manipulatedNode){return;}var rayPos=this.getRayPosition(e.event);var shiftKeyState=e.event.shiftKey;// Detect Modifier Key changes for shift while manipulating: commit and start a new manipulation
if(this.hasManFlags(1/* DragMode */)&&shiftKeyState!==this._shiftKeyState){this.beginDrag(rayPos,e.event);}// Mouse move
if(e.type===PointerEventTypes.POINTERMOVE){// Right button release while left is down => cancel the manipulation. only processed when the context menu is not showed during manipulation
if(!this.noPreventContextMenu&&e.event.button===2&&e.event.buttons===1){this.setManipulatedNodeWorldMatrix(this._firstTransform);this.setManFlags(8/* Exiting */);}else if(this.hasManFlags(1/* DragMode */)&&!this.hasManFlags(8/* Exiting */)){state.skipNextObservers=true;if(shiftKeyState||this.hasManipulatedMode(1792/* Rotations */)){this.doRot(rayPos);}else{this.doPos(rayPos);}}else{this._radix.highlighted=this._radix.intersect(rayPos);}}else if(e.type===PointerEventTypes.POINTERDOWN&&e.event.button===0){this._manipulatedMode=this._radix.intersect(rayPos);if(this._manipulatedMode!==0/* None */){state.skipNextObservers=true;this.beginDrag(rayPos,e.event);if(this.hasManipulatedMode(1792/* Rotations */)){this.doRot(rayPos);}else{this.doPos(rayPos);}}}else if(e.type===PointerEventTypes.POINTERUP){if(this.hasManFlags(1/* DragMode */)){state.skipNextObservers=true;}this._radix.highlighted=this._radix.intersect(rayPos);// Left up: end manipulation
if(e.event.button===0){this.endDragMode();}}};ManipulatorInteractionHelper.prototype.beginDrag=function(rayPos,event){this._firstMousePos=rayPos;this._prevMousePos=this._firstMousePos.clone();this._shiftKeyState=event.shiftKey;var mtx=this.getManipulatedNodeWorldMatrix();this._pos=mtx.getTranslation();this._right=mtx.getRow(0).toVector3();this._up=mtx.getRow(1).toVector3();this._view=mtx.getRow(2).toVector3();this._oldPos=this._pos.clone();this._firstTransform=mtx.clone();this._flags|=2/* FirstHit */|1/* DragMode */;};ManipulatorInteractionHelper.prototype.endDragMode=function(){this.clearManFlags(1/* DragMode */|8/* Exiting */);};ManipulatorInteractionHelper.prototype.doRot=function(rayPos){if(this.hasManFlags(2/* FirstHit */)){this.clearManFlags(2/* FirstHit */);return;}var dx=rayPos.x-this._prevMousePos.x;var dy=rayPos.y-this._prevMousePos.y;var cr=this._scene.getEngine().getRenderingCanvasClientRect();var ax=dx/cr.width*Math.PI*2*this._rotationFactor;var ay=dy/cr.height*Math.PI*2*this._rotationFactor;if(this.rotationStep){var rem=ax%this.rotationStep;ax-=rem;rem=ay%this.rotationStep;ay-=rem;}var mtx=Matrix.Identity();if(this.hasManipulatedMode(1/* ArrowX */|256/* RotationX */)){mtx=Matrix.RotationX(ay);}else if(this.hasManipulatedMode(2/* ArrowY */|512/* RotationY */)){mtx=Matrix.RotationY(ay);}else if(this.hasManipulatedMode(4/* ArrowZ */|1024/* RotationZ */)){mtx=Matrix.RotationZ(ay);}else{if(this.hasManipulatedMode(/*RadixFeatures.CenterSquare |*/16/* PlaneSelectionXY */|32/* PlaneSelectionXZ */)){mtx=mtx.multiply(Matrix.RotationX(ay));}if(this.hasManipulatedMode(16/* PlaneSelectionXY */|64/* PlaneSelectionYZ */)){mtx=mtx.multiply(Matrix.RotationY(ax));}if(this.hasManipulatedMode(32/* PlaneSelectionXZ */)){mtx=mtx.multiply(Matrix.RotationZ(ay));}if(this.hasManipulatedMode(/*RadixFeatures.CenterSquare |*/32/* PlaneSelectionXZ */)){mtx=mtx.multiply(Matrix.RotationZ(ax));}}var tmtx=mtx.multiply(this._firstTransform);this.setManipulatedNodeWorldMatrix(tmtx);};ManipulatorInteractionHelper.prototype.doPos=function(rayPos){var v=Vector3.Zero();var ray=this._scene.createPickingRay(rayPos.x,rayPos.y,Matrix.Identity(),this._scene.activeCamera);if(this.hasManipulatedMode(16/* PlaneSelectionXY */|32/* PlaneSelectionXZ */|64/* PlaneSelectionYZ */)){var pl0;var hit;if(this.hasManipulatedMode(16/* PlaneSelectionXY */)){pl0=Plane.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._up));}else if(this.hasManipulatedMode(32/* PlaneSelectionXZ */)){pl0=Plane.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._view));}else if(this.hasManipulatedMode(64/* PlaneSelectionYZ */)){pl0=Plane.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._view));}else{}var clip=0.06;//Check if the plane is too parallel to the ray
if(Math.abs(Vector3.Dot(pl0.normal,ray.direction))<clip){return;}//Make the intersection
var distance=ray.intersectsPlane(pl0);hit=ManipulatorInteractionHelper.ComputeRayHit(ray,distance);//Check if it's the first call
if(this.hasManFlags(2/* FirstHit */)){this._flags&=~2/* FirstHit */;this._prevHit=hit;return;}//Compute the vector
v=hit.subtract(this._prevHit);}else if((this._manipulatedMode&(1/* ArrowX */|2/* ArrowY */|4/* ArrowZ */))!==0){var pl0,pl1;var hit;var s;if(this.hasManFlags(2/* FirstHit */)){var res=this.setupIntersectionPlanes(this._manipulatedMode);pl0=res.p0;pl1=res.p1;if(Math.abs(Vector3.Dot(pl0.normal,ray.direction))>Math.abs(Vector3.Dot(pl1.normal,ray.direction))){var distance=ray.intersectsPlane(pl0);hit=ManipulatorInteractionHelper.ComputeRayHit(ray,distance);var number=~4/* Plane2 */;this._flags&=number;}else{var distance=ray.intersectsPlane(pl1);hit=ManipulatorInteractionHelper.ComputeRayHit(ray,distance);this._flags|=4/* Plane2 */;}this._flags&=~2/* FirstHit */;this._prevHit=hit;return;}else{var axis;var res=this.setupIntersectionPlane(this._manipulatedMode,this.hasManFlags(4/* Plane2 */));pl0=res.plane;axis=res.axis;var distance=ray.intersectsPlane(pl0);hit=ManipulatorInteractionHelper.ComputeRayHit(ray,distance);v=hit.subtract(this._prevHit);s=Vector3.Dot(axis,v);v=axis.multiplyByFloats(s,s,s);}}if(this.translationStep){v.x-=v.x%this.translationStep;v.y-=v.y%this.translationStep;v.z-=v.z%this.translationStep;}var mtx=this._firstTransform.clone();mtx.setTranslation(mtx.getTranslation().add(v));this._pos=mtx.getTranslation();this.setManipulatedNodeWorldMatrix(mtx);};ManipulatorInteractionHelper.prototype.hasManipulatedMode=function(value){return(this._manipulatedMode&value)!==0;};ManipulatorInteractionHelper.prototype.hasManFlags=function(value){return(this._flags&value)!==0;};ManipulatorInteractionHelper.prototype.clearManFlags=function(values){this._flags&=~values;return this._flags;};ManipulatorInteractionHelper.prototype.setManFlags=function(values){this._flags|=values;return this._flags;};ManipulatorInteractionHelper.ComputeRayHit=function(ray,distance){return ray.origin.add(ray.direction.multiplyByFloats(distance,distance,distance));};ManipulatorInteractionHelper.prototype.setManipulatedNodeWorldMatrix=function(mtx){if(!this._manipulatedNode){return;}if(this._manipulatedNode instanceof AbstractMesh){var mesh=this._manipulatedNode;if(mesh.parent){mtx=mtx.multiply(mesh.parent.getWorldMatrix().clone().invert());}var pos=Vector3.Zero();var scale=Vector3.Zero();var rot=new Quaternion();mtx.decompose(scale,rot,pos);mesh.position=pos;mesh.rotationQuaternion=rot;mesh.scaling=scale;}};ManipulatorInteractionHelper.prototype.getManipulatedNodeWorldMatrix=function(){if(!this._manipulatedNode){return null;}if(this._manipulatedNode instanceof AbstractMesh){return this._manipulatedNode.getWorldMatrix();}};ManipulatorInteractionHelper.prototype.setupIntersectionPlane=function(mode,plane2){var res=this.setupIntersectionPlanes(mode);var pl=plane2?res.p1:res.p0;var axis;switch(mode){case 1/* ArrowX */:axis=this._right;break;case 2/* ArrowY */:axis=this._up;break;case 4/* ArrowZ */:axis=this._view;break;default:axis=Vector3.Zero();break;}return{plane:pl,axis:axis};};ManipulatorInteractionHelper.prototype.setupIntersectionPlanes=function(mode){var p0,p1;switch(mode){case 1/* ArrowX */:p0=Plane.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._right));p1=Plane.FromPoints(this._pos,this._pos.add(this._right),this._pos.add(this._up));break;case 2/* ArrowY */:p0=Plane.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._right));p1=Plane.FromPoints(this._pos,this._pos.add(this._up),this._pos.add(this._view));break;case 4/* ArrowZ */:p0=Plane.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._right));p1=Plane.FromPoints(this._pos,this._pos.add(this._view),this._pos.add(this._up));break;}return{p0:p0,p1:p1};};ManipulatorInteractionHelper.prototype.getRayPosition=function(event){var canvasRect=this._scene.getEngine().getRenderingCanvasClientRect();var x=event.clientX-canvasRect.left;var y=event.clientY-canvasRect.top;return new Vector2(x,y);};ManipulatorInteractionHelper.prototype.renderManipulator=function(){if(!this._manipulatedNode){return;}if(this._manipulatedNode instanceof AbstractMesh){var mesh=this._manipulatedNode;var worldMtx=mesh.getWorldMatrix();var l=Vector3.Distance(this._scene.activeCamera.position,worldMtx.getTranslation());var vpWidth=this._scene.getEngine().getRenderWidth();var s=this.fromScreenToWorld(vpWidth/100,l)*20;var scale=Vector3.Zero();var position=Vector3.Zero();var rotation=Quaternion.Identity();var res=Matrix.Scaling(s,s,s).multiply(worldMtx);res.decompose(scale,rotation,position);this._radix.setWorld(position,rotation,scale);}};ManipulatorInteractionHelper.prototype.fromScreenToWorld=function(l,z){var camera=this._scene.activeCamera;var r0=this._scene.createPickingRay(0,0,Matrix.Identity(),camera,true);var r1=this._scene.createPickingRay(l,0,Matrix.Identity(),camera,true);var p0=ManipulatorInteractionHelper.evalPosition(r0,z);var p1=ManipulatorInteractionHelper.evalPosition(r1,z);return p1.x-p0.x;};ManipulatorInteractionHelper.evalPosition=function(ray,u){return ray.origin.add(ray.direction.multiplyByFloats(u,u,u));};return ManipulatorInteractionHelper;}();ManipulationHelpers.ManipulatorInteractionHelper=ManipulatorInteractionHelper;})(ManipulationHelpers||(ManipulationHelpers={}));///<reference path="../typings/babylon.d.ts"/>
///<reference path="ManipulatorInteractionHelper.ts"/>
var ManipulationHelpers;(function(ManipulationHelpers){var PointerEventTypes=BABYLON.PointerEventTypes;var AbstractMesh=BABYLON.AbstractMesh;/**
     * The purpose of this class is to allow the camera manipulation, single node selection and manipulation.
     * You can use it as an example to create your more complexe/different interaction helper
     */var SimpleInteractionHelper=function(){function SimpleInteractionHelper(scene){var _this=this;this._actionStack=new Array();this._scene=scene;this._pointerObserver=this._scene.onPointerObservable.add(function(p,s){return _this.pointerCallback(p,s);},-1,true);}Object.defineProperty(SimpleInteractionHelper.prototype,"currentAction",{get:function(){if(this._actionStack.length===0){return 1/* Selector */;}return this._actionStack[this._actionStack.length-1];},enumerable:true,configurable:true});Object.defineProperty(SimpleInteractionHelper.prototype,"manipulator",{get:function(){if(!this._manipulator){this._manipulator=new ManipulationHelpers.ManipulatorInteractionHelper(this._scene);}return this._manipulator;},enumerable:true,configurable:true});SimpleInteractionHelper.prototype.pointerCallback=function(p,s){this.detectActionChanged(p,s);switch(this.currentAction){case 1/* Selector */:this.doSelectorInteraction(p,s);break;case 2/* Camerator */:if(p.type&(PointerEventTypes.POINTERUP|PointerEventTypes.POINTERWHEEL)){this._actionStack.pop();}break;}};SimpleInteractionHelper.prototype.doSelectorInteraction=function(p,s){s.skipNextObservers=true;// We want left button up.
if(p.type!==PointerEventTypes.POINTERUP||p.event.button!==0){return;}var selectedMesh;if(p.pickInfo.hit){selectedMesh=p.pickInfo.pickedMesh;}// We selected the same mesh? nothing to do
if(this._pickedNode===selectedMesh){selectedMesh.showBoundingBox=!selectedMesh.showBoundingBox;if(selectedMesh.showBoundingBox===false){this.manipulator.detachManipulatedNode(this._pickedNode);this._pickedNode=null;}return;}// Detach the manipulator to the current selected mesh
if(this._pickedNode){if(this._pickedNode instanceof AbstractMesh){var mesh=this._pickedNode;mesh.showBoundingBox=false;}this.manipulator.detachManipulatedNode(this._pickedNode);this._pickedNode=null;}// Nothing selected, our job's done
if(!selectedMesh){return;}this._pickedNode=selectedMesh;selectedMesh.showBoundingBox=true;this.manipulator.attachManipulatedNode(this._pickedNode);};SimpleInteractionHelper.prototype.detectActionChanged=function(p,s){// Detect switch from selection to camerator
if(this.currentAction===1/* Selector */){if(p.type===PointerEventTypes.POINTERDOWN){if(!p.pickInfo.hit){this._actionStack.push(2/* Camerator */);return;}}if(p.type===PointerEventTypes.POINTERWHEEL){this._actionStack.push(2/* Camerator */);return;}}};SimpleInteractionHelper.CameratorSwitchThreshold=4.0;return SimpleInteractionHelper;}();ManipulationHelpers.SimpleInteractionHelper=SimpleInteractionHelper;})(ManipulationHelpers||(ManipulationHelpers={}));var ManipulationHelpers;(function(ManipulationHelpers){var SymbolicVisualHelper=function(){function SymbolicVisualHelper(){}SymbolicVisualHelper.prototype.render=function(){if(this.renderLight){}if(this.renderManipulator){}};return SymbolicVisualHelper;}();ManipulationHelpers.SymbolicVisualHelper=SymbolicVisualHelper;})(ManipulationHelpers||(ManipulationHelpers={}));/*
* MIT Licensed
* http://www.23developer.com/opensource
* http://github.com/23/resumable.js
* Steffen Tiedemann Christensen, steffen@23company.com
*/(function(){"use strict";var Resumable=function(opts){if(!(this instanceof Resumable)){return new Resumable(opts);}this.version=1.0;// SUPPORTED BY BROWSER?
// Check if these features are support by the browser:
// - File object type
// - Blob object type
// - FileList object type
// - slicing files
this.support=typeof File!=='undefined'&&typeof Blob!=='undefined'&&typeof FileList!=='undefined'&&(!!Blob.prototype.webkitSlice||!!Blob.prototype.mozSlice||!!Blob.prototype.slice||false);if(!this.support)return false;// PROPERTIES
var $=this;$.files=[];$.defaults={chunkSize:1*1024*1024,forceChunkSize:false,simultaneousUploads:3,fileParameterName:'file',chunkNumberParameterName:'resumableChunkNumber',chunkSizeParameterName:'resumableChunkSize',currentChunkSizeParameterName:'resumableCurrentChunkSize',totalSizeParameterName:'resumableTotalSize',typeParameterName:'resumableType',identifierParameterName:'resumableIdentifier',fileNameParameterName:'resumableFilename',relativePathParameterName:'resumableRelativePath',totalChunksParameterName:'resumableTotalChunks',dragOverClass:'dragover',throttleProgressCallbacks:0.5,query:{},headers:{},preprocess:null,preprocessFile:null,method:'multipart',uploadMethod:'POST',testMethod:'GET',prioritizeFirstAndLastChunk:false,target:'/',testTarget:null,parameterNamespace:'',testChunks:true,generateUniqueIdentifier:null,getTarget:null,maxChunkRetries:100,chunkRetryInterval:undefined,permanentErrors:[400,401,403,404,409,415,500,501],maxFiles:undefined,withCredentials:false,xhrTimeout:0,clearInput:true,chunkFormat:'blob',setChunkTypeFromFile:false,maxFilesErrorCallback:function(files,errorCount){var maxFiles=$.getOpt('maxFiles');alert('Please upload no more than '+maxFiles+' file'+(maxFiles===1?'':'s')+' at a time.');},minFileSize:1,minFileSizeErrorCallback:function(file,errorCount){alert(file.fileName||file.name+'is too small, please upload files larger than '+$h.formatSize($.getOpt('minFileSize'))+'.'+'File size:'+file.size+' - File type:'+file.type+' - File object type:'+typeof file);},maxFileSize:undefined,maxFileSizeErrorCallback:function(file,errorCount){alert(file.fileName||file.name+' is too large, please upload files less than '+$h.formatSize($.getOpt('maxFileSize'))+'.');},fileType:[],fileTypeErrorCallback:function(file,errorCount){alert(file.fileName||file.name+' has type not allowed, please upload files of type '+$.getOpt('fileType')+'.');}};$.opts=opts||{};$.getOpt=function(o){var $opt=this;// Get multiple option if passed an array
if(o instanceof Array){var options={};$h.each(o,function(option){options[option]=$opt.getOpt(option);});return options;}// Otherwise, just return a simple option
if($opt instanceof ResumableChunk){if(typeof $opt.opts[o]!=='undefined'){return $opt.opts[o];}else{$opt=$opt.fileObj;}}if($opt instanceof ResumableFile){if(typeof $opt.opts[o]!=='undefined'){return $opt.opts[o];}else{$opt=$opt.resumableObj;}}if($opt instanceof Resumable){if(typeof $opt.opts[o]!=='undefined'){return $opt.opts[o];}else{return $opt.defaults[o];}}};$.indexOf=function(array,obj){if(array.indexOf){return array.indexOf(obj);}for(var i=0;i<array.length;i++){if(array[i]===obj){return i;}}return-1;};// EVENTS
// catchAll(event, ...)
// fileSuccess(file), fileProgress(file), fileAdded(file, event), filesAdded(files, filesSkipped), fileRetry(file),
// fileError(file, message), complete(), progress(), error(message, file), pause()
$.events=[];$.on=function(event,callback){$.events.push(event.toLowerCase(),callback);};$.fire=function(){// `arguments` is an object, not array, in FF, so:
var args=[];for(var i=0;i<arguments.length;i++)args.push(arguments[i]);// Find event listeners, and support pseudo-event `catchAll`
var event=args[0].toLowerCase();for(var i=0;i<=$.events.length;i+=2){if($.events[i]==event)$.events[i+1].apply($,args.slice(1));if($.events[i]=='catchall')$.events[i+1].apply(null,args);}if(event=='fileerror')$.fire('error',args[2],args[1]);if(event=='fileprogress')$.fire('progress');};// INTERNAL HELPER METHODS (handy, but ultimately not part of uploading)
var $h={stopEvent:function(e){e.stopPropagation();e.preventDefault();},each:function(o,callback){if(typeof o.length!=='undefined'){for(var i=0;i<o.length;i++){// Array or FileList
if(callback(o[i])===false)return;}}else{for(i in o){// Object
if(callback(i,o[i])===false)return;}}},generateUniqueIdentifier:function(file,event){var custom=$.getOpt('generateUniqueIdentifier');if(typeof custom==='function'){return custom(file,event);}var relativePath=file.webkitRelativePath||file.relativePath||file.fileName||file.name;// Some confusion in different versions of Firefox
var size=file.size;return size+'-'+relativePath.replace(/[^0-9a-zA-Z_-]/img,'');},contains:function(array,test){var result=false;$h.each(array,function(value){if(value==test){result=true;return false;}return true;});return result;},formatSize:function(size){if(size<1024){return size+' bytes';}else if(size<1024*1024){return(size/1024.0).toFixed(0)+' KB';}else if(size<1024*1024*1024){return(size/1024.0/1024.0).toFixed(1)+' MB';}else{return(size/1024.0/1024.0/1024.0).toFixed(1)+' GB';}},getTarget:function(request,params){var target=$.getOpt('target');if(request==='test'&&$.getOpt('testTarget')){target=$.getOpt('testTarget')==='/'?$.getOpt('target'):$.getOpt('testTarget');}if(typeof target==='function'){return target(params);}var separator=target.indexOf('?')<0?'?':'&';var joinedParams=params.join('&');if(joinedParams)target=target+separator+joinedParams;return target;}};var onDrop=function(e){e.currentTarget.classList.remove($.getOpt('dragOverClass'));$h.stopEvent(e);//handle dropped things as items if we can (this lets us deal with folders nicer in some cases)
if(e.dataTransfer&&e.dataTransfer.items){loadFiles(e.dataTransfer.items,e);}//else handle them as files
else if(e.dataTransfer&&e.dataTransfer.files){loadFiles(e.dataTransfer.files,e);}};var onDragLeave=function(e){e.currentTarget.classList.remove($.getOpt('dragOverClass'));};var onDragOverEnter=function(e){e.preventDefault();var dt=e.dataTransfer;if($.indexOf(dt.types,"Files")>=0){// only for file drop
e.stopPropagation();dt.dropEffect="copy";dt.effectAllowed="copy";e.currentTarget.classList.add($.getOpt('dragOverClass'));}else{// not work on IE/Edge....
dt.dropEffect="none";dt.effectAllowed="none";}};/**
     * processes a single upload item (file or directory)
     * @param {Object} item item to upload, may be file or directory entry
     * @param {string} path current file path
     * @param {File[]} items list of files to append new items to
     * @param {Function} cb callback invoked when item is processed
     */function processItem(item,path,items,cb){var entry;if(item.isFile){// file provided
return item.file(function(file){file.relativePath=path+file.name;items.push(file);cb();});}else if(item.isDirectory){// item is already a directory entry, just assign
entry=item;}else if(item instanceof File){items.push(item);}if('function'===typeof item.webkitGetAsEntry){// get entry from file object
entry=item.webkitGetAsEntry();}if(entry&&entry.isDirectory){// directory provided, process it
return processDirectory(entry,path+entry.name+'/',items,cb);}if('function'===typeof item.getAsFile){// item represents a File object, convert it
item=item.getAsFile();if(item instanceof File){item.relativePath=path+item.name;items.push(item);}}cb();// indicate processing is done
}/**
     * cps-style list iteration.
     * invokes all functions in list and waits for their callback to be
     * triggered.
     * @param  {Function[]}   items list of functions expecting callback parameter
     * @param  {Function} cb    callback to trigger after the last callback has been invoked
     */function processCallbacks(items,cb){if(!items||items.length===0){// empty or no list, invoke callback
return cb();}// invoke current function, pass the next part as continuation
items[0](function(){processCallbacks(items.slice(1),cb);});}/**
     * recursively traverse directory and collect files to upload
     * @param  {Object}   directory directory to process
     * @param  {string}   path      current path
     * @param  {File[]}   items     target list of items
     * @param  {Function} cb        callback invoked after traversing directory
     */function processDirectory(directory,path,items,cb){var dirReader=directory.createReader();var allEntries=[];function readEntries(){dirReader.readEntries(function(entries){if(entries.length){allEntries=allEntries.concat(entries);return readEntries();}// process all conversion callbacks, finally invoke own one
processCallbacks(allEntries.map(function(entry){// bind all properties except for callback
return processItem.bind(null,entry,path,items);}),cb);});}readEntries();}/**
     * process items to extract files to be uploaded
     * @param  {File[]} items items to process
     * @param  {Event} event event that led to upload
     */function loadFiles(items,event){if(!items.length){return;// nothing to do
}$.fire('beforeAdd');var files=[];processCallbacks(Array.prototype.map.call(items,function(item){// bind all properties except for callback
var entry=item;if('function'===typeof item.webkitGetAsEntry){entry=item.webkitGetAsEntry();}return processItem.bind(null,entry,"",files);}),function(){if(files.length){// at least one file found
appendFilesFromFileList(files,event);}});};var appendFilesFromFileList=function(fileList,event){// check for uploading too many files
var errorCount=0;var o=$.getOpt(['maxFiles','minFileSize','maxFileSize','maxFilesErrorCallback','minFileSizeErrorCallback','maxFileSizeErrorCallback','fileType','fileTypeErrorCallback']);if(typeof o.maxFiles!=='undefined'&&o.maxFiles<fileList.length+$.files.length){// if single-file upload, file is already added, and trying to add 1 new file, simply replace the already-added file
if(o.maxFiles===1&&$.files.length===1&&fileList.length===1){$.removeFile($.files[0]);}else{o.maxFilesErrorCallback(fileList,errorCount++);return false;}}var files=[],filesSkipped=[],remaining=fileList.length;var decreaseReamining=function(){if(! --remaining){// all files processed, trigger event
if(!files.length&&!filesSkipped.length){// no succeeded files, just skip
return;}window.setTimeout(function(){$.fire('filesAdded',files,filesSkipped);},0);}};$h.each(fileList,function(file){var fileName=file.name;var fileType=file.type;// e.g video/mp4
if(o.fileType.length>0){var fileTypeFound=false;for(var index in o.fileType){// For good behaviour we do some inital sanitizing. Remove spaces and lowercase all
o.fileType[index]=o.fileType[index].replace(/\s/g,'').toLowerCase();// Allowing for both [extension, .extension, mime/type, mime/*]
var extension=(o.fileType[index].match(/^[^.][^/]+$/)?'.':'')+o.fileType[index];if(fileName.substr(-1*extension.length).toLowerCase()===extension||//If MIME type, check for wildcard or if extension matches the files tiletype
extension.indexOf('/')!==-1&&(extension.indexOf('*')!==-1&&fileType.substr(0,extension.indexOf('*'))===extension.substr(0,extension.indexOf('*'))||fileType===extension)){fileTypeFound=true;break;}}if(!fileTypeFound){o.fileTypeErrorCallback(file,errorCount++);return true;}}if(typeof o.minFileSize!=='undefined'&&file.size<o.minFileSize){o.minFileSizeErrorCallback(file,errorCount++);return true;}if(typeof o.maxFileSize!=='undefined'&&file.size>o.maxFileSize){o.maxFileSizeErrorCallback(file,errorCount++);return true;}function addFile(uniqueIdentifier){if(!$.getFromUniqueIdentifier(uniqueIdentifier)){(function(){file.uniqueIdentifier=uniqueIdentifier;var f=new ResumableFile($,file,uniqueIdentifier);$.files.push(f);files.push(f);f.container=typeof event!='undefined'?event.srcElement:null;window.setTimeout(function(){$.fire('fileAdded',f,event);},0);})();}else{filesSkipped.push(file);};decreaseReamining();}// directories have size == 0
var uniqueIdentifier=$h.generateUniqueIdentifier(file,event);if(uniqueIdentifier&&typeof uniqueIdentifier.then==='function'){// Promise or Promise-like object provided as unique identifier
uniqueIdentifier.then(function(uniqueIdentifier){// unique identifier generation succeeded
addFile(uniqueIdentifier);},function(){// unique identifier generation failed
// skip further processing, only decrease file count
decreaseReamining();});}else{// non-Promise provided as unique identifier, process synchronously
addFile(uniqueIdentifier);}});};// INTERNAL OBJECT TYPES
function ResumableFile(resumableObj,file,uniqueIdentifier){var $=this;$.opts={};$.getOpt=resumableObj.getOpt;$._prevProgress=0;$.resumableObj=resumableObj;$.file=file;$.fileName=file.fileName||file.name;// Some confusion in different versions of Firefox
$.size=file.size;$.relativePath=file.relativePath||file.webkitRelativePath||$.fileName;$.uniqueIdentifier=uniqueIdentifier;$._pause=false;$.container='';$.preprocessState=0;// 0 = unprocessed, 1 = processing, 2 = finished
var _error=uniqueIdentifier!==undefined;// Callback when something happens within the chunk
var chunkEvent=function(event,message){// event can be 'progress', 'success', 'error' or 'retry'
switch(event){case'progress':$.resumableObj.fire('fileProgress',$,message);break;case'error':$.abort();_error=true;$.chunks=[];$.resumableObj.fire('fileError',$,message);break;case'success':if(_error)return;$.resumableObj.fire('fileProgress',$,message);// it's at least progress
if($.isComplete()){$.resumableObj.fire('fileSuccess',$,message);}break;case'retry':$.resumableObj.fire('fileRetry',$);break;}};// Main code to set up a file object with chunks,
// packaged to be able to handle retries if needed.
$.chunks=[];$.abort=function(){// Stop current uploads
var abortCount=0;$h.each($.chunks,function(c){if(c.status()=='uploading'){c.abort();abortCount++;}});if(abortCount>0)$.resumableObj.fire('fileProgress',$);};$.cancel=function(){// Reset this file to be void
var _chunks=$.chunks;$.chunks=[];// Stop current uploads
$h.each(_chunks,function(c){if(c.status()=='uploading'){c.abort();$.resumableObj.uploadNextChunk();}});$.resumableObj.removeFile($);$.resumableObj.fire('fileProgress',$);};$.retry=function(){$.bootstrap();var firedRetry=false;$.resumableObj.on('chunkingComplete',function(){if(!firedRetry)$.resumableObj.upload();firedRetry=true;});};$.bootstrap=function(){$.abort();_error=false;// Rebuild stack of chunks from file
$.chunks=[];$._prevProgress=0;var round=$.getOpt('forceChunkSize')?Math.ceil:Math.floor;var maxOffset=Math.max(round($.file.size/$.getOpt('chunkSize')),1);for(var offset=0;offset<maxOffset;offset++){(function(offset){window.setTimeout(function(){$.chunks.push(new ResumableChunk($.resumableObj,$,offset,chunkEvent));$.resumableObj.fire('chunkingProgress',$,offset/maxOffset);},0);})(offset);}window.setTimeout(function(){$.resumableObj.fire('chunkingComplete',$);},0);};$.progress=function(){if(_error)return 1;// Sum up progress across everything
var ret=0;var error=false;$h.each($.chunks,function(c){if(c.status()=='error')error=true;ret+=c.progress(true);// get chunk progress relative to entire file
});ret=error?1:ret>0.99999?1:ret;ret=Math.max($._prevProgress,ret);// We don't want to lose percentages when an upload is paused
$._prevProgress=ret;return ret;};$.isUploading=function(){var uploading=false;$h.each($.chunks,function(chunk){if(chunk.status()=='uploading'){uploading=true;return false;}});return uploading;};$.isComplete=function(){var outstanding=false;if($.preprocessState===1){return false;}$h.each($.chunks,function(chunk){var status=chunk.status();if(status=='pending'||status=='uploading'||chunk.preprocessState===1){outstanding=true;return false;}});return!outstanding;};$.pause=function(pause){if(typeof pause==='undefined'){$._pause=$._pause?false:true;}else{$._pause=pause;}};$.isPaused=function(){return $._pause;};$.preprocessFinished=function(){$.preprocessState=2;$.upload();};$.upload=function(){var found=false;if($.isPaused()===false){var preprocess=$.getOpt('preprocessFile');if(typeof preprocess==='function'){switch($.preprocessState){case 0:$.preprocessState=1;preprocess($);return true;case 1:return true;case 2:break;}}$h.each($.chunks,function(chunk){if(chunk.status()=='pending'&&chunk.preprocessState!==1){chunk.send();found=true;return false;}});}return found;};$.markChunksCompleted=function(chunkNumber){if(!$.chunks||$.chunks.length<=chunkNumber){return;}for(var num=0;num<chunkNumber;num++){$.chunks[num].markComplete=true;}};// Bootstrap and return
$.resumableObj.fire('chunkingStart',$);$.bootstrap();return this;}function ResumableChunk(resumableObj,fileObj,offset,callback){var $=this;$.opts={};$.getOpt=resumableObj.getOpt;$.resumableObj=resumableObj;$.fileObj=fileObj;$.fileObjSize=fileObj.size;$.fileObjType=fileObj.file.type;$.offset=offset;$.callback=callback;$.lastProgressCallback=new Date();$.tested=false;$.retries=0;$.pendingRetry=false;$.preprocessState=0;// 0 = unprocessed, 1 = processing, 2 = finished
$.markComplete=false;// Computed properties
var chunkSize=$.getOpt('chunkSize');$.loaded=0;$.startByte=$.offset*chunkSize;$.endByte=Math.min($.fileObjSize,($.offset+1)*chunkSize);if($.fileObjSize-$.endByte<chunkSize&&!$.getOpt('forceChunkSize')){// The last chunk will be bigger than the chunk size, but less than 2*chunkSize
$.endByte=$.fileObjSize;}$.xhr=null;// test() makes a GET request without any data to see if the chunk has already been uploaded in a previous session
$.test=function(){// Set up request and listen for event
$.xhr=new XMLHttpRequest();var testHandler=function(e){$.tested=true;var status=$.status();if(status=='success'){$.callback(status,$.message());$.resumableObj.uploadNextChunk();}else{$.send();}};$.xhr.addEventListener('load',testHandler,false);$.xhr.addEventListener('error',testHandler,false);$.xhr.addEventListener('timeout',testHandler,false);// Add data from the query options
var params=[];var parameterNamespace=$.getOpt('parameterNamespace');var customQuery=$.getOpt('query');if(typeof customQuery=='function')customQuery=customQuery($.fileObj,$);$h.each(customQuery,function(k,v){params.push([encodeURIComponent(parameterNamespace+k),encodeURIComponent(v)].join('='));});// Add extra data to identify chunk
params=params.concat([// define key/value pairs for additional parameters
['chunkNumberParameterName',$.offset+1],['chunkSizeParameterName',$.getOpt('chunkSize')],['currentChunkSizeParameterName',$.endByte-$.startByte],['totalSizeParameterName',$.fileObjSize],['typeParameterName',$.fileObjType],['identifierParameterName',$.fileObj.uniqueIdentifier],['fileNameParameterName',$.fileObj.fileName],['relativePathParameterName',$.fileObj.relativePath],['totalChunksParameterName',$.fileObj.chunks.length]].filter(function(pair){// include items that resolve to truthy values
// i.e. exclude false, null, undefined and empty strings
return $.getOpt(pair[0]);}).map(function(pair){// map each key/value pair to its final form
return[parameterNamespace+$.getOpt(pair[0]),encodeURIComponent(pair[1])].join('=');}));// Append the relevant chunk and send it
$.xhr.open($.getOpt('testMethod'),$h.getTarget('test',params));$.xhr.timeout=$.getOpt('xhrTimeout');$.xhr.withCredentials=$.getOpt('withCredentials');// Add data from header options
var customHeaders=$.getOpt('headers');if(typeof customHeaders==='function'){customHeaders=customHeaders($.fileObj,$);}$h.each(customHeaders,function(k,v){$.xhr.setRequestHeader(k,v);});$.xhr.send(null);};$.preprocessFinished=function(){$.preprocessState=2;$.send();};// send() uploads the actual data in a POST call
$.send=function(){var preprocess=$.getOpt('preprocess');if(typeof preprocess==='function'){switch($.preprocessState){case 0:$.preprocessState=1;preprocess($);return;case 1:return;case 2:break;}}if($.getOpt('testChunks')&&!$.tested){$.test();return;}// Set up request and listen for event
$.xhr=new XMLHttpRequest();// Progress
$.xhr.upload.addEventListener('progress',function(e){if(new Date()-$.lastProgressCallback>$.getOpt('throttleProgressCallbacks')*1000){$.callback('progress');$.lastProgressCallback=new Date();}$.loaded=e.loaded||0;},false);$.loaded=0;$.pendingRetry=false;$.callback('progress');// Done (either done, failed or retry)
var doneHandler=function(e){var status=$.status();if(status=='success'||status=='error'){$.callback(status,$.message());$.resumableObj.uploadNextChunk();}else{$.callback('retry',$.message());$.abort();$.retries++;var retryInterval=$.getOpt('chunkRetryInterval');if(retryInterval!==undefined){$.pendingRetry=true;setTimeout($.send,retryInterval);}else{$.send();}}};$.xhr.addEventListener('load',doneHandler,false);$.xhr.addEventListener('error',doneHandler,false);$.xhr.addEventListener('timeout',doneHandler,false);// Set up the basic query data from Resumable
var query=[['chunkNumberParameterName',$.offset+1],['chunkSizeParameterName',$.getOpt('chunkSize')],['currentChunkSizeParameterName',$.endByte-$.startByte],['totalSizeParameterName',$.fileObjSize],['typeParameterName',$.fileObjType],['identifierParameterName',$.fileObj.uniqueIdentifier],['fileNameParameterName',$.fileObj.fileName],['relativePathParameterName',$.fileObj.relativePath],['totalChunksParameterName',$.fileObj.chunks.length]].filter(function(pair){// include items that resolve to truthy values
// i.e. exclude false, null, undefined and empty strings
return $.getOpt(pair[0]);}).reduce(function(query,pair){// assign query key/value
query[$.getOpt(pair[0])]=pair[1];return query;},{});// Mix in custom data
var customQuery=$.getOpt('query');if(typeof customQuery=='function')customQuery=customQuery($.fileObj,$);$h.each(customQuery,function(k,v){query[k]=v;});var func=$.fileObj.file.slice?'slice':$.fileObj.file.mozSlice?'mozSlice':$.fileObj.file.webkitSlice?'webkitSlice':'slice';var bytes=$.fileObj.file[func]($.startByte,$.endByte,$.getOpt('setChunkTypeFromFile')?$.fileObj.file.type:"");var data=null;var params=[];var parameterNamespace=$.getOpt('parameterNamespace');if($.getOpt('method')==='octet'){// Add data from the query options
data=bytes;$h.each(query,function(k,v){params.push([encodeURIComponent(parameterNamespace+k),encodeURIComponent(v)].join('='));});}else{// Add data from the query options
data=new FormData();$h.each(query,function(k,v){data.append(parameterNamespace+k,v);params.push([encodeURIComponent(parameterNamespace+k),encodeURIComponent(v)].join('='));});if($.getOpt('chunkFormat')=='blob'){data.append(parameterNamespace+$.getOpt('fileParameterName'),bytes,$.fileObj.fileName);}else if($.getOpt('chunkFormat')=='base64'){var fr=new FileReader();fr.onload=function(e){data.append(parameterNamespace+$.getOpt('fileParameterName'),fr.result);$.xhr.send(data);};fr.readAsDataURL(bytes);}}var target=$h.getTarget('upload',params);var method=$.getOpt('uploadMethod');$.xhr.open(method,target);if($.getOpt('method')==='octet'){$.xhr.setRequestHeader('Content-Type','application/octet-stream');}$.xhr.timeout=$.getOpt('xhrTimeout');$.xhr.withCredentials=$.getOpt('withCredentials');// Add data from header options
var customHeaders=$.getOpt('headers');if(typeof customHeaders==='function'){customHeaders=customHeaders($.fileObj,$);}$h.each(customHeaders,function(k,v){$.xhr.setRequestHeader(k,v);});if($.getOpt('chunkFormat')=='blob'){$.xhr.send(data);}};$.abort=function(){// Abort and reset
if($.xhr)$.xhr.abort();$.xhr=null;};$.status=function(){// Returns: 'pending', 'uploading', 'success', 'error'
if($.pendingRetry){// if pending retry then that's effectively the same as actively uploading,
// there might just be a slight delay before the retry starts
return'uploading';}else if($.markComplete){return'success';}else if(!$.xhr){return'pending';}else if($.xhr.readyState<4){// Status is really 'OPENED', 'HEADERS_RECEIVED' or 'LOADING' - meaning that stuff is happening
return'uploading';}else{if($.xhr.status==200||$.xhr.status==201){// HTTP 200, 201 (created)
return'success';}else if($h.contains($.getOpt('permanentErrors'),$.xhr.status)||$.retries>=$.getOpt('maxChunkRetries')){// HTTP 400, 404, 409, 415, 500, 501 (permanent error)
return'error';}else{// this should never happen, but we'll reset and queue a retry
// a likely case for this would be 503 service unavailable
$.abort();return'pending';}}};$.message=function(){return $.xhr?$.xhr.responseText:'';};$.progress=function(relative){if(typeof relative==='undefined')relative=false;var factor=relative?($.endByte-$.startByte)/$.fileObjSize:1;if($.pendingRetry)return 0;if((!$.xhr||!$.xhr.status)&&!$.markComplete)factor*=.95;var s=$.status();switch(s){case'success':case'error':return 1*factor;case'pending':return 0*factor;default:return $.loaded/($.endByte-$.startByte)*factor;}};return this;}// QUEUE
$.uploadNextChunk=function(){var found=false;// In some cases (such as videos) it's really handy to upload the first
// and last chunk of a file quickly; this let's the server check the file's
// metadata and determine if there's even a point in continuing.
if($.getOpt('prioritizeFirstAndLastChunk')){$h.each($.files,function(file){if(file.chunks.length&&file.chunks[0].status()=='pending'&&file.chunks[0].preprocessState===0){file.chunks[0].send();found=true;return false;}if(file.chunks.length>1&&file.chunks[file.chunks.length-1].status()=='pending'&&file.chunks[file.chunks.length-1].preprocessState===0){file.chunks[file.chunks.length-1].send();found=true;return false;}});if(found)return true;}// Now, simply look for the next, best thing to upload
$h.each($.files,function(file){found=file.upload();if(found)return false;});if(found)return true;// The are no more outstanding chunks to upload, check is everything is done
var outstanding=false;$h.each($.files,function(file){if(!file.isComplete()){outstanding=true;return false;}});if(!outstanding){// All chunks have been uploaded, complete
$.fire('complete');}return false;};// PUBLIC METHODS FOR RESUMABLE.JS
$.assignBrowse=function(domNodes,isDirectory){if(typeof domNodes.length=='undefined')domNodes=[domNodes];$h.each(domNodes,function(domNode){var input;if(domNode.tagName==='INPUT'&&domNode.type==='file'){input=domNode;}else{input=document.createElement('input');input.setAttribute('type','file');input.style.display='none';domNode.addEventListener('click',function(){input.style.opacity=0;input.style.display='block';input.focus();input.click();input.style.display='none';},false);domNode.appendChild(input);}var maxFiles=$.getOpt('maxFiles');if(typeof maxFiles==='undefined'||maxFiles!=1){input.setAttribute('multiple','multiple');}else{input.removeAttribute('multiple');}if(isDirectory){input.setAttribute('webkitdirectory','webkitdirectory');}else{input.removeAttribute('webkitdirectory');}var fileTypes=$.getOpt('fileType');if(typeof fileTypes!=='undefined'&&fileTypes.length>=1){input.setAttribute('accept',fileTypes.map(function(e){e=e.replace(/\s/g,'').toLowerCase();if(e.match(/^[^.][^/]+$/)){e='.'+e;}return e;}).join(','));}else{input.removeAttribute('accept');}// When new files are added, simply append them to the overall list
input.addEventListener('change',function(e){appendFilesFromFileList(e.target.files,e);var clearInput=$.getOpt('clearInput');if(clearInput){e.target.value='';}},false);});};$.assignDrop=function(domNodes){if(typeof domNodes.length=='undefined')domNodes=[domNodes];$h.each(domNodes,function(domNode){domNode.addEventListener('dragover',onDragOverEnter,false);domNode.addEventListener('dragenter',onDragOverEnter,false);domNode.addEventListener('dragleave',onDragLeave,false);domNode.addEventListener('drop',onDrop,false);});};$.unAssignDrop=function(domNodes){if(typeof domNodes.length=='undefined')domNodes=[domNodes];$h.each(domNodes,function(domNode){domNode.removeEventListener('dragover',onDragOverEnter);domNode.removeEventListener('dragenter',onDragOverEnter);domNode.removeEventListener('dragleave',onDragLeave);domNode.removeEventListener('drop',onDrop);});};$.isUploading=function(){var uploading=false;$h.each($.files,function(file){if(file.isUploading()){uploading=true;return false;}});return uploading;};$.upload=function(){// Make sure we don't start too many uploads at once
if($.isUploading())return;// Kick off the queue
$.fire('uploadStart');for(var num=1;num<=$.getOpt('simultaneousUploads');num++){$.uploadNextChunk();}};$.pause=function(){// Resume all chunks currently being uploaded
$h.each($.files,function(file){file.abort();});$.fire('pause');};$.cancel=function(){$.fire('beforeCancel');for(var i=$.files.length-1;i>=0;i--){$.files[i].cancel();}$.fire('cancel');};$.progress=function(){var totalDone=0;var totalSize=0;// Resume all chunks currently being uploaded
$h.each($.files,function(file){totalDone+=file.progress()*file.size;totalSize+=file.size;});return totalSize>0?totalDone/totalSize:0;};$.addFile=function(file,event){appendFilesFromFileList([file],event);};$.addFiles=function(files,event){appendFilesFromFileList(files,event);};$.removeFile=function(file){for(var i=$.files.length-1;i>=0;i--){if($.files[i]===file){$.files.splice(i,1);}}};$.getFromUniqueIdentifier=function(uniqueIdentifier){var ret=false;$h.each($.files,function(f){if(f.uniqueIdentifier==uniqueIdentifier)ret=f;});return ret;};$.getSize=function(){var totalSize=0;$h.each($.files,function(file){totalSize+=file.size;});return totalSize;};$.handleDropEvent=function(e){onDrop(e);};$.handleChangeEvent=function(e){appendFilesFromFileList(e.target.files,e);e.target.value='';};$.updateQuery=function(query){$.opts.query=query;};return this;};// Node.js-style export for Node and Component
if(typeof module!='undefined'){// left here for backwards compatibility
module.exports=Resumable;module.exports.Resumable=Resumable;}else if(typeof define==="function"&&define.amd){// AMD/requirejs: Define the module
define(function(){return Resumable;});}else{// Browser: Expose to window
window.Resumable=Resumable;}})();/**
 * @license
 * pixi.js - v2.2.8
 * Copyright (c) 2012-2014, Mat Groves
 * http://goodboydigital.com/
 *
 * Compiled: 2015-03-15
 *
 * pixi.js is licensed under the MIT License.
 * http://www.opensource.org/licenses/mit-license.php
 */ /**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */(function(){var root=this;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The [pixi.js](http://www.pixijs.com/) module/namespace.
 *
 * @module PIXI
 */ /**
 * Namespace-class for [pixi.js](http://www.pixijs.com/).
 *
 * Contains assorted static properties and enumerations.
 *
 * @class PIXI
 * @static
 */var PIXI=PIXI||{};/**
 * @property {Number} WEBGL_RENDERER
 * @protected
 * @static
 */PIXI.WEBGL_RENDERER=0;/**
 * @property {Number} CANVAS_RENDERER
 * @protected
 * @static
 */PIXI.CANVAS_RENDERER=1;/**
 * Version of pixi that is loaded.
 * @property {String} VERSION
 * @static
 */PIXI.VERSION="v2.2.8";/**
 * Various blend modes supported by pixi. IMPORTANT - The WebGL renderer only supports the NORMAL, ADD, MULTIPLY and SCREEN blend modes.
 * @property {Object} blendModes
 * @property {Number} blendModes.NORMAL
 * @property {Number} blendModes.ADD
 * @property {Number} blendModes.MULTIPLY
 * @property {Number} blendModes.SCREEN
 * @property {Number} blendModes.OVERLAY
 * @property {Number} blendModes.DARKEN
 * @property {Number} blendModes.LIGHTEN
 * @property {Number} blendModes.COLOR_DODGE
 * @property {Number} blendModes.COLOR_BURN
 * @property {Number} blendModes.HARD_LIGHT
 * @property {Number} blendModes.SOFT_LIGHT
 * @property {Number} blendModes.DIFFERENCE
 * @property {Number} blendModes.EXCLUSION
 * @property {Number} blendModes.HUE
 * @property {Number} blendModes.SATURATION
 * @property {Number} blendModes.COLOR
 * @property {Number} blendModes.LUMINOSITY
 * @static
 */PIXI.blendModes={NORMAL:0,ADD:1,MULTIPLY:2,SCREEN:3,OVERLAY:4,DARKEN:5,LIGHTEN:6,COLOR_DODGE:7,COLOR_BURN:8,HARD_LIGHT:9,SOFT_LIGHT:10,DIFFERENCE:11,EXCLUSION:12,HUE:13,SATURATION:14,COLOR:15,LUMINOSITY:16};/**
 * The scale modes that are supported by pixi.
 *
 * The DEFAULT scale mode affects the default scaling mode of future operations.
 * It can be re-assigned to either LINEAR or NEAREST, depending upon suitability.
 *
 * @property {Object} scaleModes
 * @property {Number} scaleModes.DEFAULT=LINEAR
 * @property {Number} scaleModes.LINEAR Smooth scaling
 * @property {Number} scaleModes.NEAREST Pixelating scaling
 * @static
 */PIXI.scaleModes={DEFAULT:0,LINEAR:0,NEAREST:1};// used to create uids for various pixi objects..
PIXI._UID=0;if(typeof Float32Array!='undefined'){PIXI.Float32Array=Float32Array;PIXI.Uint16Array=Uint16Array;// Uint32Array and ArrayBuffer only used by WebGL renderer
// We can suppose that if WebGL is supported then typed arrays are supported too
// as they predate WebGL support for all browsers:
// see typed arrays support: http://caniuse.com/#search=TypedArrays
// see WebGL support: http://caniuse.com/#search=WebGL
PIXI.Uint32Array=Uint32Array;PIXI.ArrayBuffer=ArrayBuffer;}else{PIXI.Float32Array=Array;PIXI.Uint16Array=Array;}// interaction frequency
PIXI.INTERACTION_FREQUENCY=30;PIXI.AUTO_PREVENT_DEFAULT=true;/**
 * @property {Number} PI_2
 * @static
 */PIXI.PI_2=Math.PI*2;/**
 * @property {Number} RAD_TO_DEG
 * @static
 */PIXI.RAD_TO_DEG=180/Math.PI;/**
 * @property {Number} DEG_TO_RAD
 * @static
 */PIXI.DEG_TO_RAD=Math.PI/180;/**
 * @property {String} RETINA_PREFIX
 * @protected
 * @static
 */PIXI.RETINA_PREFIX="@2x";//PIXI.SCALE_PREFIX "@x%%";
/**
 * If true the default pixi startup (console) banner message will be suppressed.
 *
 * @property {Boolean} dontSayHello
 * @default false
 * @static
 */PIXI.dontSayHello=false;/**
 * The default render options if none are supplied to
 * {{#crossLink "WebGLRenderer"}}{{/crossLink}} or {{#crossLink "CanvasRenderer"}}{{/crossLink}}.
 *
 * @property {Object} defaultRenderOptions
 * @property {Object} defaultRenderOptions.view=null
 * @property {Boolean} defaultRenderOptions.transparent=false
 * @property {Boolean} defaultRenderOptions.antialias=false
 * @property {Boolean} defaultRenderOptions.preserveDrawingBuffer=false
 * @property {Number} defaultRenderOptions.resolution=1
 * @property {Boolean} defaultRenderOptions.clearBeforeRender=true
 * @property {Boolean} defaultRenderOptions.autoResize=false
 * @static
 */PIXI.defaultRenderOptions={view:null,transparent:false,antialias:false,preserveDrawingBuffer:false,resolution:1,clearBeforeRender:true,autoResize:false};PIXI.sayHello=function(type){if(PIXI.dontSayHello)return;if(navigator.userAgent.toLowerCase().indexOf('chrome')>-1){var args=['%c %c %c Pixi.js '+PIXI.VERSION+' - '+type+'  %c '+' %c '+' http://www.pixijs.com/  %c %c ♥%c♥%c♥ ','background: #ff66a5','background: #ff66a5','color: #ff66a5; background: #030307;','background: #ff66a5','background: #ffc3dc','background: #ff66a5','color: #ff2424; background: #fff','color: #ff2424; background: #fff','color: #ff2424; background: #fff'];console.log.apply(console,args);}else if(window['console']){console.log('Pixi.js '+PIXI.VERSION+' - http://www.pixijs.com/');}PIXI.dontSayHello=true;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The Point object represents a location in a two-dimensional coordinate system, where x represents the horizontal axis and y represents the vertical axis.
 *
 * @class Point
 * @constructor
 * @param x {Number} position of the point on the x axis
 * @param y {Number} position of the point on the y axis
 */PIXI.Point=function(x,y){/**
     * @property x
     * @type Number
     * @default 0
     */this.x=x||0;/**
     * @property y
     * @type Number
     * @default 0
     */this.y=y||0;};/**
 * Creates a clone of this point
 *
 * @method clone
 * @return {Point} a copy of the point
 */PIXI.Point.prototype.clone=function(){return new PIXI.Point(this.x,this.y);};/**
 * Sets the point to a new x and y position.
 * If y is omitted, both x and y will be set to x.
 * 
 * @method set
 * @param [x=0] {Number} position of the point on the x axis
 * @param [y=0] {Number} position of the point on the y axis
 */PIXI.Point.prototype.set=function(x,y){this.x=x||0;this.y=y||(y!==0?this.x:0);};// constructor
PIXI.Point.prototype.constructor=PIXI.Point;/**
 * @author Mat Groves http://matgroves.com/
 */ /**
 * the Rectangle object is an area defined by its position, as indicated by its top-left corner point (x, y) and by its width and its height.
 *
 * @class Rectangle
 * @constructor
 * @param x {Number} The X coordinate of the upper-left corner of the rectangle
 * @param y {Number} The Y coordinate of the upper-left corner of the rectangle
 * @param width {Number} The overall width of this rectangle
 * @param height {Number} The overall height of this rectangle
 */PIXI.Rectangle=function(x,y,width,height){/**
     * @property x
     * @type Number
     * @default 0
     */this.x=x||0;/**
     * @property y
     * @type Number
     * @default 0
     */this.y=y||0;/**
     * @property width
     * @type Number
     * @default 0
     */this.width=width||0;/**
     * @property height
     * @type Number
     * @default 0
     */this.height=height||0;/**
     * The type of the object, should be one of the Graphics type consts, PIXI.Graphics.RECT in this case
     * @property type
     * @type Number
     * @default 0
     */};/**
 * Creates a clone of this Rectangle
 *
 * @method clone
 * @return {Rectangle} a copy of the rectangle
 */PIXI.Rectangle.prototype.clone=function(){return new PIXI.Rectangle(this.x,this.y,this.width,this.height);};/**
 * Checks whether the x and y coordinates given are contained within this Rectangle
 *
 * @method contains
 * @param x {Number} The X coordinate of the point to test
 * @param y {Number} The Y coordinate of the point to test
 * @return {Boolean} Whether the x/y coordinates are within this Rectangle
 */PIXI.Rectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true;}}return false;};// constructor
PIXI.Rectangle.prototype.constructor=PIXI.Rectangle;PIXI.EmptyRectangle=new PIXI.Rectangle(0,0,0,0);/**
 * @author Adrien Brault <adrien.brault@gmail.com>
 */ /**
 * @class Polygon
 * @constructor
 * @param points* {Array(Point)|Array(Number)|Point...|Number...} This can be an array of Points that form the polygon,
 *      a flat array of numbers that will be interpreted as [x,y, x,y, ...], or the arguments passed can be
 *      all the points of the polygon e.g. `new PIXI.Polygon(new PIXI.Point(), new PIXI.Point(), ...)`, or the
 *      arguments passed can be flat x,y values e.g. `new PIXI.Polygon(x,y, x,y, x,y, ...)` where `x` and `y` are
 *      Numbers.
 */PIXI.Polygon=function(points){//if points isn't an array, use arguments as the array
if(!(points instanceof Array))points=Array.prototype.slice.call(arguments);//if this is a flat array of numbers, convert it to points
if(points[0]instanceof PIXI.Point){var p=[];for(var i=0,il=points.length;i<il;i++){p.push(points[i].x,points[i].y);}points=p;}this.closed=true;/**
     * An array of the points of this polygon
     * @property points
     * @type Array(Point)|Array(Number)
     * 
     */this.points=points;/**
     * The type of the object, should be one of the Graphics type consts, PIXI.Graphics.POLY in this case
     * @property type
     * @type Number
     * @default 0
     */};/**
 * Creates a clone of this polygon
 *
 * @method clone
 * @return {Polygon} a copy of the polygon
 */PIXI.Polygon.prototype.clone=function(){var points=this.points.slice();return new PIXI.Polygon(points);};/**
 * Checks whether the x and y coordinates passed to this function are contained within this polygon
 *
 * @method contains
 * @param x {Number} The X coordinate of the point to test
 * @param y {Number} The Y coordinate of the point to test
 * @return {Boolean} Whether the x/y coordinates are within this polygon
 */PIXI.Polygon.prototype.contains=function(x,y){var inside=false;// use some raycasting to test hits
// https://github.com/substack/point-in-polygon/blob/master/index.js
var length=this.points.length/2;for(var i=0,j=length-1;i<length;j=i++){var xi=this.points[i*2],yi=this.points[i*2+1],xj=this.points[j*2],yj=this.points[j*2+1],intersect=yi>y!==yj>y&&x<(xj-xi)*(y-yi)/(yj-yi)+xi;if(intersect)inside=!inside;}return inside;};// constructor
PIXI.Polygon.prototype.constructor=PIXI.Polygon;/**
 * @author Chad Engler <chad@pantherdev.com>
 */ /**
 * The Circle object can be used to specify a hit area for displayObjects
 *
 * @class Circle
 * @constructor
 * @param x {Number} The X coordinate of the center of this circle
 * @param y {Number} The Y coordinate of the center of this circle
 * @param radius {Number} The radius of the circle
 */PIXI.Circle=function(x,y,radius){/**
     * @property x
     * @type Number
     * @default 0
     */this.x=x||0;/**
     * @property y
     * @type Number
     * @default 0
     */this.y=y||0;/**
     * @property radius
     * @type Number
     * @default 0
     */this.radius=radius||0;/**
     * The type of the object, should be one of the Graphics type consts, PIXI.Graphics.CIRC in this case
     * @property type
     * @type Number
     * @default 0
     */};/**
 * Creates a clone of this Circle instance
 *
 * @method clone
 * @return {Circle} a copy of the Circle
 */PIXI.Circle.prototype.clone=function(){return new PIXI.Circle(this.x,this.y,this.radius);};/**
 * Checks whether the x and y coordinates given are contained within this circle
 *
 * @method contains
 * @param x {Number} The X coordinate of the point to test
 * @param y {Number} The Y coordinate of the point to test
 * @return {Boolean} Whether the x/y coordinates are within this Circle
 */PIXI.Circle.prototype.contains=function(x,y){if(this.radius<=0)return false;var dx=this.x-x,dy=this.y-y,r2=this.radius*this.radius;dx*=dx;dy*=dy;return dx+dy<=r2;};/**
* Returns the framing rectangle of the circle as a PIXI.Rectangle object
*
* @method getBounds
* @return {Rectangle} the framing rectangle
*/PIXI.Circle.prototype.getBounds=function(){return new PIXI.Rectangle(this.x-this.radius,this.y-this.radius,this.radius*2,this.radius*2);};// constructor
PIXI.Circle.prototype.constructor=PIXI.Circle;/**
 * @author Chad Engler <chad@pantherdev.com>
 */ /**
 * The Ellipse object can be used to specify a hit area for displayObjects
 *
 * @class Ellipse
 * @constructor
 * @param x {Number} The X coordinate of the center of the ellipse
 * @param y {Number} The Y coordinate of the center of the ellipse
 * @param width {Number} The half width of this ellipse
 * @param height {Number} The half height of this ellipse
 */PIXI.Ellipse=function(x,y,width,height){/**
     * @property x
     * @type Number
     * @default 0
     */this.x=x||0;/**
     * @property y
     * @type Number
     * @default 0
     */this.y=y||0;/**
     * @property width
     * @type Number
     * @default 0
     */this.width=width||0;/**
     * @property height
     * @type Number
     * @default 0
     */this.height=height||0;/**
     * The type of the object, should be one of the Graphics type consts, PIXI.Graphics.ELIP in this case
     * @property type
     * @type Number
     * @default 0
     */};/**
 * Creates a clone of this Ellipse instance
 *
 * @method clone
 * @return {Ellipse} a copy of the ellipse
 */PIXI.Ellipse.prototype.clone=function(){return new PIXI.Ellipse(this.x,this.y,this.width,this.height);};/**
 * Checks whether the x and y coordinates given are contained within this ellipse
 *
 * @method contains
 * @param x {Number} The X coordinate of the point to test
 * @param y {Number} The Y coordinate of the point to test
 * @return {Boolean} Whether the x/y coords are within this ellipse
 */PIXI.Ellipse.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;//normalize the coords to an ellipse with center 0,0
var normx=(x-this.x)/this.width,normy=(y-this.y)/this.height;normx*=normx;normy*=normy;return normx+normy<=1;};/**
* Returns the framing rectangle of the ellipse as a PIXI.Rectangle object
*
* @method getBounds
* @return {Rectangle} the framing rectangle
*/PIXI.Ellipse.prototype.getBounds=function(){return new PIXI.Rectangle(this.x-this.width,this.y-this.height,this.width,this.height);};// constructor
PIXI.Ellipse.prototype.constructor=PIXI.Ellipse;/**
 * @author Mat Groves http://matgroves.com/
 */ /**
 * The Rounded Rectangle object is an area defined by its position and has nice rounded corners, as indicated by its top-left corner point (x, y) and by its width and its height.
 *
 * @class RoundedRectangle
 * @constructor
 * @param x {Number} The X coordinate of the upper-left corner of the rounded rectangle
 * @param y {Number} The Y coordinate of the upper-left corner of the rounded rectangle
 * @param width {Number} The overall width of this rounded rectangle
 * @param height {Number} The overall height of this rounded rectangle
 * @param radius {Number} Controls the radius of the rounded corners 
 */PIXI.RoundedRectangle=function(x,y,width,height,radius){/**
     * @property x
     * @type Number
     * @default 0
     */this.x=x||0;/**
     * @property y
     * @type Number
     * @default 0
     */this.y=y||0;/**
     * @property width
     * @type Number
     * @default 0
     */this.width=width||0;/**
     * @property height
     * @type Number
     * @default 0
     */this.height=height||0;/**
     * @property radius
     * @type Number
     * @default 20
     */this.radius=radius||20;/**
     * The type of the object, should be one of the Graphics type consts, PIXI.Graphics.RRECT in this case
     * @property type
     * @type Number
     * @default 0
     */};/**
 * Creates a clone of this Rounded Rectangle
 *
 * @method clone
 * @return {RoundedRectangle} a copy of the rounded rectangle
 */PIXI.RoundedRectangle.prototype.clone=function(){return new PIXI.RoundedRectangle(this.x,this.y,this.width,this.height,this.radius);};/**
 * Checks whether the x and y coordinates given are contained within this Rounded Rectangle
 *
 * @method contains
 * @param x {Number} The X coordinate of the point to test
 * @param y {Number} The Y coordinate of the point to test
 * @return {Boolean} Whether the x/y coordinates are within this Rounded Rectangle
 */PIXI.RoundedRectangle.prototype.contains=function(x,y){if(this.width<=0||this.height<=0)return false;var x1=this.x;if(x>=x1&&x<=x1+this.width){var y1=this.y;if(y>=y1&&y<=y1+this.height){return true;}}return false;};// constructor
PIXI.RoundedRectangle.prototype.constructor=PIXI.RoundedRectangle;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The Matrix class is now an object, which makes it a lot faster, 
 * here is a representation of it : 
 * | a | b | tx|
 * | c | d | ty|
 * | 0 | 0 | 1 |
 *
 * @class Matrix
 * @constructor
 */PIXI.Matrix=function(){/**
     * @property a
     * @type Number
     * @default 1
     */this.a=1;/**
     * @property b
     * @type Number
     * @default 0
     */this.b=0;/**
     * @property c
     * @type Number
     * @default 0
     */this.c=0;/**
     * @property d
     * @type Number
     * @default 1
     */this.d=1;/**
     * @property tx
     * @type Number
     * @default 0
     */this.tx=0;/**
     * @property ty
     * @type Number
     * @default 0
     */this.ty=0;};/**
 * Creates a Matrix object based on the given array. The Element to Matrix mapping order is as follows:
 *
 * a = array[0]
 * b = array[1]
 * c = array[3]
 * d = array[4]
 * tx = array[2]
 * ty = array[5]
 *
 * @method fromArray
 * @param array {Array} The array that the matrix will be populated from.
 */PIXI.Matrix.prototype.fromArray=function(array){this.a=array[0];this.b=array[1];this.c=array[3];this.d=array[4];this.tx=array[2];this.ty=array[5];};/**
 * Creates an array from the current Matrix object.
 *
 * @method toArray
 * @param transpose {Boolean} Whether we need to transpose the matrix or not
 * @return {Array} the newly created array which contains the matrix
 */PIXI.Matrix.prototype.toArray=function(transpose){if(!this.array)this.array=new PIXI.Float32Array(9);var array=this.array;if(transpose){array[0]=this.a;array[1]=this.b;array[2]=0;array[3]=this.c;array[4]=this.d;array[5]=0;array[6]=this.tx;array[7]=this.ty;array[8]=1;}else{array[0]=this.a;array[1]=this.c;array[2]=this.tx;array[3]=this.b;array[4]=this.d;array[5]=this.ty;array[6]=0;array[7]=0;array[8]=1;}return array;};/**
 * Get a new position with the current transformation applied.
 * Can be used to go from a child's coordinate space to the world coordinate space. (e.g. rendering)
 *
 * @method apply
 * @param pos {Point} The origin
 * @param [newPos] {Point} The point that the new position is assigned to (allowed to be same as input)
 * @return {Point} The new point, transformed through this matrix
 */PIXI.Matrix.prototype.apply=function(pos,newPos){newPos=newPos||new PIXI.Point();newPos.x=this.a*pos.x+this.c*pos.y+this.tx;newPos.y=this.b*pos.x+this.d*pos.y+this.ty;return newPos;};/**
 * Get a new position with the inverse of the current transformation applied.
 * Can be used to go from the world coordinate space to a child's coordinate space. (e.g. input)
 *
 * @method applyInverse
 * @param pos {Point} The origin
 * @param [newPos] {Point} The point that the new position is assigned to (allowed to be same as input)
 * @return {Point} The new point, inverse-transformed through this matrix
 */PIXI.Matrix.prototype.applyInverse=function(pos,newPos){newPos=newPos||new PIXI.Point();var id=1/(this.a*this.d+this.c*-this.b);newPos.x=this.d*id*pos.x+-this.c*id*pos.y+(this.ty*this.c-this.tx*this.d)*id;newPos.y=this.a*id*pos.y+-this.b*id*pos.x+(-this.ty*this.a+this.tx*this.b)*id;return newPos;};/**
 * Translates the matrix on the x and y.
 * 
 * @method translate
 * @param {Number} x
 * @param {Number} y
 * @return {Matrix} This matrix. Good for chaining method calls.
 **/PIXI.Matrix.prototype.translate=function(x,y){this.tx+=x;this.ty+=y;return this;};/**
 * Applies a scale transformation to the matrix.
 * 
 * @method scale
 * @param {Number} x The amount to scale horizontally
 * @param {Number} y The amount to scale vertically
 * @return {Matrix} This matrix. Good for chaining method calls.
 **/PIXI.Matrix.prototype.scale=function(x,y){this.a*=x;this.d*=y;this.c*=x;this.b*=y;this.tx*=x;this.ty*=y;return this;};/**
 * Applies a rotation transformation to the matrix.
 * @method rotate
 * @param {Number} angle The angle in radians.
 * @return {Matrix} This matrix. Good for chaining method calls.
 **/PIXI.Matrix.prototype.rotate=function(angle){var cos=Math.cos(angle);var sin=Math.sin(angle);var a1=this.a;var c1=this.c;var tx1=this.tx;this.a=a1*cos-this.b*sin;this.b=a1*sin+this.b*cos;this.c=c1*cos-this.d*sin;this.d=c1*sin+this.d*cos;this.tx=tx1*cos-this.ty*sin;this.ty=tx1*sin+this.ty*cos;return this;};/**
 * Appends the given Matrix to this Matrix.
 * 
 * @method append
 * @param {Matrix} matrix
 * @return {Matrix} This matrix. Good for chaining method calls.
 */PIXI.Matrix.prototype.append=function(matrix){var a1=this.a;var b1=this.b;var c1=this.c;var d1=this.d;this.a=matrix.a*a1+matrix.b*c1;this.b=matrix.a*b1+matrix.b*d1;this.c=matrix.c*a1+matrix.d*c1;this.d=matrix.c*b1+matrix.d*d1;this.tx=matrix.tx*a1+matrix.ty*c1+this.tx;this.ty=matrix.tx*b1+matrix.ty*d1+this.ty;return this;};/**
 * Resets this Matix to an identity (default) matrix.
 * 
 * @method identity
 * @return {Matrix} This matrix. Good for chaining method calls.
 */PIXI.Matrix.prototype.identity=function(){this.a=1;this.b=0;this.c=0;this.d=1;this.tx=0;this.ty=0;return this;};PIXI.identityMatrix=new PIXI.Matrix();/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The base class for all objects that are rendered on the screen.
 * This is an abstract class and should not be used on its own rather it should be extended.
 *
 * @class DisplayObject
 * @constructor
 */PIXI.DisplayObject=function(){/**
     * The coordinate of the object relative to the local coordinates of the parent.
     *
     * @property position
     * @type Point
     */this.position=new PIXI.Point();/**
     * The scale factor of the object.
     *
     * @property scale
     * @type Point
     */this.scale=new PIXI.Point(1,1);//{x:1, y:1};
/**
     * The pivot point of the displayObject that it rotates around
     *
     * @property pivot
     * @type Point
     */this.pivot=new PIXI.Point(0,0);/**
     * The rotation of the object in radians.
     *
     * @property rotation
     * @type Number
     */this.rotation=0;/**
     * The opacity of the object.
     *
     * @property alpha
     * @type Number
     */this.alpha=1;/**
     * The visibility of the object.
     *
     * @property visible
     * @type Boolean
     */this.visible=true;/**
     * This is the defined area that will pick up mouse / touch events. It is null by default.
     * Setting it is a neat way of optimising the hitTest function that the interactionManager will use (as it will not need to hit test all the children)
     *
     * @property hitArea
     * @type Rectangle|Circle|Ellipse|Polygon
     */this.hitArea=null;/**
     * This is used to indicate if the displayObject should display a mouse hand cursor on rollover
     *
     * @property buttonMode
     * @type Boolean
     */this.buttonMode=false;/**
     * Can this object be rendered
     *
     * @property renderable
     * @type Boolean
     */this.renderable=false;/**
     * [read-only] The display object container that contains this display object.
     *
     * @property parent
     * @type DisplayObjectContainer
     * @readOnly
     */this.parent=null;/**
     * [read-only] The stage the display object is connected to, or undefined if it is not connected to the stage.
     *
     * @property stage
     * @type Stage
     * @readOnly
     */this.stage=null;/**
     * [read-only] The multiplied alpha of the displayObject
     *
     * @property worldAlpha
     * @type Number
     * @readOnly
     */this.worldAlpha=1;/**
     * [read-only] Whether or not the object is interactive, do not toggle directly! use the `interactive` property
     *
     * @property _interactive
     * @type Boolean
     * @readOnly
     * @private
     */this._interactive=false;/**
     * This is the cursor that will be used when the mouse is over this object. To enable this the element must have interaction = true and buttonMode = true
     *
     * @property defaultCursor
     * @type String
     *
    */this.defaultCursor='pointer';/**
     * [read-only] Current transform of the object based on world (parent) factors
     *
     * @property worldTransform
     * @type Matrix
     * @readOnly
     * @private
     */this.worldTransform=new PIXI.Matrix();/**
     * cached sin rotation and cos rotation
     *
     * @property _sr
     * @type Number
     * @private
     */this._sr=0;/**
     * cached sin rotation and cos rotation
     *
     * @property _cr
     * @type Number
     * @private
     */this._cr=1;/**
     * The area the filter is applied to like the hitArea this is used as more of an optimisation
     * rather than figuring out the dimensions of the displayObject each frame you can set this rectangle
     *
     * @property filterArea
     * @type Rectangle
     */this.filterArea=null;//new PIXI.Rectangle(0,0,1,1);
/**
     * The original, cached bounds of the object
     *
     * @property _bounds
     * @type Rectangle
     * @private
     */this._bounds=new PIXI.Rectangle(0,0,1,1);/**
     * The most up-to-date bounds of the object
     *
     * @property _currentBounds
     * @type Rectangle
     * @private
     */this._currentBounds=null;/**
     * The original, cached mask of the object
     *
     * @property _currentBounds
     * @type Rectangle
     * @private
     */this._mask=null;/**
     * Cached internal flag.
     *
     * @property _cacheAsBitmap
     * @type Boolean
     * @private
     */this._cacheAsBitmap=false;/**
     * Cached internal flag.
     *
     * @property _cacheIsDirty
     * @type Boolean
     * @private
     */this._cacheIsDirty=false;/*
     * MOUSE Callbacks
     */ /**
     * A callback that is used when the users mouse rolls over the displayObject
     * @method mouseover
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the users mouse leaves the displayObject
     * @method mouseout
     * @param interactionData {InteractionData}
     */ //Left button
/**
     * A callback that is used when the users clicks on the displayObject with their mouse's left button
     * @method click
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user clicks the mouse's left button down over the sprite
     * @method mousedown
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases the mouse's left button that was over the displayObject
     * for this callback to be fired, the mouse's left button must have been pressed down over the displayObject
     * @method mouseup
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases the mouse's left button that was over the displayObject but is no longer over the displayObject
     * for this callback to be fired, the mouse's left button must have been pressed down over the displayObject
     * @method mouseupoutside
     * @param interactionData {InteractionData}
     */ //Right button
/**
     * A callback that is used when the users clicks on the displayObject with their mouse's right button
     * @method rightclick
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user clicks the mouse's right button down over the sprite
     * @method rightdown
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases the mouse's right button that was over the displayObject
     * for this callback to be fired the mouse's right button must have been pressed down over the displayObject
     * @method rightup
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases the mouse's right button that was over the displayObject but is no longer over the displayObject
     * for this callback to be fired, the mouse's right button must have been pressed down over the displayObject
     * @method rightupoutside
     * @param interactionData {InteractionData}
     */ /*
     * TOUCH Callbacks
     */ /**
     * A callback that is used when the users taps on the sprite with their finger
     * basically a touch version of click
     * @method tap
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user touches over the displayObject
     * @method touchstart
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases a touch over the displayObject
     * @method touchend
     * @param interactionData {InteractionData}
     */ /**
     * A callback that is used when the user releases the touch that was over the displayObject
     * for this callback to be fired, The touch must have started over the sprite
     * @method touchendoutside
     * @param interactionData {InteractionData}
     */};// constructor
PIXI.DisplayObject.prototype.constructor=PIXI.DisplayObject;/**
 * Indicates if the sprite will have touch and mouse interactivity. It is false by default
 *
 * @property interactive
 * @type Boolean
 * @default false
 */Object.defineProperty(PIXI.DisplayObject.prototype,'interactive',{get:function(){return this._interactive;},set:function(value){this._interactive=value;// TODO more to be done here..
// need to sort out a re-crawl!
if(this.stage)this.stage.dirty=true;}});/**
 * [read-only] Indicates if the sprite is globally visible.
 *
 * @property worldVisible
 * @type Boolean
 */Object.defineProperty(PIXI.DisplayObject.prototype,'worldVisible',{get:function(){var item=this;do{if(!item.visible)return false;item=item.parent;}while(item);return true;}});/**
 * Sets a mask for the displayObject. A mask is an object that limits the visibility of an object to the shape of the mask applied to it.
 * In PIXI a regular mask must be a PIXI.Graphics object. This allows for much faster masking in canvas as it utilises shape clipping.
 * To remove a mask, set this property to null.
 *
 * @property mask
 * @type Graphics
 */Object.defineProperty(PIXI.DisplayObject.prototype,'mask',{get:function(){return this._mask;},set:function(value){if(this._mask)this._mask.isMask=false;this._mask=value;if(this._mask)this._mask.isMask=true;}});/**
 * Sets the filters for the displayObject.
 * * IMPORTANT: This is a webGL only feature and will be ignored by the canvas renderer.
 * To remove filters simply set this property to 'null'
 * @property filters
 * @type Array(Filter)
 */Object.defineProperty(PIXI.DisplayObject.prototype,'filters',{get:function(){return this._filters;},set:function(value){if(value){// now put all the passes in one place..
var passes=[];for(var i=0;i<value.length;i++){var filterPasses=value[i].passes;for(var j=0;j<filterPasses.length;j++){passes.push(filterPasses[j]);}}// TODO change this as it is legacy
this._filterBlock={target:this,filterPasses:passes};}this._filters=value;}});/**
 * Set if this display object is cached as a bitmap.
 * This basically takes a snap shot of the display object as it is at that moment. It can provide a performance benefit for complex static displayObjects.
 * To remove simply set this property to 'null'
 * @property cacheAsBitmap
 * @type Boolean
 */Object.defineProperty(PIXI.DisplayObject.prototype,'cacheAsBitmap',{get:function(){return this._cacheAsBitmap;},set:function(value){if(this._cacheAsBitmap===value)return;if(value){this._generateCachedSprite();}else{this._destroyCachedSprite();}this._cacheAsBitmap=value;}});/*
 * Updates the object transform for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.DisplayObject.prototype.updateTransform=function(){// create some matrix refs for easy access
var pt=this.parent.worldTransform;var wt=this.worldTransform;// temporary matrix variables
var a,b,c,d,tx,ty;// so if rotation is between 0 then we can simplify the multiplication process..
if(this.rotation%PIXI.PI_2){// check to see if the rotation is the same as the previous render. This means we only need to use sin and cos when rotation actually changes
if(this.rotation!==this.rotationCache){this.rotationCache=this.rotation;this._sr=Math.sin(this.rotation);this._cr=Math.cos(this.rotation);}// get the matrix values of the displayobject based on its transform properties..
a=this._cr*this.scale.x;b=this._sr*this.scale.x;c=-this._sr*this.scale.y;d=this._cr*this.scale.y;tx=this.position.x;ty=this.position.y;// check for pivot.. not often used so geared towards that fact!
if(this.pivot.x||this.pivot.y){tx-=this.pivot.x*a+this.pivot.y*c;ty-=this.pivot.x*b+this.pivot.y*d;}// concat the parent matrix with the objects transform.
wt.a=a*pt.a+b*pt.c;wt.b=a*pt.b+b*pt.d;wt.c=c*pt.a+d*pt.c;wt.d=c*pt.b+d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty;}else{// lets do the fast version as we know there is no rotation..
a=this.scale.x;d=this.scale.y;tx=this.position.x-this.pivot.x*a;ty=this.position.y-this.pivot.y*d;wt.a=a*pt.a;wt.b=a*pt.b;wt.c=d*pt.c;wt.d=d*pt.d;wt.tx=tx*pt.a+ty*pt.c+pt.tx;wt.ty=tx*pt.b+ty*pt.d+pt.ty;}// multiply the alphas..
this.worldAlpha=this.alpha*this.parent.worldAlpha;};// performance increase to avoid using call.. (10x faster)
PIXI.DisplayObject.prototype.displayObjectUpdateTransform=PIXI.DisplayObject.prototype.updateTransform;/**
 * Retrieves the bounds of the displayObject as a rectangle object
 *
 * @method getBounds
 * @param matrix {Matrix}
 * @return {Rectangle} the rectangular bounding area
 */PIXI.DisplayObject.prototype.getBounds=function(matrix){matrix=matrix;//just to get passed js hinting (and preserve inheritance)
return PIXI.EmptyRectangle;};/**
 * Retrieves the local bounds of the displayObject as a rectangle object
 *
 * @method getLocalBounds
 * @return {Rectangle} the rectangular bounding area
 */PIXI.DisplayObject.prototype.getLocalBounds=function(){return this.getBounds(PIXI.identityMatrix);///PIXI.EmptyRectangle();
};/**
 * Sets the object's stage reference, the stage this object is connected to
 *
 * @method setStageReference
 * @param stage {Stage} the stage that the object will have as its current stage reference
 */PIXI.DisplayObject.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true;};/**
 * Useful function that returns a texture of the displayObject object that can then be used to create sprites
 * This can be quite useful if your displayObject is static / complicated and needs to be reused multiple times.
 *
 * @method generateTexture
 * @param resolution {Number} The resolution of the texture being generated
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @param renderer {CanvasRenderer|WebGLRenderer} The renderer used to generate the texture.
 * @return {Texture} a texture of the graphics object
 */PIXI.DisplayObject.prototype.generateTexture=function(resolution,scaleMode,renderer){var bounds=this.getLocalBounds();var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0,renderer,scaleMode,resolution);PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;renderTexture.render(this,PIXI.DisplayObject._tempMatrix);return renderTexture;};/**
 * Generates and updates the cached sprite for this object.
 *
 * @method updateCache
 */PIXI.DisplayObject.prototype.updateCache=function(){this._generateCachedSprite();};/**
 * Calculates the global position of the display object
 *
 * @method toGlobal
 * @param position {Point} The world origin to calculate from
 * @return {Point} A point object representing the position of this object
 */PIXI.DisplayObject.prototype.toGlobal=function(position){// don't need to u[date the lot
this.displayObjectUpdateTransform();return this.worldTransform.apply(position);};/**
 * Calculates the local position of the display object relative to another point
 *
 * @method toLocal
 * @param position {Point} The world origin to calculate from
 * @param [from] {DisplayObject} The DisplayObject to calculate the global position from
 * @return {Point} A point object representing the position of this object
 */PIXI.DisplayObject.prototype.toLocal=function(position,from){// 
if(from){position=from.toGlobal(position);}// don't need to u[date the lot
this.displayObjectUpdateTransform();return this.worldTransform.applyInverse(position);};/**
 * Internal method.
 *
 * @method _renderCachedSprite
 * @param renderSession {Object} The render session
 * @private
 */PIXI.DisplayObject.prototype._renderCachedSprite=function(renderSession){this._cachedSprite.worldAlpha=this.worldAlpha;if(renderSession.gl){PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession);}else{PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession);}};/**
 * Internal method.
 *
 * @method _generateCachedSprite
 * @private
 */PIXI.DisplayObject.prototype._generateCachedSprite=function(){this._cacheAsBitmap=false;var bounds=this.getLocalBounds();if(!this._cachedSprite){var renderTexture=new PIXI.RenderTexture(bounds.width|0,bounds.height|0);//, renderSession.renderer);
this._cachedSprite=new PIXI.Sprite(renderTexture);this._cachedSprite.worldTransform=this.worldTransform;}else{this._cachedSprite.texture.resize(bounds.width|0,bounds.height|0);}//REMOVE filter!
var tempFilters=this._filters;this._filters=null;this._cachedSprite.filters=tempFilters;PIXI.DisplayObject._tempMatrix.tx=-bounds.x;PIXI.DisplayObject._tempMatrix.ty=-bounds.y;this._cachedSprite.texture.render(this,PIXI.DisplayObject._tempMatrix,true);this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);this._filters=tempFilters;this._cacheAsBitmap=true;};/**
* Destroys the cached sprite.
*
* @method _destroyCachedSprite
* @private
*/PIXI.DisplayObject.prototype._destroyCachedSprite=function(){if(!this._cachedSprite)return;this._cachedSprite.texture.destroy(true);// TODO could be object pooled!
this._cachedSprite=null;};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession}
* @private
*/PIXI.DisplayObject.prototype._renderWebGL=function(renderSession){// OVERWRITE;
// this line is just here to pass jshinting :)
renderSession=renderSession;};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession}
* @private
*/PIXI.DisplayObject.prototype._renderCanvas=function(renderSession){// OVERWRITE;
// this line is just here to pass jshinting :)
renderSession=renderSession;};PIXI.DisplayObject._tempMatrix=new PIXI.Matrix();/**
 * The position of the displayObject on the x axis relative to the local coordinates of the parent.
 *
 * @property x
 * @type Number
 */Object.defineProperty(PIXI.DisplayObject.prototype,'x',{get:function(){return this.position.x;},set:function(value){this.position.x=value;}});/**
 * The position of the displayObject on the y axis relative to the local coordinates of the parent.
 *
 * @property y
 * @type Number
 */Object.defineProperty(PIXI.DisplayObject.prototype,'y',{get:function(){return this.position.y;},set:function(value){this.position.y=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A DisplayObjectContainer represents a collection of display objects.
 * It is the base class of all display objects that act as a container for other objects.
 *
 * @class DisplayObjectContainer
 * @extends DisplayObject
 * @constructor
 */PIXI.DisplayObjectContainer=function(){PIXI.DisplayObject.call(this);/**
     * [read-only] The array of children of this container.
     *
     * @property children
     * @type Array(DisplayObject)
     * @readOnly
     */this.children=[];// fast access to update transform..
};// constructor
PIXI.DisplayObjectContainer.prototype=Object.create(PIXI.DisplayObject.prototype);PIXI.DisplayObjectContainer.prototype.constructor=PIXI.DisplayObjectContainer;/**
 * The width of the displayObjectContainer, setting this will actually modify the scale to achieve the value set
 *
 * @property width
 * @type Number
 */Object.defineProperty(PIXI.DisplayObjectContainer.prototype,'width',{get:function(){return this.scale.x*this.getLocalBounds().width;},set:function(value){var width=this.getLocalBounds().width;if(width!==0){this.scale.x=value/width;}else{this.scale.x=1;}this._width=value;}});/**
 * The height of the displayObjectContainer, setting this will actually modify the scale to achieve the value set
 *
 * @property height
 * @type Number
 */Object.defineProperty(PIXI.DisplayObjectContainer.prototype,'height',{get:function(){return this.scale.y*this.getLocalBounds().height;},set:function(value){var height=this.getLocalBounds().height;if(height!==0){this.scale.y=value/height;}else{this.scale.y=1;}this._height=value;}});/**
 * Adds a child to the container.
 *
 * @method addChild
 * @param child {DisplayObject} The DisplayObject to add to the container
 * @return {DisplayObject} The child that was added.
 */PIXI.DisplayObjectContainer.prototype.addChild=function(child){return this.addChildAt(child,this.children.length);};/**
 * Adds a child to the container at a specified index. If the index is out of bounds an error will be thrown
 *
 * @method addChildAt
 * @param child {DisplayObject} The child to add
 * @param index {Number} The index to place the child in
 * @return {DisplayObject} The child that was added.
 */PIXI.DisplayObjectContainer.prototype.addChildAt=function(child,index){if(index>=0&&index<=this.children.length){if(child.parent){child.parent.removeChild(child);}child.parent=this;this.children.splice(index,0,child);if(this.stage)child.setStageReference(this.stage);return child;}else{throw new Error(child+'addChildAt: The index '+index+' supplied is out of bounds '+this.children.length);}};/**
 * Swaps the position of 2 Display Objects within this container.
 *
 * @method swapChildren
 * @param child {DisplayObject}
 * @param child2 {DisplayObject}
 */PIXI.DisplayObjectContainer.prototype.swapChildren=function(child,child2){if(child===child2){return;}var index1=this.getChildIndex(child);var index2=this.getChildIndex(child2);if(index1<0||index2<0){throw new Error('swapChildren: Both the supplied DisplayObjects must be a child of the caller.');}this.children[index1]=child2;this.children[index2]=child;};/**
 * Returns the index position of a child DisplayObject instance
 *
 * @method getChildIndex
 * @param child {DisplayObject} The DisplayObject instance to identify
 * @return {Number} The index position of the child display object to identify
 */PIXI.DisplayObjectContainer.prototype.getChildIndex=function(child){var index=this.children.indexOf(child);if(index===-1){throw new Error('The supplied DisplayObject must be a child of the caller');}return index;};/**
 * Changes the position of an existing child in the display object container
 *
 * @method setChildIndex
 * @param child {DisplayObject} The child DisplayObject instance for which you want to change the index number
 * @param index {Number} The resulting index number for the child display object
 */PIXI.DisplayObjectContainer.prototype.setChildIndex=function(child,index){if(index<0||index>=this.children.length){throw new Error('The supplied index is out of bounds');}var currentIndex=this.getChildIndex(child);this.children.splice(currentIndex,1);//remove from old position
this.children.splice(index,0,child);//add at new position
};/**
 * Returns the child at the specified index
 *
 * @method getChildAt
 * @param index {Number} The index to get the child from
 * @return {DisplayObject} The child at the given index, if any.
 */PIXI.DisplayObjectContainer.prototype.getChildAt=function(index){if(index<0||index>=this.children.length){throw new Error('getChildAt: Supplied index '+index+' does not exist in the child list, or the supplied DisplayObject must be a child of the caller');}return this.children[index];};/**
 * Removes a child from the container.
 *
 * @method removeChild
 * @param child {DisplayObject} The DisplayObject to remove
 * @return {DisplayObject} The child that was removed.
 */PIXI.DisplayObjectContainer.prototype.removeChild=function(child){var index=this.children.indexOf(child);if(index===-1)return;return this.removeChildAt(index);};/**
 * Removes a child from the specified index position.
 *
 * @method removeChildAt
 * @param index {Number} The index to get the child from
 * @return {DisplayObject} The child that was removed.
 */PIXI.DisplayObjectContainer.prototype.removeChildAt=function(index){var child=this.getChildAt(index);if(this.stage)child.removeStageReference();child.parent=undefined;this.children.splice(index,1);return child;};/**
* Removes all children from this container that are within the begin and end indexes.
*
* @method removeChildren
* @param beginIndex {Number} The beginning position. Default value is 0.
* @param endIndex {Number} The ending position. Default value is size of the container.
*/PIXI.DisplayObjectContainer.prototype.removeChildren=function(beginIndex,endIndex){var begin=beginIndex||0;var end=typeof endIndex==='number'?endIndex:this.children.length;var range=end-begin;if(range>0&&range<=end){var removed=this.children.splice(begin,range);for(var i=0;i<removed.length;i++){var child=removed[i];if(this.stage)child.removeStageReference();child.parent=undefined;}return removed;}else if(range===0&&this.children.length===0){return[];}else{throw new Error('removeChildren: Range Error, numeric values are outside the acceptable range');}};/*
 * Updates the transform on all children of this container for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.DisplayObjectContainer.prototype.updateTransform=function(){if(!this.visible)return;this.displayObjectUpdateTransform();//PIXI.DisplayObject.prototype.updateTransform.call( this );
if(this._cacheAsBitmap)return;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform();}};// performance increase to avoid using call.. (10x faster)
PIXI.DisplayObjectContainer.prototype.displayObjectContainerUpdateTransform=PIXI.DisplayObjectContainer.prototype.updateTransform;/**
 * Retrieves the bounds of the displayObjectContainer as a rectangle. The bounds calculation takes all visible children into consideration.
 *
 * @method getBounds
 * @return {Rectangle} The rectangular bounding area
 */PIXI.DisplayObjectContainer.prototype.getBounds=function(){if(this.children.length===0)return PIXI.EmptyRectangle;// TODO the bounds have already been calculated this render session so return what we have
var minX=Infinity;var minY=Infinity;var maxX=-Infinity;var maxY=-Infinity;var childBounds;var childMaxX;var childMaxY;var childVisible=false;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];if(!child.visible)continue;childVisible=true;childBounds=this.children[i].getBounds();minX=minX<childBounds.x?minX:childBounds.x;minY=minY<childBounds.y?minY:childBounds.y;childMaxX=childBounds.width+childBounds.x;childMaxY=childBounds.height+childBounds.y;maxX=maxX>childMaxX?maxX:childMaxX;maxY=maxY>childMaxY?maxY:childMaxY;}if(!childVisible)return PIXI.EmptyRectangle;var bounds=this._bounds;bounds.x=minX;bounds.y=minY;bounds.width=maxX-minX;bounds.height=maxY-minY;// TODO: store a reference so that if this function gets called again in the render cycle we do not have to recalculate
//this._currentBounds = bounds;
return bounds;};/**
 * Retrieves the non-global local bounds of the displayObjectContainer as a rectangle. The calculation takes all visible children into consideration.
 *
 * @method getLocalBounds
 * @return {Rectangle} The rectangular bounding area
 */PIXI.DisplayObjectContainer.prototype.getLocalBounds=function(){var matrixCache=this.worldTransform;this.worldTransform=PIXI.identityMatrix;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform();}var bounds=this.getBounds();this.worldTransform=matrixCache;return bounds;};/**
 * Sets the containers Stage reference. This is the Stage that this object, and all of its children, is connected to.
 *
 * @method setStageReference
 * @param stage {Stage} the stage that the container will have as its current stage reference
 */PIXI.DisplayObjectContainer.prototype.setStageReference=function(stage){this.stage=stage;if(this._interactive)this.stage.dirty=true;for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.setStageReference(stage);}};/**
 * Removes the current stage reference from the container and all of its children.
 *
 * @method removeStageReference
 */PIXI.DisplayObjectContainer.prototype.removeStageReference=function(){for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child.removeStageReference();}if(this._interactive)this.stage.dirty=true;this.stage=null;};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession} 
* @private
*/PIXI.DisplayObjectContainer.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return;}var i,j;if(this._mask||this._filters){// push filter first as we need to ensure the stencil buffer is correct for any masking
if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock);}if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start();}// simple render children!
for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}renderSession.spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();renderSession.spriteBatch.start();}else{// simple render children!
for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}}};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession} 
* @private
*/PIXI.DisplayObjectContainer.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;if(this._cacheAsBitmap){this._renderCachedSprite(renderSession);return;}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession);}for(var i=0,j=this.children.length;i<j;i++){var child=this.children[i];child._renderCanvas(renderSession);}if(this._mask){renderSession.maskManager.popMask(renderSession);}};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The Sprite object is the base for all textured objects that are rendered to the screen
 *
 * @class Sprite
 * @extends DisplayObjectContainer
 * @constructor
 * @param texture {Texture} The texture for this sprite
 *
 * A sprite can be created directly from an image like this :
 * var sprite = new PIXI.Sprite.fromImage('assets/image.png');
 * yourStage.addChild(sprite);
 * then obviously don't forget to add it to the stage you have already created
 */PIXI.Sprite=function(texture){PIXI.DisplayObjectContainer.call(this);/**
     * The anchor sets the origin point of the texture.
     * The default is 0,0 this means the texture's origin is the top left
     * Setting than anchor to 0.5,0.5 means the textures origin is centered
     * Setting the anchor to 1,1 would mean the textures origin points will be the bottom right corner
     *
     * @property anchor
     * @type Point
     */this.anchor=new PIXI.Point();/**
     * The texture that the sprite is using
     *
     * @property texture
     * @type Texture
     */this.texture=texture||PIXI.Texture.emptyTexture;/**
     * The width of the sprite (this is initially set by the texture)
     *
     * @property _width
     * @type Number
     * @private
     */this._width=0;/**
     * The height of the sprite (this is initially set by the texture)
     *
     * @property _height
     * @type Number
     * @private
     */this._height=0;/**
     * The tint applied to the sprite. This is a hex value. A value of 0xFFFFFF will remove any tint effect.
     *
     * @property tint
     * @type Number
     * @default 0xFFFFFF
     */this.tint=0xFFFFFF;/**
     * The blend mode to be applied to the sprite. Set to PIXI.blendModes.NORMAL to remove any blend mode.
     *
     * @property blendMode
     * @type Number
     * @default PIXI.blendModes.NORMAL;
     */this.blendMode=PIXI.blendModes.NORMAL;/**
     * The shader that will be used to render the texture to the stage. Set to null to remove a current shader.
     *
     * @property shader
     * @type AbstractFilter
     * @default null
     */this.shader=null;if(this.texture.baseTexture.hasLoaded){this.onTextureUpdate();}else{this.texture.on('update',this.onTextureUpdate.bind(this));}this.renderable=true;};// constructor
PIXI.Sprite.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Sprite.prototype.constructor=PIXI.Sprite;/**
 * The width of the sprite, setting this will actually modify the scale to achieve the value set
 *
 * @property width
 * @type Number
 */Object.defineProperty(PIXI.Sprite.prototype,'width',{get:function(){return this.scale.x*this.texture.frame.width;},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value;}});/**
 * The height of the sprite, setting this will actually modify the scale to achieve the value set
 *
 * @property height
 * @type Number
 */Object.defineProperty(PIXI.Sprite.prototype,'height',{get:function(){return this.scale.y*this.texture.frame.height;},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value;}});/**
 * Sets the texture of the sprite
 *
 * @method setTexture
 * @param texture {Texture} The PIXI texture that is displayed by the sprite
 */PIXI.Sprite.prototype.setTexture=function(texture){this.texture=texture;this.cachedTint=0xFFFFFF;};/**
 * When the texture is updated, this event will fire to update the scale and frame
 *
 * @method onTextureUpdate
 * @param event
 * @private
 */PIXI.Sprite.prototype.onTextureUpdate=function(){// so if _width is 0 then width was not set..
if(this._width)this.scale.x=this._width/this.texture.frame.width;if(this._height)this.scale.y=this._height/this.texture.frame.height;//this.updateFrame = true;
};/**
* Returns the bounds of the Sprite as a rectangle. The bounds calculation takes the worldTransform into account.
*
* @method getBounds
* @param matrix {Matrix} the transformation matrix of the sprite
* @return {Rectangle} the framing rectangle
*/PIXI.Sprite.prototype.getBounds=function(matrix){var width=this.texture.frame.width;var height=this.texture.frame.height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;if(b===0&&c===0){// scale may be negative!
if(a<0)a*=-1;if(d<0)d*=-1;// this means there is no rotation going on right? RIGHT?
// if thats the case then we can avoid checking the bound values! yay         
minX=a*w1+tx;maxX=a*w0+tx;minY=d*h1+ty;maxY=d*h0+ty;}else{var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;// store a reference so that if this function gets called again in the render cycle we do not have to recalculate
this._currentBounds=bounds;return bounds;};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession}
* @private
*/PIXI.Sprite.prototype._renderWebGL=function(renderSession){// if the sprite is not visible or the alpha is 0 then no need to render this element
if(!this.visible||this.alpha<=0)return;var i,j;// do a quick check to see if this element has a mask or a filter.
if(this._mask||this._filters){var spriteBatch=renderSession.spriteBatch;// push filter first as we need to ensure the stencil buffer is correct for any masking
if(this._filters){spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock);}if(this._mask){spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);spriteBatch.start();}// add this sprite to the batch
spriteBatch.render(this);// now loop through the children and make sure they get rendered
for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}// time to stop the sprite batch as either a mask element or a filter draw will happen next
spriteBatch.stop();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.popFilter();spriteBatch.start();}else{renderSession.spriteBatch.render(this);// simple render children!
for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}}};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession}
* @private
*/PIXI.Sprite.prototype._renderCanvas=function(renderSession){// If the sprite is not visible or the alpha is 0 then no need to render this element
if(this.visible===false||this.alpha===0||this.texture.crop.width<=0||this.texture.crop.height<=0)return;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;renderSession.context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode];}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession);}//  Ignore null sources
if(this.texture.valid){var resolution=this.texture.baseTexture.resolution/renderSession.resolution;renderSession.context.globalAlpha=this.worldAlpha;//  If smoothingEnabled is supported and we need to change the smoothing property for this texture
if(renderSession.smoothProperty&&renderSession.scaleMode!==this.texture.baseTexture.scaleMode){renderSession.scaleMode=this.texture.baseTexture.scaleMode;renderSession.context[renderSession.smoothProperty]=renderSession.scaleMode===PIXI.scaleModes.LINEAR;}//  If the texture is trimmed we offset by the trim x/y, otherwise we use the frame dimensions
var dx=this.texture.trim?this.texture.trim.x-this.anchor.x*this.texture.trim.width:this.anchor.x*-this.texture.frame.width;var dy=this.texture.trim?this.texture.trim.y-this.anchor.y*this.texture.trim.height:this.anchor.y*-this.texture.frame.height;//  Allow for pixel rounding
if(renderSession.roundPixels){renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution|0,this.worldTransform.ty*renderSession.resolution|0);dx=dx|0;dy=dy|0;}else{renderSession.context.setTransform(this.worldTransform.a,this.worldTransform.b,this.worldTransform.c,this.worldTransform.d,this.worldTransform.tx*renderSession.resolution,this.worldTransform.ty*renderSession.resolution);}if(this.tint!==0xFFFFFF){if(this.cachedTint!==this.tint){this.cachedTint=this.tint;//  TODO clean up caching - how to clean up the caches?
this.tintedTexture=PIXI.CanvasTinter.getTintedTexture(this,this.tint);}renderSession.context.drawImage(this.tintedTexture,0,0,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution);}else{renderSession.context.drawImage(this.texture.baseTexture.source,this.texture.crop.x,this.texture.crop.y,this.texture.crop.width,this.texture.crop.height,dx/resolution,dy/resolution,this.texture.crop.width/resolution,this.texture.crop.height/resolution);}}// OVERWRITE
for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession);}if(this._mask){renderSession.maskManager.popMask(renderSession);}};// some helper functions..
/**
 *
 * Helper function that creates a sprite that will contain a texture from the TextureCache based on the frameId
 * The frame ids are created when a Texture packer file has been loaded
 *
 * @method fromFrame
 * @static
 * @param frameId {String} The frame Id of the texture in the cache
 * @return {Sprite} A new Sprite using a texture from the texture cache matching the frameId
 */PIXI.Sprite.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache'+this);return new PIXI.Sprite(texture);};/**
 *
 * Helper function that creates a sprite that will contain a texture based on an image url
 * If the image is not in the texture cache it will be loaded
 *
 * @method fromImage
 * @static
 * @param imageId {String} The image url of the texture
 * @return {Sprite} A new Sprite using a texture from the texture cache matching the image id
 */PIXI.Sprite.fromImage=function(imageId,crossorigin,scaleMode){var texture=PIXI.Texture.fromImage(imageId,crossorigin,scaleMode);return new PIXI.Sprite(texture);};/**
 * @author Mat Groves http://matgroves.com/
 */ /**
 * The SpriteBatch class is a really fast version of the DisplayObjectContainer
 * built solely for speed, so use when you need a lot of sprites or particles.
 * And it's extremely easy to use :

    var container = new PIXI.SpriteBatch();

    stage.addChild(container);

    for(var i  = 0; i < 100; i++)
    {
        var sprite = new PIXI.Sprite.fromImage("myImage.png");
        container.addChild(sprite);
    }
 * And here you have a hundred sprites that will be renderer at the speed of light
 *
 * @class SpriteBatch
 * @constructor
 * @param texture {Texture}
 */ //TODO RENAME to PARTICLE CONTAINER?
PIXI.SpriteBatch=function(texture){PIXI.DisplayObjectContainer.call(this);this.textureThing=texture;this.ready=false;};PIXI.SpriteBatch.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.SpriteBatch.prototype.constructor=PIXI.SpriteBatch;/*
 * Initialises the spriteBatch
 *
 * @method initWebGL
 * @param gl {WebGLContext} the current WebGL drawing context
 */PIXI.SpriteBatch.prototype.initWebGL=function(gl){// TODO only one needed for the whole engine really?
this.fastSpriteBatch=new PIXI.WebGLFastSpriteBatch(gl);this.ready=true;};/*
 * Updates the object transform for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.SpriteBatch.prototype.updateTransform=function(){// TODO don't need to!
this.displayObjectUpdateTransform();//  PIXI.DisplayObjectContainer.prototype.updateTransform.call( this );
};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession}
* @private
*/PIXI.SpriteBatch.prototype._renderWebGL=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;if(!this.ready)this.initWebGL(renderSession.gl);if(this.fastSpriteBatch.gl!==renderSession.gl)this.fastSpriteBatch.setContext(renderSession.gl);renderSession.spriteBatch.stop();renderSession.shaderManager.setShader(renderSession.shaderManager.fastShader);this.fastSpriteBatch.begin(this,renderSession);this.fastSpriteBatch.render(this);renderSession.spriteBatch.start();};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession}
* @private
*/PIXI.SpriteBatch.prototype._renderCanvas=function(renderSession){if(!this.visible||this.alpha<=0||!this.children.length)return;var context=renderSession.context;context.globalAlpha=this.worldAlpha;this.displayObjectUpdateTransform();var transform=this.worldTransform;// alow for trimming
var isRotated=true;for(var i=0;i<this.children.length;i++){var child=this.children[i];if(!child.visible)continue;var texture=child.texture;var frame=texture.frame;context.globalAlpha=this.worldAlpha*child.alpha;if(child.rotation%(Math.PI*2)===0){if(isRotated){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty);isRotated=false;}// this is the fastest  way to optimise! - if rotation is 0 then we can avoid any kind of setTransform call
context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*(-frame.width*child.scale.x)+child.position.x+0.5|0,child.anchor.y*(-frame.height*child.scale.y)+child.position.y+0.5|0,frame.width*child.scale.x,frame.height*child.scale.y);}else{if(!isRotated)isRotated=true;child.displayObjectUpdateTransform();var childTransform=child.worldTransform;// allow for trimming
if(renderSession.roundPixels){context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx|0,childTransform.ty|0);}else{context.setTransform(childTransform.a,childTransform.b,childTransform.c,childTransform.d,childTransform.tx,childTransform.ty);}context.drawImage(texture.baseTexture.source,frame.x,frame.y,frame.width,frame.height,child.anchor.x*-frame.width+0.5|0,child.anchor.y*-frame.height+0.5|0,frame.width,frame.height);}// context.restore();
}//    context.restore();
};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A MovieClip is a simple way to display an animation depicted by a list of textures.
 *
 * @class MovieClip
 * @extends Sprite
 * @constructor
 * @param textures {Array(Texture)} an array of {Texture} objects that make up the animation
 */PIXI.MovieClip=function(textures){PIXI.Sprite.call(this,textures[0]);/**
     * The array of textures that make up the animation
     *
     * @property textures
     * @type Array(Texture)
     */this.textures=textures;/**
     * The speed that the MovieClip will play at. Higher is faster, lower is slower
     *
     * @property animationSpeed
     * @type Number
     * @default 1
     */this.animationSpeed=1;/**
     * Whether or not the movie clip repeats after playing.
     *
     * @property loop
     * @type Boolean
     * @default true
     */this.loop=true;/**
     * Function to call when a MovieClip finishes playing
     *
     * @property onComplete
     * @type Function
     */this.onComplete=null;/**
     * [read-only] The MovieClips current frame index (this may not have to be a whole number)
     *
     * @property currentFrame
     * @type Number
     * @default 0
     * @readOnly
     */this.currentFrame=0;/**
     * [read-only] Indicates if the MovieClip is currently playing
     *
     * @property playing
     * @type Boolean
     * @readOnly
     */this.playing=false;};// constructor
PIXI.MovieClip.prototype=Object.create(PIXI.Sprite.prototype);PIXI.MovieClip.prototype.constructor=PIXI.MovieClip;/**
* [read-only] totalFrames is the total number of frames in the MovieClip. This is the same as number of textures
* assigned to the MovieClip.
*
* @property totalFrames
* @type Number
* @default 0
* @readOnly
*/Object.defineProperty(PIXI.MovieClip.prototype,'totalFrames',{get:function(){return this.textures.length;}});/**
 * Stops the MovieClip
 *
 * @method stop
 */PIXI.MovieClip.prototype.stop=function(){this.playing=false;};/**
 * Plays the MovieClip
 *
 * @method play
 */PIXI.MovieClip.prototype.play=function(){this.playing=true;};/**
 * Stops the MovieClip and goes to a specific frame
 *
 * @method gotoAndStop
 * @param frameNumber {Number} frame index to stop at
 */PIXI.MovieClip.prototype.gotoAndStop=function(frameNumber){this.playing=false;this.currentFrame=frameNumber;var round=this.currentFrame+0.5|0;this.setTexture(this.textures[round%this.textures.length]);};/**
 * Goes to a specific frame and begins playing the MovieClip
 *
 * @method gotoAndPlay
 * @param frameNumber {Number} frame index to start at
 */PIXI.MovieClip.prototype.gotoAndPlay=function(frameNumber){this.currentFrame=frameNumber;this.playing=true;};/*
 * Updates the object transform for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.MovieClip.prototype.updateTransform=function(){this.displayObjectContainerUpdateTransform();if(!this.playing)return;this.currentFrame+=this.animationSpeed;var round=this.currentFrame+0.5|0;this.currentFrame=this.currentFrame%this.textures.length;if(this.loop||round<this.textures.length){this.setTexture(this.textures[round%this.textures.length]);}else if(round>=this.textures.length){this.gotoAndStop(this.textures.length-1);if(this.onComplete){this.onComplete();}}};/**
 * A short hand way of creating a movieclip from an array of frame ids
 *
 * @static
 * @method fromFrames
 * @param frames {Array} the array of frames ids the movieclip will use as its texture frames
 * @return {MovieClip}
 */PIXI.MovieClip.fromFrames=function(frames){var textures=[];for(var i=0;i<frames.length;i++){textures.push(new PIXI.Texture.fromFrame(frames[i]));}return new PIXI.MovieClip(textures);};/**
 * A short hand way of creating a movieclip from an array of image ids
 *
 * @static
 * @method fromImages
 * @param frames {Array} the array of image ids the movieclip will use as its texture frames
 * @return {MovieClip}
 */PIXI.MovieClip.fromImages=function(images){var textures=[];for(var i=0;i<images.length;i++){textures.push(new PIXI.Texture.fromImage(images[i]));}return new PIXI.MovieClip(textures);};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A target and pass info object for filters.
 * 
 * @class FilterBlock
 * @constructor
 */PIXI.FilterBlock=function(){/**
     * The visible state of this FilterBlock.
     *
     * @property visible
     * @type Boolean
     */this.visible=true;/**
     * The renderable state of this FilterBlock.
     *
     * @property renderable
     * @type Boolean
     */this.renderable=true;};PIXI.FilterBlock.prototype.constructor=PIXI.FilterBlock;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * Modified by Tom Slezakowski http://www.tomslezakowski.com @TomSlezakowski (24/03/2014) - Added dropShadowColor.
 */ /**
 * A Text Object will create a line or multiple lines of text. To split a line you can use '\n' in your text string,
 * or add a wordWrap property set to true and and wordWrapWidth property with a value in the style object.
 *
 * @class Text
 * @extends Sprite
 * @constructor
 * @param text {String} The copy that you would like the text to display
 * @param [style] {Object} The style parameters
 * @param [style.font] {String} default 'bold 20px Arial' The style and size of the font
 * @param [style.fill='black'] {String|Number} A canvas fillstyle that will be used on the text e.g 'red', '#00FF00'
 * @param [style.align='left'] {String} Alignment for multiline text ('left', 'center' or 'right'), does not affect single line text
 * @param [style.stroke] {String|Number} A canvas fillstyle that will be used on the text stroke e.g 'blue', '#FCFF00'
 * @param [style.strokeThickness=0] {Number} A number that represents the thickness of the stroke. Default is 0 (no stroke)
 * @param [style.wordWrap=false] {Boolean} Indicates if word wrap should be used
 * @param [style.wordWrapWidth=100] {Number} The width at which text will wrap, it needs wordWrap to be set to true
 * @param [style.dropShadow=false] {Boolean} Set a drop shadow for the text
 * @param [style.dropShadowColor='#000000'] {String} A fill style to be used on the dropshadow e.g 'red', '#00FF00'
 * @param [style.dropShadowAngle=Math.PI/4] {Number} Set a angle of the drop shadow
 * @param [style.dropShadowDistance=5] {Number} Set a distance of the drop shadow
 * @param [style.lineJoin='miter'] {String} The lineJoin property sets the type of corner created, it can resolve spiked text issue. Default is 'miter' (creates a sharp corner).
 */PIXI.Text=function(text,style){/**
     * The canvas element that everything is drawn to
     *
     * @property canvas
     * @type HTMLCanvasElement
     */this.canvas=document.createElement('canvas');/**
     * The canvas 2d context that everything is drawn with
     * @property context
     * @type CanvasRenderingContext2D
     */this.context=this.canvas.getContext('2d');/**
     * The resolution of the canvas.
     * @property resolution
     * @type Number
     */this.resolution=1;PIXI.Sprite.call(this,PIXI.Texture.fromCanvas(this.canvas));this.setText(text);this.setStyle(style);};// constructor
PIXI.Text.prototype=Object.create(PIXI.Sprite.prototype);PIXI.Text.prototype.constructor=PIXI.Text;/**
 * The width of the Text, setting this will actually modify the scale to achieve the value set
 *
 * @property width
 * @type Number
 */Object.defineProperty(PIXI.Text.prototype,'width',{get:function(){if(this.dirty){this.updateText();this.dirty=false;}return this.scale.x*this.texture.frame.width;},set:function(value){this.scale.x=value/this.texture.frame.width;this._width=value;}});/**
 * The height of the Text, setting this will actually modify the scale to achieve the value set
 *
 * @property height
 * @type Number
 */Object.defineProperty(PIXI.Text.prototype,'height',{get:function(){if(this.dirty){this.updateText();this.dirty=false;}return this.scale.y*this.texture.frame.height;},set:function(value){this.scale.y=value/this.texture.frame.height;this._height=value;}});/**
 * Set the style of the text
 *
 * @method setStyle
 * @param [style] {Object} The style parameters
 * @param [style.font='bold 20pt Arial'] {String} The style and size of the font
 * @param [style.fill='black'] {Object} A canvas fillstyle that will be used on the text eg 'red', '#00FF00'
 * @param [style.align='left'] {String} Alignment for multiline text ('left', 'center' or 'right'), does not affect single line text
 * @param [style.stroke='black'] {String} A canvas fillstyle that will be used on the text stroke eg 'blue', '#FCFF00'
 * @param [style.strokeThickness=0] {Number} A number that represents the thickness of the stroke. Default is 0 (no stroke)
 * @param [style.wordWrap=false] {Boolean} Indicates if word wrap should be used
 * @param [style.wordWrapWidth=100] {Number} The width at which text will wrap
 * @param [style.dropShadow=false] {Boolean} Set a drop shadow for the text
 * @param [style.dropShadowColor='#000000'] {String} A fill style to be used on the dropshadow e.g 'red', '#00FF00'
 * @param [style.dropShadowAngle=Math.PI/4] {Number} Set a angle of the drop shadow
 * @param [style.dropShadowDistance=5] {Number} Set a distance of the drop shadow
 * @param [style.lineJoin='miter'] {String} The lineJoin property sets the type of corner created, it can resolve spiked text issue. Default is 'miter' (creates a sharp corner).
 */PIXI.Text.prototype.setStyle=function(style){style=style||{};style.font=style.font||'bold 20pt Arial';style.fill=style.fill||'black';style.align=style.align||'left';style.stroke=style.stroke||'black';//provide a default, see: https://github.com/GoodBoyDigital/pixi.js/issues/136
style.strokeThickness=style.strokeThickness||0;style.wordWrap=style.wordWrap||false;style.wordWrapWidth=style.wordWrapWidth||100;style.dropShadow=style.dropShadow||false;style.dropShadowAngle=style.dropShadowAngle||Math.PI/6;style.dropShadowDistance=style.dropShadowDistance||4;style.dropShadowColor=style.dropShadowColor||'black';style.lineJoin=style.lineJoin||'miter';this.style=style;this.dirty=true;};/**
 * Set the copy for the text object. To split a line you can use '\n'.
 *
 * @method setText
 * @param text {String} The copy that you would like the text to display
 */PIXI.Text.prototype.setText=function(text){this.text=text.toString()||' ';this.dirty=true;};/**
 * Renders text and updates it when needed
 *
 * @method updateText
 * @private
 */PIXI.Text.prototype.updateText=function(){this.texture.baseTexture.resolution=this.resolution;this.context.font=this.style.font;var outputText=this.text;// word wrap
// preserve original text
if(this.style.wordWrap)outputText=this.wordWrap(this.text);//split text into lines
var lines=outputText.split(/(?:\r\n|\r|\n)/);//calculate text width
var lineWidths=[];var maxLineWidth=0;var fontProperties=this.determineFontProperties(this.style.font);for(var i=0;i<lines.length;i++){var lineWidth=this.context.measureText(lines[i]).width;lineWidths[i]=lineWidth;maxLineWidth=Math.max(maxLineWidth,lineWidth);}var width=maxLineWidth+this.style.strokeThickness;if(this.style.dropShadow)width+=this.style.dropShadowDistance;this.canvas.width=(width+this.context.lineWidth)*this.resolution;//calculate text height
var lineHeight=fontProperties.fontSize+this.style.strokeThickness;var height=lineHeight*lines.length;if(this.style.dropShadow)height+=this.style.dropShadowDistance;this.canvas.height=height*this.resolution;this.context.scale(this.resolution,this.resolution);if(navigator.isCocoonJS)this.context.clearRect(0,0,this.canvas.width,this.canvas.height);// used for debugging..
//this.context.fillStyle ="#FF0000"
//this.context.fillRect(0, 0, this.canvas.width,this.canvas.height);
this.context.font=this.style.font;this.context.strokeStyle=this.style.stroke;this.context.lineWidth=this.style.strokeThickness;this.context.textBaseline='alphabetic';this.context.lineJoin=this.style.lineJoin;var linePositionX;var linePositionY;if(this.style.dropShadow){this.context.fillStyle=this.style.dropShadowColor;var xShadowOffset=Math.sin(this.style.dropShadowAngle)*this.style.dropShadowDistance;var yShadowOffset=Math.cos(this.style.dropShadowAngle)*this.style.dropShadowDistance;for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==='right'){linePositionX+=maxLineWidth-lineWidths[i];}else if(this.style.align==='center'){linePositionX+=(maxLineWidth-lineWidths[i])/2;}if(this.style.fill){this.context.fillText(lines[i],linePositionX+xShadowOffset,linePositionY+yShadowOffset);}//  if(dropShadow)
}}//set canvas text styles
this.context.fillStyle=this.style.fill;//draw lines line by line
for(i=0;i<lines.length;i++){linePositionX=this.style.strokeThickness/2;linePositionY=this.style.strokeThickness/2+i*lineHeight+fontProperties.ascent;if(this.style.align==='right'){linePositionX+=maxLineWidth-lineWidths[i];}else if(this.style.align==='center'){linePositionX+=(maxLineWidth-lineWidths[i])/2;}if(this.style.stroke&&this.style.strokeThickness){this.context.strokeText(lines[i],linePositionX,linePositionY);}if(this.style.fill){this.context.fillText(lines[i],linePositionX,linePositionY);}//  if(dropShadow)
}this.updateTexture();};/**
 * Updates texture size based on canvas size
 *
 * @method updateTexture
 * @private
 */PIXI.Text.prototype.updateTexture=function(){this.texture.baseTexture.width=this.canvas.width;this.texture.baseTexture.height=this.canvas.height;this.texture.crop.width=this.texture.frame.width=this.canvas.width;this.texture.crop.height=this.texture.frame.height=this.canvas.height;this._width=this.canvas.width;this._height=this.canvas.height;// update the dirty base textures
this.texture.baseTexture.dirty();};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession} 
* @private
*/PIXI.Text.prototype._renderWebGL=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false;}PIXI.Sprite.prototype._renderWebGL.call(this,renderSession);};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession} 
* @private
*/PIXI.Text.prototype._renderCanvas=function(renderSession){if(this.dirty){this.resolution=renderSession.resolution;this.updateText();this.dirty=false;}PIXI.Sprite.prototype._renderCanvas.call(this,renderSession);};/**
* Calculates the ascent, descent and fontSize of a given fontStyle
*
* @method determineFontProperties
* @param fontStyle {Object}
* @private
*/PIXI.Text.prototype.determineFontProperties=function(fontStyle){var properties=PIXI.Text.fontPropertiesCache[fontStyle];if(!properties){properties={};var canvas=PIXI.Text.fontPropertiesCanvas;var context=PIXI.Text.fontPropertiesContext;context.font=fontStyle;var width=Math.ceil(context.measureText('|Mq').width);var baseline=Math.ceil(context.measureText('M').width);var height=2*baseline;baseline=baseline*1.4|0;canvas.width=width;canvas.height=height;context.fillStyle='#f00';context.fillRect(0,0,width,height);context.font=fontStyle;context.textBaseline='alphabetic';context.fillStyle='#000';context.fillText('|MÉq',0,baseline);var imagedata=context.getImageData(0,0,width,height).data;var pixels=imagedata.length;var line=width*4;var i,j;var idx=0;var stop=false;// ascent. scan from top to bottom until we find a non red pixel
for(i=0;i<baseline;i++){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break;}}if(!stop){idx+=line;}else{break;}}properties.ascent=baseline-i;idx=pixels-line;stop=false;// descent. scan from bottom to top until we find a non red pixel
for(i=height;i>baseline;i--){for(j=0;j<line;j+=4){if(imagedata[idx+j]!==255){stop=true;break;}}if(!stop){idx-=line;}else{break;}}properties.descent=i-baseline;//TODO might need a tweak. kind of a temp fix!
properties.descent+=6;properties.fontSize=properties.ascent+properties.descent;PIXI.Text.fontPropertiesCache[fontStyle]=properties;}return properties;};/**
 * Applies newlines to a string to have it optimally fit into the horizontal
 * bounds set by the Text object's wordWrapWidth property.
 *
 * @method wordWrap
 * @param text {String}
 * @private
 */PIXI.Text.prototype.wordWrap=function(text){// Greedy wrapping algorithm that will wrap words as the line grows longer
// than its horizontal bounds.
var result='';var lines=text.split('\n');for(var i=0;i<lines.length;i++){var spaceLeft=this.style.wordWrapWidth;var words=lines[i].split(' ');for(var j=0;j<words.length;j++){var wordWidth=this.context.measureText(words[j]).width;var wordWidthWithSpace=wordWidth+this.context.measureText(' ').width;if(j===0||wordWidthWithSpace>spaceLeft){// Skip printing the newline if it's the first word of the line that is
// greater than the word wrap width.
if(j>0){result+='\n';}result+=words[j];spaceLeft=this.style.wordWrapWidth-wordWidth;}else{spaceLeft-=wordWidthWithSpace;result+=' '+words[j];}}if(i<lines.length-1){result+='\n';}}return result;};/**
* Returns the bounds of the Text as a rectangle. The bounds calculation takes the worldTransform into account.
*
* @method getBounds
* @param matrix {Matrix} the transformation matrix of the Text
* @return {Rectangle} the framing rectangle
*/PIXI.Text.prototype.getBounds=function(matrix){if(this.dirty){this.updateText();this.dirty=false;}return PIXI.Sprite.prototype.getBounds.call(this,matrix);};/**
 * Destroys this text object.
 *
 * @method destroy
 * @param destroyBaseTexture {Boolean} whether to destroy the base texture as well
 */PIXI.Text.prototype.destroy=function(destroyBaseTexture){// make sure to reset the the context and canvas.. dont want this hanging around in memory!
this.context=null;this.canvas=null;this.texture.destroy(destroyBaseTexture===undefined?true:destroyBaseTexture);};PIXI.Text.fontPropertiesCache={};PIXI.Text.fontPropertiesCanvas=document.createElement('canvas');PIXI.Text.fontPropertiesContext=PIXI.Text.fontPropertiesCanvas.getContext('2d');/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A BitmapText object will create a line or multiple lines of text using bitmap font. To split a line you can use '\n', '\r' or '\r\n' in your string.
 * You can generate the fnt files using
 * http://www.angelcode.com/products/bmfont/ for windows or
 * http://www.bmglyph.com/ for mac.
 *
 * @class BitmapText
 * @extends DisplayObjectContainer
 * @constructor
 * @param text {String} The copy that you would like the text to display
 * @param style {Object} The style parameters
 * @param style.font {String} The size (optional) and bitmap font id (required) eq 'Arial' or '20px Arial' (must have loaded previously)
 * @param [style.align='left'] {String} Alignment for multiline text ('left', 'center' or 'right'), does not affect single line text
 */PIXI.BitmapText=function(text,style){PIXI.DisplayObjectContainer.call(this);/**
     * [read-only] The width of the overall text, different from fontSize,
     * which is defined in the style object
     *
     * @property textWidth
     * @type Number
     * @readOnly
     */this.textWidth=0;/**
     * [read-only] The height of the overall text, different from fontSize,
     * which is defined in the style object
     *
     * @property textHeight
     * @type Number
     * @readOnly
     */this.textHeight=0;/**
     * @property _pool
     * @type Array
     * @private
     */this._pool=[];this.setText(text);this.setStyle(style);this.updateText();/**
     * The dirty state of this object.
     * @property dirty
     * @type Boolean
     */this.dirty=false;};// constructor
PIXI.BitmapText.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.BitmapText.prototype.constructor=PIXI.BitmapText;/**
 * Set the text string to be rendered.
 *
 * @method setText
 * @param text {String} The text that you would like displayed
 */PIXI.BitmapText.prototype.setText=function(text){this.text=text||' ';this.dirty=true;};/**
 * Set the style of the text
 * style.font {String} The size (optional) and bitmap font id (required) eq 'Arial' or '20px Arial' (must have loaded previously)
 * [style.align='left'] {String} Alignment for multiline text ('left', 'center' or 'right'), does not affect single lines of text
 *
 * @method setStyle
 * @param style {Object} The style parameters, contained as properties of an object
 */PIXI.BitmapText.prototype.setStyle=function(style){style=style||{};style.align=style.align||'left';this.style=style;var font=style.font.split(' ');this.fontName=font[font.length-1];this.fontSize=font.length>=2?parseInt(font[font.length-2],10):PIXI.BitmapText.fonts[this.fontName].size;this.dirty=true;this.tint=style.tint;};/**
 * Renders text and updates it when needed
 *
 * @method updateText
 * @private
 */PIXI.BitmapText.prototype.updateText=function(){var data=PIXI.BitmapText.fonts[this.fontName];var pos=new PIXI.Point();var prevCharCode=null;var chars=[];var maxLineWidth=0;var lineWidths=[];var line=0;var scale=this.fontSize/data.size;for(var i=0;i<this.text.length;i++){var charCode=this.text.charCodeAt(i);if(/(?:\r\n|\r|\n)/.test(this.text.charAt(i))){lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);line++;pos.x=0;pos.y+=data.lineHeight;prevCharCode=null;continue;}var charData=data.chars[charCode];if(!charData)continue;if(prevCharCode&&charData.kerning[prevCharCode]){pos.x+=charData.kerning[prevCharCode];}chars.push({texture:charData.texture,line:line,charCode:charCode,position:new PIXI.Point(pos.x+charData.xOffset,pos.y+charData.yOffset)});pos.x+=charData.xAdvance;prevCharCode=charCode;}lineWidths.push(pos.x);maxLineWidth=Math.max(maxLineWidth,pos.x);var lineAlignOffsets=[];for(i=0;i<=line;i++){var alignOffset=0;if(this.style.align==='right'){alignOffset=maxLineWidth-lineWidths[i];}else if(this.style.align==='center'){alignOffset=(maxLineWidth-lineWidths[i])/2;}lineAlignOffsets.push(alignOffset);}var lenChildren=this.children.length;var lenChars=chars.length;var tint=this.tint||0xFFFFFF;for(i=0;i<lenChars;i++){var c=i<lenChildren?this.children[i]:this._pool.pop();// get old child if have. if not - take from pool.
if(c)c.setTexture(chars[i].texture);// check if got one before.
else c=new PIXI.Sprite(chars[i].texture);// if no create new one.
c.position.x=(chars[i].position.x+lineAlignOffsets[chars[i].line])*scale;c.position.y=chars[i].position.y*scale;c.scale.x=c.scale.y=scale;c.tint=tint;if(!c.parent)this.addChild(c);}// remove unnecessary children.
// and put their into the pool.
while(this.children.length>lenChars){var child=this.getChildAt(this.children.length-1);this._pool.push(child);this.removeChild(child);}this.textWidth=maxLineWidth*scale;this.textHeight=(pos.y+data.lineHeight)*scale;};/**
 * Updates the transform of this object
 *
 * @method updateTransform
 * @private
 */PIXI.BitmapText.prototype.updateTransform=function(){if(this.dirty){this.updateText();this.dirty=false;}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this);};PIXI.BitmapText.fonts={};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * Holds all information related to an Interaction event
 *
 * @class InteractionData
 * @constructor
 */PIXI.InteractionData=function(){/**
     * This point stores the global coords of where the touch/mouse event happened
     *
     * @property global
     * @type Point
     */this.global=new PIXI.Point();/**
     * The target Sprite that was interacted with
     *
     * @property target
     * @type Sprite
     */this.target=null;/**
     * When passed to an event handler, this will be the original DOM Event that was captured
     *
     * @property originalEvent
     * @type Event
     */this.originalEvent=null;};/**
 * This will return the local coordinates of the specified displayObject for this InteractionData
 *
 * @method getLocalPosition
 * @param displayObject {DisplayObject} The DisplayObject that you would like the local coords off
 * @param [point] {Point} A Point object in which to store the value, optional (otherwise will create a new point)
 * param [globalPos] {Point} A Point object containing your custom global coords, optional (otherwise will use the current global coords)
 * @return {Point} A point containing the coordinates of the InteractionData position relative to the DisplayObject
 */PIXI.InteractionData.prototype.getLocalPosition=function(displayObject,point,globalPos){var worldTransform=displayObject.worldTransform;var global=globalPos?globalPos:this.global;// do a cheeky transform to get the mouse coords;
var a00=worldTransform.a,a01=worldTransform.c,a02=worldTransform.tx,a10=worldTransform.b,a11=worldTransform.d,a12=worldTransform.ty,id=1/(a00*a11+a01*-a10);point=point||new PIXI.Point();point.x=a11*id*global.x+-a01*id*global.y+(a12*a01-a02*a11)*id;point.y=a00*id*global.y+-a10*id*global.x+(-a12*a00+a02*a10)*id;// set the mouse coords...
return point;};// constructor
PIXI.InteractionData.prototype.constructor=PIXI.InteractionData;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The interaction manager deals with mouse and touch events. Any DisplayObject can be interactive
 * if its interactive parameter is set to true
 * This manager also supports multitouch.
 *
 * @class InteractionManager
 * @constructor
 * @param stage {Stage} The stage to handle interactions
 */PIXI.InteractionManager=function(stage){/**
     * A reference to the stage
     *
     * @property stage
     * @type Stage
     */this.stage=stage;/**
     * The mouse data
     *
     * @property mouse
     * @type InteractionData
     */this.mouse=new PIXI.InteractionData();/**
     * An object that stores current touches (InteractionData) by id reference
     *
     * @property touches
     * @type Object
     */this.touches={};/**
     * @property tempPoint
     * @type Point
     * @private
     */this.tempPoint=new PIXI.Point();/**
     * @property mouseoverEnabled
     * @type Boolean
     * @default
     */this.mouseoverEnabled=true;/**
     * Tiny little interactiveData pool !
     *
     * @property pool
     * @type Array
     */this.pool=[];/**
     * An array containing all the iterative items from the our interactive tree
     * @property interactiveItems
     * @type Array
     * @private
     */this.interactiveItems=[];/**
     * Our canvas
     * @property interactionDOMElement
     * @type HTMLCanvasElement
     * @private
     */this.interactionDOMElement=null;//this will make it so that you don't have to call bind all the time
/**
     * @property onMouseMove
     * @type Function
     */this.onMouseMove=this.onMouseMove.bind(this);/**
     * @property onMouseDown
     * @type Function
     */this.onMouseDown=this.onMouseDown.bind(this);/**
     * @property onMouseOut
     * @type Function
     */this.onMouseOut=this.onMouseOut.bind(this);/**
     * @property onMouseUp
     * @type Function
     */this.onMouseUp=this.onMouseUp.bind(this);/**
     * @property onTouchStart
     * @type Function
     */this.onTouchStart=this.onTouchStart.bind(this);/**
     * @property onTouchEnd
     * @type Function
     */this.onTouchEnd=this.onTouchEnd.bind(this);/**
     * @property onTouchCancel
     * @type Function
     */this.onTouchCancel=this.onTouchCancel.bind(this);/**
     * @property onTouchMove
     * @type Function
     */this.onTouchMove=this.onTouchMove.bind(this);/**
     * @property last
     * @type Number
     */this.last=0;/**
     * The css style of the cursor that is being used
     * @property currentCursorStyle
     * @type String
     */this.currentCursorStyle='inherit';/**
     * Is set to true when the mouse is moved out of the canvas
     * @property mouseOut
     * @type Boolean
     */this.mouseOut=false;/**
     * @property resolution
     * @type Number
     */this.resolution=1;// used for hit testing
this._tempPoint=new PIXI.Point();};// constructor
PIXI.InteractionManager.prototype.constructor=PIXI.InteractionManager;/**
 * Collects an interactive sprite recursively to have their interactions managed
 *
 * @method collectInteractiveSprite
 * @param displayObject {DisplayObject} the displayObject to collect
 * @param iParent {DisplayObject} the display object's parent
 * @private
 */PIXI.InteractionManager.prototype.collectInteractiveSprite=function(displayObject,iParent){var children=displayObject.children;var length=children.length;// make an interaction tree... {item.__interactiveParent}
for(var i=length-1;i>=0;i--){var child=children[i];// push all interactive bits
if(child._interactive){iParent.interactiveChildren=true;//child.__iParent = iParent;
this.interactiveItems.push(child);if(child.children.length>0){this.collectInteractiveSprite(child,child);}}else{child.__iParent=null;if(child.children.length>0){this.collectInteractiveSprite(child,iParent);}}}};/**
 * Sets the target for event delegation
 *
 * @method setTarget
 * @param target {WebGLRenderer|CanvasRenderer} the renderer to bind events to
 * @private
 */PIXI.InteractionManager.prototype.setTarget=function(target){this.target=target;this.resolution=target.resolution;// Check if the dom element has been set. If it has don't do anything.
if(this.interactionDOMElement!==null)return;this.setTargetDomElement(target.view);};/**
 * Sets the DOM element which will receive mouse/touch events. This is useful for when you have other DOM
 * elements on top of the renderers Canvas element. With this you'll be able to delegate another DOM element
 * to receive those events
 *
 * @method setTargetDomElement
 * @param domElement {DOMElement} the DOM element which will receive mouse and touch events
 * @private
 */PIXI.InteractionManager.prototype.setTargetDomElement=function(domElement){this.removeEvents();if(window.navigator.msPointerEnabled){// time to remove some of that zoom in ja..
domElement.style['-ms-content-zooming']='none';domElement.style['-ms-touch-action']='none';}this.interactionDOMElement=domElement;domElement.addEventListener('mousemove',this.onMouseMove,true);domElement.addEventListener('mousedown',this.onMouseDown,true);domElement.addEventListener('mouseout',this.onMouseOut,true);// aint no multi touch just yet!
domElement.addEventListener('touchstart',this.onTouchStart,true);domElement.addEventListener('touchend',this.onTouchEnd,true);domElement.addEventListener('touchleave',this.onTouchCancel,true);domElement.addEventListener('touchcancel',this.onTouchCancel,true);domElement.addEventListener('touchmove',this.onTouchMove,true);window.addEventListener('mouseup',this.onMouseUp,true);};/**
 * @method removeEvents
 * @private
 */PIXI.InteractionManager.prototype.removeEvents=function(){if(!this.interactionDOMElement)return;this.interactionDOMElement.style['-ms-content-zooming']='';this.interactionDOMElement.style['-ms-touch-action']='';this.interactionDOMElement.removeEventListener('mousemove',this.onMouseMove,true);this.interactionDOMElement.removeEventListener('mousedown',this.onMouseDown,true);this.interactionDOMElement.removeEventListener('mouseout',this.onMouseOut,true);// aint no multi touch just yet!
this.interactionDOMElement.removeEventListener('touchstart',this.onTouchStart,true);this.interactionDOMElement.removeEventListener('touchend',this.onTouchEnd,true);this.interactionDOMElement.removeEventListener('touchleave',this.onTouchCancel,true);this.interactionDOMElement.removeEventListener('touchcancel',this.onTouchCancel,true);this.interactionDOMElement.removeEventListener('touchmove',this.onTouchMove,true);this.interactionDOMElement=null;window.removeEventListener('mouseup',this.onMouseUp,true);};/**
 * updates the state of interactive objects
 *
 * @method update
 * @private
 */PIXI.InteractionManager.prototype.update=function(){if(!this.target)return;// frequency of 30fps??
var now=Date.now();var diff=now-this.last;diff=diff*PIXI.INTERACTION_FREQUENCY/1000;if(diff<1)return;this.last=now;var i=0;// ok.. so mouse events??
// yes for now :)
// OPTIMISE - how often to check??
if(this.dirty){this.rebuildInteractiveGraph();}// loop through interactive objects!
var length=this.interactiveItems.length;var cursor='inherit';var over=false;for(i=0;i<length;i++){var item=this.interactiveItems[i];// OPTIMISATION - only calculate every time if the mousemove function exists..
// OK so.. does the object have any other interactive functions?
// hit-test the clip!
// if (item.mouseover || item.mouseout || item.buttonMode)
// {
// ok so there are some functions so lets hit test it..
item.__hit=this.hitTest(item,this.mouse);this.mouse.target=item;// ok so deal with interactions..
// looks like there was a hit!
if(item.__hit&&!over){if(item.buttonMode)cursor=item.defaultCursor;if(!item.interactiveChildren){over=true;}if(!item.__isOver){if(item.mouseover){item.mouseover(this.mouse);}item.__isOver=true;}}else{if(item.__isOver){// roll out!
if(item.mouseout){item.mouseout(this.mouse);}item.__isOver=false;}}}if(this.currentCursorStyle!==cursor){this.currentCursorStyle=cursor;this.interactionDOMElement.style.cursor=cursor;}};/**
 * @method rebuildInteractiveGraph
 * @private
 */PIXI.InteractionManager.prototype.rebuildInteractiveGraph=function(){this.dirty=false;var len=this.interactiveItems.length;for(var i=0;i<len;i++){this.interactiveItems[i].interactiveChildren=false;}this.interactiveItems=[];if(this.stage.interactive){this.interactiveItems.push(this.stage);}// Go through and collect all the objects that are interactive..
this.collectInteractiveSprite(this.stage,this.stage);};/**
 * Is called when the mouse moves across the renderer element
 *
 * @method onMouseMove
 * @param event {Event} The DOM event of the mouse moving
 * @private
 */PIXI.InteractionManager.prototype.onMouseMove=function(event){if(this.dirty){this.rebuildInteractiveGraph();}this.mouse.originalEvent=event;// TODO optimize by not check EVERY TIME! maybe half as often? //
var rect=this.interactionDOMElement.getBoundingClientRect();this.mouse.global.x=(event.clientX-rect.left)*(this.target.width/rect.width)/this.resolution;this.mouse.global.y=(event.clientY-rect.top)*(this.target.height/rect.height)/this.resolution;var length=this.interactiveItems.length;for(var i=0;i<length;i++){var item=this.interactiveItems[i];// Call the function!
if(item.mousemove){item.mousemove(this.mouse);}}};/**
 * Is called when the mouse button is pressed down on the renderer element
 *
 * @method onMouseDown
 * @param event {Event} The DOM event of a mouse button being pressed down
 * @private
 */PIXI.InteractionManager.prototype.onMouseDown=function(event){if(this.dirty){this.rebuildInteractiveGraph();}this.mouse.originalEvent=event;if(PIXI.AUTO_PREVENT_DEFAULT){this.mouse.originalEvent.preventDefault();}// loop through interaction tree...
// hit test each item! ->
// get interactive items under point??
//stage.__i
var length=this.interactiveItems.length;var e=this.mouse.originalEvent;var isRightButton=e.button===2||e.which===3;var downFunction=isRightButton?'rightdown':'mousedown';var clickFunction=isRightButton?'rightclick':'click';var buttonIsDown=isRightButton?'__rightIsDown':'__mouseIsDown';var isDown=isRightButton?'__isRightDown':'__isDown';// while
// hit test
for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item[downFunction]||item[clickFunction]){item[buttonIsDown]=true;item.__hit=this.hitTest(item,this.mouse);if(item.__hit){//call the function!
if(item[downFunction]){item[downFunction](this.mouse);}item[isDown]=true;// just the one!
if(!item.interactiveChildren)break;}}}};/**
 * Is called when the mouse is moved out of the renderer element
 *
 * @method onMouseOut
 * @param event {Event} The DOM event of a mouse being moved out
 * @private
 */PIXI.InteractionManager.prototype.onMouseOut=function(event){if(this.dirty){this.rebuildInteractiveGraph();}this.mouse.originalEvent=event;var length=this.interactiveItems.length;this.interactionDOMElement.style.cursor='inherit';for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item.__isOver){this.mouse.target=item;if(item.mouseout){item.mouseout(this.mouse);}item.__isOver=false;}}this.mouseOut=true;// move the mouse to an impossible position
this.mouse.global.x=-10000;this.mouse.global.y=-10000;};/**
 * Is called when the mouse button is released on the renderer element
 *
 * @method onMouseUp
 * @param event {Event} The DOM event of a mouse button being released
 * @private
 */PIXI.InteractionManager.prototype.onMouseUp=function(event){if(this.dirty){this.rebuildInteractiveGraph();}this.mouse.originalEvent=event;var length=this.interactiveItems.length;var up=false;var e=this.mouse.originalEvent;var isRightButton=e.button===2||e.which===3;var upFunction=isRightButton?'rightup':'mouseup';var clickFunction=isRightButton?'rightclick':'click';var upOutsideFunction=isRightButton?'rightupoutside':'mouseupoutside';var isDown=isRightButton?'__isRightDown':'__isDown';for(var i=0;i<length;i++){var item=this.interactiveItems[i];if(item[clickFunction]||item[upFunction]||item[upOutsideFunction]){item.__hit=this.hitTest(item,this.mouse);if(item.__hit&&!up){//call the function!
if(item[upFunction]){item[upFunction](this.mouse);}if(item[isDown]){if(item[clickFunction]){item[clickFunction](this.mouse);}}if(!item.interactiveChildren){up=true;}}else{if(item[isDown]){if(item[upOutsideFunction])item[upOutsideFunction](this.mouse);}}item[isDown]=false;}}};/**
 * Tests if the current mouse coordinates hit a sprite
 *
 * @method hitTest
 * @param item {DisplayObject} The displayObject to test for a hit
 * @param interactionData {InteractionData} The interactionData object to update in the case there is a hit
 * @private
 */PIXI.InteractionManager.prototype.hitTest=function(item,interactionData){var global=interactionData.global;if(!item.worldVisible){return false;}// map the global point to local space.
item.worldTransform.applyInverse(global,this._tempPoint);var x=this._tempPoint.x,y=this._tempPoint.y,i;interactionData.target=item;//a sprite or display object with a hit area defined
if(item.hitArea&&item.hitArea.contains){return item.hitArea.contains(x,y);}// a sprite with no hitarea defined
else if(item instanceof PIXI.Sprite){var width=item.texture.frame.width;var height=item.texture.frame.height;var x1=-width*item.anchor.x;var y1;if(x>x1&&x<x1+width){y1=-height*item.anchor.y;if(y>y1&&y<y1+height){// set the target property if a hit is true!
return true;}}}else if(item instanceof PIXI.Graphics){var graphicsData=item.graphicsData;for(i=0;i<graphicsData.length;i++){var data=graphicsData[i];if(!data.fill)continue;// only deal with fills..
if(data.shape){if(data.shape.contains(x,y)){//interactionData.target = item;
return true;}}}}var length=item.children.length;for(i=0;i<length;i++){var tempItem=item.children[i];var hit=this.hitTest(tempItem,interactionData);if(hit){// hmm.. TODO SET CORRECT TARGET?
interactionData.target=item;return true;}}return false;};/**
 * Is called when a touch is moved across the renderer element
 *
 * @method onTouchMove
 * @param event {Event} The DOM event of a touch moving across the renderer view
 * @private
 */PIXI.InteractionManager.prototype.onTouchMove=function(event){if(this.dirty){this.rebuildInteractiveGraph();}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var touchData;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY;}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];touchData=this.touches[touchEvent.identifier];touchData.originalEvent=event;// update the touch position
if(!isSupportCocoonJS){touchEvent.globalX=touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{//Support for CocoonJS fullscreen scale modes
touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY;}for(var j=0;j<this.interactiveItems.length;j++){var item=this.interactiveItems[j];if(item.touchmove&&item.__touchData&&item.__touchData[touchEvent.identifier]){item.touchmove(touchData);}}}};/**
 * Is called when a touch is started on the renderer element
 *
 * @method onTouchStart
 * @param event {Event} The DOM event of a touch starting on the renderer view
 * @private
 */PIXI.InteractionManager.prototype.onTouchStart=function(event){if(this.dirty){this.rebuildInteractiveGraph();}var rect=this.interactionDOMElement.getBoundingClientRect();if(PIXI.AUTO_PREVENT_DEFAULT){event.preventDefault();}var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY;}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.pool.pop();if(!touchData){touchData=new PIXI.InteractionData();}touchData.originalEvent=event;this.touches[touchEvent.identifier]=touchData;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{//Support for CocoonJS fullscreen scale modes
touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY;}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.touchstart||item.tap){item.__hit=this.hitTest(item,touchData);if(item.__hit){//call the function!
if(item.touchstart)item.touchstart(touchData);item.__isDown=true;item.__touchData=item.__touchData||{};item.__touchData[touchEvent.identifier]=touchData;if(!item.interactiveChildren)break;}}}}};/**
 * Is called when a touch is ended on the renderer element
 *
 * @method onTouchEnd
 * @param event {Event} The DOM event of a touch ending on the renderer view
 * @private
 */PIXI.InteractionManager.prototype.onTouchEnd=function(event){if(this.dirty){this.rebuildInteractiveGraph();}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY;}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.touches[touchEvent.identifier];var up=false;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{//Support for CocoonJS fullscreen scale modes
touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY;}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.__touchData&&item.__touchData[touchEvent.identifier]){item.__hit=this.hitTest(item,item.__touchData[touchEvent.identifier]);// so this one WAS down...
touchData.originalEvent=event;// hitTest??
if(item.touchend||item.tap){if(item.__hit&&!up){if(item.touchend){item.touchend(touchData);}if(item.__isDown&&item.tap){item.tap(touchData);}if(!item.interactiveChildren){up=true;}}else{if(item.__isDown&&item.touchendoutside){item.touchendoutside(touchData);}}item.__isDown=false;}item.__touchData[touchEvent.identifier]=null;}}// remove the touch..
this.pool.push(touchData);this.touches[touchEvent.identifier]=null;}};/**
 * Is called when a touch is canceled
 *
 * @method onTouchCancel
 * @param event {Event} The DOM event of a touch canceled
 * @private
 */PIXI.InteractionManager.prototype.onTouchCancel=function(event){if(this.dirty){this.rebuildInteractiveGraph();}var rect=this.interactionDOMElement.getBoundingClientRect();var changedTouches=event.changedTouches;var cLength=changedTouches.length;var wCalc=this.target.width/rect.width;var hCalc=this.target.height/rect.height;var isSupportCocoonJS=navigator.isCocoonJS&&!rect.left&&!rect.top&&!event.target.style.width&&!event.target.style.height;var touchEvent;for(var c=0;c<cLength;c++){touchEvent=changedTouches[c];if(!isSupportCocoonJS){touchEvent.globalX=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchEvent.globalY=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{touchEvent.globalX=touchEvent.clientX;touchEvent.globalY=touchEvent.clientY;}}for(var i=0;i<cLength;i++){touchEvent=changedTouches[i];var touchData=this.touches[touchEvent.identifier];var up=false;if(!isSupportCocoonJS){touchData.global.x=(touchEvent.clientX-rect.left)*wCalc/this.resolution;touchData.global.y=(touchEvent.clientY-rect.top)*hCalc/this.resolution;}else{//Support for CocoonJS fullscreen scale modes
touchData.global.x=touchEvent.clientX;touchData.global.y=touchEvent.clientY;}var length=this.interactiveItems.length;for(var j=0;j<length;j++){var item=this.interactiveItems[j];if(item.__touchData&&item.__touchData[touchEvent.identifier]){item.__hit=this.hitTest(item,item.__touchData[touchEvent.identifier]);// so this one WAS down...
touchData.originalEvent=event;// hitTest??
if(item.touchcancel&&!up){item.touchcancel(touchData);if(!item.interactiveChildren){up=true;}}item.__isDown=false;item.__touchData[touchEvent.identifier]=null;}}// remove the touch..
this.pool.push(touchData);this.touches[touchEvent.identifier]=null;}};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A Stage represents the root of the display tree. Everything connected to the stage is rendered
 *
 * @class Stage
 * @extends DisplayObjectContainer
 * @constructor
 * @param backgroundColor {Number} the background color of the stage, you have to pass this in is in hex format
 *      like: 0xFFFFFF for white
 * 
 * Creating a stage is a mandatory process when you use Pixi, which is as simple as this : 
 * var stage = new PIXI.Stage(0xFFFFFF);
 * where the parameter given is the background colour of the stage, in hex
 * you will use this stage instance to add your sprites to it and therefore to the renderer
 * Here is how to add a sprite to the stage : 
 * stage.addChild(sprite);
 */PIXI.Stage=function(backgroundColor){PIXI.DisplayObjectContainer.call(this);/**
     * [read-only] Current transform of the object based on world (parent) factors
     *
     * @property worldTransform
     * @type Matrix
     * @readOnly
     * @private
     */this.worldTransform=new PIXI.Matrix();/**
     * Whether or not the stage is interactive
     *
     * @property interactive
     * @type Boolean
     */this.interactive=true;/**
     * The interaction manage for this stage, manages all interactive activity on the stage
     *
     * @property interactionManager
     * @type InteractionManager
     */this.interactionManager=new PIXI.InteractionManager(this);/**
     * Whether the stage is dirty and needs to have interactions updated
     *
     * @property dirty
     * @type Boolean
     * @private
     */this.dirty=true;//the stage is its own stage
this.stage=this;//optimize hit detection a bit
this.stage.hitArea=new PIXI.Rectangle(0,0,100000,100000);this.setBackgroundColor(backgroundColor);};// constructor
PIXI.Stage.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Stage.prototype.constructor=PIXI.Stage;/**
 * Sets another DOM element which can receive mouse/touch interactions instead of the default Canvas element.
 * This is useful for when you have other DOM elements on top of the Canvas element.
 *
 * @method setInteractionDelegate
 * @param domElement {DOMElement} This new domElement which will receive mouse/touch events
 */PIXI.Stage.prototype.setInteractionDelegate=function(domElement){this.interactionManager.setTargetDomElement(domElement);};/*
 * Updates the object transform for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.Stage.prototype.updateTransform=function(){this.worldAlpha=1;for(var i=0,j=this.children.length;i<j;i++){this.children[i].updateTransform();}if(this.dirty){this.dirty=false;// update interactive!
this.interactionManager.dirty=true;}if(this.interactive)this.interactionManager.update();};/**
 * Sets the background color for the stage
 *
 * @method setBackgroundColor
 * @param backgroundColor {Number} the color of the background, easiest way to pass this in is in hex format
 *      like: 0xFFFFFF for white
 */PIXI.Stage.prototype.setBackgroundColor=function(backgroundColor){this.backgroundColor=backgroundColor||0x000000;this.backgroundColorSplit=PIXI.hex2rgb(this.backgroundColor);var hex=this.backgroundColor.toString(16);hex='000000'.substr(0,6-hex.length)+hex;this.backgroundColorString='#'+hex;};/**
 * This will return the point containing global coordinates of the mouse.
 *
 * @method getMousePosition
 * @return {Point} A point containing the coordinates of the global InteractionData position.
 */PIXI.Stage.prototype.getMousePosition=function(){return this.interactionManager.mouse.global;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ // http://paulirish.com/2011/requestanimationframe-for-smart-animating/
// http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
// requestAnimationFrame polyfill by Erik Möller. fixes from Paul Irish and Tino Zijdel
// MIT license
/**
 * A polyfill for requestAnimationFrame
 * You can actually use both requestAnimationFrame and requestAnimFrame, 
 * you will still benefit from the polyfill
 *
 * @method requestAnimationFrame
 */ /**
 * A polyfill for cancelAnimationFrame
 *
 * @method cancelAnimationFrame
 */(function(window){var lastTime=0;var vendors=['ms','moz','webkit','o'];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'CancelRequestAnimationFrame'];}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){var currTime=new Date().getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+timeToCall);},timeToCall);lastTime=currTime+timeToCall;return id;};}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){clearTimeout(id);};}window.requestAnimFrame=window.requestAnimationFrame;})(this);/**
 * Converts a hex color number to an [R, G, B] array
 *
 * @method hex2rgb
 * @param hex {Number}
 */PIXI.hex2rgb=function(hex){return[(hex>>16&0xFF)/255,(hex>>8&0xFF)/255,(hex&0xFF)/255];};/**
 * Converts a color as an [R, G, B] array to a hex number
 *
 * @method rgb2hex
 * @param rgb {Array}
 */PIXI.rgb2hex=function(rgb){return(rgb[0]*255<<16)+(rgb[1]*255<<8)+rgb[2]*255;};/**
 * A polyfill for Function.prototype.bind
 *
 * @method bind
 */if(typeof Function.prototype.bind!=='function'){Function.prototype.bind=function(){return function(thisArg){var target=this,i=arguments.length-1,boundArgs=[];if(i>0){boundArgs.length=i;while(i--)boundArgs[i]=arguments[i+1];}if(typeof target!=='function')throw new TypeError();function bound(){var i=arguments.length,args=new Array(i);while(i--)args[i]=arguments[i];args=boundArgs.concat(args);return target.apply(this instanceof bound?this:thisArg,args);}bound.prototype=function F(proto){if(proto)F.prototype=proto;if(!(this instanceof F))return new F();}(target.prototype);return bound;};}();}/**
 * A wrapper for ajax requests to be handled cross browser
 *
 * @class AjaxRequest
 * @constructor
 */PIXI.AjaxRequest=function(){var activexmodes=['Msxml2.XMLHTTP.6.0','Msxml2.XMLHTTP.3.0','Microsoft.XMLHTTP'];//activeX versions to check for in IE
if(window.ActiveXObject){//Test for support for ActiveXObject in IE first (as XMLHttpRequest in IE7 is broken)
for(var i=0;i<activexmodes.length;i++){try{return new window.ActiveXObject(activexmodes[i]);}catch(e){//suppress error
}}}else if(window.XMLHttpRequest)// if Mozilla, Safari etc
{return new window.XMLHttpRequest();}else{return false;}};/*
PIXI.packColorRGBA = function(r, g, b, a)//r, g, b, a)
{
  //  console.log(r, b, c, d)
  return (Math.floor((r)*63) << 18) | (Math.floor((g)*63) << 12) | (Math.floor((b)*63) << 6);// | (Math.floor((a)*63))
  //  i = i | (Math.floor((a)*63));
   // return i;
   // var r = (i / 262144.0 ) / 64;
   // var g = (i / 4096.0)%64 / 64;
  //  var b = (i / 64.0)%64 / 64;
  //  var a = (i)%64 / 64;
     
  //  console.log(r, g, b, a);
  //  return i;

};
*/ /*
PIXI.packColorRGB = function(r, g, b)//r, g, b, a)
{
    return (Math.floor((r)*255) << 16) | (Math.floor((g)*255) << 8) | (Math.floor((b)*255));
};

PIXI.unpackColorRGB = function(r, g, b)//r, g, b, a)
{
    return (Math.floor((r)*255) << 16) | (Math.floor((g)*255) << 8) | (Math.floor((b)*255));
};
*/ /**
 * Checks whether the Canvas BlendModes are supported by the current browser
 *
 * @method canUseNewCanvasBlendModes
 * @return {Boolean} whether they are supported
 */PIXI.canUseNewCanvasBlendModes=function(){if(typeof document==='undefined')return false;var canvas=document.createElement('canvas');canvas.width=1;canvas.height=1;var context=canvas.getContext('2d');context.fillStyle='#000';context.fillRect(0,0,1,1);context.globalCompositeOperation='multiply';context.fillStyle='#fff';context.fillRect(0,0,1,1);return context.getImageData(0,0,1,1).data[0]===0;};/**
 * Given a number, this function returns the closest number that is a power of two
 * this function is taken from Starling Framework as its pretty neat ;)
 *
 * @method getNextPowerOfTwo
 * @param number {Number}
 * @return {Number} the closest number that is a power of two
 */PIXI.getNextPowerOfTwo=function(number){if(number>0&&(number&number-1)===0)// see: http://goo.gl/D9kPj
return number;else{var result=1;while(result<number)result<<=1;return result;}};/**
 * checks if the given width and height make a power of two texture
 * @method isPowerOfTwo
 * @param width {Number}
 * @param height {Number}
 * @return {Boolean} 
 */PIXI.isPowerOfTwo=function(width,height){return width>0&&(width&width-1)===0&&height>0&&(height&height-1)===0;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * @author Chad Engler https://github.com/englercj @Rolnaaba
 */ /**
 * Originally based on https://github.com/mrdoob/eventtarget.js/ from mr Doob.
 * Currently takes inspiration from the nodejs EventEmitter, EventEmitter3, and smokesignals
 */ /**
 * Mixins event emitter functionality to a class
 *
 * @class EventTarget
 * @example
 *      function MyEmitter() {}
 *
 *      PIXI.EventTarget.mixin(MyEmitter.prototype);
 *
 *      var em = new MyEmitter();
 *      em.emit('eventName', 'some data', 'some more data', {}, null, ...);
 */PIXI.EventTarget={/**
     * Backward compat from when this used to be a function
     */call:function callCompat(obj){if(obj){obj=obj.prototype||obj;PIXI.EventTarget.mixin(obj);}},/**
     * Mixes in the properties of the EventTarget prototype onto another object
     *
     * @method mixin
     * @param object {Object} The obj to mix into
     */mixin:function mixin(obj){/**
         * Return a list of assigned event listeners.
         *
         * @method listeners
         * @param eventName {String} The events that should be listed.
         * @return {Array} An array of listener functions
         */obj.listeners=function listeners(eventName){this._listeners=this._listeners||{};return this._listeners[eventName]?this._listeners[eventName].slice():[];};/**
         * Emit an event to all registered event listeners.
         *
         * @method emit
         * @alias dispatchEvent
         * @param eventName {String} The name of the event.
         * @return {Boolean} Indication if we've emitted an event.
         */obj.emit=obj.dispatchEvent=function emit(eventName,data){this._listeners=this._listeners||{};//backwards compat with old method ".emit({ type: 'something' })"
if(typeof eventName==='object'){data=eventName;eventName=eventName.type;}//ensure we are using a real pixi event
if(!data||data.__isEventObject!==true){data=new PIXI.Event(this,eventName,data);}//iterate the listeners
if(this._listeners&&this._listeners[eventName]){var listeners=this._listeners[eventName].slice(0),length=listeners.length,fn=listeners[0],i;for(i=0;i<length;fn=listeners[++i]){//call the event listener
fn.call(this,data);//if "stopImmediatePropagation" is called, stop calling sibling events
if(data.stoppedImmediate){return this;}}//if "stopPropagation" is called then don't bubble the event
if(data.stopped){return this;}}//bubble this event up the scene graph
if(this.parent&&this.parent.emit){this.parent.emit.call(this.parent,eventName,data);}return this;};/**
         * Register a new EventListener for the given event.
         *
         * @method on
         * @alias addEventListener
         * @param eventName {String} Name of the event.
         * @param callback {Functon} fn Callback function.
         */obj.on=obj.addEventListener=function on(eventName,fn){this._listeners=this._listeners||{};(this._listeners[eventName]=this._listeners[eventName]||[]).push(fn);return this;};/**
         * Add an EventListener that's only called once.
         *
         * @method once
         * @param eventName {String} Name of the event.
         * @param callback {Function} Callback function.
         */obj.once=function once(eventName,fn){this._listeners=this._listeners||{};var self=this;function onceHandlerWrapper(){fn.apply(self.off(eventName,onceHandlerWrapper),arguments);}onceHandlerWrapper._originalHandler=fn;return this.on(eventName,onceHandlerWrapper);};/**
         * Remove event listeners.
         *
         * @method off
         * @alias removeEventListener
         * @param eventName {String} The event we want to remove.
         * @param callback {Function} The listener that we need to find.
         */obj.off=obj.removeEventListener=function off(eventName,fn){this._listeners=this._listeners||{};if(!this._listeners[eventName])return this;var list=this._listeners[eventName],i=fn?list.length:0;while(i-->0){if(list[i]===fn||list[i]._originalHandler===fn){list.splice(i,1);}}if(list.length===0){delete this._listeners[eventName];}return this;};/**
         * Remove all listeners or only the listeners for the specified event.
         *
         * @method removeAllListeners
         * @param eventName {String} The event you want to remove all listeners for.
         */obj.removeAllListeners=function removeAllListeners(eventName){this._listeners=this._listeners||{};if(!this._listeners[eventName])return this;delete this._listeners[eventName];return this;};}};/**
 * Creates an homogenous object for tracking events so users can know what to expect.
 *
 * @class Event
 * @extends Object
 * @constructor
 * @param target {Object} The target object that the event is called on
 * @param name {String} The string name of the event that was triggered
 * @param data {Object} Arbitrary event data to pass along
 */PIXI.Event=function(target,name,data){//for duck typing in the ".on()" function
this.__isEventObject=true;/**
     * Tracks the state of bubbling propagation. Do not
     * set this directly, instead use `event.stopPropagation()`
     *
     * @property stopped
     * @type Boolean
     * @private
     * @readOnly
     */this.stopped=false;/**
     * Tracks the state of sibling listener propagation. Do not
     * set this directly, instead use `event.stopImmediatePropagation()`
     *
     * @property stoppedImmediate
     * @type Boolean
     * @private
     * @readOnly
     */this.stoppedImmediate=false;/**
     * The original target the event triggered on.
     *
     * @property target
     * @type Object
     * @readOnly
     */this.target=target;/**
     * The string name of the event that this represents.
     *
     * @property type
     * @type String
     * @readOnly
     */this.type=name;/**
     * The data that was passed in with this event.
     *
     * @property data
     * @type Object
     * @readOnly
     */this.data=data;//backwards compat with older version of events
this.content=data;/**
     * The timestamp when the event occurred.
     *
     * @property timeStamp
     * @type Number
     * @readOnly
     */this.timeStamp=Date.now();};/**
 * Stops the propagation of events up the scene graph (prevents bubbling).
 *
 * @method stopPropagation
 */PIXI.Event.prototype.stopPropagation=function stopPropagation(){this.stopped=true;};/**
 * Stops the propagation of events to sibling listeners (no longer calls any listeners).
 *
 * @method stopImmediatePropagation
 */PIXI.Event.prototype.stopImmediatePropagation=function stopImmediatePropagation(){this.stoppedImmediate=true;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This helper function will automatically detect which renderer you should be using.
 * WebGL is the preferred renderer as it is a lot faster. If webGL is not supported by
 * the browser then this function will return a canvas renderer
 *
 * @method autoDetectRenderer
 * @for PIXI
 * @static
 * @param width=800 {Number} the width of the renderers view
 * @param height=600 {Number} the height of the renderers view
 * 
 * @param [options] {Object} The optional renderer parameters
 * @param [options.view] {HTMLCanvasElement} the canvas to use as a view, optional
 * @param [options.transparent=false] {Boolean} If the render view is transparent, default false
 * @param [options.antialias=false] {Boolean} sets antialias (only applicable in chrome at the moment)
 * @param [options.preserveDrawingBuffer=false] {Boolean} enables drawing buffer preservation, enable this if you need to call toDataUrl on the webgl context
 * @param [options.resolution=1] {Number} the resolution of the renderer retina would be 2
 * 
 */PIXI.autoDetectRenderer=function(width,height,options){if(!width)width=800;if(!height)height=600;// BORROWED from Mr Doob (mrdoob.com)
var webgl=function(){try{var canvas=document.createElement('canvas');return!!window.WebGLRenderingContext&&(canvas.getContext('webgl')||canvas.getContext('experimental-webgl'));}catch(e){return false;}}();if(webgl){return new PIXI.WebGLRenderer(width,height,options);}return new PIXI.CanvasRenderer(width,height,options);};/**
 * This helper function will automatically detect which renderer you should be using.
 * This function is very similar to the autoDetectRenderer function except that is will return a canvas renderer for android.
 * Even thought both android chrome supports webGL the canvas implementation perform better at the time of writing. 
 * This function will likely change and update as webGL performance improves on these devices.
 * 
 * @method autoDetectRecommendedRenderer
 * @for PIXI
 * @static
 * @param width=800 {Number} the width of the renderers view
 * @param height=600 {Number} the height of the renderers view
 * 
 * @param [options] {Object} The optional renderer parameters
 * @param [options.view] {HTMLCanvasElement} the canvas to use as a view, optional
 * @param [options.transparent=false] {Boolean} If the render view is transparent, default false
 * @param [options.antialias=false] {Boolean} sets antialias (only applicable in chrome at the moment)
 * @param [options.preserveDrawingBuffer=false] {Boolean} enables drawing buffer preservation, enable this if you need to call toDataUrl on the webgl context
 * @param [options.resolution=1] {Number} the resolution of the renderer retina would be 2
 * 
 */PIXI.autoDetectRecommendedRenderer=function(width,height,options){if(!width)width=800;if(!height)height=600;// BORROWED from Mr Doob (mrdoob.com)
var webgl=function(){try{var canvas=document.createElement('canvas');return!!window.WebGLRenderingContext&&(canvas.getContext('webgl')||canvas.getContext('experimental-webgl'));}catch(e){return false;}}();var isAndroid=/Android/i.test(navigator.userAgent);if(webgl&&!isAndroid){return new PIXI.WebGLRenderer(width,height,options);}return new PIXI.CanvasRenderer(width,height,options);};/*
    PolyK library
    url: http://polyk.ivank.net
    Released under MIT licence.

    Copyright (c) 2012 Ivan Kuckir

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

    This is an amazing lib!

    Slightly modified by Mat Groves (matgroves.com);
*/ /**
 * Based on the Polyk library http://polyk.ivank.net released under MIT licence.
 * This is an amazing lib!
 * Slightly modified by Mat Groves (matgroves.com);
 * @class PolyK
 */PIXI.PolyK={};/**
 * Triangulates shapes for webGL graphic fills.
 *
 * @method Triangulate
 */PIXI.PolyK.Triangulate=function(p){var sign=true;var n=p.length>>1;if(n<3)return[];var tgs=[];var avl=[];for(var i=0;i<n;i++)avl.push(i);i=0;var al=n;while(al>3){var i0=avl[(i+0)%al];var i1=avl[(i+1)%al];var i2=avl[(i+2)%al];var ax=p[2*i0],ay=p[2*i0+1];var bx=p[2*i1],by=p[2*i1+1];var cx=p[2*i2],cy=p[2*i2+1];var earFound=false;if(PIXI.PolyK._convex(ax,ay,bx,by,cx,cy,sign)){earFound=true;for(var j=0;j<al;j++){var vi=avl[j];if(vi===i0||vi===i1||vi===i2)continue;if(PIXI.PolyK._PointInTriangle(p[2*vi],p[2*vi+1],ax,ay,bx,by,cx,cy)){earFound=false;break;}}}if(earFound){tgs.push(i0,i1,i2);avl.splice((i+1)%al,1);al--;i=0;}else if(i++>3*al){// need to flip flip reverse it!
// reset!
if(sign){tgs=[];avl=[];for(i=0;i<n;i++)avl.push(i);i=0;al=n;sign=false;}else{//   window.console.log("PIXI Warning: shape too complex to fill");
return null;}}}tgs.push(avl[0],avl[1],avl[2]);return tgs;};/**
 * Checks whether a point is within a triangle
 *
 * @method _PointInTriangle
 * @param px {Number} x coordinate of the point to test
 * @param py {Number} y coordinate of the point to test
 * @param ax {Number} x coordinate of the a point of the triangle
 * @param ay {Number} y coordinate of the a point of the triangle
 * @param bx {Number} x coordinate of the b point of the triangle
 * @param by {Number} y coordinate of the b point of the triangle
 * @param cx {Number} x coordinate of the c point of the triangle
 * @param cy {Number} y coordinate of the c point of the triangle
 * @private
 * @return {Boolean}
 */PIXI.PolyK._PointInTriangle=function(px,py,ax,ay,bx,by,cx,cy){var v0x=cx-ax;var v0y=cy-ay;var v1x=bx-ax;var v1y=by-ay;var v2x=px-ax;var v2y=py-ay;var dot00=v0x*v0x+v0y*v0y;var dot01=v0x*v1x+v0y*v1y;var dot02=v0x*v2x+v0y*v2y;var dot11=v1x*v1x+v1y*v1y;var dot12=v1x*v2x+v1y*v2y;var invDenom=1/(dot00*dot11-dot01*dot01);var u=(dot11*dot02-dot01*dot12)*invDenom;var v=(dot00*dot12-dot01*dot02)*invDenom;// Check if point is in triangle
return u>=0&&v>=0&&u+v<1;};/**
 * Checks whether a shape is convex
 *
 * @method _convex
 * @private
 * @return {Boolean}
 */PIXI.PolyK._convex=function(ax,ay,bx,by,cx,cy,sign){return(ay-by)*(cx-bx)+(bx-ax)*(cy-by)>=0===sign;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @method initDefaultShaders
* @static
* @private
*/PIXI.initDefaultShaders=function(){};/**
* @method CompileVertexShader
* @static
* @param gl {WebGLContext} the current WebGL drawing context
* @param shaderSrc {Array}
* @return {Any}
*/PIXI.CompileVertexShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.VERTEX_SHADER);};/**
* @method CompileFragmentShader
* @static
* @param gl {WebGLContext} the current WebGL drawing context
* @param shaderSrc {Array}
* @return {Any}
*/PIXI.CompileFragmentShader=function(gl,shaderSrc){return PIXI._CompileShader(gl,shaderSrc,gl.FRAGMENT_SHADER);};/**
* @method _CompileShader
* @static
* @private
* @param gl {WebGLContext} the current WebGL drawing context
* @param shaderSrc {Array}
* @param shaderType {Number}
* @return {Any}
*/PIXI._CompileShader=function(gl,shaderSrc,shaderType){var src=shaderSrc.join("\n");var shader=gl.createShader(shaderType);gl.shaderSource(shader,src);gl.compileShader(shader);if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){window.console.log(gl.getShaderInfoLog(shader));return null;}return shader;};/**
* @method compileProgram
* @static
* @param gl {WebGLContext} the current WebGL drawing context
* @param vertexSrc {Array}
* @param fragmentSrc {Array}
* @return {Any}
*/PIXI.compileProgram=function(gl,vertexSrc,fragmentSrc){var fragmentShader=PIXI.CompileFragmentShader(gl,fragmentSrc);var vertexShader=PIXI.CompileVertexShader(gl,vertexSrc);var shaderProgram=gl.createProgram();gl.attachShader(shaderProgram,vertexShader);gl.attachShader(shaderProgram,fragmentShader);gl.linkProgram(shaderProgram);if(!gl.getProgramParameter(shaderProgram,gl.LINK_STATUS)){window.console.log("Could not initialise shaders");}return shaderProgram;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * @author Richard Davey http://www.photonstorm.com @photonstorm
 */ /**
* @class PixiShader
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.PixiShader=function(gl){/**
     * @property _UID
     * @type Number
     * @private
     */this._UID=PIXI._UID++;/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;/**
     * The WebGL program.
     * @property program
     * @type Any
     */this.program=null;/**
     * The fragment shader.
     * @property fragmentSrc
     * @type Array
     */this.fragmentSrc=['precision lowp float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;','}'];/**
     * A local texture counter for multi-texture shaders.
     * @property textureCount
     * @type Number
     */this.textureCount=0;/**
     * A local flag
     * @property firstRun
     * @type Boolean
     * @private
     */this.firstRun=true;/**
     * A dirty flag
     * @property dirty
     * @type Boolean
     */this.dirty=true;/**
     * Uniform attributes cache.
     * @property attributes
     * @type Array
     * @private
     */this.attributes=[];this.init();};PIXI.PixiShader.prototype.constructor=PIXI.PixiShader;/**
* Initialises the shader.
*
* @method init
*/PIXI.PixiShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc||PIXI.PixiShader.defaultVertexSrc,this.fragmentSrc);gl.useProgram(program);// get and store the uniforms for the shader
this.uSampler=gl.getUniformLocation(program,'uSampler');this.projectionVector=gl.getUniformLocation(program,'projectionVector');this.offsetVector=gl.getUniformLocation(program,'offsetVector');this.dimensions=gl.getUniformLocation(program,'dimensions');// get and store the attributes
this.aVertexPosition=gl.getAttribLocation(program,'aVertexPosition');this.aTextureCoord=gl.getAttribLocation(program,'aTextureCoord');this.colorAttribute=gl.getAttribLocation(program,'aColor');// Begin worst hack eva //
// WHY??? ONLY on my chrome pixel the line above returns -1 when using filters?
// maybe its something to do with the current state of the gl context.
// I'm convinced this is a bug in the chrome browser as there is NO reason why this should be returning -1 especially as it only manifests on my chrome pixel
// If theres any webGL people that know why could happen please help :)
if(this.colorAttribute===-1){this.colorAttribute=2;}this.attributes=[this.aVertexPosition,this.aTextureCoord,this.colorAttribute];// End worst hack eva //
// add those custom shaders!
for(var key in this.uniforms){// get the uniform locations..
this.uniforms[key].uniformLocation=gl.getUniformLocation(program,key);}this.initUniforms();this.program=program;};/**
* Initialises the shader uniform values.
*
* Uniforms are specified in the GLSL_ES Specification: http://www.khronos.org/registry/webgl/specs/latest/1.0/
* http://www.khronos.org/registry/gles/specs/2.0/GLSL_ES_Specification_1.0.17.pdf
*
* @method initUniforms
*/PIXI.PixiShader.prototype.initUniforms=function(){this.textureCount=1;var gl=this.gl;var uniform;for(var key in this.uniforms){uniform=this.uniforms[key];var type=uniform.type;if(type==='sampler2D'){uniform._init=false;if(uniform.value!==null){this.initSampler2D(uniform);}}else if(type==='mat2'||type==='mat3'||type==='mat4'){//  These require special handling
uniform.glMatrix=true;uniform.glValueLength=1;if(type==='mat2'){uniform.glFunc=gl.uniformMatrix2fv;}else if(type==='mat3'){uniform.glFunc=gl.uniformMatrix3fv;}else if(type==='mat4'){uniform.glFunc=gl.uniformMatrix4fv;}}else{//  GL function reference
uniform.glFunc=gl['uniform'+type];if(type==='2f'||type==='2i'){uniform.glValueLength=2;}else if(type==='3f'||type==='3i'){uniform.glValueLength=3;}else if(type==='4f'||type==='4i'){uniform.glValueLength=4;}else{uniform.glValueLength=1;}}}};/**
* Initialises a Sampler2D uniform (which may only be available later on after initUniforms once the texture has loaded)
*
* @method initSampler2D
*/PIXI.PixiShader.prototype.initSampler2D=function(uniform){if(!uniform.value||!uniform.value.baseTexture||!uniform.value.baseTexture.hasLoaded){return;}var gl=this.gl;gl.activeTexture(gl['TEXTURE'+this.textureCount]);gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]);//  Extended texture data
if(uniform.textureData){var data=uniform.textureData;// GLTexture = mag linear, min linear_mipmap_linear, wrap repeat + gl.generateMipmap(gl.TEXTURE_2D);
// GLTextureLinear = mag/min linear, wrap clamp
// GLTextureNearestRepeat = mag/min NEAREST, wrap repeat
// GLTextureNearest = mag/min nearest, wrap clamp
// AudioTexture = whatever + luminance + width 512, height 2, border 0
// KeyTexture = whatever + luminance + width 256, height 2, border 0
//  magFilter can be: gl.LINEAR, gl.LINEAR_MIPMAP_LINEAR or gl.NEAREST
//  wrapS/T can be: gl.CLAMP_TO_EDGE or gl.REPEAT
var magFilter=data.magFilter?data.magFilter:gl.LINEAR;var minFilter=data.minFilter?data.minFilter:gl.LINEAR;var wrapS=data.wrapS?data.wrapS:gl.CLAMP_TO_EDGE;var wrapT=data.wrapT?data.wrapT:gl.CLAMP_TO_EDGE;var format=data.luminance?gl.LUMINANCE:gl.RGBA;if(data.repeat){wrapS=gl.REPEAT;wrapT=gl.REPEAT;}gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!!data.flipY);if(data.width){var width=data.width?data.width:512;var height=data.height?data.height:2;var border=data.border?data.border:0;// void texImage2D(GLenum target, GLint level, GLenum internalformat, GLsizei width, GLsizei height, GLint border, GLenum format, GLenum type, ArrayBufferView? pixels);
gl.texImage2D(gl.TEXTURE_2D,0,format,width,height,border,format,gl.UNSIGNED_BYTE,null);}else{//  void texImage2D(GLenum target, GLint level, GLenum internalformat, GLenum format, GLenum type, ImageData? pixels);
gl.texImage2D(gl.TEXTURE_2D,0,format,gl.RGBA,gl.UNSIGNED_BYTE,uniform.value.baseTexture.source);}gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,magFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,minFilter);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,wrapS);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,wrapT);}gl.uniform1i(uniform.uniformLocation,this.textureCount);uniform._init=true;this.textureCount++;};/**
* Updates the shader uniform values.
*
* @method syncUniforms
*/PIXI.PixiShader.prototype.syncUniforms=function(){this.textureCount=1;var uniform;var gl=this.gl;//  This would probably be faster in an array and it would guarantee key order
for(var key in this.uniforms){uniform=this.uniforms[key];if(uniform.glValueLength===1){if(uniform.glMatrix===true){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.transpose,uniform.value);}else{uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value);}}else if(uniform.glValueLength===2){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y);}else if(uniform.glValueLength===3){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z);}else if(uniform.glValueLength===4){uniform.glFunc.call(gl,uniform.uniformLocation,uniform.value.x,uniform.value.y,uniform.value.z,uniform.value.w);}else if(uniform.type==='sampler2D'){if(uniform._init){gl.activeTexture(gl['TEXTURE'+this.textureCount]);//if(uniform.value.baseTexture._dirty[gl.id])
//{
//    PIXI.instances[gl.id].updateTexture(uniform.value.baseTexture);
//}
//else
//{
//    // bind the current texture
//    gl.bindTexture(gl.TEXTURE_2D, uniform.value.baseTexture._glTextures[gl.id]);
//}
// Modificato da Matteo
if(uniform.value.baseTexture._dirty.length<=gl.id||uniform.value.baseTexture._dirty[gl.id]){PIXI.instances[gl.id].updateTexture(uniform.value.baseTexture);}else{// bind the current texture
gl.bindTexture(gl.TEXTURE_2D,uniform.value.baseTexture._glTextures[gl.id]);}//   gl.bindTexture(gl.TEXTURE_2D, uniform.value.baseTexture._glTextures[gl.id] || PIXI.createWebGLTexture( uniform.value.baseTexture, gl));
gl.uniform1i(uniform.uniformLocation,this.textureCount);this.textureCount++;}else{this.initSampler2D(uniform);}}}};/**
* Destroys the shader.
*
* @method destroy
*/PIXI.PixiShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null;};/**
* The Default Vertex shader source.
*
* @property defaultVertexSrc
* @type String
*/PIXI.PixiShader.defaultVertexSrc=['attribute vec2 aVertexPosition;','attribute vec2 aTextureCoord;','attribute vec4 aColor;','uniform vec2 projectionVector;','uniform vec2 offsetVector;','varying vec2 vTextureCoord;','varying vec4 vColor;','const vec2 center = vec2(-1.0, 1.0);','void main(void) {','   gl_Position = vec4( ((aVertexPosition + offsetVector) / projectionVector) + center , 0.0, 1.0);','   vTextureCoord = aTextureCoord;','   vColor = vec4(aColor.rgb * aColor.a, aColor.a);','}'];/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class PixiFastShader
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.PixiFastShader=function(gl){/**
     * @property _UID
     * @type Number
     * @private
     */this._UID=PIXI._UID++;/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;/**
     * The WebGL program.
     * @property program
     * @type Any
     */this.program=null;/**
     * The fragment shader.
     * @property fragmentSrc
     * @type Array
     */this.fragmentSrc=['precision lowp float;','varying vec2 vTextureCoord;','varying float vColor;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;','}'];/**
     * The vertex shader.
     * @property vertexSrc
     * @type Array
     */this.vertexSrc=['attribute vec2 aVertexPosition;','attribute vec2 aPositionCoord;','attribute vec2 aScale;','attribute float aRotation;','attribute vec2 aTextureCoord;','attribute float aColor;','uniform vec2 projectionVector;','uniform vec2 offsetVector;','uniform mat3 uMatrix;','varying vec2 vTextureCoord;','varying float vColor;','const vec2 center = vec2(-1.0, 1.0);','void main(void) {','   vec2 v;','   vec2 sv = aVertexPosition * aScale;','   v.x = (sv.x) * cos(aRotation) - (sv.y) * sin(aRotation);','   v.y = (sv.x) * sin(aRotation) + (sv.y) * cos(aRotation);','   v = ( uMatrix * vec3(v + aPositionCoord , 1.0) ).xy ;','   gl_Position = vec4( ( v / projectionVector) + center , 0.0, 1.0);','   vTextureCoord = aTextureCoord;',//  '   vec3 color = mod(vec3(aColor.y/65536.0, aColor.y/256.0, aColor.y), 256.0) / 256.0;',
'   vColor = aColor;','}'];/**
     * A local texture counter for multi-texture shaders.
     * @property textureCount
     * @type Number
     */this.textureCount=0;this.init();};PIXI.PixiFastShader.prototype.constructor=PIXI.PixiFastShader;/**
* Initialises the shader.
* 
* @method init
*/PIXI.PixiFastShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);// get and store the uniforms for the shader
this.uSampler=gl.getUniformLocation(program,'uSampler');this.projectionVector=gl.getUniformLocation(program,'projectionVector');this.offsetVector=gl.getUniformLocation(program,'offsetVector');this.dimensions=gl.getUniformLocation(program,'dimensions');this.uMatrix=gl.getUniformLocation(program,'uMatrix');// get and store the attributes
this.aVertexPosition=gl.getAttribLocation(program,'aVertexPosition');this.aPositionCoord=gl.getAttribLocation(program,'aPositionCoord');this.aScale=gl.getAttribLocation(program,'aScale');this.aRotation=gl.getAttribLocation(program,'aRotation');this.aTextureCoord=gl.getAttribLocation(program,'aTextureCoord');this.colorAttribute=gl.getAttribLocation(program,'aColor');// Begin worst hack eva //
// WHY??? ONLY on my chrome pixel the line above returns -1 when using filters?
// maybe its somthing to do with the current state of the gl context.
// Im convinced this is a bug in the chrome browser as there is NO reason why this should be returning -1 especially as it only manifests on my chrome pixel
// If theres any webGL people that know why could happen please help :)
if(this.colorAttribute===-1){this.colorAttribute=2;}this.attributes=[this.aVertexPosition,this.aPositionCoord,this.aScale,this.aRotation,this.aTextureCoord,this.colorAttribute];// End worst hack eva //
this.program=program;};/**
* Destroys the shader.
* 
* @method destroy
*/PIXI.PixiFastShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class StripShader
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.StripShader=function(gl){/**
     * @property _UID
     * @type Number
     * @private
     */this._UID=PIXI._UID++;/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;/**
     * The WebGL program.
     * @property program
     * @type Any
     */this.program=null;/**
     * The fragment shader.
     * @property fragmentSrc
     * @type Array
     */this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;',//   'varying float vColor;',
'uniform float alpha;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * alpha;',//  '   gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);',//gl_FragColor * alpha;',
'}'];/**
     * The vertex shader.
     * @property vertexSrc
     * @type Array
     */this.vertexSrc=['attribute vec2 aVertexPosition;','attribute vec2 aTextureCoord;','uniform mat3 translationMatrix;','uniform vec2 projectionVector;','uniform vec2 offsetVector;',//  'uniform float alpha;',
// 'uniform vec3 tint;',
'varying vec2 vTextureCoord;',//  'varying vec4 vColor;',
'void main(void) {','   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);','   v -= offsetVector.xyx;','   gl_Position = vec4( v.x / projectionVector.x -1.0, v.y / -projectionVector.y + 1.0 , 0.0, 1.0);','   vTextureCoord = aTextureCoord;',// '   vColor = aColor * vec4(tint * alpha, alpha);',
'}'];this.init();};PIXI.StripShader.prototype.constructor=PIXI.StripShader;/**
* Initialises the shader.
* 
* @method init
*/PIXI.StripShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);// get and store the uniforms for the shader
this.uSampler=gl.getUniformLocation(program,'uSampler');this.projectionVector=gl.getUniformLocation(program,'projectionVector');this.offsetVector=gl.getUniformLocation(program,'offsetVector');this.colorAttribute=gl.getAttribLocation(program,'aColor');//this.dimensions = gl.getUniformLocation(this.program, 'dimensions');
// get and store the attributes
this.aVertexPosition=gl.getAttribLocation(program,'aVertexPosition');this.aTextureCoord=gl.getAttribLocation(program,'aTextureCoord');this.attributes=[this.aVertexPosition,this.aTextureCoord];this.translationMatrix=gl.getUniformLocation(program,'translationMatrix');this.alpha=gl.getUniformLocation(program,'alpha');this.program=program;};/**
* Destroys the shader.
* 
* @method destroy
*/PIXI.StripShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class PrimitiveShader
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.PrimitiveShader=function(gl){/**
     * @property _UID
     * @type Number
     * @private
     */this._UID=PIXI._UID++;/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;/**
     * The WebGL program.
     * @property program
     * @type Any
     */this.program=null;/**
     * The fragment shader.
     * @property fragmentSrc
     * @type Array
     */this.fragmentSrc=['precision mediump float;','varying vec4 vColor;','void main(void) {','   gl_FragColor = vColor;','}'];/**
     * The vertex shader.
     * @property vertexSrc
     * @type Array
     */this.vertexSrc=['attribute vec2 aVertexPosition;','attribute vec4 aColor;','uniform mat3 translationMatrix;','uniform vec2 projectionVector;','uniform vec2 offsetVector;','uniform float alpha;','uniform float flipY;','uniform vec3 tint;','varying vec4 vColor;','void main(void) {','   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);','   v -= offsetVector.xyx;','   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);','   vColor = aColor * vec4(tint * alpha, alpha);','}'];this.init();};PIXI.PrimitiveShader.prototype.constructor=PIXI.PrimitiveShader;/**
* Initialises the shader.
* 
* @method init
*/PIXI.PrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);// get and store the uniforms for the shader
this.projectionVector=gl.getUniformLocation(program,'projectionVector');this.offsetVector=gl.getUniformLocation(program,'offsetVector');this.tintColor=gl.getUniformLocation(program,'tint');this.flipY=gl.getUniformLocation(program,'flipY');// get and store the attributes
this.aVertexPosition=gl.getAttribLocation(program,'aVertexPosition');this.colorAttribute=gl.getAttribLocation(program,'aColor');this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,'translationMatrix');this.alpha=gl.getUniformLocation(program,'alpha');this.program=program;};/**
* Destroys the shader.
* 
* @method destroy
*/PIXI.PrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attributes=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class ComplexPrimitiveShader
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.ComplexPrimitiveShader=function(gl){/**
     * @property _UID
     * @type Number
     * @private
     */this._UID=PIXI._UID++;/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;/**
     * The WebGL program.
     * @property program
     * @type Any
     */this.program=null;/**
     * The fragment shader.
     * @property fragmentSrc
     * @type Array
     */this.fragmentSrc=['precision mediump float;','varying vec4 vColor;','void main(void) {','   gl_FragColor = vColor;','}'];/**
     * The vertex shader.
     * @property vertexSrc
     * @type Array
     */this.vertexSrc=['attribute vec2 aVertexPosition;',//'attribute vec4 aColor;',
'uniform mat3 translationMatrix;','uniform vec2 projectionVector;','uniform vec2 offsetVector;','uniform vec3 tint;','uniform float alpha;','uniform vec3 color;','uniform float flipY;','varying vec4 vColor;','void main(void) {','   vec3 v = translationMatrix * vec3(aVertexPosition , 1.0);','   v -= offsetVector.xyx;','   gl_Position = vec4( v.x / projectionVector.x -1.0, (v.y / projectionVector.y * -flipY) + flipY , 0.0, 1.0);','   vColor = vec4(color * alpha * tint, alpha);',//" * vec4(tint * alpha, alpha);',
'}'];this.init();};PIXI.ComplexPrimitiveShader.prototype.constructor=PIXI.ComplexPrimitiveShader;/**
* Initialises the shader.
* 
* @method init
*/PIXI.ComplexPrimitiveShader.prototype.init=function(){var gl=this.gl;var program=PIXI.compileProgram(gl,this.vertexSrc,this.fragmentSrc);gl.useProgram(program);// get and store the uniforms for the shader
this.projectionVector=gl.getUniformLocation(program,'projectionVector');this.offsetVector=gl.getUniformLocation(program,'offsetVector');this.tintColor=gl.getUniformLocation(program,'tint');this.color=gl.getUniformLocation(program,'color');this.flipY=gl.getUniformLocation(program,'flipY');// get and store the attributes
this.aVertexPosition=gl.getAttribLocation(program,'aVertexPosition');// this.colorAttribute = gl.getAttribLocation(program, 'aColor');
this.attributes=[this.aVertexPosition,this.colorAttribute];this.translationMatrix=gl.getUniformLocation(program,'translationMatrix');this.alpha=gl.getUniformLocation(program,'alpha');this.program=program;};/**
* Destroys the shader.
* 
* @method destroy
*/PIXI.ComplexPrimitiveShader.prototype.destroy=function(){this.gl.deleteProgram(this.program);this.uniforms=null;this.gl=null;this.attribute=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A set of functions used by the webGL renderer to draw the primitive graphics data
 *
 * @class WebGLGraphics
 * @private
 * @static
 */PIXI.WebGLGraphics=function(){};/**
 * Renders the graphics object
 *
 * @static
 * @private
 * @method renderGraphics
 * @param graphics {Graphics}
 * @param renderSession {Object}
 */PIXI.WebGLGraphics.renderGraphics=function(graphics,renderSession)//projection, offset)
{var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.primitiveShader,webGLData;if(graphics.dirty){PIXI.WebGLGraphics.updateGraphics(graphics,gl);}var webGL=graphics._webGL[gl.id];// This  could be speeded up for sure!
for(var i=0;i<webGL.data.length;i++){if(webGL.data[i].mode===1){webGLData=webGL.data[i];renderSession.stencilManager.pushStencil(graphics,webGLData,renderSession);// render quad..
gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);renderSession.stencilManager.popStencil(graphics,webGLData,renderSession);}else{webGLData=webGL.data[i];renderSession.shaderManager.setShader(shader);//activatePrimitiveShader();
shader=renderSession.shaderManager.primitiveShader;gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,1);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);// set the index buffer!
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer);gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);}}};/**
 * Updates the graphics object
 *
 * @static
 * @private
 * @method updateGraphics
 * @param graphicsData {Graphics} The graphics object to update
 * @param gl {WebGLContext} the current WebGL drawing context
 */PIXI.WebGLGraphics.updateGraphics=function(graphics,gl){// get the contexts graphics object
var webGL=graphics._webGL[gl.id];// if the graphics object does not exist in the webGL context time to create it!
if(!webGL)webGL=graphics._webGL[gl.id]={lastIndex:0,data:[],gl:gl};// flag the graphics as not dirty as we are about to update it...
graphics.dirty=false;var i;// if the user cleared the graphics object we will need to clear every object
if(graphics.clearDirty){graphics.clearDirty=false;// lop through and return all the webGLDatas to the object pool so than can be reused later on
for(i=0;i<webGL.data.length;i++){var graphicsData=webGL.data[i];graphicsData.reset();PIXI.WebGLGraphics.graphicsDataPool.push(graphicsData);}// clear the array and reset the index.. 
webGL.data=[];webGL.lastIndex=0;}var webGLData;// loop through the graphics datas and construct each one..
// if the object is a complex fill then the new stencil buffer technique will be used
// other wise graphics objects will be pushed into a batch..
for(i=webGL.lastIndex;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];if(data.type===PIXI.Graphics.POLY){// need to add the points the the graphics object..
data.points=data.shape.points.slice();if(data.shape.closed){// close the poly if the value is true!
if(data.points[0]!==data.points[data.points.length-2]||data.points[1]!==data.points[data.points.length-1]){data.points.push(data.points[0],data.points[1]);}}// MAKE SURE WE HAVE THE CORRECT TYPE..
if(data.fill){if(data.points.length>=6){if(data.points.length<6*2){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);var canDrawUsingSimple=PIXI.WebGLGraphics.buildPoly(data,webGLData);//     console.log(canDrawUsingSimple);
if(!canDrawUsingSimple){//    console.log("<>>>")
webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData);}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,1);PIXI.WebGLGraphics.buildComplexPoly(data,webGLData);}}}if(data.lineWidth>0){webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);PIXI.WebGLGraphics.buildLine(data,webGLData);}}else{webGLData=PIXI.WebGLGraphics.switchMode(webGL,0);if(data.type===PIXI.Graphics.RECT){PIXI.WebGLGraphics.buildRectangle(data,webGLData);}else if(data.type===PIXI.Graphics.CIRC||data.type===PIXI.Graphics.ELIP){PIXI.WebGLGraphics.buildCircle(data,webGLData);}else if(data.type===PIXI.Graphics.RREC){PIXI.WebGLGraphics.buildRoundedRectangle(data,webGLData);}}webGL.lastIndex++;}// upload all the dirty data...
for(i=0;i<webGL.data.length;i++){webGLData=webGL.data[i];if(webGLData.dirty)webGLData.upload();}};/**
 * @static
 * @private
 * @method switchMode
 * @param webGL {WebGLContext}
 * @param type {Number}
 */PIXI.WebGLGraphics.switchMode=function(webGL,type){var webGLData;if(!webGL.data.length){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData);}else{webGLData=webGL.data[webGL.data.length-1];if(webGLData.mode!==type||type===1){webGLData=PIXI.WebGLGraphics.graphicsDataPool.pop()||new PIXI.WebGLGraphicsData(webGL.gl);webGLData.mode=type;webGL.data.push(webGLData);}}webGLData.dirty=true;return webGLData;};/**
 * Builds a rectangle to draw
 *
 * @static
 * @private
 * @method buildRectangle
 * @param graphicsData {Graphics} The graphics object containing all the necessary properties
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildRectangle=function(graphicsData,webGLData){// --- //
// need to convert points to a nice regular data
//
var rectData=graphicsData.shape;var x=rectData.x;var y=rectData.y;var width=rectData.width;var height=rectData.height;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vertPos=verts.length/6;// start
verts.push(x,y);verts.push(r,g,b,alpha);verts.push(x+width,y);verts.push(r,g,b,alpha);verts.push(x,y+height);verts.push(r,g,b,alpha);verts.push(x+width,y+height);verts.push(r,g,b,alpha);// insert 2 dead triangles..
indices.push(vertPos,vertPos,vertPos+1,vertPos+2,vertPos+3,vertPos+3);}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[x,y,x+width,y,x+width,y+height,x,y+height,x,y];PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints;}};/**
 * Builds a rounded rectangle to draw
 *
 * @static
 * @private
 * @method buildRoundedRectangle
 * @param graphicsData {Graphics} The graphics object containing all the necessary properties
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildRoundedRectangle=function(graphicsData,webGLData){var rrectData=graphicsData.shape;var x=rrectData.x;var y=rrectData.y;var width=rrectData.width;var height=rrectData.height;var radius=rrectData.radius;var recPoints=[];recPoints.push(x,y+radius);recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x,y+height-radius,x,y+height,x+radius,y+height));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width-radius,y+height,x+width,y+height,x+width,y+height-radius));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+width,y+radius,x+width,y,x+width-radius,y));recPoints=recPoints.concat(PIXI.WebGLGraphics.quadraticBezierCurve(x+radius,y,x,y,x,y+radius));if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;var triangles=PIXI.PolyK.Triangulate(recPoints);// 
var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vecPos);indices.push(triangles[i]+vecPos);indices.push(triangles[i+1]+vecPos);indices.push(triangles[i+2]+vecPos);indices.push(triangles[i+2]+vecPos);}for(i=0;i<recPoints.length;i++){verts.push(recPoints[i],recPoints[++i],r,g,b,alpha);}}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=recPoints;PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints;}};/**
 * Calculate the points for a quadratic bezier curve. (helper function..)
 * Based on: https://stackoverflow.com/questions/785097/how-do-i-implement-a-bezier-curve-in-c
 *
 * @static
 * @private
 * @method quadraticBezierCurve
 * @param fromX {Number} Origin point x
 * @param fromY {Number} Origin point x
 * @param cpX {Number} Control point x
 * @param cpY {Number} Control point y
 * @param toX {Number} Destination point x
 * @param toY {Number} Destination point y
 * @return {Array(Number)}
 */PIXI.WebGLGraphics.quadraticBezierCurve=function(fromX,fromY,cpX,cpY,toX,toY){var xa,ya,xb,yb,x,y,n=20,points=[];function getPt(n1,n2,perc){var diff=n2-n1;return n1+diff*perc;}var j=0;for(var i=0;i<=n;i++){j=i/n;// The Green Line
xa=getPt(fromX,cpX,j);ya=getPt(fromY,cpY,j);xb=getPt(cpX,toX,j);yb=getPt(cpY,toY,j);// The Black Dot
x=getPt(xa,xb,j);y=getPt(ya,yb,j);points.push(x,y);}return points;};/**
 * Builds a circle to draw
 *
 * @static
 * @private
 * @method buildCircle
 * @param graphicsData {Graphics} The graphics object to draw
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildCircle=function(graphicsData,webGLData){// need to convert points to a nice regular data
var circleData=graphicsData.shape;var x=circleData.x;var y=circleData.y;var width;var height;// TODO - bit hacky??
if(graphicsData.type===PIXI.Graphics.CIRC){width=circleData.radius;height=circleData.radius;}else{width=circleData.width;height=circleData.height;}var totalSegs=40;var seg=Math.PI*2/totalSegs;var i=0;if(graphicsData.fill){var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var verts=webGLData.points;var indices=webGLData.indices;var vecPos=verts.length/6;indices.push(vecPos);for(i=0;i<totalSegs+1;i++){verts.push(x,y,r,g,b,alpha);verts.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height,r,g,b,alpha);indices.push(vecPos++,vecPos++);}indices.push(vecPos-1);}if(graphicsData.lineWidth){var tempPoints=graphicsData.points;graphicsData.points=[];for(i=0;i<totalSegs+1;i++){graphicsData.points.push(x+Math.sin(seg*i)*width,y+Math.cos(seg*i)*height);}PIXI.WebGLGraphics.buildLine(graphicsData,webGLData);graphicsData.points=tempPoints;}};/**
 * Builds a line to draw
 *
 * @static
 * @private
 * @method buildLine
 * @param graphicsData {Graphics} The graphics object containing all the necessary properties
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildLine=function(graphicsData,webGLData){// TODO OPTIMISE!
var i=0;var points=graphicsData.points;if(points.length===0)return;// if the line width is an odd number add 0.5 to align to a whole pixel
if(graphicsData.lineWidth%2){for(i=0;i<points.length;i++){points[i]+=0.5;}}// get first and last point.. figure out the middle!
var firstPoint=new PIXI.Point(points[0],points[1]);var lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);// if the first point is the last point - gonna have issues :)
if(firstPoint.x===lastPoint.x&&firstPoint.y===lastPoint.y){// need to clone as we are going to slightly modify the shape..
points=points.slice();points.pop();points.pop();lastPoint=new PIXI.Point(points[points.length-2],points[points.length-1]);var midPointX=lastPoint.x+(firstPoint.x-lastPoint.x)*0.5;var midPointY=lastPoint.y+(firstPoint.y-lastPoint.y)*0.5;points.unshift(midPointX,midPointY);points.push(midPointX,midPointY);}var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;var indexCount=points.length;var indexStart=verts.length/6;// DRAW the Line
var width=graphicsData.lineWidth/2;// sort color
var color=PIXI.hex2rgb(graphicsData.lineColor);var alpha=graphicsData.lineAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var px,py,p1x,p1y,p2x,p2y,p3x,p3y;var perpx,perpy,perp2x,perp2y,perp3x,perp3y;var a1,b1,c1,a2,b2,c2;var denom,pdist,dist;p1x=points[0];p1y=points[1];p2x=points[2];p2y=points[3];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;// start
verts.push(p1x-perpx,p1y-perpy,r,g,b,alpha);verts.push(p1x+perpx,p1y+perpy,r,g,b,alpha);for(i=1;i<length-1;i++){p1x=points[(i-1)*2];p1y=points[(i-1)*2+1];p2x=points[i*2];p2y=points[i*2+1];p3x=points[(i+1)*2];p3y=points[(i+1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;perp2x=-(p2y-p3y);perp2y=p2x-p3x;dist=Math.sqrt(perp2x*perp2x+perp2y*perp2y);perp2x/=dist;perp2y/=dist;perp2x*=width;perp2y*=width;a1=-perpy+p1y-(-perpy+p2y);b1=-perpx+p2x-(-perpx+p1x);c1=(-perpx+p1x)*(-perpy+p2y)-(-perpx+p2x)*(-perpy+p1y);a2=-perp2y+p3y-(-perp2y+p2y);b2=-perp2x+p2x-(-perp2x+p3x);c2=(-perp2x+p3x)*(-perp2y+p2y)-(-perp2x+p2x)*(-perp2y+p3y);denom=a1*b2-a2*b1;if(Math.abs(denom)<0.1){denom+=10.1;verts.push(p2x-perpx,p2y-perpy,r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy,r,g,b,alpha);continue;}px=(b1*c2-b2*c1)/denom;py=(a2*c1-a1*c2)/denom;pdist=(px-p2x)*(px-p2x)+(py-p2y)+(py-p2y);if(pdist>140*140){perp3x=perpx-perp2x;perp3y=perpy-perp2y;dist=Math.sqrt(perp3x*perp3x+perp3y*perp3y);perp3x/=dist;perp3y/=dist;perp3x*=width;perp3y*=width;verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);verts.push(p2x+perp3x,p2y+perp3y);verts.push(r,g,b,alpha);verts.push(p2x-perp3x,p2y-perp3y);verts.push(r,g,b,alpha);indexCount++;}else{verts.push(px,py);verts.push(r,g,b,alpha);verts.push(p2x-(px-p2x),p2y-(py-p2y));verts.push(r,g,b,alpha);}}p1x=points[(length-2)*2];p1y=points[(length-2)*2+1];p2x=points[(length-1)*2];p2y=points[(length-1)*2+1];perpx=-(p1y-p2y);perpy=p1x-p2x;dist=Math.sqrt(perpx*perpx+perpy*perpy);perpx/=dist;perpy/=dist;perpx*=width;perpy*=width;verts.push(p2x-perpx,p2y-perpy);verts.push(r,g,b,alpha);verts.push(p2x+perpx,p2y+perpy);verts.push(r,g,b,alpha);indices.push(indexStart);for(i=0;i<indexCount;i++){indices.push(indexStart++);}indices.push(indexStart-1);};/**
 * Builds a complex polygon to draw
 *
 * @static
 * @private
 * @method buildComplexPoly
 * @param graphicsData {Graphics} The graphics object containing all the necessary properties
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildComplexPoly=function(graphicsData,webGLData){//TODO - no need to copy this as it gets turned into a FLoat32Array anyways..
var points=graphicsData.points.slice();if(points.length<6)return;// get first and last point.. figure out the middle!
var indices=webGLData.indices;webGLData.points=points;webGLData.alpha=graphicsData.fillAlpha;webGLData.color=PIXI.hex2rgb(graphicsData.fillColor);/*
        calclate the bounds..
    */var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;var x,y;// get size..
for(var i=0;i<points.length;i+=2){x=points[i];y=points[i+1];minX=x<minX?x:minX;maxX=x>maxX?x:maxX;minY=y<minY?y:minY;maxY=y>maxY?y:maxY;}// add a quad to the end cos there is no point making another buffer!
points.push(minX,minY,maxX,minY,maxX,maxY,minX,maxY);// push a quad onto the end.. 
//TODO - this aint needed!
var length=points.length/2;for(i=0;i<length;i++){indices.push(i);}};/**
 * Builds a polygon to draw
 *
 * @static
 * @private
 * @method buildPoly
 * @param graphicsData {Graphics} The graphics object containing all the necessary properties
 * @param webGLData {Object}
 */PIXI.WebGLGraphics.buildPoly=function(graphicsData,webGLData){var points=graphicsData.points;if(points.length<6)return;// get first and last point.. figure out the middle!
var verts=webGLData.points;var indices=webGLData.indices;var length=points.length/2;// sort color
var color=PIXI.hex2rgb(graphicsData.fillColor);var alpha=graphicsData.fillAlpha;var r=color[0]*alpha;var g=color[1]*alpha;var b=color[2]*alpha;var triangles=PIXI.PolyK.Triangulate(points);if(!triangles)return false;var vertPos=verts.length/6;var i=0;for(i=0;i<triangles.length;i+=3){indices.push(triangles[i]+vertPos);indices.push(triangles[i]+vertPos);indices.push(triangles[i+1]+vertPos);indices.push(triangles[i+2]+vertPos);indices.push(triangles[i+2]+vertPos);}for(i=0;i<length;i++){verts.push(points[i*2],points[i*2+1],r,g,b,alpha);}return true;};PIXI.WebGLGraphics.graphicsDataPool=[];/**
 * @class WebGLGraphicsData
 * @private
 * @static
 */PIXI.WebGLGraphicsData=function(gl){this.gl=gl;//TODO does this need to be split before uploding??
this.color=[0,0,0];// color split!
this.points=[];this.indices=[];this.buffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();this.mode=1;this.alpha=1;this.dirty=true;};/**
 * @method reset
 */PIXI.WebGLGraphicsData.prototype.reset=function(){this.points=[];this.indices=[];};/**
 * @method upload
 */PIXI.WebGLGraphicsData.prototype.upload=function(){var gl=this.gl;//    this.lastIndex = graphics.graphicsData.length;
this.glPoints=new PIXI.Float32Array(this.points);gl.bindBuffer(gl.ARRAY_BUFFER,this.buffer);gl.bufferData(gl.ARRAY_BUFFER,this.glPoints,gl.STATIC_DRAW);this.glIndicies=new PIXI.Uint16Array(this.indices);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.glIndicies,gl.STATIC_DRAW);this.dirty=false;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */PIXI.glContexts=[];// this is where we store the webGL contexts for easy access.
PIXI.instances=[];/**
 * The WebGLRenderer draws the stage and all its content onto a webGL enabled canvas. This renderer
 * should be used for browsers that support webGL. This Render works by automatically managing webGLBatchs.
 * So no need for Sprite Batches or Sprite Clouds.
 * Don't forget to add the view to your DOM or you will not see anything :)
 *
 * @class WebGLRenderer
 * @constructor
 * @param [width=0] {Number} the width of the canvas view
 * @param [height=0] {Number} the height of the canvas view
 * @param [options] {Object} The optional renderer parameters
 * @param [options.view] {HTMLCanvasElement} the canvas to use as a view, optional
 * @param [options.transparent=false] {Boolean} If the render view is transparent, default false
 * @param [options.autoResize=false] {Boolean} If the render view is automatically resized, default false
 * @param [options.antialias=false] {Boolean} sets antialias (only applicable in chrome at the moment)
 * @param [options.preserveDrawingBuffer=false] {Boolean} enables drawing buffer preservation, enable this if you need to call toDataUrl on the webgl context
 * @param [options.resolution=1] {Number} the resolution of the renderer retina would be 2
 */PIXI.WebGLRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==='undefined')options[i]=PIXI.defaultRenderOptions[i];}}else{options=PIXI.defaultRenderOptions;}if(!PIXI.defaultRenderer){PIXI.sayHello('webGL');PIXI.defaultRenderer=this;}/**
     * @property type
     * @type Number
     */this.type=PIXI.WEBGL_RENDERER;/**
     * The resolution of the renderer
     *
     * @property resolution
     * @type Number
     * @default 1
     */this.resolution=options.resolution;// do a catch.. only 1 webGL renderer..
/**
     * Whether the render view is transparent
     *
     * @property transparent
     * @type Boolean
     */this.transparent=options.transparent;/**
     * Whether the render view should be resized automatically
     *
     * @property autoResize
     * @type Boolean
     */this.autoResize=options.autoResize||false;/**
     * The value of the preserveDrawingBuffer flag affects whether or not the contents of the stencil buffer is retained after rendering.
     *
     * @property preserveDrawingBuffer
     * @type Boolean
     */this.preserveDrawingBuffer=options.preserveDrawingBuffer;/**
     * This sets if the WebGLRenderer will clear the context texture or not before the new render pass. If true:
     * If the Stage is NOT transparent, Pixi will clear to alpha (0, 0, 0, 0).
     * If the Stage is transparent, Pixi will clear to the target Stage's background color.
     * Disable this by setting this to false. For example: if your game has a canvas filling background image, you often don't need this set.
     *
     * @property clearBeforeRender
     * @type Boolean
     * @default
     */this.clearBeforeRender=options.clearBeforeRender;/**
     * The width of the canvas view
     *
     * @property width
     * @type Number
     * @default 800
     */this.width=width||800;/**
     * The height of the canvas view
     *
     * @property height
     * @type Number
     * @default 600
     */this.height=height||600;/**
     * The canvas element that everything is drawn to
     *
     * @property view
     * @type HTMLCanvasElement
     */this.view=options.view||document.createElement('canvas');// deal with losing context..
/**
     * @property contextLostBound
     * @type Function
     */this.contextLostBound=this.handleContextLost.bind(this);/**
     * @property contextRestoredBound
     * @type Function
     */this.contextRestoredBound=this.handleContextRestored.bind(this);this.view.addEventListener('webglcontextlost',this.contextLostBound,false);this.view.addEventListener('webglcontextrestored',this.contextRestoredBound,false);/**
     * @property _contextOptions
     * @type Object
     * @private
     */this._contextOptions={alpha:this.transparent,antialias:options.antialias,// SPEED UP??
premultipliedAlpha:this.transparent&&this.transparent!=='notMultiplied',stencil:true,preserveDrawingBuffer:options.preserveDrawingBuffer};/**
     * @property projection
     * @type Point
     */this.projection=new PIXI.Point();/**
     * @property offset
     * @type Point
     */this.offset=new PIXI.Point(0,0);// time to create the render managers! each one focuses on managing a state in webGL
/**
     * Deals with managing the shader programs and their attribs
     * @property shaderManager
     * @type WebGLShaderManager
     */this.shaderManager=new PIXI.WebGLShaderManager();/**
     * Manages the rendering of sprites
     * @property spriteBatch
     * @type WebGLSpriteBatch
     */this.spriteBatch=new PIXI.WebGLSpriteBatch();/**
     * Manages the masks using the stencil buffer
     * @property maskManager
     * @type WebGLMaskManager
     */this.maskManager=new PIXI.WebGLMaskManager();/**
     * Manages the filters
     * @property filterManager
     * @type WebGLFilterManager
     */this.filterManager=new PIXI.WebGLFilterManager();/**
     * Manages the stencil buffer
     * @property stencilManager
     * @type WebGLStencilManager
     */this.stencilManager=new PIXI.WebGLStencilManager();/**
     * Manages the blendModes
     * @property blendModeManager
     * @type WebGLBlendModeManager
     */this.blendModeManager=new PIXI.WebGLBlendModeManager();/**
     * TODO remove
     * @property renderSession
     * @type Object
     */this.renderSession={};this.renderSession.gl=this.gl;this.renderSession.drawCount=0;this.renderSession.shaderManager=this.shaderManager;this.renderSession.maskManager=this.maskManager;this.renderSession.filterManager=this.filterManager;this.renderSession.blendModeManager=this.blendModeManager;this.renderSession.spriteBatch=this.spriteBatch;this.renderSession.stencilManager=this.stencilManager;this.renderSession.renderer=this;this.renderSession.resolution=this.resolution;// time init the context..
this.initContext();// map some webGL blend modes..
this.mapBlendModes();};// constructor
PIXI.WebGLRenderer.prototype.constructor=PIXI.WebGLRenderer;/**
* @method initContext
*/PIXI.WebGLRenderer.prototype.initContext=function(){var gl=this.view.getContext('webgl',this._contextOptions)||this.view.getContext('experimental-webgl',this._contextOptions);/*
    function logGLCall(functionName, args) {
        if (functionName === "bindTexture") {
            console.log("gl." + functionName + "(" +
                WebGLDebugUtils.glFunctionArgsToString(functionName, args) + ")");
        }
    } 

    function validateNoneOfTheArgsAreUndefined(functionName, args) {
        if (functionName === "bindTexture") {
            for (var ii = 0; ii < args.length; ++ii) {
                if (args[ii] === undefined) {
                    console.error("undefined passed to gl." + functionName + "(" +
                        WebGLDebugUtils.glFunctionArgsToString(functionName, args) + ")");
                }
            }
        }
    } 

    function logAndValidate(functionName, args) {
        logGLCall(functionName, args);
        validateNoneOfTheArgsAreUndefined(functionName, args);
    }

    gl = WebGLDebugUtils.makeDebugContext(
        gl, undefined, logAndValidate);
    */this.gl=gl;if(!gl){// fail, not able to get a context
throw new Error('This browser does not support webGL. Try using the canvas renderer');}this.glContextId=gl.id=PIXI.WebGLRenderer.glContextId++;PIXI.glContexts[this.glContextId]=gl;PIXI.instances[this.glContextId]=this;// set up the default pixi settings..
gl.disable(gl.DEPTH_TEST);gl.disable(gl.CULL_FACE);gl.enable(gl.BLEND);// need to set the context for all the managers...
this.shaderManager.setContext(gl);this.spriteBatch.setContext(gl);this.maskManager.setContext(gl);this.filterManager.setContext(gl);this.blendModeManager.setContext(gl);this.stencilManager.setContext(gl);this.renderSession.gl=this.gl;// now resize and we are good to go!
this.resize(this.width,this.height);// debug - Matteo
//console.log("Renderer.width: " + this.width + " - Renderer.height: " + this.height);
};/**
 * Renders the stage to its webGL view
 *
 * @method render
 * @param stage {Stage} the Stage element to be rendered
 */PIXI.WebGLRenderer.prototype.render=function(stage){// no point rendering if our context has been blown up!
if(this.contextLost)return;// if rendering a new stage clear the batches..
if(this.__stage!==stage){if(stage.interactive)stage.interactionManager.removeEvents();// TODO make this work
// dont think this is needed any more?
this.__stage=stage;}// update the scene graph
stage.updateTransform();var gl=this.gl;// interaction
if(stage._interactive){//need to add some events!
if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this);}}else{if(stage._interactiveEventsAdded){stage._interactiveEventsAdded=false;stage.interactionManager.setTarget(this);}}// -- Does this need to be set every frame? -- //
gl.viewport(0,0,this.width,this.height);// debug - Matteo
//console.log("Viewport.width: " + this.width + " - Viewport.height: " + this.height);
// make sure we are bound to the main frame buffer
gl.bindFramebuffer(gl.FRAMEBUFFER,null);if(this.clearBeforeRender){if(this.transparent){gl.clearColor(0,0,0,0);}else{gl.clearColor(stage.backgroundColorSplit[0],stage.backgroundColorSplit[1],stage.backgroundColorSplit[2],1);}gl.clear(gl.COLOR_BUFFER_BIT);}this.renderDisplayObject(stage,this.projection);};/**
 * Renders a Display Object.
 *
 * @method renderDisplayObject
 * @param displayObject {DisplayObject} The DisplayObject to render
 * @param projection {Point} The projection
 * @param buffer {Array} a standard WebGL buffer
 */PIXI.WebGLRenderer.prototype.renderDisplayObject=function(displayObject,projection,buffer){this.renderSession.blendModeManager.setBlendMode(PIXI.blendModes.NORMAL);// reset the render session data..
this.renderSession.drawCount=0;// make sure to flip the Y if using a render texture..
this.renderSession.flipY=buffer?-1:1;// set the default projection
this.renderSession.projection=projection;//set the default offset
this.renderSession.offset=this.offset;// start the sprite batch
this.spriteBatch.begin(this.renderSession);// start the filter manager
this.filterManager.begin(this.renderSession,buffer);// render the scene!
displayObject._renderWebGL(this.renderSession);// finish the sprite batch
this.spriteBatch.end();};/**
 * Resizes the webGL view to the specified width and height.
 *
 * @method resize
 * @param width {Number} the new width of the webGL view
 * @param height {Number} the new height of the webGL view
 */PIXI.WebGLRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+'px';this.view.style.height=this.height/this.resolution+'px';}this.gl.viewport(0,0,this.width,this.height);this.projection.x=this.width/2/this.resolution;this.projection.y=-this.height/2/this.resolution;};/**
 * Updates and Creates a WebGL texture for the renderers context.
 *
 * @method updateTexture
 * @param texture {Texture} the texture to update
 */PIXI.WebGLRenderer.prototype.updateTexture=function(texture){if(!texture.hasLoaded)return;var gl=this.gl;if(!texture._glTextures[gl.id])texture._glTextures[gl.id]=gl.createTexture();gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,texture.premultipliedAlpha);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,texture.source);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);if(texture.mipmap&&PIXI.isPowerOfTwo(texture.width,texture.height)){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR_MIPMAP_LINEAR:gl.NEAREST_MIPMAP_NEAREST);gl.generateMipmap(gl.TEXTURE_2D);}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,texture.scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);}// reguler...
if(!texture._powerOf2){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);}else{gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.REPEAT);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.REPEAT);}texture._dirty[gl.id]=false;return texture._glTextures[gl.id];};/**
 * Handles a lost webgl context
 *
 * @method handleContextLost
 * @param event {Event}
 * @private
 */PIXI.WebGLRenderer.prototype.handleContextLost=function(event){event.preventDefault();this.contextLost=true;};/**
 * Handles a restored webgl context
 *
 * @method handleContextRestored
 * @param event {Event}
 * @private
 */PIXI.WebGLRenderer.prototype.handleContextRestored=function(){this.initContext();// empty all the ol gl textures as they are useless now
for(var key in PIXI.TextureCache){var texture=PIXI.TextureCache[key].baseTexture;texture._glTextures=[];}this.contextLost=false;};/**
 * Removes everything from the renderer (event listeners, spritebatch, etc...)
 *
 * @method destroy
 */PIXI.WebGLRenderer.prototype.destroy=function(){// remove listeners
this.view.removeEventListener('webglcontextlost',this.contextLostBound);this.view.removeEventListener('webglcontextrestored',this.contextRestoredBound);PIXI.glContexts[this.glContextId]=null;this.projection=null;this.offset=null;// time to create the render managers! each one focuses on managine a state in webGL
this.shaderManager.destroy();this.spriteBatch.destroy();this.maskManager.destroy();this.filterManager.destroy();this.shaderManager=null;this.spriteBatch=null;this.maskManager=null;this.filterManager=null;// Matteo
this.gl.useProgram(null);if(this.gl.getExtension('WEBGL_lose_context')){this.gl.getExtension('WEBGL_lose_context').loseContext();}this.gl=null;this.renderSession=null;};/**
 * Maps Pixi blend modes to WebGL blend modes.
 *
 * @method mapBlendModes
 */PIXI.WebGLRenderer.prototype.mapBlendModes=function(){var gl=this.gl;if(!PIXI.blendModesWebGL){PIXI.blendModesWebGL=[];PIXI.blendModesWebGL[PIXI.blendModes.NORMAL]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.ADD]=[gl.SRC_ALPHA,gl.DST_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.MULTIPLY]=[gl.DST_COLOR,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SCREEN]=[gl.SRC_ALPHA,gl.ONE];PIXI.blendModesWebGL[PIXI.blendModes.OVERLAY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DARKEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LIGHTEN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_DODGE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR_BURN]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HARD_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SOFT_LIGHT]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.DIFFERENCE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.EXCLUSION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.HUE]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.SATURATION]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.COLOR]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];PIXI.blendModesWebGL[PIXI.blendModes.LUMINOSITY]=[gl.ONE,gl.ONE_MINUS_SRC_ALPHA];}};PIXI.WebGLRenderer.glContextId=0;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class WebGLBlendModeManager
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLBlendModeManager=function(){/**
     * @property currentBlendMode
     * @type Number
     */this.currentBlendMode=99999;};PIXI.WebGLBlendModeManager.prototype.constructor=PIXI.WebGLBlendModeManager;/**
 * Sets the WebGL Context.
 *
 * @method setContext
 * @param gl {WebGLContext} the current WebGL drawing context
 */PIXI.WebGLBlendModeManager.prototype.setContext=function(gl){this.gl=gl;};/**
* Sets-up the given blendMode from WebGL's point of view.
* 
* @method setBlendMode 
* @param blendMode {Number} the blendMode, should be a Pixi const, such as PIXI.BlendModes.ADD
*/PIXI.WebGLBlendModeManager.prototype.setBlendMode=function(blendMode){if(this.currentBlendMode===blendMode)return false;this.currentBlendMode=blendMode;var blendModeWebGL=PIXI.blendModesWebGL[this.currentBlendMode];this.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1]);return true;};/**
* Destroys this object.
* 
* @method destroy
*/PIXI.WebGLBlendModeManager.prototype.destroy=function(){this.gl=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class WebGLMaskManager
* @constructor
* @private
*/PIXI.WebGLMaskManager=function(){};PIXI.WebGLMaskManager.prototype.constructor=PIXI.WebGLMaskManager;/**
* Sets the drawing context to the one given in parameter.
* 
* @method setContext 
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLMaskManager.prototype.setContext=function(gl){this.gl=gl;};/**
* Applies the Mask and adds it to the current filter stack.
* 
* @method pushMask
* @param maskData {Array}
* @param renderSession {Object}
*/PIXI.WebGLMaskManager.prototype.pushMask=function(maskData,renderSession){var gl=renderSession.gl;if(maskData.dirty){PIXI.WebGLGraphics.updateGraphics(maskData,gl);}if(!maskData._webGL[gl.id].data.length)return;renderSession.stencilManager.pushStencil(maskData,maskData._webGL[gl.id].data[0],renderSession);};/**
* Removes the last filter from the filter stack and doesn't return it.
* 
* @method popMask
* @param maskData {Array}
* @param renderSession {Object} an object containing all the useful parameters
*/PIXI.WebGLMaskManager.prototype.popMask=function(maskData,renderSession){var gl=this.gl;renderSession.stencilManager.popStencil(maskData,maskData._webGL[gl.id].data[0],renderSession);};/**
* Destroys the mask stack.
* 
* @method destroy
*/PIXI.WebGLMaskManager.prototype.destroy=function(){this.gl=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class WebGLStencilManager
* @constructor
* @private
*/PIXI.WebGLStencilManager=function(){this.stencilStack=[];this.reverse=true;this.count=0;};/**
* Sets the drawing context to the one given in parameter.
* 
* @method setContext 
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLStencilManager.prototype.setContext=function(gl){this.gl=gl;};/**
* Applies the Mask and adds it to the current filter stack.
* 
* @method pushMask
* @param graphics {Graphics}
* @param webGLData {Array}
* @param renderSession {Object}
*/PIXI.WebGLStencilManager.prototype.pushStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.bindGraphics(graphics,webGLData,renderSession);if(this.stencilStack.length===0){gl.enable(gl.STENCIL_TEST);gl.clear(gl.STENCIL_BUFFER_BIT);this.reverse=true;this.count=0;}this.stencilStack.push(webGLData);var level=this.count;gl.colorMask(false,false,false,false);gl.stencilFunc(gl.ALWAYS,0,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);// draw the triangle strip!
if(webGLData.mode===1){gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-level,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR);}else{gl.stencilFunc(gl.EQUAL,level,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR);}// draw a quad to increment..
gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);if(this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-(level+1),0xFF);}else{gl.stencilFunc(gl.EQUAL,level+1,0xFF);}this.reverse=!this.reverse;}else{if(!this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-level,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR);}else{gl.stencilFunc(gl.EQUAL,level,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR);}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-(level+1),0xFF);}else{gl.stencilFunc(gl.EQUAL,level+1,0xFF);}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);this.count++;};/**
 * TODO this does not belong here!
 * 
 * @method bindGraphics
 * @param graphics {Graphics}
 * @param webGLData {Array}
 * @param renderSession {Object}
 */PIXI.WebGLStencilManager.prototype.bindGraphics=function(graphics,webGLData,renderSession){//if(this._currentGraphics === graphics)return;
this._currentGraphics=graphics;var gl=this.gl;// bind the graphics object..
var projection=renderSession.projection,offset=renderSession.offset,shader;// = renderSession.shaderManager.primitiveShader;
if(webGLData.mode===1){shader=renderSession.shaderManager.complexPrimitiveShader;renderSession.shaderManager.setShader(shader);gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform3fv(shader.color,webGLData.color);gl.uniform1f(shader.alpha,graphics.worldAlpha*webGLData.alpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*2,0);// now do the rest..
// set the index buffer!
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer);}else{//renderSession.shaderManager.activatePrimitiveShader();
shader=renderSession.shaderManager.primitiveShader;renderSession.shaderManager.setShader(shader);gl.uniformMatrix3fv(shader.translationMatrix,false,graphics.worldTransform.toArray(true));gl.uniform1f(shader.flipY,renderSession.flipY);gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform3fv(shader.tintColor,PIXI.hex2rgb(graphics.tint));gl.uniform1f(shader.alpha,graphics.worldAlpha);gl.bindBuffer(gl.ARRAY_BUFFER,webGLData.buffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,4*6,0);gl.vertexAttribPointer(shader.colorAttribute,4,gl.FLOAT,false,4*6,2*4);// set the index buffer!
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,webGLData.indexBuffer);}};/**
 * @method popStencil
 * @param graphics {Graphics}
 * @param webGLData {Array}
 * @param renderSession {Object}
 */PIXI.WebGLStencilManager.prototype.popStencil=function(graphics,webGLData,renderSession){var gl=this.gl;this.stencilStack.pop();this.count--;if(this.stencilStack.length===0){// the stack is empty!
gl.disable(gl.STENCIL_TEST);}else{var level=this.count;this.bindGraphics(graphics,webGLData,renderSession);gl.colorMask(false,false,false,false);if(webGLData.mode===1){this.reverse=!this.reverse;if(this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-(level+1),0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR);}else{gl.stencilFunc(gl.EQUAL,level+1,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR);}// draw a quad to increment..
gl.drawElements(gl.TRIANGLE_FAN,4,gl.UNSIGNED_SHORT,(webGLData.indices.length-4)*2);gl.stencilFunc(gl.ALWAYS,0,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INVERT);// draw the triangle strip!
gl.drawElements(gl.TRIANGLE_FAN,webGLData.indices.length-4,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-level,0xFF);}else{gl.stencilFunc(gl.EQUAL,level,0xFF);}}else{//  console.log("<<>>")
if(!this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-(level+1),0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.INCR);}else{gl.stencilFunc(gl.EQUAL,level+1,0xFF);gl.stencilOp(gl.KEEP,gl.KEEP,gl.DECR);}gl.drawElements(gl.TRIANGLE_STRIP,webGLData.indices.length,gl.UNSIGNED_SHORT,0);if(!this.reverse){gl.stencilFunc(gl.EQUAL,0xFF-level,0xFF);}else{gl.stencilFunc(gl.EQUAL,level,0xFF);}}gl.colorMask(true,true,true,true);gl.stencilOp(gl.KEEP,gl.KEEP,gl.KEEP);}};/**
* Destroys the mask stack.
* 
* @method destroy
*/PIXI.WebGLStencilManager.prototype.destroy=function(){this.stencilStack=null;this.gl=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class WebGLShaderManager
* @constructor
* @private
*/PIXI.WebGLShaderManager=function(){/**
     * @property maxAttibs
     * @type Number
     */this.maxAttibs=10;/**
     * @property attribState
     * @type Array
     */this.attribState=[];/**
     * @property tempAttribState
     * @type Array
     */this.tempAttribState=[];for(var i=0;i<this.maxAttibs;i++){this.attribState[i]=false;}/**
     * @property stack
     * @type Array
     */this.stack=[];};PIXI.WebGLShaderManager.prototype.constructor=PIXI.WebGLShaderManager;/**
* Initialises the context and the properties.
* 
* @method setContext 
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLShaderManager.prototype.setContext=function(gl){this.gl=gl;// the next one is used for rendering primitives
this.primitiveShader=new PIXI.PrimitiveShader(gl);// the next one is used for rendering triangle strips
this.complexPrimitiveShader=new PIXI.ComplexPrimitiveShader(gl);// this shader is used for the default sprite rendering
this.defaultShader=new PIXI.PixiShader(gl);// this shader is used for the fast sprite rendering
this.fastShader=new PIXI.PixiFastShader(gl);// the next one is used for rendering triangle strips
this.stripShader=new PIXI.StripShader(gl);this.setShader(this.defaultShader);};/**
* Takes the attributes given in parameters.
* 
* @method setAttribs
* @param attribs {Array} attribs 
*/PIXI.WebGLShaderManager.prototype.setAttribs=function(attribs){// reset temp state
var i;for(i=0;i<this.tempAttribState.length;i++){this.tempAttribState[i]=false;}// set the new attribs
for(i=0;i<attribs.length;i++){var attribId=attribs[i];this.tempAttribState[attribId]=true;}var gl=this.gl;for(i=0;i<this.attribState.length;i++){if(this.attribState[i]!==this.tempAttribState[i]){this.attribState[i]=this.tempAttribState[i];if(this.tempAttribState[i]){gl.enableVertexAttribArray(i);}else{gl.disableVertexAttribArray(i);}}}};/**
* Sets the current shader.
* 
* @method setShader
* @param shader {Any}
*/PIXI.WebGLShaderManager.prototype.setShader=function(shader){if(this._currentId===shader._UID)return false;this._currentId=shader._UID;this.currentShader=shader;this.gl.useProgram(shader.program);this.setAttribs(shader.attributes);return true;};/**
* Destroys this object.
* 
* @method destroy
*/PIXI.WebGLShaderManager.prototype.destroy=function(){this.attribState=null;this.tempAttribState=null;this.primitiveShader.destroy();this.complexPrimitiveShader.destroy();this.defaultShader.destroy();this.fastShader.destroy();this.stripShader.destroy();this.gl=null;};/**
 * @author Mat Groves
 * 
 * Big thanks to the very clever Matt DesLauriers <mattdesl> https://github.com/mattdesl/
 * for creating the original pixi version!
 * Also a thanks to https://github.com/bchevalier for tweaking the tint and alpha so that they now share 4 bytes on the vertex buffer
 * 
 * Heavily inspired by LibGDX's WebGLSpriteBatch:
 * https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g2d/WebGLSpriteBatch.java
 */ /**
 *
 * @class WebGLSpriteBatch
 * @private
 * @constructor
 */PIXI.WebGLSpriteBatch=function(){/**
     * @property vertSize
     * @type Number
     */this.vertSize=5;/**
     * The number of images in the SpriteBatch before it flushes
     * @property size
     * @type Number
     */this.size=2000;//Math.pow(2, 16) /  this.vertSize;
//the total number of bytes in our batch
var numVerts=this.size*4*4*this.vertSize;//the total number of indices in our batch
var numIndices=this.size*6;/**
    * Holds the vertices
    *
    * @property vertices
    * @type ArrayBuffer
    */this.vertices=new PIXI.ArrayBuffer(numVerts);/**
    * View on the vertices as a Float32Array
    *
    * @property positions
    * @type Float32Array
    */this.positions=new PIXI.Float32Array(this.vertices);/**
    * View on the vertices as a Uint32Array
    *
    * @property colors
    * @type Uint32Array
    */this.colors=new PIXI.Uint32Array(this.vertices);/**
     * Holds the indices
     *
     * @property indices
     * @type Uint16Array
     */this.indices=new PIXI.Uint16Array(numIndices);/**
     * @property lastIndexCount
     * @type Number
     */this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3;}/**
     * @property drawing
     * @type Boolean
     */this.drawing=false;/**
     * @property currentBatchSize
     * @type Number
     */this.currentBatchSize=0;/**
     * @property currentBaseTexture
     * @type BaseTexture
     */this.currentBaseTexture=null;/**
     * @property dirty
     * @type Boolean
     */this.dirty=true;/**
     * @property textures
     * @type Array
     */this.textures=[];/**
     * @property blendModes
     * @type Array
     */this.blendModes=[];/**
     * @property shaders
     * @type Array
     */this.shaders=[];/**
     * @property sprites
     * @type Array
     */this.sprites=[];/**
     * @property defaultShader
     * @type AbstractFilter
     */this.defaultShader=new PIXI.AbstractFilter(['precision lowp float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor ;','}']);};/**
* @method setContext
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLSpriteBatch.prototype.setContext=function(gl){this.gl=gl;// create a couple of buffers
this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();// 65535 is max index, so 65535 / 6 = 10922.
//upload the index data
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);this.currentBlendMode=99999;var shader=new PIXI.PixiShader(gl);shader.fragmentSrc=this.defaultShader.fragmentSrc;shader.uniforms={};shader.init();this.defaultShader.shaders[gl.id]=shader;};/**
* @method begin
* @param renderSession {Object} The RenderSession object
*/PIXI.WebGLSpriteBatch.prototype.begin=function(renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.defaultShader;this.start();};/**
* @method end
*/PIXI.WebGLSpriteBatch.prototype.end=function(){this.flush();};/**
* @method render
* @param sprite {Sprite} the sprite to render when using this spritebatch
*/PIXI.WebGLSpriteBatch.prototype.render=function(sprite){var texture=sprite.texture;//TODO set blend modes.. 
// check texture..
if(this.currentBatchSize>=this.size){this.flush();this.currentBaseTexture=texture.baseTexture;}// get the uvs for the texture
var uvs=texture._uvs;// if the uvs have not updated then no point rendering just yet!
if(!uvs)return;// TODO trim??
var aX=sprite.anchor.x;var aY=sprite.anchor.y;var w0,w1,h0,h1;if(texture.trim){// if the sprite is trimmed then we need to add the extra space before transforming the sprite coords..
var trim=texture.trim;w1=trim.x-aX*trim.width;w0=w1+texture.crop.width;h1=trim.y-aY*trim.height;h0=h1+texture.crop.height;}else{w0=texture.frame.width*(1-aX);w1=texture.frame.width*-aX;h0=texture.frame.height*(1-aY);h1=texture.frame.height*-aY;}var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=sprite.worldTransform;var a=worldTransform.a/resolution;var b=worldTransform.b/resolution;var c=worldTransform.c/resolution;var d=worldTransform.d/resolution;var tx=worldTransform.tx;var ty=worldTransform.ty;var colors=this.colors;var positions=this.positions;if(this.renderSession.roundPixels){// xy
positions[index]=a*w1+c*h1+tx|0;positions[index+1]=d*h1+b*w1+ty|0;// xy
positions[index+5]=a*w0+c*h1+tx|0;positions[index+6]=d*h1+b*w0+ty|0;// xy
positions[index+10]=a*w0+c*h0+tx|0;positions[index+11]=d*h0+b*w0+ty|0;// xy
positions[index+15]=a*w1+c*h0+tx|0;positions[index+16]=d*h0+b*w1+ty|0;}else{// xy
positions[index]=a*w1+c*h1+tx;positions[index+1]=d*h1+b*w1+ty;// xy
positions[index+5]=a*w0+c*h1+tx;positions[index+6]=d*h1+b*w0+ty;// xy
positions[index+10]=a*w0+c*h0+tx;positions[index+11]=d*h0+b*w0+ty;// xy
positions[index+15]=a*w1+c*h0+tx;positions[index+16]=d*h0+b*w1+ty;}// uv
positions[index+2]=uvs.x0;positions[index+3]=uvs.y0;// uv
positions[index+7]=uvs.x1;positions[index+8]=uvs.y1;// uv
positions[index+12]=uvs.x2;positions[index+13]=uvs.y2;// uv
positions[index+17]=uvs.x3;positions[index+18]=uvs.y3;// color and alpha
var tint=sprite.tint;colors[index+4]=colors[index+9]=colors[index+14]=colors[index+19]=(tint>>16)+(tint&0xff00)+((tint&0xff)<<16)+(sprite.worldAlpha*255<<24);// increment the batchsize
this.sprites[this.currentBatchSize++]=sprite;};/**
* Renders a TilingSprite using the spriteBatch.
* 
* @method renderTilingSprite
* @param sprite {TilingSprite} the tilingSprite to render
*/PIXI.WebGLSpriteBatch.prototype.renderTilingSprite=function(tilingSprite){var texture=tilingSprite.tilingTexture;// check texture..
if(this.currentBatchSize>=this.size){//return;
this.flush();this.currentBaseTexture=texture.baseTexture;}// set the textures uvs temporarily
// TODO create a separate texture so that we can tile part of a texture
if(!tilingSprite._uvs)tilingSprite._uvs=new PIXI.TextureUvs();var uvs=tilingSprite._uvs;tilingSprite.tilePosition.x%=texture.baseTexture.width*tilingSprite.tileScaleOffset.x;tilingSprite.tilePosition.y%=texture.baseTexture.height*tilingSprite.tileScaleOffset.y;var offsetX=tilingSprite.tilePosition.x/(texture.baseTexture.width*tilingSprite.tileScaleOffset.x);var offsetY=tilingSprite.tilePosition.y/(texture.baseTexture.height*tilingSprite.tileScaleOffset.y);var scaleX=tilingSprite.width/texture.baseTexture.width/(tilingSprite.tileScale.x*tilingSprite.tileScaleOffset.x);var scaleY=tilingSprite.height/texture.baseTexture.height/(tilingSprite.tileScale.y*tilingSprite.tileScaleOffset.y);uvs.x0=0-offsetX;uvs.y0=0-offsetY;uvs.x1=1*scaleX-offsetX;uvs.y1=0-offsetY;uvs.x2=1*scaleX-offsetX;uvs.y2=1*scaleY-offsetY;uvs.x3=0-offsetX;uvs.y3=1*scaleY-offsetY;// get the tilingSprites current alpha and tint and combining them into a single color
var tint=tilingSprite.tint;var color=(tint>>16)+(tint&0xff00)+((tint&0xff)<<16)+(tilingSprite.alpha*255<<24);var positions=this.positions;var colors=this.colors;var width=tilingSprite.width;var height=tilingSprite.height;// TODO trim??
var aX=tilingSprite.anchor.x;var aY=tilingSprite.anchor.y;var w0=width*(1-aX);var w1=width*-aX;var h0=height*(1-aY);var h1=height*-aY;var index=this.currentBatchSize*4*this.vertSize;var resolution=texture.baseTexture.resolution;var worldTransform=tilingSprite.worldTransform;var a=worldTransform.a/resolution;//[0];
var b=worldTransform.b/resolution;//[3];
var c=worldTransform.c/resolution;//[1];
var d=worldTransform.d/resolution;//[4];
var tx=worldTransform.tx;//[2];
var ty=worldTransform.ty;//[5];
// xy
positions[index++]=a*w1+c*h1+tx;positions[index++]=d*h1+b*w1+ty;// uv
positions[index++]=uvs.x0;positions[index++]=uvs.y0;// color
colors[index++]=color;// xy
positions[index++]=a*w0+c*h1+tx;positions[index++]=d*h1+b*w0+ty;// uv
positions[index++]=uvs.x1;positions[index++]=uvs.y1;// color
colors[index++]=color;// xy
positions[index++]=a*w0+c*h0+tx;positions[index++]=d*h0+b*w0+ty;// uv
positions[index++]=uvs.x2;positions[index++]=uvs.y2;// color
colors[index++]=color;// xy
positions[index++]=a*w1+c*h0+tx;positions[index++]=d*h0+b*w1+ty;// uv
positions[index++]=uvs.x3;positions[index++]=uvs.y3;// color
colors[index++]=color;// increment the batchsize
this.sprites[this.currentBatchSize++]=tilingSprite;};/**
* Renders the content and empties the current batch.
*
* @method flush
*/PIXI.WebGLSpriteBatch.prototype.flush=function(){// If the batch is length 0 then return as there is nothing to draw
if(this.currentBatchSize===0)return;var gl=this.gl;var shader;if(this.dirty){this.dirty=false;// bind the main texture
gl.activeTexture(gl.TEXTURE0);// bind the buffers
gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);shader=this.defaultShader.shaders[gl.id];// this is the same for each shader?
var stride=this.vertSize*4;gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,stride,2*4);// color attributes will be interpreted as unsigned bytes and normalized
gl.vertexAttribPointer(shader.colorAttribute,4,gl.UNSIGNED_BYTE,true,stride,4*4);}// upload the verts to the buffer  
if(this.currentBatchSize>this.size*0.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices);}else{var view=this.positions.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view);}var nextTexture,nextBlendMode,nextShader;var batchSize=0;var start=0;var currentBaseTexture=null;var currentBlendMode=this.renderSession.blendModeManager.currentBlendMode;var currentShader=null;var blendSwap=false;var shaderSwap=false;var sprite;for(var i=0,j=this.currentBatchSize;i<j;i++){sprite=this.sprites[i];nextTexture=sprite.texture.baseTexture;nextBlendMode=sprite.blendMode;nextShader=sprite.shader||this.defaultShader;blendSwap=currentBlendMode!==nextBlendMode;shaderSwap=currentShader!==nextShader;// should I use _UIDS???
if(currentBaseTexture!==nextTexture||blendSwap||shaderSwap){this.renderBatch(currentBaseTexture,batchSize,start);start=i;batchSize=0;currentBaseTexture=nextTexture;if(blendSwap){currentBlendMode=nextBlendMode;this.renderSession.blendModeManager.setBlendMode(currentBlendMode);}if(shaderSwap){currentShader=nextShader;shader=currentShader.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=currentShader.fragmentSrc;shader.uniforms=currentShader.uniforms;shader.init();currentShader.shaders[gl.id]=shader;}// set shader function???
this.renderSession.shaderManager.setShader(shader);if(shader.dirty)shader.syncUniforms();// both thease only need to be set if they are changing..
// set the projection
var projection=this.renderSession.projection;gl.uniform2f(shader.projectionVector,projection.x,projection.y);// TODO - this is temprorary!
var offsetVector=this.renderSession.offset;gl.uniform2f(shader.offsetVector,offsetVector.x,offsetVector.y);// set the pointers
}}batchSize++;}this.renderBatch(currentBaseTexture,batchSize,start);// then reset the batch!
this.currentBatchSize=0;};/**
* @method renderBatch
* @param texture {Texture}
* @param size {Number}
* @param startIndex {Number}
*/PIXI.WebGLSpriteBatch.prototype.renderBatch=function(texture,size,startIndex){if(size===0)return;var gl=this.gl;// check if a texture is dirty..
//if(texture._dirty[gl.id])
//{
//    this.renderSession.renderer.updateTexture(texture);
//}
//else
//{
//    // bind the current texture
//    gl.bindTexture(gl.TEXTURE_2D, texture._glTextures[gl.id]);
//}
// Modificato da Matteo
if(gl.id>=texture._dirty.length||texture._dirty[gl.id]){this.renderSession.renderer.updateTexture(texture);}else{// bind the current texture
gl.bindTexture(gl.TEXTURE_2D,texture._glTextures[gl.id]);}// now draw those suckas!
gl.drawElements(gl.TRIANGLES,size*6,gl.UNSIGNED_SHORT,startIndex*6*2);// increment the draw count
this.renderSession.drawCount++;};/**
* @method stop
*/PIXI.WebGLSpriteBatch.prototype.stop=function(){this.flush();this.dirty=true;};/**
* @method start
*/PIXI.WebGLSpriteBatch.prototype.start=function(){this.dirty=true;};/**
* Destroys the SpriteBatch.
* 
* @method destroy
*/PIXI.WebGLSpriteBatch.prototype.destroy=function(){this.vertices=null;this.indices=null;this.gl.deleteBuffer(this.vertexBuffer);this.gl.deleteBuffer(this.indexBuffer);this.currentBaseTexture=null;this.gl=null;};/**
 * @author Mat Groves
 * 
 * Big thanks to the very clever Matt DesLauriers <mattdesl> https://github.com/mattdesl/
 * for creating the original pixi version!
 *
 * Heavily inspired by LibGDX's WebGLSpriteBatch:
 * https://github.com/libgdx/libgdx/blob/master/gdx/src/com/badlogic/gdx/graphics/g2d/WebGLSpriteBatch.java
 */ /**
* @class WebGLFastSpriteBatch
* @constructor
*/PIXI.WebGLFastSpriteBatch=function(gl){/**
     * @property vertSize
     * @type Number
     */this.vertSize=10;/**
     * @property maxSize
     * @type Number
     */this.maxSize=6000;//Math.pow(2, 16) /  this.vertSize;
/**
     * @property size
     * @type Number
     */this.size=this.maxSize;//the total number of floats in our batch
var numVerts=this.size*4*this.vertSize;//the total number of indices in our batch
var numIndices=this.maxSize*6;/**
     * Vertex data
     * @property vertices
     * @type Float32Array
     */this.vertices=new PIXI.Float32Array(numVerts);/**
     * Index data
     * @property indices
     * @type Uint16Array
     */this.indices=new PIXI.Uint16Array(numIndices);/**
     * @property vertexBuffer
     * @type Object
     */this.vertexBuffer=null;/**
     * @property indexBuffer
     * @type Object
     */this.indexBuffer=null;/**
     * @property lastIndexCount
     * @type Number
     */this.lastIndexCount=0;for(var i=0,j=0;i<numIndices;i+=6,j+=4){this.indices[i+0]=j+0;this.indices[i+1]=j+1;this.indices[i+2]=j+2;this.indices[i+3]=j+0;this.indices[i+4]=j+2;this.indices[i+5]=j+3;}/**
     * @property drawing
     * @type Boolean
     */this.drawing=false;/**
     * @property currentBatchSize
     * @type Number
     */this.currentBatchSize=0;/**
     * @property currentBaseTexture
     * @type BaseTexture
     */this.currentBaseTexture=null;/**
     * @property currentBlendMode
     * @type Number
     */this.currentBlendMode=0;/**
     * @property renderSession
     * @type Object
     */this.renderSession=null;/**
     * @property shader
     * @type Object
     */this.shader=null;/**
     * @property matrix
     * @type Matrix
     */this.matrix=null;this.setContext(gl);};PIXI.WebGLFastSpriteBatch.prototype.constructor=PIXI.WebGLFastSpriteBatch;/**
 * Sets the WebGL Context.
 *
 * @method setContext
 * @param gl {WebGLContext} the current WebGL drawing context
 */PIXI.WebGLFastSpriteBatch.prototype.setContext=function(gl){this.gl=gl;// create a couple of buffers
this.vertexBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();// 65535 is max index, so 65535 / 6 = 10922.
//upload the index data
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);};/**
 * @method begin
 * @param spriteBatch {WebGLSpriteBatch}
 * @param renderSession {Object}
 */PIXI.WebGLFastSpriteBatch.prototype.begin=function(spriteBatch,renderSession){this.renderSession=renderSession;this.shader=this.renderSession.shaderManager.fastShader;this.matrix=spriteBatch.worldTransform.toArray(true);this.start();};/**
 * @method end
 */PIXI.WebGLFastSpriteBatch.prototype.end=function(){this.flush();};/**
 * @method render
 * @param spriteBatch {WebGLSpriteBatch}
 */PIXI.WebGLFastSpriteBatch.prototype.render=function(spriteBatch){var children=spriteBatch.children;var sprite=children[0];// if the uvs have not updated then no point rendering just yet!
// check texture.
if(!sprite.texture._uvs)return;this.currentBaseTexture=sprite.texture.baseTexture;// check blend mode
if(sprite.blendMode!==this.renderSession.blendModeManager.currentBlendMode){this.flush();this.renderSession.blendModeManager.setBlendMode(sprite.blendMode);}for(var i=0,j=children.length;i<j;i++){this.renderSprite(children[i]);}this.flush();};/**
 * @method renderSprite
 * @param sprite {Sprite}
 */PIXI.WebGLFastSpriteBatch.prototype.renderSprite=function(sprite){//sprite = children[i];
if(!sprite.visible)return;// TODO trim??
if(sprite.texture.baseTexture!==this.currentBaseTexture){this.flush();this.currentBaseTexture=sprite.texture.baseTexture;if(!sprite.texture._uvs)return;}var uvs,vertices=this.vertices,width,height,w0,w1,h0,h1,index;uvs=sprite.texture._uvs;width=sprite.texture.frame.width;height=sprite.texture.frame.height;if(sprite.texture.trim){// if the sprite is trimmed then we need to add the extra space before transforming the sprite coords..
var trim=sprite.texture.trim;w1=trim.x-sprite.anchor.x*trim.width;w0=w1+sprite.texture.crop.width;h1=trim.y-sprite.anchor.y*trim.height;h0=h1+sprite.texture.crop.height;}else{w0=sprite.texture.frame.width*(1-sprite.anchor.x);w1=sprite.texture.frame.width*-sprite.anchor.x;h0=sprite.texture.frame.height*(1-sprite.anchor.y);h1=sprite.texture.frame.height*-sprite.anchor.y;}index=this.currentBatchSize*4*this.vertSize;// xy
vertices[index++]=w1;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;//scale
vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;//rotation
vertices[index++]=sprite.rotation;// uv
vertices[index++]=uvs.x0;vertices[index++]=uvs.y1;// color
vertices[index++]=sprite.alpha;// xy
vertices[index++]=w0;vertices[index++]=h1;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;//scale
vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;//rotation
vertices[index++]=sprite.rotation;// uv
vertices[index++]=uvs.x1;vertices[index++]=uvs.y1;// color
vertices[index++]=sprite.alpha;// xy
vertices[index++]=w0;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;//scale
vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;//rotation
vertices[index++]=sprite.rotation;// uv
vertices[index++]=uvs.x2;vertices[index++]=uvs.y2;// color
vertices[index++]=sprite.alpha;// xy
vertices[index++]=w1;vertices[index++]=h0;vertices[index++]=sprite.position.x;vertices[index++]=sprite.position.y;//scale
vertices[index++]=sprite.scale.x;vertices[index++]=sprite.scale.y;//rotation
vertices[index++]=sprite.rotation;// uv
vertices[index++]=uvs.x3;vertices[index++]=uvs.y3;// color
vertices[index++]=sprite.alpha;// increment the batchs
this.currentBatchSize++;if(this.currentBatchSize>=this.size){this.flush();}};/**
 * @method flush
 */PIXI.WebGLFastSpriteBatch.prototype.flush=function(){// If the batch is length 0 then return as there is nothing to draw
if(this.currentBatchSize===0)return;var gl=this.gl;// bind the current texture
if(!this.currentBaseTexture._glTextures[gl.id])this.renderSession.renderer.updateTexture(this.currentBaseTexture,gl);gl.bindTexture(gl.TEXTURE_2D,this.currentBaseTexture._glTextures[gl.id]);// upload the verts to the buffer
if(this.currentBatchSize>this.size*0.5){gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices);}else{var view=this.vertices.subarray(0,this.currentBatchSize*4*this.vertSize);gl.bufferSubData(gl.ARRAY_BUFFER,0,view);}// now draw those suckas!
gl.drawElements(gl.TRIANGLES,this.currentBatchSize*6,gl.UNSIGNED_SHORT,0);// then reset the batch!
this.currentBatchSize=0;// increment the draw count
this.renderSession.drawCount++;};/**
 * @method stop
 */PIXI.WebGLFastSpriteBatch.prototype.stop=function(){this.flush();};/**
 * @method start
 */PIXI.WebGLFastSpriteBatch.prototype.start=function(){var gl=this.gl;// bind the main texture
gl.activeTexture(gl.TEXTURE0);// bind the buffers
gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);// set the projection
var projection=this.renderSession.projection;gl.uniform2f(this.shader.projectionVector,projection.x,projection.y);// set the matrix
gl.uniformMatrix3fv(this.shader.uMatrix,false,this.matrix);// set the pointers
var stride=this.vertSize*4;gl.vertexAttribPointer(this.shader.aVertexPosition,2,gl.FLOAT,false,stride,0);gl.vertexAttribPointer(this.shader.aPositionCoord,2,gl.FLOAT,false,stride,2*4);gl.vertexAttribPointer(this.shader.aScale,2,gl.FLOAT,false,stride,4*4);gl.vertexAttribPointer(this.shader.aRotation,1,gl.FLOAT,false,stride,6*4);gl.vertexAttribPointer(this.shader.aTextureCoord,2,gl.FLOAT,false,stride,7*4);gl.vertexAttribPointer(this.shader.colorAttribute,1,gl.FLOAT,false,stride,9*4);};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class WebGLFilterManager
* @constructor
*/PIXI.WebGLFilterManager=function(){/**
     * @property filterStack
     * @type Array
     */this.filterStack=[];/**
     * @property offsetX
     * @type Number
     */this.offsetX=0;/**
     * @property offsetY
     * @type Number
     */this.offsetY=0;};PIXI.WebGLFilterManager.prototype.constructor=PIXI.WebGLFilterManager;/**
* Initialises the context and the properties.
* 
* @method setContext 
* @param gl {WebGLContext} the current WebGL drawing context
*/PIXI.WebGLFilterManager.prototype.setContext=function(gl){this.gl=gl;this.texturePool=[];this.initShaderBuffers();};/**
* @method begin
* @param renderSession {RenderSession} 
* @param buffer {ArrayBuffer} 
*/PIXI.WebGLFilterManager.prototype.begin=function(renderSession,buffer){this.renderSession=renderSession;this.defaultShader=renderSession.shaderManager.defaultShader;var projection=this.renderSession.projection;this.width=projection.x*2;this.height=-projection.y*2;this.buffer=buffer;};/**
* Applies the filter and adds it to the current filter stack.
* 
* @method pushFilter
* @param filterBlock {Object} the filter that will be pushed to the current filter stack
*/PIXI.WebGLFilterManager.prototype.pushFilter=function(filterBlock){var gl=this.gl;var projection=this.renderSession.projection;var offset=this.renderSession.offset;filterBlock._filterArea=filterBlock.target.filterArea||filterBlock.target.getBounds();// filter program
// OPTIMISATION - the first filter is free if its a simple color change?
this.filterStack.push(filterBlock);var filter=filterBlock.filterPasses[0];this.offsetX+=filterBlock._filterArea.x;this.offsetY+=filterBlock._filterArea.y;var texture=this.texturePool.pop();if(!texture){texture=new PIXI.FilterTexture(this.gl,this.width,this.height);}else{texture.resize(this.width,this.height);}gl.bindTexture(gl.TEXTURE_2D,texture.texture);var filterArea=filterBlock._filterArea;// filterBlock.target.getBounds();///filterBlock.target.filterArea;
var padding=filter.padding;filterArea.x-=padding;filterArea.y-=padding;filterArea.width+=padding*2;filterArea.height+=padding*2;// cap filter to screen size..
if(filterArea.x<0)filterArea.x=0;if(filterArea.width>this.width)filterArea.width=this.width;if(filterArea.y<0)filterArea.y=0;if(filterArea.height>this.height)filterArea.height=this.height;//gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA,  filterArea.width, filterArea.height, 0, gl.RGBA, gl.UNSIGNED_BYTE, null);
gl.bindFramebuffer(gl.FRAMEBUFFER,texture.frameBuffer);// set view port
gl.viewport(0,0,filterArea.width,filterArea.height);projection.x=filterArea.width/2;projection.y=-filterArea.height/2;offset.x=-filterArea.x;offset.y=-filterArea.y;// update projection
// now restore the regular shader..
// this.renderSession.shaderManager.setShader(this.defaultShader);
//gl.uniform2f(this.defaultShader.projectionVector, filterArea.width/2, -filterArea.height/2);
//gl.uniform2f(this.defaultShader.offsetVector, -filterArea.x, -filterArea.y);
gl.colorMask(true,true,true,true);gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);filterBlock._glFilterTexture=texture;};/**
* Removes the last filter from the filter stack and doesn't return it.
* 
* @method popFilter
*/PIXI.WebGLFilterManager.prototype.popFilter=function(){var gl=this.gl;var filterBlock=this.filterStack.pop();var filterArea=filterBlock._filterArea;var texture=filterBlock._glFilterTexture;var projection=this.renderSession.projection;var offset=this.renderSession.offset;if(filterBlock.filterPasses.length>1){gl.viewport(0,0,filterArea.width,filterArea.height);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=0;this.vertexArray[1]=filterArea.height;this.vertexArray[2]=filterArea.width;this.vertexArray[3]=filterArea.height;this.vertexArray[4]=0;this.vertexArray[5]=0;this.vertexArray[6]=filterArea.width;this.vertexArray[7]=0;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);// now set the uvs..
this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);var inputTexture=texture;var outputTexture=this.texturePool.pop();if(!outputTexture)outputTexture=new PIXI.FilterTexture(this.gl,this.width,this.height);outputTexture.resize(this.width,this.height);// need to clear this FBO as it may have some left over elements from a previous filter.
gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);gl.clear(gl.COLOR_BUFFER_BIT);gl.disable(gl.BLEND);for(var i=0;i<filterBlock.filterPasses.length-1;i++){var filterPass=filterBlock.filterPasses[i];gl.bindFramebuffer(gl.FRAMEBUFFER,outputTexture.frameBuffer);// set texture
gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,inputTexture.texture);// draw texture..
//filterPass.applyFilterPass(filterArea.width, filterArea.height);
this.applyFilterPass(filterPass,filterArea,filterArea.width,filterArea.height);// swap the textures..
var temp=inputTexture;inputTexture=outputTexture;outputTexture=temp;}gl.enable(gl.BLEND);texture=inputTexture;this.texturePool.push(outputTexture);}var filter=filterBlock.filterPasses[filterBlock.filterPasses.length-1];this.offsetX-=filterArea.x;this.offsetY-=filterArea.y;var sizeX=this.width;var sizeY=this.height;var offsetX=0;var offsetY=0;var buffer=this.buffer;// time to render the filters texture to the previous scene
if(this.filterStack.length===0){gl.colorMask(true,true,true,true);//this.transparent);
}else{var currentFilter=this.filterStack[this.filterStack.length-1];filterArea=currentFilter._filterArea;sizeX=filterArea.width;sizeY=filterArea.height;offsetX=filterArea.x;offsetY=filterArea.y;buffer=currentFilter._glFilterTexture.frameBuffer;}// TODO need to remove these global elements..
projection.x=sizeX/2;projection.y=-sizeY/2;offset.x=offsetX;offset.y=offsetY;filterArea=filterBlock._filterArea;var x=filterArea.x-offsetX;var y=filterArea.y-offsetY;// update the buffers..
// make sure to flip the y!
gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);this.vertexArray[0]=x;this.vertexArray[1]=y+filterArea.height;this.vertexArray[2]=x+filterArea.width;this.vertexArray[3]=y+filterArea.height;this.vertexArray[4]=x;this.vertexArray[5]=y;this.vertexArray[6]=x+filterArea.width;this.vertexArray[7]=y;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertexArray);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);this.uvArray[2]=filterArea.width/this.width;this.uvArray[5]=filterArea.height/this.height;this.uvArray[6]=filterArea.width/this.width;this.uvArray[7]=filterArea.height/this.height;gl.bufferSubData(gl.ARRAY_BUFFER,0,this.uvArray);gl.viewport(0,0,sizeX*this.renderSession.resolution,sizeY*this.renderSession.resolution);// bind the buffer
gl.bindFramebuffer(gl.FRAMEBUFFER,buffer);// set the blend mode! 
//gl.blendFunc(gl.ONE, gl.ONE_MINUS_SRC_ALPHA)
// set texture
gl.activeTexture(gl.TEXTURE0);gl.bindTexture(gl.TEXTURE_2D,texture.texture);// apply!
this.applyFilterPass(filter,filterArea,sizeX,sizeY);// now restore the regular shader.. should happen automatically now..
// this.renderSession.shaderManager.setShader(this.defaultShader);
// gl.uniform2f(this.defaultShader.projectionVector, sizeX/2, -sizeY/2);
// gl.uniform2f(this.defaultShader.offsetVector, -offsetX, -offsetY);
// return the texture to the pool
this.texturePool.push(texture);filterBlock._glFilterTexture=null;};/**
* Applies the filter to the specified area.
* 
* @method applyFilterPass
* @param filter {AbstractFilter} the filter that needs to be applied
* @param filterArea {Texture} TODO - might need an update
* @param width {Number} the horizontal range of the filter
* @param height {Number} the vertical range of the filter
*/PIXI.WebGLFilterManager.prototype.applyFilterPass=function(filter,filterArea,width,height){// use program
var gl=this.gl;var shader=filter.shaders[gl.id];if(!shader){shader=new PIXI.PixiShader(gl);shader.fragmentSrc=filter.fragmentSrc;shader.uniforms=filter.uniforms;shader.init();filter.shaders[gl.id]=shader;}// set the shader
this.renderSession.shaderManager.setShader(shader);//    gl.useProgram(shader.program);
gl.uniform2f(shader.projectionVector,width/2,-height/2);gl.uniform2f(shader.offsetVector,0,0);if(filter.uniforms.dimensions){filter.uniforms.dimensions.value[0]=this.width;//width;
filter.uniforms.dimensions.value[1]=this.height;//height;
filter.uniforms.dimensions.value[2]=this.vertexArray[0];filter.uniforms.dimensions.value[3]=this.vertexArray[5];//filterArea.height;
}shader.syncUniforms();gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.vertexAttribPointer(shader.colorAttribute,2,gl.FLOAT,false,0,0);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);// draw the filter...
gl.drawElements(gl.TRIANGLES,6,gl.UNSIGNED_SHORT,0);this.renderSession.drawCount++;};/**
* Initialises the shader buffers.
* 
* @method initShaderBuffers
*/PIXI.WebGLFilterManager.prototype.initShaderBuffers=function(){var gl=this.gl;// create some buffers
this.vertexBuffer=gl.createBuffer();this.uvBuffer=gl.createBuffer();this.colorBuffer=gl.createBuffer();this.indexBuffer=gl.createBuffer();// bind and upload the vertexs..
// keep a reference to the vertexFloatData..
this.vertexArray=new PIXI.Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,1.0,1.0]);gl.bindBuffer(gl.ARRAY_BUFFER,this.vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertexArray,gl.STATIC_DRAW);// bind and upload the uv buffer
this.uvArray=new PIXI.Float32Array([0.0,0.0,1.0,0.0,0.0,1.0,1.0,1.0]);gl.bindBuffer(gl.ARRAY_BUFFER,this.uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvArray,gl.STATIC_DRAW);this.colorArray=new PIXI.Float32Array([1.0,0xFFFFFF,1.0,0xFFFFFF,1.0,0xFFFFFF,1.0,0xFFFFFF]);gl.bindBuffer(gl.ARRAY_BUFFER,this.colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colorArray,gl.STATIC_DRAW);// bind and upload the index
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this.indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,1,3,2]),gl.STATIC_DRAW);};/**
* Destroys the filter and removes it from the filter stack.
* 
* @method destroy
*/PIXI.WebGLFilterManager.prototype.destroy=function(){var gl=this.gl;this.filterStack=null;this.offsetX=0;this.offsetY=0;// destroy textures
for(var i=0;i<this.texturePool.length;i++){this.texturePool[i].destroy();}this.texturePool=null;//destroy buffers..
gl.deleteBuffer(this.vertexBuffer);gl.deleteBuffer(this.uvBuffer);gl.deleteBuffer(this.colorBuffer);gl.deleteBuffer(this.indexBuffer);};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
* @class FilterTexture
* @constructor
* @param gl {WebGLContext} the current WebGL drawing context
* @param width {Number} the horizontal range of the filter
* @param height {Number} the vertical range of the filter
* @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
*/PIXI.FilterTexture=function(gl,width,height,scaleMode){/**
     * @property gl
     * @type WebGLContext
     */this.gl=gl;// next time to create a frame buffer and texture
/**
     * @property frameBuffer
     * @type Any
     */this.frameBuffer=gl.createFramebuffer();/**
     * @property texture
     * @type Any
     */this.texture=gl.createTexture();/**
     * @property scaleMode
     * @type Number
     */scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,scaleMode===PIXI.scaleModes.LINEAR?gl.LINEAR:gl.NEAREST);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.bindFramebuffer(gl.FRAMEBUFFER,this.frameBuffer);gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,this.texture,0);// required for masking a mask??
this.renderBuffer=gl.createRenderbuffer();gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.framebufferRenderbuffer(gl.FRAMEBUFFER,gl.DEPTH_STENCIL_ATTACHMENT,gl.RENDERBUFFER,this.renderBuffer);this.resize(width,height);};PIXI.FilterTexture.prototype.constructor=PIXI.FilterTexture;/**
* Clears the filter texture.
* 
* @method clear
*/PIXI.FilterTexture.prototype.clear=function(){var gl=this.gl;gl.clearColor(0,0,0,0);gl.clear(gl.COLOR_BUFFER_BIT);};/**
 * Resizes the texture to the specified width and height
 *
 * @method resize
 * @param width {Number} the new width of the texture
 * @param height {Number} the new height of the texture
 */PIXI.FilterTexture.prototype.resize=function(width,height){if(this.width===width&&this.height===height)return;this.width=width;this.height=height;var gl=this.gl;gl.bindTexture(gl.TEXTURE_2D,this.texture);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,width,height,0,gl.RGBA,gl.UNSIGNED_BYTE,null);// update the stencil buffer width and height
gl.bindRenderbuffer(gl.RENDERBUFFER,this.renderBuffer);gl.renderbufferStorage(gl.RENDERBUFFER,gl.DEPTH_STENCIL,width,height);};/**
* Destroys the filter texture.
* 
* @method destroy
*/PIXI.FilterTexture.prototype.destroy=function(){var gl=this.gl;gl.deleteFramebuffer(this.frameBuffer);gl.deleteTexture(this.texture);this.frameBuffer=null;this.texture=null;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * Creates a Canvas element of the given size.
 *
 * @class CanvasBuffer
 * @constructor
 * @param width {Number} the width for the newly created canvas
 * @param height {Number} the height for the newly created canvas
 */PIXI.CanvasBuffer=function(width,height){/**
     * The width of the Canvas in pixels.
     *
     * @property width
     * @type Number
     */this.width=width;/**
     * The height of the Canvas in pixels.
     *
     * @property height
     * @type Number
     */this.height=height;/**
     * The Canvas object that belongs to this CanvasBuffer.
     *
     * @property canvas
     * @type HTMLCanvasElement
     */this.canvas=document.createElement("canvas");/**
     * A CanvasRenderingContext2D object representing a two-dimensional rendering context.
     *
     * @property context
     * @type CanvasRenderingContext2D
     */this.context=this.canvas.getContext("2d");this.canvas.width=width;this.canvas.height=height;};PIXI.CanvasBuffer.prototype.constructor=PIXI.CanvasBuffer;/**
 * Clears the canvas that was created by the CanvasBuffer class.
 *
 * @method clear
 * @private
 */PIXI.CanvasBuffer.prototype.clear=function(){this.context.setTransform(1,0,0,1,0,0);this.context.clearRect(0,0,this.width,this.height);};/**
 * Resizes the canvas to the specified width and height.
 *
 * @method resize
 * @param width {Number} the new width of the canvas
 * @param height {Number} the new height of the canvas
 */PIXI.CanvasBuffer.prototype.resize=function(width,height){this.width=this.canvas.width=width;this.height=this.canvas.height=height;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A set of functions used to handle masking.
 *
 * @class CanvasMaskManager
 * @constructor
 */PIXI.CanvasMaskManager=function(){};PIXI.CanvasMaskManager.prototype.constructor=PIXI.CanvasMaskManager;/**
 * This method adds it to the current stack of masks.
 *
 * @method pushMask
 * @param maskData {Object} the maskData that will be pushed
 * @param renderSession {Object} The renderSession whose context will be used for this mask manager.
 */PIXI.CanvasMaskManager.prototype.pushMask=function(maskData,renderSession){var context=renderSession.context;context.save();var cacheAlpha=maskData.alpha;var transform=maskData.worldTransform;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphicsMask(maskData,context);context.clip();maskData.worldAlpha=cacheAlpha;};/**
 * Restores the current drawing context to the state it was before the mask was applied.
 *
 * @method popMask
 * @param renderSession {Object} The renderSession whose context will be used for this mask manager.
 */PIXI.CanvasMaskManager.prototype.popMask=function(renderSession){renderSession.context.restore();};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * Utility methods for Sprite/Texture tinting.
 *
 * @class CanvasTinter
 * @static
 */PIXI.CanvasTinter=function(){};/**
 * Basically this method just needs a sprite and a color and tints the sprite with the given color.
 * 
 * @method getTintedTexture 
 * @static
 * @param sprite {Sprite} the sprite to tint
 * @param color {Number} the color to use to tint the sprite with
 * @return {HTMLCanvasElement} The tinted canvas
 */PIXI.CanvasTinter.getTintedTexture=function(sprite,color){var texture=sprite.texture;color=PIXI.CanvasTinter.roundColor(color);var stringColor="#"+("00000"+(color|0).toString(16)).substr(-6);texture.tintCache=texture.tintCache||{};if(texture.tintCache[stringColor])return texture.tintCache[stringColor];// clone texture..
var canvas=PIXI.CanvasTinter.canvas||document.createElement("canvas");//PIXI.CanvasTinter.tintWithPerPixel(texture, stringColor, canvas);
PIXI.CanvasTinter.tintMethod(texture,color,canvas);if(PIXI.CanvasTinter.convertTintToImage){// is this better?
var tintImage=new Image();tintImage.src=canvas.toDataURL();texture.tintCache[stringColor]=tintImage;}else{texture.tintCache[stringColor]=canvas;// if we are not converting the texture to an image then we need to lose the reference to the canvas
PIXI.CanvasTinter.canvas=null;}return canvas;};/**
 * Tint a texture using the "multiply" operation.
 * 
 * @method tintWithMultiply
 * @static
 * @param texture {Texture} the texture to tint
 * @param color {Number} the color to use to tint the sprite with
 * @param canvas {HTMLCanvasElement} the current canvas
 */PIXI.CanvasTinter.tintWithMultiply=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="multiply";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);};/**
 * Tint a texture using the "overlay" operation.
 * 
 * @method tintWithOverlay
 * @static
 * @param texture {Texture} the texture to tint
 * @param color {Number} the color to use to tint the sprite with
 * @param canvas {HTMLCanvasElement} the current canvas
 */PIXI.CanvasTinter.tintWithOverlay=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.fillStyle="#"+("00000"+(color|0).toString(16)).substr(-6);context.fillRect(0,0,crop.width,crop.height);context.globalCompositeOperation="destination-atop";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);//context.globalCompositeOperation = "copy";
};/**
 * Tint a texture pixel per pixel.
 * 
 * @method tintPerPixel
 * @static
 * @param texture {Texture} the texture to tint
 * @param color {Number} the color to use to tint the sprite with
 * @param canvas {HTMLCanvasElement} the current canvas
 */PIXI.CanvasTinter.tintWithPerPixel=function(texture,color,canvas){var context=canvas.getContext("2d");var crop=texture.crop;canvas.width=crop.width;canvas.height=crop.height;context.globalCompositeOperation="copy";context.drawImage(texture.baseTexture.source,crop.x,crop.y,crop.width,crop.height,0,0,crop.width,crop.height);var rgbValues=PIXI.hex2rgb(color);var r=rgbValues[0],g=rgbValues[1],b=rgbValues[2];var pixelData=context.getImageData(0,0,crop.width,crop.height);var pixels=pixelData.data;for(var i=0;i<pixels.length;i+=4){pixels[i+0]*=r;pixels[i+1]*=g;pixels[i+2]*=b;}context.putImageData(pixelData,0,0);};/**
 * Rounds the specified color according to the PIXI.CanvasTinter.cacheStepsPerColorChannel.
 * 
 * @method roundColor
 * @static
 * @param color {number} the color to round, should be a hex color
 */PIXI.CanvasTinter.roundColor=function(color){var step=PIXI.CanvasTinter.cacheStepsPerColorChannel;var rgbValues=PIXI.hex2rgb(color);rgbValues[0]=Math.min(255,rgbValues[0]/step*step);rgbValues[1]=Math.min(255,rgbValues[1]/step*step);rgbValues[2]=Math.min(255,rgbValues[2]/step*step);return PIXI.rgb2hex(rgbValues);};/**
 * Number of steps which will be used as a cap when rounding colors.
 *
 * @property cacheStepsPerColorChannel 
 * @type Number
 * @static
 */PIXI.CanvasTinter.cacheStepsPerColorChannel=8;/**
 * Tint cache boolean flag.
 *
 * @property convertTintToImage
 * @type Boolean
 * @static
 */PIXI.CanvasTinter.convertTintToImage=false;/**
 * Whether or not the Canvas BlendModes are supported, consequently the ability to tint using the multiply method.
 *
 * @property canUseMultiply
 * @type Boolean
 * @static
 */PIXI.CanvasTinter.canUseMultiply=PIXI.canUseNewCanvasBlendModes();/**
 * The tinting method that will be used.
 * 
 * @method tintMethod
 * @static
 */PIXI.CanvasTinter.tintMethod=PIXI.CanvasTinter.canUseMultiply?PIXI.CanvasTinter.tintWithMultiply:PIXI.CanvasTinter.tintWithPerPixel;/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The CanvasRenderer draws the Stage and all its content onto a 2d canvas. This renderer should be used for browsers that do not support webGL.
 * Don't forget to add the CanvasRenderer.view to your DOM or you will not see anything :)
 *
 * @class CanvasRenderer
 * @constructor
 * @param [width=800] {Number} the width of the canvas view
 * @param [height=600] {Number} the height of the canvas view
 * @param [options] {Object} The optional renderer parameters
 * @param [options.view] {HTMLCanvasElement} the canvas to use as a view, optional
 * @param [options.transparent=false] {Boolean} If the render view is transparent, default false
 * @param [options.autoResize=false] {Boolean} If the render view is automatically resized, default false
 * @param [options.resolution=1] {Number} the resolution of the renderer retina would be 2
 * @param [options.clearBeforeRender=true] {Boolean} This sets if the CanvasRenderer will clear the canvas or not before the new render pass.
 */PIXI.CanvasRenderer=function(width,height,options){if(options){for(var i in PIXI.defaultRenderOptions){if(typeof options[i]==="undefined")options[i]=PIXI.defaultRenderOptions[i];}}else{options=PIXI.defaultRenderOptions;}if(!PIXI.defaultRenderer){PIXI.sayHello("Canvas");PIXI.defaultRenderer=this;}/**
     * The renderer type.
     *
     * @property type
     * @type Number
     */this.type=PIXI.CANVAS_RENDERER;/**
     * The resolution of the canvas.
     *
     * @property resolution
     * @type Number
     */this.resolution=options.resolution;/**
     * This sets if the CanvasRenderer will clear the canvas or not before the new render pass.
     * If the Stage is NOT transparent Pixi will use a canvas sized fillRect operation every frame to set the canvas background color.
     * If the Stage is transparent Pixi will use clearRect to clear the canvas every frame.
     * Disable this by setting this to false. For example if your game has a canvas filling background image you often don't need this set.
     *
     * @property clearBeforeRender
     * @type Boolean
     * @default
     */this.clearBeforeRender=options.clearBeforeRender;/**
     * Whether the render view is transparent
     *
     * @property transparent
     * @type Boolean
     */this.transparent=options.transparent;/**
     * Whether the render view should be resized automatically
     *
     * @property autoResize
     * @type Boolean
     */this.autoResize=options.autoResize||false;/**
     * The width of the canvas view
     *
     * @property width
     * @type Number
     * @default 800
     */this.width=width||800;/**
     * The height of the canvas view
     *
     * @property height
     * @type Number
     * @default 600
     */this.height=height||600;this.width*=this.resolution;this.height*=this.resolution;/**
     * The canvas element that everything is drawn to.
     *
     * @property view
     * @type HTMLCanvasElement
     */this.view=options.view||document.createElement("canvas");/**
     * The canvas 2d context that everything is drawn with
     * @property context
     * @type CanvasRenderingContext2D
     */this.context=this.view.getContext("2d",{alpha:this.transparent});/**
     * Boolean flag controlling canvas refresh.
     *
     * @property refresh
     * @type Boolean
     */this.refresh=true;this.view.width=this.width*this.resolution;this.view.height=this.height*this.resolution;/**
     * Internal var.
     *
     * @property count
     * @type Number
     */this.count=0;/**
     * Instance of a PIXI.CanvasMaskManager, handles masking when using the canvas renderer
     * @property maskManager
     * @type CanvasMaskManager
     */this.maskManager=new PIXI.CanvasMaskManager();/**
     * The render session is just a bunch of parameter used for rendering
     * @property renderSession
     * @type Object
     */this.renderSession={context:this.context,maskManager:this.maskManager,scaleMode:null,smoothProperty:null,/**
         * If true Pixi will Math.floor() x/y values when rendering, stopping pixel interpolation.
         * Handy for crisp pixel art and speed on legacy devices.
         *
         */roundPixels:false};this.mapBlendModes();this.resize(width,height);if("imageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="imageSmoothingEnabled";else if("webkitImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="webkitImageSmoothingEnabled";else if("mozImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="mozImageSmoothingEnabled";else if("oImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="oImageSmoothingEnabled";else if("msImageSmoothingEnabled"in this.context)this.renderSession.smoothProperty="msImageSmoothingEnabled";};// constructor
PIXI.CanvasRenderer.prototype.constructor=PIXI.CanvasRenderer;/**
 * Renders the Stage to this canvas view
 *
 * @method render
 * @param stage {Stage} the Stage element to be rendered
 */PIXI.CanvasRenderer.prototype.render=function(stage){stage.updateTransform();this.context.setTransform(1,0,0,1,0,0);this.context.globalAlpha=1;this.renderSession.currentBlendMode=PIXI.blendModes.NORMAL;this.context.globalCompositeOperation=PIXI.blendModesCanvas[PIXI.blendModes.NORMAL];if(navigator.isCocoonJS&&this.view.screencanvas){this.context.fillStyle="black";this.context.clear();}if(this.clearBeforeRender){if(this.transparent){this.context.clearRect(0,0,this.width,this.height);}else{this.context.fillStyle=stage.backgroundColorString;this.context.fillRect(0,0,this.width,this.height);}}this.renderDisplayObject(stage);// run interaction!
if(stage.interactive){//need to add some events!
if(!stage._interactiveEventsAdded){stage._interactiveEventsAdded=true;stage.interactionManager.setTarget(this);}}};/**
 * Removes everything from the renderer and optionally removes the Canvas DOM element.
 *
 * @method destroy
 * @param [removeView=true] {boolean} Removes the Canvas element from the DOM.
 */PIXI.CanvasRenderer.prototype.destroy=function(removeView){if(typeof removeView==="undefined"){removeView=true;}if(removeView&&this.view.parent){this.view.parent.removeChild(this.view);}this.view=null;this.context=null;this.maskManager=null;this.renderSession=null;};/**
 * Resizes the canvas view to the specified width and height
 *
 * @method resize
 * @param width {Number} the new width of the canvas view
 * @param height {Number} the new height of the canvas view
 */PIXI.CanvasRenderer.prototype.resize=function(width,height){this.width=width*this.resolution;this.height=height*this.resolution;this.view.width=this.width;this.view.height=this.height;if(this.autoResize){this.view.style.width=this.width/this.resolution+"px";this.view.style.height=this.height/this.resolution+"px";}};/**
 * Renders a display object
 *
 * @method renderDisplayObject
 * @param displayObject {DisplayObject} The displayObject to render
 * @param context {CanvasRenderingContext2D} the context 2d method of the canvas
 * @private
 */PIXI.CanvasRenderer.prototype.renderDisplayObject=function(displayObject,context){this.renderSession.context=context||this.context;this.renderSession.resolution=this.resolution;displayObject._renderCanvas(this.renderSession);};/**
 * Maps Pixi blend modes to canvas blend modes.
 *
 * @method mapBlendModes
 * @private
 */PIXI.CanvasRenderer.prototype.mapBlendModes=function(){if(!PIXI.blendModesCanvas){PIXI.blendModesCanvas=[];if(PIXI.canUseNewCanvasBlendModes()){PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";//IS THIS OK???
PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="multiply";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="screen";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="overlay";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="darken";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="lighten";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="color-dodge";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="color-burn";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="hard-light";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="soft-light";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="difference";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="exclusion";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="hue";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="saturation";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="color";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="luminosity";}else{// this means that the browser does not support the cool new blend modes in canvas "cough" ie "cough"
PIXI.blendModesCanvas[PIXI.blendModes.NORMAL]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.ADD]="lighter";//IS THIS OK???
PIXI.blendModesCanvas[PIXI.blendModes.MULTIPLY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SCREEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.OVERLAY]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DARKEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LIGHTEN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_DODGE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR_BURN]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HARD_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SOFT_LIGHT]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.DIFFERENCE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.EXCLUSION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.HUE]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.SATURATION]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.COLOR]="source-over";PIXI.blendModesCanvas[PIXI.blendModes.LUMINOSITY]="source-over";}}};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A set of functions used by the canvas renderer to draw the primitive graphics data.
 *
 * @class CanvasGraphics
 * @static
 */PIXI.CanvasGraphics=function(){};/*
 * Renders a PIXI.Graphics object to a canvas.
 *
 * @method renderGraphics
 * @static
 * @param graphics {Graphics} the actual graphics object to render
 * @param context {CanvasRenderingContext2D} the 2d drawing method of the canvas
 */PIXI.CanvasGraphics.renderGraphics=function(graphics,context){var worldAlpha=graphics.worldAlpha;if(graphics.dirty){this.updateGraphicsTint(graphics);graphics.dirty=false;}for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var shape=data.shape;var fillColor=data._fillTint;var lineColor=data._lineTint;context.lineWidth=data.lineWidth;if(data.type===PIXI.Graphics.POLY){context.beginPath();var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1]);}if(shape.closed){context.lineTo(points[0],points[1]);}// if the first and last point are the same close the path - much neater :)
if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath();}if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle='#'+('00000'+(fillColor|0).toString(16)).substr(-6);context.fill();}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle='#'+('00000'+(lineColor|0).toString(16)).substr(-6);context.stroke();}}else if(data.type===PIXI.Graphics.RECT){if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle='#'+('00000'+(fillColor|0).toString(16)).substr(-6);context.fillRect(shape.x,shape.y,shape.width,shape.height);}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle='#'+('00000'+(lineColor|0).toString(16)).substr(-6);context.strokeRect(shape.x,shape.y,shape.width,shape.height);}}else if(data.type===PIXI.Graphics.CIRC){// TODO - need to be Undefined!
context.beginPath();context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle='#'+('00000'+(fillColor|0).toString(16)).substr(-6);context.fill();}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle='#'+('00000'+(lineColor|0).toString(16)).substr(-6);context.stroke();}}else if(data.type===PIXI.Graphics.ELIP){// ellipse code taken from: http://stackoverflow.com/questions/2172798/how-to-draw-an-oval-in-html5-canvas
var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;context.beginPath();var kappa=0.5522848,ox=w/2*kappa,// control point offset horizontal
oy=h/2*kappa,// control point offset vertical
xe=x+w,// x-end
ye=y+h,// y-end
xm=x+w/2,// x-middle
ym=y+h/2;// y-middle
context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath();if(data.fill){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle='#'+('00000'+(fillColor|0).toString(16)).substr(-6);context.fill();}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle='#'+('00000'+(lineColor|0).toString(16)).substr(-6);context.stroke();}}else if(data.type===PIXI.Graphics.RREC){var rx=shape.x;var ry=shape.y;var width=shape.width;var height=shape.height;var radius=shape.radius;var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.beginPath();context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath();if(data.fillColor||data.fillColor===0){context.globalAlpha=data.fillAlpha*worldAlpha;context.fillStyle='#'+('00000'+(fillColor|0).toString(16)).substr(-6);context.fill();}if(data.lineWidth){context.globalAlpha=data.lineAlpha*worldAlpha;context.strokeStyle='#'+('00000'+(lineColor|0).toString(16)).substr(-6);context.stroke();}}}};/*
 * Renders a graphics mask
 *
 * @static
 * @private
 * @method renderGraphicsMask
 * @param graphics {Graphics} the graphics which will be used as a mask
 * @param context {CanvasRenderingContext2D} the context 2d method of the canvas
 */PIXI.CanvasGraphics.renderGraphicsMask=function(graphics,context){var len=graphics.graphicsData.length;if(len===0)return;if(len>1){len=1;window.console.log('Pixi.js warning: masks in canvas can only mask using the first path in the graphics object');}for(var i=0;i<1;i++){var data=graphics.graphicsData[i];var shape=data.shape;if(data.type===PIXI.Graphics.POLY){context.beginPath();var points=shape.points;context.moveTo(points[0],points[1]);for(var j=1;j<points.length/2;j++){context.lineTo(points[j*2],points[j*2+1]);}// if the first and last point are the same close the path - much neater :)
if(points[0]===points[points.length-2]&&points[1]===points[points.length-1]){context.closePath();}}else if(data.type===PIXI.Graphics.RECT){context.beginPath();context.rect(shape.x,shape.y,shape.width,shape.height);context.closePath();}else if(data.type===PIXI.Graphics.CIRC){// TODO - need to be Undefined!
context.beginPath();context.arc(shape.x,shape.y,shape.radius,0,2*Math.PI);context.closePath();}else if(data.type===PIXI.Graphics.ELIP){// ellipse code taken from: http://stackoverflow.com/questions/2172798/how-to-draw-an-oval-in-html5-canvas
var w=shape.width*2;var h=shape.height*2;var x=shape.x-w/2;var y=shape.y-h/2;context.beginPath();var kappa=0.5522848,ox=w/2*kappa,// control point offset horizontal
oy=h/2*kappa,// control point offset vertical
xe=x+w,// x-end
ye=y+h,// y-end
xm=x+w/2,// x-middle
ym=y+h/2;// y-middle
context.moveTo(x,ym);context.bezierCurveTo(x,ym-oy,xm-ox,y,xm,y);context.bezierCurveTo(xm+ox,y,xe,ym-oy,xe,ym);context.bezierCurveTo(xe,ym+oy,xm+ox,ye,xm,ye);context.bezierCurveTo(xm-ox,ye,x,ym+oy,x,ym);context.closePath();}else if(data.type===PIXI.Graphics.RREC){var pts=shape.points;var rx=pts[0];var ry=pts[1];var width=pts[2];var height=pts[3];var radius=pts[4];var maxRadius=Math.min(width,height)/2|0;radius=radius>maxRadius?maxRadius:radius;context.beginPath();context.moveTo(rx,ry+radius);context.lineTo(rx,ry+height-radius);context.quadraticCurveTo(rx,ry+height,rx+radius,ry+height);context.lineTo(rx+width-radius,ry+height);context.quadraticCurveTo(rx+width,ry+height,rx+width,ry+height-radius);context.lineTo(rx+width,ry+radius);context.quadraticCurveTo(rx+width,ry,rx+width-radius,ry);context.lineTo(rx+radius,ry);context.quadraticCurveTo(rx,ry,rx,ry+radius);context.closePath();}}};PIXI.CanvasGraphics.updateGraphicsTint=function(graphics){if(graphics.tint===0xFFFFFF)return;var tintR=(graphics.tint>>16&0xFF)/255;var tintG=(graphics.tint>>8&0xFF)/255;var tintB=(graphics.tint&0xFF)/255;for(var i=0;i<graphics.graphicsData.length;i++){var data=graphics.graphicsData[i];var fillColor=data.fillColor|0;var lineColor=data.lineColor|0;/*
        var colorR = (fillColor >> 16 & 0xFF) / 255;
        var colorG = (fillColor >> 8 & 0xFF) / 255;
        var colorB = (fillColor & 0xFF) / 255; 

        colorR *= tintR;
        colorG *= tintG;
        colorB *= tintB;

        fillColor = ((colorR*255 << 16) + (colorG*255 << 8) + colorB*255);

        colorR = (lineColor >> 16 & 0xFF) / 255;
        colorG = (lineColor >> 8 & 0xFF) / 255;
        colorB = (lineColor & 0xFF) / 255; 

        colorR *= tintR;
        colorG *= tintG;
        colorB *= tintB;

        lineColor = ((colorR*255 << 16) + (colorG*255 << 8) + colorB*255);   
        */ // super inline cos im an optimization NAZI :)
data._fillTint=((fillColor>>16&0xFF)/255*tintR*255<<16)+((fillColor>>8&0xFF)/255*tintG*255<<8)+(fillColor&0xFF)/255*tintB*255;data._lineTint=((lineColor>>16&0xFF)/255*tintR*255<<16)+((lineColor>>8&0xFF)/255*tintG*255<<8)+(lineColor&0xFF)/255*tintB*255;}};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The Graphics class contains methods used to draw primitive shapes such as lines, circles and rectangles to the display, and color and fill them.
 * 
 * @class Graphics
 * @extends DisplayObjectContainer
 * @constructor
 */PIXI.Graphics=function(){PIXI.DisplayObjectContainer.call(this);this.renderable=true;/**
     * The alpha value used when filling the Graphics object.
     *
     * @property fillAlpha
     * @type Number
     */this.fillAlpha=1;/**
     * The width (thickness) of any lines drawn.
     *
     * @property lineWidth
     * @type Number
     */this.lineWidth=0;/**
     * The color of any lines drawn.
     *
     * @property lineColor
     * @type String
     * @default 0
     */this.lineColor=0;/**
     * Graphics data
     *
     * @property graphicsData
     * @type Array
     * @private
     */this.graphicsData=[];/**
     * The tint applied to the graphic shape. This is a hex value. Apply a value of 0xFFFFFF to reset the tint.
     *
     * @property tint
     * @type Number
     * @default 0xFFFFFF
     */this.tint=0xFFFFFF;/**
     * The blend mode to be applied to the graphic shape. Apply a value of PIXI.blendModes.NORMAL to reset the blend mode.
     *
     * @property blendMode
     * @type Number
     * @default PIXI.blendModes.NORMAL;
     */this.blendMode=PIXI.blendModes.NORMAL;/**
     * Current path
     *
     * @property currentPath
     * @type Object
     * @private
     */this.currentPath=null;/**
     * Array containing some WebGL-related properties used by the WebGL renderer.
     *
     * @property _webGL
     * @type Array
     * @private
     */this._webGL=[];/**
     * Whether this shape is being used as a mask.
     *
     * @property isMask
     * @type Boolean
     */this.isMask=false;/**
     * The bounds' padding used for bounds calculation.
     *
     * @property boundsPadding
     * @type Number
     */this.boundsPadding=0;this._localBounds=new PIXI.Rectangle(0,0,1,1);/**
     * Used to detect if the graphics object has changed. If this is set to true then the graphics object will be recalculated.
     * 
     * @property dirty
     * @type Boolean
     * @private
     */this.dirty=true;/**
     * Used to detect if the webgl graphics object has changed. If this is set to true then the graphics object will be recalculated.
     * 
     * @property webGLDirty
     * @type Boolean
     * @private
     */this.webGLDirty=false;/**
     * Used to detect if the cached sprite object needs to be updated.
     * 
     * @property cachedSpriteDirty
     * @type Boolean
     * @private
     */this.cachedSpriteDirty=false;};// constructor
PIXI.Graphics.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Graphics.prototype.constructor=PIXI.Graphics;/**
 * When cacheAsBitmap is set to true the graphics object will be rendered as if it was a sprite.
 * This is useful if your graphics element does not change often, as it will speed up the rendering of the object in exchange for taking up texture memory.
 * It is also useful if you need the graphics object to be anti-aliased, because it will be rendered using canvas.
 * This is not recommended if you are constantly redrawing the graphics element.
 *
 * @property cacheAsBitmap
 * @type Boolean
 * @default false
 * @private
 */Object.defineProperty(PIXI.Graphics.prototype,"cacheAsBitmap",{get:function(){return this._cacheAsBitmap;},set:function(value){this._cacheAsBitmap=value;if(this._cacheAsBitmap){this._generateCachedSprite();}else{this.destroyCachedSprite();this.dirty=true;}}});/**
 * Specifies the line style used for subsequent calls to Graphics methods such as the lineTo() method or the drawCircle() method.
 *
 * @method lineStyle
 * @param lineWidth {Number} width of the line to draw, will update the objects stored style
 * @param color {Number} color of the line to draw, will update the objects stored style
 * @param alpha {Number} alpha of the line to draw, will update the objects stored style
 * @return {Graphics}
 */PIXI.Graphics.prototype.lineStyle=function(lineWidth,color,alpha){this.lineWidth=lineWidth||0;this.lineColor=color||0;this.lineAlpha=arguments.length<3?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length){// halfway through a line? start a new one!
this.drawShape(new PIXI.Polygon(this.currentPath.shape.points.slice(-2)));return this;}// otherwise its empty so lets just set the line properties
this.currentPath.lineWidth=this.lineWidth;this.currentPath.lineColor=this.lineColor;this.currentPath.lineAlpha=this.lineAlpha;}return this;};/**
 * Moves the current drawing position to x, y.
 *
 * @method moveTo
 * @param x {Number} the X coordinate to move to
 * @param y {Number} the Y coordinate to move to
 * @return {Graphics}
  */PIXI.Graphics.prototype.moveTo=function(x,y){this.drawShape(new PIXI.Polygon([x,y]));return this;};/**
 * Draws a line using the current line style from the current drawing position to (x, y);
 * The current drawing position is then set to (x, y).
 *
 * @method lineTo
 * @param x {Number} the X coordinate to draw to
 * @param y {Number} the Y coordinate to draw to
 * @return {Graphics}
 */PIXI.Graphics.prototype.lineTo=function(x,y){this.currentPath.shape.points.push(x,y);this.dirty=true;return this;};/**
 * Calculate the points for a quadratic bezier curve and then draws it.
 * Based on: https://stackoverflow.com/questions/785097/how-do-i-implement-a-bezier-curve-in-c
 *
 * @method quadraticCurveTo
 * @param cpX {Number} Control point x
 * @param cpY {Number} Control point y
 * @param toX {Number} Destination point x
 * @param toY {Number} Destination point y
 * @return {Graphics}
 */PIXI.Graphics.prototype.quadraticCurveTo=function(cpX,cpY,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0)this.currentPath.shape.points=[0,0];}else{this.moveTo(0,0);}var xa,ya,n=20,points=this.currentPath.shape.points;if(points.length===0)this.moveTo(0,0);var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;i++){j=i/n;xa=fromX+(cpX-fromX)*j;ya=fromY+(cpY-fromY)*j;points.push(xa+(cpX+(toX-cpX)*j-xa)*j,ya+(cpY+(toY-cpY)*j-ya)*j);}this.dirty=true;return this;};/**
 * Calculate the points for a bezier curve and then draws it.
 *
 * @method bezierCurveTo
 * @param cpX {Number} Control point x
 * @param cpY {Number} Control point y
 * @param cpX2 {Number} Second Control point x
 * @param cpY2 {Number} Second Control point y
 * @param toX {Number} Destination point x
 * @param toY {Number} Destination point y
 * @return {Graphics}
 */PIXI.Graphics.prototype.bezierCurveTo=function(cpX,cpY,cpX2,cpY2,toX,toY){if(this.currentPath){if(this.currentPath.shape.points.length===0)this.currentPath.shape.points=[0,0];}else{this.moveTo(0,0);}var n=20,dt,dt2,dt3,t2,t3,points=this.currentPath.shape.points;var fromX=points[points.length-2];var fromY=points[points.length-1];var j=0;for(var i=1;i<=n;i++){j=i/n;dt=1-j;dt2=dt*dt;dt3=dt2*dt;t2=j*j;t3=t2*j;points.push(dt3*fromX+3*dt2*j*cpX+3*dt*t2*cpX2+t3*toX,dt3*fromY+3*dt2*j*cpY+3*dt*t2*cpY2+t3*toY);}this.dirty=true;return this;};/*
 * The arcTo() method creates an arc/curve between two tangents on the canvas.
 * 
 * "borrowed" from https://code.google.com/p/fxcanvas/ - thanks google!
 *
 * @method arcTo
 * @param x1 {Number} The x-coordinate of the beginning of the arc
 * @param y1 {Number} The y-coordinate of the beginning of the arc
 * @param x2 {Number} The x-coordinate of the end of the arc
 * @param y2 {Number} The y-coordinate of the end of the arc
 * @param radius {Number} The radius of the arc
 * @return {Graphics}
 */PIXI.Graphics.prototype.arcTo=function(x1,y1,x2,y2,radius){if(this.currentPath){if(this.currentPath.shape.points.length===0){this.currentPath.shape.points.push(x1,y1);}}else{this.moveTo(x1,y1);}var points=this.currentPath.shape.points;var fromX=points[points.length-2];var fromY=points[points.length-1];var a1=fromY-y1;var b1=fromX-x1;var a2=y2-y1;var b2=x2-x1;var mm=Math.abs(a1*b2-b1*a2);if(mm<1.0e-8||radius===0){if(points[points.length-2]!==x1||points[points.length-1]!==y1){//console.log(">>")
points.push(x1,y1);}}else{var dd=a1*a1+b1*b1;var cc=a2*a2+b2*b2;var tt=a1*a2+b1*b2;var k1=radius*Math.sqrt(dd)/mm;var k2=radius*Math.sqrt(cc)/mm;var j1=k1*tt/dd;var j2=k2*tt/cc;var cx=k1*b2+k2*b1;var cy=k1*a2+k2*a1;var px=b1*(k2+j1);var py=a1*(k2+j1);var qx=b2*(k1+j2);var qy=a2*(k1+j2);var startAngle=Math.atan2(py-cy,px-cx);var endAngle=Math.atan2(qy-cy,qx-cx);this.arc(cx+x1,cy+y1,radius,startAngle,endAngle,b1*a2>b2*a1);}this.dirty=true;return this;};/**
 * The arc method creates an arc/curve (used to create circles, or parts of circles).
 *
 * @method arc
 * @param cx {Number} The x-coordinate of the center of the circle
 * @param cy {Number} The y-coordinate of the center of the circle
 * @param radius {Number} The radius of the circle
 * @param startAngle {Number} The starting angle, in radians (0 is at the 3 o'clock position of the arc's circle)
 * @param endAngle {Number} The ending angle, in radians
 * @param anticlockwise {Boolean} Optional. Specifies whether the drawing should be counterclockwise or clockwise. False is default, and indicates clockwise, while true indicates counter-clockwise.
 * @return {Graphics}
 */PIXI.Graphics.prototype.arc=function(cx,cy,radius,startAngle,endAngle,anticlockwise){var startX=cx+Math.cos(startAngle)*radius;var startY=cy+Math.sin(startAngle)*radius;var points;if(this.currentPath){points=this.currentPath.shape.points;if(points.length===0){points.push(startX,startY);}else if(points[points.length-2]!==startX||points[points.length-1]!==startY){points.push(startX,startY);}}else{this.moveTo(startX,startY);points=this.currentPath.shape.points;}if(startAngle===endAngle)return this;if(!anticlockwise&&endAngle<=startAngle){endAngle+=Math.PI*2;}else if(anticlockwise&&startAngle<=endAngle){startAngle+=Math.PI*2;}var sweep=anticlockwise?(startAngle-endAngle)*-1:endAngle-startAngle;var segs=Math.abs(sweep)/(Math.PI*2)*40;if(sweep===0)return this;var theta=sweep/(segs*2);var theta2=theta*2;var cTheta=Math.cos(theta);var sTheta=Math.sin(theta);var segMinus=segs-1;var remainder=segMinus%1/segMinus;for(var i=0;i<=segMinus;i++){var real=i+remainder*i;var angle=theta+startAngle+theta2*real;var c=Math.cos(angle);var s=-Math.sin(angle);points.push((cTheta*c+sTheta*s)*radius+cx,(cTheta*-s+sTheta*c)*radius+cy);}this.dirty=true;return this;};/**
 * Specifies a simple one-color fill that subsequent calls to other Graphics methods
 * (such as lineTo() or drawCircle()) use when drawing.
 *
 * @method beginFill
 * @param color {Number} the color of the fill
 * @param alpha {Number} the alpha of the fill
 * @return {Graphics}
 */PIXI.Graphics.prototype.beginFill=function(color,alpha){this.filling=true;this.fillColor=color||0;this.fillAlpha=alpha===undefined?1:alpha;if(this.currentPath){if(this.currentPath.shape.points.length<=2){this.currentPath.fill=this.filling;this.currentPath.fillColor=this.fillColor;this.currentPath.fillAlpha=this.fillAlpha;}}return this;};/**
 * Applies a fill to the lines and shapes that were added since the last call to the beginFill() method.
 *
 * @method endFill
 * @return {Graphics}
 */PIXI.Graphics.prototype.endFill=function(){this.filling=false;this.fillColor=null;this.fillAlpha=1;return this;};/**
 * Draws a rectangle.
 * 
 * @method drawRect
 *
 * @param x {Number} The X coord of the top-left of the rectangle
 * @param y {Number} The Y coord of the top-left of the rectangle
 * @param width {Number} The width of the rectangle
 * @param height {Number} The height of the rectangle
 * @return {Graphics}
 */PIXI.Graphics.prototype.drawRect=function(x,y,width,height){this.drawShape(new PIXI.Rectangle(x,y,width,height));return this;};/**
 * Draws a rounded rectangle.
 * 
 * @method drawRoundedRect
 *
 * @param x {Number} The X coord of the top-left of the rectangle
 * @param y {Number} The Y coord of the top-left of the rectangle
 * @param width {Number} The width of the rectangle
 * @param height {Number} The height of the rectangle
 * @param radius {Number} Radius of the rectangle corners
 * @return {Graphics}
 */PIXI.Graphics.prototype.drawRoundedRect=function(x,y,width,height,radius){this.drawShape(new PIXI.RoundedRectangle(x,y,width,height,radius));return this;};/**
 * Draws a circle.
 *
 * @method drawCircle
 * @param x {Number} The X coordinate of the center of the circle
 * @param y {Number} The Y coordinate of the center of the circle
 * @param radius {Number} The radius of the circle
 * @return {Graphics}
 */PIXI.Graphics.prototype.drawCircle=function(x,y,radius){this.drawShape(new PIXI.Circle(x,y,radius));return this;};/**
 * Draws an ellipse.
 *
 * @method drawEllipse
 * @param x {Number} The X coordinate of the center of the ellipse
 * @param y {Number} The Y coordinate of the center of the ellipse
 * @param width {Number} The half width of the ellipse
 * @param height {Number} The half height of the ellipse
 * @return {Graphics}
 */PIXI.Graphics.prototype.drawEllipse=function(x,y,width,height){this.drawShape(new PIXI.Ellipse(x,y,width,height));return this;};/**
 * Draws a polygon using the given path.
 *
 * @method drawPolygon
 * @param path {Array} The path data used to construct the polygon.
 * @return {Graphics}
 */PIXI.Graphics.prototype.drawPolygon=function(path){if(!(path instanceof Array))path=Array.prototype.slice.call(arguments);this.drawShape(new PIXI.Polygon(path));return this;};/**
 * Clears the graphics that were drawn to this Graphics object, and resets fill and line style settings.
 *
 * @method clear
 * @return {Graphics}
 */PIXI.Graphics.prototype.clear=function(){this.lineWidth=0;this.filling=false;this.dirty=true;this.clearDirty=true;this.graphicsData=[];return this;};/**
 * Useful function that returns a texture of the graphics object that can then be used to create sprites
 * This can be quite useful if your geometry is complicated and needs to be reused multiple times.
 *
 * @method generateTexture
 * @param resolution {Number} The resolution of the texture being generated
 * @param scaleMode {Number} Should be one of the PIXI.scaleMode consts
 * @return {Texture} a texture of the graphics object
 */PIXI.Graphics.prototype.generateTexture=function(resolution,scaleMode){resolution=resolution||1;var bounds=this.getBounds();var canvasBuffer=new PIXI.CanvasBuffer(bounds.width*resolution,bounds.height*resolution);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas,scaleMode);texture.baseTexture.resolution=resolution;canvasBuffer.context.scale(resolution,resolution);canvasBuffer.context.translate(-bounds.x,-bounds.y);PIXI.CanvasGraphics.renderGraphics(this,canvasBuffer.context);return texture;};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession} 
* @private
*/PIXI.Graphics.prototype._renderWebGL=function(renderSession){// if the sprite is not visible or the alpha is 0 then no need to render this element
if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();// we will also need to update the texture on the gpu too!
this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false;}this._cachedSprite.worldAlpha=this.worldAlpha;PIXI.Sprite.prototype._renderWebGL.call(this._cachedSprite,renderSession);return;}else{renderSession.spriteBatch.stop();renderSession.blendModeManager.setBlendMode(this.blendMode);if(this._mask)renderSession.maskManager.pushMask(this._mask,renderSession);if(this._filters)renderSession.filterManager.pushFilter(this._filterBlock);// check blend mode
if(this.blendMode!==renderSession.spriteBatch.currentBlendMode){renderSession.spriteBatch.currentBlendMode=this.blendMode;var blendModeWebGL=PIXI.blendModesWebGL[renderSession.spriteBatch.currentBlendMode];renderSession.spriteBatch.gl.blendFunc(blendModeWebGL[0],blendModeWebGL[1]);}// check if the webgl graphic needs to be updated
if(this.webGLDirty){this.dirty=true;this.webGLDirty=false;}PIXI.WebGLGraphics.renderGraphics(this,renderSession);// only render if it has children!
if(this.children.length){renderSession.spriteBatch.start();// simple render children!
for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}renderSession.spriteBatch.stop();}if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this.mask,renderSession);renderSession.drawCount++;renderSession.spriteBatch.start();}};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession} 
* @private
*/PIXI.Graphics.prototype._renderCanvas=function(renderSession){// if the sprite is not visible or the alpha is 0 then no need to render this element
if(this.visible===false||this.alpha===0||this.isMask===true)return;if(this._cacheAsBitmap){if(this.dirty||this.cachedSpriteDirty){this._generateCachedSprite();// we will also need to update the texture
this.updateCachedSpriteTexture();this.cachedSpriteDirty=false;this.dirty=false;}this._cachedSprite.alpha=this.alpha;PIXI.Sprite.prototype._renderCanvas.call(this._cachedSprite,renderSession);return;}else{var context=renderSession.context;var transform=this.worldTransform;if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode];}if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession);}var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);PIXI.CanvasGraphics.renderGraphics(this,context);// simple render children!
for(var i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession);}if(this._mask){renderSession.maskManager.popMask(renderSession);}}};/**
 * Retrieves the bounds of the graphic shape as a rectangle object
 *
 * @method getBounds
 * @return {Rectangle} the rectangular bounding area
 */PIXI.Graphics.prototype.getBounds=function(matrix){// return an empty object if the item is a mask!
if(this.isMask)return PIXI.EmptyRectangle;if(this.dirty){this.updateLocalBounds();this.webGLDirty=true;this.cachedSpriteDirty=true;this.dirty=false;}var bounds=this._localBounds;var w0=bounds.x;var w1=bounds.width+bounds.x;var h0=bounds.y;var h1=bounds.height+bounds.y;var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=x1;var maxY=y1;var minX=x1;var minY=y1;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;this._bounds.x=minX;this._bounds.width=maxX-minX;this._bounds.y=minY;this._bounds.height=maxY-minY;return this._bounds;};/**
 * Update the bounds of the object
 *
 * @method updateLocalBounds
 */PIXI.Graphics.prototype.updateLocalBounds=function(){var minX=Infinity;var maxX=-Infinity;var minY=Infinity;var maxY=-Infinity;if(this.graphicsData.length){var shape,points,x,y,w,h;for(var i=0;i<this.graphicsData.length;i++){var data=this.graphicsData[i];var type=data.type;var lineWidth=data.lineWidth;shape=data.shape;if(type===PIXI.Graphics.RECT||type===PIXI.Graphics.RREC){x=shape.x-lineWidth/2;y=shape.y-lineWidth/2;w=shape.width+lineWidth;h=shape.height+lineWidth;minX=x<minX?x:minX;maxX=x+w>maxX?x+w:maxX;minY=y<minY?y:minY;maxY=y+h>maxY?y+h:maxY;}else if(type===PIXI.Graphics.CIRC){x=shape.x;y=shape.y;w=shape.radius+lineWidth/2;h=shape.radius+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY;}else if(type===PIXI.Graphics.ELIP){x=shape.x;y=shape.y;w=shape.width+lineWidth/2;h=shape.height+lineWidth/2;minX=x-w<minX?x-w:minX;maxX=x+w>maxX?x+w:maxX;minY=y-h<minY?y-h:minY;maxY=y+h>maxY?y+h:maxY;}else{// POLY
points=shape.points;for(var j=0;j<points.length;j+=2){x=points[j];y=points[j+1];minX=x-lineWidth<minX?x-lineWidth:minX;maxX=x+lineWidth>maxX?x+lineWidth:maxX;minY=y-lineWidth<minY?y-lineWidth:minY;maxY=y+lineWidth>maxY?y+lineWidth:maxY;}}}}else{minX=0;maxX=0;minY=0;maxY=0;}var padding=this.boundsPadding;this._localBounds.x=minX-padding;this._localBounds.width=maxX-minX+padding*2;this._localBounds.y=minY-padding;this._localBounds.height=maxY-minY+padding*2;};/**
 * Generates the cached sprite when the sprite has cacheAsBitmap = true
 *
 * @method _generateCachedSprite
 * @private
 */PIXI.Graphics.prototype._generateCachedSprite=function(){var bounds=this.getLocalBounds();if(!this._cachedSprite){var canvasBuffer=new PIXI.CanvasBuffer(bounds.width,bounds.height);var texture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this._cachedSprite=new PIXI.Sprite(texture);this._cachedSprite.buffer=canvasBuffer;this._cachedSprite.worldTransform=this.worldTransform;}else{this._cachedSprite.buffer.resize(bounds.width,bounds.height);}// leverage the anchor to account for the offset of the element
this._cachedSprite.anchor.x=-(bounds.x/bounds.width);this._cachedSprite.anchor.y=-(bounds.y/bounds.height);// this._cachedSprite.buffer.context.save();
this._cachedSprite.buffer.context.translate(-bounds.x,-bounds.y);// make sure we set the alpha of the graphics to 1 for the render.. 
this.worldAlpha=1;// now render the graphic..
PIXI.CanvasGraphics.renderGraphics(this,this._cachedSprite.buffer.context);this._cachedSprite.alpha=this.alpha;};/**
 * Updates texture size based on canvas size
 *
 * @method updateCachedSpriteTexture
 * @private
 */PIXI.Graphics.prototype.updateCachedSpriteTexture=function(){var cachedSprite=this._cachedSprite;var texture=cachedSprite.texture;var canvas=cachedSprite.buffer.canvas;texture.baseTexture.width=canvas.width;texture.baseTexture.height=canvas.height;texture.crop.width=texture.frame.width=canvas.width;texture.crop.height=texture.frame.height=canvas.height;cachedSprite._width=canvas.width;cachedSprite._height=canvas.height;// update the dirty base textures
texture.baseTexture.dirty();};/**
 * Destroys a previous cached sprite.
 *
 * @method destroyCachedSprite
 */PIXI.Graphics.prototype.destroyCachedSprite=function(){this._cachedSprite.texture.destroy(true);// let the gc collect the unused sprite
// TODO could be object pooled!
this._cachedSprite=null;};/**
 * Draws the given shape to this Graphics object. Can be any of Circle, Rectangle, Ellipse, Line or Polygon.
 *
 * @method drawShape
 * @param {Circle|Rectangle|Ellipse|Line|Polygon} shape The Shape object to draw.
 * @return {GraphicsData} The generated GraphicsData object.
 */PIXI.Graphics.prototype.drawShape=function(shape){if(this.currentPath){// check current path!
if(this.currentPath.shape.points.length<=2)this.graphicsData.pop();}this.currentPath=null;var data=new PIXI.GraphicsData(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.filling,shape);this.graphicsData.push(data);if(data.type===PIXI.Graphics.POLY){data.shape.closed=this.filling;this.currentPath=data;}this.dirty=true;return data;};/**
 * A GraphicsData object.
 * 
 * @class GraphicsData
 * @constructor
 */PIXI.GraphicsData=function(lineWidth,lineColor,lineAlpha,fillColor,fillAlpha,fill,shape){this.lineWidth=lineWidth;this.lineColor=lineColor;this.lineAlpha=lineAlpha;this._lineTint=lineColor;this.fillColor=fillColor;this.fillAlpha=fillAlpha;this._fillTint=fillColor;this.fill=fill;this.shape=shape;this.type=shape.type;};// SOME TYPES:
PIXI.Graphics.POLY=0;PIXI.Graphics.RECT=1;PIXI.Graphics.CIRC=2;PIXI.Graphics.ELIP=3;PIXI.Graphics.RREC=4;PIXI.Polygon.prototype.type=PIXI.Graphics.POLY;PIXI.Rectangle.prototype.type=PIXI.Graphics.RECT;PIXI.Circle.prototype.type=PIXI.Graphics.CIRC;PIXI.Ellipse.prototype.type=PIXI.Graphics.ELIP;PIXI.RoundedRectangle.prototype.type=PIXI.Graphics.RREC;/**
 * @author Mat Groves http://matgroves.com/
 */ /**
 *
 * @class Strip
 * @extends DisplayObjectContainer
 * @constructor
 * @param texture {Texture} The texture to use
 * @param width {Number} the width
 * @param height {Number} the height
 *
 */PIXI.Strip=function(texture){PIXI.DisplayObjectContainer.call(this);/**
     * The texture of the strip
     *
     * @property texture
     * @type Texture
     */this.texture=texture;// set up the main bits..
this.uvs=new PIXI.Float32Array([0,1,1,1,1,0,0,1]);this.vertices=new PIXI.Float32Array([0,0,100,0,100,100,0,100]);this.colors=new PIXI.Float32Array([1,1,1,1]);this.indices=new PIXI.Uint16Array([0,1,2,3]);/**
     * Whether the strip is dirty or not
     *
     * @property dirty
     * @type Boolean
     */this.dirty=true;/**
     * The blend mode to be applied to the sprite. Set to PIXI.blendModes.NORMAL to remove any blend mode.
     *
     * @property blendMode
     * @type Number
     * @default PIXI.blendModes.NORMAL;
     */this.blendMode=PIXI.blendModes.NORMAL;/**
     * Triangles in canvas mode are automatically antialiased, use this value to force triangles to overlap a bit with each other.
     *
     * @property canvasPadding
     * @type Number
     */this.canvasPadding=0;this.drawMode=PIXI.Strip.DrawModes.TRIANGLE_STRIP;};// constructor
PIXI.Strip.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Strip.prototype.constructor=PIXI.Strip;PIXI.Strip.prototype._renderWebGL=function(renderSession){// if the sprite is not visible or the alpha is 0 then no need to render this element
if(!this.visible||this.alpha<=0)return;// render triangle strip..
renderSession.spriteBatch.stop();// init! init!
if(!this._vertexBuffer)this._initWebGL(renderSession);renderSession.shaderManager.setShader(renderSession.shaderManager.stripShader);this._renderStrip(renderSession);///renderSession.shaderManager.activateDefaultShader();
renderSession.spriteBatch.start();//TODO check culling
};PIXI.Strip.prototype._initWebGL=function(renderSession){// build the strip!
var gl=renderSession.gl;this._vertexBuffer=gl.createBuffer();this._indexBuffer=gl.createBuffer();this._uvBuffer=gl.createBuffer();this._colorBuffer=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.DYNAMIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.bindBuffer(gl.ARRAY_BUFFER,this._colorBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.colors,gl.STATIC_DRAW);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);};PIXI.Strip.prototype._renderStrip=function(renderSession){var gl=renderSession.gl;var projection=renderSession.projection,offset=renderSession.offset,shader=renderSession.shaderManager.stripShader;var drawMode=this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP?gl.TRIANGLE_STRIP:gl.TRIANGLES;// gl.uniformMatrix4fv(shaderProgram.mvMatrixUniform, false, mat4Real);
renderSession.blendModeManager.setBlendMode(this.blendMode);// set uniforms
gl.uniformMatrix3fv(shader.translationMatrix,false,this.worldTransform.toArray(true));gl.uniform2f(shader.projectionVector,projection.x,-projection.y);gl.uniform2f(shader.offsetVector,-offset.x,-offset.y);gl.uniform1f(shader.alpha,this.worldAlpha);if(!this.dirty){gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferSubData(gl.ARRAY_BUFFER,0,this.vertices);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);// update the uvs
gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);// check if a texture is dirty..
if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture);}else{// bind the current texture
gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id]);}// dont need to upload!
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);}else{this.dirty=false;gl.bindBuffer(gl.ARRAY_BUFFER,this._vertexBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.vertices,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aVertexPosition,2,gl.FLOAT,false,0,0);// update the uvs
gl.bindBuffer(gl.ARRAY_BUFFER,this._uvBuffer);gl.bufferData(gl.ARRAY_BUFFER,this.uvs,gl.STATIC_DRAW);gl.vertexAttribPointer(shader.aTextureCoord,2,gl.FLOAT,false,0,0);gl.activeTexture(gl.TEXTURE0);// check if a texture is dirty..
if(this.texture.baseTexture._dirty[gl.id]){renderSession.renderer.updateTexture(this.texture.baseTexture);}else{gl.bindTexture(gl.TEXTURE_2D,this.texture.baseTexture._glTextures[gl.id]);}// dont need to upload!
gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,this._indexBuffer);gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,this.indices,gl.STATIC_DRAW);}//console.log(gl.TRIANGLE_STRIP)
//
//
gl.drawElements(drawMode,this.indices.length,gl.UNSIGNED_SHORT,0);};PIXI.Strip.prototype._renderCanvas=function(renderSession){var context=renderSession.context;var transform=this.worldTransform;if(renderSession.roundPixels){context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx|0,transform.ty|0);}else{context.setTransform(transform.a,transform.b,transform.c,transform.d,transform.tx,transform.ty);}if(this.drawMode===PIXI.Strip.DrawModes.TRIANGLE_STRIP){this._renderCanvasTriangleStrip(context);}else{this._renderCanvasTriangles(context);}};PIXI.Strip.prototype._renderCanvasTriangleStrip=function(context){// draw triangles!!
var vertices=this.vertices;var uvs=this.uvs;var length=vertices.length/2;this.count++;for(var i=0;i<length-2;i++){// draw some triangles!
var index=i*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index,index+2,index+4);}};PIXI.Strip.prototype._renderCanvasTriangles=function(context){// draw triangles!!
var vertices=this.vertices;var uvs=this.uvs;var indices=this.indices;var length=indices.length;this.count++;for(var i=0;i<length;i+=3){// draw some triangles!
var index0=indices[i]*2,index1=indices[i+1]*2,index2=indices[i+2]*2;this._renderCanvasDrawTriangle(context,vertices,uvs,index0,index1,index2);}};PIXI.Strip.prototype._renderCanvasDrawTriangle=function(context,vertices,uvs,index0,index1,index2){var textureSource=this.texture.baseTexture.source;var textureWidth=this.texture.width;var textureHeight=this.texture.height;var x0=vertices[index0],x1=vertices[index1],x2=vertices[index2];var y0=vertices[index0+1],y1=vertices[index1+1],y2=vertices[index2+1];var u0=uvs[index0]*textureWidth,u1=uvs[index1]*textureWidth,u2=uvs[index2]*textureWidth;var v0=uvs[index0+1]*textureHeight,v1=uvs[index1+1]*textureHeight,v2=uvs[index2+1]*textureHeight;if(this.canvasPadding>0){var paddingX=this.canvasPadding/this.worldTransform.a;var paddingY=this.canvasPadding/this.worldTransform.d;var centerX=(x0+x1+x2)/3;var centerY=(y0+y1+y2)/3;var normX=x0-centerX;var normY=y0-centerY;var dist=Math.sqrt(normX*normX+normY*normY);x0=centerX+normX/dist*(dist+paddingX);y0=centerY+normY/dist*(dist+paddingY);//
normX=x1-centerX;normY=y1-centerY;dist=Math.sqrt(normX*normX+normY*normY);x1=centerX+normX/dist*(dist+paddingX);y1=centerY+normY/dist*(dist+paddingY);normX=x2-centerX;normY=y2-centerY;dist=Math.sqrt(normX*normX+normY*normY);x2=centerX+normX/dist*(dist+paddingX);y2=centerY+normY/dist*(dist+paddingY);}context.save();context.beginPath();context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2);context.closePath();context.clip();// Compute matrix transform
var delta=u0*v1+v0*u2+u1*v2-v1*u2-v0*u1-u0*v2;var deltaA=x0*v1+v0*x2+x1*v2-v1*x2-v0*x1-x0*v2;var deltaB=u0*x1+x0*u2+u1*x2-x1*u2-x0*u1-u0*x2;var deltaC=u0*v1*x2+v0*x1*u2+x0*u1*v2-x0*v1*u2-v0*u1*x2-u0*x1*v2;var deltaD=y0*v1+v0*y2+y1*v2-v1*y2-v0*y1-y0*v2;var deltaE=u0*y1+y0*u2+u1*y2-y1*u2-y0*u1-u0*y2;var deltaF=u0*v1*y2+v0*y1*u2+y0*u1*v2-y0*v1*u2-v0*u1*y2-u0*y1*v2;context.transform(deltaA/delta,deltaD/delta,deltaB/delta,deltaE/delta,deltaC/delta,deltaF/delta);context.drawImage(textureSource,0,0);context.restore();};/**
 * Renders a flat strip
 *
 * @method renderStripFlat
 * @param strip {Strip} The Strip to render
 * @private
 */PIXI.Strip.prototype.renderStripFlat=function(strip){var context=this.context;var vertices=strip.vertices;var length=vertices.length/2;this.count++;context.beginPath();for(var i=1;i<length-2;i++){// draw some triangles!
var index=i*2;var x0=vertices[index],x1=vertices[index+2],x2=vertices[index+4];var y0=vertices[index+1],y1=vertices[index+3],y2=vertices[index+5];context.moveTo(x0,y0);context.lineTo(x1,y1);context.lineTo(x2,y2);}context.fillStyle='#FF0000';context.fill();context.closePath();};/*
PIXI.Strip.prototype.setTexture = function(texture)
{
    //TODO SET THE TEXTURES
    //TODO VISIBILITY

    // stop current texture
    this.texture = texture;
    this.width   = texture.frame.width;
    this.height  = texture.frame.height;
    this.updateFrame = true;
};
*/ /**
 * When the texture is updated, this event will fire to update the scale and frame
 *
 * @method onTextureUpdate
 * @param event
 * @private
 */PIXI.Strip.prototype.onTextureUpdate=function(){this.updateFrame=true;};/**
 * Returns the bounds of the mesh as a rectangle. The bounds calculation takes the worldTransform into account.
 *
 * @method getBounds
 * @param matrix {Matrix} the transformation matrix of the sprite
 * @return {Rectangle} the framing rectangle
 */PIXI.Strip.prototype.getBounds=function(matrix){var worldTransform=matrix||this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;var vertices=this.vertices;for(var i=0,n=vertices.length;i<n;i+=2){var rawX=vertices[i],rawY=vertices[i+1];var x=a*rawX+c*rawY+tx;var y=d*rawY+b*rawX+ty;minX=x<minX?x:minX;minY=y<minY?y:minY;maxX=x>maxX?x:maxX;maxY=y>maxY?y:maxY;}if(minX===-Infinity||maxY===Infinity){return PIXI.EmptyRectangle;}var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;// store a reference so that if this function gets called again in the render cycle we do not have to recalculate
this._currentBounds=bounds;return bounds;};/**
 * Different drawing buffer modes supported
 *
 * @property
 * @type {{TRIANGLE_STRIP: number, TRIANGLES: number}}
 * @static
 */PIXI.Strip.DrawModes={TRIANGLE_STRIP:0,TRIANGLES:1};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * @copyright Mat Groves, Rovanion Luckey
 */ /**
 *
 * @class Rope
 * @constructor
 * @extends Strip
 * @param {Texture} texture - The texture to use on the rope.
 * @param {Array} points - An array of {PIXI.Point}.
 *
 */PIXI.Rope=function(texture,points){PIXI.Strip.call(this,texture);this.points=points;this.vertices=new PIXI.Float32Array(points.length*4);this.uvs=new PIXI.Float32Array(points.length*4);this.colors=new PIXI.Float32Array(points.length*2);this.indices=new PIXI.Uint16Array(points.length*2);this.refresh();};// constructor
PIXI.Rope.prototype=Object.create(PIXI.Strip.prototype);PIXI.Rope.prototype.constructor=PIXI.Rope;/*
 * Refreshes
 *
 * @method refresh
 */PIXI.Rope.prototype.refresh=function(){var points=this.points;if(points.length<1)return;var uvs=this.uvs;var lastPoint=points[0];var indices=this.indices;var colors=this.colors;this.count-=0.2;uvs[0]=0;uvs[1]=0;uvs[2]=0;uvs[3]=1;colors[0]=1;colors[1]=1;indices[0]=0;indices[1]=1;var total=points.length,point,index,amount;for(var i=1;i<total;i++){point=points[i];index=i*4;// time to do some smart drawing!
amount=i/(total-1);if(i%2){uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1;}else{uvs[index]=amount;uvs[index+1]=0;uvs[index+2]=amount;uvs[index+3]=1;}index=i*2;colors[index]=1;colors[index+1]=1;index=i*2;indices[index]=index;indices[index+1]=index+1;lastPoint=point;}};/*
 * Updates the object transform for rendering
 *
 * @method updateTransform
 * @private
 */PIXI.Rope.prototype.updateTransform=function(){var points=this.points;if(points.length<1)return;var lastPoint=points[0];var nextPoint;var perp={x:0,y:0};this.count-=0.2;var vertices=this.vertices;var total=points.length,point,index,ratio,perpLength,num;for(var i=0;i<total;i++){point=points[i];index=i*4;if(i<points.length-1){nextPoint=points[i+1];}else{nextPoint=point;}perp.y=-(nextPoint.x-lastPoint.x);perp.x=nextPoint.y-lastPoint.y;ratio=(1-i/(total-1))*10;if(ratio>1)ratio=1;perpLength=Math.sqrt(perp.x*perp.x+perp.y*perp.y);num=this.texture.height/2;//(20 + Math.abs(Math.sin((i + this.count) * 0.3) * 50) )* ratio;
perp.x/=perpLength;perp.y/=perpLength;perp.x*=num;perp.y*=num;vertices[index]=point.x+perp.x;vertices[index+1]=point.y+perp.y;vertices[index+2]=point.x-perp.x;vertices[index+3]=point.y-perp.y;lastPoint=point;}PIXI.DisplayObjectContainer.prototype.updateTransform.call(this);};/*
 * Sets the texture that the Rope will use
 *
 * @method setTexture
 * @param texture {Texture} the texture that will be used
 */PIXI.Rope.prototype.setTexture=function(texture){// stop current texture
this.texture=texture;//this.updateFrame = true;
};/**
 * @author Mat Groves http://matgroves.com/
 */ /**
 * A tiling sprite is a fast way of rendering a tiling image
 *
 * @class TilingSprite
 * @extends Sprite
 * @constructor
 * @param texture {Texture} the texture of the tiling sprite
 * @param width {Number}  the width of the tiling sprite
 * @param height {Number} the height of the tiling sprite
 */PIXI.TilingSprite=function(texture,width,height){PIXI.Sprite.call(this,texture);/**
     * The with of the tiling sprite
     *
     * @property width
     * @type Number
     */this._width=width||100;/**
     * The height of the tiling sprite
     *
     * @property height
     * @type Number
     */this._height=height||100;/**
     * The scaling of the image that is being tiled
     *
     * @property tileScale
     * @type Point
     */this.tileScale=new PIXI.Point(1,1);/**
     * A point that represents the scale of the texture object
     *
     * @property tileScaleOffset
     * @type Point
     */this.tileScaleOffset=new PIXI.Point(1,1);/**
     * The offset position of the image that is being tiled
     *
     * @property tilePosition
     * @type Point
     */this.tilePosition=new PIXI.Point(0,0);/**
     * Whether this sprite is renderable or not
     *
     * @property renderable
     * @type Boolean
     * @default true
     */this.renderable=true;/**
     * The tint applied to the sprite. This is a hex value
     *
     * @property tint
     * @type Number
     * @default 0xFFFFFF
     */this.tint=0xFFFFFF;/**
     * The blend mode to be applied to the sprite
     *
     * @property blendMode
     * @type Number
     * @default PIXI.blendModes.NORMAL;
     */this.blendMode=PIXI.blendModes.NORMAL;};// constructor
PIXI.TilingSprite.prototype=Object.create(PIXI.Sprite.prototype);PIXI.TilingSprite.prototype.constructor=PIXI.TilingSprite;/**
 * The width of the sprite, setting this will actually modify the scale to achieve the value set
 *
 * @property width
 * @type Number
 */Object.defineProperty(PIXI.TilingSprite.prototype,'width',{get:function(){return this._width;},set:function(value){this._width=value;}});/**
 * The height of the TilingSprite, setting this will actually modify the scale to achieve the value set
 *
 * @property height
 * @type Number
 */Object.defineProperty(PIXI.TilingSprite.prototype,'height',{get:function(){return this._height;},set:function(value){this._height=value;}});PIXI.TilingSprite.prototype.setTexture=function(texture){if(this.texture===texture)return;this.texture=texture;this.refreshTexture=true;this.cachedTint=0xFFFFFF;};/**
* Renders the object using the WebGL renderer
*
* @method _renderWebGL
* @param renderSession {RenderSession}
* @private
*/PIXI.TilingSprite.prototype._renderWebGL=function(renderSession){if(this.visible===false||this.alpha===0)return;var i,j;if(this._mask){renderSession.spriteBatch.stop();renderSession.maskManager.pushMask(this.mask,renderSession);renderSession.spriteBatch.start();}if(this._filters){renderSession.spriteBatch.flush();renderSession.filterManager.pushFilter(this._filterBlock);}if(!this.tilingTexture||this.refreshTexture){this.generateTilingTexture(true);if(this.tilingTexture&&this.tilingTexture.needsUpdate){//TODO - tweaking
renderSession.renderer.updateTexture(this.tilingTexture.baseTexture);this.tilingTexture.needsUpdate=false;// this.tilingTexture._uvs = null;
}}else{renderSession.spriteBatch.renderTilingSprite(this);}// simple render children!
for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderWebGL(renderSession);}renderSession.spriteBatch.stop();if(this._filters)renderSession.filterManager.popFilter();if(this._mask)renderSession.maskManager.popMask(this._mask,renderSession);renderSession.spriteBatch.start();};/**
* Renders the object using the Canvas renderer
*
* @method _renderCanvas
* @param renderSession {RenderSession}
* @private
*/PIXI.TilingSprite.prototype._renderCanvas=function(renderSession){if(this.visible===false||this.alpha===0)return;var context=renderSession.context;if(this._mask){renderSession.maskManager.pushMask(this._mask,renderSession);}context.globalAlpha=this.worldAlpha;var transform=this.worldTransform;var i,j;var resolution=renderSession.resolution;context.setTransform(transform.a*resolution,transform.b*resolution,transform.c*resolution,transform.d*resolution,transform.tx*resolution,transform.ty*resolution);if(!this.__tilePattern||this.refreshTexture){this.generateTilingTexture(false);if(this.tilingTexture){this.__tilePattern=context.createPattern(this.tilingTexture.baseTexture.source,'repeat');}else{return;}}// check blend mode
if(this.blendMode!==renderSession.currentBlendMode){renderSession.currentBlendMode=this.blendMode;context.globalCompositeOperation=PIXI.blendModesCanvas[renderSession.currentBlendMode];}var tilePosition=this.tilePosition;var tileScale=this.tileScale;tilePosition.x%=this.tilingTexture.baseTexture.width;tilePosition.y%=this.tilingTexture.baseTexture.height;// offset - make sure to account for the anchor point..
context.scale(tileScale.x,tileScale.y);context.translate(tilePosition.x+this.anchor.x*-this._width,tilePosition.y+this.anchor.y*-this._height);context.fillStyle=this.__tilePattern;context.fillRect(-tilePosition.x,-tilePosition.y,this._width/tileScale.x,this._height/tileScale.y);context.scale(1/tileScale.x,1/tileScale.y);context.translate(-tilePosition.x+this.anchor.x*this._width,-tilePosition.y+this.anchor.y*this._height);if(this._mask){renderSession.maskManager.popMask(renderSession);}for(i=0,j=this.children.length;i<j;i++){this.children[i]._renderCanvas(renderSession);}};/**
* Returns the framing rectangle of the sprite as a PIXI.Rectangle object
*
* @method getBounds
* @return {Rectangle} the framing rectangle
*/PIXI.TilingSprite.prototype.getBounds=function(){var width=this._width;var height=this._height;var w0=width*(1-this.anchor.x);var w1=width*-this.anchor.x;var h0=height*(1-this.anchor.y);var h1=height*-this.anchor.y;var worldTransform=this.worldTransform;var a=worldTransform.a;var b=worldTransform.b;var c=worldTransform.c;var d=worldTransform.d;var tx=worldTransform.tx;var ty=worldTransform.ty;var x1=a*w1+c*h1+tx;var y1=d*h1+b*w1+ty;var x2=a*w0+c*h1+tx;var y2=d*h1+b*w0+ty;var x3=a*w0+c*h0+tx;var y3=d*h0+b*w0+ty;var x4=a*w1+c*h0+tx;var y4=d*h0+b*w1+ty;var maxX=-Infinity;var maxY=-Infinity;var minX=Infinity;var minY=Infinity;minX=x1<minX?x1:minX;minX=x2<minX?x2:minX;minX=x3<minX?x3:minX;minX=x4<minX?x4:minX;minY=y1<minY?y1:minY;minY=y2<minY?y2:minY;minY=y3<minY?y3:minY;minY=y4<minY?y4:minY;maxX=x1>maxX?x1:maxX;maxX=x2>maxX?x2:maxX;maxX=x3>maxX?x3:maxX;maxX=x4>maxX?x4:maxX;maxY=y1>maxY?y1:maxY;maxY=y2>maxY?y2:maxY;maxY=y3>maxY?y3:maxY;maxY=y4>maxY?y4:maxY;var bounds=this._bounds;bounds.x=minX;bounds.width=maxX-minX;bounds.y=minY;bounds.height=maxY-minY;// store a reference so that if this function gets called again in the render cycle we do not have to recalculate
this._currentBounds=bounds;return bounds;};/**
 * When the texture is updated, this event will fire to update the scale and frame
 *
 * @method onTextureUpdate
 * @param event
 * @private
 */PIXI.TilingSprite.prototype.onTextureUpdate=function(){// overriding the sprite version of this!
};/**
*
* @method generateTilingTexture
*
* @param forcePowerOfTwo {Boolean} Whether we want to force the texture to be a power of two
*/PIXI.TilingSprite.prototype.generateTilingTexture=function(forcePowerOfTwo){if(!this.texture.baseTexture.hasLoaded)return;var texture=this.originalTexture||this.texture;var frame=texture.frame;var targetWidth,targetHeight;//  Check that the frame is the same size as the base texture.
var isFrame=frame.width!==texture.baseTexture.width||frame.height!==texture.baseTexture.height;var newTextureRequired=false;if(!forcePowerOfTwo){if(isFrame){if(texture.trim){targetWidth=texture.trim.width;targetHeight=texture.trim.height;}else{targetWidth=frame.width;targetHeight=frame.height;}newTextureRequired=true;}}else{targetWidth=PIXI.getNextPowerOfTwo(frame.width);targetHeight=PIXI.getNextPowerOfTwo(frame.height);//  If the BaseTexture dimensions don't match the texture frame then we need a new texture anyway because it's part of a texture atlas
if(frame.width!==targetWidth||frame.height!==targetHeight||texture.baseTexture.width!==targetWidth||texture.baseTexture.height||targetHeight)newTextureRequired=true;}if(newTextureRequired){var canvasBuffer;if(this.tilingTexture&&this.tilingTexture.isTiling){canvasBuffer=this.tilingTexture.canvasBuffer;canvasBuffer.resize(targetWidth,targetHeight);this.tilingTexture.baseTexture.width=targetWidth;this.tilingTexture.baseTexture.height=targetHeight;this.tilingTexture.needsUpdate=true;}else{canvasBuffer=new PIXI.CanvasBuffer(targetWidth,targetHeight);this.tilingTexture=PIXI.Texture.fromCanvas(canvasBuffer.canvas);this.tilingTexture.canvasBuffer=canvasBuffer;this.tilingTexture.isTiling=true;}canvasBuffer.context.drawImage(texture.baseTexture.source,texture.crop.x,texture.crop.y,texture.crop.width,texture.crop.height,0,0,targetWidth,targetHeight);this.tileScaleOffset.x=frame.width/targetWidth;this.tileScaleOffset.y=frame.height/targetHeight;}else{//  TODO - switching?
if(this.tilingTexture&&this.tilingTexture.isTiling){// destroy the tiling texture!
// TODO could store this somewhere?
this.tilingTexture.destroy(true);}this.tileScaleOffset.x=1;this.tileScaleOffset.y=1;this.tilingTexture=texture;}this.refreshTexture=false;this.originalTexture=this.texture;this.texture=this.tilingTexture;this.tilingTexture.baseTexture._powerOf2=true;};PIXI.TilingSprite.prototype.destroy=function(){PIXI.Sprite.prototype.destroy.call(this);this.tileScale=null;this.tileScaleOffset=null;this.tilePosition=null;if(this.tilingTexture){this.tilingTexture.destroy(true);this.tilingTexture=null;}};/******************************************************************************
 * Spine Runtimes Software License
 * Version 2.1
 *
 * Copyright (c) 2013, Esoteric Software
 * All rights reserved.
 *
 * You are granted a perpetual, non-exclusive, non-sublicensable and
 * non-transferable license to install, execute and perform the Spine Runtimes
 * Software (the "Software") solely for internal use. Without the written
 * permission of Esoteric Software (typically granted by licensing Spine), you
 * may not (a) modify, translate, adapt or otherwise create derivative works,
 * improvements of the Software or develop new applications using the Software
 * or (b) remove, delete, alter or obscure any trademarks or any copyright,
 * trademark, patent or other intellectual property or proprietary rights
 * notices on or in the Software, including any copy thereof. Redistributions
 * in binary or source form must include this license and terms.
 *
 * THIS SOFTWARE IS PROVIDED BY ESOTERIC SOFTWARE "AS IS" AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO
 * EVENT SHALL ESOTERIC SOFTARE BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
 * OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
 * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
 * OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *****************************************************************************/var spine={radDeg:180/Math.PI,degRad:Math.PI/180,temp:[],Float32Array:typeof Float32Array==='undefined'?Array:Float32Array,Uint16Array:typeof Uint16Array==='undefined'?Array:Uint16Array};spine.BoneData=function(name,parent){this.name=name;this.parent=parent;};spine.BoneData.prototype={length:0,x:0,y:0,rotation:0,scaleX:1,scaleY:1,inheritScale:true,inheritRotation:true,flipX:false,flipY:false};spine.SlotData=function(name,boneData){this.name=name;this.boneData=boneData;};spine.SlotData.prototype={r:1,g:1,b:1,a:1,attachmentName:null,additiveBlending:false};spine.IkConstraintData=function(name){this.name=name;this.bones=[];};spine.IkConstraintData.prototype={target:null,bendDirection:1,mix:1};spine.Bone=function(boneData,skeleton,parent){this.data=boneData;this.skeleton=skeleton;this.parent=parent;this.setToSetupPose();};spine.Bone.yDown=false;spine.Bone.prototype={x:0,y:0,rotation:0,rotationIK:0,scaleX:1,scaleY:1,flipX:false,flipY:false,m00:0,m01:0,worldX:0,// a b x
m10:0,m11:0,worldY:0,// c d y
worldRotation:0,worldScaleX:1,worldScaleY:1,worldFlipX:false,worldFlipY:false,updateWorldTransform:function(){var parent=this.parent;if(parent){this.worldX=this.x*parent.m00+this.y*parent.m01+parent.worldX;this.worldY=this.x*parent.m10+this.y*parent.m11+parent.worldY;if(this.data.inheritScale){this.worldScaleX=parent.worldScaleX*this.scaleX;this.worldScaleY=parent.worldScaleY*this.scaleY;}else{this.worldScaleX=this.scaleX;this.worldScaleY=this.scaleY;}this.worldRotation=this.data.inheritRotation?parent.worldRotation+this.rotationIK:this.rotationIK;this.worldFlipX=parent.worldFlipX!=this.flipX;this.worldFlipY=parent.worldFlipY!=this.flipY;}else{var skeletonFlipX=this.skeleton.flipX,skeletonFlipY=this.skeleton.flipY;this.worldX=skeletonFlipX?-this.x:this.x;this.worldY=skeletonFlipY!=spine.Bone.yDown?-this.y:this.y;this.worldScaleX=this.scaleX;this.worldScaleY=this.scaleY;this.worldRotation=this.rotationIK;this.worldFlipX=skeletonFlipX!=this.flipX;this.worldFlipY=skeletonFlipY!=this.flipY;}var radians=this.worldRotation*spine.degRad;var cos=Math.cos(radians);var sin=Math.sin(radians);if(this.worldFlipX){this.m00=-cos*this.worldScaleX;this.m01=sin*this.worldScaleY;}else{this.m00=cos*this.worldScaleX;this.m01=-sin*this.worldScaleY;}if(this.worldFlipY!=spine.Bone.yDown){this.m10=-sin*this.worldScaleX;this.m11=-cos*this.worldScaleY;}else{this.m10=sin*this.worldScaleX;this.m11=cos*this.worldScaleY;}},setToSetupPose:function(){var data=this.data;this.x=data.x;this.y=data.y;this.rotation=data.rotation;this.rotationIK=this.rotation;this.scaleX=data.scaleX;this.scaleY=data.scaleY;this.flipX=data.flipX;this.flipY=data.flipY;},worldToLocal:function(world){var dx=world[0]-this.worldX,dy=world[1]-this.worldY;var m00=this.m00,m10=this.m10,m01=this.m01,m11=this.m11;if(this.worldFlipX!=(this.worldFlipY!=spine.Bone.yDown)){m00=-m00;m11=-m11;}var invDet=1/(m00*m11-m01*m10);world[0]=dx*m00*invDet-dy*m01*invDet;world[1]=dy*m11*invDet-dx*m10*invDet;},localToWorld:function(local){var localX=local[0],localY=local[1];local[0]=localX*this.m00+localY*this.m01+this.worldX;local[1]=localX*this.m10+localY*this.m11+this.worldY;}};spine.Slot=function(slotData,bone){this.data=slotData;this.bone=bone;this.setToSetupPose();};spine.Slot.prototype={r:1,g:1,b:1,a:1,_attachmentTime:0,attachment:null,attachmentVertices:[],setAttachment:function(attachment){this.attachment=attachment;this._attachmentTime=this.bone.skeleton.time;this.attachmentVertices.length=0;},setAttachmentTime:function(time){this._attachmentTime=this.bone.skeleton.time-time;},getAttachmentTime:function(){return this.bone.skeleton.time-this._attachmentTime;},setToSetupPose:function(){var data=this.data;this.r=data.r;this.g=data.g;this.b=data.b;this.a=data.a;var slotDatas=this.bone.skeleton.data.slots;for(var i=0,n=slotDatas.length;i<n;i++){if(slotDatas[i]==data){this.setAttachment(!data.attachmentName?null:this.bone.skeleton.getAttachmentBySlotIndex(i,data.attachmentName));break;}}}};spine.IkConstraint=function(data,skeleton){this.data=data;this.mix=data.mix;this.bendDirection=data.bendDirection;this.bones=[];for(var i=0,n=data.bones.length;i<n;i++)this.bones.push(skeleton.findBone(data.bones[i].name));this.target=skeleton.findBone(data.target.name);};spine.IkConstraint.prototype={apply:function(){var target=this.target;var bones=this.bones;switch(bones.length){case 1:spine.IkConstraint.apply1(bones[0],target.worldX,target.worldY,this.mix);break;case 2:spine.IkConstraint.apply2(bones[0],bones[1],target.worldX,target.worldY,this.bendDirection,this.mix);break;}}};/** Adjusts the bone rotation so the tip is as close to the target position as possible. The target is specified in the world
 * coordinate system. */spine.IkConstraint.apply1=function(bone,targetX,targetY,alpha){var parentRotation=!bone.data.inheritRotation||!bone.parent?0:bone.parent.worldRotation;var rotation=bone.rotation;var rotationIK=Math.atan2(targetY-bone.worldY,targetX-bone.worldX)*spine.radDeg-parentRotation;bone.rotationIK=rotation+(rotationIK-rotation)*alpha;};/** Adjusts the parent and child bone rotations so the tip of the child is as close to the target position as possible. The
 * target is specified in the world coordinate system.
 * @param child Any descendant bone of the parent. */spine.IkConstraint.apply2=function(parent,child,targetX,targetY,bendDirection,alpha){var childRotation=child.rotation,parentRotation=parent.rotation;if(!alpha){child.rotationIK=childRotation;parent.rotationIK=parentRotation;return;}var positionX,positionY,tempPosition=spine.temp;var parentParent=parent.parent;if(parentParent){tempPosition[0]=targetX;tempPosition[1]=targetY;parentParent.worldToLocal(tempPosition);targetX=(tempPosition[0]-parent.x)*parentParent.worldScaleX;targetY=(tempPosition[1]-parent.y)*parentParent.worldScaleY;}else{targetX-=parent.x;targetY-=parent.y;}if(child.parent==parent){positionX=child.x;positionY=child.y;}else{tempPosition[0]=child.x;tempPosition[1]=child.y;child.parent.localToWorld(tempPosition);parent.worldToLocal(tempPosition);positionX=tempPosition[0];positionY=tempPosition[1];}var childX=positionX*parent.worldScaleX,childY=positionY*parent.worldScaleY;var offset=Math.atan2(childY,childX);var len1=Math.sqrt(childX*childX+childY*childY),len2=child.data.length*child.worldScaleX;// Based on code by Ryan Juckett with permission: Copyright (c) 2008-2009 Ryan Juckett, http://www.ryanjuckett.com/
var cosDenom=2*len1*len2;if(cosDenom<0.0001){child.rotationIK=childRotation+(Math.atan2(targetY,targetX)*spine.radDeg-parentRotation-childRotation)*alpha;return;}var cos=(targetX*targetX+targetY*targetY-len1*len1-len2*len2)/cosDenom;if(cos<-1)cos=-1;else if(cos>1)cos=1;var childAngle=Math.acos(cos)*bendDirection;var adjacent=len1+len2*cos,opposite=len2*Math.sin(childAngle);var parentAngle=Math.atan2(targetY*adjacent-targetX*opposite,targetX*adjacent+targetY*opposite);var rotation=(parentAngle-offset)*spine.radDeg-parentRotation;if(rotation>180)rotation-=360;else if(rotation<-180)//
rotation+=360;parent.rotationIK=parentRotation+rotation*alpha;rotation=(childAngle+offset)*spine.radDeg-childRotation;if(rotation>180)rotation-=360;else if(rotation<-180)//
rotation+=360;child.rotationIK=childRotation+(rotation+parent.worldRotation-child.parent.worldRotation)*alpha;};spine.Skin=function(name){this.name=name;this.attachments={};};spine.Skin.prototype={addAttachment:function(slotIndex,name,attachment){this.attachments[slotIndex+":"+name]=attachment;},getAttachment:function(slotIndex,name){return this.attachments[slotIndex+":"+name];},_attachAll:function(skeleton,oldSkin){for(var key in oldSkin.attachments){var colon=key.indexOf(":");var slotIndex=parseInt(key.substring(0,colon));var name=key.substring(colon+1);var slot=skeleton.slots[slotIndex];if(slot.attachment&&slot.attachment.name==name){var attachment=this.getAttachment(slotIndex,name);if(attachment)slot.setAttachment(attachment);}}}};spine.Animation=function(name,timelines,duration){this.name=name;this.timelines=timelines;this.duration=duration;};spine.Animation.prototype={apply:function(skeleton,lastTime,time,loop,events){if(loop&&this.duration!=0){time%=this.duration;lastTime%=this.duration;}var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,lastTime,time,events,1);},mix:function(skeleton,lastTime,time,loop,events,alpha){if(loop&&this.duration!=0){time%=this.duration;lastTime%=this.duration;}var timelines=this.timelines;for(var i=0,n=timelines.length;i<n;i++)timelines[i].apply(skeleton,lastTime,time,events,alpha);}};spine.Animation.binarySearch=function(values,target,step){var low=0;var high=Math.floor(values.length/step)-2;if(!high)return step;var current=high>>>1;while(true){if(values[(current+1)*step]<=target)low=current+1;else high=current;if(low==high)return(low+1)*step;current=low+high>>>1;}};spine.Animation.binarySearch1=function(values,target){var low=0;var high=values.length-2;if(!high)return 1;var current=high>>>1;while(true){if(values[current+1]<=target)low=current+1;else high=current;if(low==high)return low+1;current=low+high>>>1;}};spine.Animation.linearSearch=function(values,target,step){for(var i=0,last=values.length-step;i<=last;i+=step)if(values[i]>target)return i;return-1;};spine.Curves=function(frameCount){this.curves=[];// type, x, y, ...
//this.curves.length = (frameCount - 1) * 19/*BEZIER_SIZE*/;
};spine.Curves.prototype={setLinear:function(frameIndex){this.curves[frameIndex*19/*BEZIER_SIZE*/]=0/*LINEAR*/;},setStepped:function(frameIndex){this.curves[frameIndex*19/*BEZIER_SIZE*/]=1/*STEPPED*/;},/** Sets the control handle positions for an interpolation bezier curve used to transition from this keyframe to the next.
	 * cx1 and cx2 are from 0 to 1, representing the percent of time between the two keyframes. cy1 and cy2 are the percent of
	 * the difference between the keyframe's values. */setCurve:function(frameIndex,cx1,cy1,cx2,cy2){var subdiv1=1/10/*BEZIER_SEGMENTS*/,subdiv2=subdiv1*subdiv1,subdiv3=subdiv2*subdiv1;var pre1=3*subdiv1,pre2=3*subdiv2,pre4=6*subdiv2,pre5=6*subdiv3;var tmp1x=-cx1*2+cx2,tmp1y=-cy1*2+cy2,tmp2x=(cx1-cx2)*3+1,tmp2y=(cy1-cy2)*3+1;var dfx=cx1*pre1+tmp1x*pre2+tmp2x*subdiv3,dfy=cy1*pre1+tmp1y*pre2+tmp2y*subdiv3;var ddfx=tmp1x*pre4+tmp2x*pre5,ddfy=tmp1y*pre4+tmp2y*pre5;var dddfx=tmp2x*pre5,dddfy=tmp2y*pre5;var i=frameIndex*19/*BEZIER_SIZE*/;var curves=this.curves;curves[i++]=2/*BEZIER*/;var x=dfx,y=dfy;for(var n=i+19/*BEZIER_SIZE*/-1;i<n;i+=2){curves[i]=x;curves[i+1]=y;dfx+=ddfx;dfy+=ddfy;ddfx+=dddfx;ddfy+=dddfy;x+=dfx;y+=dfy;}},getCurvePercent:function(frameIndex,percent){percent=percent<0?0:percent>1?1:percent;var curves=this.curves;var i=frameIndex*19/*BEZIER_SIZE*/;var type=curves[i];if(type===0/*LINEAR*/)return percent;if(type==1/*STEPPED*/)return 0;i++;var x=0;for(var start=i,n=i+19/*BEZIER_SIZE*/-1;i<n;i+=2){x=curves[i];if(x>=percent){var prevX,prevY;if(i==start){prevX=0;prevY=0;}else{prevX=curves[i-2];prevY=curves[i-1];}return prevY+(curves[i+1]-prevY)*(percent-prevX)/(x-prevX);}}var y=curves[i-1];return y+(1-y)*(percent-x)/(1-x);// Last point is 1,1.
}};spine.RotateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, angle, ...
this.frames.length=frameCount*2;};spine.RotateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2;},setFrame:function(frameIndex,time,angle){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=angle;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-2]){// Time is after last frame.
var amount=bone.data.rotation+frames[frames.length-1]-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha;return;}// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch(frames,time,2);var prevFrameValue=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-2/*PREV_FRAME_TIME*/]-frameTime);percent=this.curves.getCurvePercent(frameIndex/2-1,percent);var amount=frames[frameIndex+1/*FRAME_VALUE*/]-prevFrameValue;while(amount>180)amount-=360;while(amount<-180)amount+=360;amount=bone.data.rotation+(prevFrameValue+amount*percent)-bone.rotation;while(amount>180)amount-=360;while(amount<-180)amount+=360;bone.rotation+=amount*alpha;}};spine.TranslateTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, x, y, ...
this.frames.length=frameCount*3;};spine.TranslateTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3;},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){// Time is after last frame.
bone.x+=(bone.data.x+frames[frames.length-2]-bone.x)*alpha;bone.y+=(bone.data.y+frames[frames.length-1]-bone.y)*alpha;return;}// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameX=frames[frameIndex-2];var prevFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3/*PREV_FRAME_TIME*/]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.x+=(bone.data.x+prevFrameX+(frames[frameIndex+1/*FRAME_X*/]-prevFrameX)*percent-bone.x)*alpha;bone.y+=(bone.data.y+prevFrameY+(frames[frameIndex+2/*FRAME_Y*/]-prevFrameY)*percent-bone.y)*alpha;}};spine.ScaleTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, x, y, ...
this.frames.length=frameCount*3;};spine.ScaleTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/3;},setFrame:function(frameIndex,time,x,y){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=x;this.frames[frameIndex+2]=y;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var bone=skeleton.bones[this.boneIndex];if(time>=frames[frames.length-3]){// Time is after last frame.
bone.scaleX+=(bone.data.scaleX*frames[frames.length-2]-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY*frames[frames.length-1]-bone.scaleY)*alpha;return;}// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameX=frames[frameIndex-2];var prevFrameY=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3/*PREV_FRAME_TIME*/]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);bone.scaleX+=(bone.data.scaleX*(prevFrameX+(frames[frameIndex+1/*FRAME_X*/]-prevFrameX)*percent)-bone.scaleX)*alpha;bone.scaleY+=(bone.data.scaleY*(prevFrameY+(frames[frameIndex+2/*FRAME_Y*/]-prevFrameY)*percent)-bone.scaleY)*alpha;}};spine.ColorTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, r, g, b, a, ...
this.frames.length=frameCount*5;};spine.ColorTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length/5;},setFrame:function(frameIndex,time,r,g,b,a){frameIndex*=5;this.frames[frameIndex]=time;this.frames[frameIndex+1]=r;this.frames[frameIndex+2]=g;this.frames[frameIndex+3]=b;this.frames[frameIndex+4]=a;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var r,g,b,a;if(time>=frames[frames.length-5]){// Time is after last frame.
var i=frames.length-1;r=frames[i-3];g=frames[i-2];b=frames[i-1];a=frames[i];}else{// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch(frames,time,5);var prevFrameR=frames[frameIndex-4];var prevFrameG=frames[frameIndex-3];var prevFrameB=frames[frameIndex-2];var prevFrameA=frames[frameIndex-1];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-5/*PREV_FRAME_TIME*/]-frameTime);percent=this.curves.getCurvePercent(frameIndex/5-1,percent);r=prevFrameR+(frames[frameIndex+1/*FRAME_R*/]-prevFrameR)*percent;g=prevFrameG+(frames[frameIndex+2/*FRAME_G*/]-prevFrameG)*percent;b=prevFrameB+(frames[frameIndex+3/*FRAME_B*/]-prevFrameB)*percent;a=prevFrameA+(frames[frameIndex+4/*FRAME_A*/]-prevFrameA)*percent;}var slot=skeleton.slots[this.slotIndex];if(alpha<1){slot.r+=(r-slot.r)*alpha;slot.g+=(g-slot.g)*alpha;slot.b+=(b-slot.b)*alpha;slot.a+=(a-slot.a)*alpha;}else{slot.r=r;slot.g=g;slot.b=b;slot.a=a;}}};spine.AttachmentTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, ...
this.frames.length=frameCount;this.attachmentNames=[];this.attachmentNames.length=frameCount;};spine.AttachmentTimeline.prototype={slotIndex:0,getFrameCount:function(){return this.frames.length;},setFrame:function(frameIndex,time,attachmentName){this.frames[frameIndex]=time;this.attachmentNames[frameIndex]=attachmentName;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return;}else if(lastTime>time)//
lastTime=-1;var frameIndex=time>=frames[frames.length-1]?frames.length-1:spine.Animation.binarySearch1(frames,time)-1;if(frames[frameIndex]<lastTime)return;var attachmentName=this.attachmentNames[frameIndex];skeleton.slots[this.slotIndex].setAttachment(!attachmentName?null:skeleton.getAttachmentBySlotIndex(this.slotIndex,attachmentName));}};spine.EventTimeline=function(frameCount){this.frames=[];// time, ...
this.frames.length=frameCount;this.events=[];this.events.length=frameCount;};spine.EventTimeline.prototype={getFrameCount:function(){return this.frames.length;},setFrame:function(frameIndex,time,event){this.frames[frameIndex]=time;this.events[frameIndex]=event;},/** Fires events for frames > lastTime and <= time. */apply:function(skeleton,lastTime,time,firedEvents,alpha){if(!firedEvents)return;var frames=this.frames;var frameCount=frames.length;if(lastTime>time){// Fire events after last time for looped animations.
this.apply(skeleton,lastTime,Number.MAX_VALUE,firedEvents,alpha);lastTime=-1;}else if(lastTime>=frames[frameCount-1])// Last time is after last frame.
return;if(time<frames[0])return;// Time is before first frame.
var frameIndex;if(lastTime<frames[0])frameIndex=0;else{frameIndex=spine.Animation.binarySearch1(frames,lastTime);var frame=frames[frameIndex];while(frameIndex>0){// Fire multiple events with the same frame.
if(frames[frameIndex-1]!=frame)break;frameIndex--;}}var events=this.events;for(;frameIndex<frameCount&&time>=frames[frameIndex];frameIndex++)firedEvents.push(events[frameIndex]);}};spine.DrawOrderTimeline=function(frameCount){this.frames=[];// time, ...
this.frames.length=frameCount;this.drawOrders=[];this.drawOrders.length=frameCount;};spine.DrawOrderTimeline.prototype={getFrameCount:function(){return this.frames.length;},setFrame:function(frameIndex,time,drawOrder){this.frames[frameIndex]=time;this.drawOrders[frameIndex]=drawOrder;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var frameIndex;if(time>=frames[frames.length-1])// Time is after last frame.
frameIndex=frames.length-1;else frameIndex=spine.Animation.binarySearch1(frames,time)-1;var drawOrder=skeleton.drawOrder;var slots=skeleton.slots;var drawOrderToSetupIndex=this.drawOrders[frameIndex];if(drawOrderToSetupIndex){for(var i=0,n=drawOrderToSetupIndex.length;i<n;i++)drawOrder[i]=drawOrderToSetupIndex[i];}}};spine.FfdTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];this.frames.length=frameCount;this.frameVertices=[];this.frameVertices.length=frameCount;};spine.FfdTimeline.prototype={slotIndex:0,attachment:0,getFrameCount:function(){return this.frames.length;},setFrame:function(frameIndex,time,vertices){this.frames[frameIndex]=time;this.frameVertices[frameIndex]=vertices;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var slot=skeleton.slots[this.slotIndex];if(slot.attachment!=this.attachment)return;var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var frameVertices=this.frameVertices;var vertexCount=frameVertices[0].length;var vertices=slot.attachmentVertices;if(vertices.length!=vertexCount)alpha=1;vertices.length=vertexCount;if(time>=frames[frames.length-1]){// Time is after last frame.
var lastVertices=frameVertices[frames.length-1];if(alpha<1){for(var i=0;i<vertexCount;i++)vertices[i]+=(lastVertices[i]-vertices[i])*alpha;}else{for(var i=0;i<vertexCount;i++)vertices[i]=lastVertices[i];}return;}// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch1(frames,time);var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex-1]-frameTime);percent=this.curves.getCurvePercent(frameIndex-1,percent<0?0:percent>1?1:percent);var prevVertices=frameVertices[frameIndex-1];var nextVertices=frameVertices[frameIndex];if(alpha<1){for(var i=0;i<vertexCount;i++){var prev=prevVertices[i];vertices[i]+=(prev+(nextVertices[i]-prev)*percent-vertices[i])*alpha;}}else{for(var i=0;i<vertexCount;i++){var prev=prevVertices[i];vertices[i]=prev+(nextVertices[i]-prev)*percent;}}}};spine.IkConstraintTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, mix, bendDirection, ...
this.frames.length=frameCount*3;};spine.IkConstraintTimeline.prototype={ikConstraintIndex:0,getFrameCount:function(){return this.frames.length/3;},setFrame:function(frameIndex,time,mix,bendDirection){frameIndex*=3;this.frames[frameIndex]=time;this.frames[frameIndex+1]=mix;this.frames[frameIndex+2]=bendDirection;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0])return;// Time is before first frame.
var ikConstraint=skeleton.ikConstraints[this.ikConstraintIndex];if(time>=frames[frames.length-3]){// Time is after last frame.
ikConstraint.mix+=(frames[frames.length-2]-ikConstraint.mix)*alpha;ikConstraint.bendDirection=frames[frames.length-1];return;}// Interpolate between the previous frame and the current frame.
var frameIndex=spine.Animation.binarySearch(frames,time,3);var prevFrameMix=frames[frameIndex+-2/*PREV_FRAME_MIX*/];var frameTime=frames[frameIndex];var percent=1-(time-frameTime)/(frames[frameIndex+-3/*PREV_FRAME_TIME*/]-frameTime);percent=this.curves.getCurvePercent(frameIndex/3-1,percent);var mix=prevFrameMix+(frames[frameIndex+1/*FRAME_MIX*/]-prevFrameMix)*percent;ikConstraint.mix+=(mix-ikConstraint.mix)*alpha;ikConstraint.bendDirection=frames[frameIndex+-1/*PREV_FRAME_BEND_DIRECTION*/];}};spine.FlipXTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, flip, ...
this.frames.length=frameCount*2;};spine.FlipXTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2;},setFrame:function(frameIndex,time,flip){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=flip?1:0;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return;}else if(lastTime>time)//
lastTime=-1;var frameIndex=(time>=frames[frames.length-2]?frames.length:spine.Animation.binarySearch(frames,time,2))-2;if(frames[frameIndex]<lastTime)return;skeleton.bones[boneIndex].flipX=frames[frameIndex+1]!=0;}};spine.FlipYTimeline=function(frameCount){this.curves=new spine.Curves(frameCount);this.frames=[];// time, flip, ...
this.frames.length=frameCount*2;};spine.FlipYTimeline.prototype={boneIndex:0,getFrameCount:function(){return this.frames.length/2;},setFrame:function(frameIndex,time,flip){frameIndex*=2;this.frames[frameIndex]=time;this.frames[frameIndex+1]=flip?1:0;},apply:function(skeleton,lastTime,time,firedEvents,alpha){var frames=this.frames;if(time<frames[0]){if(lastTime>time)this.apply(skeleton,lastTime,Number.MAX_VALUE,null,0);return;}else if(lastTime>time)//
lastTime=-1;var frameIndex=(time>=frames[frames.length-2]?frames.length:spine.Animation.binarySearch(frames,time,2))-2;if(frames[frameIndex]<lastTime)return;skeleton.bones[boneIndex].flipY=frames[frameIndex+1]!=0;}};spine.SkeletonData=function(){this.bones=[];this.slots=[];this.skins=[];this.events=[];this.animations=[];this.ikConstraints=[];};spine.SkeletonData.prototype={name:null,defaultSkin:null,width:0,height:0,version:null,hash:null,/** @return May be null. */findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return bones[i];return null;},/** @return -1 if the bone was not found. */findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].name==boneName)return i;return-1;},/** @return May be null. */findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){if(slots[i].name==slotName)return slot[i];}return null;},/** @return -1 if the bone was not found. */findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].name==slotName)return i;return-1;},/** @return May be null. */findSkin:function(skinName){var skins=this.skins;for(var i=0,n=skins.length;i<n;i++)if(skins[i].name==skinName)return skins[i];return null;},/** @return May be null. */findEvent:function(eventName){var events=this.events;for(var i=0,n=events.length;i<n;i++)if(events[i].name==eventName)return events[i];return null;},/** @return May be null. */findAnimation:function(animationName){var animations=this.animations;for(var i=0,n=animations.length;i<n;i++)if(animations[i].name==animationName)return animations[i];return null;},/** @return May be null. */findIkConstraint:function(ikConstraintName){var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++)if(ikConstraints[i].name==ikConstraintName)return ikConstraints[i];return null;}};spine.Skeleton=function(skeletonData){this.data=skeletonData;this.bones=[];for(var i=0,n=skeletonData.bones.length;i<n;i++){var boneData=skeletonData.bones[i];var parent=!boneData.parent?null:this.bones[skeletonData.bones.indexOf(boneData.parent)];this.bones.push(new spine.Bone(boneData,this,parent));}this.slots=[];this.drawOrder=[];for(var i=0,n=skeletonData.slots.length;i<n;i++){var slotData=skeletonData.slots[i];var bone=this.bones[skeletonData.bones.indexOf(slotData.boneData)];var slot=new spine.Slot(slotData,bone);this.slots.push(slot);this.drawOrder.push(i);}this.ikConstraints=[];for(var i=0,n=skeletonData.ikConstraints.length;i<n;i++)this.ikConstraints.push(new spine.IkConstraint(skeletonData.ikConstraints[i],this));this.boneCache=[];this.updateCache();};spine.Skeleton.prototype={x:0,y:0,skin:null,r:1,g:1,b:1,a:1,time:0,flipX:false,flipY:false,/** Caches information about bones and IK constraints. Must be called if bones or IK constraints are added or removed. */updateCache:function(){var ikConstraints=this.ikConstraints;var ikConstraintsCount=ikConstraints.length;var arrayCount=ikConstraintsCount+1;var boneCache=this.boneCache;if(boneCache.length>arrayCount)boneCache.length=arrayCount;for(var i=0,n=boneCache.length;i<n;i++)boneCache[i].length=0;while(boneCache.length<arrayCount)boneCache[boneCache.length]=[];var nonIkBones=boneCache[0];var bones=this.bones;outer:for(var i=0,n=bones.length;i<n;i++){var bone=bones[i];var current=bone;do{for(var ii=0;ii<ikConstraintsCount;ii++){var ikConstraint=ikConstraints[ii];var parent=ikConstraint.bones[0];var child=ikConstraint.bones[ikConstraint.bones.length-1];while(true){if(current==child){boneCache[ii].push(bone);boneCache[ii+1].push(bone);continue outer;}if(child==parent)break;child=child.parent;}}current=current.parent;}while(current);nonIkBones[nonIkBones.length]=bone;}},/** Updates the world transform for each bone. */updateWorldTransform:function(){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++){var bone=bones[i];bone.rotationIK=bone.rotation;}var i=0,last=this.boneCache.length-1;while(true){var cacheBones=this.boneCache[i];for(var ii=0,nn=cacheBones.length;ii<nn;ii++)cacheBones[ii].updateWorldTransform();if(i==last)break;this.ikConstraints[i].apply();i++;}},/** Sets the bones and slots to their setup pose values. */setToSetupPose:function(){this.setBonesToSetupPose();this.setSlotsToSetupPose();},setBonesToSetupPose:function(){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)bones[i].setToSetupPose();var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++){var ikConstraint=ikConstraints[i];ikConstraint.bendDirection=ikConstraint.data.bendDirection;ikConstraint.mix=ikConstraint.data.mix;}},setSlotsToSetupPose:function(){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){slots[i].setToSetupPose(i);}this.resetDrawOrder();},/** @return May return null. */getRootBone:function(){return this.bones.length?this.bones[0]:null;},/** @return May be null. */findBone:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return bones[i];return null;},/** @return -1 if the bone was not found. */findBoneIndex:function(boneName){var bones=this.bones;for(var i=0,n=bones.length;i<n;i++)if(bones[i].data.name==boneName)return i;return-1;},/** @return May be null. */findSlot:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return slots[i];return null;},/** @return -1 if the bone was not found. */findSlotIndex:function(slotName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++)if(slots[i].data.name==slotName)return i;return-1;},setSkinByName:function(skinName){var skin=this.data.findSkin(skinName);if(!skin)throw"Skin not found: "+skinName;this.setSkin(skin);},/** Sets the skin used to look up attachments before looking in the {@link SkeletonData#getDefaultSkin() default skin}.
	 * Attachments from the new skin are attached if the corresponding attachment from the old skin was attached. If there was
	 * no old skin, each slot's setup mode attachment is attached from the new skin.
	 * @param newSkin May be null. */setSkin:function(newSkin){if(newSkin){if(this.skin)newSkin._attachAll(this,this.skin);else{var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){var slot=slots[i];var name=slot.data.attachmentName;if(name){var attachment=newSkin.getAttachment(i,name);if(attachment)slot.setAttachment(attachment);}}}}this.skin=newSkin;},/** @return May be null. */getAttachmentBySlotName:function(slotName,attachmentName){return this.getAttachmentBySlotIndex(this.data.findSlotIndex(slotName),attachmentName);},/** @return May be null. */getAttachmentBySlotIndex:function(slotIndex,attachmentName){if(this.skin){var attachment=this.skin.getAttachment(slotIndex,attachmentName);if(attachment)return attachment;}if(this.data.defaultSkin)return this.data.defaultSkin.getAttachment(slotIndex,attachmentName);return null;},/** @param attachmentName May be null. */setAttachment:function(slotName,attachmentName){var slots=this.slots;for(var i=0,n=slots.length;i<n;i++){var slot=slots[i];if(slot.data.name==slotName){var attachment=null;if(attachmentName){attachment=this.getAttachmentBySlotIndex(i,attachmentName);if(!attachment)throw"Attachment not found: "+attachmentName+", for slot: "+slotName;}slot.setAttachment(attachment);return;}}throw"Slot not found: "+slotName;},/** @return May be null. */findIkConstraint:function(ikConstraintName){var ikConstraints=this.ikConstraints;for(var i=0,n=ikConstraints.length;i<n;i++)if(ikConstraints[i].data.name==ikConstraintName)return ikConstraints[i];return null;},update:function(delta){this.time+=delta;},resetDrawOrder:function(){for(var i=0,n=this.drawOrder.length;i<n;i++)this.drawOrder[i]=i;}};spine.EventData=function(name){this.name=name;};spine.EventData.prototype={intValue:0,floatValue:0,stringValue:null};spine.Event=function(data){this.data=data;};spine.Event.prototype={intValue:0,floatValue:0,stringValue:null};spine.AttachmentType={region:0,boundingbox:1,mesh:2,skinnedmesh:3};spine.RegionAttachment=function(name){this.name=name;this.offset=[];this.offset.length=8;this.uvs=[];this.uvs.length=8;};spine.RegionAttachment.prototype={type:spine.AttachmentType.region,x:0,y:0,rotation:0,scaleX:1,scaleY:1,width:0,height:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,setUVs:function(u,v,u2,v2,rotate){var uvs=this.uvs;if(rotate){uvs[2/*X2*/]=u;uvs[3/*Y2*/]=v2;uvs[4/*X3*/]=u;uvs[5/*Y3*/]=v;uvs[6/*X4*/]=u2;uvs[7/*Y4*/]=v;uvs[0/*X1*/]=u2;uvs[1/*Y1*/]=v2;}else{uvs[0/*X1*/]=u;uvs[1/*Y1*/]=v2;uvs[2/*X2*/]=u;uvs[3/*Y2*/]=v;uvs[4/*X3*/]=u2;uvs[5/*Y3*/]=v;uvs[6/*X4*/]=u2;uvs[7/*Y4*/]=v2;}},updateOffset:function(){var regionScaleX=this.width/this.regionOriginalWidth*this.scaleX;var regionScaleY=this.height/this.regionOriginalHeight*this.scaleY;var localX=-this.width/2*this.scaleX+this.regionOffsetX*regionScaleX;var localY=-this.height/2*this.scaleY+this.regionOffsetY*regionScaleY;var localX2=localX+this.regionWidth*regionScaleX;var localY2=localY+this.regionHeight*regionScaleY;var radians=this.rotation*spine.degRad;var cos=Math.cos(radians);var sin=Math.sin(radians);var localXCos=localX*cos+this.x;var localXSin=localX*sin;var localYCos=localY*cos+this.y;var localYSin=localY*sin;var localX2Cos=localX2*cos+this.x;var localX2Sin=localX2*sin;var localY2Cos=localY2*cos+this.y;var localY2Sin=localY2*sin;var offset=this.offset;offset[0/*X1*/]=localXCos-localYSin;offset[1/*Y1*/]=localYCos+localXSin;offset[2/*X2*/]=localXCos-localY2Sin;offset[3/*Y2*/]=localY2Cos+localXSin;offset[4/*X3*/]=localX2Cos-localY2Sin;offset[5/*Y3*/]=localY2Cos+localX2Sin;offset[6/*X4*/]=localX2Cos-localYSin;offset[7/*Y4*/]=localYCos+localX2Sin;},computeVertices:function(x,y,bone,vertices){x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var offset=this.offset;vertices[0/*X1*/]=offset[0/*X1*/]*m00+offset[1/*Y1*/]*m01+x;vertices[1/*Y1*/]=offset[0/*X1*/]*m10+offset[1/*Y1*/]*m11+y;vertices[2/*X2*/]=offset[2/*X2*/]*m00+offset[3/*Y2*/]*m01+x;vertices[3/*Y2*/]=offset[2/*X2*/]*m10+offset[3/*Y2*/]*m11+y;vertices[4/*X3*/]=offset[4/*X3*/]*m00+offset[5/*X3*/]*m01+x;vertices[5/*X3*/]=offset[4/*X3*/]*m10+offset[5/*X3*/]*m11+y;vertices[6/*X4*/]=offset[6/*X4*/]*m00+offset[7/*Y4*/]*m01+x;vertices[7/*Y4*/]=offset[6/*X4*/]*m10+offset[7/*Y4*/]*m11+y;}};spine.MeshAttachment=function(name){this.name=name;};spine.MeshAttachment.prototype={type:spine.AttachmentType.mesh,vertices:null,uvs:null,regionUVs:null,triangles:null,hullLength:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionU:0,regionV:0,regionU2:0,regionV2:0,regionRotate:false,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,edges:null,width:0,height:0,updateUVs:function(){var width=this.regionU2-this.regionU,height=this.regionV2-this.regionV;var n=this.regionUVs.length;if(!this.uvs||this.uvs.length!=n){this.uvs=new spine.Float32Array(n);}if(this.regionRotate){for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i+1]*width;this.uvs[i+1]=this.regionV+height-this.regionUVs[i]*height;}}else{for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i]*width;this.uvs[i+1]=this.regionV+this.regionUVs[i+1]*height;}}},computeWorldVertices:function(x,y,slot,worldVertices){var bone=slot.bone;x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var vertices=this.vertices;var verticesCount=vertices.length;if(slot.attachmentVertices.length==verticesCount)vertices=slot.attachmentVertices;for(var i=0;i<verticesCount;i+=2){var vx=vertices[i];var vy=vertices[i+1];worldVertices[i]=vx*m00+vy*m01+x;worldVertices[i+1]=vx*m10+vy*m11+y;}}};spine.SkinnedMeshAttachment=function(name){this.name=name;};spine.SkinnedMeshAttachment.prototype={type:spine.AttachmentType.skinnedmesh,bones:null,weights:null,uvs:null,regionUVs:null,triangles:null,hullLength:0,r:1,g:1,b:1,a:1,path:null,rendererObject:null,regionU:0,regionV:0,regionU2:0,regionV2:0,regionRotate:false,regionOffsetX:0,regionOffsetY:0,regionWidth:0,regionHeight:0,regionOriginalWidth:0,regionOriginalHeight:0,edges:null,width:0,height:0,updateUVs:function(u,v,u2,v2,rotate){var width=this.regionU2-this.regionU,height=this.regionV2-this.regionV;var n=this.regionUVs.length;if(!this.uvs||this.uvs.length!=n){this.uvs=new spine.Float32Array(n);}if(this.regionRotate){for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i+1]*width;this.uvs[i+1]=this.regionV+height-this.regionUVs[i]*height;}}else{for(var i=0;i<n;i+=2){this.uvs[i]=this.regionU+this.regionUVs[i]*width;this.uvs[i+1]=this.regionV+this.regionUVs[i+1]*height;}}},computeWorldVertices:function(x,y,slot,worldVertices){var skeletonBones=slot.bone.skeleton.bones;var weights=this.weights;var bones=this.bones;var w=0,v=0,b=0,f=0,n=bones.length,nn;var wx,wy,bone,vx,vy,weight;if(!slot.attachmentVertices.length){for(;v<n;w+=2){wx=0;wy=0;nn=bones[v++]+v;for(;v<nn;v++,b+=3){bone=skeletonBones[bones[v]];vx=weights[b];vy=weights[b+1];weight=weights[b+2];wx+=(vx*bone.m00+vy*bone.m01+bone.worldX)*weight;wy+=(vx*bone.m10+vy*bone.m11+bone.worldY)*weight;}worldVertices[w]=wx+x;worldVertices[w+1]=wy+y;}}else{var ffd=slot.attachmentVertices;for(;v<n;w+=2){wx=0;wy=0;nn=bones[v++]+v;for(;v<nn;v++,b+=3,f+=2){bone=skeletonBones[bones[v]];vx=weights[b]+ffd[f];vy=weights[b+1]+ffd[f+1];weight=weights[b+2];wx+=(vx*bone.m00+vy*bone.m01+bone.worldX)*weight;wy+=(vx*bone.m10+vy*bone.m11+bone.worldY)*weight;}worldVertices[w]=wx+x;worldVertices[w+1]=wy+y;}}}};spine.BoundingBoxAttachment=function(name){this.name=name;this.vertices=[];};spine.BoundingBoxAttachment.prototype={type:spine.AttachmentType.boundingbox,computeWorldVertices:function(x,y,bone,worldVertices){x+=bone.worldX;y+=bone.worldY;var m00=bone.m00,m01=bone.m01,m10=bone.m10,m11=bone.m11;var vertices=this.vertices;for(var i=0,n=vertices.length;i<n;i+=2){var px=vertices[i];var py=vertices[i+1];worldVertices[i]=px*m00+py*m01+x;worldVertices[i+1]=px*m10+py*m11+y;}}};spine.AnimationStateData=function(skeletonData){this.skeletonData=skeletonData;this.animationToMixTime={};};spine.AnimationStateData.prototype={defaultMix:0,setMixByName:function(fromName,toName,duration){var from=this.skeletonData.findAnimation(fromName);if(!from)throw"Animation not found: "+fromName;var to=this.skeletonData.findAnimation(toName);if(!to)throw"Animation not found: "+toName;this.setMix(from,to,duration);},setMix:function(from,to,duration){this.animationToMixTime[from.name+":"+to.name]=duration;},getMix:function(from,to){var key=from.name+":"+to.name;return this.animationToMixTime.hasOwnProperty(key)?this.animationToMixTime[key]:this.defaultMix;}};spine.TrackEntry=function(){};spine.TrackEntry.prototype={next:null,previous:null,animation:null,loop:false,delay:0,time:0,lastTime:-1,endTime:0,timeScale:1,mixTime:0,mixDuration:0,mix:1,onStart:null,onEnd:null,onComplete:null,onEvent:null};spine.AnimationState=function(stateData){this.data=stateData;this.tracks=[];this.events=[];};spine.AnimationState.prototype={onStart:null,onEnd:null,onComplete:null,onEvent:null,timeScale:1,update:function(delta){delta*=this.timeScale;for(var i=0;i<this.tracks.length;i++){var current=this.tracks[i];if(!current)continue;current.time+=delta*current.timeScale;if(current.previous){var previousDelta=delta*current.previous.timeScale;current.previous.time+=previousDelta;current.mixTime+=previousDelta;}var next=current.next;if(next){next.time=current.lastTime-next.delay;if(next.time>=0)this.setCurrent(i,next);}else{// End non-looping animation when it reaches its end time and there is no next entry.
if(!current.loop&&current.lastTime>=current.endTime)this.clearTrack(i);}}},apply:function(skeleton){skeleton.resetDrawOrder();for(var i=0;i<this.tracks.length;i++){var current=this.tracks[i];if(!current)continue;this.events.length=0;var time=current.time;var lastTime=current.lastTime;var endTime=current.endTime;var loop=current.loop;if(!loop&&time>endTime)time=endTime;var previous=current.previous;if(!previous){if(current.mix==1)current.animation.apply(skeleton,current.lastTime,time,loop,this.events);else current.animation.mix(skeleton,current.lastTime,time,loop,this.events,current.mix);}else{var previousTime=previous.time;if(!previous.loop&&previousTime>previous.endTime)previousTime=previous.endTime;previous.animation.apply(skeleton,previousTime,previousTime,previous.loop,null);var alpha=current.mixTime/current.mixDuration*current.mix;if(alpha>=1){alpha=1;current.previous=null;}current.animation.mix(skeleton,current.lastTime,time,loop,this.events,alpha);}for(var ii=0,nn=this.events.length;ii<nn;ii++){var event=this.events[ii];if(current.onEvent)current.onEvent(i,event);if(this.onEvent)this.onEvent(i,event);}// Check if completed the animation or a loop iteration.
if(loop?lastTime%endTime>time%endTime:lastTime<endTime&&time>=endTime){var count=Math.floor(time/endTime);if(current.onComplete)current.onComplete(i,count);if(this.onComplete)this.onComplete(i,count);}current.lastTime=current.time;}},clearTracks:function(){for(var i=0,n=this.tracks.length;i<n;i++)this.clearTrack(i);this.tracks.length=0;},clearTrack:function(trackIndex){if(trackIndex>=this.tracks.length)return;var current=this.tracks[trackIndex];if(!current)return;if(current.onEnd)current.onEnd(trackIndex);if(this.onEnd)this.onEnd(trackIndex);this.tracks[trackIndex]=null;},_expandToIndex:function(index){if(index<this.tracks.length)return this.tracks[index];while(index>=this.tracks.length)this.tracks.push(null);return null;},setCurrent:function(index,entry){var current=this._expandToIndex(index);if(current){var previous=current.previous;current.previous=null;if(current.onEnd)current.onEnd(index);if(this.onEnd)this.onEnd(index);entry.mixDuration=this.data.getMix(current.animation,entry.animation);if(entry.mixDuration>0){entry.mixTime=0;// If a mix is in progress, mix from the closest animation.
if(previous&&current.mixTime/current.mixDuration<0.5)entry.previous=previous;else entry.previous=current;}}this.tracks[index]=entry;if(entry.onStart)entry.onStart(index);if(this.onStart)this.onStart(index);},setAnimationByName:function(trackIndex,animationName,loop){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;return this.setAnimation(trackIndex,animation,loop);},/** Set the current animation. Any queued animations are cleared. */setAnimation:function(trackIndex,animation,loop){var entry=new spine.TrackEntry();entry.animation=animation;entry.loop=loop;entry.endTime=animation.duration;this.setCurrent(trackIndex,entry);return entry;},addAnimationByName:function(trackIndex,animationName,loop,delay){var animation=this.data.skeletonData.findAnimation(animationName);if(!animation)throw"Animation not found: "+animationName;return this.addAnimation(trackIndex,animation,loop,delay);},/** Adds an animation to be played delay seconds after the current or last queued animation.
	 * @param delay May be <= 0 to use duration of previous animation minus any mix duration plus the negative delay. */addAnimation:function(trackIndex,animation,loop,delay){var entry=new spine.TrackEntry();entry.animation=animation;entry.loop=loop;entry.endTime=animation.duration;var last=this._expandToIndex(trackIndex);if(last){while(last.next)last=last.next;last.next=entry;}else this.tracks[trackIndex]=entry;if(delay<=0){if(last)delay+=last.endTime-this.data.getMix(last.animation,animation);else delay=0;}entry.delay=delay;return entry;},/** May be null. */getCurrent:function(trackIndex){if(trackIndex>=this.tracks.length)return null;return this.tracks[trackIndex];}};spine.SkeletonJson=function(attachmentLoader){this.attachmentLoader=attachmentLoader;};spine.SkeletonJson.prototype={scale:1,readSkeletonData:function(root,name){var skeletonData=new spine.SkeletonData();skeletonData.name=name;// Skeleton.
var skeletonMap=root["skeleton"];if(skeletonMap){skeletonData.hash=skeletonMap["hash"];skeletonData.version=skeletonMap["spine"];skeletonData.width=skeletonMap["width"]||0;skeletonData.height=skeletonMap["height"]||0;}// Bones.
var bones=root["bones"];for(var i=0,n=bones.length;i<n;i++){var boneMap=bones[i];var parent=null;if(boneMap["parent"]){parent=skeletonData.findBone(boneMap["parent"]);if(!parent)throw"Parent bone not found: "+boneMap["parent"];}var boneData=new spine.BoneData(boneMap["name"],parent);boneData.length=(boneMap["length"]||0)*this.scale;boneData.x=(boneMap["x"]||0)*this.scale;boneData.y=(boneMap["y"]||0)*this.scale;boneData.rotation=boneMap["rotation"]||0;boneData.scaleX=boneMap.hasOwnProperty("scaleX")?boneMap["scaleX"]:1;boneData.scaleY=boneMap.hasOwnProperty("scaleY")?boneMap["scaleY"]:1;boneData.inheritScale=boneMap.hasOwnProperty("inheritScale")?boneMap["inheritScale"]:true;boneData.inheritRotation=boneMap.hasOwnProperty("inheritRotation")?boneMap["inheritRotation"]:true;skeletonData.bones.push(boneData);}// IK constraints.
var ik=root["ik"];if(ik){for(var i=0,n=ik.length;i<n;i++){var ikMap=ik[i];var ikConstraintData=new spine.IkConstraintData(ikMap["name"]);var bones=ikMap["bones"];for(var ii=0,nn=bones.length;ii<nn;ii++){var bone=skeletonData.findBone(bones[ii]);if(!bone)throw"IK bone not found: "+bones[ii];ikConstraintData.bones.push(bone);}ikConstraintData.target=skeletonData.findBone(ikMap["target"]);if(!ikConstraintData.target)throw"Target bone not found: "+ikMap["target"];ikConstraintData.bendDirection=!ikMap.hasOwnProperty("bendPositive")||ikMap["bendPositive"]?1:-1;ikConstraintData.mix=ikMap.hasOwnProperty("mix")?ikMap["mix"]:1;skeletonData.ikConstraints.push(ikConstraintData);}}// Slots.
var slots=root["slots"];for(var i=0,n=slots.length;i<n;i++){var slotMap=slots[i];var boneData=skeletonData.findBone(slotMap["bone"]);if(!boneData)throw"Slot bone not found: "+slotMap["bone"];var slotData=new spine.SlotData(slotMap["name"],boneData);var color=slotMap["color"];if(color){slotData.r=this.toColor(color,0);slotData.g=this.toColor(color,1);slotData.b=this.toColor(color,2);slotData.a=this.toColor(color,3);}slotData.attachmentName=slotMap["attachment"];slotData.additiveBlending=slotMap["additive"]&&slotMap["additive"]=="true";skeletonData.slots.push(slotData);}// Skins.
var skins=root["skins"];for(var skinName in skins){if(!skins.hasOwnProperty(skinName))continue;var skinMap=skins[skinName];var skin=new spine.Skin(skinName);for(var slotName in skinMap){if(!skinMap.hasOwnProperty(slotName))continue;var slotIndex=skeletonData.findSlotIndex(slotName);var slotEntry=skinMap[slotName];for(var attachmentName in slotEntry){if(!slotEntry.hasOwnProperty(attachmentName))continue;var attachment=this.readAttachment(skin,attachmentName,slotEntry[attachmentName]);if(attachment)skin.addAttachment(slotIndex,attachmentName,attachment);}}skeletonData.skins.push(skin);if(skin.name=="default")skeletonData.defaultSkin=skin;}// Events.
var events=root["events"];for(var eventName in events){if(!events.hasOwnProperty(eventName))continue;var eventMap=events[eventName];var eventData=new spine.EventData(eventName);eventData.intValue=eventMap["int"]||0;eventData.floatValue=eventMap["float"]||0;eventData.stringValue=eventMap["string"]||null;skeletonData.events.push(eventData);}// Animations.
var animations=root["animations"];for(var animationName in animations){if(!animations.hasOwnProperty(animationName))continue;this.readAnimation(animationName,animations[animationName],skeletonData);}return skeletonData;},readAttachment:function(skin,name,map){name=map["name"]||name;var type=spine.AttachmentType[map["type"]||"region"];var path=map["path"]||name;var scale=this.scale;if(type==spine.AttachmentType.region){var region=this.attachmentLoader.newRegionAttachment(skin,name,path);if(!region)return null;region.path=path;region.x=(map["x"]||0)*scale;region.y=(map["y"]||0)*scale;region.scaleX=map.hasOwnProperty("scaleX")?map["scaleX"]:1;region.scaleY=map.hasOwnProperty("scaleY")?map["scaleY"]:1;region.rotation=map["rotation"]||0;region.width=(map["width"]||0)*scale;region.height=(map["height"]||0)*scale;var color=map["color"];if(color){region.r=this.toColor(color,0);region.g=this.toColor(color,1);region.b=this.toColor(color,2);region.a=this.toColor(color,3);}region.updateOffset();return region;}else if(type==spine.AttachmentType.mesh){var mesh=this.attachmentLoader.newMeshAttachment(skin,name,path);if(!mesh)return null;mesh.path=path;mesh.vertices=this.getFloatArray(map,"vertices",scale);mesh.triangles=this.getIntArray(map,"triangles");mesh.regionUVs=this.getFloatArray(map,"uvs",1);mesh.updateUVs();color=map["color"];if(color){mesh.r=this.toColor(color,0);mesh.g=this.toColor(color,1);mesh.b=this.toColor(color,2);mesh.a=this.toColor(color,3);}mesh.hullLength=(map["hull"]||0)*2;if(map["edges"])mesh.edges=this.getIntArray(map,"edges");mesh.width=(map["width"]||0)*scale;mesh.height=(map["height"]||0)*scale;return mesh;}else if(type==spine.AttachmentType.skinnedmesh){var mesh=this.attachmentLoader.newSkinnedMeshAttachment(skin,name,path);if(!mesh)return null;mesh.path=path;var uvs=this.getFloatArray(map,"uvs",1);var vertices=this.getFloatArray(map,"vertices",1);var weights=[];var bones=[];for(var i=0,n=vertices.length;i<n;){var boneCount=vertices[i++]|0;bones[bones.length]=boneCount;for(var nn=i+boneCount*4;i<nn;){bones[bones.length]=vertices[i];weights[weights.length]=vertices[i+1]*scale;weights[weights.length]=vertices[i+2]*scale;weights[weights.length]=vertices[i+3];i+=4;}}mesh.bones=bones;mesh.weights=weights;mesh.triangles=this.getIntArray(map,"triangles");mesh.regionUVs=uvs;mesh.updateUVs();color=map["color"];if(color){mesh.r=this.toColor(color,0);mesh.g=this.toColor(color,1);mesh.b=this.toColor(color,2);mesh.a=this.toColor(color,3);}mesh.hullLength=(map["hull"]||0)*2;if(map["edges"])mesh.edges=this.getIntArray(map,"edges");mesh.width=(map["width"]||0)*scale;mesh.height=(map["height"]||0)*scale;return mesh;}else if(type==spine.AttachmentType.boundingbox){var attachment=this.attachmentLoader.newBoundingBoxAttachment(skin,name);var vertices=map["vertices"];for(var i=0,n=vertices.length;i<n;i++)attachment.vertices.push(vertices[i]*scale);return attachment;}throw"Unknown attachment type: "+type;},readAnimation:function(name,map,skeletonData){var timelines=[];var duration=0;var slots=map["slots"];for(var slotName in slots){if(!slots.hasOwnProperty(slotName))continue;var slotMap=slots[slotName];var slotIndex=skeletonData.findSlotIndex(slotName);for(var timelineName in slotMap){if(!slotMap.hasOwnProperty(timelineName))continue;var values=slotMap[timelineName];if(timelineName=="color"){var timeline=new spine.ColorTimeline(values.length);timeline.slotIndex=slotIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var color=valueMap["color"];var r=this.toColor(color,0);var g=this.toColor(color,1);var b=this.toColor(color,2);var a=this.toColor(color,3);timeline.setFrame(frameIndex,valueMap["time"],r,g,b,a);this.readCurve(timeline,frameIndex,valueMap);frameIndex++;}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*5-5]);}else if(timelineName=="attachment"){var timeline=new spine.AttachmentTimeline(values.length);timeline.slotIndex=slotIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex++,valueMap["time"],valueMap["name"]);}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1]);}else throw"Invalid timeline type for a slot: "+timelineName+" ("+slotName+")";}}var bones=map["bones"];for(var boneName in bones){if(!bones.hasOwnProperty(boneName))continue;var boneIndex=skeletonData.findBoneIndex(boneName);if(boneIndex==-1)throw"Bone not found: "+boneName;var boneMap=bones[boneName];for(var timelineName in boneMap){if(!boneMap.hasOwnProperty(timelineName))continue;var values=boneMap[timelineName];if(timelineName=="rotate"){var timeline=new spine.RotateTimeline(values.length);timeline.boneIndex=boneIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex,valueMap["time"],valueMap["angle"]);this.readCurve(timeline,frameIndex,valueMap);frameIndex++;}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*2-2]);}else if(timelineName=="translate"||timelineName=="scale"){var timeline;var timelineScale=1;if(timelineName=="scale")timeline=new spine.ScaleTimeline(values.length);else{timeline=new spine.TranslateTimeline(values.length);timelineScale=this.scale;}timeline.boneIndex=boneIndex;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var x=(valueMap["x"]||0)*timelineScale;var y=(valueMap["y"]||0)*timelineScale;timeline.setFrame(frameIndex,valueMap["time"],x,y);this.readCurve(timeline,frameIndex,valueMap);frameIndex++;}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*3-3]);}else if(timelineName=="flipX"||timelineName=="flipY"){var x=timelineName=="flipX";var timeline=x?new spine.FlipXTimeline(values.length):new spine.FlipYTimeline(values.length);timeline.boneIndex=boneIndex;var field=x?"x":"y";var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];timeline.setFrame(frameIndex,valueMap["time"],valueMap[field]||false);frameIndex++;}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()*2-2]);}else throw"Invalid timeline type for a bone: "+timelineName+" ("+boneName+")";}}var ikMap=map["ik"];for(var ikConstraintName in ikMap){if(!ikMap.hasOwnProperty(ikConstraintName))continue;var ikConstraint=skeletonData.findIkConstraint(ikConstraintName);var values=ikMap[ikConstraintName];var timeline=new spine.IkConstraintTimeline(values.length);timeline.ikConstraintIndex=skeletonData.ikConstraints.indexOf(ikConstraint);var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var mix=valueMap.hasOwnProperty("mix")?valueMap["mix"]:1;var bendDirection=!valueMap.hasOwnProperty("bendPositive")||valueMap["bendPositive"]?1:-1;timeline.setFrame(frameIndex,valueMap["time"],mix,bendDirection);this.readCurve(timeline,frameIndex,valueMap);frameIndex++;}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.frameCount*3-3]);}var ffd=map["ffd"];for(var skinName in ffd){var skin=skeletonData.findSkin(skinName);var slotMap=ffd[skinName];for(slotName in slotMap){var slotIndex=skeletonData.findSlotIndex(slotName);var meshMap=slotMap[slotName];for(var meshName in meshMap){var values=meshMap[meshName];var timeline=new spine.FfdTimeline(values.length);var attachment=skin.getAttachment(slotIndex,meshName);if(!attachment)throw"FFD attachment not found: "+meshName;timeline.slotIndex=slotIndex;timeline.attachment=attachment;var isMesh=attachment.type==spine.AttachmentType.mesh;var vertexCount;if(isMesh)vertexCount=attachment.vertices.length;else vertexCount=attachment.weights.length/3*2;var frameIndex=0;for(var i=0,n=values.length;i<n;i++){var valueMap=values[i];var vertices;if(!valueMap["vertices"]){if(isMesh)vertices=attachment.vertices;else{vertices=[];vertices.length=vertexCount;}}else{var verticesValue=valueMap["vertices"];var vertices=[];vertices.length=vertexCount;var start=valueMap["offset"]||0;var nn=verticesValue.length;if(this.scale==1){for(var ii=0;ii<nn;ii++)vertices[ii+start]=verticesValue[ii];}else{for(var ii=0;ii<nn;ii++)vertices[ii+start]=verticesValue[ii]*this.scale;}if(isMesh){var meshVertices=attachment.vertices;for(var ii=0,nn=vertices.length;ii<nn;ii++)vertices[ii]+=meshVertices[ii];}}timeline.setFrame(frameIndex,valueMap["time"],vertices);this.readCurve(timeline,frameIndex,valueMap);frameIndex++;}timelines[timelines.length]=timeline;duration=Math.max(duration,timeline.frames[timeline.frameCount-1]);}}}var drawOrderValues=map["drawOrder"];if(!drawOrderValues)drawOrderValues=map["draworder"];if(drawOrderValues){var timeline=new spine.DrawOrderTimeline(drawOrderValues.length);var slotCount=skeletonData.slots.length;var frameIndex=0;for(var i=0,n=drawOrderValues.length;i<n;i++){var drawOrderMap=drawOrderValues[i];var drawOrder=null;if(drawOrderMap["offsets"]){drawOrder=[];drawOrder.length=slotCount;for(var ii=slotCount-1;ii>=0;ii--)drawOrder[ii]=-1;var offsets=drawOrderMap["offsets"];var unchanged=[];unchanged.length=slotCount-offsets.length;var originalIndex=0,unchangedIndex=0;for(var ii=0,nn=offsets.length;ii<nn;ii++){var offsetMap=offsets[ii];var slotIndex=skeletonData.findSlotIndex(offsetMap["slot"]);if(slotIndex==-1)throw"Slot not found: "+offsetMap["slot"];// Collect unchanged items.
while(originalIndex!=slotIndex)unchanged[unchangedIndex++]=originalIndex++;// Set changed items.
drawOrder[originalIndex+offsetMap["offset"]]=originalIndex++;}// Collect remaining unchanged items.
while(originalIndex<slotCount)unchanged[unchangedIndex++]=originalIndex++;// Fill in unchanged items.
for(var ii=slotCount-1;ii>=0;ii--)if(drawOrder[ii]==-1)drawOrder[ii]=unchanged[--unchangedIndex];}timeline.setFrame(frameIndex++,drawOrderMap["time"],drawOrder);}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1]);}var events=map["events"];if(events){var timeline=new spine.EventTimeline(events.length);var frameIndex=0;for(var i=0,n=events.length;i<n;i++){var eventMap=events[i];var eventData=skeletonData.findEvent(eventMap["name"]);if(!eventData)throw"Event not found: "+eventMap["name"];var event=new spine.Event(eventData);event.intValue=eventMap.hasOwnProperty("int")?eventMap["int"]:eventData.intValue;event.floatValue=eventMap.hasOwnProperty("float")?eventMap["float"]:eventData.floatValue;event.stringValue=eventMap.hasOwnProperty("string")?eventMap["string"]:eventData.stringValue;timeline.setFrame(frameIndex++,eventMap["time"],event);}timelines.push(timeline);duration=Math.max(duration,timeline.frames[timeline.getFrameCount()-1]);}skeletonData.animations.push(new spine.Animation(name,timelines,duration));},readCurve:function(timeline,frameIndex,valueMap){var curve=valueMap["curve"];if(!curve)timeline.curves.setLinear(frameIndex);else if(curve=="stepped")timeline.curves.setStepped(frameIndex);else if(curve instanceof Array)timeline.curves.setCurve(frameIndex,curve[0],curve[1],curve[2],curve[3]);},toColor:function(hexString,colorIndex){if(hexString.length!=8)throw"Color hexidecimal length must be 8, recieved: "+hexString;return parseInt(hexString.substring(colorIndex*2,colorIndex*2+2),16)/255;},getFloatArray:function(map,name,scale){var list=map[name];var values=new spine.Float32Array(list.length);var i=0,n=list.length;if(scale==1){for(;i<n;i++)values[i]=list[i];}else{for(;i<n;i++)values[i]=list[i]*scale;}return values;},getIntArray:function(map,name){var list=map[name];var values=new spine.Uint16Array(list.length);for(var i=0,n=list.length;i<n;i++)values[i]=list[i]|0;return values;}};spine.Atlas=function(atlasText,textureLoader){this.textureLoader=textureLoader;this.pages=[];this.regions=[];var reader=new spine.AtlasReader(atlasText);var tuple=[];tuple.length=4;var page=null;while(true){var line=reader.readLine();if(line===null)break;line=reader.trim(line);if(!line.length)page=null;else if(!page){page=new spine.AtlasPage();page.name=line;if(reader.readTuple(tuple)==2){// size is only optional for an atlas packed with an old TexturePacker.
page.width=parseInt(tuple[0]);page.height=parseInt(tuple[1]);reader.readTuple(tuple);}page.format=spine.Atlas.Format[tuple[0]];reader.readTuple(tuple);page.minFilter=spine.Atlas.TextureFilter[tuple[0]];page.magFilter=spine.Atlas.TextureFilter[tuple[1]];var direction=reader.readValue();page.uWrap=spine.Atlas.TextureWrap.clampToEdge;page.vWrap=spine.Atlas.TextureWrap.clampToEdge;if(direction=="x")page.uWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="y")page.vWrap=spine.Atlas.TextureWrap.repeat;else if(direction=="xy")page.uWrap=page.vWrap=spine.Atlas.TextureWrap.repeat;textureLoader.load(page,line,this);this.pages.push(page);}else{var region=new spine.AtlasRegion();region.name=line;region.page=page;region.rotate=reader.readValue()=="true";reader.readTuple(tuple);var x=parseInt(tuple[0]);var y=parseInt(tuple[1]);reader.readTuple(tuple);var width=parseInt(tuple[0]);var height=parseInt(tuple[1]);region.u=x/page.width;region.v=y/page.height;if(region.rotate){region.u2=(x+height)/page.width;region.v2=(y+width)/page.height;}else{region.u2=(x+width)/page.width;region.v2=(y+height)/page.height;}region.x=x;region.y=y;region.width=Math.abs(width);region.height=Math.abs(height);if(reader.readTuple(tuple)==4){// split is optional
region.splits=[parseInt(tuple[0]),parseInt(tuple[1]),parseInt(tuple[2]),parseInt(tuple[3])];if(reader.readTuple(tuple)==4){// pad is optional, but only present with splits
region.pads=[parseInt(tuple[0]),parseInt(tuple[1]),parseInt(tuple[2]),parseInt(tuple[3])];reader.readTuple(tuple);}}region.originalWidth=parseInt(tuple[0]);region.originalHeight=parseInt(tuple[1]);reader.readTuple(tuple);region.offsetX=parseInt(tuple[0]);region.offsetY=parseInt(tuple[1]);region.index=parseInt(reader.readValue());this.regions.push(region);}}};spine.Atlas.prototype={findRegion:function(name){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++)if(regions[i].name==name)return regions[i];return null;},dispose:function(){var pages=this.pages;for(var i=0,n=pages.length;i<n;i++)this.textureLoader.unload(pages[i].rendererObject);},updateUVs:function(page){var regions=this.regions;for(var i=0,n=regions.length;i<n;i++){var region=regions[i];if(region.page!=page)continue;region.u=region.x/page.width;region.v=region.y/page.height;if(region.rotate){region.u2=(region.x+region.height)/page.width;region.v2=(region.y+region.width)/page.height;}else{region.u2=(region.x+region.width)/page.width;region.v2=(region.y+region.height)/page.height;}}}};spine.Atlas.Format={alpha:0,intensity:1,luminanceAlpha:2,rgb565:3,rgba4444:4,rgb888:5,rgba8888:6};spine.Atlas.TextureFilter={nearest:0,linear:1,mipMap:2,mipMapNearestNearest:3,mipMapLinearNearest:4,mipMapNearestLinear:5,mipMapLinearLinear:6};spine.Atlas.TextureWrap={mirroredRepeat:0,clampToEdge:1,repeat:2};spine.AtlasPage=function(){};spine.AtlasPage.prototype={name:null,format:null,minFilter:null,magFilter:null,uWrap:null,vWrap:null,rendererObject:null,width:0,height:0};spine.AtlasRegion=function(){};spine.AtlasRegion.prototype={page:null,name:null,x:0,y:0,width:0,height:0,u:0,v:0,u2:0,v2:0,offsetX:0,offsetY:0,originalWidth:0,originalHeight:0,index:0,rotate:false,splits:null,pads:null};spine.AtlasReader=function(text){this.lines=text.split(/\r\n|\r|\n/);};spine.AtlasReader.prototype={index:0,trim:function(value){return value.replace(/^\s+|\s+$/g,"");},readLine:function(){if(this.index>=this.lines.length)return null;return this.lines[this.index++];},readValue:function(){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;return this.trim(line.substring(colon+1));},/** Returns the number of tuple values read (1, 2 or 4). */readTuple:function(tuple){var line=this.readLine();var colon=line.indexOf(":");if(colon==-1)throw"Invalid line: "+line;var i=0,lastMatch=colon+1;for(;i<3;i++){var comma=line.indexOf(",",lastMatch);if(comma==-1)break;tuple[i]=this.trim(line.substr(lastMatch,comma-lastMatch));lastMatch=comma+1;}tuple[i]=this.trim(line.substring(lastMatch));return i+1;}};spine.AtlasAttachmentLoader=function(atlas){this.atlas=atlas;};spine.AtlasAttachmentLoader.prototype={newRegionAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (region attachment: "+name+")";var attachment=new spine.RegionAttachment(name);attachment.rendererObject=region;attachment.setUVs(region.u,region.v,region.u2,region.v2,region.rotate);attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment;},newMeshAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (mesh attachment: "+name+")";var attachment=new spine.MeshAttachment(name);attachment.rendererObject=region;attachment.regionU=region.u;attachment.regionV=region.v;attachment.regionU2=region.u2;attachment.regionV2=region.v2;attachment.regionRotate=region.rotate;attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment;},newSkinnedMeshAttachment:function(skin,name,path){var region=this.atlas.findRegion(path);if(!region)throw"Region not found in atlas: "+path+" (skinned mesh attachment: "+name+")";var attachment=new spine.SkinnedMeshAttachment(name);attachment.rendererObject=region;attachment.regionU=region.u;attachment.regionV=region.v;attachment.regionU2=region.u2;attachment.regionV2=region.v2;attachment.regionRotate=region.rotate;attachment.regionOffsetX=region.offsetX;attachment.regionOffsetY=region.offsetY;attachment.regionWidth=region.width;attachment.regionHeight=region.height;attachment.regionOriginalWidth=region.originalWidth;attachment.regionOriginalHeight=region.originalHeight;return attachment;},newBoundingBoxAttachment:function(skin,name){return new spine.BoundingBoxAttachment(name);}};spine.SkeletonBounds=function(){this.polygonPool=[];this.polygons=[];this.boundingBoxes=[];};spine.SkeletonBounds.prototype={minX:0,minY:0,maxX:0,maxY:0,update:function(skeleton,updateAabb){var slots=skeleton.slots;var slotCount=slots.length;var x=skeleton.x,y=skeleton.y;var boundingBoxes=this.boundingBoxes;var polygonPool=this.polygonPool;var polygons=this.polygons;boundingBoxes.length=0;for(var i=0,n=polygons.length;i<n;i++)polygonPool.push(polygons[i]);polygons.length=0;for(var i=0;i<slotCount;i++){var slot=slots[i];var boundingBox=slot.attachment;if(boundingBox.type!=spine.AttachmentType.boundingbox)continue;boundingBoxes.push(boundingBox);var poolCount=polygonPool.length,polygon;if(poolCount>0){polygon=polygonPool[poolCount-1];polygonPool.splice(poolCount-1,1);}else polygon=[];polygons.push(polygon);polygon.length=boundingBox.vertices.length;boundingBox.computeWorldVertices(x,y,slot.bone,polygon);}if(updateAabb)this.aabbCompute();},aabbCompute:function(){var polygons=this.polygons;var minX=Number.MAX_VALUE,minY=Number.MAX_VALUE,maxX=Number.MIN_VALUE,maxY=Number.MIN_VALUE;for(var i=0,n=polygons.length;i<n;i++){var vertices=polygons[i];for(var ii=0,nn=vertices.length;ii<nn;ii+=2){var x=vertices[ii];var y=vertices[ii+1];minX=Math.min(minX,x);minY=Math.min(minY,y);maxX=Math.max(maxX,x);maxY=Math.max(maxY,y);}}this.minX=minX;this.minY=minY;this.maxX=maxX;this.maxY=maxY;},/** Returns true if the axis aligned bounding box contains the point. */aabbContainsPoint:function(x,y){return x>=this.minX&&x<=this.maxX&&y>=this.minY&&y<=this.maxY;},/** Returns true if the axis aligned bounding box intersects the line segment. */aabbIntersectsSegment:function(x1,y1,x2,y2){var minX=this.minX,minY=this.minY,maxX=this.maxX,maxY=this.maxY;if(x1<=minX&&x2<=minX||y1<=minY&&y2<=minY||x1>=maxX&&x2>=maxX||y1>=maxY&&y2>=maxY)return false;var m=(y2-y1)/(x2-x1);var y=m*(minX-x1)+y1;if(y>minY&&y<maxY)return true;y=m*(maxX-x1)+y1;if(y>minY&&y<maxY)return true;var x=(minY-y1)/m+x1;if(x>minX&&x<maxX)return true;x=(maxY-y1)/m+x1;if(x>minX&&x<maxX)return true;return false;},/** Returns true if the axis aligned bounding box intersects the axis aligned bounding box of the specified bounds. */aabbIntersectsSkeleton:function(bounds){return this.minX<bounds.maxX&&this.maxX>bounds.minX&&this.minY<bounds.maxY&&this.maxY>bounds.minY;},/** Returns the first bounding box attachment that contains the point, or null. When doing many checks, it is usually more
	 * efficient to only call this method if {@link #aabbContainsPoint(float, float)} returns true. */containsPoint:function(x,y){var polygons=this.polygons;for(var i=0,n=polygons.length;i<n;i++)if(this.polygonContainsPoint(polygons[i],x,y))return this.boundingBoxes[i];return null;},/** Returns the first bounding box attachment that contains the line segment, or null. When doing many checks, it is usually
	 * more efficient to only call this method if {@link #aabbIntersectsSegment(float, float, float, float)} returns true. */intersectsSegment:function(x1,y1,x2,y2){var polygons=this.polygons;for(var i=0,n=polygons.length;i<n;i++)if(polygons[i].intersectsSegment(x1,y1,x2,y2))return this.boundingBoxes[i];return null;},/** Returns true if the polygon contains the point. */polygonContainsPoint:function(polygon,x,y){var nn=polygon.length;var prevIndex=nn-2;var inside=false;for(var ii=0;ii<nn;ii+=2){var vertexY=polygon[ii+1];var prevY=polygon[prevIndex+1];if(vertexY<y&&prevY>=y||prevY<y&&vertexY>=y){var vertexX=polygon[ii];if(vertexX+(y-vertexY)/(prevY-vertexY)*(polygon[prevIndex]-vertexX)<x)inside=!inside;}prevIndex=ii;}return inside;},/** Returns true if the polygon contains the line segment. */polygonIntersectsSegment:function(polygon,x1,y1,x2,y2){var nn=polygon.length;var width12=x1-x2,height12=y1-y2;var det1=x1*y2-y1*x2;var x3=polygon[nn-2],y3=polygon[nn-1];for(var ii=0;ii<nn;ii+=2){var x4=polygon[ii],y4=polygon[ii+1];var det2=x3*y4-y3*x4;var width34=x3-x4,height34=y3-y4;var det3=width12*height34-height12*width34;var x=(det1*width34-width12*det2)/det3;if((x>=x3&&x<=x4||x>=x4&&x<=x3)&&(x>=x1&&x<=x2||x>=x2&&x<=x1)){var y=(det1*height34-height12*det2)/det3;if((y>=y3&&y<=y4||y>=y4&&y<=y3)&&(y>=y1&&y<=y2||y>=y2&&y<=y1))return true;}x3=x4;y3=y4;}return false;},getPolygon:function(attachment){var index=this.boundingBoxes.indexOf(attachment);return index==-1?null:this.polygons[index];},getWidth:function(){return this.maxX-this.minX;},getHeight:function(){return this.maxY-this.minY;}};/* Esoteric Software SPINE wrapper for pixi.js */spine.Bone.yDown=true;PIXI.AnimCache={};/**
 * Supporting class to load images from spine atlases as per spine spec.
 *
 * @class SpineTextureLoader
 * @uses EventTarget
 * @constructor
 * @param basePath {String} Tha base path where to look for the images to be loaded
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.SpineTextureLoader=function(basePath,crossorigin){PIXI.EventTarget.call(this);this.basePath=basePath;this.crossorigin=crossorigin;this.loadingCount=0;};/* constructor */PIXI.SpineTextureLoader.prototype=PIXI.SpineTextureLoader;/**
 * Starts loading a base texture as per spine specification
 *
 * @method load
 * @param page {spine.AtlasPage} Atlas page to which texture belongs
 * @param file {String} The file to load, this is just the file path relative to the base path configured in the constructor
 */PIXI.SpineTextureLoader.prototype.load=function(page,file){page.rendererObject=PIXI.BaseTexture.fromImage(this.basePath+'/'+file,this.crossorigin);if(!page.rendererObject.hasLoaded){var scope=this;++scope.loadingCount;page.rendererObject.addEventListener('loaded',function(){--scope.loadingCount;scope.dispatchEvent({type:'loadedBaseTexture',content:scope});});}};/**
 * Unloads a previously loaded texture as per spine specification
 *
 * @method unload
 * @param texture {BaseTexture} Texture object to destroy
 */PIXI.SpineTextureLoader.prototype.unload=function(texture){texture.destroy(true);};/**
 * A class that enables the you to import and run your spine animations in pixi.
 * Spine animation data needs to be loaded using the PIXI.AssetLoader or PIXI.SpineLoader before it can be used by this class
 * See example 12 (http://www.goodboydigital.com/pixijs/examples/12/) to see a working example and check out the source
 *
 * @class Spine
 * @extends DisplayObjectContainer
 * @constructor
 * @param url {String} The url of the spine anim file to be used
 */PIXI.Spine=function(url){PIXI.DisplayObjectContainer.call(this);this.spineData=PIXI.AnimCache[url];if(!this.spineData){throw new Error('Spine data must be preloaded using PIXI.SpineLoader or PIXI.AssetLoader: '+url);}this.skeleton=new spine.Skeleton(this.spineData);this.skeleton.updateWorldTransform();this.stateData=new spine.AnimationStateData(this.spineData);this.state=new spine.AnimationState(this.stateData);this.slotContainers=[];for(var i=0,n=this.skeleton.slots.length;i<n;i++){var slot=this.skeleton.slots[i];var attachment=slot.attachment;var slotContainer=new PIXI.DisplayObjectContainer();this.slotContainers.push(slotContainer);this.addChild(slotContainer);if(attachment instanceof spine.RegionAttachment){var spriteName=attachment.rendererObject.name;var sprite=this.createSprite(slot,attachment);slot.currentSprite=sprite;slot.currentSpriteName=spriteName;slotContainer.addChild(sprite);}else if(attachment instanceof spine.MeshAttachment){var mesh=this.createMesh(slot,attachment);slot.currentMesh=mesh;slot.currentMeshName=attachment.name;slotContainer.addChild(mesh);}else{continue;}}this.autoUpdate=true;};PIXI.Spine.prototype=Object.create(PIXI.DisplayObjectContainer.prototype);PIXI.Spine.prototype.constructor=PIXI.Spine;/**
 * If this flag is set to true, the spine animation will be autoupdated every time
 * the object id drawn. The down side of this approach is that the delta time is
 * automatically calculated and you could miss out on cool effects like slow motion,
 * pause, skip ahead and the sorts. Most of these effects can be achieved even with
 * autoupdate enabled but are harder to achieve.
 *
 * @property autoUpdate
 * @type { Boolean }
 * @default true
 */Object.defineProperty(PIXI.Spine.prototype,'autoUpdate',{get:function(){return this.updateTransform===PIXI.Spine.prototype.autoUpdateTransform;},set:function(value){this.updateTransform=value?PIXI.Spine.prototype.autoUpdateTransform:PIXI.DisplayObjectContainer.prototype.updateTransform;}});/**
 * Update the spine skeleton and its animations by delta time (dt)
 *
 * @method update
 * @param dt {Number} Delta time. Time by which the animation should be updated
 */PIXI.Spine.prototype.update=function(dt){this.state.update(dt);this.state.apply(this.skeleton);this.skeleton.updateWorldTransform();var drawOrder=this.skeleton.drawOrder;var slots=this.skeleton.slots;for(var i=0,n=drawOrder.length;i<n;i++)this.children[i]=this.slotContainers[drawOrder[i]];for(i=0,n=slots.length;i<n;i++){var slot=slots[i];var attachment=slot.attachment;var slotContainer=this.slotContainers[i];if(!attachment){slotContainer.visible=false;continue;}var type=attachment.type;if(type===spine.AttachmentType.region){if(attachment.rendererObject){if(!slot.currentSpriteName||slot.currentSpriteName!==attachment.name){var spriteName=attachment.rendererObject.name;if(slot.currentSprite!==undefined){slot.currentSprite.visible=false;}slot.sprites=slot.sprites||{};if(slot.sprites[spriteName]!==undefined){slot.sprites[spriteName].visible=true;}else{var sprite=this.createSprite(slot,attachment);slotContainer.addChild(sprite);}slot.currentSprite=slot.sprites[spriteName];slot.currentSpriteName=spriteName;}}var bone=slot.bone;slotContainer.position.x=bone.worldX+attachment.x*bone.m00+attachment.y*bone.m01;slotContainer.position.y=bone.worldY+attachment.x*bone.m10+attachment.y*bone.m11;slotContainer.scale.x=bone.worldScaleX;slotContainer.scale.y=bone.worldScaleY;slotContainer.rotation=-(slot.bone.worldRotation*spine.degRad);slot.currentSprite.tint=PIXI.rgb2hex([slot.r,slot.g,slot.b]);}else if(type===spine.AttachmentType.skinnedmesh){if(!slot.currentMeshName||slot.currentMeshName!==attachment.name){var meshName=attachment.name;if(slot.currentMesh!==undefined){slot.currentMesh.visible=false;}slot.meshes=slot.meshes||{};if(slot.meshes[meshName]!==undefined){slot.meshes[meshName].visible=true;}else{var mesh=this.createMesh(slot,attachment);slotContainer.addChild(mesh);}slot.currentMesh=slot.meshes[meshName];slot.currentMeshName=meshName;}attachment.computeWorldVertices(slot.bone.skeleton.x,slot.bone.skeleton.y,slot,slot.currentMesh.vertices);}else{slotContainer.visible=false;continue;}slotContainer.visible=true;slotContainer.alpha=slot.a;}};/**
 * When autoupdate is set to yes this function is used as pixi's updateTransform function
 *
 * @method autoUpdateTransform
 * @private
 */PIXI.Spine.prototype.autoUpdateTransform=function(){this.lastTime=this.lastTime||Date.now();var timeDelta=(Date.now()-this.lastTime)*0.001;this.lastTime=Date.now();this.update(timeDelta);PIXI.DisplayObjectContainer.prototype.updateTransform.call(this);};/**
 * Create a new sprite to be used with spine.RegionAttachment
 *
 * @method createSprite
 * @param slot {spine.Slot} The slot to which the attachment is parented
 * @param attachment {spine.RegionAttachment} The attachment that the sprite will represent
 * @private
 */PIXI.Spine.prototype.createSprite=function(slot,attachment){var descriptor=attachment.rendererObject;var baseTexture=descriptor.page.rendererObject;var spriteRect=new PIXI.Rectangle(descriptor.x,descriptor.y,descriptor.rotate?descriptor.height:descriptor.width,descriptor.rotate?descriptor.width:descriptor.height);var spriteTexture=new PIXI.Texture(baseTexture,spriteRect);var sprite=new PIXI.Sprite(spriteTexture);var baseRotation=descriptor.rotate?Math.PI*0.5:0.0;sprite.scale.set(descriptor.width/descriptor.originalWidth,descriptor.height/descriptor.originalHeight);sprite.rotation=baseRotation-attachment.rotation*spine.degRad;sprite.anchor.x=sprite.anchor.y=0.5;slot.sprites=slot.sprites||{};slot.sprites[descriptor.name]=sprite;return sprite;};PIXI.Spine.prototype.createMesh=function(slot,attachment){var descriptor=attachment.rendererObject;var baseTexture=descriptor.page.rendererObject;var texture=new PIXI.Texture(baseTexture);var strip=new PIXI.Strip(texture);strip.drawMode=PIXI.Strip.DrawModes.TRIANGLES;strip.canvasPadding=1.5;strip.vertices=new PIXI.Float32Array(attachment.uvs.length);strip.uvs=attachment.uvs;strip.indices=attachment.triangles;slot.meshes=slot.meshes||{};slot.meshes[attachment.name]=strip;return strip;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */PIXI.BaseTextureCache={};PIXI.BaseTextureCacheIdGenerator=0;/**
 * A texture stores the information that represents an image. All textures have a base texture.
 *
 * @class BaseTexture
 * @uses EventTarget
 * @constructor
 * @param source {String} the source object (image or canvas)
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 */PIXI.BaseTexture=function(source,scaleMode){/**
     * The Resolution of the texture. 
     *
     * @property resolution
     * @type Number
     */this.resolution=1;/**
     * [read-only] The width of the base texture set when the image has loaded
     *
     * @property width
     * @type Number
     * @readOnly
     */this.width=100;/**
     * [read-only] The height of the base texture set when the image has loaded
     *
     * @property height
     * @type Number
     * @readOnly
     */this.height=100;/**
     * The scale mode to apply when scaling this texture
     * 
     * @property scaleMode
     * @type {Number}
     * @default PIXI.scaleModes.LINEAR
     */this.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;/**
     * [read-only] Set to true once the base texture has loaded
     *
     * @property hasLoaded
     * @type Boolean
     * @readOnly
     */this.hasLoaded=false;/**
     * The image source that is used to create the texture.
     *
     * @property source
     * @type Image
     */this.source=source;this._UID=PIXI._UID++;/**
     * Controls if RGB channels should be pre-multiplied by Alpha  (WebGL only)
     *
     * @property premultipliedAlpha
     * @type Boolean
     * @default true
     */this.premultipliedAlpha=true;// used for webGL
/**
     * @property _glTextures
     * @type Array
     * @private
     */this._glTextures=[];/**
     *
     * Set this to true if a mipmap of this texture needs to be generated. This value needs to be set before the texture is used
     * Also the texture must be a power of two size to work
     * 
     * @property mipmap
     * @type {Boolean}
     */this.mipmap=false;// used for webGL texture updating...
// TODO - this needs to be addressed
/**
     * @property _dirty
     * @type Array
     * @private
     */this._dirty=[true,true,true,true];if(!source)return;if((this.source.complete||this.source.getContext)&&this.source.width&&this.source.height){this.hasLoaded=true;this.width=this.source.naturalWidth||this.source.width;this.height=this.source.naturalHeight||this.source.height;this.dirty();}else{var scope=this;this.source.onload=function(){scope.hasLoaded=true;scope.width=scope.source.naturalWidth||scope.source.width;scope.height=scope.source.naturalHeight||scope.source.height;scope.dirty();// add it to somewhere...
scope.dispatchEvent({type:'loaded',content:scope});};this.source.onerror=function(){scope.dispatchEvent({type:'error',content:scope});};}/**
     * @property imageUrl
     * @type String
     */this.imageUrl=null;/**
     * @property _powerOf2
     * @type Boolean
     * @private
     */this._powerOf2=false;};PIXI.BaseTexture.prototype.constructor=PIXI.BaseTexture;PIXI.EventTarget.mixin(PIXI.BaseTexture.prototype);/**
 * Destroys this base texture
 *
 * @method destroy
 */PIXI.BaseTexture.prototype.destroy=function(){if(this.imageUrl){delete PIXI.BaseTextureCache[this.imageUrl];delete PIXI.TextureCache[this.imageUrl];this.imageUrl=null;if(!navigator.isCocoonJS)this.source.src='';}else if(this.source&&this.source._pixiId){delete PIXI.BaseTextureCache[this.source._pixiId];}this.source=null;this.unloadFromGPU();};/**
 * Changes the source image of the texture
 *
 * @method updateSourceImage
 * @param newSrc {String} the path of the image
 */PIXI.BaseTexture.prototype.updateSourceImage=function(newSrc){this.hasLoaded=false;this.source.src=null;this.source.src=newSrc;};/**
 * Sets all glTextures to be dirty.
 *
 * @method dirty
 */PIXI.BaseTexture.prototype.dirty=function(){for(var i=0;i<this._glTextures.length;i++){this._dirty[i]=true;}};/**
 * Removes the base texture from the GPU, useful for managing resources on the GPU.
 * Atexture is still 100% usable and will simply be reuploaded if there is a sprite on screen that is using it.
 *
 * @method unloadFromGPU
 */PIXI.BaseTexture.prototype.unloadFromGPU=function(){this.dirty();// delete the webGL textures if any.
for(var i=this._glTextures.length-1;i>=0;i--){var glTexture=this._glTextures[i];var gl=PIXI.glContexts[i];if(gl&&glTexture){gl.deleteTexture(glTexture);}}this._glTextures.length=0;this.dirty();};/**
 * Helper function that creates a base texture from the given image url.
 * If the image is not in the base texture cache it will be created and loaded.
 *
 * @static
 * @method fromImage
 * @param imageUrl {String} The image url of the texture
 * @param crossorigin {Boolean}
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return BaseTexture
 */PIXI.BaseTexture.fromImage=function(imageUrl,crossorigin,scaleMode){var baseTexture=PIXI.BaseTextureCache[imageUrl];if(crossorigin===undefined&&imageUrl.indexOf('data:')===-1)crossorigin=true;if(!baseTexture){// new Image() breaks tex loading in some versions of Chrome.
// See https://code.google.com/p/chromium/issues/detail?id=238071
var image=new Image();//document.createElement('img');
if(crossorigin){image.crossOrigin='';}image.src=imageUrl;baseTexture=new PIXI.BaseTexture(image,scaleMode);baseTexture.imageUrl=imageUrl;PIXI.BaseTextureCache[imageUrl]=baseTexture;// if there is an @2x at the end of the url we are going to assume its a highres image
if(imageUrl.indexOf(PIXI.RETINA_PREFIX+'.')!==-1){baseTexture.resolution=2;}}return baseTexture;};/**
 * Helper function that creates a base texture from the given canvas element.
 *
 * @static
 * @method fromCanvas
 * @param canvas {Canvas} The canvas element source of the texture
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return BaseTexture
 */PIXI.BaseTexture.fromCanvas=function(canvas,scaleMode){if(!canvas._pixiId){canvas._pixiId='canvas_'+PIXI.TextureCacheIdGenerator++;}var baseTexture=PIXI.BaseTextureCache[canvas._pixiId];if(!baseTexture){baseTexture=new PIXI.BaseTexture(canvas,scaleMode);PIXI.BaseTextureCache[canvas._pixiId]=baseTexture;}return baseTexture;};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */PIXI.TextureCache={};PIXI.FrameCache={};PIXI.TextureCacheIdGenerator=0;/**
 * A texture stores the information that represents an image or part of an image. It cannot be added
 * to the display list directly. Instead use it as the texture for a PIXI.Sprite. If no frame is provided then the whole image is used.
 *
 * @class Texture
 * @uses EventTarget
 * @constructor
 * @param baseTexture {BaseTexture} The base texture source to create the texture from
 * @param [frame] {Rectangle} The rectangle frame of the texture to show
 * @param [crop] {Rectangle} The area of original texture 
 * @param [trim] {Rectangle} Trimmed texture rectangle
 */PIXI.Texture=function(baseTexture,frame,crop,trim){/**
     * Does this Texture have any frame data assigned to it?
     *
     * @property noFrame
     * @type Boolean
     */this.noFrame=false;if(!frame){this.noFrame=true;frame=new PIXI.Rectangle(0,0,1,1);}if(baseTexture instanceof PIXI.Texture){baseTexture=baseTexture.baseTexture;}/**
     * The base texture that this texture uses.
     *
     * @property baseTexture
     * @type BaseTexture
     */this.baseTexture=baseTexture;/**
     * The frame specifies the region of the base texture that this texture uses
     *
     * @property frame
     * @type Rectangle
     */this.frame=frame;/**
     * The texture trim data.
     *
     * @property trim
     * @type Rectangle
     */this.trim=trim;/**
     * This will let the renderer know if the texture is valid. If it's not then it cannot be rendered.
     *
     * @property valid
     * @type Boolean
     */this.valid=false;/**
     * This will let a renderer know that a texture has been updated (used mainly for webGL uv updates)
     *
     * @property requiresUpdate
     * @type Boolean
     */this.requiresUpdate=false;/**
     * The WebGL UV data cache.
     *
     * @property _uvs
     * @type Object
     * @private
     */this._uvs=null;/**
     * The width of the Texture in pixels.
     *
     * @property width
     * @type Number
     */this.width=0;/**
     * The height of the Texture in pixels.
     *
     * @property height
     * @type Number
     */this.height=0;/**
     * This is the area of the BaseTexture image to actually copy to the Canvas / WebGL when rendering,
     * irrespective of the actual frame size or placement (which can be influenced by trimmed texture atlases)
     *
     * @property crop
     * @type Rectangle
     */this.crop=crop||new PIXI.Rectangle(0,0,1,1);if(baseTexture.hasLoaded){if(this.noFrame)frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(frame);}else{baseTexture.addEventListener('loaded',this.onBaseTextureLoaded.bind(this));}};PIXI.Texture.prototype.constructor=PIXI.Texture;PIXI.EventTarget.mixin(PIXI.Texture.prototype);/**
 * Called when the base texture is loaded
 *
 * @method onBaseTextureLoaded
 * @private
 */PIXI.Texture.prototype.onBaseTextureLoaded=function(){var baseTexture=this.baseTexture;baseTexture.removeEventListener('loaded',this.onLoaded);if(this.noFrame)this.frame=new PIXI.Rectangle(0,0,baseTexture.width,baseTexture.height);this.setFrame(this.frame);this.dispatchEvent({type:'update',content:this});};/**
 * Destroys this texture
 *
 * @method destroy
 * @param destroyBase {Boolean} Whether to destroy the base texture as well
 */PIXI.Texture.prototype.destroy=function(destroyBase){if(destroyBase)this.baseTexture.destroy();this.valid=false;};/**
 * Specifies the region of the baseTexture that this texture will use.
 *
 * @method setFrame
 * @param frame {Rectangle} The frame of the texture to set it to
 */PIXI.Texture.prototype.setFrame=function(frame){this.noFrame=false;this.frame=frame;this.width=frame.width;this.height=frame.height;this.crop.x=frame.x;this.crop.y=frame.y;this.crop.width=frame.width;this.crop.height=frame.height;if(!this.trim&&(frame.x+frame.width>this.baseTexture.width||frame.y+frame.height>this.baseTexture.height)){throw new Error('Texture Error: frame does not fit inside the base Texture dimensions '+this);}this.valid=frame&&frame.width&&frame.height&&this.baseTexture.source&&this.baseTexture.hasLoaded;if(this.trim){this.width=this.trim.width;this.height=this.trim.height;this.frame.width=this.trim.width;this.frame.height=this.trim.height;}if(this.valid)this._updateUvs();};/**
 * Updates the internal WebGL UV cache.
 *
 * @method _updateUvs
 * @private
 */PIXI.Texture.prototype._updateUvs=function(){if(!this._uvs)this._uvs=new PIXI.TextureUvs();var frame=this.crop;var tw=this.baseTexture.width;var th=this.baseTexture.height;this._uvs.x0=frame.x/tw;this._uvs.y0=frame.y/th;this._uvs.x1=(frame.x+frame.width)/tw;this._uvs.y1=frame.y/th;this._uvs.x2=(frame.x+frame.width)/tw;this._uvs.y2=(frame.y+frame.height)/th;this._uvs.x3=frame.x/tw;this._uvs.y3=(frame.y+frame.height)/th;};/**
 * Helper function that creates a Texture object from the given image url.
 * If the image is not in the texture cache it will be  created and loaded.
 *
 * @static
 * @method fromImage
 * @param imageUrl {String} The image url of the texture
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return Texture
 */PIXI.Texture.fromImage=function(imageUrl,crossorigin,scaleMode){var texture=PIXI.TextureCache[imageUrl];if(!texture){texture=new PIXI.Texture(PIXI.BaseTexture.fromImage(imageUrl,crossorigin,scaleMode));PIXI.TextureCache[imageUrl]=texture;}return texture;};/**
 * Helper function that returns a Texture objected based on the given frame id.
 * If the frame id is not in the texture cache an error will be thrown.
 *
 * @static
 * @method fromFrame
 * @param frameId {String} The frame id of the texture
 * @return Texture
 */PIXI.Texture.fromFrame=function(frameId){var texture=PIXI.TextureCache[frameId];if(!texture)throw new Error('The frameId "'+frameId+'" does not exist in the texture cache ');return texture;};/**
 * Helper function that creates a new a Texture based on the given canvas element.
 *
 * @static
 * @method fromCanvas
 * @param canvas {Canvas} The canvas element source of the texture
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return Texture
 */PIXI.Texture.fromCanvas=function(canvas,scaleMode){var baseTexture=PIXI.BaseTexture.fromCanvas(canvas,scaleMode);return new PIXI.Texture(baseTexture);};/**
 * Adds a texture to the global PIXI.TextureCache. This cache is shared across the whole PIXI object.
 *
 * @static
 * @method addTextureToCache
 * @param texture {Texture} The Texture to add to the cache.
 * @param id {String} The id that the texture will be stored against.
 */PIXI.Texture.addTextureToCache=function(texture,id){PIXI.TextureCache[id]=texture;};/**
 * Remove a texture from the global PIXI.TextureCache.
 *
 * @static
 * @method removeTextureFromCache
 * @param id {String} The id of the texture to be removed
 * @return {Texture} The texture that was removed
 */PIXI.Texture.removeTextureFromCache=function(id){var texture=PIXI.TextureCache[id];delete PIXI.TextureCache[id];delete PIXI.BaseTextureCache[id];return texture;};PIXI.TextureUvs=function(){this.x0=0;this.y0=0;this.x1=0;this.y1=0;this.x2=0;this.y2=0;this.x3=0;this.y3=0;};PIXI.Texture.emptyTexture=new PIXI.Texture(new PIXI.BaseTexture());/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A RenderTexture is a special texture that allows any Pixi display object to be rendered to it.
 *
 * __Hint__: All DisplayObjects (i.e. Sprites) that render to a RenderTexture should be preloaded otherwise black rectangles will be drawn instead.
 *
 * A RenderTexture takes a snapshot of any Display Object given to its render method. The position and rotation of the given Display Objects is ignored. For example:
 *
 *    var renderTexture = new PIXI.RenderTexture(800, 600);
 *    var sprite = PIXI.Sprite.fromImage("spinObj_01.png");
 *    sprite.position.x = 800/2;
 *    sprite.position.y = 600/2;
 *    sprite.anchor.x = 0.5;
 *    sprite.anchor.y = 0.5;
 *    renderTexture.render(sprite);
 *
 * The Sprite in this case will be rendered to a position of 0,0. To render this sprite at its actual position a DisplayObjectContainer should be used:
 *
 *    var doc = new PIXI.DisplayObjectContainer();
 *    doc.addChild(sprite);
 *    renderTexture.render(doc);  // Renders to center of renderTexture
 *
 * @class RenderTexture
 * @extends Texture
 * @constructor
 * @param width {Number} The width of the render texture
 * @param height {Number} The height of the render texture
 * @param renderer {CanvasRenderer|WebGLRenderer} The renderer used for this RenderTexture
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @param resolution {Number} The resolution of the texture being generated
 */PIXI.RenderTexture=function(width,height,renderer,scaleMode,resolution){/**
     * The with of the render texture
     *
     * @property width
     * @type Number
     */this.width=width||100;/**
     * The height of the render texture
     *
     * @property height
     * @type Number
     */this.height=height||100;/**
     * The Resolution of the texture.
     *
     * @property resolution
     * @type Number
     */this.resolution=resolution||1;/**
     * The framing rectangle of the render texture
     *
     * @property frame
     * @type Rectangle
     */this.frame=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);/**
     * This is the area of the BaseTexture image to actually copy to the Canvas / WebGL when rendering,
     * irrespective of the actual frame size or placement (which can be influenced by trimmed texture atlases)
     *
     * @property crop
     * @type Rectangle
     */this.crop=new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution);/**
     * The base texture object that this texture uses
     *
     * @property baseTexture
     * @type BaseTexture
     */this.baseTexture=new PIXI.BaseTexture();this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution;this.baseTexture._glTextures=[];this.baseTexture.resolution=this.resolution;this.baseTexture.scaleMode=scaleMode||PIXI.scaleModes.DEFAULT;this.baseTexture.hasLoaded=true;PIXI.Texture.call(this,this.baseTexture,new PIXI.Rectangle(0,0,this.width*this.resolution,this.height*this.resolution));/**
     * The renderer this RenderTexture uses. A RenderTexture can only belong to one renderer at the moment if its webGL.
     *
     * @property renderer
     * @type CanvasRenderer|WebGLRenderer
     */this.renderer=renderer||PIXI.defaultRenderer;if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;this.baseTexture._dirty[gl.id]=false;this.textureBuffer=new PIXI.FilterTexture(gl,this.width,this.height,this.baseTexture.scaleMode);this.baseTexture._glTextures[gl.id]=this.textureBuffer.texture;this.render=this.renderWebGL;this.projection=new PIXI.Point(this.width*0.5,-this.height*0.5);}else{this.render=this.renderCanvas;this.textureBuffer=new PIXI.CanvasBuffer(this.width*this.resolution,this.height*this.resolution);this.baseTexture.source=this.textureBuffer.canvas;}/**
     * @property valid
     * @type Boolean
     */this.valid=true;this._updateUvs();};PIXI.RenderTexture.prototype=Object.create(PIXI.Texture.prototype);PIXI.RenderTexture.prototype.constructor=PIXI.RenderTexture;/**
 * Resizes the RenderTexture.
 *
 * @method resize
 * @param width {Number} The width to resize to.
 * @param height {Number} The height to resize to.
 * @param updateBase {Boolean} Should the baseTexture.width and height values be resized as well?
 */PIXI.RenderTexture.prototype.resize=function(width,height,updateBase){if(width===this.width&&height===this.height)return;this.valid=width>0&&height>0;this.width=width;this.height=height;this.frame.width=this.crop.width=width*this.resolution;this.frame.height=this.crop.height=height*this.resolution;if(updateBase){this.baseTexture.width=this.width*this.resolution;this.baseTexture.height=this.height*this.resolution;}if(this.renderer.type===PIXI.WEBGL_RENDERER){this.projection.x=this.width/2;this.projection.y=-this.height/2;}if(!this.valid)return;this.textureBuffer.resize(this.width,this.height);};/**
 * Clears the RenderTexture.
 *
 * @method clear
 */PIXI.RenderTexture.prototype.clear=function(){if(!this.valid)return;if(this.renderer.type===PIXI.WEBGL_RENDERER){this.renderer.gl.bindFramebuffer(this.renderer.gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);}this.textureBuffer.clear();};/**
 * This function will draw the display object to the texture.
 *
 * @method renderWebGL
 * @param displayObject {DisplayObject} The display object to render this texture on
 * @param [matrix] {Matrix} Optional matrix to apply to the display object before rendering.
 * @param [clear] {Boolean} If true the texture will be cleared before the displayObject is drawn
 * @private
 */PIXI.RenderTexture.prototype.renderWebGL=function(displayObject,matrix,clear){if(!this.valid)return;//TOOD replace position with matrix..
//Lets create a nice matrix to apply to our display object. Frame buffers come in upside down so we need to flip the matrix 
var wt=displayObject.worldTransform;wt.identity();wt.translate(0,this.projection.y*2);if(matrix)wt.append(matrix);wt.scale(1,-1);// setWorld Alpha to ensure that the object is renderer at full opacity
displayObject.worldAlpha=1;// Time to update all the children of the displayObject with the new matrix..    
var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform();}// time for the webGL fun stuff!
var gl=this.renderer.gl;gl.viewport(0,0,this.width*this.resolution,this.height*this.resolution);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);if(clear)this.textureBuffer.clear();this.renderer.spriteBatch.dirty=true;this.renderer.renderDisplayObject(displayObject,this.projection,this.textureBuffer.frameBuffer);this.renderer.spriteBatch.dirty=true;};/**
 * This function will draw the display object to the texture.
 *
 * @method renderCanvas
 * @param displayObject {DisplayObject} The display object to render this texture on
 * @param [matrix] {Matrix} Optional matrix to apply to the display object before rendering.
 * @param [clear] {Boolean} If true the texture will be cleared before the displayObject is drawn
 * @private
 */PIXI.RenderTexture.prototype.renderCanvas=function(displayObject,matrix,clear){if(!this.valid)return;var wt=displayObject.worldTransform;wt.identity();if(matrix)wt.append(matrix);// setWorld Alpha to ensure that the object is renderer at full opacity
displayObject.worldAlpha=1;// Time to update all the children of the displayObject with the new matrix..    
var children=displayObject.children;for(var i=0,j=children.length;i<j;i++){children[i].updateTransform();}if(clear)this.textureBuffer.clear();var context=this.textureBuffer.context;var realResolution=this.renderer.resolution;this.renderer.resolution=this.resolution;this.renderer.renderDisplayObject(displayObject,context);this.renderer.resolution=realResolution;};/**
 * Will return a HTML Image of the texture
 *
 * @method getImage
 * @return {Image}
 */PIXI.RenderTexture.prototype.getImage=function(){var image=new Image();image.src=this.getBase64();return image;};/**
 * Will return a a base64 encoded string of this texture. It works by calling RenderTexture.getCanvas and then running toDataURL on that.
 *
 * @method getBase64
 * @return {String} A base64 encoded string of the texture.
 */PIXI.RenderTexture.prototype.getBase64=function(){return this.getCanvas().toDataURL();};/**
 * Creates a Canvas element, renders this RenderTexture to it and then returns it.
 *
 * @method getCanvas
 * @return {HTMLCanvasElement} A Canvas element with the texture rendered on.
 */PIXI.RenderTexture.prototype.getCanvas=function(){if(this.renderer.type===PIXI.WEBGL_RENDERER){var gl=this.renderer.gl;var width=this.textureBuffer.width;var height=this.textureBuffer.height;var webGLPixels=new Uint8Array(4*width*height);gl.bindFramebuffer(gl.FRAMEBUFFER,this.textureBuffer.frameBuffer);gl.readPixels(0,0,width,height,gl.RGBA,gl.UNSIGNED_BYTE,webGLPixels);gl.bindFramebuffer(gl.FRAMEBUFFER,null);var tempCanvas=new PIXI.CanvasBuffer(width,height);var canvasData=tempCanvas.context.getImageData(0,0,width,height);canvasData.data.set(webGLPixels);tempCanvas.context.putImageData(canvasData,0,0);return tempCanvas.canvas;}else{return this.textureBuffer.canvas;}};PIXI.RenderTexture.tempMatrix=new PIXI.Matrix();/**
 * A texture of a [playing] Video.
 *
 * See the ["deus" demo](http://www.goodboydigital.com/pixijs/examples/deus/).
 *
 * @class VideoTexture
 * @extends BaseTexture
 * @constructor
 * @param source {HTMLVideoElement}
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 */PIXI.VideoTexture=function(source,scaleMode){if(!source){throw new Error('No video source element specified.');}// hook in here to check if video is already available.
// PIXI.BaseTexture looks for a source.complete boolean, plus width & height.
if((source.readyState===source.HAVE_ENOUGH_DATA||source.readyState===source.HAVE_FUTURE_DATA)&&source.width&&source.height){source.complete=true;}PIXI.BaseTexture.call(this,source,scaleMode);this.autoUpdate=false;this.updateBound=this._onUpdate.bind(this);if(!source.complete){this._onCanPlay=this.onCanPlay.bind(this);source.addEventListener('canplay',this._onCanPlay);source.addEventListener('canplaythrough',this._onCanPlay);// started playing..
source.addEventListener('play',this.onPlayStart.bind(this));source.addEventListener('pause',this.onPlayStop.bind(this));}};PIXI.VideoTexture.prototype=Object.create(PIXI.BaseTexture.prototype);PIXI.VideoTexture.constructor=PIXI.VideoTexture;PIXI.VideoTexture.prototype._onUpdate=function(){if(this.autoUpdate){window.requestAnimationFrame(this.updateBound);this.dirty();}};PIXI.VideoTexture.prototype.onPlayStart=function(){if(!this.autoUpdate){window.requestAnimationFrame(this.updateBound);this.autoUpdate=true;}};PIXI.VideoTexture.prototype.onPlayStop=function(){this.autoUpdate=false;};PIXI.VideoTexture.prototype.onCanPlay=function(){if(event.type==='canplaythrough'){this.hasLoaded=true;if(this.source){this.source.removeEventListener('canplay',this._onCanPlay);this.source.removeEventListener('canplaythrough',this._onCanPlay);this.width=this.source.videoWidth;this.height=this.source.videoHeight;// prevent multiple loaded dispatches..
if(!this.__loaded){this.__loaded=true;this.dispatchEvent({type:'loaded',content:this});}}}};PIXI.VideoTexture.prototype.destroy=function(){if(this.source&&this.source._pixiId){PIXI.BaseTextureCache[this.source._pixiId]=null;delete PIXI.BaseTextureCache[this.source._pixiId];this.source._pixiId=null;delete this.source._pixiId;}PIXI.BaseTexture.prototype.destroy.call(this);};/**
 * Mimic Pixi BaseTexture.from.... method.
 *
 * @static
 * @method baseTextureFromVideo
 * @param video {HTMLVideoElement}
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return {VideoTexture}
 */PIXI.VideoTexture.baseTextureFromVideo=function(video,scaleMode){if(!video._pixiId){video._pixiId='video_'+PIXI.TextureCacheIdGenerator++;}var baseTexture=PIXI.BaseTextureCache[video._pixiId];if(!baseTexture){baseTexture=new PIXI.VideoTexture(video,scaleMode);PIXI.BaseTextureCache[video._pixiId]=baseTexture;}return baseTexture;};/**
 * Mimic Pixi BaseTexture.from.... method.
 *
 * @static
 * @method textureFromVideo 
 * @param video {HTMLVideoElement}
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return {Texture} A Texture, but not a VideoTexture.
 */PIXI.VideoTexture.textureFromVideo=function(video,scaleMode){var baseTexture=PIXI.VideoTexture.baseTextureFromVideo(video,scaleMode);return new PIXI.Texture(baseTexture);};/**
 * Mimic Pixi BaseTexture.from.... method.
 *
 * @static
 * @method fromUrl 
 * @param videoSrc {String} The URL for the video.
 * @param scaleMode {Number} See {{#crossLink "PIXI/scaleModes:property"}}PIXI.scaleModes{{/crossLink}} for possible values
 * @return {VideoTexture}
 */PIXI.VideoTexture.fromUrl=function(videoSrc,scaleMode){var video=document.createElement('video');video.src=videoSrc;video.autoPlay=true;video.play();return PIXI.VideoTexture.textureFromVideo(video,scaleMode);};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A Class that loads a bunch of images / sprite sheet / bitmap font files. Once the
 * assets have been loaded they are added to the PIXI Texture cache and can be accessed
 * easily through PIXI.Texture.fromImage() and PIXI.Sprite.fromImage()
 * When all items have been loaded this class will dispatch a 'onLoaded' event
 * As each individual item is loaded this class will dispatch a 'onProgress' event
 *
 * @class AssetLoader
 * @constructor
 * @uses EventTarget
 * @param assetURLs {Array(String)} An array of image/sprite sheet urls that you would like loaded
 *      supported. Supported image formats include 'jpeg', 'jpg', 'png', 'gif'. Supported
 *      sprite sheet data formats only include 'JSON' at this time. Supported bitmap font
 *      data formats include 'xml' and 'fnt'.
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.AssetLoader=function(assetURLs,crossorigin){/**
     * The array of asset URLs that are going to be loaded
     *
     * @property assetURLs
     * @type Array(String)
     */this.assetURLs=assetURLs;/**
     * Whether the requests should be treated as cross origin
     *
     * @property crossorigin
     * @type Boolean
     */this.crossorigin=crossorigin;/**
     * Maps file extension to loader types
     *
     * @property loadersByType
     * @type Object
     */this.loadersByType={'jpg':PIXI.ImageLoader,'jpeg':PIXI.ImageLoader,'png':PIXI.ImageLoader,'gif':PIXI.ImageLoader,'webp':PIXI.ImageLoader,'json':PIXI.JsonLoader,'atlas':PIXI.AtlasLoader,'anim':PIXI.SpineLoader,'xml':PIXI.BitmapFontLoader,'fnt':PIXI.BitmapFontLoader};};PIXI.EventTarget.mixin(PIXI.AssetLoader.prototype);/**
 * Fired when an item has loaded
 * @event onProgress
 */ /**
 * Fired when all the assets have loaded
 * @event onComplete
 */ // constructor
PIXI.AssetLoader.prototype.constructor=PIXI.AssetLoader;/**
 * Given a filename, returns its extension.
 *
 * @method _getDataType
 * @param str {String} the name of the asset
 */PIXI.AssetLoader.prototype._getDataType=function(str){var test='data:';//starts with 'data:'
var start=str.slice(0,test.length).toLowerCase();if(start===test){var data=str.slice(test.length);var sepIdx=data.indexOf(',');if(sepIdx===-1)//malformed data URI scheme
return null;//e.g. 'image/gif;base64' => 'image/gif'
var info=data.slice(0,sepIdx).split(';')[0];//We might need to handle some special cases here...
//standardize text/plain to 'txt' file extension
if(!info||info.toLowerCase()==='text/plain')return'txt';//User specified mime type, try splitting it by '/'
return info.split('/').pop().toLowerCase();}return null;};/**
 * Starts loading the assets sequentially
 *
 * @method load
 */PIXI.AssetLoader.prototype.load=function(){var scope=this;function onLoad(evt){scope.onAssetLoaded(evt.data.content);}this.loadCount=this.assetURLs.length;for(var i=0;i<this.assetURLs.length;i++){var fileName=this.assetURLs[i];//first see if we have a data URI scheme..
var fileType=this._getDataType(fileName);//if not, assume it's a file URI
if(!fileType)fileType=fileName.split('?').shift().split('.').pop().toLowerCase();var Constructor=this.loadersByType[fileType];if(!Constructor)throw new Error(fileType+' is an unsupported file type');var loader=new Constructor(fileName,this.crossorigin);loader.on('loaded',onLoad);loader.load();}};/**
 * Invoked after each file is loaded
 *
 * @method onAssetLoaded
 * @private
 */PIXI.AssetLoader.prototype.onAssetLoaded=function(loader){this.loadCount--;this.emit('onProgress',{content:this,loader:loader,loaded:this.assetURLs.length-this.loadCount,total:this.assetURLs.length});if(this.onProgress)this.onProgress(loader);if(!this.loadCount){this.emit('onComplete',{content:this});if(this.onComplete)this.onComplete();}};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The json file loader is used to load in JSON data and parse it
 * When loaded this class will dispatch a 'loaded' event
 * If loading fails this class will dispatch an 'error' event
 *
 * @class JsonLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the JSON file
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.JsonLoader=function(url,crossorigin){/**
     * The url of the bitmap font data
     *
     * @property url
     * @type String
     */this.url=url;/**
     * Whether the requests should be treated as cross origin
     *
     * @property crossorigin
     * @type Boolean
     */this.crossorigin=crossorigin;/**
     * [read-only] The base url of the bitmap font data
     *
     * @property baseUrl
     * @type String
     * @readOnly
     */this.baseUrl=url.replace(/[^\/]*$/,'');/**
     * [read-only] Whether the data has loaded yet
     *
     * @property loaded
     * @type Boolean
     * @readOnly
     */this.loaded=false;};// constructor
PIXI.JsonLoader.prototype.constructor=PIXI.JsonLoader;PIXI.EventTarget.mixin(PIXI.JsonLoader.prototype);/**
 * Loads the JSON data
 *
 * @method load
 */PIXI.JsonLoader.prototype.load=function(){if(window.XDomainRequest&&this.crossorigin){this.ajaxRequest=new window.XDomainRequest();// XDomainRequest has a few quirks. Occasionally it will abort requests
// A way to avoid this is to make sure ALL callbacks are set even if not used
// More info here: http://stackoverflow.com/questions/15786966/xdomainrequest-aborts-post-on-ie-9
this.ajaxRequest.timeout=3000;this.ajaxRequest.onerror=this.onError.bind(this);this.ajaxRequest.ontimeout=this.onError.bind(this);this.ajaxRequest.onprogress=function(){};this.ajaxRequest.onload=this.onJSONLoaded.bind(this);}else{if(window.XMLHttpRequest){this.ajaxRequest=new window.XMLHttpRequest();}else{this.ajaxRequest=new window.ActiveXObject('Microsoft.XMLHTTP');}this.ajaxRequest.onreadystatechange=this.onReadyStateChanged.bind(this);}this.ajaxRequest.open('GET',this.url,true);this.ajaxRequest.send();};/**
 * Bridge function to be able to use the more reliable onreadystatechange in XMLHttpRequest.
 *
 * @method onReadyStateChanged
 * @private
 */PIXI.JsonLoader.prototype.onReadyStateChanged=function(){if(this.ajaxRequest.readyState===4&&(this.ajaxRequest.status===200||window.location.href.indexOf('http')===-1)){this.onJSONLoaded();}};/**
 * Invoke when JSON file is loaded
 *
 * @method onJSONLoaded
 * @private
 */PIXI.JsonLoader.prototype.onJSONLoaded=function(){if(!this.ajaxRequest.responseText){this.onError();return;}this.json=JSON.parse(this.ajaxRequest.responseText);if(this.json.frames&&this.json.meta&&this.json.meta.image){// sprite sheet
var textureUrl=this.json.meta.image;if(textureUrl.indexOf('data:')===-1){textureUrl=this.baseUrl+textureUrl;}var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);var frameData=this.json.frames;this.texture=image.texture.baseTexture;image.addEventListener('loaded',this.onLoaded.bind(this));for(var i in frameData){var rect=frameData[i].frame;if(rect){var textureSize=new PIXI.Rectangle(rect.x,rect.y,rect.w,rect.h);var crop=textureSize.clone();var trim=null;//  Check to see if the sprite is trimmed
if(frameData[i].trimmed){var actualSize=frameData[i].sourceSize;var realSize=frameData[i].spriteSourceSize;trim=new PIXI.Rectangle(realSize.x,realSize.y,actualSize.w,actualSize.h);}PIXI.TextureCache[i]=new PIXI.Texture(this.texture,textureSize,crop,trim);}}image.load();}else if(this.json.bones){/* check if the json was loaded before */if(PIXI.AnimCache[this.url]){this.onLoaded();}else{/* use a bit of hackery to load the atlas file, here we assume that the .json, .atlas and .png files
			 * that correspond to the spine file are in the same base URL and that the .json and .atlas files
			 * have the same name
			*/var atlasPath=this.url.substr(0,this.url.lastIndexOf('.'))+'.atlas';var atlasLoader=new PIXI.JsonLoader(atlasPath,this.crossorigin);// save a copy of the current object for future reference //
var originalLoader=this;// before loading the file, replace the "onJSONLoaded" function for our own //
atlasLoader.onJSONLoaded=function(){// at this point "this" points at the atlasLoader (JsonLoader) instance //
if(!this.ajaxRequest.responseText){this.onError();// FIXME: hmm, this is funny because we are not responding to errors yet
return;}// create a new instance of a spine texture loader for this spine object //
var textureLoader=new PIXI.SpineTextureLoader(this.url.substring(0,this.url.lastIndexOf('/')));// create a spine atlas using the loaded text and a spine texture loader instance //
var spineAtlas=new spine.Atlas(this.ajaxRequest.responseText,textureLoader);// now we use an atlas attachment loader //
var attachmentLoader=new spine.AtlasAttachmentLoader(spineAtlas);// spine animation
var spineJsonParser=new spine.SkeletonJson(attachmentLoader);var skeletonData=spineJsonParser.readSkeletonData(originalLoader.json);PIXI.AnimCache[originalLoader.url]=skeletonData;originalLoader.spine=skeletonData;originalLoader.spineAtlas=spineAtlas;originalLoader.spineAtlasLoader=atlasLoader;// wait for textures to finish loading if needed
if(textureLoader.loadingCount>0){textureLoader.addEventListener('loadedBaseTexture',function(evt){if(evt.content.content.loadingCount<=0){originalLoader.onLoaded();}});}else{originalLoader.onLoaded();}};// start the loading //
atlasLoader.load();}}else{this.onLoaded();}};/**
 * Invoke when json file loaded
 *
 * @method onLoaded
 * @private
 */PIXI.JsonLoader.prototype.onLoaded=function(){this.loaded=true;this.dispatchEvent({type:'loaded',content:this});};/**
 * Invoke when error occured
 *
 * @method onError
 * @private
 */PIXI.JsonLoader.prototype.onError=function(){this.dispatchEvent({type:'error',content:this});};/**
 * @author Martin Kelm http://mkelm.github.com
 */ /**
 * The atlas file loader is used to load in Texture Atlas data and parse it. When loaded this class will dispatch a 'loaded' event. If loading fails this class will dispatch an 'error' event.
 *
 * To generate the data you can use http://www.codeandweb.com/texturepacker and publish in the 'JSON' format.
 * 
 * It is highly recommended to use texture atlases (also know as 'sprite sheets') as it allowed sprites to be batched and drawn together for highly increased rendering speed.
 * Once the data has been loaded the frames are stored in the PIXI texture cache and can be accessed though PIXI.Texture.fromFrameId() and PIXI.Sprite.fromFrameId()
 * 
 * @class AtlasLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the JSON file
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.AtlasLoader=function(url,crossorigin){this.url=url;this.baseUrl=url.replace(/[^\/]*$/,'');this.crossorigin=crossorigin;this.loaded=false;};// constructor
PIXI.AtlasLoader.constructor=PIXI.AtlasLoader;PIXI.EventTarget.mixin(PIXI.AtlasLoader.prototype);/**
 * Starts loading the JSON file
 *
 * @method load
 */PIXI.AtlasLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest();this.ajaxRequest.onreadystatechange=this.onAtlasLoaded.bind(this);this.ajaxRequest.open('GET',this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType('application/json');this.ajaxRequest.send(null);};/**
 * Invoked when the Atlas has fully loaded. Parses the JSON and builds the texture frames.
 * 
 * @method onAtlasLoaded
 * @private
 */PIXI.AtlasLoader.prototype.onAtlasLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.href.indexOf('http')===-1){this.atlas={meta:{image:[]},frames:[]};var result=this.ajaxRequest.responseText.split(/\r?\n/);var lineCount=-3;var currentImageId=0;var currentFrame=null;var nameInNextLine=false;var i=0,j=0,selfOnLoaded=this.onLoaded.bind(this);// parser without rotation support yet!
for(i=0;i<result.length;i++){result[i]=result[i].replace(/^\s+|\s+$/g,'');if(result[i]===''){nameInNextLine=i+1;}if(result[i].length>0){if(nameInNextLine===i){this.atlas.meta.image.push(result[i]);currentImageId=this.atlas.meta.image.length-1;this.atlas.frames.push({});lineCount=-3;}else if(lineCount>0){if(lineCount%7===1){// frame name
if(currentFrame!=null){//jshint ignore:line
this.atlas.frames[currentImageId][currentFrame.name]=currentFrame;}currentFrame={name:result[i],frame:{}};}else{var text=result[i].split(' ');if(lineCount%7===3){// position
currentFrame.frame.x=Number(text[1].replace(',',''));currentFrame.frame.y=Number(text[2]);}else if(lineCount%7===4){// size
currentFrame.frame.w=Number(text[1].replace(',',''));currentFrame.frame.h=Number(text[2]);}else if(lineCount%7===5){// real size
var realSize={x:0,y:0,w:Number(text[1].replace(',','')),h:Number(text[2])};if(realSize.w>currentFrame.frame.w||realSize.h>currentFrame.frame.h){currentFrame.trimmed=true;currentFrame.realSize=realSize;}else{currentFrame.trimmed=false;}}}}lineCount++;}}if(currentFrame!=null){//jshint ignore:line
this.atlas.frames[currentImageId][currentFrame.name]=currentFrame;}if(this.atlas.meta.image.length>0){this.images=[];for(j=0;j<this.atlas.meta.image.length;j++){// sprite sheet
var textureUrl=this.baseUrl+this.atlas.meta.image[j];var frameData=this.atlas.frames[j];this.images.push(new PIXI.ImageLoader(textureUrl,this.crossorigin));for(i in frameData){var rect=frameData[i].frame;if(rect){PIXI.TextureCache[i]=new PIXI.Texture(this.images[j].texture.baseTexture,{x:rect.x,y:rect.y,width:rect.w,height:rect.h});if(frameData[i].trimmed){PIXI.TextureCache[i].realSize=frameData[i].realSize;// trim in pixi not supported yet, todo update trim properties if it is done ...
PIXI.TextureCache[i].trim.x=0;PIXI.TextureCache[i].trim.y=0;}}}}this.currentImageId=0;for(j=0;j<this.images.length;j++){this.images[j].on('loaded',selfOnLoaded);}this.images[this.currentImageId].load();}else{this.onLoaded();}}else{this.onError();}}};/**
 * Invoked when json file has loaded.
 * 
 * @method onLoaded
 * @private
 */PIXI.AtlasLoader.prototype.onLoaded=function(){if(this.images.length-1>this.currentImageId){this.currentImageId++;this.images[this.currentImageId].load();}else{this.loaded=true;this.emit('loaded',{content:this});}};/**
 * Invoked when an error occurs.
 * 
 * @method onError
 * @private
 */PIXI.AtlasLoader.prototype.onError=function(){this.emit('error',{content:this});};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The sprite sheet loader is used to load in JSON sprite sheet data
 * To generate the data you can use http://www.codeandweb.com/texturepacker and publish in the 'JSON' format
 * There is a free version so thats nice, although the paid version is great value for money.
 * It is highly recommended to use Sprite sheets (also know as a 'texture atlas') as it means sprites can be batched and drawn together for highly increased rendering speed.
 * Once the data has been loaded the frames are stored in the PIXI texture cache and can be accessed though PIXI.Texture.fromFrameId() and PIXI.Sprite.fromFrameId()
 * This loader will load the image file that the Spritesheet points to as well as the data.
 * When loaded this class will dispatch a 'loaded' event
 *
 * @class SpriteSheetLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the sprite sheet JSON file
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.SpriteSheetLoader=function(url,crossorigin){/**
     * The url of the atlas data
     *
     * @property url
     * @type String
     */this.url=url;/**
     * Whether the requests should be treated as cross origin
     *
     * @property crossorigin
     * @type Boolean
     */this.crossorigin=crossorigin;/**
     * [read-only] The base url of the bitmap font data
     *
     * @property baseUrl
     * @type String
     * @readOnly
     */this.baseUrl=url.replace(/[^\/]*$/,'');/**
     * The texture being loaded
     *
     * @property texture
     * @type Texture
     */this.texture=null;/**
     * The frames of the sprite sheet
     *
     * @property frames
     * @type Object
     */this.frames={};};// constructor
PIXI.SpriteSheetLoader.prototype.constructor=PIXI.SpriteSheetLoader;PIXI.EventTarget.mixin(PIXI.SpriteSheetLoader.prototype);/**
 * This will begin loading the JSON file
 *
 * @method load
 */PIXI.SpriteSheetLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.on('loaded',function(event){scope.json=event.data.content.json;scope.onLoaded();});jsonLoader.load();};/**
 * Invoke when all files are loaded (json and texture)
 *
 * @method onLoaded
 * @private
 */PIXI.SpriteSheetLoader.prototype.onLoaded=function(){this.emit('loaded',{content:this});};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The image loader class is responsible for loading images file formats ('jpeg', 'jpg', 'png' and 'gif')
 * Once the image has been loaded it is stored in the PIXI texture cache and can be accessed though PIXI.Texture.fromFrame() and PIXI.Sprite.fromFrame()
 * When loaded this class will dispatch a 'loaded' event
 *
 * @class ImageLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the image
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.ImageLoader=function(url,crossorigin){/**
     * The texture being loaded
     *
     * @property texture
     * @type Texture
     */this.texture=PIXI.Texture.fromImage(url,crossorigin);/**
     * if the image is loaded with loadFramedSpriteSheet
     * frames will contain the sprite sheet frames
     *
     * @property frames
     * @type Array
     * @readOnly
     */this.frames=[];};// constructor
PIXI.ImageLoader.prototype.constructor=PIXI.ImageLoader;PIXI.EventTarget.mixin(PIXI.ImageLoader.prototype);/**
 * Loads image or takes it from cache
 *
 * @method load
 */PIXI.ImageLoader.prototype.load=function(){if(!this.texture.baseTexture.hasLoaded){this.texture.baseTexture.on('loaded',this.onLoaded.bind(this));}else{this.onLoaded();}};/**
 * Invoked when image file is loaded or it is already cached and ready to use
 *
 * @method onLoaded
 * @private
 */PIXI.ImageLoader.prototype.onLoaded=function(){this.emit('loaded',{content:this});};/**
 * Loads image and split it to uniform sized frames
 *
 * @method loadFramedSpriteSheet
 * @param frameWidth {Number} width of each frame
 * @param frameHeight {Number} height of each frame
 * @param textureName {String} if given, the frames will be cached in <textureName>-<ord> format
 */PIXI.ImageLoader.prototype.loadFramedSpriteSheet=function(frameWidth,frameHeight,textureName){this.frames=[];var cols=Math.floor(this.texture.width/frameWidth);var rows=Math.floor(this.texture.height/frameHeight);var i=0;for(var y=0;y<rows;y++){for(var x=0;x<cols;x++,i++){var texture=new PIXI.Texture(this.texture.baseTexture,{x:x*frameWidth,y:y*frameHeight,width:frameWidth,height:frameHeight});this.frames.push(texture);if(textureName)PIXI.TextureCache[textureName+'-'+i]=texture;}}this.load();};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The xml loader is used to load in XML bitmap font data ('xml' or 'fnt')
 * To generate the data you can use http://www.angelcode.com/products/bmfont/
 * This loader will also load the image file as the data.
 * When loaded this class will dispatch a 'loaded' event
 *
 * @class BitmapFontLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the sprite sheet JSON file
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.BitmapFontLoader=function(url,crossorigin){/**
     * The url of the bitmap font data
     *
     * @property url
     * @type String
     */this.url=url;/**
     * Whether the requests should be treated as cross origin
     *
     * @property crossorigin
     * @type Boolean
     */this.crossorigin=crossorigin;/**
     * [read-only] The base url of the bitmap font data
     *
     * @property baseUrl
     * @type String
     * @readOnly
     */this.baseUrl=url.replace(/[^\/]*$/,'');/**
     * [read-only] The texture of the bitmap font
     *
     * @property texture
     * @type Texture
     */this.texture=null;};// constructor
PIXI.BitmapFontLoader.prototype.constructor=PIXI.BitmapFontLoader;PIXI.EventTarget.mixin(PIXI.BitmapFontLoader.prototype);/**
 * Loads the XML font data
 *
 * @method load
 */PIXI.BitmapFontLoader.prototype.load=function(){this.ajaxRequest=new PIXI.AjaxRequest();this.ajaxRequest.onreadystatechange=this.onXMLLoaded.bind(this);this.ajaxRequest.open('GET',this.url,true);if(this.ajaxRequest.overrideMimeType)this.ajaxRequest.overrideMimeType('application/xml');this.ajaxRequest.send(null);};/**
 * Invoked when the XML file is loaded, parses the data.
 *
 * @method onXMLLoaded
 * @private
 */PIXI.BitmapFontLoader.prototype.onXMLLoaded=function(){if(this.ajaxRequest.readyState===4){if(this.ajaxRequest.status===200||window.location.protocol.indexOf('http')===-1){var responseXML=this.ajaxRequest.responseXML;if(!responseXML||/MSIE 9/i.test(navigator.userAgent)||navigator.isCocoonJS){if(typeof window.DOMParser==='function'){var domparser=new DOMParser();responseXML=domparser.parseFromString(this.ajaxRequest.responseText,'text/xml');}else{var div=document.createElement('div');div.innerHTML=this.ajaxRequest.responseText;responseXML=div;}}var textureUrl=this.baseUrl+responseXML.getElementsByTagName('page')[0].getAttribute('file');var image=new PIXI.ImageLoader(textureUrl,this.crossorigin);this.texture=image.texture.baseTexture;var data={};var info=responseXML.getElementsByTagName('info')[0];var common=responseXML.getElementsByTagName('common')[0];data.font=info.getAttribute('face');data.size=parseInt(info.getAttribute('size'),10);data.lineHeight=parseInt(common.getAttribute('lineHeight'),10);data.chars={};//parse letters
var letters=responseXML.getElementsByTagName('char');for(var i=0;i<letters.length;i++){var charCode=parseInt(letters[i].getAttribute('id'),10);var textureRect=new PIXI.Rectangle(parseInt(letters[i].getAttribute('x'),10),parseInt(letters[i].getAttribute('y'),10),parseInt(letters[i].getAttribute('width'),10),parseInt(letters[i].getAttribute('height'),10));data.chars[charCode]={xOffset:parseInt(letters[i].getAttribute('xoffset'),10),yOffset:parseInt(letters[i].getAttribute('yoffset'),10),xAdvance:parseInt(letters[i].getAttribute('xadvance'),10),kerning:{},texture:PIXI.TextureCache[charCode]=new PIXI.Texture(this.texture,textureRect)};}//parse kernings
var kernings=responseXML.getElementsByTagName('kerning');for(i=0;i<kernings.length;i++){var first=parseInt(kernings[i].getAttribute('first'),10);var second=parseInt(kernings[i].getAttribute('second'),10);var amount=parseInt(kernings[i].getAttribute('amount'),10);data.chars[second].kerning[first]=amount;}PIXI.BitmapText.fonts[data.font]=data;image.addEventListener('loaded',this.onLoaded.bind(this));image.load();}}};/**
 * Invoked when all files are loaded (xml/fnt and texture)
 *
 * @method onLoaded
 * @private
 */PIXI.BitmapFontLoader.prototype.onLoaded=function(){this.emit('loaded',{content:this});};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * based on pixi impact spine implementation made by Eemeli Kelokorpi (@ekelokorpi) https://github.com/ekelokorpi
 *
 * Awesome JS run time provided by EsotericSoftware
 * https://github.com/EsotericSoftware/spine-runtimes
 *
 */ /**
 * The Spine loader is used to load in JSON spine data
 * To generate the data you need to use http://esotericsoftware.com/ and export in the "JSON" format
 * Due to a clash of names  You will need to change the extension of the spine file from *.json to *.anim for it to load
 * See example 12 (http://www.goodboydigital.com/pixijs/examples/12/) to see a working example and check out the source
 * You will need to generate a sprite sheet to accompany the spine data
 * When loaded this class will dispatch a "loaded" event
 *
 * @class SpineLoader
 * @uses EventTarget
 * @constructor
 * @param url {String} The url of the JSON file
 * @param crossorigin {Boolean} Whether requests should be treated as crossorigin
 */PIXI.SpineLoader=function(url,crossorigin){/**
     * The url of the bitmap font data
     *
     * @property url
     * @type String
     */this.url=url;/**
     * Whether the requests should be treated as cross origin
     *
     * @property crossorigin
     * @type Boolean
     */this.crossorigin=crossorigin;/**
     * [read-only] Whether the data has loaded yet
     *
     * @property loaded
     * @type Boolean
     * @readOnly
     */this.loaded=false;};PIXI.SpineLoader.prototype.constructor=PIXI.SpineLoader;PIXI.EventTarget.mixin(PIXI.SpineLoader.prototype);/**
 * Loads the JSON data
 *
 * @method load
 */PIXI.SpineLoader.prototype.load=function(){var scope=this;var jsonLoader=new PIXI.JsonLoader(this.url,this.crossorigin);jsonLoader.on('loaded',function(event){scope.json=event.data.content.json;scope.onLoaded();});jsonLoader.load();};/**
 * Invoked when JSON file is loaded.
 *
 * @method onLoaded
 * @private
 */PIXI.SpineLoader.prototype.onLoaded=function(){this.loaded=true;this.emit('loaded',{content:this});};/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This is the base class for creating a PIXI filter. Currently only webGL supports filters.
 * If you want to make a custom filter this should be your base class.
 * @class AbstractFilter
 * @constructor
 * @param fragmentSrc {Array} The fragment source in an array of strings.
 * @param uniforms {Object} An object containing the uniforms for this filter.
 */PIXI.AbstractFilter=function(fragmentSrc,uniforms){/**
    * An array of passes - some filters contain a few steps this array simply stores the steps in a liniear fashion.
    * For example the blur filter has two passes blurX and blurY.
    * @property passes
    * @type Array(Filter)
    * @private
    */this.passes=[this];/**
    * @property shaders
    * @type Array(Shader)
    * @private
    */this.shaders=[];/**
    * @property dirty
    * @type Boolean
    */this.dirty=true;/**
    * @property padding
    * @type Number
    */this.padding=0;/**
    * @property uniforms
    * @type object
    * @private
    */this.uniforms=uniforms||{};/**
    * @property fragmentSrc
    * @type Array
    * @private
    */this.fragmentSrc=fragmentSrc||[];};PIXI.AbstractFilter.prototype.constructor=PIXI.AbstractFilter;/**
 * Syncs the uniforms between the class object and the shaders.
 *
 * @method syncUniforms
 */PIXI.AbstractFilter.prototype.syncUniforms=function(){for(var i=0,j=this.shaders.length;i<j;i++){this.shaders[i].dirty=true;}};/*
PIXI.AbstractFilter.prototype.apply = function(frameBuffer)
{
    // TODO :)
};
*/ /**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The AlphaMaskFilter class uses the pixel values from the specified texture (called the displacement map) to perform a displacement of an object.
 * You can use this filter to apply all manor of crazy warping effects
 * Currently the r property of the texture is used to offset the x and the g property of the texture is used to offset the y.
 * 
 * @class AlphaMaskFilter
 * @extends AbstractFilter
 * @constructor
 * @param texture {Texture} The texture used for the displacement map * must be power of 2 texture at the moment
 */PIXI.AlphaMaskFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;// set the uniforms
this.uniforms={mask:{type:'sampler2D',value:texture},mapDimensions:{type:'2f',value:{x:1,y:5112}},dimensions:{type:'4fv',value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mask.value.x=texture.width;this.uniforms.mask.value.y=texture.height;}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on('loaded',this.boundLoadedFunction);}this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D mask;','uniform sampler2D uSampler;','uniform vec2 offset;','uniform vec4 dimensions;','uniform vec2 mapDimensions;','void main(void) {','   vec2 mapCords = vTextureCoord.xy;','   mapCords += (dimensions.zw + offset)/ dimensions.xy ;','   mapCords.y *= -1.0;','   mapCords.y += 1.0;','   mapCords *= dimensions.xy / mapDimensions;','   vec4 original =  texture2D(uSampler, vTextureCoord);','   float maskAlpha =  texture2D(mask, mapCords).r;','   original *= maskAlpha;',//'   original.rgb *= maskAlpha;',
'   gl_FragColor =  original;',//'   gl_FragColor = gl_FragColor;',
'}'];};PIXI.AlphaMaskFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.AlphaMaskFilter.prototype.constructor=PIXI.AlphaMaskFilter;/**
 * Sets the map dimensions uniforms when the texture becomes available.
 *
 * @method onTextureLoaded
 */PIXI.AlphaMaskFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.mask.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.mask.value.height;this.uniforms.mask.value.baseTexture.off('loaded',this.boundLoadedFunction);};/**
 * The texture used for the displacement map. Must be power of 2 sized texture.
 *
 * @property map
 * @type Texture
 */Object.defineProperty(PIXI.AlphaMaskFilter.prototype,'map',{get:function(){return this.uniforms.mask.value;},set:function(value){this.uniforms.mask.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The ColorMatrixFilter class lets you apply a 4x4 matrix transformation on the RGBA
 * color and alpha values of every pixel on your displayObject to produce a result
 * with a new set of RGBA color and alpha values. It's pretty powerful!
 * 
 * @class ColorMatrixFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.ColorMatrixFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={matrix:{type:'mat4',value:[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float invert;','uniform mat4 matrix;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord) * matrix;',//  '   gl_FragColor = gl_FragColor;',
'}'];};PIXI.ColorMatrixFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorMatrixFilter.prototype.constructor=PIXI.ColorMatrixFilter;/**
 * Sets the matrix of the color matrix filter
 *
 * @property matrix
 * @type Array(Number)
 * @default [1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]
 */Object.defineProperty(PIXI.ColorMatrixFilter.prototype,'matrix',{get:function(){return this.uniforms.matrix.value;},set:function(value){this.uniforms.matrix.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This greyscales the palette of your Display Objects.
 * 
 * @class GrayFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.GrayFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={gray:{type:'1f',value:1}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D uSampler;','uniform float gray;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord);','   gl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.2126*gl_FragColor.r + 0.7152*gl_FragColor.g + 0.0722*gl_FragColor.b), gray);',//   '   gl_FragColor = gl_FragColor;',
'}'];};PIXI.GrayFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.GrayFilter.prototype.constructor=PIXI.GrayFilter;/**
 * The strength of the gray. 1 will make the object black and white, 0 will make the object its normal color.
 * @property gray
 * @type Number
 */Object.defineProperty(PIXI.GrayFilter.prototype,'gray',{get:function(){return this.uniforms.gray.value;},set:function(value){this.uniforms.gray.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The DisplacementFilter class uses the pixel values from the specified texture (called the displacement map) to perform a displacement of an object.
 * You can use this filter to apply all manor of crazy warping effects
 * Currently the r property of the texture is used offset the x and the g property of the texture is used to offset the y.
 * 
 * @class DisplacementFilter
 * @extends AbstractFilter
 * @constructor
 * @param texture {Texture} The texture used for the displacement map * must be power of 2 texture at the moment
 */PIXI.DisplacementFilter=function(texture){PIXI.AbstractFilter.call(this);this.passes=[this];texture.baseTexture._powerOf2=true;// set the uniforms
this.uniforms={displacementMap:{type:'sampler2D',value:texture},scale:{type:'2f',value:{x:30,y:30}},offset:{type:'2f',value:{x:0,y:0}},mapDimensions:{type:'2f',value:{x:1,y:5112}},dimensions:{type:'4fv',value:[0,0,0,0]}};if(texture.baseTexture.hasLoaded){this.uniforms.mapDimensions.value.x=texture.width;this.uniforms.mapDimensions.value.y=texture.height;}else{this.boundLoadedFunction=this.onTextureLoaded.bind(this);texture.baseTexture.on('loaded',this.boundLoadedFunction);}this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D displacementMap;','uniform sampler2D uSampler;','uniform vec2 scale;','uniform vec2 offset;','uniform vec4 dimensions;','uniform vec2 mapDimensions;',// = vec2(256.0, 256.0);',
// 'const vec2 textureDimensions = vec2(750.0, 750.0);',
'void main(void) {','   vec2 mapCords = vTextureCoord.xy;',//'   mapCords -= ;',
'   mapCords += (dimensions.zw + offset)/ dimensions.xy ;','   mapCords.y *= -1.0;','   mapCords.y += 1.0;','   vec2 matSample = texture2D(displacementMap, mapCords).xy;','   matSample -= 0.5;','   matSample *= scale;','   matSample /= mapDimensions;','   gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.x + matSample.x, vTextureCoord.y + matSample.y));','   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb, 1.0);','   vec2 cord = vTextureCoord;',//'   gl_FragColor =  texture2D(displacementMap, cord);',
//   '   gl_FragColor = gl_FragColor;',
'}'];};PIXI.DisplacementFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DisplacementFilter.prototype.constructor=PIXI.DisplacementFilter;/**
 * Sets the map dimensions uniforms when the texture becomes available.
 *
 * @method onTextureLoaded
 */PIXI.DisplacementFilter.prototype.onTextureLoaded=function(){this.uniforms.mapDimensions.value.x=this.uniforms.displacementMap.value.width;this.uniforms.mapDimensions.value.y=this.uniforms.displacementMap.value.height;this.uniforms.displacementMap.value.baseTexture.off('loaded',this.boundLoadedFunction);};/**
 * The texture used for the displacement map. Must be power of 2 texture.
 *
 * @property map
 * @type Texture
 */Object.defineProperty(PIXI.DisplacementFilter.prototype,'map',{get:function(){return this.uniforms.displacementMap.value;},set:function(value){this.uniforms.displacementMap.value=value;}});/**
 * The multiplier used to scale the displacement result from the map calculation.
 *
 * @property scale
 * @type Point
 */Object.defineProperty(PIXI.DisplacementFilter.prototype,'scale',{get:function(){return this.uniforms.scale.value;},set:function(value){this.uniforms.scale.value=value;}});/**
 * The offset used to move the displacement map.
 *
 * @property offset
 * @type Point
 */Object.defineProperty(PIXI.DisplacementFilter.prototype,'offset',{get:function(){return this.uniforms.offset.value;},set:function(value){this.uniforms.offset.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This filter applies a pixelate effect making display objects appear 'blocky'.
 * 
 * @class PixelateFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.PixelateFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={invert:{type:'1f',value:0},dimensions:{type:'4fv',value:new PIXI.Float32Array([10000,100,10,10])},pixelSize:{type:'2f',value:{x:10,y:10}}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform vec2 testDim;','uniform vec4 dimensions;','uniform vec2 pixelSize;','uniform sampler2D uSampler;','void main(void) {','   vec2 coord = vTextureCoord;','   vec2 size = dimensions.xy/pixelSize;','   vec2 color = floor( ( vTextureCoord * size ) ) / size + pixelSize/dimensions.xy * 0.5;','   gl_FragColor = texture2D(uSampler, color);','}'];};PIXI.PixelateFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.PixelateFilter.prototype.constructor=PIXI.PixelateFilter;/**
 * This a point that describes the size of the blocks. x is the width of the block and y is the height.
 * 
 * @property size
 * @type Point
 */Object.defineProperty(PIXI.PixelateFilter.prototype,'size',{get:function(){return this.uniforms.pixelSize.value;},set:function(value){this.dirty=true;this.uniforms.pixelSize.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The BlurXFilter applies a horizontal Gaussian blur to an object.
 *
 * @class BlurXFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.BlurXFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={blur:{type:'1f',value:1/512}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float blur;','uniform sampler2D uSampler;','void main(void) {','   vec4 sum = vec4(0.0);','   sum += texture2D(uSampler, vec2(vTextureCoord.x - 4.0*blur, vTextureCoord.y)) * 0.05;','   sum += texture2D(uSampler, vec2(vTextureCoord.x - 3.0*blur, vTextureCoord.y)) * 0.09;','   sum += texture2D(uSampler, vec2(vTextureCoord.x - 2.0*blur, vTextureCoord.y)) * 0.12;','   sum += texture2D(uSampler, vec2(vTextureCoord.x - blur, vTextureCoord.y)) * 0.15;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;','   sum += texture2D(uSampler, vec2(vTextureCoord.x + blur, vTextureCoord.y)) * 0.15;','   sum += texture2D(uSampler, vec2(vTextureCoord.x + 2.0*blur, vTextureCoord.y)) * 0.12;','   sum += texture2D(uSampler, vec2(vTextureCoord.x + 3.0*blur, vTextureCoord.y)) * 0.09;','   sum += texture2D(uSampler, vec2(vTextureCoord.x + 4.0*blur, vTextureCoord.y)) * 0.05;','   gl_FragColor = sum;','}'];};PIXI.BlurXFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurXFilter.prototype.constructor=PIXI.BlurXFilter;/**
 * Sets the strength of both the blur.
 *
 * @property blur
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.BlurXFilter.prototype,'blur',{get:function(){return this.uniforms.blur.value/(1/7000);},set:function(value){this.dirty=true;this.uniforms.blur.value=1/7000*value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The BlurYFilter applies a vertical Gaussian blur to an object.
 *
 * @class BlurYFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.BlurYFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={blur:{type:'1f',value:1/512}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float blur;','uniform sampler2D uSampler;','void main(void) {','   vec4 sum = vec4(0.0);','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 4.0*blur)) * 0.05;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 3.0*blur)) * 0.09;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - 2.0*blur)) * 0.12;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y - blur)) * 0.15;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y)) * 0.16;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + blur)) * 0.15;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 2.0*blur)) * 0.12;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 3.0*blur)) * 0.09;','   sum += texture2D(uSampler, vec2(vTextureCoord.x, vTextureCoord.y + 4.0*blur)) * 0.05;','   gl_FragColor = sum;','}'];};PIXI.BlurYFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurYFilter.prototype.constructor=PIXI.BlurYFilter;/**
 * Sets the strength of both the blur.
 *
 * @property blur
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.BlurYFilter.prototype,'blur',{get:function(){return this.uniforms.blur.value/(1/7000);},set:function(value){//this.padding = value;
this.uniforms.blur.value=1/7000*value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * The BlurFilter applies a Gaussian blur to an object.
 * The strength of the blur can be set for x- and y-axis separately (always relative to the stage).
 *
 * @class BlurFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.BlurFilter=function(){this.blurXFilter=new PIXI.BlurXFilter();this.blurYFilter=new PIXI.BlurYFilter();this.passes=[this.blurXFilter,this.blurYFilter];};PIXI.BlurFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.BlurFilter.prototype.constructor=PIXI.BlurFilter;/**
 * Sets the strength of both the blurX and blurY properties simultaneously
 *
 * @property blur
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.BlurFilter.prototype,'blur',{get:function(){return this.blurXFilter.blur;},set:function(value){this.blurXFilter.blur=this.blurYFilter.blur=value;}});/**
 * Sets the strength of the blurX property
 *
 * @property blurX
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.BlurFilter.prototype,'blurX',{get:function(){return this.blurXFilter.blur;},set:function(value){this.blurXFilter.blur=value;}});/**
 * Sets the strength of the blurY property
 *
 * @property blurY
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.BlurFilter.prototype,'blurY',{get:function(){return this.blurYFilter.blur;},set:function(value){this.blurYFilter.blur=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This inverts your Display Objects colors.
 * 
 * @class InvertFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.InvertFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={invert:{type:'1f',value:1}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float invert;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord);','   gl_FragColor.rgb = mix( (vec3(1)-gl_FragColor.rgb) * gl_FragColor.a, gl_FragColor.rgb, 1.0 - invert);',//'   gl_FragColor.rgb = gl_FragColor.rgb  * gl_FragColor.a;',
//  '   gl_FragColor = gl_FragColor * vColor;',
'}'];};PIXI.InvertFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.InvertFilter.prototype.constructor=PIXI.InvertFilter;/**
 * The strength of the invert. 1 will fully invert the colors, 0 will make the object its normal color
 * @property invert
 * @type Number
*/Object.defineProperty(PIXI.InvertFilter.prototype,'invert',{get:function(){return this.uniforms.invert.value;},set:function(value){this.uniforms.invert.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This applies a sepia effect to your Display Objects.
 * 
 * @class SepiaFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.SepiaFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={sepia:{type:'1f',value:1}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float sepia;','uniform sampler2D uSampler;','const mat3 sepiaMatrix = mat3(0.3588, 0.7044, 0.1368, 0.2990, 0.5870, 0.1140, 0.2392, 0.4696, 0.0912);','void main(void) {','   gl_FragColor = texture2D(uSampler, vTextureCoord);','   gl_FragColor.rgb = mix( gl_FragColor.rgb, gl_FragColor.rgb * sepiaMatrix, sepia);',// '   gl_FragColor = gl_FragColor * vColor;',
'}'];};PIXI.SepiaFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.SepiaFilter.prototype.constructor=PIXI.SepiaFilter;/**
 * The strength of the sepia. 1 will apply the full sepia effect, 0 will make the object its normal color.
 * @property sepia
 * @type Number
*/Object.defineProperty(PIXI.SepiaFilter.prototype,'sepia',{get:function(){return this.uniforms.sepia.value;},set:function(value){this.uniforms.sepia.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This filter applies a twist effect making display objects appear twisted in the given direction.
 * 
 * @class TwistFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.TwistFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={radius:{type:'1f',value:0.5},angle:{type:'1f',value:5},offset:{type:'2f',value:{x:0.5,y:0.5}}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform vec4 dimensions;','uniform sampler2D uSampler;','uniform float radius;','uniform float angle;','uniform vec2 offset;','void main(void) {','   vec2 coord = vTextureCoord - offset;','   float distance = length(coord);','   if (distance < radius) {','       float ratio = (radius - distance) / radius;','       float angleMod = ratio * ratio * angle;','       float s = sin(angleMod);','       float c = cos(angleMod);','       coord = vec2(coord.x * c - coord.y * s, coord.x * s + coord.y * c);','   }','   gl_FragColor = texture2D(uSampler, coord+offset);','}'];};PIXI.TwistFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.TwistFilter.prototype.constructor=PIXI.TwistFilter;/**
 * This point describes the the offset of the twist.
 * 
 * @property offset
 * @type Point
 */Object.defineProperty(PIXI.TwistFilter.prototype,'offset',{get:function(){return this.uniforms.offset.value;},set:function(value){this.dirty=true;this.uniforms.offset.value=value;}});/**
 * This radius of the twist.
 * 
 * @property radius
 * @type Number
 */Object.defineProperty(PIXI.TwistFilter.prototype,'radius',{get:function(){return this.uniforms.radius.value;},set:function(value){this.dirty=true;this.uniforms.radius.value=value;}});/**
 * This angle of the twist.
 * 
 * @property angle
 * @type Number
 */Object.defineProperty(PIXI.TwistFilter.prototype,'angle',{get:function(){return this.uniforms.angle.value;},set:function(value){this.dirty=true;this.uniforms.angle.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * This lowers the color depth of your image by the given amount, producing an image with a smaller palette.
 * 
 * @class ColorStepFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.ColorStepFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={step:{type:'1f',value:5}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform sampler2D uSampler;','uniform float step;','void main(void) {','   vec4 color = texture2D(uSampler, vTextureCoord);','   color = floor(color * step) / step;','   gl_FragColor = color;','}'];};PIXI.ColorStepFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.ColorStepFilter.prototype.constructor=PIXI.ColorStepFilter;/**
 * The number of steps to reduce the palette by.
 *
 * @property step
 * @type Number
 */Object.defineProperty(PIXI.ColorStepFilter.prototype,'step',{get:function(){return this.uniforms.step.value;},set:function(value){this.uniforms.step.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 * original filter: https://github.com/evanw/glfx.js/blob/master/src/filters/fun/dotscreen.js
 */ /**
 * This filter applies a dotscreen effect making display objects appear to be made out of black and white halftone dots like an old printer.
 * 
 * @class DotScreenFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.DotScreenFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={scale:{type:'1f',value:1},angle:{type:'1f',value:5},dimensions:{type:'4fv',value:[0,0,0,0]}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform vec4 dimensions;','uniform sampler2D uSampler;','uniform float angle;','uniform float scale;','float pattern() {','   float s = sin(angle), c = cos(angle);','   vec2 tex = vTextureCoord * dimensions.xy;','   vec2 point = vec2(','       c * tex.x - s * tex.y,','       s * tex.x + c * tex.y','   ) * scale;','   return (sin(point.x) * sin(point.y)) * 4.0;','}','void main() {','   vec4 color = texture2D(uSampler, vTextureCoord);','   float average = (color.r + color.g + color.b) / 3.0;','   gl_FragColor = vec4(vec3(average * 10.0 - 5.0 + pattern()), color.a);','}'];};PIXI.DotScreenFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.DotScreenFilter.prototype.constructor=PIXI.DotScreenFilter;/**
 * The scale of the effect.
 * @property scale
 * @type Number
 */Object.defineProperty(PIXI.DotScreenFilter.prototype,'scale',{get:function(){return this.uniforms.scale.value;},set:function(value){this.dirty=true;this.uniforms.scale.value=value;}});/**
 * The radius of the effect.
 * @property angle
 * @type Number
 */Object.defineProperty(PIXI.DotScreenFilter.prototype,'angle',{get:function(){return this.uniforms.angle.value;},set:function(value){this.dirty=true;this.uniforms.angle.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * A Cross Hatch effect filter.
 * 
 * @class CrossHatchFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.CrossHatchFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={blur:{type:'1f',value:1/512}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform float blur;','uniform sampler2D uSampler;','void main(void) {','    float lum = length(texture2D(uSampler, vTextureCoord.xy).rgb);','    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);','    if (lum < 1.00) {','        if (mod(gl_FragCoord.x + gl_FragCoord.y, 10.0) == 0.0) {','            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);','        }','    }','    if (lum < 0.75) {','        if (mod(gl_FragCoord.x - gl_FragCoord.y, 10.0) == 0.0) {','            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);','        }','    }','    if (lum < 0.50) {','        if (mod(gl_FragCoord.x + gl_FragCoord.y - 5.0, 10.0) == 0.0) {','            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);','        }','    }','    if (lum < 0.3) {','        if (mod(gl_FragCoord.x - gl_FragCoord.y - 5.0, 10.0) == 0.0) {','            gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);','        }','    }','}'];};PIXI.CrossHatchFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.CrossHatchFilter.prototype.constructor=PIXI.CrossHatchFilter;/**
 * Sets the strength of both the blur.
 *
 * @property blur
 * @type Number
 * @default 2
 */Object.defineProperty(PIXI.CrossHatchFilter.prototype,'blur',{get:function(){return this.uniforms.blur.value/(1/7000);},set:function(value){//this.padding = value;
this.uniforms.blur.value=1/7000*value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */ /**
 * An RGB Split Filter.
 * 
 * @class RGBSplitFilter
 * @extends AbstractFilter
 * @constructor
 */PIXI.RGBSplitFilter=function(){PIXI.AbstractFilter.call(this);this.passes=[this];// set the uniforms
this.uniforms={red:{type:'2f',value:{x:20,y:20}},green:{type:'2f',value:{x:-20,y:20}},blue:{type:'2f',value:{x:20,y:-20}},dimensions:{type:'4fv',value:[0,0,0,0]}};this.fragmentSrc=['precision mediump float;','varying vec2 vTextureCoord;','varying vec4 vColor;','uniform vec2 red;','uniform vec2 green;','uniform vec2 blue;','uniform vec4 dimensions;','uniform sampler2D uSampler;','void main(void) {','   gl_FragColor.r = texture2D(uSampler, vTextureCoord + red/dimensions.xy).r;','   gl_FragColor.g = texture2D(uSampler, vTextureCoord + green/dimensions.xy).g;','   gl_FragColor.b = texture2D(uSampler, vTextureCoord + blue/dimensions.xy).b;','   gl_FragColor.a = texture2D(uSampler, vTextureCoord).a;','}'];};PIXI.RGBSplitFilter.prototype=Object.create(PIXI.AbstractFilter.prototype);PIXI.RGBSplitFilter.prototype.constructor=PIXI.RGBSplitFilter;/**
 * Red channel offset.
 * 
 * @property red
 * @type Point
 */Object.defineProperty(PIXI.RGBSplitFilter.prototype,'red',{get:function(){return this.uniforms.red.value;},set:function(value){this.uniforms.red.value=value;}});/**
 * Green channel offset.
 * 
 * @property green
 * @type Point
 */Object.defineProperty(PIXI.RGBSplitFilter.prototype,'green',{get:function(){return this.uniforms.green.value;},set:function(value){this.uniforms.green.value=value;}});/**
 * Blue offset.
 * 
 * @property blue
 * @type Point
 */Object.defineProperty(PIXI.RGBSplitFilter.prototype,'blue',{get:function(){return this.uniforms.blue.value;},set:function(value){this.uniforms.blue.value=value;}});/**
 * @author Mat Groves http://matgroves.com/ @Doormat23
 */if(typeof exports!=='undefined'){if(typeof module!=='undefined'&&module.exports){exports=module.exports=PIXI;}exports.PIXI=PIXI;}else if(typeof define!=='undefined'&&define.amd){define(PIXI);}else{root.PIXI=PIXI;}}).call(this);/*!
 * jQuery Mousewheel 3.1.13
 *
 * Copyright jQuery Foundation and other contributors
 * Released under the MIT license
 * http://jquery.org/license
 */(function(factory){if(typeof define==='function'&&define.amd){// AMD. Register as an anonymous module.
define(['jquery'],factory);}else if(typeof exports==='object'){// Node/CommonJS style for Browserify
module.exports=factory;}else{// Browser globals
factory(jQuery);}})(function($){var toFix=['wheel','mousewheel','DOMMouseScroll','MozMousePixelScroll'],toBind='onwheel'in document||document.documentMode>=9?['wheel']:['mousewheel','DomMouseScroll','MozMousePixelScroll'],slice=Array.prototype.slice,nullLowestDeltaTimeout,lowestDelta;if($.event.fixHooks){for(var i=toFix.length;i;){$.event.fixHooks[toFix[--i]]=$.event.mouseHooks;}}var special=$.event.special.mousewheel={version:'3.1.12',setup:function(){if(this.addEventListener){for(var i=toBind.length;i;){this.addEventListener(toBind[--i],handler,false);}}else{this.onmousewheel=handler;}// Store the line height and page height for this particular element
$.data(this,'mousewheel-line-height',special.getLineHeight(this));$.data(this,'mousewheel-page-height',special.getPageHeight(this));},teardown:function(){if(this.removeEventListener){for(var i=toBind.length;i;){this.removeEventListener(toBind[--i],handler,false);}}else{this.onmousewheel=null;}// Clean up the data we added to the element
$.removeData(this,'mousewheel-line-height');$.removeData(this,'mousewheel-page-height');},getLineHeight:function(elem){var $elem=$(elem),$parent=$elem['offsetParent'in $.fn?'offsetParent':'parent']();if(!$parent.length){$parent=$('body');}return parseInt($parent.css('fontSize'),10)||parseInt($elem.css('fontSize'),10)||16;},getPageHeight:function(elem){return $(elem).height();},settings:{adjustOldDeltas:true,// see shouldAdjustOldDeltas() below
normalizeOffset:true// calls getBoundingClientRect for each event
}};$.fn.extend({mousewheel:function(fn){return fn?this.bind('mousewheel',fn):this.trigger('mousewheel');},unmousewheel:function(fn){return this.unbind('mousewheel',fn);}});function handler(event){var orgEvent=event||window.event,args=slice.call(arguments,1),delta=0,deltaX=0,deltaY=0,absDelta=0,offsetX=0,offsetY=0;event=$.event.fix(orgEvent);event.type='mousewheel';// Old school scrollwheel delta
if('detail'in orgEvent){deltaY=orgEvent.detail*-1;}if('wheelDelta'in orgEvent){deltaY=orgEvent.wheelDelta;}if('wheelDeltaY'in orgEvent){deltaY=orgEvent.wheelDeltaY;}if('wheelDeltaX'in orgEvent){deltaX=orgEvent.wheelDeltaX*-1;}// Firefox < 17 horizontal scrolling related to DOMMouseScroll event
if('axis'in orgEvent&&orgEvent.axis===orgEvent.HORIZONTAL_AXIS){deltaX=deltaY*-1;deltaY=0;}// Set delta to be deltaY or deltaX if deltaY is 0 for backwards compatabilitiy
delta=deltaY===0?deltaX:deltaY;// New school wheel delta (wheel event)
if('deltaY'in orgEvent){deltaY=orgEvent.deltaY*-1;delta=deltaY;}if('deltaX'in orgEvent){deltaX=orgEvent.deltaX;if(deltaY===0){delta=deltaX*-1;}}// No change actually happened, no reason to go any further
if(deltaY===0&&deltaX===0){return;}// Need to convert lines and pages to pixels if we aren't already in pixels
// There are three delta modes:
//   * deltaMode 0 is by pixels, nothing to do
//   * deltaMode 1 is by lines
//   * deltaMode 2 is by pages
if(orgEvent.deltaMode===1){var lineHeight=$.data(this,'mousewheel-line-height');delta*=lineHeight;deltaY*=lineHeight;deltaX*=lineHeight;}else if(orgEvent.deltaMode===2){var pageHeight=$.data(this,'mousewheel-page-height');delta*=pageHeight;deltaY*=pageHeight;deltaX*=pageHeight;}// Store lowest absolute delta to normalize the delta values
absDelta=Math.max(Math.abs(deltaY),Math.abs(deltaX));if(!lowestDelta||absDelta<lowestDelta){lowestDelta=absDelta;// Adjust older deltas if necessary
if(shouldAdjustOldDeltas(orgEvent,absDelta)){lowestDelta/=40;}}// Adjust older deltas if necessary
if(shouldAdjustOldDeltas(orgEvent,absDelta)){// Divide all the things by 40!
delta/=40;deltaX/=40;deltaY/=40;}// Get a whole, normalized value for the deltas
delta=Math[delta>=1?'floor':'ceil'](delta/lowestDelta);deltaX=Math[deltaX>=1?'floor':'ceil'](deltaX/lowestDelta);deltaY=Math[deltaY>=1?'floor':'ceil'](deltaY/lowestDelta);// Normalise offsetX and offsetY properties
if(special.settings.normalizeOffset&&this.getBoundingClientRect){var boundingRect=this.getBoundingClientRect();offsetX=event.clientX-boundingRect.left;offsetY=event.clientY-boundingRect.top;}// Add information to the event object
event.deltaX=deltaX;event.deltaY=deltaY;event.deltaFactor=lowestDelta;event.offsetX=offsetX;event.offsetY=offsetY;// Go ahead and set deltaMode to 0 since we converted to pixels
// Although this is a little odd since we overwrite the deltaX/Y
// properties with normalized deltas.
event.deltaMode=0;// Add event and delta to the front of the arguments
args.unshift(event,delta,deltaX,deltaY);// Clearout lowestDelta after sometime to better
// handle multiple device types that give different
// a different lowestDelta
// Ex: trackpad = 3 and mouse wheel = 120
if(nullLowestDeltaTimeout){clearTimeout(nullLowestDeltaTimeout);}nullLowestDeltaTimeout=setTimeout(nullLowestDelta,200);return($.event.dispatch||$.event.handle).apply(this,args);}function nullLowestDelta(){lowestDelta=null;}function shouldAdjustOldDeltas(orgEvent,absDelta){// If this is an older event and the delta is divisable by 120,
// then we are assuming that the browser is treating this as an
// older mouse wheel event and that we should divide the deltas
// by 40 to try and get a more usable deltaFactor.
// Side note, this actually impacts the reported scroll distance
// in older browsers and can cause scrolling to be slower than native.
// Turn this off by setting $.event.special.mousewheel.settings.adjustOldDeltas to false.
return special.settings.adjustOldDeltas&&orgEvent.type==='mousewheel'&&absDelta%120===0;}});(function(){var $,Analyze,Blender,Calculate,Caman,CamanParser,Canvas,Convert,Event,Fiber,Filter,IO,Image,Layer,Log,Logger,PixelInfo,Plugin,Renderer,Root,Store,Util,fs,slice,vignetteFilters,__hasProp={}.hasOwnProperty,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;},__slice=[].slice,_this=this;slice=Array.prototype.slice;$=function(sel,root){if(root==null){root=document;}if(typeof sel==="object"||typeof exports!=="undefined"&&exports!==null){return sel;}return root.querySelector(sel);};Util=function(){function Util(){}Util.uniqid=function(){var id;id=0;return{get:function(){return id++;}};}();Util.extend=function(obj){var copy,dest,prop,src,_i,_len;dest=obj;src=slice.call(arguments,1);for(_i=0,_len=src.length;_i<_len;_i++){copy=src[_i];for(prop in copy){if(!__hasProp.call(copy,prop))continue;dest[prop]=copy[prop];}}return dest;};Util.clampRGB=function(val){if(val<0){return 0;}if(val>255){return 255;}return val;};Util.copyAttributes=function(from,to,opts){var attr,_i,_len,_ref,_ref1,_results;if(opts==null){opts={};}_ref=from.attributes;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){attr=_ref[_i];if(opts.except!=null&&(_ref1=attr.nodeName,__indexOf.call(opts.except,_ref1)>=0)){continue;}_results.push(to.setAttribute(attr.nodeName,attr.nodeValue));}return _results;};Util.dataArray=function(length){if(length==null){length=0;}if(Caman.NodeJS||window.Uint8Array!=null){return new Uint8Array(length);}return new Array(length);};return Util;}();if(typeof exports!=="undefined"&&exports!==null){Root=exports;Canvas=require('canvas');Image=Canvas.Image;Fiber=require('fibers');fs=require('fs');}else{Root=window;}Root.Caman=Caman=function(){Caman.version={release:"4.1.1",date:"4/8/2013"};Caman.DEBUG=false;Caman.NodeJS=typeof exports!=="undefined"&&exports!==null;Caman.autoload=!Caman.NodeJS;Caman.allowRevert=true;Caman.crossOrigin="anonymous";Caman.toString=function(){return"Version "+Caman.version.release+", Released "+Caman.version.date;};Caman.remoteProxy="";Caman.proxyParam="camanProxyUrl";Caman.getAttrId=function(canvas){if(Caman.NodeJS){return true;}if(typeof canvas==="string"){canvas=$(canvas);}if(!(canvas!=null&&canvas.getAttribute!=null)){return null;}return canvas.getAttribute('data-caman-id');};function Caman(){var args,callback,id,_this=this;if(arguments.length===0){throw"Invalid arguments";}if(this instanceof Caman){this.finishInit=this.finishInit.bind(this);this.imageLoaded=this.imageLoaded.bind(this);args=arguments[0];if(!Caman.NodeJS){id=parseInt(Caman.getAttrId(args[0]),10);callback=typeof args[1]==="function"?args[1]:typeof args[2]==="function"?args[2]:function(){};if(!isNaN(id)&&Store.has(id)){return Store.execute(id,callback);}}this.id=Util.uniqid.get();this.initializedPixelData=this.originalPixelData=null;this.cropCoordinates={x:0,y:0};this.cropped=false;this.resized=false;this.pixelStack=[];this.layerStack=[];this.canvasQueue=[];this.currentLayer=null;this.scaled=false;this.analyze=new Analyze(this);this.renderer=new Renderer(this);this.domIsLoaded(function(){_this.parseArguments(args);return _this.setup();});return this;}else{return new Caman(arguments);}}Caman.prototype.domIsLoaded=function(cb){var listener,_this=this;if(Caman.NodeJS){return setTimeout(function(){return cb.call(_this);},0);}else{if(document.readyState==="complete"){Log.debug("DOM initialized");return setTimeout(function(){return cb.call(_this);},0);}else{listener=function(){if(document.readyState==="complete"){Log.debug("DOM initialized");return cb.call(_this);}};return document.addEventListener("readystatechange",listener,false);}}};Caman.prototype.parseArguments=function(args){var key,val,_ref,_results;if(args.length===0){throw"Invalid arguments given";}this.initObj=null;this.initType=null;this.imageUrl=null;this.callback=function(){};this.setInitObject(args[0]);if(args.length===1){return;}switch(typeof args[1]){case"string":this.imageUrl=args[1];break;case"function":this.callback=args[1];}if(args.length===2){return;}this.callback=args[2];if(args.length===4){_ref=args[4];_results=[];for(key in _ref){if(!__hasProp.call(_ref,key))continue;val=_ref[key];_results.push(this.options[key]=val);}return _results;}};Caman.prototype.setInitObject=function(obj){if(Caman.NodeJS){this.initObj=obj;this.initType='node';return;}if(typeof obj==="object"){this.initObj=obj;}else{this.initObj=$(obj);}if(this.initObj==null){throw"Could not find image or canvas for initialization.";}return this.initType=this.initObj.nodeName.toLowerCase();};Caman.prototype.setup=function(){switch(this.initType){case"node":return this.initNode();case"img":return this.initImage();case"canvas":return this.initCanvas();}};Caman.prototype.initNode=function(){var _this=this;Log.debug("Initializing for NodeJS");this.image=new Image();this.image.onload=function(){Log.debug("Image loaded. Width = "+_this.imageWidth()+", Height = "+_this.imageHeight());_this.canvas=new Canvas(_this.imageWidth(),_this.imageHeight());return _this.finishInit();};this.image.onerror=function(err){throw err;};return this.image.src=this.initObj;};Caman.prototype.initImage=function(){this.image=this.initObj;this.canvas=document.createElement('canvas');this.context=this.canvas.getContext('2d');Util.copyAttributes(this.image,this.canvas,{except:['src']});this.image.parentNode.replaceChild(this.canvas,this.image);this.imageAdjustments();return this.waitForImageLoaded();};Caman.prototype.initCanvas=function(){this.canvas=this.initObj;this.context=this.canvas.getContext('2d');if(this.imageUrl!=null){this.image=document.createElement('img');this.image.src=this.imageUrl;this.imageAdjustments();return this.waitForImageLoaded();}else{return this.finishInit();}};Caman.prototype.imageAdjustments=function(){if(this.needsHiDPISwap()){Log.debug(this.image.src,"->",this.hiDPIReplacement());this.swapped=true;this.image.src=this.hiDPIReplacement();}if(IO.isRemote(this.image)){this.image.src=IO.proxyUrl(this.image.src);return Log.debug("Remote image detected, using URL = "+this.image.src);}};Caman.prototype.waitForImageLoaded=function(){if(this.isImageLoaded()){return this.imageLoaded();}else{return this.image.onload=this.imageLoaded;}};Caman.prototype.isImageLoaded=function(){if(!this.image.complete){return false;}if(this.image.naturalWidth!=null&&this.image.naturalWidth===0){return false;}return true;};Caman.prototype.imageWidth=function(){return this.image.width||this.image.naturalWidth;};Caman.prototype.imageHeight=function(){return this.image.height||this.image.naturalHeight;};Caman.prototype.imageLoaded=function(){Log.debug("Image loaded. Width = "+this.imageWidth()+", Height = "+this.imageHeight());if(this.swapped){this.canvas.width=this.imageWidth()/this.hiDPIRatio();this.canvas.height=this.imageHeight()/this.hiDPIRatio();}else{this.canvas.width=this.imageWidth();this.canvas.height=this.imageHeight();}return this.finishInit();};Caman.prototype.finishInit=function(){var i,pixel,_i,_len,_ref;if(this.context==null){this.context=this.canvas.getContext('2d');}this.originalWidth=this.preScaledWidth=this.width=this.canvas.width;this.originalHeight=this.preScaledHeight=this.height=this.canvas.height;this.hiDPIAdjustments();if(!this.hasId()){this.assignId();}if(this.image!=null){this.context.drawImage(this.image,0,0,this.imageWidth(),this.imageHeight(),0,0,this.preScaledWidth,this.preScaledHeight);}this.reloadCanvasData();if(Caman.allowRevert){this.initializedPixelData=Util.dataArray(this.pixelData.length);this.originalPixelData=Util.dataArray(this.pixelData.length);_ref=this.pixelData;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){pixel=_ref[i];this.initializedPixelData[i]=pixel;this.originalPixelData[i]=pixel;}}this.dimensions={width:this.canvas.width,height:this.canvas.height};Store.put(this.id,this);this.callback.call(this,this);return this.callback=function(){};};Caman.prototype.reloadCanvasData=function(){this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);return this.pixelData=this.imageData.data;};Caman.prototype.resetOriginalPixelData=function(){var pixel,_i,_len,_ref,_results;if(!Caman.allowRevert){throw"Revert disabled";}this.originalPixelData=Util.dataArray(this.pixelData.length);_ref=this.pixelData;_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){pixel=_ref[_i];_results.push(this.originalPixelData.push(pixel));}return _results;};Caman.prototype.hasId=function(){return Caman.getAttrId(this.canvas)!=null;};Caman.prototype.assignId=function(){if(Caman.NodeJS||this.canvas.getAttribute('data-caman-id')){return;}return this.canvas.setAttribute('data-caman-id',this.id);};Caman.prototype.hiDPIDisabled=function(){return this.canvas.getAttribute('data-caman-hidpi-disabled')!==null;};Caman.prototype.hiDPIAdjustments=function(){var ratio;if(Caman.NodeJS||this.hiDPIDisabled()){return;}ratio=this.hiDPIRatio();if(ratio!==1){Log.debug("HiDPI ratio = "+ratio);this.scaled=true;this.preScaledWidth=this.canvas.width;this.preScaledHeight=this.canvas.height;this.canvas.width=this.preScaledWidth*ratio;this.canvas.height=this.preScaledHeight*ratio;this.canvas.style.width=""+this.preScaledWidth+"px";this.canvas.style.height=""+this.preScaledHeight+"px";this.context.scale(ratio,ratio);this.width=this.originalWidth=this.canvas.width;return this.height=this.originalHeight=this.canvas.height;}};Caman.prototype.hiDPIRatio=function(){var backingStoreRatio,devicePixelRatio;devicePixelRatio=window.devicePixelRatio||1;backingStoreRatio=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1;return devicePixelRatio/backingStoreRatio;};Caman.prototype.hiDPICapable=function(){return window.devicePixelRatio!=null&&window.devicePixelRatio!==1;};Caman.prototype.needsHiDPISwap=function(){if(this.hiDPIDisabled()||!this.hiDPICapable()){return false;}return this.hiDPIReplacement()!==null;};Caman.prototype.hiDPIReplacement=function(){if(this.image==null){return null;}return this.image.getAttribute('data-caman-hidpi');};Caman.prototype.replaceCanvas=function(newCanvas){var oldCanvas;oldCanvas=this.canvas;this.canvas=newCanvas;this.context=this.canvas.getContext('2d');oldCanvas.parentNode.replaceChild(this.canvas,oldCanvas);this.width=this.canvas.width;this.height=this.canvas.height;this.reloadCanvasData();return this.dimensions={width:this.canvas.width,height:this.canvas.height};};Caman.prototype.render=function(callback){var _this=this;if(callback==null){callback=function(){};}Event.trigger(this,"renderStart");return this.renderer.execute(function(){_this.context.putImageData(_this.imageData,0,0);return callback.call(_this);});};Caman.prototype.revert=function(){var i,pixel,_i,_len,_ref;if(!Caman.allowRevert){throw"Revert disabled";}_ref=this.originalVisiblePixels();for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){pixel=_ref[i];this.pixelData[i]=pixel;}return this.context.putImageData(this.imageData,0,0);};Caman.prototype.reset=function(){var canvas,ctx,i,imageData,pixel,pixelData,_i,_len,_ref;canvas=document.createElement('canvas');Util.copyAttributes(this.canvas,canvas);canvas.width=this.originalWidth;canvas.height=this.originalHeight;ctx=canvas.getContext('2d');imageData=ctx.getImageData(0,0,canvas.width,canvas.height);pixelData=imageData.data;_ref=this.initializedPixelData;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){pixel=_ref[i];pixelData[i]=pixel;}ctx.putImageData(imageData,0,0);this.cropCoordinates={x:0,y:0};this.resized=false;return this.replaceCanvas(canvas);};Caman.prototype.originalVisiblePixels=function(){var canvas,coord,ctx,endX,endY,i,imageData,pixel,pixelData,pixels,scaledCanvas,startX,startY,width,_i,_j,_len,_ref,_ref1,_ref2,_ref3;if(!Caman.allowRevert){throw"Revert disabled";}pixels=[];startX=this.cropCoordinates.x;endX=startX+this.width;startY=this.cropCoordinates.y;endY=startY+this.height;if(this.resized){canvas=document.createElement('canvas');canvas.width=this.originalWidth;canvas.height=this.originalHeight;ctx=canvas.getContext('2d');imageData=ctx.getImageData(0,0,canvas.width,canvas.height);pixelData=imageData.data;_ref=this.originalPixelData;for(i=_i=0,_len=_ref.length;_i<_len;i=++_i){pixel=_ref[i];pixelData[i]=pixel;}ctx.putImageData(imageData,0,0);scaledCanvas=document.createElement('canvas');scaledCanvas.width=this.width;scaledCanvas.height=this.height;ctx=scaledCanvas.getContext('2d');ctx.drawImage(canvas,0,0,this.originalWidth,this.originalHeight,0,0,this.width,this.height);pixelData=ctx.getImageData(0,0,this.width,this.height).data;width=this.width;}else{pixelData=this.originalPixelData;width=this.originalWidth;}for(i=_j=0,_ref1=pixelData.length;_j<_ref1;i=_j+=4){coord=PixelInfo.locationToCoordinates(i,width);if(startX<=(_ref2=coord.x)&&_ref2<endX&&startY<=(_ref3=coord.y)&&_ref3<endY){pixels.push(pixelData[i],pixelData[i+1],pixelData[i+2],pixelData[i+3]);}}return pixels;};Caman.prototype.process=function(name,processFn){this.renderer.add({type:Filter.Type.Single,name:name,processFn:processFn});return this;};Caman.prototype.processKernel=function(name,adjust,divisor,bias){var i,_i,_ref;if(!divisor){divisor=0;for(i=_i=0,_ref=adjust.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){divisor+=adjust[i];}}this.renderer.add({type:Filter.Type.Kernel,name:name,adjust:adjust,divisor:divisor,bias:bias||0});return this;};Caman.prototype.processPlugin=function(plugin,args){this.renderer.add({type:Filter.Type.Plugin,plugin:plugin,args:args});return this;};Caman.prototype.newLayer=function(callback){var layer;layer=new Layer(this);this.canvasQueue.push(layer);this.renderer.add({type:Filter.Type.LayerDequeue});callback.call(layer);this.renderer.add({type:Filter.Type.LayerFinished});return this;};Caman.prototype.executeLayer=function(layer){return this.pushContext(layer);};Caman.prototype.pushContext=function(layer){this.layerStack.push(this.currentLayer);this.pixelStack.push(this.pixelData);this.currentLayer=layer;return this.pixelData=layer.pixelData;};Caman.prototype.popContext=function(){this.pixelData=this.pixelStack.pop();return this.currentLayer=this.layerStack.pop();};Caman.prototype.applyCurrentLayer=function(){return this.currentLayer.applyToParent();};return Caman;}();Analyze=function(){function Analyze(c){this.c=c;}Analyze.prototype.calculateLevels=function(){var i,levels,numPixels,_i,_j,_k,_ref;levels={r:{},g:{},b:{}};for(i=_i=0;_i<=255;i=++_i){levels.r[i]=0;levels.g[i]=0;levels.b[i]=0;}for(i=_j=0,_ref=this.c.pixelData.length;_j<_ref;i=_j+=4){levels.r[this.c.pixelData[i]]++;levels.g[this.c.pixelData[i+1]]++;levels.b[this.c.pixelData[i+2]]++;}numPixels=this.c.pixelData.length/4;for(i=_k=0;_k<=255;i=++_k){levels.r[i]/=numPixels;levels.g[i]/=numPixels;levels.b[i]/=numPixels;}return levels;};return Analyze;}();Caman.DOMUpdated=function(){var img,imgs,parser,_i,_len,_results;imgs=document.querySelectorAll("img[data-caman]");if(!(imgs.length>0)){return;}_results=[];for(_i=0,_len=imgs.length;_i<_len;_i++){img=imgs[_i];_results.push(parser=new CamanParser(img,function(){this.parse();return this.execute();}));}return _results;};if(Caman.autoload){(function(){if(document.readyState==="complete"){return Caman.DOMUpdated();}else{return document.addEventListener("DOMContentLoaded",Caman.DOMUpdated,false);}})();}CamanParser=function(){var INST_REGEX;INST_REGEX="(\\w+)\\((.*?)\\)";function CamanParser(ele,ready){this.dataStr=ele.getAttribute('data-caman');this.caman=Caman(ele,ready.bind(this));}CamanParser.prototype.parse=function(){var args,filter,func,inst,instFunc,m,r,unparsedInstructions,_i,_len,_ref,_results;this.ele=this.caman.canvas;r=new RegExp(INST_REGEX,'g');unparsedInstructions=this.dataStr.match(r);if(!(unparsedInstructions.length>0)){return;}r=new RegExp(INST_REGEX);_results=[];for(_i=0,_len=unparsedInstructions.length;_i<_len;_i++){inst=unparsedInstructions[_i];_ref=inst.match(r),m=_ref[0],filter=_ref[1],args=_ref[2];instFunc=new Function("return function() {        this."+filter+"("+args+");      };");try{func=instFunc();_results.push(func.call(this.caman));}catch(e){_results.push(Log.debug(e));}}return _results;};CamanParser.prototype.execute=function(){var ele;ele=this.ele;return this.caman.render(function(){return ele.parentNode.replaceChild(this.toImage(),ele);});};return CamanParser;}();Caman.Blender=Blender=function(){function Blender(){}Blender.blenders={};Blender.register=function(name,func){return this.blenders[name]=func;};Blender.execute=function(name,rgbaLayer,rgbaParent){return this.blenders[name](rgbaLayer,rgbaParent);};return Blender;}();Caman.Calculate=Calculate=function(){function Calculate(){}Calculate.distance=function(x1,y1,x2,y2){return Math.sqrt(Math.pow(x2-x1,2)+Math.pow(y2-y1,2));};Calculate.randomRange=function(min,max,getFloat){var rand;if(getFloat==null){getFloat=false;}rand=min+Math.random()*(max-min);if(getFloat){return rand.toFixed(getFloat);}else{return Math.round(rand);}};Calculate.luminance=function(rgba){return 0.299*rgba.r+0.587*rgba.g+0.114*rgba.b;};Calculate.bezier=function(start,ctrl1,ctrl2,end,lowBound,highBound){var Ax,Ay,Bx,By,Cx,Cy,bezier,curveX,curveY,i,j,leftCoord,rightCoord,t,x0,x1,x2,x3,y0,y1,y2,y3,_i,_j,_k,_ref,_ref1;x0=start[0];y0=start[1];x1=ctrl1[0];y1=ctrl1[1];x2=ctrl2[0];y2=ctrl2[1];x3=end[0];y3=end[1];bezier={};Cx=parseInt(3*(x1-x0),10);Bx=3*(x2-x1)-Cx;Ax=x3-x0-Cx-Bx;Cy=3*(y1-y0);By=3*(y2-y1)-Cy;Ay=y3-y0-Cy-By;for(i=_i=0;_i<1000;i=++_i){t=i/1000;curveX=Math.round(Ax*Math.pow(t,3)+Bx*Math.pow(t,2)+Cx*t+x0);curveY=Math.round(Ay*Math.pow(t,3)+By*Math.pow(t,2)+Cy*t+y0);if(lowBound&&curveY<lowBound){curveY=lowBound;}else if(highBound&&curveY>highBound){curveY=highBound;}bezier[curveX]=curveY;}if(bezier.length<end[0]+1){for(i=_j=0,_ref=end[0];0<=_ref?_j<=_ref:_j>=_ref;i=0<=_ref?++_j:--_j){if(bezier[i]==null){leftCoord=[i-1,bezier[i-1]];for(j=_k=i,_ref1=end[0];i<=_ref1?_k<=_ref1:_k>=_ref1;j=i<=_ref1?++_k:--_k){if(bezier[j]!=null){rightCoord=[j,bezier[j]];break;}}bezier[i]=leftCoord[1]+(rightCoord[1]-leftCoord[1])/(rightCoord[0]-leftCoord[0])*(i-leftCoord[0]);}}}if(bezier[end[0]]==null){bezier[end[0]]=bezier[end[0]-1];}return bezier;};return Calculate;}();Convert=function(){function Convert(){}Convert.hexToRGB=function(hex){var b,g,r;if(hex.charAt(0)==="#"){hex=hex.substr(1);}r=parseInt(hex.substr(0,2),16);g=parseInt(hex.substr(2,2),16);b=parseInt(hex.substr(4,2),16);return{r:r,g:g,b:b};};Convert.rgbToHSL=function(r,g,b){var d,h,l,max,min,s;if(typeof r==="object"){g=r.g;b=r.b;r=r.r;}r/=255;g/=255;b/=255;max=Math.max(r,g,b);min=Math.min(r,g,b);l=(max+min)/2;if(max===min){h=s=0;}else{d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);h=function(){switch(max){case r:return(g-b)/d+(g<b?6:0);case g:return(b-r)/d+2;case b:return(r-g)/d+4;}}();h/=6;}return{h:h,s:s,l:l};};Convert.hslToRGB=function(h,s,l){var b,g,p,q,r;if(typeof h==="object"){s=h.s;l=h.l;h=h.h;}if(s===0){r=g=b=l;}else{q=l<0.5?l*(1+s):l+s-l*s;p=2*l-q;r=this.hueToRGB(p,q,h+1/3);g=this.hueToRGB(p,q,h);b=this.hueToRGB(p,q,h-1/3);}return{r:r*255,g:g*255,b:b*255};};Convert.hueToRGB=function(p,q,t){if(t<0){t+=1;}if(t>1){t-=1;}if(t<1/6){return p+(q-p)*6*t;}if(t<1/2){return q;}if(t<2/3){return p+(q-p)*(2/3-t)*6;}return p;};Convert.rgbToHSV=function(r,g,b){var d,h,max,min,s,v;r/=255;g/=255;b/=255;max=Math.max(r,g,b);min=Math.min(r,g,b);v=max;d=max-min;s=max===0?0:d/max;if(max===min){h=0;}else{h=function(){switch(max){case r:return(g-b)/d+(g<b?6:0);case g:return(b-r)/d+2;case b:return(r-g)/d+4;}}();h/=6;}return{h:h,s:s,v:v};};Convert.hsvToRGB=function(h,s,v){var b,f,g,i,p,q,r,t;i=Math.floor(h*6);f=h*6-i;p=v*(1-s);q=v*(1-f*s);t=v*(1-(1-f)*s);switch(i%6){case 0:r=v;g=t;b=p;break;case 1:r=q;g=v;b=p;break;case 2:r=p;g=v;b=t;break;case 3:r=p;g=q;b=v;break;case 4:r=t;g=p;b=v;break;case 5:r=v;g=p;b=q;}return{r:r*255,g:g*255,b:b*255};};Convert.rgbToXYZ=function(r,g,b){var x,y,z;r/=255;g/=255;b/=255;if(r>0.04045){r=Math.pow((r+0.055)/1.055,2.4);}else{r/=12.92;}if(g>0.04045){g=Math.pow((g+0.055)/1.055,2.4);}else{g/=12.92;}if(b>0.04045){b=Math.pow((b+0.055)/1.055,2.4);}else{b/=12.92;}x=r*0.4124+g*0.3576+b*0.1805;y=r*0.2126+g*0.7152+b*0.0722;z=r*0.0193+g*0.1192+b*0.9505;return{x:x*100,y:y*100,z:z*100};};Convert.xyzToRGB=function(x,y,z){var b,g,r;x/=100;y/=100;z/=100;r=3.2406*x+-1.5372*y+-0.4986*z;g=-0.9689*x+1.8758*y+0.0415*z;b=0.0557*x+-0.2040*y+1.0570*z;if(r>0.0031308){r=1.055*Math.pow(r,0.4166666667)-0.055;}else{r*=12.92;}if(g>0.0031308){g=1.055*Math.pow(g,0.4166666667)-0.055;}else{g*=12.92;}if(b>0.0031308){b=1.055*Math.pow(b,0.4166666667)-0.055;}else{b*=12.92;}return{r:r*255,g:g*255,b:b*255};};Convert.xyzToLab=function(x,y,z){var a,b,l,whiteX,whiteY,whiteZ;if(typeof x==="object"){y=x.y;z=x.z;x=x.x;}whiteX=95.047;whiteY=100.0;whiteZ=108.883;x/=whiteX;y/=whiteY;z/=whiteZ;if(x>0.008856451679){x=Math.pow(x,0.3333333333);}else{x=7.787037037*x+0.1379310345;}if(y>0.008856451679){y=Math.pow(y,0.3333333333);}else{y=7.787037037*y+0.1379310345;}if(z>0.008856451679){z=Math.pow(z,0.3333333333);}else{z=7.787037037*z+0.1379310345;}l=116*y-16;a=500*(x-y);b=200*(y-z);return{l:l,a:a,b:b};};Convert.labToXYZ=function(l,a,b){var x,y,z;if(typeof l==="object"){a=l.a;b=l.b;l=l.l;}y=(l+16)/116;x=y+a/500;z=y-b/200;if(x>0.2068965517){x=x*x*x;}else{x=0.1284185493*(x-0.1379310345);}if(y>0.2068965517){y=y*y*y;}else{y=0.1284185493*(y-0.1379310345);}if(z>0.2068965517){z=z*z*z;}else{z=0.1284185493*(z-0.1379310345);}return{x:x*95.047,y:y*100.0,z:z*108.883};};Convert.rgbToLab=function(r,g,b){var xyz;if(typeof r==="object"){g=r.g;b=r.b;r=r.r;}xyz=this.rgbToXYZ(r,g,b);return this.xyzToLab(xyz);};Convert.labToRGB=function(l,a,b){};return Convert;}();Event=function(){function Event(){}Event.events={};Event.types=["processStart","processComplete","renderStart","renderFinished","blockStarted","blockFinished"];Event.trigger=function(target,type,data){var event,_i,_len,_ref,_results;if(this.events[type]&&this.events[type].length){_ref=this.events[type];_results=[];for(_i=0,_len=_ref.length;_i<_len;_i++){event=_ref[_i];if(event.target===null||target.id===event.target.id){_results.push(event.fn.call(target,data));}else{_results.push(void 0);}}return _results;}};Event.listen=function(target,type,fn){var _fn,_type;if(typeof target==="string"){_type=target;_fn=type;target=null;type=_type;fn=_fn;}if(__indexOf.call(this.types,type)<0){return false;}if(!this.events[type]){this.events[type]=[];}this.events[type].push({target:target,fn:fn});return true;};return Event;}();Caman.Event=Event;Caman.Filter=Filter=function(){function Filter(){}Filter.Type={Single:1,Kernel:2,LayerDequeue:3,LayerFinished:4,LoadOverlay:5,Plugin:6};Filter.register=function(name,filterFunc){return Caman.prototype[name]=filterFunc;};return Filter;}();Caman.IO=IO=function(){function IO(){}IO.domainRegex=/(?:(?:http|https):\/\/)((?:\w+)\.(?:(?:\w|\.)+))/;IO.isRemote=function(img){if(img==null){return false;}if(this.corsEnabled(img)){return false;}return this.isURLRemote(img.src);};IO.corsEnabled=function(img){var _ref;return img.crossOrigin!=null&&((_ref=img.crossOrigin.toLowerCase())==='anonymous'||_ref==='use-credentials');};IO.isURLRemote=function(url){var matches;matches=url.match(this.domainRegex);if(matches){return matches[1]!==document.domain;}else{return false;}};IO.remoteCheck=function(src){if(this.isURLRemote(src)){if(!Caman.remoteProxy.length){Logger.info("Attempting to load a remote image without a configured proxy. URL: "+src);}else{if(Caman.isURLRemote(Caman.remoteProxy)){Logger.info("Cannot use a remote proxy for loading images.");return;}return""+Caman.remoteProxy+"?camanProxyUrl="+encodeURIComponent(src);}}};IO.proxyUrl=function(src){return""+Caman.remoteProxy+"?"+Caman.proxyParam+"="+encodeURIComponent(src);};IO.useProxy=function(lang){var langToExt;langToExt={ruby:'rb',python:'py',perl:'pl',javascript:'js'};lang=lang.toLowerCase();if(langToExt[lang]!=null){lang=langToExt[lang];}return"proxies/caman_proxy."+lang;};return IO;}();Caman.prototype.save=function(){if(typeof exports!=="undefined"&&exports!==null){return this.nodeSave.apply(this,arguments);}else{return this.browserSave.apply(this,arguments);}};Caman.prototype.browserSave=function(type){var image;if(type==null){type="png";}type=type.toLowerCase();image=this.toBase64(type).replace("image/"+type,"image/octet-stream");return document.location.href=image;};Caman.prototype.nodeSave=function(file,overwrite){var stats;if(overwrite==null){overwrite=true;}try{stats=fs.statSync(file);if(stats.isFile()&&!overwrite){return false;}}catch(e){Log.debug("Creating output file "+file);}return fs.writeFile(file,this.canvas.toBuffer(),function(){return Log.debug("Finished writing to "+file);});};Caman.prototype.toImage=function(type){var img;img=document.createElement('img');img.src=this.toBase64(type);img.width=this.dimensions.width;img.height=this.dimensions.height;if(window.devicePixelRatio){img.width/=window.devicePixelRatio;img.height/=window.devicePixelRatio;}return img;};Caman.prototype.toBase64=function(type){if(type==null){type="png";}type=type.toLowerCase();return this.canvas.toDataURL("image/"+type);};Layer=function(){function Layer(c){this.c=c;this.filter=this.c;this.options={blendingMode:'normal',opacity:1.0};this.layerID=Util.uniqid.get();this.canvas=typeof exports!=="undefined"&&exports!==null?new Canvas():document.createElement('canvas');this.canvas.width=this.c.dimensions.width;this.canvas.height=this.c.dimensions.height;this.context=this.canvas.getContext('2d');this.context.createImageData(this.canvas.width,this.canvas.height);this.imageData=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);this.pixelData=this.imageData.data;}Layer.prototype.newLayer=function(cb){return this.c.newLayer.call(this.c,cb);};Layer.prototype.setBlendingMode=function(mode){this.options.blendingMode=mode;return this;};Layer.prototype.opacity=function(opacity){this.options.opacity=opacity/100;return this;};Layer.prototype.copyParent=function(){var i,parentData,_i,_ref;parentData=this.c.pixelData;for(i=_i=0,_ref=this.c.pixelData.length;_i<_ref;i=_i+=4){this.pixelData[i]=parentData[i];this.pixelData[i+1]=parentData[i+1];this.pixelData[i+2]=parentData[i+2];this.pixelData[i+3]=parentData[i+3];}return this;};Layer.prototype.fillColor=function(){return this.c.fillColor.apply(this.c,arguments);};Layer.prototype.overlayImage=function(image){if(typeof image==="object"){image=image.src;}else if(typeof image==="string"&&image[0]==="#"){image=$(image).src;}if(!image){return this;}this.c.renderer.renderQueue.push({type:Filter.Type.LoadOverlay,src:image,layer:this});return this;};Layer.prototype.applyToParent=function(){var i,layerData,parentData,result,rgbaLayer,rgbaParent,_i,_ref,_results;parentData=this.c.pixelStack[this.c.pixelStack.length-1];layerData=this.c.pixelData;_results=[];for(i=_i=0,_ref=layerData.length;_i<_ref;i=_i+=4){rgbaParent={r:parentData[i],g:parentData[i+1],b:parentData[i+2],a:parentData[i+3]};rgbaLayer={r:layerData[i],g:layerData[i+1],b:layerData[i+2],a:layerData[i+3]};result=Blender.execute(this.options.blendingMode,rgbaLayer,rgbaParent);result.r=Util.clampRGB(result.r);result.g=Util.clampRGB(result.g);result.b=Util.clampRGB(result.b);if(result.a==null){result.a=rgbaLayer.a;}parentData[i]=rgbaParent.r-(rgbaParent.r-result.r)*(this.options.opacity*(result.a/255));parentData[i+1]=rgbaParent.g-(rgbaParent.g-result.g)*(this.options.opacity*(result.a/255));_results.push(parentData[i+2]=rgbaParent.b-(rgbaParent.b-result.b)*(this.options.opacity*(result.a/255)));}return _results;};return Layer;}();Logger=function(){function Logger(){var name,_i,_len,_ref;_ref=['log','info','warn','error'];for(_i=0,_len=_ref.length;_i<_len;_i++){name=_ref[_i];this[name]=function(name){return function(){var args;args=1<=arguments.length?__slice.call(arguments,0):[];if(!Caman.DEBUG){return;}try{return console[name].apply(console,args);}catch(e){return console[name](args);}};}(name);}this.debug=this.log;}return Logger;}();Log=new Logger();PixelInfo=function(){PixelInfo.coordinatesToLocation=function(x,y,width){return(y*width+x)*4;};PixelInfo.locationToCoordinates=function(loc,width){var x,y;y=Math.floor(loc/(width*4));x=loc%(width*4)/4;return{x:x,y:y};};function PixelInfo(c){this.c=c;this.loc=0;}PixelInfo.prototype.locationXY=function(){var x,y;y=this.c.dimensions.height-Math.floor(this.loc/(this.c.dimensions.width*4));x=this.loc%(this.c.dimensions.width*4)/4;return{x:x,y:y};};PixelInfo.prototype.getPixelRelative=function(horiz,vert){var newLoc;newLoc=this.loc+this.c.dimensions.width*4*(vert*-1)+4*horiz;if(newLoc>this.c.pixelData.length||newLoc<0){return{r:0,g:0,b:0,a:0};}return{r:this.c.pixelData[newLoc],g:this.c.pixelData[newLoc+1],b:this.c.pixelData[newLoc+2],a:this.c.pixelData[newLoc+3]};};PixelInfo.prototype.putPixelRelative=function(horiz,vert,rgba){var nowLoc;nowLoc=this.loc+this.c.dimensions.width*4*(vert*-1)+4*horiz;if(newLoc>this.c.pixelData.length||newLoc<0){return;}this.c.pixelData[newLoc]=rgba.r;this.c.pixelData[newLoc+1]=rgba.g;this.c.pixelData[newLoc+2]=rgba.b;this.c.pixelData[newLoc+3]=rgba.a;return true;};PixelInfo.prototype.getPixel=function(x,y){var loc;loc=this.coordinatesToLocation(x,y,this.width);return{r:this.c.pixelData[loc],g:this.c.pixelData[loc+1],b:this.c.pixelData[loc+2],a:this.c.pixelData[loc+3]};};PixelInfo.prototype.putPixel=function(x,y,rgba){var loc;loc=this.coordinatesToLocation(x,y,this.width);this.c.pixelData[loc]=rgba.r;this.c.pixelData[loc+1]=rgba.g;this.c.pixelData[loc+2]=rgba.b;return this.c.pixelData[loc+3]=rgba.a;};return PixelInfo;}();Plugin=function(){function Plugin(){}Plugin.plugins={};Plugin.register=function(name,plugin){return this.plugins[name]=plugin;};Plugin.execute=function(context,name,args){return this.plugins[name].apply(context,args);};return Plugin;}();Caman.Plugin=Plugin;Caman.Renderer=Renderer=function(){Renderer.Blocks=Caman.NodeJS?require('os').cpus().length:4;function Renderer(c){var _this=this;this.c=c;this.processNext=function(){return Renderer.prototype.processNext.apply(_this,arguments);};this.renderQueue=[];this.modPixelData=null;}Renderer.prototype.add=function(job){if(job==null){return;}return this.renderQueue.push(job);};Renderer.prototype.processNext=function(){var layer;if(this.renderQueue.length===0){Event.trigger(this,"renderFinished");if(this.finishedFn!=null){this.finishedFn.call(this.c);}return this;}this.currentJob=this.renderQueue.shift();switch(this.currentJob.type){case Filter.Type.LayerDequeue:layer=this.c.canvasQueue.shift();this.c.executeLayer(layer);return this.processNext();case Filter.Type.LayerFinished:this.c.applyCurrentLayer();this.c.popContext();return this.processNext();case Filter.Type.LoadOverlay:return this.loadOverlay(this.currentJob.layer,this.currentJob.src);case Filter.Type.Plugin:return this.executePlugin();default:return this.executeFilter();}};Renderer.prototype.execute=function(callback){this.finishedFn=callback;this.modPixelData=Util.dataArray(this.c.pixelData.length);return this.processNext();};Renderer.prototype.eachBlock=function(fn){var blockN,blockPixelLength,bnum,end,f,i,lastBlockN,n,start,_i,_ref,_results,_this=this;this.blocksDone=0;n=this.c.pixelData.length;blockPixelLength=Math.floor(n/4/Renderer.Blocks);blockN=blockPixelLength*4;lastBlockN=blockN+n/4%Renderer.Blocks*4;_results=[];for(i=_i=0,_ref=Renderer.Blocks;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){start=i*blockN;end=start+(i===Renderer.Blocks-1?lastBlockN:blockN);if(Caman.NodeJS){f=Fiber(function(){return fn.call(_this,i,start,end);});bnum=f.run();_results.push(this.blockFinished(bnum));}else{_results.push(setTimeout(function(i,start,end){return function(){return fn.call(_this,i,start,end);};}(i,start,end),0));}}return _results;};Renderer.prototype.executeFilter=function(){Event.trigger(this.c,"processStart",this.currentJob);if(this.currentJob.type===Filter.Type.Single){return this.eachBlock(this.renderBlock);}else{return this.eachBlock(this.renderKernel);}};Renderer.prototype.executePlugin=function(){Log.debug("Executing plugin "+this.currentJob.plugin);Plugin.execute(this.c,this.currentJob.plugin,this.currentJob.args);Log.debug("Plugin "+this.currentJob.plugin+" finished!");return this.processNext();};Renderer.prototype.renderBlock=function(bnum,start,end){var data,i,pixelInfo,res,_i;Log.debug("Block #"+bnum+" - Filter: "+this.currentJob.name+", Start: "+start+", End: "+end);Event.trigger(this.c,"blockStarted",{blockNum:bnum,totalBlocks:Renderer.Blocks,startPixel:start,endPixel:end});data={r:0,g:0,b:0,a:0};pixelInfo=new PixelInfo(this.c);for(i=_i=start;_i<end;i=_i+=4){pixelInfo.loc=i;data.r=this.c.pixelData[i];data.g=this.c.pixelData[i+1];data.b=this.c.pixelData[i+2];data.a=this.c.pixelData[i+3];res=this.currentJob.processFn.call(pixelInfo,data);if(res.a==null){res.a=data.a;}this.c.pixelData[i]=Util.clampRGB(res.r);this.c.pixelData[i+1]=Util.clampRGB(res.g);this.c.pixelData[i+2]=Util.clampRGB(res.b);this.c.pixelData[i+3]=Util.clampRGB(res.a);}if(Caman.NodeJS){return Fiber["yield"](bnum);}else{return this.blockFinished(bnum);}};Renderer.prototype.renderKernel=function(bnum,start,end){var adjust,adjustSize,bias,builder,builderIndex,divisor,i,j,k,kernel,n,name,pixel,pixelInfo,res,_i,_j,_k;name=this.currentJob.name;bias=this.currentJob.bias;divisor=this.currentJob.divisor;n=this.c.pixelData.length;adjust=this.currentJob.adjust;adjustSize=Math.sqrt(adjust.length);kernel=[];Log.debug("Rendering kernel - Filter: "+this.currentJob.name);start=Math.max(start,this.c.dimensions.width*4*((adjustSize-1)/2));end=Math.min(end,n-this.c.dimensions.width*4*((adjustSize-1)/2));builder=(adjustSize-1)/2;pixelInfo=new PixelInfo(this.c);for(i=_i=start;_i<end;i=_i+=4){pixelInfo.loc=i;builderIndex=0;for(j=_j=-builder;-builder<=builder?_j<=builder:_j>=builder;j=-builder<=builder?++_j:--_j){for(k=_k=builder;builder<=-builder?_k<=-builder:_k>=-builder;k=builder<=-builder?++_k:--_k){pixel=pixelInfo.getPixelRelative(j,k);kernel[builderIndex*3]=pixel.r;kernel[builderIndex*3+1]=pixel.g;kernel[builderIndex*3+2]=pixel.b;builderIndex++;}}res=this.processKernel(adjust,kernel,divisor,bias);this.modPixelData[i]=Util.clampRGB(res.r);this.modPixelData[i+1]=Util.clampRGB(res.g);this.modPixelData[i+2]=Util.clampRGB(res.b);this.modPixelData[i+3]=this.c.pixelData[i+3];}if(Caman.NodeJS){return Fiber["yield"](bnum);}else{return this.blockFinished(bnum);}};Renderer.prototype.blockFinished=function(bnum){var i,_i,_ref;if(bnum>=0){Log.debug("Block #"+bnum+" finished! Filter: "+this.currentJob.name);}this.blocksDone++;Event.trigger(this.c,"blockFinished",{blockNum:bnum,blocksFinished:this.blocksDone,totalBlocks:Renderer.Blocks});if(this.blocksDone===Renderer.Blocks){if(this.currentJob.type===Filter.Type.Kernel){for(i=_i=0,_ref=this.c.pixelData.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){this.c.pixelData[i]=this.modPixelData[i];}}if(bnum>=0){Log.debug("Filter "+this.currentJob.name+" finished!");}Event.trigger(this.c,"processComplete",this.currentJob);return this.processNext();}};Renderer.prototype.processKernel=function(adjust,kernel,divisor,bias){var i,val,_i,_ref;val={r:0,g:0,b:0};for(i=_i=0,_ref=adjust.length;0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){val.r+=adjust[i]*kernel[i*3];val.g+=adjust[i]*kernel[i*3+1];val.b+=adjust[i]*kernel[i*3+2];}val.r=val.r/divisor+bias;val.g=val.g/divisor+bias;val.b=val.b/divisor+bias;return val;};Renderer.prototype.loadOverlay=function(layer,src){var img,proxyUrl,_this=this;img=document.createElement('img');img.onload=function(){layer.context.drawImage(img,0,0,_this.c.dimensions.width,_this.c.dimensions.height);layer.imageData=layer.context.getImageData(0,0,_this.c.dimensions.width,_this.c.dimensions.height);layer.pixelData=layer.imageData.data;_this.c.pixelData=layer.pixelData;return _this.processNext();};proxyUrl=IO.remoteCheck(src);return img.src=proxyUrl!=null?proxyUrl:src;};return Renderer;}();Caman.Store=Store=function(){function Store(){}Store.items={};Store.has=function(search){return this.items[search]!=null;};Store.get=function(search){return this.items[search];};Store.put=function(name,obj){return this.items[name]=obj;};Store.execute=function(search,callback){var _this=this;setTimeout(function(){return callback.call(_this.get(search),_this.get(search));},0);return this.get(search);};Store.flush=function(name){if(name==null){name=false;}if(name){return delete this.items[name];}else{return this.items={};}};return Store;}();Blender.register("normal",function(rgbaLayer,rgbaParent){return{r:rgbaLayer.r,g:rgbaLayer.g,b:rgbaLayer.b};});Blender.register("multiply",function(rgbaLayer,rgbaParent){return{r:rgbaLayer.r*rgbaParent.r/255,g:rgbaLayer.g*rgbaParent.g/255,b:rgbaLayer.b*rgbaParent.b/255};});Blender.register("screen",function(rgbaLayer,rgbaParent){return{r:255-(255-rgbaLayer.r)*(255-rgbaParent.r)/255,g:255-(255-rgbaLayer.g)*(255-rgbaParent.g)/255,b:255-(255-rgbaLayer.b)*(255-rgbaParent.b)/255};});Blender.register("overlay",function(rgbaLayer,rgbaParent){var result;result={};result.r=rgbaParent.r>128?255-2*(255-rgbaLayer.r)*(255-rgbaParent.r)/255:rgbaParent.r*rgbaLayer.r*2/255;result.g=rgbaParent.g>128?255-2*(255-rgbaLayer.g)*(255-rgbaParent.g)/255:rgbaParent.g*rgbaLayer.g*2/255;result.b=rgbaParent.b>128?255-2*(255-rgbaLayer.b)*(255-rgbaParent.b)/255:rgbaParent.b*rgbaLayer.b*2/255;return result;});Blender.register("difference",function(rgbaLayer,rgbaParent){return{r:rgbaLayer.r-rgbaParent.r,g:rgbaLayer.g-rgbaParent.g,b:rgbaLayer.b-rgbaParent.b};});Blender.register("addition",function(rgbaLayer,rgbaParent){return{r:rgbaParent.r+rgbaLayer.r,g:rgbaParent.g+rgbaLayer.g,b:rgbaParent.b+rgbaLayer.b};});Blender.register("exclusion",function(rgbaLayer,rgbaParent){return{r:128-2*(rgbaParent.r-128)*(rgbaLayer.r-128)/255,g:128-2*(rgbaParent.g-128)*(rgbaLayer.g-128)/255,b:128-2*(rgbaParent.b-128)*(rgbaLayer.b-128)/255};});Blender.register("softLight",function(rgbaLayer,rgbaParent){var result;result={};result.r=rgbaParent.r>128?255-(255-rgbaParent.r)*(255-(rgbaLayer.r-128))/255:rgbaParent.r*(rgbaLayer.r+128)/255;result.g=rgbaParent.g>128?255-(255-rgbaParent.g)*(255-(rgbaLayer.g-128))/255:rgbaParent.g*(rgbaLayer.g+128)/255;result.b=rgbaParent.b>128?255-(255-rgbaParent.b)*(255-(rgbaLayer.b-128))/255:rgbaParent.b*(rgbaLayer.b+128)/255;return result;});Blender.register("lighten",function(rgbaLayer,rgbaParent){return{r:rgbaParent.r>rgbaLayer.r?rgbaParent.r:rgbaLayer.r,g:rgbaParent.g>rgbaLayer.g?rgbaParent.g:rgbaLayer.g,b:rgbaParent.b>rgbaLayer.b?rgbaParent.b:rgbaLayer.b};});Blender.register("darken",function(rgbaLayer,rgbaParent){return{r:rgbaParent.r>rgbaLayer.r?rgbaLayer.r:rgbaParent.r,g:rgbaParent.g>rgbaLayer.g?rgbaLayer.g:rgbaParent.g,b:rgbaParent.b>rgbaLayer.b?rgbaLayer.b:rgbaParent.b};});Filter.register("fillColor",function(){var color;if(arguments.length===1){color=Convert.hexToRGB(arguments[0]);}else{color={r:arguments[0],g:arguments[1],b:arguments[2]};}return this.process("fillColor",function(rgba){rgba.r=color.r;rgba.g=color.g;rgba.b=color.b;rgba.a=255;return rgba;});});Filter.register("brightness",function(adjust){adjust=Math.floor(255*(adjust/100));return this.process("brightness",function(rgba){rgba.r+=adjust;rgba.g+=adjust;rgba.b+=adjust;return rgba;});});Filter.register("saturation",function(adjust){adjust*=-0.01;return this.process("saturation",function(rgba){var max;max=Math.max(rgba.r,rgba.g,rgba.b);if(rgba.r!==max){rgba.r+=(max-rgba.r)*adjust;}if(rgba.g!==max){rgba.g+=(max-rgba.g)*adjust;}if(rgba.b!==max){rgba.b+=(max-rgba.b)*adjust;}return rgba;});});Filter.register("vibrance",function(adjust){adjust*=-1;return this.process("vibrance",function(rgba){var amt,avg,max;max=Math.max(rgba.r,rgba.g,rgba.b);avg=(rgba.r+rgba.g+rgba.b)/3;amt=Math.abs(max-avg)*2/255*adjust/100;if(rgba.r!==max){rgba.r+=(max-rgba.r)*amt;}if(rgba.g!==max){rgba.g+=(max-rgba.g)*amt;}if(rgba.b!==max){rgba.b+=(max-rgba.b)*amt;}return rgba;});});Filter.register("greyscale",function(adjust){return this.process("greyscale",function(rgba){var avg;avg=Calculate.luminance(rgba);rgba.r=avg;rgba.g=avg;rgba.b=avg;return rgba;});});Filter.register("contrast",function(adjust){adjust=Math.pow((adjust+100)/100,2);return this.process("contrast",function(rgba){rgba.r/=255;rgba.r-=0.5;rgba.r*=adjust;rgba.r+=0.5;rgba.r*=255;rgba.g/=255;rgba.g-=0.5;rgba.g*=adjust;rgba.g+=0.5;rgba.g*=255;rgba.b/=255;rgba.b-=0.5;rgba.b*=adjust;rgba.b+=0.5;rgba.b*=255;return rgba;});});Filter.register("hue",function(adjust){return this.process("hue",function(rgba){var h,hsv,rgb;hsv=Convert.rgbToHSV(rgba.r,rgba.g,rgba.b);h=hsv.h*100;h+=Math.abs(adjust);h=h%100;h/=100;hsv.h=h;rgb=Convert.hsvToRGB(hsv.h,hsv.s,hsv.v);rgb.a=rgba.a;return rgb;});});Filter.register("colorize",function(){var level,rgb;if(arguments.length===2){rgb=Convert.hexToRGB(arguments[0]);level=arguments[1];}else if(arguments.length===4){rgb={r:arguments[0],g:arguments[1],b:arguments[2]};level=arguments[3];}return this.process("colorize",function(rgba){rgba.r-=(rgba.r-rgb.r)*(level/100);rgba.g-=(rgba.g-rgb.g)*(level/100);rgba.b-=(rgba.b-rgb.b)*(level/100);return rgba;});});Filter.register("invert",function(){return this.process("invert",function(rgba){rgba.r=255-rgba.r;rgba.g=255-rgba.g;rgba.b=255-rgba.b;return rgba;});});Filter.register("sepia",function(adjust){if(adjust==null){adjust=100;}adjust/=100;return this.process("sepia",function(rgba){rgba.r=Math.min(255,rgba.r*(1-0.607*adjust)+rgba.g*(0.769*adjust)+rgba.b*(0.189*adjust));rgba.g=Math.min(255,rgba.r*(0.349*adjust)+rgba.g*(1-0.314*adjust)+rgba.b*(0.168*adjust));rgba.b=Math.min(255,rgba.r*(0.272*adjust)+rgba.g*(0.534*adjust)+rgba.b*(1-0.869*adjust));return rgba;});});Filter.register("gamma",function(adjust){return this.process("gamma",function(rgba){rgba.r=Math.pow(rgba.r/255,adjust)*255;rgba.g=Math.pow(rgba.g/255,adjust)*255;rgba.b=Math.pow(rgba.b/255,adjust)*255;return rgba;});});Filter.register("noise",function(adjust){adjust=Math.abs(adjust)*2.55;return this.process("noise",function(rgba){var rand;rand=Calculate.randomRange(adjust*-1,adjust);rgba.r+=rand;rgba.g+=rand;rgba.b+=rand;return rgba;});});Filter.register("clip",function(adjust){adjust=Math.abs(adjust)*2.55;return this.process("clip",function(rgba){if(rgba.r>255-adjust){rgba.r=255;}else if(rgba.r<adjust){rgba.r=0;}if(rgba.g>255-adjust){rgba.g=255;}else if(rgba.g<adjust){rgba.g=0;}if(rgba.b>255-adjust){rgba.b=255;}else if(rgba.b<adjust){rgba.b=0;}return rgba;});});Filter.register("channels",function(options){var chan,value;if(typeof options!=="object"){return this;}for(chan in options){if(!__hasProp.call(options,chan))continue;value=options[chan];if(value===0){delete options[chan];continue;}options[chan]/=100;}if(options.length===0){return this;}return this.process("channels",function(rgba){if(options.red!=null){if(options.red>0){rgba.r+=(255-rgba.r)*options.red;}else{rgba.r-=rgba.r*Math.abs(options.red);}}if(options.green!=null){if(options.green>0){rgba.g+=(255-rgba.g)*options.green;}else{rgba.g-=rgba.g*Math.abs(options.green);}}if(options.blue!=null){if(options.blue>0){rgba.b+=(255-rgba.b)*options.blue;}else{rgba.b-=rgba.b*Math.abs(options.blue);}}return rgba;});});Filter.register("curves",function(){var bezier,chans,cps,ctrl1,ctrl2,end,i,start,_i,_j,_ref,_ref1;chans=arguments[0],cps=2<=arguments.length?__slice.call(arguments,1):[];if(typeof chans==="string"){chans=chans.split("");}if(chans[0]==="v"){chans=['r','g','b'];}if(cps.length<3||cps.length>4){throw"Invalid number of arguments to curves filter";}start=cps[0];ctrl1=cps[1];ctrl2=cps.length===4?cps[2]:cps[1];end=cps[cps.length-1];bezier=Calculate.bezier(start,ctrl1,ctrl2,end,0,255);if(start[0]>0){for(i=_i=0,_ref=start[0];0<=_ref?_i<_ref:_i>_ref;i=0<=_ref?++_i:--_i){bezier[i]=start[1];}}if(end[0]<255){for(i=_j=_ref1=end[0];_ref1<=255?_j<=255:_j>=255;i=_ref1<=255?++_j:--_j){bezier[i]=end[1];}}return this.process("curves",function(rgba){var _k,_ref2;for(i=_k=0,_ref2=chans.length;0<=_ref2?_k<_ref2:_k>_ref2;i=0<=_ref2?++_k:--_k){rgba[chans[i]]=bezier[rgba[chans[i]]];}return rgba;});});Filter.register("exposure",function(adjust){var ctrl1,ctrl2,p;p=Math.abs(adjust)/100;ctrl1=[0,255*p];ctrl2=[255-255*p,255];if(adjust<0){ctrl1=ctrl1.reverse();ctrl2=ctrl2.reverse();}return this.curves('rgb',[0,0],ctrl1,ctrl2,[255,255]);});Caman.Plugin.register("crop",function(width,height,x,y){var canvas,ctx;if(x==null){x=0;}if(y==null){y=0;}if(typeof exports!=="undefined"&&exports!==null){canvas=new Canvas(width,height);}else{canvas=document.createElement('canvas');Util.copyAttributes(this.canvas,canvas);canvas.width=width;canvas.height=height;}ctx=canvas.getContext('2d');ctx.drawImage(this.canvas,x,y,width,height,0,0,width,height);this.cropCoordinates={x:x,y:y};this.cropped=true;return this.replaceCanvas(canvas);});Caman.Plugin.register("resize",function(newDims){var canvas,ctx;if(newDims==null){newDims=null;}if(newDims===null||newDims.width==null&&newDims.height==null){Log.error("Invalid or missing dimensions given for resize");return;}if(newDims.width==null){newDims.width=this.canvas.width*newDims.height/this.canvas.height;}else if(newDims.height==null){newDims.height=this.canvas.height*newDims.width/this.canvas.width;}if(typeof exports!=="undefined"&&exports!==null){canvas=new Canvas(newDims.width,newDims.height);}else{canvas=document.createElement('canvas');Util.copyAttributes(this.canvas,canvas);canvas.width=newDims.width;canvas.height=newDims.height;}ctx=canvas.getContext('2d');ctx.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,newDims.width,newDims.height);this.resized=true;return this.replaceCanvas(canvas);});Caman.Filter.register("crop",function(){return this.processPlugin("crop",Array.prototype.slice.call(arguments,0));});Caman.Filter.register("resize",function(){return this.processPlugin("resize",Array.prototype.slice.call(arguments,0));});Caman.Filter.register("boxBlur",function(){return this.processKernel("Box Blur",[1,1,1,1,1,1,1,1,1]);});Caman.Filter.register("heavyRadialBlur",function(){return this.processKernel("Heavy Radial Blur",[0,0,1,0,0,0,1,1,1,0,1,1,1,1,1,0,1,1,1,0,0,0,1,0,0]);});Caman.Filter.register("gaussianBlur",function(){return this.processKernel("Gaussian Blur",[1,4,6,4,1,4,16,24,16,4,6,24,36,24,6,4,16,24,16,4,1,4,6,4,1]);});Caman.Filter.register("motionBlur",function(degrees){var kernel;if(degrees===0||degrees===180){kernel=[0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1,0,0];}else if(degrees>0&&degrees<90||degrees>180&&degrees<270){kernel=[0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0];}else if(degrees===90||degrees===270){kernel=[0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0];}else{kernel=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];}return this.processKernel("Motion Blur",kernel);});Caman.Filter.register("sharpen",function(amt){if(amt==null){amt=100;}amt/=100;return this.processKernel("Sharpen",[0,-amt,0,-amt,4*amt+1,-amt,0,-amt,0]);});vignetteFilters={brightness:function(rgba,amt,opts){rgba.r=rgba.r-rgba.r*amt*opts.strength;rgba.g=rgba.g-rgba.g*amt*opts.strength;rgba.b=rgba.b-rgba.b*amt*opts.strength;return rgba;},gamma:function(rgba,amt,opts){rgba.r=Math.pow(rgba.r/255,Math.max(10*amt*opts.strength,1))*255;rgba.g=Math.pow(rgba.g/255,Math.max(10*amt*opts.strength,1))*255;rgba.b=Math.pow(rgba.b/255,Math.max(10*amt*opts.strength,1))*255;return rgba;},colorize:function(rgba,amt,opts){rgba.r-=(rgba.r-opts.color.r)*amt;rgba.g-=(rgba.g-opts.color.g)*amt;rgba.b-=(rgba.b-opts.color.b)*amt;return rgba;}};Filter.register("vignette",function(size,strength){var bezier,center,end,start;if(strength==null){strength=60;}if(typeof size==="string"&&size.substr(-1)==="%"){if(this.dimensions.height>this.dimensions.width){size=this.dimensions.width*(parseInt(size.substr(0,size.length-1),10)/100);}else{size=this.dimensions.height*(parseInt(size.substr(0,size.length-1),10)/100);}}strength/=100;center=[this.dimensions.width/2,this.dimensions.height/2];start=Math.sqrt(Math.pow(center[0],2)+Math.pow(center[1],2));end=start-size;bezier=Calculate.bezier([0,1],[30,30],[70,60],[100,80]);return this.process("vignette",function(rgba){var dist,div,loc;loc=this.locationXY();dist=Calculate.distance(loc.x,loc.y,center[0],center[1]);if(dist>end){div=Math.max(1,bezier[Math.round((dist-end)/size*100)]/10*strength);rgba.r=Math.pow(rgba.r/255,div)*255;rgba.g=Math.pow(rgba.g/255,div)*255;rgba.b=Math.pow(rgba.b/255,div)*255;}return rgba;});});Filter.register("rectangularVignette",function(opts){var defaults,dim,percent,size,_i,_len,_ref;defaults={strength:50,cornerRadius:0,method:'brightness',color:{r:0,g:0,b:0}};opts=Util.extend(defaults,opts);if(!opts.size){return this;}else if(typeof opts.size==="string"){percent=parseInt(opts.size,10)/100;opts.size={width:this.dimensions.width*percent,height:this.dimensions.height*percent};}else if(typeof opts.size==="object"){_ref=["width","height"];for(_i=0,_len=_ref.length;_i<_len;_i++){dim=_ref[_i];if(typeof opts.size[dim]==="string"){opts.size[dim]=this.dimensions[dim]*(parseInt(opts.size[dim],10)/100);}}}else if(opts.size==="number"){size=opts.size;opts.size={width:size,height:size};}if(typeof opts.cornerRadius==="string"){opts.cornerRadius=opts.size.width/2*(parseInt(opts.cornerRadius,10)/100);}opts.strength/=100;opts.size.width=Math.floor(opts.size.width);opts.size.height=Math.floor(opts.size.height);opts.image={width:this.dimensions.width,height:this.dimensions.height};if(opts.method==="colorize"&&typeof opts.color==="string"){opts.color=Convert.hexToRGB(opts.color);}opts.coords={left:(this.dimensions.width-opts.size.width)/2,right:this.dimensions.width-opts.coords.left,bottom:(this.dimensions.height-opts.size.height)/2,top:this.dimensions.height-opts.coords.bottom};opts.corners=[{x:opts.coords.left+opts.cornerRadius,y:opts.coords.top-opts.cornerRadius},{x:opts.coords.right-opts.cornerRadius,y:opts.coords.top-opts.cornerRadius},{x:opts.coords.right-opts.cornerRadius,y:opts.coords.bottom+opts.cornerRadius},{x:opts.coords.left+opts.cornerRadius,y:opts.coords.bottom+opts.cornerRadius}];opts.maxDist=Calculate.distance(0,0,opts.corners[3].x,opts.corners[3].y)-opts.cornerRadius;return this.process("rectangularVignette",function(rgba){var amt,loc,radialDist;loc=this.locationXY();if(loc.x>opts.corners[0].x&&loc.x<opts.corners[1].x&&loc.y>opts.coords.bottom&&loc.y<opts.coords.top){return rgba;}if(loc.x>opts.coords.left&&loc.x<opts.coords.right&&loc.y>opts.corners[3].y&&loc.y<opts.corners[2].y){return rgba;}if(loc.x>opts.corners[0].x&&loc.x<opts.corners[1].x&&loc.y>opts.coords.top){amt=(loc.y-opts.coords.top)/opts.maxDist;}else if(loc.y>opts.corners[2].y&&loc.y<opts.corners[1].y&&loc.x>opts.coords.right){amt=(loc.x-opts.coords.right)/opts.maxDist;}else if(loc.x>opts.corners[0].x&&loc.x<opts.corners[1].x&&loc.y<opts.coords.bottom){amt=(opts.coords.bottom-loc.y)/opts.maxDist;}else if(loc.y>opts.corners[2].y&&loc.y<opts.corners[1].y&&loc.x<opts.coords.left){amt=(opts.coords.left-loc.x)/opts.maxDist;}else if(loc.x<=opts.corners[0].x&&loc.y>=opts.corners[0].y){radialDist=Caman.distance(loc.x,loc.y,opts.corners[0].x,opts.corners[0].y);amt=(radialDist-opts.cornerRadius)/opts.maxDist;}else if(loc.x>=opts.corners[1].x&&loc.y>=opts.corners[1].y){radialDist=Caman.distance(loc.x,loc.y,opts.corners[1].x,opts.corners[1].y);amt=(radialDist-opts.cornerRadius)/opts.maxDist;}else if(loc.x>=opts.corners[2].x&&loc.y<=opts.corners[2].y){radialDist=Caman.distance(loc.x,loc.y,opts.corners[2].x,opts.corners[2].y);amt=(radialDist-opts.cornerRadius)/opts.maxDist;}else if(loc.x<=opts.corners[3].x&&loc.y<=opts.corners[3].y){radialDist=Caman.distance(loc.x,loc.y,opts.corners[3].x,opts.corners[3].y);amt=(radialDist-opts.cornerRadius)/opts.maxDist;}if(amt<0){return rgba;}return vignetteFilters[opts.method](rgba,amt,opts);});});(function(){var BlurStack,getLinearGradientMap,getRadialGradientMap,mul_table,shg_table;mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];getLinearGradientMap=function(width,height,centerX,centerY,angle,length,mirrored){var cnv,context,gradient,x1,x2,y1,y2;cnv=typeof exports!=="undefined"&&exports!==null?new Canvas():document.createElement('canvas');cnv.width=width;cnv.height=height;x1=centerX+Math.cos(angle)*length*0.5;y1=centerY+Math.sin(angle)*length*0.5;x2=centerX-Math.cos(angle)*length*0.5;y2=centerY-Math.sin(angle)*length*0.5;context=cnv.getContext("2d");gradient=context.createLinearGradient(x1,y1,x2,y2);if(!mirrored){gradient.addColorStop(0,"white");gradient.addColorStop(1,"black");}else{gradient.addColorStop(0,"white");gradient.addColorStop(0.5,"black");gradient.addColorStop(1,"white");}context.fillStyle=gradient;context.fillRect(0,0,width,height);return context.getImageData(0,0,width,height);};getRadialGradientMap=function(width,height,centerX,centerY,radius1,radius2){var cnv,context,gradient;cnv=typeof exports!=="undefined"&&exports!==null?new Canvas():document.createElement('canvas');cnv.width=width;cnv.height=height;context=cnv.getContext("2d");gradient=context.createRadialGradient(centerX,centerY,radius1,centerX,centerY,radius2);gradient.addColorStop(1,"white");gradient.addColorStop(0,"black");context.fillStyle=gradient;context.fillRect(0,0,width,height);return context.getImageData(0,0,width,height);};BlurStack=function(){this.r=0;this.g=0;this.b=0;this.a=0;return this.next=null;};Caman.Plugin.register("compoundBlur",function(radiusData,radius,increaseFactor,blurLevels){var b_in_sum,b_out_sum,b_sum,blend,currentIndex,div,g_in_sum,g_out_sum,g_sum,height,heightMinus1,i,iblend,idx,imagePixels,index,iradius,lookupValue,mul_sum,p,pb,pg,pixels,pr,r_in_sum,r_out_sum,r_sum,radiusPixels,radiusPlus1,rbs,shg_sum,stack,stackEnd,stackIn,stackOut,stackStart,steps,sumFactor,w4,wh,wh4,width,widthMinus1,x,y,yi,yp,yw,_i,_j,_k,_l,_m,_n,_o,_p,_q,_r;width=this.dimensions.width;height=this.dimensions.height;imagePixels=this.pixelData;radiusPixels=radiusData.data;wh=width*height;wh4=wh<<2;pixels=[];for(i=_i=0;0<=wh4?_i<wh4:_i>wh4;i=0<=wh4?++_i:--_i){pixels[i]=imagePixels[i];}currentIndex=0;steps=blurLevels;blurLevels-=1;while(steps-->=0){iradius=radius+0.5|0;if(iradius===0){continue;}if(iradius>256){iradius=256;}div=iradius+iradius+1;w4=width<<2;widthMinus1=width-1;heightMinus1=height-1;radiusPlus1=iradius+1;sumFactor=radiusPlus1*(radiusPlus1+1)/2;stackStart=new BlurStack();stackEnd=void 0;stack=stackStart;for(i=_j=1;1<=div?_j<div:_j>div;i=1<=div?++_j:--_j){stack=stack.next=new BlurStack();if(i===radiusPlus1){stackEnd=stack;}}stack.next=stackStart;stackIn=null;stackOut=null;yw=yi=0;mul_sum=mul_table[iradius];shg_sum=shg_table[iradius];for(y=_k=0;0<=height?_k<height:_k>height;y=0<=height?++_k:--_k){r_in_sum=g_in_sum=b_in_sum=r_sum=g_sum=b_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=_l=0;0<=radiusPlus1?_l<radiusPlus1:_l>radiusPlus1;i=0<=radiusPlus1?++_l:--_l){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next;}for(i=_m=1;1<=radiusPlus1?_m<radiusPlus1:_m>radiusPlus1;i=1<=radiusPlus1?++_m:--_m){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next;}stackIn=stackStart;stackOut=stackEnd;for(x=_n=0;0<=width?_n<width:_n>width;x=0<=width?++_n:--_n){pixels[yi]=r_sum*mul_sum>>shg_sum;pixels[yi+1]=g_sum*mul_sum>>shg_sum;pixels[yi+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=yw+((p=x+radiusPlus1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=4;}yw+=width;}for(x=_o=0;0<=width?_o<width:_o>width;x=0<=width?++_o:--_o){g_in_sum=b_in_sum=r_in_sum=g_sum=b_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=_p=0;0<=radiusPlus1?_p<radiusPlus1:_p>radiusPlus1;i=0<=radiusPlus1?++_p:--_p){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next;}yp=width;for(i=_q=1;1<=radiusPlus1?_q<radiusPlus1:_q>radiusPlus1;i=1<=radiusPlus1?++_q:--_q){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next;if(i<heightMinus1){yp+=width;}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=_r=0;0<=height?_r<height:_r>height;y=0<=height?++_r:--_r){p=yi<<2;pixels[p]=r_sum*mul_sum>>shg_sum;pixels[p+1]=g_sum*mul_sum>>shg_sum;pixels[p+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=width;}}radius*=increaseFactor;i=wh;while(--i>-1){idx=i<<2;lookupValue=(radiusPixels[idx+2]&0xff)/255.0*blurLevels;index=lookupValue|0;if(index===currentIndex){blend=256.0*(lookupValue-(lookupValue|0));iblend=256-blend;imagePixels[idx]=imagePixels[idx]*iblend+pixels[idx]*blend>>8;imagePixels[idx+1]=imagePixels[idx+1]*iblend+pixels[idx+1]*blend>>8;imagePixels[idx+2]=imagePixels[idx+2]*iblend+pixels[idx+2]*blend>>8;}else if(index===currentIndex+1){imagePixels[idx]=pixels[idx];imagePixels[idx+1]=pixels[idx+1];imagePixels[idx+2]=pixels[idx+2];}}currentIndex++;}return this;});Caman.Filter.register("tiltShift",function(opts){var defaults,gradient;defaults={center:{x:this.dimensions.width/2,y:this.dimensions.height/2},angle:45,focusWidth:200,startRadius:3,radiusFactor:1.5,steps:3};opts=Util.extend(defaults,opts);opts.angle*=Math.PI/180;gradient=getLinearGradientMap(this.dimensions.width,this.dimensions.height,opts.center.x,opts.center.y,opts.angle,opts.focusWidth,true);return this.processPlugin("compoundBlur",[gradient,opts.startRadius,opts.radiusFactor,opts.steps]);});return Caman.Filter.register("radialBlur",function(opts){var defaults,gradient,radius1,radius2;defaults={size:50,center:{x:this.dimensions.width/2,y:this.dimensions.height/2},startRadius:3,radiusFactor:1.5,steps:3,radius:null};opts=Util.extend(defaults,opts);if(!opts.radius){opts.radius=this.dimensions.width<this.dimensions.height?this.dimensions.height:this.dimensions.width;}radius1=opts.radius/2-opts.size;radius2=opts.radius/2;gradient=getRadialGradientMap(this.dimensions.width,this.dimensions.height,opts.center.x,opts.center.y,radius1,radius2);return this.processPlugin("compoundBlur",[gradient,opts.startRadius,opts.radiusFactor,opts.steps]);});})();Caman.Filter.register("edgeEnhance",function(){return this.processKernel("Edge Enhance",[0,0,0,-1,1,0,0,0,0]);});Caman.Filter.register("edgeDetect",function(){return this.processKernel("Edge Detect",[-1,-1,-1,-1,8,-1,-1,-1,-1]);});Caman.Filter.register("emboss",function(){return this.processKernel("Emboss",[-2,-1,0,-1,1,1,0,1,2]);});Caman.Filter.register("posterize",function(adjust){var numOfAreas,numOfValues;numOfAreas=256/adjust;numOfValues=255/(adjust-1);return this.process("posterize",function(rgba){rgba.r=Math.floor(Math.floor(rgba.r/numOfAreas)*numOfValues);rgba.g=Math.floor(Math.floor(rgba.g/numOfAreas)*numOfValues);rgba.b=Math.floor(Math.floor(rgba.b/numOfAreas)*numOfValues);return rgba;});});Caman.Filter.register("vintage",function(vignette){if(vignette==null){vignette=true;}this.greyscale();this.contrast(5);this.noise(3);this.sepia(100);this.channels({red:8,blue:2,green:4});this.gamma(0.87);if(vignette){return this.vignette("40%",30);}});Caman.Filter.register("lomo",function(vignette){if(vignette==null){vignette=true;}this.brightness(15);this.exposure(15);this.curves('rgb',[0,0],[200,0],[155,255],[255,255]);this.saturation(-20);this.gamma(1.8);if(vignette){this.vignette("50%",60);}return this.brightness(5);});Caman.Filter.register("clarity",function(grey){if(grey==null){grey=false;}this.vibrance(20);this.curves('rgb',[5,0],[130,150],[190,220],[250,255]);this.sharpen(15);this.vignette("45%",20);if(grey){this.greyscale();this.contrast(4);}return this;});Caman.Filter.register("sinCity",function(){this.contrast(100);this.brightness(15);this.exposure(10);this.posterize(80);this.clip(30);return this.greyscale();});Caman.Filter.register("sunrise",function(){this.exposure(3.5);this.saturation(-5);this.vibrance(50);this.sepia(60);this.colorize("#e87b22",10);this.channels({red:8,blue:8});this.contrast(5);this.gamma(1.2);return this.vignette("55%",25);});Caman.Filter.register("crossProcess",function(){this.exposure(5);this.colorize("#e87b22",4);this.sepia(20);this.channels({blue:8,red:3});this.curves('b',[0,0],[100,150],[180,180],[255,255]);this.contrast(15);this.vibrance(75);return this.gamma(1.6);});Caman.Filter.register("orangePeel",function(){this.curves('rgb',[0,0],[100,50],[140,200],[255,255]);this.vibrance(-30);this.saturation(-30);this.colorize('#ff9000',30);this.contrast(-5);return this.gamma(1.4);});Caman.Filter.register("love",function(){this.brightness(5);this.exposure(8);this.contrast(4);this.colorize('#c42007',30);this.vibrance(50);return this.gamma(1.3);});Caman.Filter.register("grungy",function(){this.gamma(1.5);this.clip(25);this.saturation(-60);this.contrast(5);this.noise(5);return this.vignette("50%",30);});Caman.Filter.register("jarques",function(){this.saturation(-35);this.curves('b',[20,0],[90,120],[186,144],[255,230]);this.curves('r',[0,0],[144,90],[138,120],[255,255]);this.curves('g',[10,0],[115,105],[148,100],[255,248]);this.curves('rgb',[0,0],[120,100],[128,140],[255,255]);return this.sharpen(20);});Caman.Filter.register("pinhole",function(){this.greyscale();this.sepia(10);this.exposure(10);this.contrast(15);return this.vignette("60%",35);});Caman.Filter.register("oldBoot",function(){this.saturation(-20);this.vibrance(-50);this.gamma(1.1);this.sepia(30);this.channels({red:-10,blue:5});this.curves('rgb',[0,0],[80,50],[128,230],[255,255]);return this.vignette("60%",30);});Caman.Filter.register("glowingSun",function(vignette){if(vignette==null){vignette=true;}this.brightness(10);this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(80);this.copyParent();this.filter.gamma(0.8);this.filter.contrast(50);return this.filter.exposure(10);});this.newLayer(function(){this.setBlendingMode("softLight");this.opacity(80);return this.fillColor("#f49600");});this.exposure(20);this.gamma(0.8);if(vignette){return this.vignette("45%",20);}});Caman.Filter.register("hazyDays",function(){this.gamma(1.2);this.newLayer(function(){this.setBlendingMode("overlay");this.opacity(60);this.copyParent();this.filter.channels({red:5});return this.filter.stackBlur(15);});this.newLayer(function(){this.setBlendingMode("addition");this.opacity(40);return this.fillColor("#6899ba");});this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(35);this.copyParent();this.filter.brightness(40);this.filter.vibrance(40);this.filter.exposure(30);this.filter.contrast(15);this.filter.curves('r',[0,40],[128,128],[128,128],[255,215]);this.filter.curves('g',[0,40],[128,128],[128,128],[255,215]);this.filter.curves('b',[0,40],[128,128],[128,128],[255,215]);return this.filter.stackBlur(5);});this.curves('r',[20,0],[128,158],[128,128],[235,255]);this.curves('g',[20,0],[128,128],[128,128],[235,255]);this.curves('b',[20,0],[128,108],[128,128],[235,255]);return this.vignette("45%",20);});Caman.Filter.register("herMajesty",function(){this.brightness(40);this.colorize("#ea1c5d",10);this.curves('b',[0,10],[128,180],[190,190],[255,255]);this.newLayer(function(){this.setBlendingMode('overlay');this.opacity(50);this.copyParent();this.filter.gamma(0.7);return this.newLayer(function(){this.setBlendingMode('normal');this.opacity(60);return this.fillColor('#ea1c5d');});});this.newLayer(function(){this.setBlendingMode('multiply');this.opacity(60);this.copyParent();this.filter.saturation(50);this.filter.hue(90);return this.filter.contrast(10);});this.gamma(1.4);this.vibrance(-30);this.newLayer(function(){this.opacity(10);return this.fillColor('#e5f0ff');});return this;});Caman.Filter.register("nostalgia",function(){this.saturation(20);this.gamma(1.4);this.greyscale();this.contrast(5);this.sepia(100);this.channels({red:8,blue:2,green:4});this.gamma(0.8);this.contrast(5);this.exposure(10);this.newLayer(function(){this.setBlendingMode('overlay');this.copyParent();this.opacity(55);return this.filter.stackBlur(10);});return this.vignette("50%",30);});Caman.Filter.register("hemingway",function(){this.greyscale();this.contrast(10);this.gamma(0.9);this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(40);this.copyParent();this.filter.exposure(15);this.filter.contrast(15);return this.filter.channels({green:10,red:5});});this.sepia(30);this.curves('rgb',[0,10],[120,90],[180,200],[235,255]);this.channels({red:5,green:-2});return this.exposure(15);});Caman.Filter.register("concentrate",function(){this.sharpen(40);this.saturation(-50);this.channels({red:3});this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(80);this.copyParent();this.filter.sharpen(5);this.filter.contrast(50);this.filter.exposure(10);return this.filter.channels({blue:5});});return this.brightness(10);});(function(){var BlurStack,mul_table,shg_table;mul_table=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259];shg_table=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24];BlurStack=function(){this.r=0;this.g=0;this.b=0;this.a=0;return this.next=null;};Caman.Plugin.register("stackBlur",function(radius){var b_in_sum,b_out_sum,b_sum,div,g_in_sum,g_out_sum,g_sum,height,heightMinus1,i,mul_sum,p,pb,pg,pixels,pr,r_in_sum,r_out_sum,r_sum,radiusPlus1,rbs,shg_sum,stack,stackEnd,stackIn,stackOut,stackStart,sumFactor,w4,width,widthMinus1,x,y,yi,yp,yw,_i,_j,_k,_l,_m,_n,_o,_p,_q;if(isNaN(radius)||radius<1){return;}radius|=0;pixels=this.pixelData;width=this.dimensions.width;height=this.dimensions.height;div=radius+radius+1;w4=width<<2;widthMinus1=width-1;heightMinus1=height-1;radiusPlus1=radius+1;sumFactor=radiusPlus1*(radiusPlus1+1)/2;stackStart=new BlurStack();stack=stackStart;for(i=_i=1;1<=div?_i<div:_i>div;i=1<=div?++_i:--_i){stack=stack.next=new BlurStack();if(i===radiusPlus1){stackEnd=stack;}}stack.next=stackStart;stackIn=null;stackOut=null;yw=yi=0;mul_sum=mul_table[radius];shg_sum=shg_table[radius];for(y=_j=0;0<=height?_j<height:_j>height;y=0<=height?++_j:--_j){r_in_sum=g_in_sum=b_in_sum=r_sum=g_sum=b_sum=0;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=_k=0;0<=radiusPlus1?_k<radiusPlus1:_k>radiusPlus1;i=0<=radiusPlus1?++_k:--_k){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next;}for(i=_l=1;1<=radiusPlus1?_l<radiusPlus1:_l>radiusPlus1;i=1<=radiusPlus1?++_l:--_l){p=yi+((widthMinus1<i?widthMinus1:i)<<2);r_sum+=(stack.r=pr=pixels[p])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[p+1])*rbs;b_sum+=(stack.b=pb=pixels[p+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next;}stackIn=stackStart;stackOut=stackEnd;for(x=_m=0;0<=width?_m<width:_m>width;x=0<=width?++_m:--_m){pixels[yi]=r_sum*mul_sum>>shg_sum;pixels[yi+1]=g_sum*mul_sum>>shg_sum;pixels[yi+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=yw+((p=x+radius+1)<widthMinus1?p:widthMinus1)<<2;r_in_sum+=stackIn.r=pixels[p];g_in_sum+=stackIn.g=pixels[p+1];b_in_sum+=stackIn.b=pixels[p+2];r_sum+=r_in_sum;g_sum+=g_in_sum;b_sum+=b_in_sum;stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=4;}yw+=width;}for(x=_n=0;0<=width?_n<width:_n>width;x=0<=width?++_n:--_n){g_in_sum=b_in_sum=r_in_sum=g_sum=b_sum=r_sum=0;yi=x<<2;r_out_sum=radiusPlus1*(pr=pixels[yi]);g_out_sum=radiusPlus1*(pg=pixels[yi+1]);b_out_sum=radiusPlus1*(pb=pixels[yi+2]);r_sum+=sumFactor*pr;g_sum+=sumFactor*pg;b_sum+=sumFactor*pb;stack=stackStart;for(i=_o=0;0<=radiusPlus1?_o<radiusPlus1:_o>radiusPlus1;i=0<=radiusPlus1?++_o:--_o){stack.r=pr;stack.g=pg;stack.b=pb;stack=stack.next;}yp=width;for(i=_p=1;1<=radius?_p<=radius:_p>=radius;i=1<=radius?++_p:--_p){yi=yp+x<<2;r_sum+=(stack.r=pr=pixels[yi])*(rbs=radiusPlus1-i);g_sum+=(stack.g=pg=pixels[yi+1])*rbs;b_sum+=(stack.b=pb=pixels[yi+2])*rbs;r_in_sum+=pr;g_in_sum+=pg;b_in_sum+=pb;stack=stack.next;if(i<heightMinus1){yp+=width;}}yi=x;stackIn=stackStart;stackOut=stackEnd;for(y=_q=0;0<=height?_q<height:_q>height;y=0<=height?++_q:--_q){p=yi<<2;pixels[p]=r_sum*mul_sum>>shg_sum;pixels[p+1]=g_sum*mul_sum>>shg_sum;pixels[p+2]=b_sum*mul_sum>>shg_sum;r_sum-=r_out_sum;g_sum-=g_out_sum;b_sum-=b_out_sum;r_out_sum-=stackIn.r;g_out_sum-=stackIn.g;b_out_sum-=stackIn.b;p=x+((p=y+radiusPlus1)<heightMinus1?p:heightMinus1)*width<<2;r_sum+=r_in_sum+=stackIn.r=pixels[p];g_sum+=g_in_sum+=stackIn.g=pixels[p+1];b_sum+=b_in_sum+=stackIn.b=pixels[p+2];stackIn=stackIn.next;r_out_sum+=pr=stackOut.r;g_out_sum+=pg=stackOut.g;b_out_sum+=pb=stackOut.b;r_in_sum-=pr;g_in_sum-=pg;b_in_sum-=pb;stackOut=stackOut.next;yi+=width;}}return this;});return Caman.Filter.register("stackBlur",function(radius){return this.processPlugin("stackBlur",[radius]);});})();Caman.Filter.register("threshold",function(adjust){return this.process("threshold",function(rgba){var luminance;luminance=0.2126*rgba.r+0.7152*rgba.g+0.0722*rgba.b;if(luminance<adjust){rgba.r=0;rgba.g=0;rgba.b=0;}else{rgba.r=255;rgba.g=255;rgba.b=255;}return rgba;});});}).call(this);/*! Hammer.JS - v2.0.8 - 2016-09-30
 * http://hammerjs.github.io/
 *
 * Copyright (c)  Jorik Tangelder;
 * Licensed under the MIT license */(function(window,document,exportName,undefined){'use strict';/**
 * @private
 * use the val2 when val1 is undefined
 * @param {*} val1
 * @param {*} val2
 * @returns {*}
 */function ifUndefined(val1,val2){return val1===undefined?val2:val1;}var VENDOR_PREFIXES=['','webkit','Moz','MS','ms','o'];var TEST_ELEMENT=document.createElement('div');var TYPE_FUNCTION='function';var round=Math.round;var abs=Math.abs;var now=Date.now;/**
 * @private
 * get the prefixed property
 * @param {Object} obj
 * @param {String} property
 * @returns {String|Undefined} prefixed
 */function prefixed(obj,property){var prefix=void 0;var prop=void 0;var camelProp=property[0].toUpperCase()+property.slice(1);var i=0;while(i<VENDOR_PREFIXES.length){prefix=VENDOR_PREFIXES[i];prop=prefix?prefix+camelProp:property;if(prop in obj){return prop;}i++;}return undefined;}function getTouchActionProps(){if(!NATIVE_TOUCH_ACTION){return false;}var touchMap={};var cssSupports=window.CSS&&window.CSS.supports;['auto','manipulation','pan-y','pan-x','pan-x pan-y','none'].forEach(function(val){// If css.supports is not supported but there is native touch-action assume it supports
// all values. This is the case for IE 10 and 11.
return touchMap[val]=cssSupports?window.CSS.supports('touch-action',val):true;});return touchMap;}var PREFIXED_TOUCH_ACTION=prefixed(TEST_ELEMENT.style,'touchAction');var NATIVE_TOUCH_ACTION=PREFIXED_TOUCH_ACTION!==undefined;// magical touchAction value
var TOUCH_ACTION_COMPUTE='compute';var TOUCH_ACTION_AUTO='auto';var TOUCH_ACTION_MANIPULATION='manipulation';// not implemented
var TOUCH_ACTION_NONE='none';var TOUCH_ACTION_PAN_X='pan-x';var TOUCH_ACTION_PAN_Y='pan-y';var TOUCH_ACTION_MAP=getTouchActionProps();var MOBILE_REGEX=/mobile|tablet|ip(ad|hone|od)|android/i;var SUPPORT_TOUCH=('ontouchstart'in window);var SUPPORT_POINTER_EVENTS=prefixed(window,'PointerEvent')!==undefined;var SUPPORT_ONLY_TOUCH=SUPPORT_TOUCH&&MOBILE_REGEX.test(navigator.userAgent);var INPUT_TYPE_TOUCH='touch';var INPUT_TYPE_PEN='pen';var INPUT_TYPE_MOUSE='mouse';var INPUT_TYPE_KINECT='kinect';var COMPUTE_INTERVAL=25;var INPUT_START=1;var INPUT_MOVE=2;var INPUT_END=4;var INPUT_CANCEL=8;var DIRECTION_NONE=1;var DIRECTION_LEFT=2;var DIRECTION_RIGHT=4;var DIRECTION_UP=8;var DIRECTION_DOWN=16;var DIRECTION_HORIZONTAL=DIRECTION_LEFT|DIRECTION_RIGHT;var DIRECTION_VERTICAL=DIRECTION_UP|DIRECTION_DOWN;var DIRECTION_ALL=DIRECTION_HORIZONTAL|DIRECTION_VERTICAL;var PROPS_XY=['x','y'];var PROPS_CLIENT_XY=['clientX','clientY'];var STATE_POSSIBLE=1;var STATE_BEGAN=2;var STATE_CHANGED=4;var STATE_ENDED=8;var STATE_RECOGNIZED=STATE_ENDED;var STATE_CANCELLED=16;var STATE_FAILED=32;/**
 * @private
 * extend object.
 * means that properties in dest will be overwritten by the ones in src.
 * @param {Object} target
 * @param {...Object} objects_to_assign
 * @returns {Object} target
 */var assign=void 0;if(typeof Object.assign!=='function'){assign=function assign(target){if(target===undefined||target===null){throw new TypeError('Cannot convert undefined or null to object');}var output=Object(target);for(var index=1;index<arguments.length;index++){var source=arguments[index];if(source!==undefined&&source!==null){for(var nextKey in source){if(source.hasOwnProperty(nextKey)){output[nextKey]=source[nextKey];}}}}return output;};}else{assign=Object.assign;}var assign$1=assign;/**
 * @private
 * get a unique id
 * @returns {number} uniqueId
 */var _uniqueId=1;function uniqueId(){return _uniqueId++;}/**
 * @private
 * walk objects and arrays
 * @param {Object} obj
 * @param {Function} iterator
 * @param {Object} context
 */function each(obj,iterator,context){var i=void 0;if(!obj){return;}if(obj.forEach){obj.forEach(iterator,context);}else if(obj.length!==undefined){i=0;while(i<obj.length){iterator.call(context,obj[i],i,obj);i++;}}else{for(i in obj){obj.hasOwnProperty(i)&&iterator.call(context,obj[i],i,obj);}}}/**
 * @private
 * if the argument is an array, we want to execute the fn on each entry
 * if it aint an array we don't want to do a thing.
 * this is used by all the methods that accept a single and array argument.
 * @param {*|Array} arg
 * @param {String} fn
 * @param {Object} [context]
 * @returns {Boolean}
 */function invokeArrayArg(arg,fn,context){if(Array.isArray(arg)){each(arg,context[fn],context);return true;}return false;}/**
 * @private
 * find if a array contains the object using indexOf or a simple polyFill
 * @param {Array} src
 * @param {String} find
 * @param {String} [findByKey]
 * @return {Boolean|Number} false when not found, or the index
 */function inArray(src,find,findByKey){if(src.indexOf&&!findByKey){return src.indexOf(find);}else{var i=0;while(i<src.length){if(findByKey&&src[i][findByKey]==find||!findByKey&&src[i]===find){// do not use === here, test fails
return i;}i++;}return-1;}}var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj;}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};var asyncGenerator=function(){function AwaitValue(value){this.value=value;}function AsyncGenerator(gen){var front,back;function send(key,arg){return new Promise(function(resolve,reject){var request={key:key,arg:arg,resolve:resolve,reject:reject,next:null};if(back){back=back.next=request;}else{front=back=request;resume(key,arg);}});}function resume(key,arg){try{var result=gen[key](arg);var value=result.value;if(value instanceof AwaitValue){Promise.resolve(value.value).then(function(arg){resume("next",arg);},function(arg){resume("throw",arg);});}else{settle(result.done?"return":"normal",result.value);}}catch(err){settle("throw",err);}}function settle(type,value){switch(type){case"return":front.resolve({value:value,done:true});break;case"throw":front.reject(value);break;default:front.resolve({value:value,done:false});break;}front=front.next;if(front){resume(front.key,front.arg);}else{back=null;}}this._invoke=send;if(typeof gen.return!=="function"){this.return=undefined;}}if(typeof Symbol==="function"&&Symbol.asyncIterator){AsyncGenerator.prototype[Symbol.asyncIterator]=function(){return this;};}AsyncGenerator.prototype.next=function(arg){return this._invoke("next",arg);};AsyncGenerator.prototype.throw=function(arg){return this._invoke("throw",arg);};AsyncGenerator.prototype.return=function(arg){return this._invoke("return",arg);};return{wrap:function(fn){return function(){return new AsyncGenerator(fn.apply(this,arguments));};},await:function(value){return new AwaitValue(value);}};}();var classCallCheck=function(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}};var createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var get=function get(object,property,receiver){if(object===null)object=Function.prototype;var desc=Object.getOwnPropertyDescriptor(object,property);if(desc===undefined){var parent=Object.getPrototypeOf(object);if(parent===null){return undefined;}else{return get(parent,property,receiver);}}else if("value"in desc){return desc.value;}else{var getter=desc.get;if(getter===undefined){return undefined;}return getter.call(receiver);}};var inherits=function(subClass,superClass){if(typeof superClass!=="function"&&superClass!==null){throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);}subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:false,writable:true,configurable:true}});if(superClass)Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass;};var possibleConstructorReturn=function(self,call){if(!self){throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return call&&(typeof call==="object"||typeof call==="function")?call:self;};var slicedToArray=function(){function sliceIterator(arr,i){var _arr=[];var _n=true;var _d=false;var _e=undefined;try{for(var _i=arr[Symbol.iterator](),_s;!(_n=(_s=_i.next()).done);_n=true){_arr.push(_s.value);if(i&&_arr.length===i)break;}}catch(err){_d=true;_e=err;}finally{try{if(!_n&&_i["return"])_i["return"]();}finally{if(_d)throw _e;}}return _arr;}return function(arr,i){if(Array.isArray(arr)){return arr;}else if(Symbol.iterator in Object(arr)){return sliceIterator(arr,i);}else{throw new TypeError("Invalid attempt to destructure non-iterable instance");}};}();/**
 * @private
 * let a boolean value also be a function that must return a boolean
 * this first item in args will be used as the context
 * @param {Boolean|Function} val
 * @param {Array} [args]
 * @returns {Boolean}
 */function boolOrFn(val,args){if((typeof val==='undefined'?'undefined':_typeof(val))===TYPE_FUNCTION){return val.apply(args?args[0]||undefined:undefined,args);}return val;}/**
 * @private
 * get a recognizer by name if it is bound to a manager
 * @param {Recognizer|String} otherRecognizer
 * @param {Recognizer} recognizer
 * @returns {Recognizer}
 */function getRecognizerByNameIfManager(otherRecognizer,recognizer){var manager=recognizer.manager;if(manager){return manager.get(otherRecognizer);}return otherRecognizer;}/**
 * @private
 * get a usable string, used as event postfix
 * @param {constant} state
 * @returns {String} state
 */function stateStr(state){if(state&STATE_CANCELLED){return'cancel';}else if(state&STATE_ENDED){return'end';}else if(state&STATE_CHANGED){return'move';}else if(state&STATE_BEGAN){return'start';}return'';}/**
 * @private
 * Recognizer flow explained; *
 * All recognizers have the initial state of POSSIBLE when a input session starts.
 * The definition of a input session is from the first input until the last input, with all it's movement in it. *
 * Example session for mouse-input: mousedown -> mousemove -> mouseup
 *
 * On each recognizing cycle (see Manager.recognize) the .recognize() method is executed
 * which determines with state it should be.
 *
 * If the recognizer has the state FAILED, CANCELLED or RECOGNIZED (equals ENDED), it is reset to
 * POSSIBLE to give it another change on the next cycle.
 *
 *               Possible
 *                  |
 *            +-----+---------------+
 *            |                     |
 *      +-----+-----+               |
 *      |           |               |
 *   Failed      Cancelled          |
 *                          +-------+------+
 *                          |              |
 *                      Recognized       Began
 *                                         |
 *                                      Changed
 *                                         |
 *                                  Ended/Recognized
 */ /**
 * @private
 * Recognizer
 * Every recognizer needs to extend from this class.
 * @constructor
 * @param {Object} options
 */var Recognizer=function(){function Recognizer(options){classCallCheck(this,Recognizer);this.options=assign$1({},this.defaults,options||{});this.id=uniqueId();this.manager=null;// default is enable true
this.options.enable=ifUndefined(this.options.enable,true);this.state=STATE_POSSIBLE;this.simultaneous={};this.requireFail=[];}/**
   * @private
   * set options
   * @param {Object} options
   * @return {Recognizer}
   */createClass(Recognizer,[{key:'set',value:function set(options){assign$1(this.options,options);// also update the touchAction, in case something changed about the directions/enabled state
this.manager&&this.manager.touchAction.update();return this;}/**
     * @private
     * recognize simultaneous with an other recognizer.
     * @param {Recognizer} otherRecognizer
     * @returns {Recognizer} this
     */},{key:'recognizeWith',value:function recognizeWith(otherRecognizer){if(invokeArrayArg(otherRecognizer,'recognizeWith',this)){return this;}var simultaneous=this.simultaneous;otherRecognizer=getRecognizerByNameIfManager(otherRecognizer,this);if(!simultaneous[otherRecognizer.id]){simultaneous[otherRecognizer.id]=otherRecognizer;otherRecognizer.recognizeWith(this);}return this;}/**
     * @private
     * drop the simultaneous link. it doesnt remove the link on the other recognizer.
     * @param {Recognizer} otherRecognizer
     * @returns {Recognizer} this
     */},{key:'dropRecognizeWith',value:function dropRecognizeWith(otherRecognizer){if(invokeArrayArg(otherRecognizer,'dropRecognizeWith',this)){return this;}otherRecognizer=getRecognizerByNameIfManager(otherRecognizer,this);delete this.simultaneous[otherRecognizer.id];return this;}/**
     * @private
     * recognizer can only run when an other is failing
     * @param {Recognizer} otherRecognizer
     * @returns {Recognizer} this
     */},{key:'requireFailure',value:function requireFailure(otherRecognizer){if(invokeArrayArg(otherRecognizer,'requireFailure',this)){return this;}var requireFail=this.requireFail;otherRecognizer=getRecognizerByNameIfManager(otherRecognizer,this);if(inArray(requireFail,otherRecognizer)===-1){requireFail.push(otherRecognizer);otherRecognizer.requireFailure(this);}return this;}/**
     * @private
     * drop the requireFailure link. it does not remove the link on the other recognizer.
     * @param {Recognizer} otherRecognizer
     * @returns {Recognizer} this
     */},{key:'dropRequireFailure',value:function dropRequireFailure(otherRecognizer){if(invokeArrayArg(otherRecognizer,'dropRequireFailure',this)){return this;}otherRecognizer=getRecognizerByNameIfManager(otherRecognizer,this);var index=inArray(this.requireFail,otherRecognizer);if(index>-1){this.requireFail.splice(index,1);}return this;}/**
     * @private
     * has require failures boolean
     * @returns {boolean}
     */},{key:'hasRequireFailures',value:function hasRequireFailures(){return this.requireFail.length>0;}/**
     * @private
     * if the recognizer can recognize simultaneous with an other recognizer
     * @param {Recognizer} otherRecognizer
     * @returns {Boolean}
     */},{key:'canRecognizeWith',value:function canRecognizeWith(otherRecognizer){return!!this.simultaneous[otherRecognizer.id];}/**
     * @private
     * You should use `tryEmit` instead of `emit` directly to check
     * that all the needed recognizers has failed before emitting.
     * @param {Object} input
     */},{key:'emit',value:function emit(input){var self=this;var state=this.state;function emit(event){self.manager.emit(event,input);}// 'panstart' and 'panmove'
if(state<STATE_ENDED){emit(self.options.event+stateStr(state));}emit(self.options.event);// simple 'eventName' events
if(input.additionalEvent){// additional event(panleft, panright, pinchin, pinchout...)
emit(input.additionalEvent);}// panend and pancancel
if(state>=STATE_ENDED){emit(self.options.event+stateStr(state));}}/**
     * @private
     * Check that all the require failure recognizers has failed,
     * if true, it emits a gesture event,
     * otherwise, setup the state to FAILED.
     * @param {Object} input
     */},{key:'tryEmit',value:function tryEmit(input){if(this.canEmit()){return this.emit(input);}// it's failing anyway
this.state=STATE_FAILED;}/**
     * @private
     * can we emit?
     * @returns {boolean}
     */},{key:'canEmit',value:function canEmit(){var i=0;while(i<this.requireFail.length){if(!(this.requireFail[i].state&(STATE_FAILED|STATE_POSSIBLE))){return false;}i++;}return true;}/**
     * @private
     * update the recognizer
     * @param {Object} inputData
     */},{key:'recognize',value:function recognize(inputData){// make a new copy of the inputData
// so we can change the inputData without messing up the other recognizers
var inputDataClone=assign$1({},inputData);// is is enabled and allow recognizing?
if(!boolOrFn(this.options.enable,[this,inputDataClone])){this.reset();this.state=STATE_FAILED;return;}// reset when we've reached the end
if(this.state&(STATE_RECOGNIZED|STATE_CANCELLED|STATE_FAILED)){this.state=STATE_POSSIBLE;}this.state=this.process(inputDataClone);// the recognizer has recognized a gesture
// so trigger an event
if(this.state&(STATE_BEGAN|STATE_CHANGED|STATE_ENDED|STATE_CANCELLED)){this.tryEmit(inputDataClone);}}/**
     * @private
     * return the state of the recognizer
     * the actual recognizing happens in this method
     * @virtual
     * @param {Object} inputData
     * @returns {constant} STATE
     */ /* jshint ignore:start */},{key:'process',value:function process(inputData){}/* jshint ignore:end */ /**
     * @private
     * return the preferred touch-action
     * @virtual
     * @returns {Array}
     */},{key:'getTouchAction',value:function getTouchAction(){}/**
     * @private
     * called when the gesture isn't allowed to recognize
     * like when another is being recognized or it is disabled
     * @virtual
     */},{key:'reset',value:function reset(){}}]);return Recognizer;}();Recognizer.prototype.defaults={};/**
 * @private
 * This recognizer is just used as a base for the simple attribute recognizers.
 * @constructor
 * @extends Recognizer
 */var AttrRecognizer=function(_Recognizer){inherits(AttrRecognizer,_Recognizer);function AttrRecognizer(){classCallCheck(this,AttrRecognizer);return possibleConstructorReturn(this,(AttrRecognizer.__proto__||Object.getPrototypeOf(AttrRecognizer)).apply(this,arguments));}/**
   * @private
   * Used to check if it the recognizer receives valid input, like input.distance > 10.
   * @memberof AttrRecognizer
   * @param {Object} input
   * @returns {Boolean} recognized
   */createClass(AttrRecognizer,[{key:'attrTest',value:function attrTest(input){var optionPointers=this.options.pointers;return optionPointers===0||input.pointers.length===optionPointers;}/**
     * @private
     * Process the input and return the state for the recognizer
     * @memberof AttrRecognizer
     * @param {Object} input
     * @returns {*} State
     */},{key:'process',value:function process(input){var state=this.state;var eventType=input.eventType;var isRecognized=state&(STATE_BEGAN|STATE_CHANGED);var isValid=this.attrTest(input);// on cancel input and we've recognized before, return STATE_CANCELLED
if(isRecognized&&(eventType&INPUT_CANCEL||!isValid)){return state|STATE_CANCELLED;}else if(isRecognized||isValid){if(eventType&INPUT_END){return state|STATE_ENDED;}else if(!(state&STATE_BEGAN)){return STATE_BEGAN;}return state|STATE_CHANGED;}return STATE_FAILED;}}]);return AttrRecognizer;}(Recognizer);AttrRecognizer.prototype.defaults={/**
   * @private
   * @type {Number}
   * @default 1
   */pointers:1};/**
 * @private
 * Rotate
 * Recognized when two or more pointer are moving in a circular motion.
 * @constructor
 * @extends AttrRecognizer
 */var RotateRecognizer=function(_AttrRecognizer){inherits(RotateRecognizer,_AttrRecognizer);function RotateRecognizer(){classCallCheck(this,RotateRecognizer);return possibleConstructorReturn(this,(RotateRecognizer.__proto__||Object.getPrototypeOf(RotateRecognizer)).apply(this,arguments));}createClass(RotateRecognizer,[{key:'getTouchAction',value:function getTouchAction(){return[TOUCH_ACTION_NONE];}},{key:'attrTest',value:function attrTest(input){return get(RotateRecognizer.prototype.__proto__||Object.getPrototypeOf(RotateRecognizer.prototype),'attrTest',this).call(this,input)&&(Math.abs(input.rotation)>this.options.threshold||this.state&STATE_BEGAN);}}]);return RotateRecognizer;}(AttrRecognizer);RotateRecognizer.prototype.defaults={event:'rotate',threshold:0,pointers:2};/**
 * @private
 * Pinch
 * Recognized when two or more pointers are moving toward (zoom-in) or away from each other (zoom-out).
 * @constructor
 * @extends AttrRecognizer
 */var PinchRecognizer=function(_AttrRecognizer){inherits(PinchRecognizer,_AttrRecognizer);function PinchRecognizer(){classCallCheck(this,PinchRecognizer);return possibleConstructorReturn(this,(PinchRecognizer.__proto__||Object.getPrototypeOf(PinchRecognizer)).apply(this,arguments));}createClass(PinchRecognizer,[{key:'getTouchAction',value:function getTouchAction(){return[TOUCH_ACTION_NONE];}},{key:'attrTest',value:function attrTest(input){return get(PinchRecognizer.prototype.__proto__||Object.getPrototypeOf(PinchRecognizer.prototype),'attrTest',this).call(this,input)&&(Math.abs(input.scale-1)>this.options.threshold||this.state&STATE_BEGAN);}},{key:'emit',value:function emit(input){if(input.scale!==1){var inOut=input.scale<1?'in':'out';input.additionalEvent=this.options.event+inOut;}get(PinchRecognizer.prototype.__proto__||Object.getPrototypeOf(PinchRecognizer.prototype),'emit',this).call(this,input);}}]);return PinchRecognizer;}(AttrRecognizer);PinchRecognizer.prototype.defaults={event:'pinch',threshold:0,pointers:2};/**
 * @private
 * direction cons to string
 * @param {constant} direction
 * @returns {String}
 */function directionStr(direction){if(direction===DIRECTION_DOWN){return'down';}else if(direction===DIRECTION_UP){return'up';}else if(direction===DIRECTION_LEFT){return'left';}else if(direction===DIRECTION_RIGHT){return'right';}return'';}/**
 * @private
 * Pan
 * Recognized when the pointer is down and moved in the allowed direction.
 * @constructor
 * @extends AttrRecognizer
 */var PanRecognizer=function(_AttrRecognizer){inherits(PanRecognizer,_AttrRecognizer);function PanRecognizer(){classCallCheck(this,PanRecognizer);var _this=possibleConstructorReturn(this,(PanRecognizer.__proto__||Object.getPrototypeOf(PanRecognizer)).apply(this,arguments));_this.pX=null;_this.pY=null;return _this;}createClass(PanRecognizer,[{key:'getTouchAction',value:function getTouchAction(){var direction=this.options.direction;var actions=[];if(direction&DIRECTION_HORIZONTAL){actions.push(TOUCH_ACTION_PAN_Y);}if(direction&DIRECTION_VERTICAL){actions.push(TOUCH_ACTION_PAN_X);}return actions;}},{key:'directionTest',value:function directionTest(input){var options=this.options;var hasMoved=true;var distance=input.distance;var direction=input.direction;var x=input.deltaX;var y=input.deltaY;// lock to axis?
if(!(direction&options.direction)){if(options.direction&DIRECTION_HORIZONTAL){direction=x===0?DIRECTION_NONE:x<0?DIRECTION_LEFT:DIRECTION_RIGHT;hasMoved=x!==this.pX;distance=Math.abs(input.deltaX);}else{direction=y===0?DIRECTION_NONE:y<0?DIRECTION_UP:DIRECTION_DOWN;hasMoved=y!==this.pY;distance=Math.abs(input.deltaY);}}input.direction=direction;return hasMoved&&distance>options.threshold&&direction&options.direction;}},{key:'attrTest',value:function attrTest(input){return AttrRecognizer.prototype.attrTest.call(this,input)&&(// replace with a super call
this.state&STATE_BEGAN||!(this.state&STATE_BEGAN)&&this.directionTest(input));}},{key:'emit',value:function emit(input){this.pX=input.deltaX;this.pY=input.deltaY;var direction=directionStr(input.direction);if(direction){input.additionalEvent=this.options.event+direction;}get(PanRecognizer.prototype.__proto__||Object.getPrototypeOf(PanRecognizer.prototype),'emit',this).call(this,input);}}]);return PanRecognizer;}(AttrRecognizer);PanRecognizer.prototype.defaults={event:'pan',threshold:10,pointers:1,direction:DIRECTION_ALL};/**
 * @private
 * Swipe
 * Recognized when the pointer is moving fast (velocity), with enough distance in the allowed direction.
 * @constructor
 * @extends AttrRecognizer
 */var SwipeRecognizer=function(_AttrRecognizer){inherits(SwipeRecognizer,_AttrRecognizer);function SwipeRecognizer(){classCallCheck(this,SwipeRecognizer);return possibleConstructorReturn(this,(SwipeRecognizer.__proto__||Object.getPrototypeOf(SwipeRecognizer)).apply(this,arguments));}createClass(SwipeRecognizer,[{key:'getTouchAction',value:function getTouchAction(){return PanRecognizer.prototype.getTouchAction.call(this);}},{key:'attrTest',value:function attrTest(input){var direction=this.options.direction;var velocity=void 0;if(direction&(DIRECTION_HORIZONTAL|DIRECTION_VERTICAL)){velocity=input.overallVelocity;}else if(direction&DIRECTION_HORIZONTAL){velocity=input.overallVelocityX;}else if(direction&DIRECTION_VERTICAL){velocity=input.overallVelocityY;}return get(SwipeRecognizer.prototype.__proto__||Object.getPrototypeOf(SwipeRecognizer.prototype),'attrTest',this).call(this,input)&&direction&input.offsetDirection&&input.distance>this.options.threshold&&input.maxPointers===this.options.pointers&&abs(velocity)>this.options.velocity&&input.eventType&INPUT_END;}},{key:'emit',value:function emit(input){var direction=directionStr(input.offsetDirection);if(direction){this.manager.emit(this.options.event+direction,input);}this.manager.emit(this.options.event,input);}}]);return SwipeRecognizer;}(AttrRecognizer);SwipeRecognizer.prototype.defaults={event:'swipe',threshold:10,velocity:0.3,direction:DIRECTION_HORIZONTAL|DIRECTION_VERTICAL,pointers:1};/**
 * @private
 * simple function bind
 * @param {Function} fn
 * @param {Object} context
 * @returns {Function}
 */function bindFn(fn,context){return function boundFn(){return fn.apply(context,arguments);};}/**
 * @private
 * set a timeout with a given scope
 * @param {Function} fn
 * @param {Number} timeout
 * @param {Object} context
 * @returns {number}
 */function setTimeoutContext(fn,timeout,context){return setTimeout(bindFn(fn,context),timeout);}/**
 * @private
 * calculate the absolute distance between two points
 * @param {Object} p1 {x, y}
 * @param {Object} p2 {x, y}
 * @param {Array} [props] containing x and y keys
 * @return {Number} distance
 */function getDistance(p1,p2,props){if(!props){props=PROPS_XY;}var x=p2[props[0]]-p1[props[0]];var y=p2[props[1]]-p1[props[1]];return Math.sqrt(x*x+y*y);}/**
 * @private
 * A tap is recognized when the pointer is doing a small tap/click. Multiple taps are recognized if they occur
 * between the given interval and position. The delay option can be used to recognize multi-taps without firing
 * a single tap.
 *
 * The eventData from the emitted event contains the property `tapCount`, which contains the amount of
 * multi-taps being recognized.
 * @constructor
 * @extends Recognizer
 */var TapRecognizer=function(_Recognizer){inherits(TapRecognizer,_Recognizer);function TapRecognizer(){classCallCheck(this,TapRecognizer);// previous time and center,
// used for tap counting
var _this=possibleConstructorReturn(this,(TapRecognizer.__proto__||Object.getPrototypeOf(TapRecognizer)).apply(this,arguments));_this.pTime=false;_this.pCenter=false;_this._timer=null;_this._input=null;_this.count=0;return _this;}createClass(TapRecognizer,[{key:'getTouchAction',value:function getTouchAction(){return[TOUCH_ACTION_MANIPULATION];}},{key:'process',value:function process(input){var _this2=this;var options=this.options;var validPointers=input.pointers.length===options.pointers;var validMovement=input.distance<options.threshold;var validTouchTime=input.deltaTime<options.time;this.reset();if(input.eventType&INPUT_START&&this.count===0){return this.failTimeout();}// we only allow little movement
// and we've reached an end event, so a tap is possible
if(validMovement&&validTouchTime&&validPointers){if(input.eventType!==INPUT_END){return this.failTimeout();}var validInterval=this.pTime?input.timeStamp-this.pTime<options.interval:true;var validMultiTap=!this.pCenter||getDistance(this.pCenter,input.center)<options.posThreshold;this.pTime=input.timeStamp;this.pCenter=input.center;if(!validMultiTap||!validInterval){this.count=1;}else{this.count+=1;}this._input=input;// if tap count matches we have recognized it,
// else it has began recognizing...
var tapCount=this.count%options.taps;if(tapCount===0){// no failing requirements, immediately trigger the tap event
// or wait as long as the multitap interval to trigger
if(!this.hasRequireFailures()){return STATE_RECOGNIZED;}else{this._timer=setTimeoutContext(function(){_this2.state=STATE_RECOGNIZED;_this2.tryEmit();},options.interval,this);return STATE_BEGAN;}}}return STATE_FAILED;}},{key:'failTimeout',value:function failTimeout(){var _this3=this;this._timer=setTimeoutContext(function(){_this3.state=STATE_FAILED;},this.options.interval,this);return STATE_FAILED;}},{key:'reset',value:function reset(){clearTimeout(this._timer);}},{key:'emit',value:function emit(){if(this.state===STATE_RECOGNIZED){this._input.tapCount=this.count;this.manager.emit(this.options.event,this._input);}}}]);return TapRecognizer;}(Recognizer);TapRecognizer.prototype.defaults={event:'tap',pointers:1,taps:1,interval:300,// max time between the multi-tap taps
time:250,// max time of the pointer to be down (like finger on the screen)
threshold:9,// a minimal movement is ok, but keep it low
posThreshold:10// a multi-tap can be a bit off the initial position
};/**
 * @private
 * Press
 * Recognized when the pointer is down for x ms without any movement.
 * @constructor
 * @extends Recognizer
 */var PressRecognizer=function(_Recognizer){inherits(PressRecognizer,_Recognizer);function PressRecognizer(){classCallCheck(this,PressRecognizer);var _this=possibleConstructorReturn(this,(PressRecognizer.__proto__||Object.getPrototypeOf(PressRecognizer)).apply(this,arguments));_this._timer=null;_this._input=null;return _this;}createClass(PressRecognizer,[{key:'getTouchAction',value:function getTouchAction(){return[TOUCH_ACTION_AUTO];}},{key:'process',value:function process(input){var _this2=this;var options=this.options;var validPointers=input.pointers.length===options.pointers;var validMovement=input.distance<options.threshold;var validTime=input.deltaTime>options.time;this._input=input;// we only allow little movement
// and we've reached an end event, so a tap is possible
if(!validMovement||!validPointers||input.eventType&(INPUT_END|INPUT_CANCEL)&&!validTime){this.reset();}else if(input.eventType&INPUT_START){this.reset();this._timer=setTimeoutContext(function(){_this2.state=STATE_RECOGNIZED;_this2.tryEmit();},options.time,this);}else if(input.eventType&INPUT_END){return STATE_RECOGNIZED;}return STATE_FAILED;}},{key:'reset',value:function reset(){clearTimeout(this._timer);}},{key:'emit',value:function emit(input){if(this.state!==STATE_RECOGNIZED){return;}if(input&&input.eventType&INPUT_END){this.manager.emit(this.options.event+'up',input);}else{this._input.timeStamp=now();this.manager.emit(this.options.event,this._input);}}}]);return PressRecognizer;}(Recognizer);PressRecognizer.prototype.defaults={event:'press',pointers:1,time:251,// minimal time of the pointer to be pressed
threshold:9// a minimal movement is ok, but keep it low
};/**
 * @private
 * small indexOf wrapper
 * @param {String} str
 * @param {String} find
 * @returns {Boolean} found
 */function inStr(str,find){return str.indexOf(find)>-1;}/**
 * @private
 * when the touchActions are collected they are not a valid value, so we need to clean things up. *
 * @param {String} actions
 * @returns {*}
 */function cleanTouchActions(actions){// none
if(inStr(actions,TOUCH_ACTION_NONE)){return TOUCH_ACTION_NONE;}var hasPanX=inStr(actions,TOUCH_ACTION_PAN_X);var hasPanY=inStr(actions,TOUCH_ACTION_PAN_Y);// if both pan-x and pan-y are set (different recognizers
// for different directions, e.g. horizontal pan but vertical swipe?)
// we need none (as otherwise with pan-x pan-y combined none of these
// recognizers will work, since the browser would handle all panning
if(hasPanX&&hasPanY){return TOUCH_ACTION_NONE;}// pan-x OR pan-y
if(hasPanX||hasPanY){return hasPanX?TOUCH_ACTION_PAN_X:TOUCH_ACTION_PAN_Y;}// manipulation
if(inStr(actions,TOUCH_ACTION_MANIPULATION)){return TOUCH_ACTION_MANIPULATION;}return TOUCH_ACTION_AUTO;}/**
 * @private
 * Touch Action
 * sets the touchAction property or uses the js alternative
 * @param {Manager} manager
 * @param {String} value
 * @constructor
 */var TouchAction=function(){function TouchAction(manager,value){classCallCheck(this,TouchAction);this.manager=manager;this.set(value);}/**
   * @private
   * set the touchAction value on the element or enable the polyfill
   * @param {String} value
   */createClass(TouchAction,[{key:'set',value:function set(value){// find out the touch-action by the event handlers
if(value===TOUCH_ACTION_COMPUTE){value=this.compute();}if(NATIVE_TOUCH_ACTION&&this.manager.element.style&&TOUCH_ACTION_MAP[value]){this.manager.element.style[PREFIXED_TOUCH_ACTION]=value;}this.actions=value.toLowerCase().trim();}/**
     * @private
     * just re-set the touchAction value
     */},{key:'update',value:function update(){this.set(this.manager.options.touchAction);}/**
     * @private
     * compute the value for the touchAction property based on the recognizer's settings
     * @returns {String} value
     */},{key:'compute',value:function compute(){var actions=[];each(this.manager.recognizers,function(recognizer){if(boolOrFn(recognizer.options.enable,[recognizer])){actions=actions.concat(recognizer.getTouchAction());}});return cleanTouchActions(actions.join(' '));}/**
     * @private
     * this method is called on each input cycle and provides the preventing of the browser behavior
     * @param {Object} input
     */},{key:'preventDefaults',value:function preventDefaults(input){var srcEvent=input.srcEvent;var direction=input.offsetDirection;// if the touch action did prevented once this session
if(this.manager.session.prevented){srcEvent.preventDefault();return;}var actions=this.actions;var hasNone=inStr(actions,TOUCH_ACTION_NONE)&&!TOUCH_ACTION_MAP[TOUCH_ACTION_NONE];var hasPanY=inStr(actions,TOUCH_ACTION_PAN_Y)&&!TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_Y];var hasPanX=inStr(actions,TOUCH_ACTION_PAN_X)&&!TOUCH_ACTION_MAP[TOUCH_ACTION_PAN_X];if(hasNone){// do not prevent defaults if this is a tap gesture
var isTapPointer=input.pointers.length===1;var isTapMovement=input.distance<2;var isTapTouchTime=input.deltaTime<250;if(isTapPointer&&isTapMovement&&isTapTouchTime){return;}}if(hasPanX&&hasPanY){// `pan-x pan-y` means browser handles all scrolling/panning, do not prevent
return;}if(hasNone||hasPanY&&direction&DIRECTION_HORIZONTAL||hasPanX&&direction&DIRECTION_VERTICAL){return this.preventSrc(srcEvent);}}/**
     * @private
     * call preventDefault to prevent the browser's default behavior (scrolling in most cases)
     * @param {Object} srcEvent
     */},{key:'preventSrc',value:function preventSrc(srcEvent){this.manager.session.prevented=true;srcEvent.preventDefault();}}]);return TouchAction;}();/**
 * @private
 * find if a node is in the given parent
 * @method hasParent
 * @param {HTMLElement} node
 * @param {HTMLElement} parent
 * @return {Boolean} found
 */function hasParent(node,parent){while(node){if(node===parent){return true;}node=node.parentNode;}return false;}/**
 * @private
 * get the center of all the pointers
 * @param {Array} pointers
 * @return {Object} center contains `x` and `y` properties
 */function getCenter(pointers){var pointersLength=pointers.length;// no need to loop when only one touch
if(pointersLength===1){return{x:round(pointers[0].clientX),y:round(pointers[0].clientY)};}var x=0;var y=0;var i=0;while(i<pointersLength){x+=pointers[i].clientX;y+=pointers[i].clientY;i++;}return{x:round(x/pointersLength),y:round(y/pointersLength)};}/**
 * @private
 * create a simple clone from the input used for storage of firstInput and firstMultiple
 * @param {Object} input
 * @returns {Object} clonedInputData
 */function simpleCloneInputData(input){// make a simple copy of the pointers because we will get a reference if we don't
// we only need clientXY for the calculations
var pointers=[];var i=0;while(i<input.pointers.length){pointers[i]={clientX:round(input.pointers[i].clientX),clientY:round(input.pointers[i].clientY)};i++;}return{timeStamp:now(),pointers:pointers,center:getCenter(pointers),deltaX:input.deltaX,deltaY:input.deltaY};}/**
 * @private
 * calculate the angle between two coordinates
 * @param {Object} p1
 * @param {Object} p2
 * @param {Array} [props] containing x and y keys
 * @return {Number} angle
 */function getAngle(p1,p2,props){if(!props){props=PROPS_XY;}var x=p2[props[0]]-p1[props[0]];var y=p2[props[1]]-p1[props[1]];return Math.atan2(y,x)*180/Math.PI;}/**
 * @private
 * get the direction between two points
 * @param {Number} x
 * @param {Number} y
 * @return {Number} direction
 */function getDirection(x,y){if(x===y){return DIRECTION_NONE;}if(abs(x)>=abs(y)){return x<0?DIRECTION_LEFT:DIRECTION_RIGHT;}return y<0?DIRECTION_UP:DIRECTION_DOWN;}function computeDeltaXY(session,input){var center=input.center;// let { offsetDelta:offset = {}, prevDelta = {}, prevInput = {} } = session;
// jscs throwing error on defalut destructured values and without defaults tests fail
var offset=session.offsetDelta||{};var prevDelta=session.prevDelta||{};var prevInput=session.prevInput||{};if(input.eventType===INPUT_START||prevInput.eventType===INPUT_END){prevDelta=session.prevDelta={x:prevInput.deltaX||0,y:prevInput.deltaY||0};offset=session.offsetDelta={x:center.x,y:center.y};}input.deltaX=prevDelta.x+(center.x-offset.x);input.deltaY=prevDelta.y+(center.y-offset.y);}/**
 * @private
 * calculate the velocity between two points. unit is in px per ms.
 * @param {Number} deltaTime
 * @param {Number} x
 * @param {Number} y
 * @return {Object} velocity `x` and `y`
 */function getVelocity(deltaTime,x,y){return{x:x/deltaTime||0,y:y/deltaTime||0};}/**
 * @private
 * calculate the scale factor between two pointersets
 * no scale is 1, and goes down to 0 when pinched together, and bigger when pinched out
 * @param {Array} start array of pointers
 * @param {Array} end array of pointers
 * @return {Number} scale
 */function getScale(start,end){return getDistance(end[0],end[1],PROPS_CLIENT_XY)/getDistance(start[0],start[1],PROPS_CLIENT_XY);}/**
 * @private
 * calculate the rotation degrees between two pointersets
 * @param {Array} start array of pointers
 * @param {Array} end array of pointers
 * @return {Number} rotation
 */function getRotation(start,end){return getAngle(end[1],end[0],PROPS_CLIENT_XY)+getAngle(start[1],start[0],PROPS_CLIENT_XY);}/**
 * @private
 * velocity is calculated every x ms
 * @param {Object} session
 * @param {Object} input
 */function computeIntervalInputData(session,input){var last=session.lastInterval||input;var deltaTime=input.timeStamp-last.timeStamp;var velocity=void 0;var velocityX=void 0;var velocityY=void 0;var direction=void 0;if(input.eventType!==INPUT_CANCEL&&(deltaTime>COMPUTE_INTERVAL||last.velocity===undefined)){var deltaX=input.deltaX-last.deltaX;var deltaY=input.deltaY-last.deltaY;var v=getVelocity(deltaTime,deltaX,deltaY);velocityX=v.x;velocityY=v.y;velocity=abs(v.x)>abs(v.y)?v.x:v.y;direction=getDirection(deltaX,deltaY);session.lastInterval=input;}else{// use latest velocity info if it doesn't overtake a minimum period
velocity=last.velocity;velocityX=last.velocityX;velocityY=last.velocityY;direction=last.direction;}input.velocity=velocity;input.velocityX=velocityX;input.velocityY=velocityY;input.direction=direction;}/**
* @private
 * extend the data with some usable properties like scale, rotate, velocity etc
 * @param {Object} manager
 * @param {Object} input
 */function computeInputData(manager,input){var session=manager.session;var pointers=input.pointers;var pointersLength=pointers.length;// store the first input to calculate the distance and direction
if(!session.firstInput){session.firstInput=simpleCloneInputData(input);}// to compute scale and rotation we need to store the multiple touches
if(pointersLength>1&&!session.firstMultiple){session.firstMultiple=simpleCloneInputData(input);}else if(pointersLength===1){session.firstMultiple=false;}var firstInput=session.firstInput;var firstMultiple=session.firstMultiple;var offsetCenter=firstMultiple?firstMultiple.center:firstInput.center;var center=input.center=getCenter(pointers);input.timeStamp=now();input.deltaTime=input.timeStamp-firstInput.timeStamp;input.angle=getAngle(offsetCenter,center);input.distance=getDistance(offsetCenter,center);computeDeltaXY(session,input);input.offsetDirection=getDirection(input.deltaX,input.deltaY);var overallVelocity=getVelocity(input.deltaTime,input.deltaX,input.deltaY);input.overallVelocityX=overallVelocity.x;input.overallVelocityY=overallVelocity.y;input.overallVelocity=abs(overallVelocity.x)>abs(overallVelocity.y)?overallVelocity.x:overallVelocity.y;input.scale=firstMultiple?getScale(firstMultiple.pointers,pointers):1;input.rotation=firstMultiple?getRotation(firstMultiple.pointers,pointers):0;input.maxPointers=!session.prevInput?input.pointers.length:input.pointers.length>session.prevInput.maxPointers?input.pointers.length:session.prevInput.maxPointers;computeIntervalInputData(session,input);// find the correct target
var target=manager.element;if(hasParent(input.srcEvent.target,target)){target=input.srcEvent.target;}input.target=target;}/**
 * @private
 * handle input events
 * @param {Manager} manager
 * @param {String} eventType
 * @param {Object} input
 */function inputHandler(manager,eventType,input){var pointersLen=input.pointers.length;var changedPointersLen=input.changedPointers.length;var isFirst=eventType&INPUT_START&&pointersLen-changedPointersLen===0;var isFinal=eventType&(INPUT_END|INPUT_CANCEL)&&pointersLen-changedPointersLen===0;input.isFirst=!!isFirst;input.isFinal=!!isFinal;if(isFirst){manager.session={};}// source event is the normalized value of the domEvents
// like 'touchstart, mouseup, pointerdown'
input.eventType=eventType;// compute scale, rotation etc
computeInputData(manager,input);// emit secret event
manager.emit('hammer.input',input);manager.recognize(input);manager.session.prevInput=input;}/**
 * @private
 * split string on whitespace
 * @param {String} str
 * @returns {Array} words
 */function splitStr(str){return str.trim().split(/\s+/g);}/**
 * @private
 * addEventListener with multiple events at once
 * @param {EventTarget} target
 * @param {String} types
 * @param {Function} handler
 */function addEventListeners(target,types,handler){each(splitStr(types),function(type){target.addEventListener(type,handler,false);});}/**
 * @private
 * removeEventListener with multiple events at once
 * @param {EventTarget} target
 * @param {String} types
 * @param {Function} handler
 */function removeEventListeners(target,types,handler){each(splitStr(types),function(type){target.removeEventListener(type,handler,false);});}/**
 * @private
 * get the window object of an element
 * @param {HTMLElement} element
 * @returns {DocumentView|Window}
 */function getWindowForElement(element){var doc=element.ownerDocument||element;return doc.defaultView||doc.parentWindow||window;}/**
 * @private
 * create new input type manager
 * @param {Manager} manager
 * @param {Function} callback
 * @returns {Input}
 * @constructor
 */var Input=function(){function Input(manager,callback){classCallCheck(this,Input);var self=this;this.manager=manager;this.callback=callback;this.element=manager.element;this.target=manager.options.inputTarget;// smaller wrapper around the handler, for the scope and the enabled state of the manager,
// so when disabled the input events are completely bypassed.
this.domHandler=function(ev){if(boolOrFn(manager.options.enable,[manager])){self.handler(ev);}};this.init();}/**
   * @private
   * should handle the inputEvent data and trigger the callback
   * @virtual
   */createClass(Input,[{key:'handler',value:function handler(){}/**
     * @private
     * bind the events
     */},{key:'init',value:function init(){this.evEl&&addEventListeners(this.element,this.evEl,this.domHandler);this.evTarget&&addEventListeners(this.target,this.evTarget,this.domHandler);this.evWin&&addEventListeners(getWindowForElement(this.element),this.evWin,this.domHandler);}/**
     * @private
     * unbind the events
     */},{key:'destroy',value:function destroy(){this.evEl&&removeEventListeners(this.element,this.evEl,this.domHandler);this.evTarget&&removeEventListeners(this.target,this.evTarget,this.domHandler);this.evWin&&removeEventListeners(getWindowForElement(this.element),this.evWin,this.domHandler);}}]);return Input;}();var POINTER_INPUT_MAP={pointerdown:INPUT_START,pointermove:INPUT_MOVE,pointerup:INPUT_END,pointercancel:INPUT_CANCEL,pointerout:INPUT_CANCEL};// in IE10 the pointer types is defined as an enum
var IE10_POINTER_TYPE_ENUM={2:INPUT_TYPE_TOUCH,3:INPUT_TYPE_PEN,4:INPUT_TYPE_MOUSE,5:INPUT_TYPE_KINECT// see https://twitter.com/jacobrossi/status/480596438489890816
};var POINTER_ELEMENT_EVENTS='pointerdown';var POINTER_WINDOW_EVENTS='pointermove pointerup pointercancel';// IE10 has prefixed support, and case-sensitive
if(window.MSPointerEvent&&!window.PointerEvent){POINTER_ELEMENT_EVENTS='MSPointerDown';POINTER_WINDOW_EVENTS='MSPointerMove MSPointerUp MSPointerCancel';}/**
 * @private
 * Pointer events input
 * @constructor
 * @extends Input
 */var PointerEventInput=function(_Input){inherits(PointerEventInput,_Input);function PointerEventInput(){classCallCheck(this,PointerEventInput);var _this=possibleConstructorReturn(this,(PointerEventInput.__proto__||Object.getPrototypeOf(PointerEventInput)).apply(this,arguments));_this.evEl=POINTER_ELEMENT_EVENTS;_this.evWin=POINTER_WINDOW_EVENTS;_this.init();_this.store=_this.manager.session.pointerEvents=[];return _this;}/**
   * @private
   * handle mouse events
   * @param {Object} ev
   */createClass(PointerEventInput,[{key:'handler',value:function handler(ev){var store=this.store;var removePointer=false;var eventTypeNormalized=ev.type.toLowerCase().replace('ms','');var eventType=POINTER_INPUT_MAP[eventTypeNormalized];var pointerType=IE10_POINTER_TYPE_ENUM[ev.pointerType]||ev.pointerType;var isTouch=pointerType===INPUT_TYPE_TOUCH;// get index of the event in the store
var storeIndex=inArray(store,ev.pointerId,'pointerId');// start and mouse must be down
if(eventType&INPUT_START&&(ev.button===0||isTouch)){if(storeIndex<0){store.push(ev);storeIndex=store.length-1;}}else if(eventType&(INPUT_END|INPUT_CANCEL)){removePointer=true;}// it not found, so the pointer hasn't been down (so it's probably a hover)
if(storeIndex<0){return;}// update the event in the store
store[storeIndex]=ev;this.callback(this.manager,eventType,{pointers:store,changedPointers:[ev],pointerType:pointerType,srcEvent:ev});if(removePointer){// remove from the store
store.splice(storeIndex,1);}}}]);return PointerEventInput;}(Input);/**
 * @private
 * convert array-like objects to real arrays
 * @param {Object} obj
 * @returns {Array}
 */function toArray$1(obj){return Array.prototype.slice.call(obj,0);}/**
 * @private
 * unique array with objects based on a key (like 'id') or just by the array's value
 * @param {Array} src [{id:1},{id:2},{id:1}]
 * @param {String} [key]
 * @param {Boolean} [sort=False]
 * @returns {Array} [{id:1},{id:2}]
 */function uniqueArray(src,key,sort){var results=[];var values=[];var i=0;while(i<src.length){var val=key?src[i][key]:src[i];if(inArray(values,val)<0){results.push(src[i]);}values[i]=val;i++;}if(sort){if(!key){results=results.sort();}else{results=results.sort(function(a,b){return a[key]>b[key];});}}return results;}var TOUCH_INPUT_MAP={touchstart:INPUT_START,touchmove:INPUT_MOVE,touchend:INPUT_END,touchcancel:INPUT_CANCEL};var TOUCH_TARGET_EVENTS='touchstart touchmove touchend touchcancel';/**
 * @private
 * Multi-user touch events input
 * @constructor
 * @extends Input
 */var TouchInput=function(_Input){inherits(TouchInput,_Input);function TouchInput(){classCallCheck(this,TouchInput);TouchInput.prototype.evTarget=TOUCH_TARGET_EVENTS;TouchInput.prototype.targetIds={};var _this=possibleConstructorReturn(this,(TouchInput.__proto__||Object.getPrototypeOf(TouchInput)).apply(this,arguments));_this.evTarget=TOUCH_TARGET_EVENTS;_this.targetIds={};_this.init();return _this;}createClass(TouchInput,[{key:'handler',value:function handler(ev){var type=TOUCH_INPUT_MAP[ev.type];var touches=getTouches.call(this,ev,type);if(!touches){return;}this.callback(this.manager,type,{pointers:touches[0],changedPointers:touches[1],pointerType:INPUT_TYPE_TOUCH,srcEvent:ev});}}]);return TouchInput;}(Input);function getTouches(ev,type){var allTouches=toArray$1(ev.touches);var targetIds=this.targetIds;// when there is only one touch, the process can be simplified
if(type&(INPUT_START|INPUT_MOVE)&&allTouches.length===1){targetIds[allTouches[0].identifier]=true;return[allTouches,allTouches];}var i=void 0;var targetTouches=void 0;var changedTouches=toArray$1(ev.changedTouches);var changedTargetTouches=[];var target=this.target;// get target touches from touches
targetTouches=allTouches.filter(function(touch){return hasParent(touch.target,target);});// collect touches
if(type===INPUT_START){i=0;while(i<targetTouches.length){targetIds[targetTouches[i].identifier]=true;i++;}}// filter changed touches to only contain touches that exist in the collected target ids
i=0;while(i<changedTouches.length){if(targetIds[changedTouches[i].identifier]){changedTargetTouches.push(changedTouches[i]);}// cleanup removed touches
if(type&(INPUT_END|INPUT_CANCEL)){delete targetIds[changedTouches[i].identifier];}i++;}if(!changedTargetTouches.length){return;}return[// merge targetTouches with changedTargetTouches so it contains ALL touches, including 'end' and 'cancel'
uniqueArray(targetTouches.concat(changedTargetTouches),'identifier',true),changedTargetTouches];}var MOUSE_INPUT_MAP={mousedown:INPUT_START,mousemove:INPUT_MOVE,mouseup:INPUT_END};var MOUSE_ELEMENT_EVENTS='mousedown';var MOUSE_WINDOW_EVENTS='mousemove mouseup';/**
 * @private
 * Mouse events input
 * @constructor
 * @extends Input
 */var MouseInput=function(_Input){inherits(MouseInput,_Input);function MouseInput(){classCallCheck(this,MouseInput);var _this=possibleConstructorReturn(this,(MouseInput.__proto__||Object.getPrototypeOf(MouseInput)).apply(this,arguments));_this.evEl=MOUSE_ELEMENT_EVENTS;_this.evWin=MOUSE_WINDOW_EVENTS;_this.pressed=false;// mousedown state
return _this;}/**
   * @private
   * handle mouse events
   * @param {Object} ev
   */createClass(MouseInput,[{key:'handler',value:function handler(ev){var eventType=MOUSE_INPUT_MAP[ev.type];// on start we want to have the left mouse button down
if(eventType&INPUT_START&&ev.button===0){this.pressed=true;}if(eventType&INPUT_MOVE&&ev.which!==1){eventType=INPUT_END;}// mouse must be down
if(!this.pressed){return;}if(eventType&INPUT_END){this.pressed=false;}this.callback(this.manager,eventType,{pointers:[ev],changedPointers:[ev],pointerType:INPUT_TYPE_MOUSE,srcEvent:ev});}}]);return MouseInput;}(Input);/**
 * @private
 * Combined touch and mouse input
 *
 * Touch has a higher priority then mouse, and while touching no mouse events are allowed.
 * This because touch devices also emit mouse events while doing a touch.
 *
 * @constructor
 * @extends Input
 */var DEDUP_TIMEOUT=2500;var DEDUP_DISTANCE=25;var TouchMouseInput=function(_Input){inherits(TouchMouseInput,_Input);function TouchMouseInput(){classCallCheck(this,TouchMouseInput);var _this=possibleConstructorReturn(this,(TouchMouseInput.__proto__||Object.getPrototypeOf(TouchMouseInput)).apply(this,arguments));var handler=bindFn(_this.handler,_this);_this.touch=new TouchInput(_this.manager,handler);_this.mouse=new MouseInput(_this.manager,handler);_this.primaryTouch=null;_this.lastTouches=[];return _this;}/**
   * @private
   * handle mouse and touch events
   * @param {Hammer} manager
   * @param {String} inputEvent
   * @param {Object} inputData
   */createClass(TouchMouseInput,[{key:'handler',value:function handler(manager,inputEvent,inputData){var isTouch=inputData.pointerType===INPUT_TYPE_TOUCH;var isMouse=inputData.pointerType===INPUT_TYPE_MOUSE;if(isMouse&&inputData.sourceCapabilities&&inputData.sourceCapabilities.firesTouchEvents){return;}// when we're in a touch event, record touches to  de-dupe synthetic mouse event
if(isTouch){recordTouches.call(this,inputEvent,inputData);}else if(isMouse&&isSyntheticEvent.call(this,inputData)){return;}this.callback(manager,inputEvent,inputData);}/**
     * @private
     * remove the event listeners
     */},{key:'destroy',value:function destroy(){this.touch.destroy();this.mouse.destroy();}}]);return TouchMouseInput;}(Input);function recordTouches(eventType,eventData){if(eventType&INPUT_START){this.primaryTouch=eventData.changedPointers[0].identifier;setLastTouch.call(this,eventData);}else if(eventType&(INPUT_END|INPUT_CANCEL)){setLastTouch.call(this,eventData);}}function setLastTouch(eventData){var _this2=this;var _eventData$changedPoi=slicedToArray(eventData.changedPointers,1);var touch=_eventData$changedPoi[0];if(touch.identifier===this.primaryTouch){(function(){var lastTouch={x:touch.clientX,y:touch.clientY};_this2.lastTouches.push(lastTouch);var lts=_this2.lastTouches;var removeLastTouch=function removeLastTouch(){var i=lts.indexOf(lastTouch);if(i>-1){lts.splice(i,1);}};setTimeout(removeLastTouch,DEDUP_TIMEOUT);})();}}function isSyntheticEvent(eventData){var x=eventData.srcEvent.clientX;var y=eventData.srcEvent.clientY;for(var i=0;i<this.lastTouches.length;i++){var t=this.lastTouches[i];var dx=Math.abs(x-t.x);var dy=Math.abs(y-t.y);if(dx<=DEDUP_DISTANCE&&dy<=DEDUP_DISTANCE){return true;}}return false;}/**
 * @private
 * create new input type manager
 * called by the Manager constructor
 * @param {Hammer} manager
 * @returns {Input}
 */function createInputInstance(manager){var Type=void 0;// let inputClass = manager.options.inputClass;
var inputClass=manager.options.inputClass;if(inputClass){Type=inputClass;}else if(SUPPORT_ONLY_TOUCH){Type=TouchInput;}else if(SUPPORT_POINTER_EVENTS){Type=PointerEventInput;}else if(!SUPPORT_TOUCH){Type=MouseInput;}else{Type=TouchMouseInput;}return new Type(manager,inputHandler);}var STOP=1;var FORCED_STOP=2;/**
* @private
 * Manager
 * @param {HTMLElement} element
 * @param {Object} [options]
 * @constructor
 */var Manager=function(){function Manager(element,options){var _this=this;classCallCheck(this,Manager);this.options=assign$1({},Hammer.defaults,options||{});this.options.inputTarget=this.options.inputTarget||element;this.handlers={};this.session={};this.recognizers=[];this.oldCssProps={};this.element=element;this.input=createInputInstance(this);this.touchAction=new TouchAction(this,this.options.touchAction);toggleCssProps(this,true);each(this.options.recognizers,function(item){var recognizer=_this.add(new item[0](item[1]));item[2]&&recognizer.recognizeWith(item[2]);item[3]&&recognizer.requireFailure(item[3]);},this);}/**
   * @private
   * set options
   * @param {Object} options
   * @returns {Manager}
   */createClass(Manager,[{key:'set',value:function set(options){assign$1(this.options,options);// Options that need a little more setup
if(options.touchAction){this.touchAction.update();}if(options.inputTarget){// Clean up existing event listeners and reinitialize
this.input.destroy();this.input.target=options.inputTarget;this.input.init();}return this;}/**
     * @private
     * stop recognizing for this session.
     * This session will be discarded, when a new [input]start event is fired.
     * When forced, the recognizer cycle is stopped immediately.
     * @param {Boolean} [force]
     */},{key:'stop',value:function stop(force){this.session.stopped=force?FORCED_STOP:STOP;}/**
     * @private
     * run the recognizers!
     * called by the inputHandler function on every movement of the pointers (touches)
     * it walks through all the recognizers and tries to detect the gesture that is being made
     * @param {Object} inputData
     */},{key:'recognize',value:function recognize(inputData){var session=this.session;if(session.stopped){return;}// run the touch-action polyfill
this.touchAction.preventDefaults(inputData);var recognizer=void 0;var recognizers=this.recognizers;// this holds the recognizer that is being recognized.
// so the recognizer's state needs to be BEGAN, CHANGED, ENDED or RECOGNIZED
// if no recognizer is detecting a thing, it is set to `null`
var curRecognizer=session.curRecognizer;// reset when the last recognizer is recognized
// or when we're in a new session
if(!curRecognizer||curRecognizer&&curRecognizer.state&STATE_RECOGNIZED){curRecognizer=session.curRecognizer=null;}var i=0;while(i<recognizers.length){recognizer=recognizers[i];// find out if we are allowed try to recognize the input for this one.
// 1.   allow if the session is NOT forced stopped (see the .stop() method)
// 2.   allow if we still haven't recognized a gesture in this session, or the this recognizer is the one
//      that is being recognized.
// 3.   allow if the recognizer is allowed to run simultaneous with the current recognized recognizer.
//      this can be setup with the `recognizeWith()` method on the recognizer.
if(session.stopped!==FORCED_STOP&&(// 1
!curRecognizer||recognizer===curRecognizer||// 2
recognizer.canRecognizeWith(curRecognizer))){// 3
recognizer.recognize(inputData);}else{recognizer.reset();}// if the recognizer has been recognizing the input as a valid gesture, we want to store this one as the
// current active recognizer. but only if we don't already have an active recognizer
if(!curRecognizer&&recognizer.state&(STATE_BEGAN|STATE_CHANGED|STATE_ENDED)){curRecognizer=session.curRecognizer=recognizer;}i++;}}/**
     * @private
     * get a recognizer by its event name.
     * @param {Recognizer|String} recognizer
     * @returns {Recognizer|Null}
     */},{key:'get',value:function get(recognizer){if(recognizer instanceof Recognizer){return recognizer;}var recognizers=this.recognizers;for(var i=0;i<recognizers.length;i++){if(recognizers[i].options.event===recognizer){return recognizers[i];}}return null;}/**
     * @private add a recognizer to the manager
     * existing recognizers with the same event name will be removed
     * @param {Recognizer} recognizer
     * @returns {Recognizer|Manager}
     */},{key:'add',value:function add(recognizer){if(invokeArrayArg(recognizer,'add',this)){return this;}// remove existing
var existing=this.get(recognizer.options.event);if(existing){this.remove(existing);}this.recognizers.push(recognizer);recognizer.manager=this;this.touchAction.update();return recognizer;}/**
     * @private
     * remove a recognizer by name or instance
     * @param {Recognizer|String} recognizer
     * @returns {Manager}
     */},{key:'remove',value:function remove(recognizer){if(invokeArrayArg(recognizer,'remove',this)){return this;}recognizer=this.get(recognizer);// let's make sure this recognizer exists
if(recognizer){var recognizers=this.recognizers;var index=inArray(recognizers,recognizer);if(index!==-1){recognizers.splice(index,1);this.touchAction.update();}}return this;}/**
     * @private
     * bind event
     * @param {String} events
     * @param {Function} handler
     * @returns {EventEmitter} this
     */},{key:'on',value:function on(events,handler){if(events===undefined){return;}if(handler===undefined){return;}var handlers=this.handlers;each(splitStr(events),function(event){handlers[event]=handlers[event]||[];handlers[event].push(handler);});return this;}/**
     * @private unbind event, leave emit blank to remove all handlers
     * @param {String} events
     * @param {Function} [handler]
     * @returns {EventEmitter} this
     */},{key:'off',value:function off(events,handler){if(events===undefined){return;}var handlers=this.handlers;each(splitStr(events),function(event){if(!handler){delete handlers[event];}else{handlers[event]&&handlers[event].splice(inArray(handlers[event],handler),1);}});return this;}/**
     * @private emit event to the listeners
     * @param {String} event
     * @param {Object} data
     */},{key:'emit',value:function emit(event,data){// we also want to trigger dom events
if(this.options.domEvents){triggerDomEvent(event,data);}// no handlers, so skip it all
var handlers=this.handlers[event]&&this.handlers[event].slice();if(!handlers||!handlers.length){return;}data.type=event;data.preventDefault=function(){data.srcEvent.preventDefault();};var i=0;while(i<handlers.length){handlers[i](data);i++;}}/**
     * @private
     * destroy the manager and unbinds all events
     * it doesn't unbind dom events, that is the user own responsibility
     */},{key:'destroy',value:function destroy(){this.element&&toggleCssProps(this,false);this.handlers={};this.session={};this.input.destroy();this.element=null;}}]);return Manager;}();function toggleCssProps(manager,add){var element=manager.element;if(!element.style){return;}var prop=void 0;each(manager.options.cssProps,function(value,name){prop=prefixed(element.style,name);if(add){manager.oldCssProps[prop]=element.style[prop];element.style[prop]=value;}else{element.style[prop]=manager.oldCssProps[prop]||'';}});if(!add){manager.oldCssProps={};}}/**
 * @private
 * trigger dom event
 * @param {String} event
 * @param {Object} data
 */function triggerDomEvent(event,data){var gestureEvent=document.createEvent('Event');gestureEvent.initEvent(event,true,true);gestureEvent.gesture=data;data.target.dispatchEvent(gestureEvent);}/**
 * @private
 * Simple way to create a manager with a default set of recognizers.
 * @param {HTMLElement} element
 * @param {Object} [options]
 * @constructor
 */var Hammer=function Hammer(element,options){classCallCheck(this,Hammer);options=options||{};options.recognizers=ifUndefined(options.recognizers,Hammer.defaults.preset);return new Manager(element,options);};Hammer.VERSION='2.0.8';/**
 * @private
 * default settings
 * @namespace
 */Hammer.defaults={/**
   * @private
   * set if DOM events are being triggered.
   * But this is slower and unused by simple implementations, so disabled by default.
   * @type {Boolean}
   * @default false
   */domEvents:false,/**
   * @private
   * The value for the touchAction property/fallback.
   * When set to `compute` it will magically set the correct value based on the added recognizers.
   * @type {String}
   * @default compute
   */touchAction:TOUCH_ACTION_COMPUTE,/**
   * @private
   * @type {Boolean}
   * @default true
   */enable:true,/**
   * @private
   * EXPERIMENTAL FEATURE -- can be removed/changed
   * Change the parent input target element.
   * If Null, then it is being set the to main element.
   * @type {Null|EventTarget}
   * @default null
   */inputTarget:null,/**
   * @private
   * force an input class
   * @type {Null|Function}
   * @default null
   */inputClass:null,/**
   * @private
   * Default recognizer setup when calling `Hammer()`
   * When creating a new Manager these will be skipped.
   * @type {Array}
   */preset:[// RecognizerClass, options, [recognizeWith, ...], [requireFailure, ...]
[RotateRecognizer,{enable:false}],[PinchRecognizer,{enable:false},['rotate']],[SwipeRecognizer,{direction:DIRECTION_HORIZONTAL}],[PanRecognizer,{direction:DIRECTION_HORIZONTAL},['swipe']],[TapRecognizer],[TapRecognizer,{event:'doubletap',taps:2},['tap']],[PressRecognizer]],/**
   * @private
   * Some CSS properties can be used to improve the working of Hammer.
   * Add them to this method and they will be set when creating a new Manager.
   * @namespace
   */cssProps:{/**
     * @private
     * Disables text selection to improve the dragging gesture. Mainly for desktop browsers.
     * @type {String}
     * @default 'none'
     */userSelect:'none',/**
     * @private
     * Disable the Windows Phone grippers when pressing an element.
     * @type {String}
     * @default 'none'
     */touchSelect:'none',/**
     * @private
     * Disables the default callout shown when you touch and hold a touch target.
     * On iOS, when you touch and hold a touch target such as a link, Safari displays
     * a callout containing information about the link. This property allows you to disable that callout.
     * @type {String}
     * @default 'none'
     */touchCallout:'none',/**
     * @private
     * Specifies whether zooming is enabled. Used by IE10>
     * @type {String}
     * @default 'none'
     */contentZooming:'none',/**
     * @private
     * Specifies that an entire element should be draggable instead of its contents. Mainly for desktop browsers.
     * @type {String}
     * @default 'none'
     */userDrag:'none',/**
     * @private
     * Overrides the highlight color shown when the user taps a link or a JavaScript
     * clickable element in iOS. This property obeys the alpha value, if specified.
     * @type {String}
     * @default 'rgba(0,0,0,0)'
     */tapHighlightColor:'rgba(0,0,0,0)'}};var SINGLE_TOUCH_INPUT_MAP={touchstart:INPUT_START,touchmove:INPUT_MOVE,touchend:INPUT_END,touchcancel:INPUT_CANCEL};var SINGLE_TOUCH_TARGET_EVENTS='touchstart';var SINGLE_TOUCH_WINDOW_EVENTS='touchstart touchmove touchend touchcancel';/**
 * @private
 * Touch events input
 * @constructor
 * @extends Input
 */var SingleTouchInput=function(_Input){inherits(SingleTouchInput,_Input);function SingleTouchInput(){classCallCheck(this,SingleTouchInput);var _this=possibleConstructorReturn(this,(SingleTouchInput.__proto__||Object.getPrototypeOf(SingleTouchInput)).apply(this,arguments));_this.evTarget=SINGLE_TOUCH_TARGET_EVENTS;_this.evWin=SINGLE_TOUCH_WINDOW_EVENTS;_this.started=false;Input.apply(_this,arguments);return _this;}createClass(SingleTouchInput,[{key:'handler',value:function handler(ev){var type=SINGLE_TOUCH_INPUT_MAP[ev.type];// should we handle the touch events?
if(type===INPUT_START){this.started=true;}if(!this.started){return;}var touches=normalizeSingleTouches.call(this,ev,type);// when done, reset the started state
if(type&(INPUT_END|INPUT_CANCEL)&&touches[0].length-touches[1].length===0){this.started=false;}this.callback(this.manager,type,{pointers:touches[0],changedPointers:touches[1],pointerType:INPUT_TYPE_TOUCH,srcEvent:ev});}}]);return SingleTouchInput;}(Input);function normalizeSingleTouches(ev,type){var all=toArray$1(ev.touches);var changed=toArray$1(ev.changedTouches);if(type&(INPUT_END|INPUT_CANCEL)){all=uniqueArray(all.concat(changed),'identifier',true);}return[all,changed];}/**
 * @private
 * wrap a method with a deprecation warning and stack trace
 * @param {Function} method
 * @param {String} name
 * @param {String} message
 * @returns {Function} A new function wrapping the supplied method.
 */function deprecate(method,name,message){var deprecationMessage='DEPRECATED METHOD: '+name+'\n'+message+' AT \n';return function(){var e=new Error('get-stack-trace');var stack=e&&e.stack?e.stack.replace(/^[^\(]+?[\n$]/gm,'').replace(/^\s+at\s+/gm,'').replace(/^Object.<anonymous>\s*\(/gm,'{anonymous}()@'):'Unknown Stack Trace';var log=window.console&&(window.console.warn||window.console.log);if(log){log.call(window.console,deprecationMessage,stack);}return method.apply(this,arguments);};}/**
 * @private
 * extend object.
 * means that properties in dest will be overwritten by the ones in src.
 * @param {Object} dest
 * @param {Object} src
 * @param {Boolean} [merge=false]
 * @returns {Object} dest
 */var extend=deprecate(function(dest,src,merge){var keys=Object.keys(src);var i=0;while(i<keys.length){if(!merge||merge&&dest[keys[i]]===undefined){dest[keys[i]]=src[keys[i]];}i++;}return dest;},'extend','Use `assign`.');/**
 * @private
 * merge the values from src in the dest.
 * means that properties that exist in dest will not be overwritten by src
 * @param {Object} dest
 * @param {Object} src
 * @returns {Object} dest
 */var merge=deprecate(function(dest,src){return extend(dest,src,true);},'merge','Use `assign`.');/**
 * @private
 * simple class inheritance
 * @param {Function} child
 * @param {Function} base
 * @param {Object} [properties]
 */function inherit(child,base,properties){var baseP=base.prototype;var childP=void 0;childP=child.prototype=Object.create(baseP);childP.constructor=child;childP._super=baseP;if(properties){assign$1(childP,properties);}}// this prevents errors when Hammer is loaded in the presence of an AMD
//  style loader but by script tag, not by the loader.
assign$1(Hammer,{INPUT_START:INPUT_START,INPUT_MOVE:INPUT_MOVE,INPUT_END:INPUT_END,INPUT_CANCEL:INPUT_CANCEL,STATE_POSSIBLE:STATE_POSSIBLE,STATE_BEGAN:STATE_BEGAN,STATE_CHANGED:STATE_CHANGED,STATE_ENDED:STATE_ENDED,STATE_RECOGNIZED:STATE_RECOGNIZED,STATE_CANCELLED:STATE_CANCELLED,STATE_FAILED:STATE_FAILED,DIRECTION_NONE:DIRECTION_NONE,DIRECTION_LEFT:DIRECTION_LEFT,DIRECTION_RIGHT:DIRECTION_RIGHT,DIRECTION_UP:DIRECTION_UP,DIRECTION_DOWN:DIRECTION_DOWN,DIRECTION_HORIZONTAL:DIRECTION_HORIZONTAL,DIRECTION_VERTICAL:DIRECTION_VERTICAL,DIRECTION_ALL:DIRECTION_ALL,Manager:Manager,Input:Input,TouchAction:TouchAction,TouchInput:TouchInput,MouseInput:MouseInput,PointerEventInput:PointerEventInput,TouchMouseInput:TouchMouseInput,SingleTouchInput:SingleTouchInput,Recognizer:Recognizer,AttrRecognizer:AttrRecognizer,Tap:TapRecognizer,Pan:PanRecognizer,Swipe:SwipeRecognizer,Pinch:PinchRecognizer,Rotate:RotateRecognizer,Press:PressRecognizer,on:addEventListeners,off:removeEventListeners,each:each,merge:merge,extend:extend,assign:assign$1,inherit:inherit,bindFn:bindFn,prefixed:prefixed,toArray:toArray$1,inArray:inArray,uniqueArray:uniqueArray,splitStr:splitStr,boolOrFn:boolOrFn,hasParent:hasParent,addEventListeners:addEventListeners,removeEventListeners:removeEventListeners});/* jshint ignore:start */if(typeof define==='function'&&define.amd){define(function(){return Hammer;});}else if(typeof module!=='undefined'&&module.exports){module.exports=Hammer;}else{window[exportName]=Hammer;}/* jshint ignore:end */})(window,document,'Hammer');/*!
 * Paper.js v0.11.5 - The Swiss Army Knife of Vector Graphics Scripting.
 * http://paperjs.org/
 *
 * Copyright (c) 2011 - 2016, Juerg Lehni & Jonathan Puckey
 * http://scratchdisk.com/ & http://jonathanpuckey.com/
 *
 * Distributed under the MIT license. See LICENSE file for details.
 *
 * All rights reserved.
 *
 * Date: Thu Oct 5 16:16:29 2017 +0200
 *
 ***
 *
 * Straps.js - Class inheritance library with support for bean-style accessors
 *
 * Copyright (c) 2006 - 2016 Juerg Lehni
 * http://scratchdisk.com/
 *
 * Distributed under the MIT license.
 *
 ***
 *
 * Acorn.js
 * http://marijnhaverbeke.nl/acorn/
 *
 * Acorn is a tiny, fast JavaScript parser written in JavaScript,
 * created by Marijn Haverbeke and released under an MIT license.
 *
 */var paper=function(self,undefined){self=self||require('./node/self.js');var window=self.window,document=self.document;var Base=new function(){var hidden=/^(statics|enumerable|beans|preserve)$/,array=[],slice=array.slice,create=Object.create,describe=Object.getOwnPropertyDescriptor,define=Object.defineProperty,forEach=array.forEach||function(iter,bind){for(var i=0,l=this.length;i<l;i++){iter.call(bind,this[i],i,this);}},forIn=function(iter,bind){for(var i in this){if(this.hasOwnProperty(i))iter.call(bind,this[i],i,this);}},set=Object.assign||function(dst){for(var i=1,l=arguments.length;i<l;i++){var src=arguments[i];for(var key in src){if(src.hasOwnProperty(key))dst[key]=src[key];}}return dst;},each=function(obj,iter,bind){if(obj){var desc=describe(obj,'length');(desc&&typeof desc.value==='number'?forEach:forIn).call(obj,iter,bind=bind||obj);}return bind;};function inject(dest,src,enumerable,beans,preserve){var beansNames={};function field(name,val){val=val||(val=describe(src,name))&&(val.get?val:val.value);if(typeof val==='string'&&val[0]==='#')val=dest[val.substring(1)]||val;var isFunc=typeof val==='function',res=val,prev=preserve||isFunc&&!val.base?val&&val.get?name in dest:dest[name]:null,bean;if(!preserve||!prev){if(isFunc&&prev)val.base=prev;if(isFunc&&beans!==false&&(bean=name.match(/^([gs]et|is)(([A-Z])(.*))$/)))beansNames[bean[3].toLowerCase()+bean[4]]=bean[2];if(!res||isFunc||!res.get||typeof res.get!=='function'||!Base.isPlainObject(res)){res={value:res,writable:true};}if((describe(dest,name)||{configurable:true}).configurable){res.configurable=true;res.enumerable=enumerable!=null?enumerable:!bean;}define(dest,name,res);}}if(src){for(var name in src){if(src.hasOwnProperty(name)&&!hidden.test(name))field(name);}for(var name in beansNames){var part=beansNames[name],set=dest['set'+part],get=dest['get'+part]||set&&dest['is'+part];if(get&&(beans===true||get.length===0))field(name,{get:get,set:set});}}return dest;}function Base(){for(var i=0,l=arguments.length;i<l;i++){var src=arguments[i];if(src)set(this,src);}return this;}return inject(Base,{inject:function(src){if(src){var statics=src.statics===true?src:src.statics,beans=src.beans,preserve=src.preserve;if(statics!==src)inject(this.prototype,src,src.enumerable,beans,preserve);inject(this,statics,null,beans,preserve);}for(var i=1,l=arguments.length;i<l;i++)this.inject(arguments[i]);return this;},extend:function(){var base=this,ctor,proto;for(var i=0,obj,l=arguments.length;i<l&&!(ctor&&proto);i++){obj=arguments[i];ctor=ctor||obj.initialize;proto=proto||obj.prototype;}ctor=ctor||function(){base.apply(this,arguments);};proto=ctor.prototype=proto||create(this.prototype);define(proto,'constructor',{value:ctor,writable:true,configurable:true});inject(ctor,this);if(arguments.length)this.inject.apply(ctor,arguments);ctor.base=base;return ctor;}}).inject({enumerable:false,initialize:Base,set:Base,inject:function(){for(var i=0,l=arguments.length;i<l;i++){var src=arguments[i];if(src){inject(this,src,src.enumerable,src.beans,src.preserve);}}return this;},extend:function(){var res=create(this);return res.inject.apply(res,arguments);},each:function(iter,bind){return each(this,iter,bind);},clone:function(){return new this.constructor(this);},statics:{set:set,each:each,create:create,define:define,describe:describe,clone:function(obj){return set(new obj.constructor(),obj);},isPlainObject:function(obj){var ctor=obj!=null&&obj.constructor;return ctor&&(ctor===Object||ctor===Base||ctor.name==='Object');},pick:function(a,b){return a!==undefined?a:b;},slice:function(list,begin,end){return slice.call(list,begin,end);}}});}();if(typeof module!=='undefined')module.exports=Base;Base.inject({enumerable:false,toString:function(){return this._id!=null?(this._class||'Object')+(this._name?" '"+this._name+"'":' @'+this._id):'{ '+Base.each(this,function(value,key){if(!/^_/.test(key)){var type=typeof value;this.push(key+': '+(type==='number'?Formatter.instance.number(value):type==='string'?"'"+value+"'":value));}},[]).join(', ')+' }';},getClassName:function(){return this._class||'';},importJSON:function(json){return Base.importJSON(json,this);},exportJSON:function(options){return Base.exportJSON(this,options);},toJSON:function(){return Base.serialize(this);},set:function(props,exclude){if(props)Base.filter(this,props,exclude,this._prioritize);return this;}},{beans:false,statics:{exports:{},extend:function extend(){var res=extend.base.apply(this,arguments),name=res.prototype._class;if(name&&!Base.exports[name])Base.exports[name]=res;return res;},equals:function(obj1,obj2){if(obj1===obj2)return true;if(obj1&&obj1.equals)return obj1.equals(obj2);if(obj2&&obj2.equals)return obj2.equals(obj1);if(obj1&&obj2&&typeof obj1==='object'&&typeof obj2==='object'){if(Array.isArray(obj1)&&Array.isArray(obj2)){var length=obj1.length;if(length!==obj2.length)return false;while(length--){if(!Base.equals(obj1[length],obj2[length]))return false;}}else{var keys=Object.keys(obj1),length=keys.length;if(length!==Object.keys(obj2).length)return false;while(length--){var key=keys[length];if(!(obj2.hasOwnProperty(key)&&Base.equals(obj1[key],obj2[key])))return false;}}return true;}return false;},read:function(list,start,options,amount){if(this===Base){var value=this.peek(list,start);list.__index++;return value;}var proto=this.prototype,readIndex=proto._readIndex,begin=start||readIndex&&list.__index||0,length=list.length,obj=list[begin];amount=amount||length-begin;if(obj instanceof this||options&&options.readNull&&obj==null&&amount<=1){if(readIndex)list.__index=begin+1;return obj&&options&&options.clone?obj.clone():obj;}obj=Base.create(proto);if(readIndex)obj.__read=true;obj=obj.initialize.apply(obj,begin>0||begin+amount<length?Base.slice(list,begin,begin+amount):list)||obj;if(readIndex){list.__index=begin+obj.__read;var filtered=obj.__filtered;if(filtered){list.__filtered=filtered;obj.__filtered=undefined;}obj.__read=undefined;}return obj;},peek:function(list,start){return list[list.__index=start||list.__index||0];},remain:function(list){return list.length-(list.__index||0);},readList:function(list,start,options,amount){var res=[],entry,begin=start||0,end=amount?begin+amount:list.length;for(var i=begin;i<end;i++){res.push(Array.isArray(entry=list[i])?this.read(entry,0,options):this.read(list,i,options,1));}return res;},readNamed:function(list,name,start,options,amount){var value=this.getNamed(list,name),hasObject=value!==undefined;if(hasObject){var filtered=list.__filtered;if(!filtered){filtered=list.__filtered=Base.create(list[0]);filtered.__unfiltered=list[0];}filtered[name]=undefined;}var l=hasObject?[value]:list,res=this.read(l,start,options,amount);return res;},getNamed:function(list,name){var arg=list[0];if(list._hasObject===undefined)list._hasObject=list.length===1&&Base.isPlainObject(arg);if(list._hasObject)return name?arg[name]:list.__filtered||arg;},hasNamed:function(list,name){return!!this.getNamed(list,name);},filter:function(dest,source,exclude,prioritize){var processed;function handleKey(key){if(!(exclude&&key in exclude)&&!(processed&&key in processed)){var value=source[key];if(value!==undefined)dest[key]=value;}}if(prioritize){var keys={};for(var i=0,key,l=prioritize.length;i<l;i++){if((key=prioritize[i])in source){handleKey(key);keys[key]=true;}}processed=keys;}Object.keys(source.__unfiltered||source).forEach(handleKey);return dest;},isPlainValue:function(obj,asString){return Base.isPlainObject(obj)||Array.isArray(obj)||asString&&typeof obj==='string';},serialize:function(obj,options,compact,dictionary){options=options||{};var isRoot=!dictionary,res;if(isRoot){options.formatter=new Formatter(options.precision);dictionary={length:0,definitions:{},references:{},add:function(item,create){var id='#'+item._id,ref=this.references[id];if(!ref){this.length++;var res=create.call(item),name=item._class;if(name&&res[0]!==name)res.unshift(name);this.definitions[id]=res;ref=this.references[id]=[id];}return ref;}};}if(obj&&obj._serialize){res=obj._serialize(options,dictionary);var name=obj._class;if(name&&!obj._compactSerialize&&(isRoot||!compact)&&res[0]!==name){res.unshift(name);}}else if(Array.isArray(obj)){res=[];for(var i=0,l=obj.length;i<l;i++)res[i]=Base.serialize(obj[i],options,compact,dictionary);}else if(Base.isPlainObject(obj)){res={};var keys=Object.keys(obj);for(var i=0,l=keys.length;i<l;i++){var key=keys[i];res[key]=Base.serialize(obj[key],options,compact,dictionary);}}else if(typeof obj==='number'){res=options.formatter.number(obj,options.precision);}else{res=obj;}return isRoot&&dictionary.length>0?[['dictionary',dictionary.definitions],res]:res;},deserialize:function(json,create,_data,_setDictionary,_isRoot){var res=json,isFirst=!_data,hasDictionary=isFirst&&json&&json.length&&json[0][0]==='dictionary';_data=_data||{};if(Array.isArray(json)){var type=json[0],isDictionary=type==='dictionary';if(json.length==1&&/^#/.test(type)){return _data.dictionary[type];}type=Base.exports[type];res=[];for(var i=type?1:0,l=json.length;i<l;i++){res.push(Base.deserialize(json[i],create,_data,isDictionary,hasDictionary));}if(type){var args=res;if(create){res=create(type,args,isFirst||_isRoot);}else{res=Base.create(type.prototype);type.apply(res,args);}}}else if(Base.isPlainObject(json)){res={};if(_setDictionary)_data.dictionary=res;for(var key in json)res[key]=Base.deserialize(json[key],create,_data);}return hasDictionary?res[1]:res;},exportJSON:function(obj,options){var json=Base.serialize(obj,options);return options&&options.asString==false?json:JSON.stringify(json);},importJSON:function(json,target){return Base.deserialize(typeof json==='string'?JSON.parse(json):json,function(ctor,args,isRoot){var useTarget=isRoot&&target&&target.constructor===ctor,obj=useTarget?target:Base.create(ctor.prototype);if(args.length===1&&obj instanceof Item&&(useTarget||!(obj instanceof Layer))){var arg=args[0];if(Base.isPlainObject(arg))arg.insert=false;}(useTarget?obj.set:ctor).apply(obj,args);if(useTarget)target=null;return obj;});},splice:function(list,items,index,remove){var amount=items&&items.length,append=index===undefined;index=append?list.length:index;if(index>list.length)index=list.length;for(var i=0;i<amount;i++)items[i]._index=index+i;if(append){list.push.apply(list,items);return[];}else{var args=[index,remove];if(items)args.push.apply(args,items);var removed=list.splice.apply(list,args);for(var i=0,l=removed.length;i<l;i++)removed[i]._index=undefined;for(var i=index+amount,l=list.length;i<l;i++)list[i]._index=i;return removed;}},capitalize:function(str){return str.replace(/\b[a-z]/g,function(match){return match.toUpperCase();});},camelize:function(str){return str.replace(/-(.)/g,function(match,chr){return chr.toUpperCase();});},hyphenate:function(str){return str.replace(/([a-z])([A-Z])/g,'$1-$2').toLowerCase();}}});var Emitter={on:function(type,func){if(typeof type!=='string'){Base.each(type,function(value,key){this.on(key,value);},this);}else{var types=this._eventTypes,entry=types&&types[type],handlers=this._callbacks=this._callbacks||{};handlers=handlers[type]=handlers[type]||[];if(handlers.indexOf(func)===-1){handlers.push(func);if(entry&&entry.install&&handlers.length===1)entry.install.call(this,type);}}return this;},off:function(type,func){if(typeof type!=='string'){Base.each(type,function(value,key){this.off(key,value);},this);return;}var types=this._eventTypes,entry=types&&types[type],handlers=this._callbacks&&this._callbacks[type],index;if(handlers){if(!func||(index=handlers.indexOf(func))!==-1&&handlers.length===1){if(entry&&entry.uninstall)entry.uninstall.call(this,type);delete this._callbacks[type];}else if(index!==-1){handlers.splice(index,1);}}return this;},once:function(type,func){return this.on(type,function(){func.apply(this,arguments);this.off(type,func);});},emit:function(type,event){var handlers=this._callbacks&&this._callbacks[type];if(!handlers)return false;var args=Base.slice(arguments,1),setTarget=event&&event.target&&!event.currentTarget;handlers=handlers.slice();if(setTarget)event.currentTarget=this;for(var i=0,l=handlers.length;i<l;i++){if(handlers[i].apply(this,args)==false){if(event&&event.stop)event.stop();break;}}if(setTarget)delete event.currentTarget;return true;},responds:function(type){return!!(this._callbacks&&this._callbacks[type]);},attach:'#on',detach:'#off',fire:'#emit',_installEvents:function(install){var types=this._eventTypes,handlers=this._callbacks,key=install?'install':'uninstall';if(types){for(var type in handlers){if(handlers[type].length>0){var entry=types[type],func=entry&&entry[key];if(func)func.call(this,type);}}}},statics:{inject:function inject(src){var events=src._events;if(events){var types={};Base.each(events,function(entry,key){var isString=typeof entry==='string',name=isString?entry:key,part=Base.capitalize(name),type=name.substring(2).toLowerCase();types[type]=isString?{}:entry;name='_'+name;src['get'+part]=function(){return this[name];};src['set'+part]=function(func){var prev=this[name];if(prev)this.off(type,prev);if(func)this.on(type,func);this[name]=func;};});src._eventTypes=types;}return inject.base.apply(this,arguments);}}};var PaperScope=Base.extend({_class:'PaperScope',initialize:function PaperScope(){paper=this;this.settings=new Base({applyMatrix:true,insertItems:true,handleSize:4,hitTolerance:0});this.project=null;this.projects=[];this.tools=[];this._id=PaperScope._id++;PaperScope._scopes[this._id]=this;var proto=PaperScope.prototype;if(!this.support){var ctx=CanvasProvider.getContext(1,1)||{};proto.support={nativeDash:'setLineDash'in ctx||'mozDash'in ctx,nativeBlendModes:BlendMode.nativeModes};CanvasProvider.release(ctx);}if(!this.agent){var user=self.navigator.userAgent.toLowerCase(),os=(/(darwin|win|mac|linux|freebsd|sunos)/.exec(user)||[])[0],platform=os==='darwin'?'mac':os,agent=proto.agent=proto.browser={platform:platform};if(platform)agent[platform]=true;user.replace(/(opera|chrome|safari|webkit|firefox|msie|trident|atom|node)\/?\s*([.\d]+)(?:.*version\/([.\d]+))?(?:.*rv\:v?([.\d]+))?/g,function(match,n,v1,v2,rv){if(!agent.chrome){var v=n==='opera'?v2:/^(node|trident)$/.test(n)?rv:v1;agent.version=v;agent.versionNumber=parseFloat(v);n=n==='trident'?'msie':n;agent.name=n;agent[n]=true;}});if(agent.chrome)delete agent.webkit;if(agent.atom)delete agent.chrome;}},version:"0.11.5",getView:function(){var project=this.project;return project&&project._view;},getPaper:function(){return this;},execute:function(code,options){paper.PaperScript.execute(code,this,options);View.updateFocus();},install:function(scope){var that=this;Base.each(['project','view','tool'],function(key){Base.define(scope,key,{configurable:true,get:function(){return that[key];}});});for(var key in this)if(!/^_/.test(key)&&this[key])scope[key]=this[key];},setup:function(element){paper=this;this.project=new Project(element);return this;},createCanvas:function(width,height){return CanvasProvider.getCanvas(width,height);},activate:function(){paper=this;},clear:function(){var projects=this.projects,tools=this.tools;for(var i=projects.length-1;i>=0;i--)projects[i].remove();for(var i=tools.length-1;i>=0;i--)tools[i].remove();},remove:function(){this.clear();delete PaperScope._scopes[this._id];},statics:new function(){function handleAttribute(name){name+='Attribute';return function(el,attr){return el[name](attr)||el[name]('data-paper-'+attr);};}return{_scopes:{},_id:0,get:function(id){return this._scopes[id]||null;},getAttribute:handleAttribute('get'),hasAttribute:handleAttribute('has')};}()});var PaperScopeItem=Base.extend(Emitter,{initialize:function(activate){this._scope=paper;this._index=this._scope[this._list].push(this)-1;if(activate||!this._scope[this._reference])this.activate();},activate:function(){if(!this._scope)return false;var prev=this._scope[this._reference];if(prev&&prev!==this)prev.emit('deactivate');this._scope[this._reference]=this;this.emit('activate',prev);return true;},isActive:function(){return this._scope[this._reference]===this;},remove:function(){if(this._index==null)return false;Base.splice(this._scope[this._list],null,this._index,1);if(this._scope[this._reference]==this)this._scope[this._reference]=null;this._scope=null;return true;},getView:function(){return this._scope.getView();}});var Formatter=Base.extend({initialize:function(precision){this.precision=Base.pick(precision,5);this.multiplier=Math.pow(10,this.precision);},number:function(val){return this.precision<16?Math.round(val*this.multiplier)/this.multiplier:val;},pair:function(val1,val2,separator){return this.number(val1)+(separator||',')+this.number(val2);},point:function(val,separator){return this.number(val.x)+(separator||',')+this.number(val.y);},size:function(val,separator){return this.number(val.width)+(separator||',')+this.number(val.height);},rectangle:function(val,separator){return this.point(val,separator)+(separator||',')+this.size(val,separator);}});Formatter.instance=new Formatter();var Numerical=new function(){var abscissas=[[0.5773502691896257645091488],[0,0.7745966692414833770358531],[0.3399810435848562648026658,0.8611363115940525752239465],[0,0.5384693101056830910363144,0.9061798459386639927976269],[0.2386191860831969086305017,0.6612093864662645136613996,0.9324695142031520278123016],[0,0.4058451513773971669066064,0.7415311855993944398638648,0.9491079123427585245261897],[0.1834346424956498049394761,0.5255324099163289858177390,0.7966664774136267395915539,0.9602898564975362316835609],[0,0.3242534234038089290385380,0.6133714327005903973087020,0.8360311073266357942994298,0.9681602395076260898355762],[0.1488743389816312108848260,0.4333953941292471907992659,0.6794095682990244062343274,0.8650633666889845107320967,0.9739065285171717200779640],[0,0.2695431559523449723315320,0.5190961292068118159257257,0.7301520055740493240934163,0.8870625997680952990751578,0.9782286581460569928039380],[0.1252334085114689154724414,0.3678314989981801937526915,0.5873179542866174472967024,0.7699026741943046870368938,0.9041172563704748566784659,0.9815606342467192506905491],[0,0.2304583159551347940655281,0.4484927510364468528779129,0.6423493394403402206439846,0.8015780907333099127942065,0.9175983992229779652065478,0.9841830547185881494728294],[0.1080549487073436620662447,0.3191123689278897604356718,0.5152486363581540919652907,0.6872929048116854701480198,0.8272013150697649931897947,0.9284348836635735173363911,0.9862838086968123388415973],[0,0.2011940939974345223006283,0.3941513470775633698972074,0.5709721726085388475372267,0.7244177313601700474161861,0.8482065834104272162006483,0.9372733924007059043077589,0.9879925180204854284895657],[0.0950125098376374401853193,0.2816035507792589132304605,0.4580167776572273863424194,0.6178762444026437484466718,0.7554044083550030338951012,0.8656312023878317438804679,0.9445750230732325760779884,0.9894009349916499325961542]];var weights=[[1],[0.8888888888888888888888889,0.5555555555555555555555556],[0.6521451548625461426269361,0.3478548451374538573730639],[0.5688888888888888888888889,0.4786286704993664680412915,0.2369268850561890875142640],[0.4679139345726910473898703,0.3607615730481386075698335,0.1713244923791703450402961],[0.4179591836734693877551020,0.3818300505051189449503698,0.2797053914892766679014678,0.1294849661688696932706114],[0.3626837833783619829651504,0.3137066458778872873379622,0.2223810344533744705443560,0.1012285362903762591525314],[0.3302393550012597631645251,0.3123470770400028400686304,0.2606106964029354623187429,0.1806481606948574040584720,0.0812743883615744119718922],[0.2955242247147528701738930,0.2692667193099963550912269,0.2190863625159820439955349,0.1494513491505805931457763,0.0666713443086881375935688],[0.2729250867779006307144835,0.2628045445102466621806889,0.2331937645919904799185237,0.1862902109277342514260976,0.1255803694649046246346943,0.0556685671161736664827537],[0.2491470458134027850005624,0.2334925365383548087608499,0.2031674267230659217490645,0.1600783285433462263346525,0.1069393259953184309602547,0.0471753363865118271946160],[0.2325515532308739101945895,0.2262831802628972384120902,0.2078160475368885023125232,0.1781459807619457382800467,0.1388735102197872384636018,0.0921214998377284479144218,0.0404840047653158795200216],[0.2152638534631577901958764,0.2051984637212956039659241,0.1855383974779378137417166,0.1572031671581935345696019,0.1215185706879031846894148,0.0801580871597602098056333,0.0351194603317518630318329],[0.2025782419255612728806202,0.1984314853271115764561183,0.1861610000155622110268006,0.1662692058169939335532009,0.1395706779261543144478048,0.1071592204671719350118695,0.0703660474881081247092674,0.0307532419961172683546284],[0.1894506104550684962853967,0.1826034150449235888667637,0.1691565193950025381893121,0.1495959888165767320815017,0.1246289712555338720524763,0.0951585116824927848099251,0.0622535239386478928628438,0.0271524594117540948517806]];var abs=Math.abs,sqrt=Math.sqrt,pow=Math.pow,log2=Math.log2||function(x){return Math.log(x)*Math.LOG2E;},EPSILON=1e-12,MACHINE_EPSILON=1.12e-16;function clamp(value,min,max){return value<min?min:value>max?max:value;}function getDiscriminant(a,b,c){function split(v){var x=v*134217729,y=v-x,hi=y+x,lo=v-hi;return[hi,lo];}var D=b*b-a*c,E=b*b+a*c;if(abs(D)*3<E){var ad=split(a),bd=split(b),cd=split(c),p=b*b,dp=bd[0]*bd[0]-p+2*bd[0]*bd[1]+bd[1]*bd[1],q=a*c,dq=ad[0]*cd[0]-q+ad[0]*cd[1]+ad[1]*cd[0]+ad[1]*cd[1];D=p-q+(dp-dq);}return D;}function getNormalizationFactor(){var norm=Math.max.apply(Math,arguments);return norm&&(norm<1e-8||norm>1e8)?pow(2,-Math.round(log2(norm))):0;}return{EPSILON:EPSILON,MACHINE_EPSILON:MACHINE_EPSILON,CURVETIME_EPSILON:1e-8,GEOMETRIC_EPSILON:1e-7,TRIGONOMETRIC_EPSILON:1e-8,KAPPA:4*(sqrt(2)-1)/3,isZero:function(val){return val>=-EPSILON&&val<=EPSILON;},clamp:clamp,integrate:function(f,a,b,n){var x=abscissas[n-2],w=weights[n-2],A=(b-a)*0.5,B=A+a,i=0,m=n+1>>1,sum=n&1?w[i++]*f(B):0;while(i<m){var Ax=A*x[i];sum+=w[i++]*(f(B+Ax)+f(B-Ax));}return A*sum;},findRoot:function(f,df,x,a,b,n,tolerance){for(var i=0;i<n;i++){var fx=f(x),dx=fx/df(x),nx=x-dx;if(abs(dx)<tolerance){x=nx;break;}if(fx>0){b=x;x=nx<=a?(a+b)*0.5:nx;}else{a=x;x=nx>=b?(a+b)*0.5:nx;}}return clamp(x,a,b);},solveQuadratic:function(a,b,c,roots,min,max){var x1,x2=Infinity;if(abs(a)<EPSILON){if(abs(b)<EPSILON)return abs(c)<EPSILON?-1:0;x1=-c/b;}else{b*=-0.5;var D=getDiscriminant(a,b,c);if(D&&abs(D)<MACHINE_EPSILON){var f=getNormalizationFactor(abs(a),abs(b),abs(c));if(f){a*=f;b*=f;c*=f;D=getDiscriminant(a,b,c);}}if(D>=-MACHINE_EPSILON){var Q=D<0?0:sqrt(D),R=b+(b<0?-Q:Q);if(R===0){x1=c/a;x2=-x1;}else{x1=R/a;x2=c/R;}}}var count=0,boundless=min==null,minB=min-EPSILON,maxB=max+EPSILON;if(isFinite(x1)&&(boundless||x1>minB&&x1<maxB))roots[count++]=boundless?x1:clamp(x1,min,max);if(x2!==x1&&isFinite(x2)&&(boundless||x2>minB&&x2<maxB))roots[count++]=boundless?x2:clamp(x2,min,max);return count;},solveCubic:function(a,b,c,d,roots,min,max){var f=getNormalizationFactor(abs(a),abs(b),abs(c),abs(d)),x,b1,c2,qd,q;if(f){a*=f;b*=f;c*=f;d*=f;}function evaluate(x0){x=x0;var tmp=a*x;b1=tmp+b;c2=b1*x+c;qd=(tmp+b1)*x+c2;q=c2*x+d;}if(abs(a)<EPSILON){a=b;b1=c;c2=d;x=Infinity;}else if(abs(d)<EPSILON){b1=b;c2=c;x=0;}else{evaluate(-(b/a)/3);var t=q/a,r=pow(abs(t),1/3),s=t<0?-1:1,td=-qd/a,rd=td>0?1.324717957244746*Math.max(r,sqrt(td)):r,x0=x-s*rd;if(x0!==x){do{evaluate(x0);x0=qd===0?x:x-q/qd/(1+MACHINE_EPSILON);}while(s*x0>s*x);if(abs(a)*x*x>abs(d/x)){c2=-d/x;b1=(c2-c)/x;}}}var count=Numerical.solveQuadratic(a,b1,c2,roots,min,max),boundless=min==null;if(isFinite(x)&&(count===0||count>0&&x!==roots[0]&&x!==roots[1])&&(boundless||x>min-EPSILON&&x<max+EPSILON))roots[count++]=boundless?x:clamp(x,min,max);return count;}};}();var UID={_id:1,_pools:{},get:function(name){if(name){var pool=this._pools[name];if(!pool)pool=this._pools[name]={_id:1};return pool._id++;}else{return this._id++;}}};var Point=Base.extend({_class:'Point',_readIndex:true,initialize:function Point(arg0,arg1){var type=typeof arg0,reading=this.__read,read=0;if(type==='number'){var hasY=typeof arg1==='number';this._set(arg0,hasY?arg1:arg0);if(reading)read=hasY?2:1;}else if(type==='undefined'||arg0===null){this._set(0,0);if(reading)read=arg0===null?1:0;}else{var obj=type==='string'?arg0.split(/[\s,]+/)||[]:arg0;read=1;if(Array.isArray(obj)){this._set(+obj[0],+(obj.length>1?obj[1]:obj[0]));}else if('x'in obj){this._set(obj.x||0,obj.y||0);}else if('width'in obj){this._set(obj.width||0,obj.height||0);}else if('angle'in obj){this._set(obj.length||0,0);this.setAngle(obj.angle||0);}else{this._set(0,0);read=0;}}if(reading)this.__read=read;return this;},set:'#initialize',_set:function(x,y){this.x=x;this.y=y;return this;},equals:function(point){return this===point||point&&(this.x===point.x&&this.y===point.y||Array.isArray(point)&&this.x===point[0]&&this.y===point[1])||false;},clone:function(){return new Point(this.x,this.y);},toString:function(){var f=Formatter.instance;return'{ x: '+f.number(this.x)+', y: '+f.number(this.y)+' }';},_serialize:function(options){var f=options.formatter;return[f.number(this.x),f.number(this.y)];},getLength:function(){return Math.sqrt(this.x*this.x+this.y*this.y);},setLength:function(length){if(this.isZero()){var angle=this._angle||0;this._set(Math.cos(angle)*length,Math.sin(angle)*length);}else{var scale=length/this.getLength();if(Numerical.isZero(scale))this.getAngle();this._set(this.x*scale,this.y*scale);}},getAngle:function(){return this.getAngleInRadians.apply(this,arguments)*180/Math.PI;},setAngle:function(angle){this.setAngleInRadians.call(this,angle*Math.PI/180);},getAngleInDegrees:'#getAngle',setAngleInDegrees:'#setAngle',getAngleInRadians:function(){if(!arguments.length){return this.isZero()?this._angle||0:this._angle=Math.atan2(this.y,this.x);}else{var point=Point.read(arguments),div=this.getLength()*point.getLength();if(Numerical.isZero(div)){return NaN;}else{var a=this.dot(point)/div;return Math.acos(a<-1?-1:a>1?1:a);}}},setAngleInRadians:function(angle){this._angle=angle;if(!this.isZero()){var length=this.getLength();this._set(Math.cos(angle)*length,Math.sin(angle)*length);}},getQuadrant:function(){return this.x>=0?this.y>=0?1:4:this.y>=0?2:3;}},{beans:false,getDirectedAngle:function(){var point=Point.read(arguments);return Math.atan2(this.cross(point),this.dot(point))*180/Math.PI;},getDistance:function(){var point=Point.read(arguments),x=point.x-this.x,y=point.y-this.y,d=x*x+y*y,squared=Base.read(arguments);return squared?d:Math.sqrt(d);},normalize:function(length){if(length===undefined)length=1;var current=this.getLength(),scale=current!==0?length/current:0,point=new Point(this.x*scale,this.y*scale);if(scale>=0)point._angle=this._angle;return point;},rotate:function(angle,center){if(angle===0)return this.clone();angle=angle*Math.PI/180;var point=center?this.subtract(center):this,sin=Math.sin(angle),cos=Math.cos(angle);point=new Point(point.x*cos-point.y*sin,point.x*sin+point.y*cos);return center?point.add(center):point;},transform:function(matrix){return matrix?matrix._transformPoint(this):this;},add:function(){var point=Point.read(arguments);return new Point(this.x+point.x,this.y+point.y);},subtract:function(){var point=Point.read(arguments);return new Point(this.x-point.x,this.y-point.y);},multiply:function(){var point=Point.read(arguments);return new Point(this.x*point.x,this.y*point.y);},divide:function(){var point=Point.read(arguments);return new Point(this.x/point.x,this.y/point.y);},modulo:function(){var point=Point.read(arguments);return new Point(this.x%point.x,this.y%point.y);},negate:function(){return new Point(-this.x,-this.y);},isInside:function(){return Rectangle.read(arguments).contains(this);},isClose:function(){var point=Point.read(arguments),tolerance=Base.read(arguments);return this.getDistance(point)<=tolerance;},isCollinear:function(){var point=Point.read(arguments);return Point.isCollinear(this.x,this.y,point.x,point.y);},isColinear:'#isCollinear',isOrthogonal:function(){var point=Point.read(arguments);return Point.isOrthogonal(this.x,this.y,point.x,point.y);},isZero:function(){var isZero=Numerical.isZero;return isZero(this.x)&&isZero(this.y);},isNaN:function(){return isNaN(this.x)||isNaN(this.y);},isInQuadrant:function(q){return this.x*(q>1&&q<4?-1:1)>=0&&this.y*(q>2?-1:1)>=0;},dot:function(){var point=Point.read(arguments);return this.x*point.x+this.y*point.y;},cross:function(){var point=Point.read(arguments);return this.x*point.y-this.y*point.x;},project:function(){var point=Point.read(arguments),scale=point.isZero()?0:this.dot(point)/point.dot(point);return new Point(point.x*scale,point.y*scale);},statics:{min:function(){var point1=Point.read(arguments),point2=Point.read(arguments);return new Point(Math.min(point1.x,point2.x),Math.min(point1.y,point2.y));},max:function(){var point1=Point.read(arguments),point2=Point.read(arguments);return new Point(Math.max(point1.x,point2.x),Math.max(point1.y,point2.y));},random:function(){return new Point(Math.random(),Math.random());},isCollinear:function(x1,y1,x2,y2){return Math.abs(x1*y2-y1*x2)<=Math.sqrt((x1*x1+y1*y1)*(x2*x2+y2*y2))*1e-8;},isOrthogonal:function(x1,y1,x2,y2){return Math.abs(x1*x2+y1*y2)<=Math.sqrt((x1*x1+y1*y1)*(x2*x2+y2*y2))*1e-8;}}},Base.each(['round','ceil','floor','abs'],function(key){var op=Math[key];this[key]=function(){return new Point(op(this.x),op(this.y));};},{}));var LinkedPoint=Point.extend({initialize:function Point(x,y,owner,setter){this._x=x;this._y=y;this._owner=owner;this._setter=setter;},_set:function(x,y,_dontNotify){this._x=x;this._y=y;if(!_dontNotify)this._owner[this._setter](this);return this;},getX:function(){return this._x;},setX:function(x){this._x=x;this._owner[this._setter](this);},getY:function(){return this._y;},setY:function(y){this._y=y;this._owner[this._setter](this);},isSelected:function(){return!!(this._owner._selection&this._getSelection());},setSelected:function(selected){this._owner._changeSelection(this._getSelection(),selected);},_getSelection:function(){return this._setter==='setPosition'?4:0;}});var Size=Base.extend({_class:'Size',_readIndex:true,initialize:function Size(arg0,arg1){var type=typeof arg0,reading=this.__read,read=0;if(type==='number'){var hasHeight=typeof arg1==='number';this._set(arg0,hasHeight?arg1:arg0);if(reading)read=hasHeight?2:1;}else if(type==='undefined'||arg0===null){this._set(0,0);if(reading)read=arg0===null?1:0;}else{var obj=type==='string'?arg0.split(/[\s,]+/)||[]:arg0;read=1;if(Array.isArray(obj)){this._set(+obj[0],+(obj.length>1?obj[1]:obj[0]));}else if('width'in obj){this._set(obj.width||0,obj.height||0);}else if('x'in obj){this._set(obj.x||0,obj.y||0);}else{this._set(0,0);read=0;}}if(reading)this.__read=read;return this;},set:'#initialize',_set:function(width,height){this.width=width;this.height=height;return this;},equals:function(size){return size===this||size&&(this.width===size.width&&this.height===size.height||Array.isArray(size)&&this.width===size[0]&&this.height===size[1])||false;},clone:function(){return new Size(this.width,this.height);},toString:function(){var f=Formatter.instance;return'{ width: '+f.number(this.width)+', height: '+f.number(this.height)+' }';},_serialize:function(options){var f=options.formatter;return[f.number(this.width),f.number(this.height)];},add:function(){var size=Size.read(arguments);return new Size(this.width+size.width,this.height+size.height);},subtract:function(){var size=Size.read(arguments);return new Size(this.width-size.width,this.height-size.height);},multiply:function(){var size=Size.read(arguments);return new Size(this.width*size.width,this.height*size.height);},divide:function(){var size=Size.read(arguments);return new Size(this.width/size.width,this.height/size.height);},modulo:function(){var size=Size.read(arguments);return new Size(this.width%size.width,this.height%size.height);},negate:function(){return new Size(-this.width,-this.height);},isZero:function(){var isZero=Numerical.isZero;return isZero(this.width)&&isZero(this.height);},isNaN:function(){return isNaN(this.width)||isNaN(this.height);},statics:{min:function(size1,size2){return new Size(Math.min(size1.width,size2.width),Math.min(size1.height,size2.height));},max:function(size1,size2){return new Size(Math.max(size1.width,size2.width),Math.max(size1.height,size2.height));},random:function(){return new Size(Math.random(),Math.random());}}},Base.each(['round','ceil','floor','abs'],function(key){var op=Math[key];this[key]=function(){return new Size(op(this.width),op(this.height));};},{}));var LinkedSize=Size.extend({initialize:function Size(width,height,owner,setter){this._width=width;this._height=height;this._owner=owner;this._setter=setter;},_set:function(width,height,_dontNotify){this._width=width;this._height=height;if(!_dontNotify)this._owner[this._setter](this);return this;},getWidth:function(){return this._width;},setWidth:function(width){this._width=width;this._owner[this._setter](this);},getHeight:function(){return this._height;},setHeight:function(height){this._height=height;this._owner[this._setter](this);}});var Rectangle=Base.extend({_class:'Rectangle',_readIndex:true,beans:true,initialize:function Rectangle(arg0,arg1,arg2,arg3){var type=typeof arg0,read;if(type==='number'){this._set(arg0,arg1,arg2,arg3);read=4;}else if(type==='undefined'||arg0===null){this._set(0,0,0,0);read=arg0===null?1:0;}else if(arguments.length===1){if(Array.isArray(arg0)){this._set.apply(this,arg0);read=1;}else if(arg0.x!==undefined||arg0.width!==undefined){this._set(arg0.x||0,arg0.y||0,arg0.width||0,arg0.height||0);read=1;}else if(arg0.from===undefined&&arg0.to===undefined){this._set(0,0,0,0);Base.filter(this,arg0);read=1;}}if(read===undefined){var frm=Point.readNamed(arguments,'from'),next=Base.peek(arguments),x=frm.x,y=frm.y,width,height;if(next&&next.x!==undefined||Base.hasNamed(arguments,'to')){var to=Point.readNamed(arguments,'to');width=to.x-x;height=to.y-y;if(width<0){x=to.x;width=-width;}if(height<0){y=to.y;height=-height;}}else{var size=Size.read(arguments);width=size.width;height=size.height;}this._set(x,y,width,height);read=arguments.__index;var filtered=arguments.__filtered;if(filtered)this.__filtered=filtered;}if(this.__read)this.__read=read;return this;},set:'#initialize',_set:function(x,y,width,height){this.x=x;this.y=y;this.width=width;this.height=height;return this;},clone:function(){return new Rectangle(this.x,this.y,this.width,this.height);},equals:function(rect){var rt=Base.isPlainValue(rect)?Rectangle.read(arguments):rect;return rt===this||rt&&this.x===rt.x&&this.y===rt.y&&this.width===rt.width&&this.height===rt.height||false;},toString:function(){var f=Formatter.instance;return'{ x: '+f.number(this.x)+', y: '+f.number(this.y)+', width: '+f.number(this.width)+', height: '+f.number(this.height)+' }';},_serialize:function(options){var f=options.formatter;return[f.number(this.x),f.number(this.y),f.number(this.width),f.number(this.height)];},getPoint:function(_dontLink){var ctor=_dontLink?Point:LinkedPoint;return new ctor(this.x,this.y,this,'setPoint');},setPoint:function(){var point=Point.read(arguments);this.x=point.x;this.y=point.y;},getSize:function(_dontLink){var ctor=_dontLink?Size:LinkedSize;return new ctor(this.width,this.height,this,'setSize');},_fw:1,_fh:1,setSize:function(){var size=Size.read(arguments),sx=this._sx,sy=this._sy,w=size.width,h=size.height;if(sx){this.x+=(this.width-w)*sx;}if(sy){this.y+=(this.height-h)*sy;}this.width=w;this.height=h;this._fw=this._fh=1;},getLeft:function(){return this.x;},setLeft:function(left){if(!this._fw){var amount=left-this.x;this.width-=this._sx===0.5?amount*2:amount;}this.x=left;this._sx=this._fw=0;},getTop:function(){return this.y;},setTop:function(top){if(!this._fh){var amount=top-this.y;this.height-=this._sy===0.5?amount*2:amount;}this.y=top;this._sy=this._fh=0;},getRight:function(){return this.x+this.width;},setRight:function(right){if(!this._fw){var amount=right-this.x;this.width=this._sx===0.5?amount*2:amount;}this.x=right-this.width;this._sx=1;this._fw=0;},getBottom:function(){return this.y+this.height;},setBottom:function(bottom){if(!this._fh){var amount=bottom-this.y;this.height=this._sy===0.5?amount*2:amount;}this.y=bottom-this.height;this._sy=1;this._fh=0;},getCenterX:function(){return this.x+this.width/2;},setCenterX:function(x){if(this._fw||this._sx===0.5){this.x=x-this.width/2;}else{if(this._sx){this.x+=(x-this.x)*2*this._sx;}this.width=(x-this.x)*2;}this._sx=0.5;this._fw=0;},getCenterY:function(){return this.y+this.height/2;},setCenterY:function(y){if(this._fh||this._sy===0.5){this.y=y-this.height/2;}else{if(this._sy){this.y+=(y-this.y)*2*this._sy;}this.height=(y-this.y)*2;}this._sy=0.5;this._fh=0;},getCenter:function(_dontLink){var ctor=_dontLink?Point:LinkedPoint;return new ctor(this.getCenterX(),this.getCenterY(),this,'setCenter');},setCenter:function(){var point=Point.read(arguments);this.setCenterX(point.x);this.setCenterY(point.y);return this;},getArea:function(){return this.width*this.height;},isEmpty:function(){return this.width===0||this.height===0;},contains:function(arg){return arg&&arg.width!==undefined||(Array.isArray(arg)?arg:arguments).length===4?this._containsRectangle(Rectangle.read(arguments)):this._containsPoint(Point.read(arguments));},_containsPoint:function(point){var x=point.x,y=point.y;return x>=this.x&&y>=this.y&&x<=this.x+this.width&&y<=this.y+this.height;},_containsRectangle:function(rect){var x=rect.x,y=rect.y;return x>=this.x&&y>=this.y&&x+rect.width<=this.x+this.width&&y+rect.height<=this.y+this.height;},intersects:function(){var rect=Rectangle.read(arguments),epsilon=Base.read(arguments)||0;return rect.x+rect.width>this.x-epsilon&&rect.y+rect.height>this.y-epsilon&&rect.x<this.x+this.width+epsilon&&rect.y<this.y+this.height+epsilon;},intersect:function(){var rect=Rectangle.read(arguments),x1=Math.max(this.x,rect.x),y1=Math.max(this.y,rect.y),x2=Math.min(this.x+this.width,rect.x+rect.width),y2=Math.min(this.y+this.height,rect.y+rect.height);return new Rectangle(x1,y1,x2-x1,y2-y1);},unite:function(){var rect=Rectangle.read(arguments),x1=Math.min(this.x,rect.x),y1=Math.min(this.y,rect.y),x2=Math.max(this.x+this.width,rect.x+rect.width),y2=Math.max(this.y+this.height,rect.y+rect.height);return new Rectangle(x1,y1,x2-x1,y2-y1);},include:function(){var point=Point.read(arguments);var x1=Math.min(this.x,point.x),y1=Math.min(this.y,point.y),x2=Math.max(this.x+this.width,point.x),y2=Math.max(this.y+this.height,point.y);return new Rectangle(x1,y1,x2-x1,y2-y1);},expand:function(){var amount=Size.read(arguments),hor=amount.width,ver=amount.height;return new Rectangle(this.x-hor/2,this.y-ver/2,this.width+hor,this.height+ver);},scale:function(hor,ver){return this.expand(this.width*hor-this.width,this.height*(ver===undefined?hor:ver)-this.height);}},Base.each([['Top','Left'],['Top','Right'],['Bottom','Left'],['Bottom','Right'],['Left','Center'],['Top','Center'],['Right','Center'],['Bottom','Center']],function(parts,index){var part=parts.join(''),xFirst=/^[RL]/.test(part);if(index>=4)parts[1]+=xFirst?'Y':'X';var x=parts[xFirst?0:1],y=parts[xFirst?1:0],getX='get'+x,getY='get'+y,setX='set'+x,setY='set'+y,get='get'+part,set='set'+part;this[get]=function(_dontLink){var ctor=_dontLink?Point:LinkedPoint;return new ctor(this[getX](),this[getY](),this,set);};this[set]=function(){var point=Point.read(arguments);this[setX](point.x);this[setY](point.y);};},{beans:true}));var LinkedRectangle=Rectangle.extend({initialize:function Rectangle(x,y,width,height,owner,setter){this._set(x,y,width,height,true);this._owner=owner;this._setter=setter;},_set:function(x,y,width,height,_dontNotify){this._x=x;this._y=y;this._width=width;this._height=height;if(!_dontNotify)this._owner[this._setter](this);return this;}},new function(){var proto=Rectangle.prototype;return Base.each(['x','y','width','height'],function(key){var part=Base.capitalize(key),internal='_'+key;this['get'+part]=function(){return this[internal];};this['set'+part]=function(value){this[internal]=value;if(!this._dontNotify)this._owner[this._setter](this);};},Base.each(['Point','Size','Center','Left','Top','Right','Bottom','CenterX','CenterY','TopLeft','TopRight','BottomLeft','BottomRight','LeftCenter','TopCenter','RightCenter','BottomCenter'],function(key){var name='set'+key;this[name]=function(){this._dontNotify=true;proto[name].apply(this,arguments);this._dontNotify=false;this._owner[this._setter](this);};},{isSelected:function(){return!!(this._owner._selection&2);},setSelected:function(selected){var owner=this._owner;if(owner._changeSelection){owner._changeSelection(2,selected);}}}));}());var Matrix=Base.extend({_class:'Matrix',initialize:function Matrix(arg,_dontNotify){var count=arguments.length,ok=true;if(count>=6){this._set.apply(this,arguments);}else if(count===1||count===2){if(arg instanceof Matrix){this._set(arg._a,arg._b,arg._c,arg._d,arg._tx,arg._ty,_dontNotify);}else if(Array.isArray(arg)){this._set.apply(this,_dontNotify?arg.concat([_dontNotify]):arg);}else{ok=false;}}else if(!count){this.reset();}else{ok=false;}if(!ok){throw new Error('Unsupported matrix parameters');}return this;},set:'#initialize',_set:function(a,b,c,d,tx,ty,_dontNotify){this._a=a;this._b=b;this._c=c;this._d=d;this._tx=tx;this._ty=ty;if(!_dontNotify)this._changed();return this;},_serialize:function(options,dictionary){return Base.serialize(this.getValues(),options,true,dictionary);},_changed:function(){var owner=this._owner;if(owner){if(owner._applyMatrix){owner.transform(null,true);}else{owner._changed(9);}}},clone:function(){return new Matrix(this._a,this._b,this._c,this._d,this._tx,this._ty);},equals:function(mx){return mx===this||mx&&this._a===mx._a&&this._b===mx._b&&this._c===mx._c&&this._d===mx._d&&this._tx===mx._tx&&this._ty===mx._ty;},toString:function(){var f=Formatter.instance;return'[['+[f.number(this._a),f.number(this._c),f.number(this._tx)].join(', ')+'], ['+[f.number(this._b),f.number(this._d),f.number(this._ty)].join(', ')+']]';},reset:function(_dontNotify){this._a=this._d=1;this._b=this._c=this._tx=this._ty=0;if(!_dontNotify)this._changed();return this;},apply:function(recursively,_setApplyMatrix){var owner=this._owner;if(owner){owner.transform(null,true,Base.pick(recursively,true),_setApplyMatrix);return this.isIdentity();}return false;},translate:function(){var point=Point.read(arguments),x=point.x,y=point.y;this._tx+=x*this._a+y*this._c;this._ty+=x*this._b+y*this._d;this._changed();return this;},scale:function(){var scale=Point.read(arguments),center=Point.read(arguments,0,{readNull:true});if(center)this.translate(center);this._a*=scale.x;this._b*=scale.x;this._c*=scale.y;this._d*=scale.y;if(center)this.translate(center.negate());this._changed();return this;},rotate:function(angle){angle*=Math.PI/180;var center=Point.read(arguments,1),x=center.x,y=center.y,cos=Math.cos(angle),sin=Math.sin(angle),tx=x-x*cos+y*sin,ty=y-x*sin-y*cos,a=this._a,b=this._b,c=this._c,d=this._d;this._a=cos*a+sin*c;this._b=cos*b+sin*d;this._c=-sin*a+cos*c;this._d=-sin*b+cos*d;this._tx+=tx*a+ty*c;this._ty+=tx*b+ty*d;this._changed();return this;},shear:function(){var shear=Point.read(arguments),center=Point.read(arguments,0,{readNull:true});if(center)this.translate(center);var a=this._a,b=this._b;this._a+=shear.y*this._c;this._b+=shear.y*this._d;this._c+=shear.x*a;this._d+=shear.x*b;if(center)this.translate(center.negate());this._changed();return this;},skew:function(){var skew=Point.read(arguments),center=Point.read(arguments,0,{readNull:true}),toRadians=Math.PI/180,shear=new Point(Math.tan(skew.x*toRadians),Math.tan(skew.y*toRadians));return this.shear(shear,center);},append:function(mx,_dontNotify){if(mx){var a1=this._a,b1=this._b,c1=this._c,d1=this._d,a2=mx._a,b2=mx._c,c2=mx._b,d2=mx._d,tx2=mx._tx,ty2=mx._ty;this._a=a2*a1+c2*c1;this._c=b2*a1+d2*c1;this._b=a2*b1+c2*d1;this._d=b2*b1+d2*d1;this._tx+=tx2*a1+ty2*c1;this._ty+=tx2*b1+ty2*d1;if(!_dontNotify)this._changed();}return this;},prepend:function(mx,_dontNotify){if(mx){var a1=this._a,b1=this._b,c1=this._c,d1=this._d,tx1=this._tx,ty1=this._ty,a2=mx._a,b2=mx._c,c2=mx._b,d2=mx._d,tx2=mx._tx,ty2=mx._ty;this._a=a2*a1+b2*b1;this._c=a2*c1+b2*d1;this._b=c2*a1+d2*b1;this._d=c2*c1+d2*d1;this._tx=a2*tx1+b2*ty1+tx2;this._ty=c2*tx1+d2*ty1+ty2;if(!_dontNotify)this._changed();}return this;},appended:function(mx){return this.clone().append(mx);},prepended:function(mx){return this.clone().prepend(mx);},invert:function(){var a=this._a,b=this._b,c=this._c,d=this._d,tx=this._tx,ty=this._ty,det=a*d-b*c,res=null;if(det&&!isNaN(det)&&isFinite(tx)&&isFinite(ty)){this._a=d/det;this._b=-b/det;this._c=-c/det;this._d=a/det;this._tx=(c*ty-d*tx)/det;this._ty=(b*tx-a*ty)/det;res=this;}return res;},inverted:function(){return this.clone().invert();},concatenate:'#append',preConcatenate:'#prepend',chain:'#appended',_shiftless:function(){return new Matrix(this._a,this._b,this._c,this._d,0,0);},_orNullIfIdentity:function(){return this.isIdentity()?null:this;},isIdentity:function(){return this._a===1&&this._b===0&&this._c===0&&this._d===1&&this._tx===0&&this._ty===0;},isInvertible:function(){var det=this._a*this._d-this._c*this._b;return det&&!isNaN(det)&&isFinite(this._tx)&&isFinite(this._ty);},isSingular:function(){return!this.isInvertible();},transform:function(src,dst,count){return arguments.length<3?this._transformPoint(Point.read(arguments)):this._transformCoordinates(src,dst,count);},_transformPoint:function(point,dest,_dontNotify){var x=point.x,y=point.y;if(!dest)dest=new Point();return dest._set(x*this._a+y*this._c+this._tx,x*this._b+y*this._d+this._ty,_dontNotify);},_transformCoordinates:function(src,dst,count){for(var i=0,max=2*count;i<max;i+=2){var x=src[i],y=src[i+1];dst[i]=x*this._a+y*this._c+this._tx;dst[i+1]=x*this._b+y*this._d+this._ty;}return dst;},_transformCorners:function(rect){var x1=rect.x,y1=rect.y,x2=x1+rect.width,y2=y1+rect.height,coords=[x1,y1,x2,y1,x2,y2,x1,y2];return this._transformCoordinates(coords,coords,4);},_transformBounds:function(bounds,dest,_dontNotify){var coords=this._transformCorners(bounds),min=coords.slice(0,2),max=min.slice();for(var i=2;i<8;i++){var val=coords[i],j=i&1;if(val<min[j]){min[j]=val;}else if(val>max[j]){max[j]=val;}}if(!dest)dest=new Rectangle();return dest._set(min[0],min[1],max[0]-min[0],max[1]-min[1],_dontNotify);},inverseTransform:function(){return this._inverseTransform(Point.read(arguments));},_inverseTransform:function(point,dest,_dontNotify){var a=this._a,b=this._b,c=this._c,d=this._d,tx=this._tx,ty=this._ty,det=a*d-b*c,res=null;if(det&&!isNaN(det)&&isFinite(tx)&&isFinite(ty)){var x=point.x-this._tx,y=point.y-this._ty;if(!dest)dest=new Point();res=dest._set((x*d-y*c)/det,(y*a-x*b)/det,_dontNotify);}return res;},decompose:function(){var a=this._a,b=this._b,c=this._c,d=this._d,det=a*d-b*c,sqrt=Math.sqrt,atan2=Math.atan2,degrees=180/Math.PI,rotate,scale,skew;if(a!==0||b!==0){var r=sqrt(a*a+b*b);rotate=Math.acos(a/r)*(b>0?1:-1);scale=[r,det/r];skew=[atan2(a*c+b*d,r*r),0];}else if(c!==0||d!==0){var s=sqrt(c*c+d*d);rotate=Math.asin(c/s)*(d>0?1:-1);scale=[det/s,s];skew=[0,atan2(a*c+b*d,s*s)];}else{rotate=0;skew=scale=[0,0];}return{translation:this.getTranslation(),rotation:rotate*degrees,scaling:new Point(scale),skewing:new Point(skew[0]*degrees,skew[1]*degrees)};},getValues:function(){return[this._a,this._b,this._c,this._d,this._tx,this._ty];},getTranslation:function(){return new Point(this._tx,this._ty);},getScaling:function(){return(this.decompose()||{}).scaling;},getRotation:function(){return(this.decompose()||{}).rotation;},applyToContext:function(ctx){if(!this.isIdentity()){ctx.transform(this._a,this._b,this._c,this._d,this._tx,this._ty);}}},Base.each(['a','b','c','d','tx','ty'],function(key){var part=Base.capitalize(key),prop='_'+key;this['get'+part]=function(){return this[prop];};this['set'+part]=function(value){this[prop]=value;this._changed();};},{}));var Line=Base.extend({_class:'Line',initialize:function Line(arg0,arg1,arg2,arg3,arg4){var asVector=false;if(arguments.length>=4){this._px=arg0;this._py=arg1;this._vx=arg2;this._vy=arg3;asVector=arg4;}else{this._px=arg0.x;this._py=arg0.y;this._vx=arg1.x;this._vy=arg1.y;asVector=arg2;}if(!asVector){this._vx-=this._px;this._vy-=this._py;}},getPoint:function(){return new Point(this._px,this._py);},getVector:function(){return new Point(this._vx,this._vy);},getLength:function(){return this.getVector().getLength();},intersect:function(line,isInfinite){return Line.intersect(this._px,this._py,this._vx,this._vy,line._px,line._py,line._vx,line._vy,true,isInfinite);},getSide:function(point,isInfinite){return Line.getSide(this._px,this._py,this._vx,this._vy,point.x,point.y,true,isInfinite);},getDistance:function(point){return Math.abs(this.getSignedDistance(point));},getSignedDistance:function(point){return Line.getSignedDistance(this._px,this._py,this._vx,this._vy,point.x,point.y,true);},isCollinear:function(line){return Point.isCollinear(this._vx,this._vy,line._vx,line._vy);},isOrthogonal:function(line){return Point.isOrthogonal(this._vx,this._vy,line._vx,line._vy);},statics:{intersect:function(p1x,p1y,v1x,v1y,p2x,p2y,v2x,v2y,asVector,isInfinite){if(!asVector){v1x-=p1x;v1y-=p1y;v2x-=p2x;v2y-=p2y;}var cross=v1x*v2y-v1y*v2x;if(!Numerical.isZero(cross)){var dx=p1x-p2x,dy=p1y-p2y,u1=(v2x*dy-v2y*dx)/cross,u2=(v1x*dy-v1y*dx)/cross,epsilon=1e-12,uMin=-epsilon,uMax=1+epsilon;if(isInfinite||uMin<u1&&u1<uMax&&uMin<u2&&u2<uMax){if(!isInfinite){u1=u1<=0?0:u1>=1?1:u1;}return new Point(p1x+u1*v1x,p1y+u1*v1y);}}},getSide:function(px,py,vx,vy,x,y,asVector,isInfinite){if(!asVector){vx-=px;vy-=py;}var v2x=x-px,v2y=y-py,ccw=v2x*vy-v2y*vx;if(!isInfinite&&Numerical.isZero(ccw)){ccw=(v2x*vx+v2x*vx)/(vx*vx+vy*vy);if(ccw>=0&&ccw<=1)ccw=0;}return ccw<0?-1:ccw>0?1:0;},getSignedDistance:function(px,py,vx,vy,x,y,asVector){if(!asVector){vx-=px;vy-=py;}return vx===0?vy>0?x-px:px-x:vy===0?vx<0?y-py:py-y:((x-px)*vy-(y-py)*vx)/Math.sqrt(vx*vx+vy*vy);},getDistance:function(px,py,vx,vy,x,y,asVector){return Math.abs(Line.getSignedDistance(px,py,vx,vy,x,y,asVector));}}});var Project=PaperScopeItem.extend({_class:'Project',_list:'projects',_reference:'project',_compactSerialize:true,initialize:function Project(element){PaperScopeItem.call(this,true);this._children=[];this._namedChildren={};this._activeLayer=null;this._currentStyle=new Style(null,null,this);this._view=View.create(this,element||CanvasProvider.getCanvas(1,1));this._selectionItems={};this._selectionCount=0;this._updateVersion=0;},_serialize:function(options,dictionary){return Base.serialize(this._children,options,true,dictionary);},_changed:function(flags,item){if(flags&1){var view=this._view;if(view){view._needsUpdate=true;if(!view._requested&&view._autoUpdate)view.requestUpdate();//view.update();
}}var changes=this._changes;if(changes&&item){var changesById=this._changesById,id=item._id,entry=changesById[id];if(entry){entry.flags|=flags;}else{changes.push(changesById[id]={item:item,flags:flags});}}},clear:function(){var children=this._children;for(var i=children.length-1;i>=0;i--)children[i].remove();},isEmpty:function(){return!this._children.length;},remove:function remove(){if(!remove.base.call(this))return false;if(this._view)this._view.remove();return true;},getView:function(){return this._view;},getCurrentStyle:function(){return this._currentStyle;},setCurrentStyle:function(style){this._currentStyle.set(style);},getIndex:function(){return this._index;},getOptions:function(){return this._scope.settings;},getLayers:function(){return this._children;},getActiveLayer:function(){return this._activeLayer||new Layer({project:this,insert:true});},getSymbolDefinitions:function(){var definitions=[],ids={};this.getItems({class:SymbolItem,match:function(item){var definition=item._definition,id=definition._id;if(!ids[id]){ids[id]=true;definitions.push(definition);}return false;}});return definitions;},getSymbols:'getSymbolDefinitions',getSelectedItems:function(){var selectionItems=this._selectionItems,items=[];for(var id in selectionItems){var item=selectionItems[id],selection=item._selection;if(selection&1&&item.isInserted()){items.push(item);}else if(!selection){this._updateSelection(item);}}return items;},_updateSelection:function(item){var id=item._id,selectionItems=this._selectionItems;if(item._selection){if(selectionItems[id]!==item){this._selectionCount++;selectionItems[id]=item;}}else if(selectionItems[id]===item){this._selectionCount--;delete selectionItems[id];}},selectAll:function(){var children=this._children;for(var i=0,l=children.length;i<l;i++)children[i].setFullySelected(true);},deselectAll:function(){var selectionItems=this._selectionItems;for(var i in selectionItems)selectionItems[i].setFullySelected(false);},addLayer:function(layer){return this.insertLayer(undefined,layer);},insertLayer:function(index,layer){if(layer instanceof Layer){layer._remove(false,true);Base.splice(this._children,[layer],index,0);layer._setProject(this,true);var name=layer._name;if(name)layer.setName(name);if(this._changes)layer._changed(5);if(!this._activeLayer)this._activeLayer=layer;}else{layer=null;}return layer;},_insertItem:function(index,item,_created){item=this.insertLayer(index,item)||(this._activeLayer||this._insertItem(undefined,new Layer(Item.NO_INSERT),true)).insertChild(index,item);if(_created&&item.activate)item.activate();return item;},getItems:function(options){return Item._getItems(this,options);},getItem:function(options){return Item._getItems(this,options,null,null,true)[0]||null;},importJSON:function(json){this.activate();var layer=this._activeLayer;return Base.importJSON(json,layer&&layer.isEmpty()&&layer);},removeOn:function(type){var sets=this._removeSets;if(sets){if(type==='mouseup')sets.mousedrag=null;var set=sets[type];if(set){for(var id in set){var item=set[id];for(var key in sets){var other=sets[key];if(other&&other!=set)delete other[item._id];}item.remove();}sets[type]=null;}}},draw:function(ctx,matrix,pixelRatio){this._updateVersion++;ctx.save();matrix.applyToContext(ctx);var children=this._children,param=new Base({offset:new Point(0,0),pixelRatio:pixelRatio,viewMatrix:matrix.isIdentity()?null:matrix,matrices:[new Matrix()],updateMatrix:true});for(var i=0,l=children.length;i<l;i++){children[i].draw(ctx,param);}ctx.restore();if(this._selectionCount>0){ctx.save();ctx.strokeWidth=1;var items=this._selectionItems,size=this._scope.settings.handleSize,version=this._updateVersion;for(var id in items){items[id]._drawSelection(ctx,matrix,size,items,version);}ctx.restore();}}});var Item=Base.extend(Emitter,{statics:{extend:function extend(src){if(src._serializeFields)src._serializeFields=Base.set({},this.prototype._serializeFields,src._serializeFields);return extend.base.apply(this,arguments);},NO_INSERT:{insert:false}},_class:'Item',_name:null,_applyMatrix:true,_canApplyMatrix:true,_canScaleStroke:false,_pivot:null,_visible:true,_blendMode:'normal',_enhanceBlendMode:false,// Matteo
_opacity:1,_locked:false,_guide:false,_clipMask:false,_selection:0,_selectBounds:true,_selectChildren:false,_serializeFields:{name:null,applyMatrix:null,matrix:new Matrix(),pivot:null,visible:true,blendMode:'normal',enhanceBlendMode:false,// Matteo
opacity:1,locked:false,guide:false,clipMask:false,selected:false,data:{}},_prioritize:['applyMatrix']},new function(){var handlers=['onMouseDown','onMouseUp','onMouseDrag','onClick','onDoubleClick','onMouseMove','onMouseEnter','onMouseLeave'];return Base.each(handlers,function(name){this._events[name]={install:function(type){this.getView()._countItemEvent(type,1);},uninstall:function(type){this.getView()._countItemEvent(type,-1);}};},{_events:{onFrame:{install:function(){this.getView()._animateItem(this,true);},uninstall:function(){this.getView()._animateItem(this,false);}},onLoad:{},onError:{}},statics:{_itemHandlers:handlers}});}(),{initialize:function Item(){},_initialize:function(props,point){var hasProps=props&&Base.isPlainObject(props),internal=hasProps&&props.internal===true,matrix=this._matrix=new Matrix(),project=hasProps&&props.project||paper.project,settings=paper.settings;this._id=internal?null:UID.get();this._parent=this._index=null;this._applyMatrix=this._canApplyMatrix&&settings.applyMatrix;if(point)matrix.translate(point);matrix._owner=this;this._style=new Style(project._currentStyle,this,project);if(internal||hasProps&&props.insert==false||!settings.insertItems&&!(hasProps&&props.insert===true)){this._setProject(project);}else{(hasProps&&props.parent||project)._insertItem(undefined,this,true);}if(hasProps&&props!==Item.NO_INSERT){this.set(props,{internal:true,insert:true,project:true,parent:true});}return hasProps;},_serialize:function(options,dictionary){var props={},that=this;function serialize(fields){for(var key in fields){var value=that[key];if(!Base.equals(value,key==='leading'?fields.fontSize*1.2:fields[key])){props[key]=Base.serialize(value,options,key!=='data',dictionary);}}}serialize(this._serializeFields);if(!(this instanceof Group))serialize(this._style._defaults);return[this._class,props];},_changed:function(flags){var symbol=this._symbol,cacheParent=this._parent||symbol,project=this._project;if(flags&8){this._bounds=this._position=this._decomposed=this._globalMatrix=undefined;}if(cacheParent&&flags&40){Item._clearBoundsCache(cacheParent);}if(flags&2){Item._clearBoundsCache(this);}if(project)project._changed(flags,this);if(symbol)symbol._changed(flags);},getId:function(){return this._id;},getName:function(){return this._name;},setName:function(name){if(this._name)this._removeNamed();if(name===+name+'')throw new Error('Names consisting only of numbers are not supported.');var owner=this._getOwner();if(name&&owner){var children=owner._children,namedChildren=owner._namedChildren;(namedChildren[name]=namedChildren[name]||[]).push(this);if(!(name in children))children[name]=this;}this._name=name||undefined;this._changed(128);},getStyle:function(){return this._style;},setStyle:function(style){this.getStyle().set(style);}},Base.each(['locked','visible','blendMode','opacity','guide','enhanceBlendMode'],// Matteo - aggiunto enhanceBlendMode
function(name){var part=Base.capitalize(name),key='_'+name,flags={locked:128,visible:137};this['get'+part]=function(){return this[key];};this['set'+part]=function(value){if(value!=this[key]){this[key]=value;this._changed(flags[name]||129);}};},{}),{beans:true,getSelection:function(){return this._selection;},setSelection:function(selection){if(selection!==this._selection){this._selection=selection;var project=this._project;if(project){project._updateSelection(this);this._changed(129);}}},_changeSelection:function(flag,selected){var selection=this._selection;this.setSelection(selected?selection|flag:selection&~flag);},isSelected:function(){if(this._selectChildren){var children=this._children;for(var i=0,l=children.length;i<l;i++)if(children[i].isSelected())return true;}return!!(this._selection&1);},setSelected:function(selected){if(this._selectChildren){var children=this._children;for(var i=0,l=children.length;i<l;i++)children[i].setSelected(selected);}this._changeSelection(1,selected);},isFullySelected:function(){var children=this._children,selected=!!(this._selection&1);if(children&&selected){for(var i=0,l=children.length;i<l;i++)if(!children[i].isFullySelected())return false;return true;}return selected;},setFullySelected:function(selected){var children=this._children;if(children){for(var i=0,l=children.length;i<l;i++)children[i].setFullySelected(selected);}this._changeSelection(1,selected);},isClipMask:function(){return this._clipMask;},setClipMask:function(clipMask){if(this._clipMask!=(clipMask=!!clipMask)){this._clipMask=clipMask;if(clipMask){this.setFillColor(null);this.setStrokeColor(null);}this._changed(129);if(this._parent)this._parent._changed(1024);}},getData:function(){if(!this._data)this._data={};return this._data;},setData:function(data){this._data=data;},getPosition:function(_dontLink){var position=this._position,ctor=_dontLink?Point:LinkedPoint;if(!position){var pivot=this._pivot;position=this._position=pivot?this._matrix._transformPoint(pivot):this.getBounds().getCenter(true);}return new ctor(position.x,position.y,this,'setPosition');},setPosition:function(){this.translate(Point.read(arguments).subtract(this.getPosition(true)));},getPivot:function(){var pivot=this._pivot;return pivot?new LinkedPoint(pivot.x,pivot.y,this,'setPivot'):null;},setPivot:function(){this._pivot=Point.read(arguments,0,{clone:true,readNull:true});this._position=undefined;}},Base.each({getStrokeBounds:{stroke:true},getHandleBounds:{handle:true},getInternalBounds:{internal:true}},function(options,key){this[key]=function(matrix){return this.getBounds(matrix,options);};},{beans:true,getBounds:function(matrix,options){var hasMatrix=options||matrix instanceof Matrix,opts=Base.set({},hasMatrix?options:matrix,this._boundsOptions);if(!opts.stroke||this.getStrokeScaling())opts.cacheItem=this;var rect=this._getCachedBounds(hasMatrix&&matrix,opts).rect;return!arguments.length?new LinkedRectangle(rect.x,rect.y,rect.width,rect.height,this,'setBounds'):rect;},setBounds:function(){var rect=Rectangle.read(arguments),bounds=this.getBounds(),_matrix=this._matrix,matrix=new Matrix(),center=rect.getCenter();matrix.translate(center);if(rect.width!=bounds.width||rect.height!=bounds.height){if(!_matrix.isInvertible()){_matrix.set(_matrix._backup||new Matrix().translate(_matrix.getTranslation()));bounds=this.getBounds();}matrix.scale(bounds.width!==0?rect.width/bounds.width:0,bounds.height!==0?rect.height/bounds.height:0);}center=bounds.getCenter();matrix.translate(-center.x,-center.y);this.transform(matrix);},_getBounds:function(matrix,options){var children=this._children;if(!children||!children.length)return new Rectangle();Item._updateBoundsCache(this,options.cacheItem);return Item._getBounds(children,matrix,options);},_getBoundsCacheKey:function(options,internal){return[options.stroke?1:0,options.handle?1:0,internal?1:0].join('');},_getCachedBounds:function(matrix,options,noInternal){matrix=matrix&&matrix._orNullIfIdentity();var internal=options.internal&&!noInternal,cacheItem=options.cacheItem,_matrix=internal?null:this._matrix._orNullIfIdentity(),cacheKey=cacheItem&&(!matrix||matrix.equals(_matrix))&&this._getBoundsCacheKey(options,internal),bounds=this._bounds;Item._updateBoundsCache(this._parent||this._symbol,cacheItem);if(cacheKey&&bounds&&cacheKey in bounds){var cached=bounds[cacheKey];return{rect:cached.rect.clone(),nonscaling:cached.nonscaling};}var res=this._getBounds(matrix||_matrix,options),rect=res.rect||res,style=this._style,nonscaling=res.nonscaling||style.hasStroke()&&!style.getStrokeScaling();if(cacheKey){if(!bounds){this._bounds=bounds={};}var cached=bounds[cacheKey]={rect:rect.clone(),nonscaling:nonscaling,internal:internal};}return{rect:rect,nonscaling:nonscaling};},_getStrokeMatrix:function(matrix,options){var parent=this.getStrokeScaling()?null:options&&options.internal?this:this._parent||this._symbol&&this._symbol._item,mx=parent?parent.getViewMatrix().invert():matrix;return mx&&mx._shiftless();},statics:{_updateBoundsCache:function(parent,item){if(parent&&item){var id=item._id,ref=parent._boundsCache=parent._boundsCache||{ids:{},list:[]};if(!ref.ids[id]){ref.list.push(item);ref.ids[id]=item;}}},_clearBoundsCache:function(item){var cache=item._boundsCache;if(cache){item._bounds=item._position=item._boundsCache=undefined;for(var i=0,list=cache.list,l=list.length;i<l;i++){var other=list[i];if(other!==item){other._bounds=other._position=undefined;if(other._boundsCache)Item._clearBoundsCache(other);}}}},_getBounds:function(items,matrix,options){var x1=Infinity,x2=-x1,y1=x1,y2=x2,nonscaling=false;options=options||{};for(var i=0,l=items.length;i<l;i++){var item=items[i];if(item._visible&&!item.isEmpty()){var bounds=item._getCachedBounds(matrix&&matrix.appended(item._matrix),options,true),rect=bounds.rect;x1=Math.min(rect.x,x1);y1=Math.min(rect.y,y1);x2=Math.max(rect.x+rect.width,x2);y2=Math.max(rect.y+rect.height,y2);if(bounds.nonscaling)nonscaling=true;}}return{rect:isFinite(x1)?new Rectangle(x1,y1,x2-x1,y2-y1):new Rectangle(),nonscaling:nonscaling};}}}),{beans:true,_decompose:function(){return this._applyMatrix?null:this._decomposed||(this._decomposed=this._matrix.decompose());},getRotation:function(){var decomposed=this._decompose();return decomposed?decomposed.rotation:0;},setRotation:function(rotation){var current=this.getRotation();if(current!=null&&rotation!=null){var decomposed=this._decomposed;this.rotate(rotation-current);if(decomposed){decomposed.rotation=rotation;this._decomposed=decomposed;}}},getScaling:function(){var decomposed=this._decompose(),s=decomposed&&decomposed.scaling;return new LinkedPoint(s?s.x:1,s?s.y:1,this,'setScaling');},setScaling:function(){var current=this.getScaling(),scaling=Point.read(arguments,0,{clone:true,readNull:true});if(current&&scaling&&!current.equals(scaling)){var rotation=this.getRotation(),decomposed=this._decomposed,matrix=new Matrix(),center=this.getPosition(true);matrix.translate(center);if(rotation)matrix.rotate(rotation);matrix.scale(scaling.x/current.x,scaling.y/current.y);if(rotation)matrix.rotate(-rotation);matrix.translate(center.negate());this.transform(matrix);if(decomposed){decomposed.scaling=scaling;this._decomposed=decomposed;}}},getMatrix:function(){return this._matrix;},setMatrix:function(){var matrix=this._matrix;matrix.initialize.apply(matrix,arguments);},getGlobalMatrix:function(_dontClone){var matrix=this._globalMatrix,updateVersion=this._project._updateVersion;if(matrix&&matrix._updateVersion!==updateVersion)matrix=null;if(!matrix){matrix=this._globalMatrix=this._matrix.clone();var parent=this._parent;if(parent)matrix.prepend(parent.getGlobalMatrix(true));matrix._updateVersion=updateVersion;}return _dontClone?matrix:matrix.clone();},getViewMatrix:function(){return this.getGlobalMatrix().prepend(this.getView()._matrix);},getApplyMatrix:function(){return this._applyMatrix;},setApplyMatrix:function(apply){if(this._applyMatrix=this._canApplyMatrix&&!!apply)this.transform(null,true);},getTransformContent:'#getApplyMatrix',setTransformContent:'#setApplyMatrix'},{getProject:function(){return this._project;},_setProject:function(project,installEvents){if(this._project!==project){if(this._project)this._installEvents(false);this._project=project;var children=this._children;for(var i=0,l=children&&children.length;i<l;i++)children[i]._setProject(project);installEvents=true;}if(installEvents)this._installEvents(true);},getView:function(){return this._project._view;},_installEvents:function _installEvents(install){_installEvents.base.call(this,install);var children=this._children;for(var i=0,l=children&&children.length;i<l;i++)children[i]._installEvents(install);},getLayer:function(){var parent=this;while(parent=parent._parent){if(parent instanceof Layer)return parent;}return null;},getParent:function(){return this._parent;},setParent:function(item){return item.addChild(this);},_getOwner:'#getParent',getChildren:function(){return this._children;},setChildren:function(items){this.removeChildren();this.addChildren(items);},getFirstChild:function(){return this._children&&this._children[0]||null;},getLastChild:function(){return this._children&&this._children[this._children.length-1]||null;},getNextSibling:function(){var owner=this._getOwner();return owner&&owner._children[this._index+1]||null;},getPreviousSibling:function(){var owner=this._getOwner();return owner&&owner._children[this._index-1]||null;},getIndex:function(){return this._index;},equals:function(item){return item===this||item&&this._class===item._class&&this._style.equals(item._style)&&this._matrix.equals(item._matrix)&&this._locked===item._locked&&this._visible===item._visible&&this._blendMode===item._blendMode&&this._opacity===item._opacity&&this._clipMask===item._clipMask&&this._guide===item._guide&&this._equals(item)||false;},_equals:function(item){return Base.equals(this._children,item._children);},clone:function(options){var copy=new this.constructor(Item.NO_INSERT),children=this._children,insert=Base.pick(options?options.insert:undefined,options===undefined||options===true),deep=Base.pick(options?options.deep:undefined,true);if(children)copy.copyAttributes(this);if(!children||deep)copy.copyContent(this);if(!children)copy.copyAttributes(this);if(insert)copy.insertAbove(this);var name=this._name,parent=this._parent;if(name&&parent){var children=parent._children,orig=name,i=1;while(children[name])name=orig+' '+i++;if(name!==orig)copy.setName(name);}return copy;},copyContent:function(source){var children=source._children;for(var i=0,l=children&&children.length;i<l;i++){this.addChild(children[i].clone(false),true);}},copyAttributes:function(source,excludeMatrix){this.setStyle(source._style);var keys=['_locked','_visible','_blendMode','_opacity','_clipMask','_guide','_enhanceBlendMode'];// Matteo - aggiunto enhanceBlendMode
for(var i=0,l=keys.length;i<l;i++){var key=keys[i];if(source.hasOwnProperty(key))this[key]=source[key];}if(!excludeMatrix)this._matrix.set(source._matrix,true);this.setApplyMatrix(source._applyMatrix);this.setPivot(source._pivot);this.setSelection(source._selection);var data=source._data,name=source._name;this._data=data?Base.clone(data):null;if(name)this.setName(name);},rasterize:function(resolution,insert){var bounds=this.getStrokeBounds(),scale=(resolution||this.getView().getResolution())/72,topLeft=bounds.getTopLeft().floor(),bottomRight=bounds.getBottomRight().ceil(),size=new Size(bottomRight.subtract(topLeft)),raster=new Raster(Item.NO_INSERT);if(!size.isZero()){var canvas=CanvasProvider.getCanvas(size.multiply(scale)),ctx=canvas.getContext('2d'),matrix=new Matrix().scale(scale).translate(topLeft.negate());ctx.save();matrix.applyToContext(ctx);this.draw(ctx,new Base({matrices:[matrix]}));ctx.restore();raster.setCanvas(canvas);}raster.transform(new Matrix().translate(topLeft.add(size.divide(2))).scale(1/scale));if(insert===undefined||insert)raster.insertAbove(this);return raster;},contains:function(){return!!this._contains(this._matrix._inverseTransform(Point.read(arguments)));},_contains:function(point){var children=this._children;if(children){for(var i=children.length-1;i>=0;i--){if(children[i].contains(point))return true;}return false;}return point.isInside(this.getInternalBounds());},isInside:function(){return Rectangle.read(arguments).contains(this.getBounds());},_asPathItem:function(){return new Path.Rectangle({rectangle:this.getInternalBounds(),matrix:this._matrix,insert:false});},intersects:function(item,_matrix){if(!(item instanceof Item))return false;return this._asPathItem().getIntersections(item._asPathItem(),null,_matrix,true).length>0;}},new function(){function hitTest(){return this._hitTest(Point.read(arguments),HitResult.getOptions(arguments));}function hitTestAll(){var point=Point.read(arguments),options=HitResult.getOptions(arguments),all=[];this._hitTest(point,Base.set({all:all},options));return all;}function hitTestChildren(point,options,viewMatrix,_exclude){var children=this._children;if(children){for(var i=children.length-1;i>=0;i--){var child=children[i];var res=child!==_exclude&&child._hitTest(point,options,viewMatrix);if(res&&!options.all)return res;}}return null;}Project.inject({hitTest:hitTest,hitTestAll:hitTestAll,_hitTest:hitTestChildren});return{hitTest:hitTest,hitTestAll:hitTestAll,_hitTestChildren:hitTestChildren};}(),{_hitTest:function(point,options,parentViewMatrix){if(this._locked||!this._visible||this._guide&&!options.guides||this.isEmpty()){return null;}var matrix=this._matrix,viewMatrix=parentViewMatrix?parentViewMatrix.appended(matrix):this.getGlobalMatrix().prepend(this.getView()._matrix),tolerance=Math.max(options.tolerance,1e-12),tolerancePadding=options._tolerancePadding=new Size(Path._getStrokePadding(tolerance,matrix._shiftless().invert()));point=matrix._inverseTransform(point);if(!point||!this._children&&!this.getBounds({internal:true,stroke:true,handle:true}).expand(tolerancePadding.multiply(2))._containsPoint(point)){return null;}var checkSelf=!(options.guides&&!this._guide||options.selected&&!this.isSelected()||options.type&&options.type!==Base.hyphenate(this._class)||options.class&&!(this instanceof options.class)),match=options.match,that=this,bounds,res;function filter(hit){if(hit&&match&&!match(hit))hit=null;if(hit&&options.all)options.all.push(hit);return hit;}function checkPoint(type,part){var pt=part?bounds['get'+part]():that.getPosition();if(point.subtract(pt).divide(tolerancePadding).length<=1){return new HitResult(type,that,{name:part?Base.hyphenate(part):type,point:pt});}}var checkPosition=options.position,checkCenter=options.center,checkBounds=options.bounds;if(checkSelf&&this._parent&&(checkPosition||checkCenter||checkBounds)){if(checkCenter||checkBounds){bounds=this.getInternalBounds();}res=checkPosition&&checkPoint('position')||checkCenter&&checkPoint('center','Center');if(!res&&checkBounds){var points=['TopLeft','TopRight','BottomLeft','BottomRight','LeftCenter','TopCenter','RightCenter','BottomCenter'];for(var i=0;i<8&&!res;i++){res=checkPoint('bounds',points[i]);}}res=filter(res);}if(!res){res=this._hitTestChildren(point,options,viewMatrix)||checkSelf&&filter(this._hitTestSelf(point,options,viewMatrix,this.getStrokeScaling()?null:viewMatrix._shiftless().invert()))||null;}if(res&&res.point){res.point=matrix.transform(res.point);}return res;},_hitTestSelf:function(point,options){if(options.fill&&this.hasFill()&&this._contains(point))return new HitResult('fill',this);},matches:function(name,compare){function matchObject(obj1,obj2){for(var i in obj1){if(obj1.hasOwnProperty(i)){var val1=obj1[i],val2=obj2[i];if(Base.isPlainObject(val1)&&Base.isPlainObject(val2)){if(!matchObject(val1,val2))return false;}else if(!Base.equals(val1,val2)){return false;}}}return true;}var type=typeof name;if(type==='object'){for(var key in name){if(name.hasOwnProperty(key)&&!this.matches(key,name[key]))return false;}return true;}else if(type==='function'){return name(this);}else if(name==='match'){return compare(this);}else{var value=/^(empty|editable)$/.test(name)?this['is'+Base.capitalize(name)]():name==='type'?Base.hyphenate(this._class):this[name];if(name==='class'){if(typeof compare==='function')return this instanceof compare;value=this._class;}if(typeof compare==='function'){return!!compare(value);}else if(compare){if(compare.test){return compare.test(value);}else if(Base.isPlainObject(compare)){return matchObject(compare,value);}}return Base.equals(value,compare);}},getItems:function(options){return Item._getItems(this,options,this._matrix);},getItem:function(options){return Item._getItems(this,options,this._matrix,null,true)[0]||null;},statics:{_getItems:function _getItems(item,options,matrix,param,firstOnly){if(!param){var obj=typeof options==='object'&&options,overlapping=obj&&obj.overlapping,inside=obj&&obj.inside,bounds=overlapping||inside,rect=bounds&&Rectangle.read([bounds]);param={items:[],recursive:obj&&obj.recursive!==false,inside:!!inside,overlapping:!!overlapping,rect:rect,path:overlapping&&new Path.Rectangle({rectangle:rect,insert:false})};if(obj){options=Base.filter({},options,{recursive:true,inside:true,overlapping:true});}}var children=item._children,items=param.items,rect=param.rect;matrix=rect&&(matrix||new Matrix());for(var i=0,l=children&&children.length;i<l;i++){var child=children[i],childMatrix=matrix&&matrix.appended(child._matrix),add=true;if(rect){var bounds=child.getBounds(childMatrix);if(!rect.intersects(bounds))continue;if(!(rect.contains(bounds)||param.overlapping&&(bounds.contains(rect)||param.path.intersects(child,childMatrix))))add=false;}if(add&&child.matches(options)){items.push(child);if(firstOnly)break;}if(param.recursive!==false){_getItems(child,options,childMatrix,param,firstOnly);}if(firstOnly&&items.length>0)break;}return items;}}},{importJSON:function(json){var res=Base.importJSON(json,this);return res!==this?this.addChild(res):res;},addChild:function(item){return this.insertChild(undefined,item);},insertChild:function(index,item){var res=item?this.insertChildren(index,[item]):null;return res&&res[0];},addChildren:function(items){return this.insertChildren(this._children.length,items);},insertChildren:function(index,items){var children=this._children;if(children&&items&&items.length>0){items=Base.slice(items);var inserted={};for(var i=items.length-1;i>=0;i--){var item=items[i],id=item&&item._id;if(!item||inserted[id]){items.splice(i,1);}else{item._remove(false,true);inserted[id]=true;}}Base.splice(children,items,index,0);var project=this._project,notifySelf=project._changes;for(var i=0,l=items.length;i<l;i++){var item=items[i],name=item._name;item._parent=this;item._setProject(project,true);if(name)item.setName(name);if(notifySelf)item._changed(5);}this._changed(11);}else{items=null;}return items;},_insertItem:'#insertChild',_insertAt:function(item,offset){var owner=item&&item._getOwner(),res=item!==this&&owner?this:null;if(res){res._remove(false,true);owner._insertItem(item._index+offset,res);}return res;},insertAbove:function(item){return this._insertAt(item,1);},insertBelow:function(item){return this._insertAt(item,0);},sendToBack:function(){var owner=this._getOwner();return owner?owner._insertItem(0,this):null;},bringToFront:function(){var owner=this._getOwner();return owner?owner._insertItem(undefined,this):null;},appendTop:'#addChild',appendBottom:function(item){return this.insertChild(0,item);},moveAbove:'#insertAbove',moveBelow:'#insertBelow',addTo:function(owner){return owner._insertItem(undefined,this);},copyTo:function(owner){return this.clone(false).addTo(owner);},reduce:function(options){var children=this._children;if(children&&children.length===1){var child=children[0].reduce(options);if(this._parent){child.insertAbove(this);this.remove();}else{child.remove();}return child;}return this;},_removeNamed:function(){var owner=this._getOwner();if(owner){var children=owner._children,namedChildren=owner._namedChildren,name=this._name,namedArray=namedChildren[name],index=namedArray?namedArray.indexOf(this):-1;if(index!==-1){if(children[name]==this)delete children[name];namedArray.splice(index,1);if(namedArray.length){children[name]=namedArray[0];}else{delete namedChildren[name];}}}},_remove:function(notifySelf,notifyParent){var owner=this._getOwner(),project=this._project,index=this._index;if(owner){if(this._name)this._removeNamed();if(index!=null){if(project._activeLayer===this)project._activeLayer=this.getNextSibling()||this.getPreviousSibling();Base.splice(owner._children,null,index,1);}this._installEvents(false);if(notifySelf&&project._changes)this._changed(5);if(notifyParent)owner._changed(11,this);this._parent=null;return true;}return false;},remove:function(){return this._remove(true,true);},replaceWith:function(item){var ok=item&&item.insertBelow(this);if(ok)this.remove();return ok;},removeChildren:function(start,end){if(!this._children)return null;start=start||0;end=Base.pick(end,this._children.length);var removed=Base.splice(this._children,null,start,end-start);for(var i=removed.length-1;i>=0;i--){removed[i]._remove(true,false);}if(removed.length>0)this._changed(11);return removed;},clear:'#removeChildren',reverseChildren:function(){if(this._children){this._children.reverse();for(var i=0,l=this._children.length;i<l;i++)this._children[i]._index=i;this._changed(11);}},isEmpty:function(){var children=this._children;return!children||!children.length;},isEditable:function(){var item=this;while(item){if(!item._visible||item._locked)return false;item=item._parent;}return true;},hasFill:function(){return this.getStyle().hasFill();},hasStroke:function(){return this.getStyle().hasStroke();},hasShadow:function(){return this.getStyle().hasShadow();},_getOrder:function(item){function getList(item){var list=[];do{list.unshift(item);}while(item=item._parent);return list;}var list1=getList(this),list2=getList(item);for(var i=0,l=Math.min(list1.length,list2.length);i<l;i++){if(list1[i]!=list2[i]){return list1[i]._index<list2[i]._index?1:-1;}}return 0;},hasChildren:function(){return this._children&&this._children.length>0;},isInserted:function(){return this._parent?this._parent.isInserted():false;},isAbove:function(item){return this._getOrder(item)===-1;},isBelow:function(item){return this._getOrder(item)===1;},isParent:function(item){return this._parent===item;},isChild:function(item){return item&&item._parent===this;},isDescendant:function(item){var parent=this;while(parent=parent._parent){if(parent===item)return true;}return false;},isAncestor:function(item){return item?item.isDescendant(this):false;},isSibling:function(item){return this._parent===item._parent;},isGroupedWith:function(item){var parent=this._parent;while(parent){if(parent._parent&&/^(Group|Layer|CompoundPath)$/.test(parent._class)&&item.isDescendant(parent))return true;parent=parent._parent;}return false;}},Base.each(['rotate','scale','shear','skew'],function(key){var rotate=key==='rotate';this[key]=function(){var value=(rotate?Base:Point).read(arguments),center=Point.read(arguments,0,{readNull:true});return this.transform(new Matrix()[key](value,center||this.getPosition(true)));};},{translate:function(){var mx=new Matrix();return this.transform(mx.translate.apply(mx,arguments));},transform:function(matrix,_applyMatrix,_applyRecursively,_setApplyMatrix){var _matrix=this._matrix,transform=matrix&&!matrix.isIdentity(),applyMatrix=(_applyMatrix||this._applyMatrix)&&(!_matrix.isIdentity()||transform||_applyMatrix&&_applyRecursively&&this._children);if(!transform&&!applyMatrix)return this;if(transform){if(!matrix.isInvertible()&&_matrix.isInvertible())_matrix._backup=_matrix.getValues();_matrix.prepend(matrix,true);var style=this._style,fillColor=style.getFillColor(true),strokeColor=style.getStrokeColor(true);if(fillColor)fillColor.transform(matrix);if(strokeColor)strokeColor.transform(matrix);}if(applyMatrix&&(applyMatrix=this._transformContent(_matrix,_applyRecursively,_setApplyMatrix))){var pivot=this._pivot;if(pivot)_matrix._transformPoint(pivot,pivot,true);_matrix.reset(true);if(_setApplyMatrix&&this._canApplyMatrix)this._applyMatrix=true;}var bounds=this._bounds,position=this._position;if(transform||applyMatrix){this._changed(9);}var decomp=transform&&bounds&&matrix.decompose();if(decomp&&decomp.skewing.isZero()&&decomp.rotation%90===0){for(var key in bounds){var cache=bounds[key];if(cache.nonscaling){delete bounds[key];}else if(applyMatrix||!cache.internal){var rect=cache.rect;matrix._transformBounds(rect,rect);}}this._bounds=bounds;var cached=bounds[this._getBoundsCacheKey(this._boundsOptions||{})];if(cached){this._position=cached.rect.getCenter(true);}}else if(transform&&position&&this._pivot){this._position=matrix._transformPoint(position,position);}return this;},_transformContent:function(matrix,applyRecursively,setApplyMatrix){var children=this._children;if(children){for(var i=0,l=children.length;i<l;i++)children[i].transform(matrix,true,applyRecursively,setApplyMatrix);return true;}},globalToLocal:function(){return this.getGlobalMatrix(true)._inverseTransform(Point.read(arguments));},localToGlobal:function(){return this.getGlobalMatrix(true)._transformPoint(Point.read(arguments));},parentToLocal:function(){return this._matrix._inverseTransform(Point.read(arguments));},localToParent:function(){return this._matrix._transformPoint(Point.read(arguments));},fitBounds:function(rectangle,fill){rectangle=Rectangle.read(arguments);var bounds=this.getBounds(),itemRatio=bounds.height/bounds.width,rectRatio=rectangle.height/rectangle.width,scale=(fill?itemRatio>rectRatio:itemRatio<rectRatio)?rectangle.width/bounds.width:rectangle.height/bounds.height,newBounds=new Rectangle(new Point(),new Size(bounds.width*scale,bounds.height*scale));newBounds.setCenter(rectangle.getCenter());this.setBounds(newBounds);}}),{_setStyles:function(ctx,param,viewMatrix){var style=this._style,matrix=this._matrix;if(style.hasFill()){ctx.fillStyle=style.getFillColor().toCanvasStyle(ctx,matrix);}if(style.hasStroke()){ctx.strokeStyle=style.getStrokeColor().toCanvasStyle(ctx,matrix);ctx.lineWidth=style.getStrokeWidth();var strokeJoin=style.getStrokeJoin(),strokeCap=style.getStrokeCap(),miterLimit=style.getMiterLimit();if(strokeJoin)ctx.lineJoin=strokeJoin;if(strokeCap)ctx.lineCap=strokeCap;if(miterLimit)ctx.miterLimit=miterLimit;if(paper.support.nativeDash){var dashArray=style.getDashArray(),dashOffset=style.getDashOffset();if(dashArray&&dashArray.length){if('setLineDash'in ctx){ctx.setLineDash(dashArray);ctx.lineDashOffset=dashOffset;}else{ctx.mozDash=dashArray;ctx.mozDashOffset=dashOffset;}}}}if(style.hasShadow()){var pixelRatio=param.pixelRatio||1,mx=viewMatrix._shiftless().prepend(new Matrix().scale(pixelRatio,pixelRatio)),blur=mx.transform(new Point(style.getShadowBlur(),0)),offset=mx.transform(this.getShadowOffset());ctx.shadowColor=style.getShadowColor().toCanvasStyle(ctx);ctx.shadowBlur=blur.getLength();ctx.shadowOffsetX=offset.x;ctx.shadowOffsetY=offset.y;}},draw:function(ctx,param,parentStrokeMatrix){var updateVersion=this._updateVersion=this._project._updateVersion;if(!this._visible||this._opacity===0)return;var matrices=param.matrices,viewMatrix=param.viewMatrix,matrix=this._matrix,globalMatrix=matrices[matrices.length-1].appended(matrix);if(!globalMatrix.isInvertible())return;viewMatrix=viewMatrix?viewMatrix.appended(globalMatrix):globalMatrix;matrices.push(globalMatrix);if(param.updateMatrix){globalMatrix._updateVersion=updateVersion;this._globalMatrix=globalMatrix;}var enhanceBlendMode=this._enhanceBlendMode;// Matteo
var blendMode=this._blendMode,opacity=this._opacity,normalBlend=blendMode==='normal',nativeBlend=BlendMode.nativeModes[blendMode],direct=normalBlend&&opacity===1||param.dontStart||param.clip||(nativeBlend||normalBlend&&opacity<1)&&this._canComposite(),pixelRatio=param.pixelRatio||1,mainCtx,itemOffset,prevOffset;if(!direct){var bounds=this.getStrokeBounds(viewMatrix);if(!bounds.width||!bounds.height)return;prevOffset=param.offset;itemOffset=param.offset=bounds.getTopLeft().floor();mainCtx=ctx;ctx=CanvasProvider.getContext(bounds.getSize().ceil().add(1).multiply(pixelRatio));if(pixelRatio!==1)ctx.scale(pixelRatio,pixelRatio);}ctx.save();var strokeMatrix=parentStrokeMatrix?parentStrokeMatrix.appended(matrix):this._canScaleStroke&&!this.getStrokeScaling(true)&&viewMatrix,clip=!direct&&param.clipItem,transform=!strokeMatrix||clip;if(direct){ctx.globalAlpha=opacity;if(nativeBlend)ctx.globalCompositeOperation=blendMode;}else if(transform){ctx.translate(-itemOffset.x,-itemOffset.y);}if(transform){(direct?matrix:viewMatrix).applyToContext(ctx);}if(clip){param.clipItem.draw(ctx,param.extend({clip:true}));}if(strokeMatrix){ctx.setTransform(pixelRatio,0,0,pixelRatio,0,0);var offset=param.offset;if(offset)ctx.translate(-offset.x,-offset.y);}this._draw(ctx,param,viewMatrix,strokeMatrix);// Matteo - Test enhanced blend mode
if(direct&&blendMode!="normal"&&enhanceBlendMode){this._draw(ctx,param,viewMatrix,strokeMatrix);}ctx.restore();matrices.pop();if(param.clip&&!param.dontFinish)ctx.clip();if(!direct){BlendMode.process(blendMode,ctx,mainCtx,opacity,itemOffset.subtract(prevOffset).multiply(pixelRatio));// Matteo - Test enhanced blend mode
if(blendMode!="normal"&&enhanceBlendMode){BlendMode.process(blendMode,ctx,mainCtx,opacity,itemOffset.subtract(prevOffset).multiply(pixelRatio));}CanvasProvider.release(ctx);param.offset=prevOffset;}},_isUpdated:function(updateVersion){var parent=this._parent;if(parent instanceof CompoundPath)return parent._isUpdated(updateVersion);var updated=this._updateVersion===updateVersion;if(!updated&&parent&&parent._visible&&parent._isUpdated(updateVersion)){this._updateVersion=updateVersion;updated=true;}return updated;},_drawSelection:function(ctx,matrix,size,selectionItems,updateVersion){var selection=this._selection,itemSelected=selection&1,boundsSelected=selection&2||itemSelected&&this._selectBounds,positionSelected=selection&4;if(!this._drawSelected)itemSelected=false;if((itemSelected||boundsSelected||positionSelected)&&this._isUpdated(updateVersion)){var layer,color=this.getSelectedColor(true)||(layer=this.getLayer())&&layer.getSelectedColor(true),mx=matrix.appended(this.getGlobalMatrix(true)),half=size/2;ctx.strokeStyle=ctx.fillStyle=color?color.toCanvasStyle(ctx):'#009dec';if(itemSelected)this._drawSelected(ctx,mx,selectionItems);if(positionSelected){var point=this.getPosition(true),x=point.x,y=point.y;ctx.beginPath();ctx.arc(x,y,half,0,Math.PI*2,true);ctx.stroke();var deltas=[[0,-1],[1,0],[0,1],[-1,0]],start=half,end=size+1;for(var i=0;i<4;i++){var delta=deltas[i],dx=delta[0],dy=delta[1];ctx.moveTo(x+dx*start,y+dy*start);ctx.lineTo(x+dx*end,y+dy*end);ctx.stroke();}}if(boundsSelected){var coords=mx._transformCorners(this.getInternalBounds());ctx.beginPath();for(var i=0;i<8;i++){ctx[!i?'moveTo':'lineTo'](coords[i],coords[++i]);}ctx.closePath();ctx.stroke();for(var i=0;i<8;i++){ctx.fillRect(coords[i]-half,coords[++i]-half,size,size);}}}},_canComposite:function(){return false;}},Base.each(['down','drag','up','move'],function(key){this['removeOn'+Base.capitalize(key)]=function(){var hash={};hash[key]=true;return this.removeOn(hash);};},{removeOn:function(obj){for(var name in obj){if(obj[name]){var key='mouse'+name,project=this._project,sets=project._removeSets=project._removeSets||{};sets[key]=sets[key]||{};sets[key][this._id]=this;}}return this;}}));var Group=Item.extend({_class:'Group',_selectBounds:false,_selectChildren:true,_serializeFields:{children:[]},initialize:function Group(arg){this._children=[];this._namedChildren={};if(!this._initialize(arg))this.addChildren(Array.isArray(arg)?arg:arguments);},_changed:function _changed(flags){_changed.base.call(this,flags);if(flags&1026){this._clipItem=undefined;}},_getClipItem:function(){var clipItem=this._clipItem;if(clipItem===undefined){clipItem=null;var children=this._children;for(var i=0,l=children.length;i<l;i++){if(children[i]._clipMask){clipItem=children[i];break;}}this._clipItem=clipItem;}return clipItem;},isClipped:function(){return!!this._getClipItem();},setClipped:function(clipped){var child=this.getFirstChild();if(child)child.setClipMask(clipped);},_getBounds:function _getBounds(matrix,options){var clipItem=this._getClipItem();return clipItem?clipItem._getCachedBounds(matrix&&matrix.appended(clipItem._matrix),Base.set({},options,{stroke:false})):_getBounds.base.call(this,matrix,options);},_hitTestChildren:function _hitTestChildren(point,options,viewMatrix){var clipItem=this._getClipItem();return(!clipItem||clipItem.contains(point))&&_hitTestChildren.base.call(this,point,options,viewMatrix,clipItem);},_draw:function(ctx,param){var clip=param.clip,clipItem=!clip&&this._getClipItem();param=param.extend({clipItem:clipItem,clip:false});if(clip){ctx.beginPath();param.dontStart=param.dontFinish=true;}else if(clipItem){clipItem.draw(ctx,param.extend({clip:true}));}var children=this._children;for(var i=0,l=children.length;i<l;i++){var item=children[i];if(item!==clipItem)item.draw(ctx,param);}}});var Layer=Group.extend({_class:'Layer',initialize:function Layer(){Group.apply(this,arguments);},_getOwner:function(){return this._parent||this._index!=null&&this._project;},isInserted:function isInserted(){return this._parent?isInserted.base.call(this):this._index!=null;},activate:function(){this._project._activeLayer=this;},_hitTestSelf:function(){}});var Shape=Item.extend({_class:'Shape',_applyMatrix:false,_canApplyMatrix:false,_canScaleStroke:true,_serializeFields:{type:null,size:null,radius:null},initialize:function Shape(props,point){this._initialize(props,point);},_equals:function(item){return this._type===item._type&&this._size.equals(item._size)&&Base.equals(this._radius,item._radius);},copyContent:function(source){this.setType(source._type);this.setSize(source._size);this.setRadius(source._radius);},getType:function(){return this._type;},setType:function(type){this._type=type;},getShape:'#getType',setShape:'#setType',getSize:function(){var size=this._size;return new LinkedSize(size.width,size.height,this,'setSize');},setSize:function(){var size=Size.read(arguments);if(!this._size){this._size=size.clone();}else if(!this._size.equals(size)){var type=this._type,width=size.width,height=size.height;if(type==='rectangle'){this._radius.set(Size.min(this._radius,size.divide(2)));}else if(type==='circle'){width=height=(width+height)/2;this._radius=width/2;}else if(type==='ellipse'){this._radius._set(width/2,height/2);}this._size._set(width,height);this._changed(9);}},getRadius:function(){var rad=this._radius;return this._type==='circle'?rad:new LinkedSize(rad.width,rad.height,this,'setRadius');},setRadius:function(radius){var type=this._type;if(type==='circle'){if(radius===this._radius)return;var size=radius*2;this._radius=radius;this._size._set(size,size);}else{radius=Size.read(arguments);if(!this._radius){this._radius=radius.clone();}else{if(this._radius.equals(radius))return;this._radius.set(radius);if(type==='rectangle'){var size=Size.max(this._size,radius.multiply(2));this._size.set(size);}else if(type==='ellipse'){this._size._set(radius.width*2,radius.height*2);}}}this._changed(9);},isEmpty:function(){return false;},toPath:function(insert){var path=new Path[Base.capitalize(this._type)]({center:new Point(),size:this._size,radius:this._radius,insert:false});path.copyAttributes(this);if(paper.settings.applyMatrix)path.setApplyMatrix(true);if(insert===undefined||insert)path.insertAbove(this);return path;},toShape:'#clone',_asPathItem:function(){return this.toPath(false);},_draw:function(ctx,param,viewMatrix,strokeMatrix){var style=this._style,hasFill=style.hasFill(),hasStroke=style.hasStroke(),dontPaint=param.dontFinish||param.clip,untransformed=!strokeMatrix;if(hasFill||hasStroke||dontPaint){var type=this._type,radius=this._radius,isCircle=type==='circle';if(!param.dontStart)ctx.beginPath();if(untransformed&&isCircle){ctx.arc(0,0,radius,0,Math.PI*2,true);}else{var rx=isCircle?radius:radius.width,ry=isCircle?radius:radius.height,size=this._size,width=size.width,height=size.height;if(untransformed&&type==='rectangle'&&rx===0&&ry===0){ctx.rect(-width/2,-height/2,width,height);}else{var x=width/2,y=height/2,kappa=1-0.5522847498307936,cx=rx*kappa,cy=ry*kappa,c=[-x,-y+ry,-x,-y+cy,-x+cx,-y,-x+rx,-y,x-rx,-y,x-cx,-y,x,-y+cy,x,-y+ry,x,y-ry,x,y-cy,x-cx,y,x-rx,y,-x+rx,y,-x+cx,y,-x,y-cy,-x,y-ry];if(strokeMatrix)strokeMatrix.transform(c,c,32);ctx.moveTo(c[0],c[1]);ctx.bezierCurveTo(c[2],c[3],c[4],c[5],c[6],c[7]);if(x!==rx)ctx.lineTo(c[8],c[9]);ctx.bezierCurveTo(c[10],c[11],c[12],c[13],c[14],c[15]);if(y!==ry)ctx.lineTo(c[16],c[17]);ctx.bezierCurveTo(c[18],c[19],c[20],c[21],c[22],c[23]);if(x!==rx)ctx.lineTo(c[24],c[25]);ctx.bezierCurveTo(c[26],c[27],c[28],c[29],c[30],c[31]);}}ctx.closePath();}if(!dontPaint&&(hasFill||hasStroke)){this._setStyles(ctx,param,viewMatrix);if(hasFill){ctx.fill(style.getFillRule());ctx.shadowColor='rgba(0,0,0,0)';}if(hasStroke)ctx.stroke();}},_canComposite:function(){return!(this.hasFill()&&this.hasStroke());},_getBounds:function(matrix,options){var rect=new Rectangle(this._size).setCenter(0,0),style=this._style,strokeWidth=options.stroke&&style.hasStroke()&&style.getStrokeWidth();if(matrix)rect=matrix._transformBounds(rect);return strokeWidth?rect.expand(Path._getStrokePadding(strokeWidth,this._getStrokeMatrix(matrix,options))):rect;}},new function(){function getCornerCenter(that,point,expand){var radius=that._radius;if(!radius.isZero()){var halfSize=that._size.divide(2);for(var q=1;q<=4;q++){var dir=new Point(q>1&&q<4?-1:1,q>2?-1:1),corner=dir.multiply(halfSize),center=corner.subtract(dir.multiply(radius)),rect=new Rectangle(expand?corner.add(dir.multiply(expand)):corner,center);if(rect.contains(point))return{point:center,quadrant:q};}}}function isOnEllipseStroke(point,radius,padding,quadrant){var vector=point.divide(radius);return(!quadrant||vector.isInQuadrant(quadrant))&&vector.subtract(vector.normalize()).multiply(radius).divide(padding).length<=1;}return{_contains:function _contains(point){if(this._type==='rectangle'){var center=getCornerCenter(this,point);return center?point.subtract(center.point).divide(this._radius).getLength()<=1:_contains.base.call(this,point);}else{return point.divide(this.size).getLength()<=0.5;}},_hitTestSelf:function _hitTestSelf(point,options,viewMatrix,strokeMatrix){var hit=false,style=this._style,hitStroke=options.stroke&&style.hasStroke(),hitFill=options.fill&&style.hasFill();if(hitStroke||hitFill){var type=this._type,radius=this._radius,strokeRadius=hitStroke?style.getStrokeWidth()/2:0,strokePadding=options._tolerancePadding.add(Path._getStrokePadding(strokeRadius,!style.getStrokeScaling()&&strokeMatrix));if(type==='rectangle'){var padding=strokePadding.multiply(2),center=getCornerCenter(this,point,padding);if(center){hit=isOnEllipseStroke(point.subtract(center.point),radius,strokePadding,center.quadrant);}else{var rect=new Rectangle(this._size).setCenter(0,0),outer=rect.expand(padding),inner=rect.expand(padding.negate());hit=outer._containsPoint(point)&&!inner._containsPoint(point);}}else{hit=isOnEllipseStroke(point,radius,strokePadding);}}return hit?new HitResult(hitStroke?'stroke':'fill',this):_hitTestSelf.base.apply(this,arguments);}};}(),{statics:new function(){function createShape(type,point,size,radius,args){var item=new Shape(Base.getNamed(args),point);item._type=type;item._size=size;item._radius=radius;return item;}return{Circle:function(){var center=Point.readNamed(arguments,'center'),radius=Base.readNamed(arguments,'radius');return createShape('circle',center,new Size(radius*2),radius,arguments);},Rectangle:function(){var rect=Rectangle.readNamed(arguments,'rectangle'),radius=Size.min(Size.readNamed(arguments,'radius'),rect.getSize(true).divide(2));return createShape('rectangle',rect.getCenter(true),rect.getSize(true),radius,arguments);},Ellipse:function(){var ellipse=Shape._readEllipse(arguments),radius=ellipse.radius;return createShape('ellipse',ellipse.center,radius.multiply(2),radius,arguments);},_readEllipse:function(args){var center,radius;if(Base.hasNamed(args,'radius')){center=Point.readNamed(args,'center');radius=Size.readNamed(args,'radius');}else{var rect=Rectangle.readNamed(args,'rectangle');center=rect.getCenter(true);radius=rect.getSize(true).divide(2);}return{center:center,radius:radius};}};}()});var Raster=Item.extend({_class:'Raster',_applyMatrix:false,_canApplyMatrix:false,_boundsOptions:{stroke:false,handle:false},_serializeFields:{crossOrigin:null,source:null},_prioritize:['crossOrigin'],initialize:function Raster(object,position){if(!this._initialize(object,position!==undefined&&Point.read(arguments,1))){var image=typeof object==='string'?document.getElementById(object):object;if(image){this.setImage(image);}else{this.setSource(object);}}if(!this._size){this._size=new Size();this._loaded=false;}},_equals:function(item){return this.getSource()===item.getSource();},copyContent:function(source){var image=source._image,canvas=source._canvas;if(image){this._setImage(image);}else if(canvas){var copyCanvas=CanvasProvider.getCanvas(source._size);copyCanvas.getContext('2d').drawImage(canvas,0,0);this._setImage(copyCanvas);}this._crossOrigin=source._crossOrigin;},getSize:function(){var size=this._size;return new LinkedSize(size?size.width:0,size?size.height:0,this,'setSize');},setSize:function(){var size=Size.read(arguments);if(!size.equals(this._size)){if(size.width>0&&size.height>0){var element=this.getElement();this._setImage(CanvasProvider.getCanvas(size));if(element)this.getContext(true).drawImage(element,0,0,size.width,size.height);}else{if(this._canvas)CanvasProvider.release(this._canvas);this._size=size.clone();}}},getWidth:function(){return this._size?this._size.width:0;},setWidth:function(width){this.setSize(width,this.getHeight());},getHeight:function(){return this._size?this._size.height:0;},setHeight:function(height){this.setSize(this.getWidth(),height);},getLoaded:function(){return this._loaded;},isEmpty:function(){var size=this._size;return!size||size.width===0&&size.height===0;},getResolution:function(){var matrix=this._matrix,orig=new Point(0,0).transform(matrix),u=new Point(1,0).transform(matrix).subtract(orig),v=new Point(0,1).transform(matrix).subtract(orig);return new Size(72/u.getLength(),72/v.getLength());},getPpi:'#getResolution',getImage:function(){return this._image;},setImage:function(image){var that=this;function emit(event){var view=that.getView(),type=event&&event.type||'load';if(view&&that.responds(type)){paper=view._scope;that.emit(type,new Event(event));}}this._setImage(image);if(this._loaded){setTimeout(emit,0);}else if(image){DomEvent.add(image,{load:function(event){that._setImage(image);emit(event);},error:emit});}},_setImage:function(image){if(this._canvas)CanvasProvider.release(this._canvas);if(image&&image.getContext){this._image=null;this._canvas=image;this._loaded=true;}else{this._image=image;this._canvas=null;this._loaded=!!(image&&image.src&&image.complete);}this._size=new Size(image?image.naturalWidth||image.width:0,image?image.naturalHeight||image.height:0);this._context=null;this._changed(521);},getCanvas:function(){if(!this._canvas){var ctx=CanvasProvider.getContext(this._size);try{if(this._image)ctx.drawImage(this._image,0,0);this._canvas=ctx.canvas;}catch(e){CanvasProvider.release(ctx);}}return this._canvas;},setCanvas:'#setImage',getContext:function(modify){if(!this._context)this._context=this.getCanvas().getContext('2d');if(modify){this._image=null;this._changed(513);}return this._context;},setContext:function(context){this._context=context;},getSource:function(){var image=this._image;return image&&image.src||this.toDataURL();},setSource:function(src){var image=new self.Image(),crossOrigin=this._crossOrigin;if(crossOrigin)image.crossOrigin=crossOrigin;image.src=src;this.setImage(image);},getCrossOrigin:function(){var image=this._image;return image&&image.crossOrigin||this._crossOrigin||'';},setCrossOrigin:function(crossOrigin){this._crossOrigin=crossOrigin;var image=this._image;if(image)image.crossOrigin=crossOrigin;},getElement:function(){return this._canvas||this._loaded&&this._image;}},{beans:false,getSubCanvas:function(){var rect=Rectangle.read(arguments),ctx=CanvasProvider.getContext(rect.getSize());ctx.drawImage(this.getCanvas(),rect.x,rect.y,rect.width,rect.height,0,0,rect.width,rect.height);return ctx.canvas;},getSubRaster:function(){var rect=Rectangle.read(arguments),raster=new Raster(Item.NO_INSERT);raster._setImage(this.getSubCanvas(rect));raster.translate(rect.getCenter().subtract(this.getSize().divide(2)));raster._matrix.prepend(this._matrix);raster.insertAbove(this);return raster;},toDataURL:function(){var image=this._image,src=image&&image.src;if(/^data:/.test(src))return src;var canvas=this.getCanvas();return canvas?canvas.toDataURL.apply(canvas,arguments):null;},drawImage:function(image){var point=Point.read(arguments,1);this.getContext(true).drawImage(image,point.x,point.y);},getAverageColor:function(object){var bounds,path;if(!object){bounds=this.getBounds();}else if(object instanceof PathItem){path=object;bounds=object.getBounds();}else if(typeof object==='object'){if('width'in object){bounds=new Rectangle(object);}else if('x'in object){bounds=new Rectangle(object.x-0.5,object.y-0.5,1,1);}}if(!bounds)return null;var sampleSize=32,width=Math.min(bounds.width,sampleSize),height=Math.min(bounds.height,sampleSize);var ctx=Raster._sampleContext;if(!ctx){ctx=Raster._sampleContext=CanvasProvider.getContext(new Size(sampleSize));}else{ctx.clearRect(0,0,sampleSize+1,sampleSize+1);}ctx.save();var matrix=new Matrix().scale(width/bounds.width,height/bounds.height).translate(-bounds.x,-bounds.y);matrix.applyToContext(ctx);if(path)path.draw(ctx,new Base({clip:true,matrices:[matrix]}));this._matrix.applyToContext(ctx);var element=this.getElement(),size=this._size;if(element)ctx.drawImage(element,-size.width/2,-size.height/2);ctx.restore();var pixels=ctx.getImageData(0.5,0.5,Math.ceil(width),Math.ceil(height)).data,channels=[0,0,0],total=0;for(var i=0,l=pixels.length;i<l;i+=4){var alpha=pixels[i+3];total+=alpha;alpha/=255;channels[0]+=pixels[i]*alpha;channels[1]+=pixels[i+1]*alpha;channels[2]+=pixels[i+2]*alpha;}for(var i=0;i<3;i++)channels[i]/=total;return total?Color.read(channels):null;},getPixel:function(){var point=Point.read(arguments);var data=this.getContext().getImageData(point.x,point.y,1,1).data;return new Color('rgb',[data[0]/255,data[1]/255,data[2]/255],data[3]/255);},setPixel:function(){var point=Point.read(arguments),color=Color.read(arguments),components=color._convert('rgb'),alpha=color._alpha,ctx=this.getContext(true),imageData=ctx.createImageData(1,1),data=imageData.data;data[0]=components[0]*255;data[1]=components[1]*255;data[2]=components[2]*255;data[3]=alpha!=null?alpha*255:255;ctx.putImageData(imageData,point.x,point.y);},createImageData:function(){var size=Size.read(arguments);return this.getContext().createImageData(size.width,size.height);},getImageData:function(){var rect=Rectangle.read(arguments);if(rect.isEmpty())rect=new Rectangle(this._size);return this.getContext().getImageData(rect.x,rect.y,rect.width,rect.height);},setImageData:function(data){var point=Point.read(arguments,1);this.getContext(true).putImageData(data,point.x,point.y);},_getBounds:function(matrix,options){var rect=new Rectangle(this._size).setCenter(0,0);return matrix?matrix._transformBounds(rect):rect;},_hitTestSelf:function(point){if(this._contains(point)){var that=this;return new HitResult('pixel',that,{offset:point.add(that._size.divide(2)).round(),color:{get:function(){return that.getPixel(this.offset);}}});}},_draw:function(ctx){var element=this.getElement();if(element){ctx.globalAlpha=this._opacity;ctx.drawImage(element,-this._size.width/2,-this._size.height/2);}},_canComposite:function(){return true;}});var SymbolItem=Item.extend({_class:'SymbolItem',_applyMatrix:false,_canApplyMatrix:false,_boundsOptions:{stroke:true},_serializeFields:{symbol:null},initialize:function SymbolItem(arg0,arg1){if(!this._initialize(arg0,arg1!==undefined&&Point.read(arguments,1)))this.setDefinition(arg0 instanceof SymbolDefinition?arg0:new SymbolDefinition(arg0));},_equals:function(item){return this._definition===item._definition;},copyContent:function(source){this.setDefinition(source._definition);},getDefinition:function(){return this._definition;},setDefinition:function(definition){this._definition=definition;this._changed(9);},getSymbol:'#getDefinition',setSymbol:'#setDefinition',isEmpty:function(){return this._definition._item.isEmpty();},_getBounds:function(matrix,options){var item=this._definition._item;return item._getCachedBounds(item._matrix.prepended(matrix),options);},_hitTestSelf:function(point,options,viewMatrix){var res=this._definition._item._hitTest(point,options,viewMatrix);if(res)res.item=this;return res;},_draw:function(ctx,param){this._definition._item.draw(ctx,param);}});var SymbolDefinition=Base.extend({_class:'SymbolDefinition',initialize:function SymbolDefinition(item,dontCenter){this._id=UID.get();this.project=paper.project;if(item)this.setItem(item,dontCenter);},_serialize:function(options,dictionary){return dictionary.add(this,function(){return Base.serialize([this._class,this._item],options,false,dictionary);});},_changed:function(flags){if(flags&8)Item._clearBoundsCache(this);if(flags&1)this.project._changed(flags);},getItem:function(){return this._item;},setItem:function(item,_dontCenter){if(item._symbol)item=item.clone();if(this._item)this._item._symbol=null;this._item=item;item.remove();item.setSelected(false);if(!_dontCenter)item.setPosition(new Point());item._symbol=this;this._changed(9);},getDefinition:'#getItem',setDefinition:'#setItem',place:function(position){return new SymbolItem(this,position);},clone:function(){return new SymbolDefinition(this._item.clone(false));},equals:function(symbol){return symbol===this||symbol&&this._item.equals(symbol._item)||false;}});var HitResult=Base.extend({_class:'HitResult',initialize:function HitResult(type,item,values){this.type=type;this.item=item;if(values)this.inject(values);},statics:{getOptions:function(args){var options=args&&Base.read(args);return Base.set({type:null,tolerance:paper.settings.hitTolerance,fill:!options,stroke:!options,segments:!options,handles:false,ends:false,position:false,center:false,bounds:false,guides:false,selected:false},options);}}});var Segment=Base.extend({_class:'Segment',beans:true,_selection:0,initialize:function Segment(arg0,arg1,arg2,arg3,arg4,arg5){var count=arguments.length,point,handleIn,handleOut,selection;if(count>0){if(arg0==null||typeof arg0==='object'){if(count===1&&arg0&&'point'in arg0){point=arg0.point;handleIn=arg0.handleIn;handleOut=arg0.handleOut;selection=arg0.selection;}else{point=arg0;handleIn=arg1;handleOut=arg2;selection=arg3;}}else{point=[arg0,arg1];handleIn=arg2!==undefined?[arg2,arg3]:null;handleOut=arg4!==undefined?[arg4,arg5]:null;}}new SegmentPoint(point,this,'_point');new SegmentPoint(handleIn,this,'_handleIn');new SegmentPoint(handleOut,this,'_handleOut');if(selection)this.setSelection(selection);},_serialize:function(options,dictionary){var point=this._point,selection=this._selection,obj=selection||this.hasHandles()?[point,this._handleIn,this._handleOut]:point;if(selection)obj.push(selection);return Base.serialize(obj,options,true,dictionary);},_changed:function(point){var path=this._path;if(!path)return;var curves=path._curves,index=this._index,curve;if(curves){if((!point||point===this._point||point===this._handleIn)&&(curve=index>0?curves[index-1]:path._closed?curves[curves.length-1]:null))curve._changed();if((!point||point===this._point||point===this._handleOut)&&(curve=curves[index]))curve._changed();}path._changed(25);},getPoint:function(){return this._point;},setPoint:function(){this._point.set(Point.read(arguments));},getHandleIn:function(){return this._handleIn;},setHandleIn:function(){this._handleIn.set(Point.read(arguments));},getHandleOut:function(){return this._handleOut;},setHandleOut:function(){this._handleOut.set(Point.read(arguments));},hasHandles:function(){return!this._handleIn.isZero()||!this._handleOut.isZero();},isSmooth:function(){var handleIn=this._handleIn,handleOut=this._handleOut;return!handleIn.isZero()&&!handleOut.isZero()&&handleIn.isCollinear(handleOut);},clearHandles:function(){this._handleIn._set(0,0);this._handleOut._set(0,0);},getSelection:function(){return this._selection;},setSelection:function(selection){var oldSelection=this._selection,path=this._path;this._selection=selection=selection||0;if(path&&selection!==oldSelection){path._updateSelection(this,oldSelection,selection);path._changed(129);}},_changeSelection:function(flag,selected){var selection=this._selection;this.setSelection(selected?selection|flag:selection&~flag);},isSelected:function(){return!!(this._selection&7);},setSelected:function(selected){this._changeSelection(7,selected);},getIndex:function(){return this._index!==undefined?this._index:null;},getPath:function(){return this._path||null;},getCurve:function(){var path=this._path,index=this._index;if(path){if(index>0&&!path._closed&&index===path._segments.length-1)index--;return path.getCurves()[index]||null;}return null;},getLocation:function(){var curve=this.getCurve();return curve?new CurveLocation(curve,this===curve._segment1?0:1):null;},getNext:function(){var segments=this._path&&this._path._segments;return segments&&(segments[this._index+1]||this._path._closed&&segments[0])||null;},smooth:function(options,_first,_last){var opts=options||{},type=opts.type,factor=opts.factor,prev=this.getPrevious(),next=this.getNext(),p0=(prev||this)._point,p1=this._point,p2=(next||this)._point,d1=p0.getDistance(p1),d2=p1.getDistance(p2);if(!type||type==='catmull-rom'){var a=factor===undefined?0.5:factor,d1_a=Math.pow(d1,a),d1_2a=d1_a*d1_a,d2_a=Math.pow(d2,a),d2_2a=d2_a*d2_a;if(!_first&&prev){var A=2*d2_2a+3*d2_a*d1_a+d1_2a,N=3*d2_a*(d2_a+d1_a);this.setHandleIn(N!==0?new Point((d2_2a*p0._x+A*p1._x-d1_2a*p2._x)/N-p1._x,(d2_2a*p0._y+A*p1._y-d1_2a*p2._y)/N-p1._y):new Point());}if(!_last&&next){var A=2*d1_2a+3*d1_a*d2_a+d2_2a,N=3*d1_a*(d1_a+d2_a);this.setHandleOut(N!==0?new Point((d1_2a*p2._x+A*p1._x-d2_2a*p0._x)/N-p1._x,(d1_2a*p2._y+A*p1._y-d2_2a*p0._y)/N-p1._y):new Point());}}else if(type==='geometric'){if(prev&&next){var vector=p0.subtract(p2),t=factor===undefined?0.4:factor,k=t*d1/(d1+d2);if(!_first)this.setHandleIn(vector.multiply(k));if(!_last)this.setHandleOut(vector.multiply(k-t));}}else{throw new Error('Smoothing method \''+type+'\' not supported.');}},getPrevious:function(){var segments=this._path&&this._path._segments;return segments&&(segments[this._index-1]||this._path._closed&&segments[segments.length-1])||null;},isFirst:function(){return!this._index;},isLast:function(){var path=this._path;return path&&this._index===path._segments.length-1||false;},reverse:function(){var handleIn=this._handleIn,handleOut=this._handleOut,tmp=handleIn.clone();handleIn.set(handleOut);handleOut.set(tmp);},reversed:function(){return new Segment(this._point,this._handleOut,this._handleIn);},remove:function(){return this._path?!!this._path.removeSegment(this._index):false;},clone:function(){return new Segment(this._point,this._handleIn,this._handleOut);},equals:function(segment){return segment===this||segment&&this._class===segment._class&&this._point.equals(segment._point)&&this._handleIn.equals(segment._handleIn)&&this._handleOut.equals(segment._handleOut)||false;},toString:function(){var parts=['point: '+this._point];if(!this._handleIn.isZero())parts.push('handleIn: '+this._handleIn);if(!this._handleOut.isZero())parts.push('handleOut: '+this._handleOut);return'{ '+parts.join(', ')+' }';},transform:function(matrix){this._transformCoordinates(matrix,new Array(6),true);this._changed();},interpolate:function(from,to,factor){var u=1-factor,v=factor,point1=from._point,point2=to._point,handleIn1=from._handleIn,handleIn2=to._handleIn,handleOut2=to._handleOut,handleOut1=from._handleOut;this._point._set(u*point1._x+v*point2._x,u*point1._y+v*point2._y,true);this._handleIn._set(u*handleIn1._x+v*handleIn2._x,u*handleIn1._y+v*handleIn2._y,true);this._handleOut._set(u*handleOut1._x+v*handleOut2._x,u*handleOut1._y+v*handleOut2._y,true);this._changed();},_transformCoordinates:function(matrix,coords,change){var point=this._point,handleIn=!change||!this._handleIn.isZero()?this._handleIn:null,handleOut=!change||!this._handleOut.isZero()?this._handleOut:null,x=point._x,y=point._y,i=2;coords[0]=x;coords[1]=y;if(handleIn){coords[i++]=handleIn._x+x;coords[i++]=handleIn._y+y;}if(handleOut){coords[i++]=handleOut._x+x;coords[i++]=handleOut._y+y;}if(matrix){matrix._transformCoordinates(coords,coords,i/2);x=coords[0];y=coords[1];if(change){point._x=x;point._y=y;i=2;if(handleIn){handleIn._x=coords[i++]-x;handleIn._y=coords[i++]-y;}if(handleOut){handleOut._x=coords[i++]-x;handleOut._y=coords[i++]-y;}}else{if(!handleIn){coords[i++]=x;coords[i++]=y;}if(!handleOut){coords[i++]=x;coords[i++]=y;}}}return coords;}});var SegmentPoint=Point.extend({initialize:function SegmentPoint(point,owner,key){var x,y,selected;if(!point){x=y=0;}else if((x=point[0])!==undefined){y=point[1];}else{var pt=point;if((x=pt.x)===undefined){pt=Point.read(arguments);x=pt.x;}y=pt.y;selected=pt.selected;}this._x=x;this._y=y;this._owner=owner;owner[key]=this;if(selected)this.setSelected(true);},_set:function(x,y){this._x=x;this._y=y;this._owner._changed(this);return this;},getX:function(){return this._x;},setX:function(x){this._x=x;this._owner._changed(this);},getY:function(){return this._y;},setY:function(y){this._y=y;this._owner._changed(this);},isZero:function(){var isZero=Numerical.isZero;return isZero(this._x)&&isZero(this._y);},isSelected:function(){return!!(this._owner._selection&this._getSelection());},setSelected:function(selected){this._owner._changeSelection(this._getSelection(),selected);},_getSelection:function(){var owner=this._owner;return this===owner._point?1:this===owner._handleIn?2:this===owner._handleOut?4:0;}});var Curve=Base.extend({_class:'Curve',beans:true,initialize:function Curve(arg0,arg1,arg2,arg3,arg4,arg5,arg6,arg7){var count=arguments.length,seg1,seg2,point1,point2,handle1,handle2;if(count===3){this._path=arg0;seg1=arg1;seg2=arg2;}else if(!count){seg1=new Segment();seg2=new Segment();}else if(count===1){if('segment1'in arg0){seg1=new Segment(arg0.segment1);seg2=new Segment(arg0.segment2);}else if('point1'in arg0){point1=arg0.point1;handle1=arg0.handle1;handle2=arg0.handle2;point2=arg0.point2;}else if(Array.isArray(arg0)){point1=[arg0[0],arg0[1]];point2=[arg0[6],arg0[7]];handle1=[arg0[2]-arg0[0],arg0[3]-arg0[1]];handle2=[arg0[4]-arg0[6],arg0[5]-arg0[7]];}}else if(count===2){seg1=new Segment(arg0);seg2=new Segment(arg1);}else if(count===4){point1=arg0;handle1=arg1;handle2=arg2;point2=arg3;}else if(count===8){point1=[arg0,arg1];point2=[arg6,arg7];handle1=[arg2-arg0,arg3-arg1];handle2=[arg4-arg6,arg5-arg7];}this._segment1=seg1||new Segment(point1,null,handle1);this._segment2=seg2||new Segment(point2,handle2,null);},_serialize:function(options,dictionary){return Base.serialize(this.hasHandles()?[this.getPoint1(),this.getHandle1(),this.getHandle2(),this.getPoint2()]:[this.getPoint1(),this.getPoint2()],options,true,dictionary);},_changed:function(){this._length=this._bounds=undefined;},clone:function(){return new Curve(this._segment1,this._segment2);},toString:function(){var parts=['point1: '+this._segment1._point];if(!this._segment1._handleOut.isZero())parts.push('handle1: '+this._segment1._handleOut);if(!this._segment2._handleIn.isZero())parts.push('handle2: '+this._segment2._handleIn);parts.push('point2: '+this._segment2._point);return'{ '+parts.join(', ')+' }';},classify:function(){return Curve.classify(this.getValues());},remove:function(){var removed=false;if(this._path){var segment2=this._segment2,handleOut=segment2._handleOut;removed=segment2.remove();if(removed)this._segment1._handleOut.set(handleOut);}return removed;},getPoint1:function(){return this._segment1._point;},setPoint1:function(){this._segment1._point.set(Point.read(arguments));},getPoint2:function(){return this._segment2._point;},setPoint2:function(){this._segment2._point.set(Point.read(arguments));},getHandle1:function(){return this._segment1._handleOut;},setHandle1:function(){this._segment1._handleOut.set(Point.read(arguments));},getHandle2:function(){return this._segment2._handleIn;},setHandle2:function(){this._segment2._handleIn.set(Point.read(arguments));},getSegment1:function(){return this._segment1;},getSegment2:function(){return this._segment2;},getPath:function(){return this._path;},getIndex:function(){return this._segment1._index;},getNext:function(){var curves=this._path&&this._path._curves;return curves&&(curves[this._segment1._index+1]||this._path._closed&&curves[0])||null;},getPrevious:function(){var curves=this._path&&this._path._curves;return curves&&(curves[this._segment1._index-1]||this._path._closed&&curves[curves.length-1])||null;},isFirst:function(){return!this._segment1._index;},isLast:function(){var path=this._path;return path&&this._segment1._index===path._curves.length-1||false;},isSelected:function(){return this.getPoint1().isSelected()&&this.getHandle1().isSelected()&&this.getHandle2().isSelected()&&this.getPoint2().isSelected();},setSelected:function(selected){this.getPoint1().setSelected(selected);this.getHandle1().setSelected(selected);this.getHandle2().setSelected(selected);this.getPoint2().setSelected(selected);},getValues:function(matrix){return Curve.getValues(this._segment1,this._segment2,matrix);},getPoints:function(){var coords=this.getValues(),points=[];for(var i=0;i<8;i+=2)points.push(new Point(coords[i],coords[i+1]));return points;}},{getLength:function(){if(this._length==null)this._length=Curve.getLength(this.getValues(),0,1);return this._length;},getArea:function(){return Curve.getArea(this.getValues());},getLine:function(){return new Line(this._segment1._point,this._segment2._point);},getPart:function(from,to){return new Curve(Curve.getPart(this.getValues(),from,to));},getPartLength:function(from,to){return Curve.getLength(this.getValues(),from,to);},divideAt:function(location){return this.divideAtTime(location&&location.curve===this?location.time:this.getTimeAt(location));},divideAtTime:function(time,_setHandles){var tMin=1e-8,tMax=1-tMin,res=null;if(time>=tMin&&time<=tMax){var parts=Curve.subdivide(this.getValues(),time),left=parts[0],right=parts[1],setHandles=_setHandles||this.hasHandles(),seg1=this._segment1,seg2=this._segment2,path=this._path;if(setHandles){seg1._handleOut._set(left[2]-left[0],left[3]-left[1]);seg2._handleIn._set(right[4]-right[6],right[5]-right[7]);}var x=left[6],y=left[7],segment=new Segment(new Point(x,y),setHandles&&new Point(left[4]-x,left[5]-y),setHandles&&new Point(right[2]-x,right[3]-y));if(path){path.insert(seg1._index+1,segment);res=this.getNext();}else{this._segment2=segment;this._changed();res=new Curve(segment,seg2);}}return res;},splitAt:function(location){var path=this._path;return path?path.splitAt(location):null;},splitAtTime:function(time){return this.splitAt(this.getLocationAtTime(time));},divide:function(offset,isTime){return this.divideAtTime(offset===undefined?0.5:isTime?offset:this.getTimeAt(offset));},split:function(offset,isTime){return this.splitAtTime(offset===undefined?0.5:isTime?offset:this.getTimeAt(offset));},reversed:function(){return new Curve(this._segment2.reversed(),this._segment1.reversed());},clearHandles:function(){this._segment1._handleOut._set(0,0);this._segment2._handleIn._set(0,0);},statics:{getValues:function(segment1,segment2,matrix,straight){var p1=segment1._point,h1=segment1._handleOut,h2=segment2._handleIn,p2=segment2._point,x1=p1.x,y1=p1.y,x2=p2.x,y2=p2.y,values=straight?[x1,y1,x1,y1,x2,y2,x2,y2]:[x1,y1,x1+h1._x,y1+h1._y,x2+h2._x,y2+h2._y,x2,y2];if(matrix)matrix._transformCoordinates(values,values,4);return values;},subdivide:function(v,t){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7];if(t===undefined)t=0.5;var u=1-t,x4=u*x0+t*x1,y4=u*y0+t*y1,x5=u*x1+t*x2,y5=u*y1+t*y2,x6=u*x2+t*x3,y6=u*y2+t*y3,x7=u*x4+t*x5,y7=u*y4+t*y5,x8=u*x5+t*x6,y8=u*y5+t*y6,x9=u*x7+t*x8,y9=u*y7+t*y8;return[[x0,y0,x4,y4,x7,y7,x9,y9],[x9,y9,x8,y8,x6,y6,x3,y3]];},getMonoCurves:function(v,dir){var curves=[],io=dir?0:1,o0=v[io+0],o1=v[io+2],o2=v[io+4],o3=v[io+6];if(o0>=o1===o1>=o2&&o1>=o2===o2>=o3||Curve.isStraight(v)){curves.push(v);}else{var a=3*(o1-o2)-o0+o3,b=2*(o0+o2)-4*o1,c=o1-o0,tMin=1e-8,tMax=1-tMin,roots=[],n=Numerical.solveQuadratic(a,b,c,roots,tMin,tMax);if(!n){curves.push(v);}else{roots.sort();var t=roots[0],parts=Curve.subdivide(v,t);curves.push(parts[0]);if(n>1){t=(roots[1]-t)/(1-t);parts=Curve.subdivide(parts[1],t);curves.push(parts[0]);}curves.push(parts[1]);}}return curves;},solveCubic:function(v,coord,val,roots,min,max){var v0=v[coord],v1=v[coord+2],v2=v[coord+4],v3=v[coord+6],res=0;if(!(v0<val&&v3<val&&v1<val&&v2<val||v0>val&&v3>val&&v1>val&&v2>val)){var c=3*(v1-v0),b=3*(v2-v1)-c,a=v3-v0-c-b;res=Numerical.solveCubic(a,b,c,v0-val,roots,min,max);}return res;},getTimeOf:function(v,point){var p0=new Point(v[0],v[1]),p3=new Point(v[6],v[7]),epsilon=1e-12,geomEpsilon=1e-7,t=point.isClose(p0,epsilon)?0:point.isClose(p3,epsilon)?1:null;if(t===null){var coords=[point.x,point.y],roots=[];for(var c=0;c<2;c++){var count=Curve.solveCubic(v,c,coords[c],roots,0,1);for(var i=0;i<count;i++){var u=roots[i];if(point.isClose(Curve.getPoint(v,u),geomEpsilon))return u;}}}return point.isClose(p0,geomEpsilon)?0:point.isClose(p3,geomEpsilon)?1:null;},getNearestTime:function(v,point){if(Curve.isStraight(v)){var x0=v[0],y0=v[1],x3=v[6],y3=v[7],vx=x3-x0,vy=y3-y0,det=vx*vx+vy*vy;if(det===0)return 0;var u=((point.x-x0)*vx+(point.y-y0)*vy)/det;return u<1e-12?0:u>0.999999999999?1:Curve.getTimeOf(v,new Point(x0+u*vx,y0+u*vy));}var count=100,minDist=Infinity,minT=0;function refine(t){if(t>=0&&t<=1){var dist=point.getDistance(Curve.getPoint(v,t),true);if(dist<minDist){minDist=dist;minT=t;return true;}}}for(var i=0;i<=count;i++)refine(i/count);var step=1/(count*2);while(step>1e-8){if(!refine(minT-step)&&!refine(minT+step))step/=2;}return minT;},getPart:function(v,from,to){var flip=from>to;if(flip){var tmp=from;from=to;to=tmp;}if(from>0)v=Curve.subdivide(v,from)[1];if(to<1)v=Curve.subdivide(v,(to-from)/(1-from))[0];return flip?[v[6],v[7],v[4],v[5],v[2],v[3],v[0],v[1]]:v;},isFlatEnough:function(v,flatness){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7],ux=3*x1-2*x0-x3,uy=3*y1-2*y0-y3,vx=3*x2-2*x3-x0,vy=3*y2-2*y3-y0;return Math.max(ux*ux,vx*vx)+Math.max(uy*uy,vy*vy)<=16*flatness*flatness;},getArea:function(v){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7];return 3*((y3-y0)*(x1+x2)-(x3-x0)*(y1+y2)+y1*(x0-x2)-x1*(y0-y2)+y3*(x2+x0/3)-x3*(y2+y0/3))/20;},getBounds:function(v){var min=v.slice(0,2),max=min.slice(),roots=[0,0];for(var i=0;i<2;i++)Curve._addBounds(v[i],v[i+2],v[i+4],v[i+6],i,0,min,max,roots);return new Rectangle(min[0],min[1],max[0]-min[0],max[1]-min[1]);},_addBounds:function(v0,v1,v2,v3,coord,padding,min,max,roots){function add(value,padding){var left=value-padding,right=value+padding;if(left<min[coord])min[coord]=left;if(right>max[coord])max[coord]=right;}padding/=2;var minPad=min[coord]-padding,maxPad=max[coord]+padding;if(v0<minPad||v1<minPad||v2<minPad||v3<minPad||v0>maxPad||v1>maxPad||v2>maxPad||v3>maxPad){if(v1<v0!=v1<v3&&v2<v0!=v2<v3){add(v0,padding);add(v3,padding);}else{var a=3*(v1-v2)-v0+v3,b=2*(v0+v2)-4*v1,c=v1-v0,count=Numerical.solveQuadratic(a,b,c,roots),tMin=1e-8,tMax=1-tMin;add(v3,0);for(var i=0;i<count;i++){var t=roots[i],u=1-t;if(tMin<=t&&t<=tMax)add(u*u*u*v0+3*u*u*t*v1+3*u*t*t*v2+t*t*t*v3,padding);}}}}}},Base.each(['getBounds','getStrokeBounds','getHandleBounds'],function(name){this[name]=function(){if(!this._bounds)this._bounds={};var bounds=this._bounds[name];if(!bounds){bounds=this._bounds[name]=Path[name]([this._segment1,this._segment2],false,this._path);}return bounds.clone();};},{}),Base.each({isStraight:function(p1,h1,h2,p2){if(h1.isZero()&&h2.isZero()){return true;}else{var v=p2.subtract(p1);if(v.isZero()){return false;}else if(v.isCollinear(h1)&&v.isCollinear(h2)){var l=new Line(p1,p2),epsilon=1e-7;if(l.getDistance(p1.add(h1))<epsilon&&l.getDistance(p2.add(h2))<epsilon){var div=v.dot(v),s1=v.dot(h1)/div,s2=v.dot(h2)/div;return s1>=0&&s1<=1&&s2<=0&&s2>=-1;}}}return false;},isLinear:function(p1,h1,h2,p2){var third=p2.subtract(p1).divide(3);return h1.equals(third)&&h2.negate().equals(third);}},function(test,name){this[name]=function(epsilon){var seg1=this._segment1,seg2=this._segment2;return test(seg1._point,seg1._handleOut,seg2._handleIn,seg2._point,epsilon);};this.statics[name]=function(v,epsilon){var x0=v[0],y0=v[1],x3=v[6],y3=v[7];return test(new Point(x0,y0),new Point(v[2]-x0,v[3]-y0),new Point(v[4]-x3,v[5]-y3),new Point(x3,y3),epsilon);};},{statics:{},hasHandles:function(){return!this._segment1._handleOut.isZero()||!this._segment2._handleIn.isZero();},hasLength:function(epsilon){return(!this.getPoint1().equals(this.getPoint2())||this.hasHandles())&&this.getLength()>(epsilon||0);},isCollinear:function(curve){return curve&&this.isStraight()&&curve.isStraight()&&this.getLine().isCollinear(curve.getLine());},isHorizontal:function(){return this.isStraight()&&Math.abs(this.getTangentAtTime(0.5).y)<1e-8;},isVertical:function(){return this.isStraight()&&Math.abs(this.getTangentAtTime(0.5).x)<1e-8;}}),{beans:false,getLocationAt:function(offset,_isTime){return this.getLocationAtTime(_isTime?offset:this.getTimeAt(offset));},getLocationAtTime:function(t){return t!=null&&t>=0&&t<=1?new CurveLocation(this,t):null;},getTimeAt:function(offset,start){return Curve.getTimeAt(this.getValues(),offset,start);},getParameterAt:'#getTimeAt',getOffsetAtTime:function(t){return this.getPartLength(0,t);},getLocationOf:function(){return this.getLocationAtTime(this.getTimeOf(Point.read(arguments)));},getOffsetOf:function(){var loc=this.getLocationOf.apply(this,arguments);return loc?loc.getOffset():null;},getTimeOf:function(){return Curve.getTimeOf(this.getValues(),Point.read(arguments));},getParameterOf:'#getTimeOf',getNearestLocation:function(){var point=Point.read(arguments),values=this.getValues(),t=Curve.getNearestTime(values,point),pt=Curve.getPoint(values,t);return new CurveLocation(this,t,pt,null,point.getDistance(pt));},getNearestPoint:function(){var loc=this.getNearestLocation.apply(this,arguments);return loc?loc.getPoint():loc;}},new function(){var methods=['getPoint','getTangent','getNormal','getWeightedTangent','getWeightedNormal','getCurvature'];return Base.each(methods,function(name){this[name+'At']=function(location,_isTime){var values=this.getValues();return Curve[name](values,_isTime?location:Curve.getTimeAt(values,location));};this[name+'AtTime']=function(time){return Curve[name](this.getValues(),time);};},{statics:{_evaluateMethods:methods}});}(),new function(){function getLengthIntegrand(v){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7],ax=9*(x1-x2)+3*(x3-x0),bx=6*(x0+x2)-12*x1,cx=3*(x1-x0),ay=9*(y1-y2)+3*(y3-y0),by=6*(y0+y2)-12*y1,cy=3*(y1-y0);return function(t){var dx=(ax*t+bx)*t+cx,dy=(ay*t+by)*t+cy;return Math.sqrt(dx*dx+dy*dy);};}function getIterations(a,b){return Math.max(2,Math.min(16,Math.ceil(Math.abs(b-a)*32)));}function evaluate(v,t,type,normalized){if(t==null||t<0||t>1)return null;var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7],isZero=Numerical.isZero;if(isZero(x1-x0)&&isZero(y1-y0)){x1=x0;y1=y0;}if(isZero(x2-x3)&&isZero(y2-y3)){x2=x3;y2=y3;}var cx=3*(x1-x0),bx=3*(x2-x1)-cx,ax=x3-x0-cx-bx,cy=3*(y1-y0),by=3*(y2-y1)-cy,ay=y3-y0-cy-by,x,y;if(type===0){x=t===0?x0:t===1?x3:((ax*t+bx)*t+cx)*t+x0;y=t===0?y0:t===1?y3:((ay*t+by)*t+cy)*t+y0;}else{var tMin=1e-8,tMax=1-tMin;if(t<tMin){x=cx;y=cy;}else if(t>tMax){x=3*(x3-x2);y=3*(y3-y2);}else{x=(3*ax*t+2*bx)*t+cx;y=(3*ay*t+2*by)*t+cy;}if(normalized){if(x===0&&y===0&&(t<tMin||t>tMax)){x=x2-x1;y=y2-y1;}var len=Math.sqrt(x*x+y*y);if(len){x/=len;y/=len;}}if(type===3){var x2=6*ax*t+2*bx,y2=6*ay*t+2*by,d=Math.pow(x*x+y*y,3/2);x=d!==0?(x*y2-y*x2)/d:0;y=0;}}return type===2?new Point(y,-x):new Point(x,y);}return{statics:{classify:function(v){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7],a1=x0*(y3-y2)+y0*(x2-x3)+x3*y2-y3*x2,a2=x1*(y0-y3)+y1*(x3-x0)+x0*y3-y0*x3,a3=x2*(y1-y0)+y2*(x0-x1)+x1*y0-y1*x0,d3=3*a3,d2=d3-a2,d1=d2-a2+a1,l=Math.sqrt(d1*d1+d2*d2+d3*d3),s=l!==0?1/l:0,isZero=Numerical.isZero,serpentine='serpentine';d1*=s;d2*=s;d3*=s;function type(type,t1,t2){var hasRoots=t1!==undefined,t1Ok=hasRoots&&t1>0&&t1<1,t2Ok=hasRoots&&t2>0&&t2<1;if(hasRoots&&(!(t1Ok||t2Ok)||type==='loop'&&!(t1Ok&&t2Ok))){type='arch';t1Ok=t2Ok=false;}return{type:type,roots:t1Ok||t2Ok?t1Ok&&t2Ok?t1<t2?[t1,t2]:[t2,t1]:[t1Ok?t1:t2]:null};}if(isZero(d1)){return isZero(d2)?type(isZero(d3)?'line':'quadratic'):type(serpentine,d3/(3*d2));}var d=3*d2*d2-4*d1*d3;if(isZero(d)){return type('cusp',d2/(2*d1));}var f1=d>0?Math.sqrt(d/3):Math.sqrt(-d),f2=2*d1;return type(d>0?serpentine:'loop',(d2+f1)/f2,(d2-f1)/f2);},getLength:function(v,a,b,ds){if(a===undefined)a=0;if(b===undefined)b=1;if(Curve.isStraight(v)){var c=v;if(b<1){c=Curve.subdivide(c,b)[0];a/=b;}if(a>0){c=Curve.subdivide(c,a)[1];}var dx=c[6]-c[0],dy=c[7]-c[1];return Math.sqrt(dx*dx+dy*dy);}return Numerical.integrate(ds||getLengthIntegrand(v),a,b,getIterations(a,b));},getTimeAt:function(v,offset,start){if(start===undefined)start=offset<0?1:0;if(offset===0)return start;var abs=Math.abs,epsilon=1e-12,forward=offset>0,a=forward?start:0,b=forward?1:start,ds=getLengthIntegrand(v),rangeLength=Curve.getLength(v,a,b,ds),diff=abs(offset)-rangeLength;if(abs(diff)<epsilon){return forward?b:a;}else if(diff>epsilon){return null;}var guess=offset/rangeLength,length=0;function f(t){length+=Numerical.integrate(ds,start,t,getIterations(start,t));start=t;return length-offset;}return Numerical.findRoot(f,ds,start+guess,a,b,32,1e-12);},getPoint:function(v,t){return evaluate(v,t,0,false);},getTangent:function(v,t){return evaluate(v,t,1,true);},getWeightedTangent:function(v,t){return evaluate(v,t,1,false);},getNormal:function(v,t){return evaluate(v,t,2,true);},getWeightedNormal:function(v,t){return evaluate(v,t,2,false);},getCurvature:function(v,t){return evaluate(v,t,3,false).x;},getPeaks:function(v){var x0=v[0],y0=v[1],x1=v[2],y1=v[3],x2=v[4],y2=v[5],x3=v[6],y3=v[7],ax=-x0+3*x1-3*x2+x3,bx=3*x0-6*x1+3*x2,cx=-3*x0+3*x1,ay=-y0+3*y1-3*y2+y3,by=3*y0-6*y1+3*y2,cy=-3*y0+3*y1,tMin=1e-8,tMax=1-tMin,roots=[];Numerical.solveCubic(9*(ax*ax+ay*ay),9*(ax*bx+by*ay),2*(bx*bx+by*by)+3*(cx*ax+cy*ay),cx*bx+by*cy,roots,tMin,tMax);return roots.sort();}}};}(),new function(){function addLocation(locations,include,c1,t1,c2,t2,overlap){var excludeStart=!overlap&&c1.getPrevious()===c2,excludeEnd=!overlap&&c1!==c2&&c1.getNext()===c2,tMin=1e-8,tMax=1-tMin;if(t1!==null&&t1>=(excludeStart?tMin:0)&&t1<=(excludeEnd?tMax:1)){if(t2!==null&&t2>=(excludeEnd?tMin:0)&&t2<=(excludeStart?tMax:1)){var loc1=new CurveLocation(c1,t1,null,overlap),loc2=new CurveLocation(c2,t2,null,overlap);loc1._intersection=loc2;loc2._intersection=loc1;if(!include||include(loc1)){CurveLocation.insert(locations,loc1,true);}}}}function addCurveIntersections(v1,v2,c1,c2,locations,include,flip,recursion,calls,tMin,tMax,uMin,uMax){if(++calls>=4096||++recursion>=40)return calls;var fatLineEpsilon=1e-9,q0x=v2[0],q0y=v2[1],q3x=v2[6],q3y=v2[7],getSignedDistance=Line.getSignedDistance,d1=getSignedDistance(q0x,q0y,q3x,q3y,v2[2],v2[3]),d2=getSignedDistance(q0x,q0y,q3x,q3y,v2[4],v2[5]),factor=d1*d2>0?3/4:4/9,dMin=factor*Math.min(0,d1,d2),dMax=factor*Math.max(0,d1,d2),dp0=getSignedDistance(q0x,q0y,q3x,q3y,v1[0],v1[1]),dp1=getSignedDistance(q0x,q0y,q3x,q3y,v1[2],v1[3]),dp2=getSignedDistance(q0x,q0y,q3x,q3y,v1[4],v1[5]),dp3=getSignedDistance(q0x,q0y,q3x,q3y,v1[6],v1[7]),hull=getConvexHull(dp0,dp1,dp2,dp3),top=hull[0],bottom=hull[1],tMinClip,tMaxClip;if(d1===0&&d2===0&&dp0===0&&dp1===0&&dp2===0&&dp3===0||(tMinClip=clipConvexHull(top,bottom,dMin,dMax))==null||(tMaxClip=clipConvexHull(top.reverse(),bottom.reverse(),dMin,dMax))==null)return calls;var tMinNew=tMin+(tMax-tMin)*tMinClip,tMaxNew=tMin+(tMax-tMin)*tMaxClip;if(Math.max(uMax-uMin,tMaxNew-tMinNew)<fatLineEpsilon){var t=(tMinNew+tMaxNew)/2,u=(uMin+uMax)/2;addLocation(locations,include,flip?c2:c1,flip?u:t,flip?c1:c2,flip?t:u);}else{v1=Curve.getPart(v1,tMinClip,tMaxClip);if(tMaxClip-tMinClip>0.8){if(tMaxNew-tMinNew>uMax-uMin){var parts=Curve.subdivide(v1,0.5),t=(tMinNew+tMaxNew)/2;calls=addCurveIntersections(v2,parts[0],c2,c1,locations,include,!flip,recursion,calls,uMin,uMax,tMinNew,t);calls=addCurveIntersections(v2,parts[1],c2,c1,locations,include,!flip,recursion,calls,uMin,uMax,t,tMaxNew);}else{var parts=Curve.subdivide(v2,0.5),u=(uMin+uMax)/2;calls=addCurveIntersections(parts[0],v1,c2,c1,locations,include,!flip,recursion,calls,uMin,u,tMinNew,tMaxNew);calls=addCurveIntersections(parts[1],v1,c2,c1,locations,include,!flip,recursion,calls,u,uMax,tMinNew,tMaxNew);}}else{if(uMax-uMin>=fatLineEpsilon){calls=addCurveIntersections(v2,v1,c2,c1,locations,include,!flip,recursion,calls,uMin,uMax,tMinNew,tMaxNew);}else{calls=addCurveIntersections(v1,v2,c1,c2,locations,include,flip,recursion,calls,tMinNew,tMaxNew,uMin,uMax);}}}return calls;}function getConvexHull(dq0,dq1,dq2,dq3){var p0=[0,dq0],p1=[1/3,dq1],p2=[2/3,dq2],p3=[1,dq3],dist1=dq1-(2*dq0+dq3)/3,dist2=dq2-(dq0+2*dq3)/3,hull;if(dist1*dist2<0){hull=[[p0,p1,p3],[p0,p2,p3]];}else{var distRatio=dist1/dist2;hull=[distRatio>=2?[p0,p1,p3]:distRatio<=0.5?[p0,p2,p3]:[p0,p1,p2,p3],[p0,p3]];}return(dist1||dist2)<0?hull.reverse():hull;}function clipConvexHull(hullTop,hullBottom,dMin,dMax){if(hullTop[0][1]<dMin){return clipConvexHullPart(hullTop,true,dMin);}else if(hullBottom[0][1]>dMax){return clipConvexHullPart(hullBottom,false,dMax);}else{return hullTop[0][0];}}function clipConvexHullPart(part,top,threshold){var px=part[0][0],py=part[0][1];for(var i=1,l=part.length;i<l;i++){var qx=part[i][0],qy=part[i][1];if(top?qy>=threshold:qy<=threshold){return qy===threshold?qx:px+(threshold-py)*(qx-px)/(qy-py);}px=qx;py=qy;}return null;}function getCurveLineIntersections(v,px,py,vx,vy){var isZero=Numerical.isZero;if(isZero(vx)&&isZero(vy)){var t=Curve.getTimeOf(v,new Point(px,py));return t===null?[]:[t];}var angle=Math.atan2(-vy,vx),sin=Math.sin(angle),cos=Math.cos(angle),rv=[],roots=[];for(var i=0;i<8;i+=2){var x=v[i]-px,y=v[i+1]-py;rv.push(x*cos-y*sin,x*sin+y*cos);}Curve.solveCubic(rv,1,0,roots,0,1);return roots;}function addCurveLineIntersections(v1,v2,c1,c2,locations,include,flip){var x1=v2[0],y1=v2[1],x2=v2[6],y2=v2[7],roots=getCurveLineIntersections(v1,x1,y1,x2-x1,y2-y1);for(var i=0,l=roots.length;i<l;i++){var t1=roots[i],p1=Curve.getPoint(v1,t1),t2=Curve.getTimeOf(v2,p1);if(t2!==null){addLocation(locations,include,flip?c2:c1,flip?t2:t1,flip?c1:c2,flip?t1:t2);}}}function addLineIntersection(v1,v2,c1,c2,locations,include){var pt=Line.intersect(v1[0],v1[1],v1[6],v1[7],v2[0],v2[1],v2[6],v2[7]);if(pt){addLocation(locations,include,c1,Curve.getTimeOf(v1,pt),c2,Curve.getTimeOf(v2,pt));}}function getCurveIntersections(v1,v2,c1,c2,locations,include){var epsilon=1e-12,min=Math.min,max=Math.max;if(max(v1[0],v1[2],v1[4],v1[6])+epsilon>min(v2[0],v2[2],v2[4],v2[6])&&min(v1[0],v1[2],v1[4],v1[6])-epsilon<max(v2[0],v2[2],v2[4],v2[6])&&max(v1[1],v1[3],v1[5],v1[7])+epsilon>min(v2[1],v2[3],v2[5],v2[7])&&min(v1[1],v1[3],v1[5],v1[7])-epsilon<max(v2[1],v2[3],v2[5],v2[7])){var overlaps=getOverlaps(v1,v2);if(overlaps){for(var i=0;i<2;i++){var overlap=overlaps[i];addLocation(locations,include,c1,overlap[0],c2,overlap[1],true);}}else{var straight1=Curve.isStraight(v1),straight2=Curve.isStraight(v2),straight=straight1&&straight2,flip=straight1&&!straight2,before=locations.length;(straight?addLineIntersection:straight1||straight2?addCurveLineIntersections:addCurveIntersections)(flip?v2:v1,flip?v1:v2,flip?c2:c1,flip?c1:c2,locations,include,flip,0,0,0,1,0,1);if(!straight||locations.length===before){for(var i=0;i<4;i++){var t1=i>>1,t2=i&1,i1=t1*6,i2=t2*6,p1=new Point(v1[i1],v1[i1+1]),p2=new Point(v2[i2],v2[i2+1]);if(p1.isClose(p2,epsilon)){addLocation(locations,include,c1,t1,c2,t2);}}}}}return locations;}function getLoopIntersection(v1,c1,locations,include){var info=Curve.classify(v1);if(info.type==='loop'){var roots=info.roots;addLocation(locations,include,c1,roots[0],c1,roots[1]);}return locations;}function getIntersections(curves1,curves2,include,matrix1,matrix2,_returnFirst){var self=!curves2;if(self)curves2=curves1;var length1=curves1.length,length2=curves2.length,values2=[],arrays=[],locations,current;for(var i=0;i<length2;i++)values2[i]=curves2[i].getValues(matrix2);for(var i=0;i<length1;i++){var curve1=curves1[i],values1=self?values2[i]:curve1.getValues(matrix1),path1=curve1.getPath();if(path1!==current){current=path1;locations=[];arrays.push(locations);}if(self){getLoopIntersection(values1,curve1,locations,include);}for(var j=self?i+1:0;j<length2;j++){if(_returnFirst&&locations.length)return locations;getCurveIntersections(values1,values2[j],curve1,curves2[j],locations,include);}}locations=[];for(var i=0,l=arrays.length;i<l;i++){locations.push.apply(locations,arrays[i]);}return locations;}function getOverlaps(v1,v2){function getSquaredLineLength(v){var x=v[6]-v[0],y=v[7]-v[1];return x*x+y*y;}var abs=Math.abs,getDistance=Line.getDistance,timeEpsilon=1e-8,geomEpsilon=1e-7,straight1=Curve.isStraight(v1),straight2=Curve.isStraight(v2),straightBoth=straight1&&straight2,flip=getSquaredLineLength(v1)<getSquaredLineLength(v2),l1=flip?v2:v1,l2=flip?v1:v2,px=l1[0],py=l1[1],vx=l1[6]-px,vy=l1[7]-py;if(getDistance(px,py,vx,vy,l2[0],l2[1],true)<geomEpsilon&&getDistance(px,py,vx,vy,l2[6],l2[7],true)<geomEpsilon){if(!straightBoth&&getDistance(px,py,vx,vy,l1[2],l1[3],true)<geomEpsilon&&getDistance(px,py,vx,vy,l1[4],l1[5],true)<geomEpsilon&&getDistance(px,py,vx,vy,l2[2],l2[3],true)<geomEpsilon&&getDistance(px,py,vx,vy,l2[4],l2[5],true)<geomEpsilon){straight1=straight2=straightBoth=true;}}else if(straightBoth){return null;}if(straight1^straight2){return null;}var v=[v1,v2],pairs=[];for(var i=0;i<4&&pairs.length<2;i++){var i1=i&1,i2=i1^1,t1=i>>1,t2=Curve.getTimeOf(v[i1],new Point(v[i2][t1?6:0],v[i2][t1?7:1]));if(t2!=null){var pair=i1?[t1,t2]:[t2,t1];if(!pairs.length||abs(pair[0]-pairs[0][0])>timeEpsilon&&abs(pair[1]-pairs[0][1])>timeEpsilon){pairs.push(pair);}}if(i>2&&!pairs.length)break;}if(pairs.length!==2){pairs=null;}else if(!straightBoth){var o1=Curve.getPart(v1,pairs[0][0],pairs[1][0]),o2=Curve.getPart(v2,pairs[0][1],pairs[1][1]);if(abs(o2[2]-o1[2])>geomEpsilon||abs(o2[3]-o1[3])>geomEpsilon||abs(o2[4]-o1[4])>geomEpsilon||abs(o2[5]-o1[5])>geomEpsilon)pairs=null;}return pairs;}return{getIntersections:function(curve){var v1=this.getValues(),v2=curve&&curve!==this&&curve.getValues();return v2?getCurveIntersections(v1,v2,this,curve,[]):getLoopIntersection(v1,this,[]);},statics:{getOverlaps:getOverlaps,getIntersections:getIntersections,getCurveLineIntersections:getCurveLineIntersections}};}());var CurveLocation=Base.extend({_class:'CurveLocation',initialize:function CurveLocation(curve,time,point,_overlap,_distance){if(time>=0.99999999){var next=curve.getNext();if(next){time=0;curve=next;}}this._setCurve(curve);this._time=time;this._point=point||curve.getPointAtTime(time);this._overlap=_overlap;this._distance=_distance;this._intersection=this._next=this._previous=null;},_setCurve:function(curve){var path=curve._path;this._path=path;this._version=path?path._version:0;this._curve=curve;this._segment=null;this._segment1=curve._segment1;this._segment2=curve._segment2;},_setSegment:function(segment){this._setCurve(segment.getCurve());this._segment=segment;this._time=segment===this._segment1?0:1;this._point=segment._point.clone();},getSegment:function(){var segment=this._segment;if(!segment){var curve=this.getCurve(),time=this.getTime();if(time===0){segment=curve._segment1;}else if(time===1){segment=curve._segment2;}else if(time!=null){segment=curve.getPartLength(0,time)<curve.getPartLength(time,1)?curve._segment1:curve._segment2;}this._segment=segment;}return segment;},getCurve:function(){var path=this._path,that=this;if(path&&path._version!==this._version){this._time=this._offset=this._curveOffset=this._curve=null;}function trySegment(segment){var curve=segment&&segment.getCurve();if(curve&&(that._time=curve.getTimeOf(that._point))!=null){that._setCurve(curve);return curve;}}return this._curve||trySegment(this._segment)||trySegment(this._segment1)||trySegment(this._segment2.getPrevious());},getPath:function(){var curve=this.getCurve();return curve&&curve._path;},getIndex:function(){var curve=this.getCurve();return curve&&curve.getIndex();},getTime:function(){var curve=this.getCurve(),time=this._time;return curve&&time==null?this._time=curve.getTimeOf(this._point):time;},getParameter:'#getTime',getPoint:function(){return this._point;},getOffset:function(){var offset=this._offset;if(offset==null){offset=0;var path=this.getPath(),index=this.getIndex();if(path&&index!=null){var curves=path.getCurves();for(var i=0;i<index;i++)offset+=curves[i].getLength();}this._offset=offset+=this.getCurveOffset();}return offset;},getCurveOffset:function(){var offset=this._curveOffset;if(offset==null){var curve=this.getCurve(),time=this.getTime();this._curveOffset=offset=time!=null&&curve&&curve.getPartLength(0,time);}return offset;},getIntersection:function(){return this._intersection;},getDistance:function(){return this._distance;},divide:function(){var curve=this.getCurve(),res=curve&&curve.divideAtTime(this.getTime());if(res){this._setSegment(res._segment1);}return res;},split:function(){var curve=this.getCurve(),path=curve._path,res=curve&&curve.splitAtTime(this.getTime());if(res){this._setSegment(path.getLastSegment());}return res;},equals:function(loc,_ignoreOther){var res=this===loc;if(!res&&loc instanceof CurveLocation){var c1=this.getCurve(),c2=loc.getCurve(),p1=c1._path,p2=c2._path;if(p1===p2){var abs=Math.abs,epsilon=1e-7,diff=abs(this.getOffset()-loc.getOffset()),i1=!_ignoreOther&&this._intersection,i2=!_ignoreOther&&loc._intersection;res=(diff<epsilon||p1&&abs(p1.getLength()-diff)<epsilon)&&(!i1&&!i2||i1&&i2&&i1.equals(i2,true));}}return res;},toString:function(){var parts=[],point=this.getPoint(),f=Formatter.instance;if(point)parts.push('point: '+point);var index=this.getIndex();if(index!=null)parts.push('index: '+index);var time=this.getTime();if(time!=null)parts.push('time: '+f.number(time));if(this._distance!=null)parts.push('distance: '+f.number(this._distance));return'{ '+parts.join(', ')+' }';},isTouching:function(){var inter=this._intersection;if(inter&&this.getTangent().isCollinear(inter.getTangent())){var curve1=this.getCurve(),curve2=inter.getCurve();return!(curve1.isStraight()&&curve2.isStraight()&&curve1.getLine().intersect(curve2.getLine()));}return false;},isCrossing:function(){var inter=this._intersection;if(!inter)return false;var t1=this.getTime(),t2=inter.getTime(),tMin=1e-8,tMax=1-tMin,t1Inside=t1>=tMin&&t1<=tMax,t2Inside=t2>=tMin&&t2<=tMax;if(t1Inside&&t2Inside)return!this.isTouching();var c2=this.getCurve(),c1=t1<tMin?c2.getPrevious():c2,c4=inter.getCurve(),c3=t2<tMin?c4.getPrevious():c4;if(t1>tMax)c2=c2.getNext();if(t2>tMax)c4=c4.getNext();if(!c1||!c2||!c3||!c4)return false;var offsets=[];function addOffsets(curve,end){var v=curve.getValues(),roots=Curve.classify(v).roots||Curve.getPeaks(v),count=roots.length,t=end&&count>1?roots[count-1]:count>0?roots[0]:0.5;offsets.push(Curve.getLength(v,end?t:0,end?1:t)/2);}function isInRange(angle,min,max){return min<max?angle>min&&angle<max:angle>min||angle<max;}if(!t1Inside){addOffsets(c1,true);addOffsets(c2,false);}if(!t2Inside){addOffsets(c3,true);addOffsets(c4,false);}var pt=this.getPoint(),offset=Math.min.apply(Math,offsets),v2=t1Inside?c2.getTangentAtTime(t1):c2.getPointAt(offset).subtract(pt),v1=t1Inside?v2.negate():c1.getPointAt(-offset).subtract(pt),v4=t2Inside?c4.getTangentAtTime(t2):c4.getPointAt(offset).subtract(pt),v3=t2Inside?v4.negate():c3.getPointAt(-offset).subtract(pt),a1=v1.getAngle(),a2=v2.getAngle(),a3=v3.getAngle(),a4=v4.getAngle();return!!(t1Inside?isInRange(a1,a3,a4)^isInRange(a2,a3,a4)&&isInRange(a1,a4,a3)^isInRange(a2,a4,a3):isInRange(a3,a1,a2)^isInRange(a4,a1,a2)&&isInRange(a3,a2,a1)^isInRange(a4,a2,a1));},hasOverlap:function(){return!!this._overlap;}},Base.each(Curve._evaluateMethods,function(name){var get=name+'At';this[name]=function(){var curve=this.getCurve(),time=this.getTime();return time!=null&&curve&&curve[get](time,true);};},{preserve:true}),new function(){function insert(locations,loc,merge){var length=locations.length,l=0,r=length-1;function search(index,dir){for(var i=index+dir;i>=-1&&i<=length;i+=dir){var loc2=locations[(i%length+length)%length];if(!loc.getPoint().isClose(loc2.getPoint(),1e-7))break;if(loc.equals(loc2))return loc2;}return null;}while(l<=r){var m=l+r>>>1,loc2=locations[m],found;if(merge&&(found=loc.equals(loc2)?loc2:search(m,-1)||search(m,1))){if(loc._overlap){found._overlap=found._intersection._overlap=true;}return found;}var path1=loc.getPath(),path2=loc2.getPath(),diff=path1!==path2?path1._id-path2._id:loc.getIndex()+loc.getTime()-(loc2.getIndex()+loc2.getTime());if(diff<0){r=m-1;}else{l=m+1;}}locations.splice(l,0,loc);return loc;}return{statics:{insert:insert,expand:function(locations){var expanded=locations.slice();for(var i=locations.length-1;i>=0;i--){insert(expanded,locations[i]._intersection,false);}return expanded;}}};}());var PathItem=Item.extend({_class:'PathItem',_selectBounds:false,_canScaleStroke:true,beans:true,initialize:function PathItem(){},statics:{create:function(arg){var data,segments,compound;if(Base.isPlainObject(arg)){segments=arg.segments;data=arg.pathData;}else if(Array.isArray(arg)){segments=arg;}else if(typeof arg==='string'){data=arg;}if(segments){var first=segments[0];compound=first&&Array.isArray(first[0]);}else if(data){compound=(data.match(/m/gi)||[]).length>1||/z\s*\S+/i.test(data);}var ctor=compound?CompoundPath:Path;return new ctor(arg);}},_asPathItem:function(){return this;},isClockwise:function(){return this.getArea()>=0;},setClockwise:function(clockwise){if(this.isClockwise()!=(clockwise=!!clockwise))this.reverse();},setPathData:function(data){var parts=data&&data.match(/[mlhvcsqtaz][^mlhvcsqtaz]*/ig),coords,relative=false,previous,control,current=new Point(),start=new Point();function getCoord(index,coord){var val=+coords[index];if(relative)val+=current[coord];return val;}function getPoint(index){return new Point(getCoord(index,'x'),getCoord(index+1,'y'));}this.clear();for(var i=0,l=parts&&parts.length;i<l;i++){var part=parts[i],command=part[0],lower=command.toLowerCase();coords=part.match(/[+-]?(?:\d*\.\d+|\d+\.?)(?:[eE][+-]?\d+)?/g);var length=coords&&coords.length;relative=command===lower;if(previous==='z'&&!/[mz]/.test(lower))this.moveTo(current);switch(lower){case'm':case'l':var move=lower==='m';for(var j=0;j<length;j+=2){this[move?'moveTo':'lineTo'](current=getPoint(j));if(move){start=current;move=false;}}control=current;break;case'h':case'v':var coord=lower==='h'?'x':'y';current=current.clone();for(var j=0;j<length;j++){current[coord]=getCoord(j,coord);this.lineTo(current);}control=current;break;case'c':for(var j=0;j<length;j+=6){this.cubicCurveTo(getPoint(j),control=getPoint(j+2),current=getPoint(j+4));}break;case's':for(var j=0;j<length;j+=4){this.cubicCurveTo(/[cs]/.test(previous)?current.multiply(2).subtract(control):current,control=getPoint(j),current=getPoint(j+2));previous=lower;}break;case'q':for(var j=0;j<length;j+=4){this.quadraticCurveTo(control=getPoint(j),current=getPoint(j+2));}break;case't':for(var j=0;j<length;j+=2){this.quadraticCurveTo(control=/[qt]/.test(previous)?current.multiply(2).subtract(control):current,current=getPoint(j));previous=lower;}break;case'a':for(var j=0;j<length;j+=7){this.arcTo(current=getPoint(j+5),new Size(+coords[j],+coords[j+1]),+coords[j+2],+coords[j+4],+coords[j+3]);}break;case'z':this.closePath(1e-12);current=start;break;}previous=lower;}},_canComposite:function(){return!(this.hasFill()&&this.hasStroke());},_contains:function(point){var winding=point.isInside(this.getBounds({internal:true,handle:true}))?this._getWinding(point):{};return winding.onPath||!!(this.getFillRule()==='evenodd'?winding.windingL&1||winding.windingR&1:winding.winding);},getIntersections:function(path,include,_matrix,_returnFirst){var self=this===path||!path,matrix1=this._matrix._orNullIfIdentity(),matrix2=self?matrix1:(_matrix||path._matrix)._orNullIfIdentity();return self||this.getBounds(matrix1).intersects(path.getBounds(matrix2),1e-12)?Curve.getIntersections(this.getCurves(),!self&&path.getCurves(),include,matrix1,matrix2,_returnFirst):[];},getCrossings:function(path){return this.getIntersections(path,function(inter){return inter.hasOverlap()||inter.isCrossing();});},getNearestLocation:function(){var point=Point.read(arguments),curves=this.getCurves(),minDist=Infinity,minLoc=null;for(var i=0,l=curves.length;i<l;i++){var loc=curves[i].getNearestLocation(point);if(loc._distance<minDist){minDist=loc._distance;minLoc=loc;}}return minLoc;},getNearestPoint:function(){var loc=this.getNearestLocation.apply(this,arguments);return loc?loc.getPoint():loc;},interpolate:function(from,to,factor){var isPath=!this._children,name=isPath?'_segments':'_children',itemsFrom=from[name],itemsTo=to[name],items=this[name];if(!itemsFrom||!itemsTo||itemsFrom.length!==itemsTo.length){throw new Error('Invalid operands in interpolate() call: '+from+', '+to);}var current=items.length,length=itemsTo.length;if(current<length){var ctor=isPath?Segment:Path;for(var i=current;i<length;i++){this.add(new ctor());}}else if(current>length){this[isPath?'removeSegments':'removeChildren'](length,current);}for(var i=0;i<length;i++){items[i].interpolate(itemsFrom[i],itemsTo[i],factor);}if(isPath){this.setClosed(from._closed);this._changed(9);}},compare:function(path){var ok=false;if(path){var paths1=this._children||[this],paths2=path._children?path._children.slice():[path],length1=paths1.length,length2=paths2.length,matched=[],count=0;ok=true;for(var i1=length1-1;i1>=0&&ok;i1--){var path1=paths1[i1];ok=false;for(var i2=length2-1;i2>=0&&!ok;i2--){if(path1.compare(paths2[i2])){if(!matched[i2]){matched[i2]=true;count++;}ok=true;}}}ok=ok&&count===length2;}return ok;}});var Path=PathItem.extend({_class:'Path',_serializeFields:{segments:[],closed:false},initialize:function Path(arg){this._closed=false;this._segments=[];this._version=0;var segments=Array.isArray(arg)?typeof arg[0]==='object'?arg:arguments:arg&&arg.size===undefined&&(arg.x!==undefined||arg.point!==undefined)?arguments:null;if(segments&&segments.length>0){this.setSegments(segments);}else{this._curves=undefined;this._segmentSelection=0;if(!segments&&typeof arg==='string'){this.setPathData(arg);arg=null;}}this._initialize(!segments&&arg);},_equals:function(item){return this._closed===item._closed&&Base.equals(this._segments,item._segments);},copyContent:function(source){this.setSegments(source._segments);this._closed=source._closed;},_changed:function _changed(flags){_changed.base.call(this,flags);if(flags&8){this._length=this._area=undefined;if(flags&16){this._version++;}else if(this._curves){for(var i=0,l=this._curves.length;i<l;i++)this._curves[i]._changed();}}else if(flags&32){this._bounds=undefined;}},getStyle:function(){var parent=this._parent;return(parent instanceof CompoundPath?parent:this)._style;},getSegments:function(){return this._segments;},setSegments:function(segments){var fullySelected=this.isFullySelected(),length=segments&&segments.length;this._segments.length=0;this._segmentSelection=0;this._curves=undefined;if(length){var last=segments[length-1];if(typeof last==='boolean'){this.setClosed(last);length--;}this._add(Segment.readList(segments,0,{},length));}if(fullySelected)this.setFullySelected(true);},getFirstSegment:function(){return this._segments[0];},getLastSegment:function(){return this._segments[this._segments.length-1];},getCurves:function(){var curves=this._curves,segments=this._segments;if(!curves){var length=this._countCurves();curves=this._curves=new Array(length);for(var i=0;i<length;i++)curves[i]=new Curve(this,segments[i],segments[i+1]||segments[0]);}return curves;},getFirstCurve:function(){return this.getCurves()[0];},getLastCurve:function(){var curves=this.getCurves();return curves[curves.length-1];},isClosed:function(){return this._closed;},setClosed:function(closed){if(this._closed!=(closed=!!closed)){this._closed=closed;if(this._curves){var length=this._curves.length=this._countCurves();if(closed)this._curves[length-1]=new Curve(this,this._segments[length-1],this._segments[0]);}this._changed(25);}}},{beans:true,getPathData:function(_matrix,_precision){var segments=this._segments,length=segments.length,f=new Formatter(_precision),coords=new Array(6),first=true,curX,curY,prevX,prevY,inX,inY,outX,outY,parts=[];function addSegment(segment,skipLine){segment._transformCoordinates(_matrix,coords);curX=coords[0];curY=coords[1];if(first){parts.push('M'+f.pair(curX,curY));first=false;}else{inX=coords[2];inY=coords[3];if(inX===curX&&inY===curY&&outX===prevX&&outY===prevY){if(!skipLine){var dx=curX-prevX,dy=curY-prevY;parts.push(dx===0?'v'+f.number(dy):dy===0?'h'+f.number(dx):'l'+f.pair(dx,dy));}}else{parts.push('c'+f.pair(outX-prevX,outY-prevY)+' '+f.pair(inX-prevX,inY-prevY)+' '+f.pair(curX-prevX,curY-prevY));}}prevX=curX;prevY=curY;outX=coords[4];outY=coords[5];}if(!length)return'';for(var i=0;i<length;i++)addSegment(segments[i]);if(this._closed&&length>0){addSegment(segments[0],true);parts.push('z');}return parts.join('');},isEmpty:function(){return!this._segments.length;},_transformContent:function(matrix){var segments=this._segments,coords=new Array(6);for(var i=0,l=segments.length;i<l;i++)segments[i]._transformCoordinates(matrix,coords,true);return true;},_add:function(segs,index){var segments=this._segments,curves=this._curves,amount=segs.length,append=index==null,index=append?segments.length:index;for(var i=0;i<amount;i++){var segment=segs[i];if(segment._path)segment=segs[i]=segment.clone();segment._path=this;segment._index=index+i;if(segment._selection)this._updateSelection(segment,0,segment._selection);}if(append){segments.push.apply(segments,segs);}else{segments.splice.apply(segments,[index,0].concat(segs));for(var i=index+amount,l=segments.length;i<l;i++)segments[i]._index=i;}if(curves){var total=this._countCurves(),start=index>0&&index+amount-1===total?index-1:index,insert=start,end=Math.min(start+amount,total);if(segs._curves){curves.splice.apply(curves,[start,0].concat(segs._curves));insert+=segs._curves.length;}for(var i=insert;i<end;i++)curves.splice(i,0,new Curve(this,null,null));this._adjustCurves(start,end);}this._changed(25);return segs;},_adjustCurves:function(start,end){var segments=this._segments,curves=this._curves,curve;for(var i=start;i<end;i++){curve=curves[i];curve._path=this;curve._segment1=segments[i];curve._segment2=segments[i+1]||segments[0];curve._changed();}if(curve=curves[this._closed&&!start?segments.length-1:start-1]){curve._segment2=segments[start]||segments[0];curve._changed();}if(curve=curves[end]){curve._segment1=segments[end];curve._changed();}},_countCurves:function(){var length=this._segments.length;return!this._closed&&length>0?length-1:length;},add:function(segment1){return arguments.length>1&&typeof segment1!=='number'?this._add(Segment.readList(arguments)):this._add([Segment.read(arguments)])[0];},insert:function(index,segment1){return arguments.length>2&&typeof segment1!=='number'?this._add(Segment.readList(arguments,1),index):this._add([Segment.read(arguments,1)],index)[0];},addSegment:function(){return this._add([Segment.read(arguments)])[0];},insertSegment:function(index){return this._add([Segment.read(arguments,1)],index)[0];},addSegments:function(segments){return this._add(Segment.readList(segments));},insertSegments:function(index,segments){return this._add(Segment.readList(segments),index);},removeSegment:function(index){return this.removeSegments(index,index+1)[0]||null;},removeSegments:function(start,end,_includeCurves){start=start||0;end=Base.pick(end,this._segments.length);var segments=this._segments,curves=this._curves,count=segments.length,removed=segments.splice(start,end-start),amount=removed.length;if(!amount)return removed;for(var i=0;i<amount;i++){var segment=removed[i];if(segment._selection)this._updateSelection(segment,segment._selection,0);segment._index=segment._path=null;}for(var i=start,l=segments.length;i<l;i++)segments[i]._index=i;if(curves){var index=start>0&&end===count+(this._closed?1:0)?start-1:start,curves=curves.splice(index,amount);for(var i=curves.length-1;i>=0;i--)curves[i]._path=null;if(_includeCurves)removed._curves=curves.slice(1);this._adjustCurves(index,index);}this._changed(25);return removed;},clear:'#removeSegments',hasHandles:function(){var segments=this._segments;for(var i=0,l=segments.length;i<l;i++){if(segments[i].hasHandles())return true;}return false;},clearHandles:function(){var segments=this._segments;for(var i=0,l=segments.length;i<l;i++)segments[i].clearHandles();},getLength:function(){if(this._length==null){var curves=this.getCurves(),length=0;for(var i=0,l=curves.length;i<l;i++)length+=curves[i].getLength();this._length=length;}return this._length;},getArea:function(){var area=this._area;if(area==null){var segments=this._segments,closed=this._closed;area=0;for(var i=0,l=segments.length;i<l;i++){var last=i+1===l;area+=Curve.getArea(Curve.getValues(segments[i],segments[last?0:i+1],null,last&&!closed));}this._area=area;}return area;},isFullySelected:function(){var length=this._segments.length;return this.isSelected()&&length>0&&this._segmentSelection===length*7;},setFullySelected:function(selected){if(selected)this._selectSegments(true);this.setSelected(selected);},setSelection:function setSelection(selection){if(!(selection&1))this._selectSegments(false);setSelection.base.call(this,selection);},_selectSegments:function(selected){var segments=this._segments,length=segments.length,selection=selected?7:0;this._segmentSelection=selection*length;for(var i=0;i<length;i++)segments[i]._selection=selection;},_updateSelection:function(segment,oldSelection,newSelection){segment._selection=newSelection;var selection=this._segmentSelection+=newSelection-oldSelection;if(selection>0)this.setSelected(true);},divideAt:function(location){var loc=this.getLocationAt(location),curve;return loc&&(curve=loc.getCurve().divideAt(loc.getCurveOffset()))?curve._segment1:null;},splitAt:function(location){var loc=this.getLocationAt(location),index=loc&&loc.index,time=loc&&loc.time,tMin=1e-8,tMax=1-tMin;if(time>tMax){index++;time=0;}var curves=this.getCurves();if(index>=0&&index<curves.length){if(time>=tMin){curves[index++].divideAtTime(time);}var segs=this.removeSegments(index,this._segments.length,true),path;if(this._closed){this.setClosed(false);path=this;}else{path=new Path(Item.NO_INSERT);path.insertAbove(this);path.copyAttributes(this);}path._add(segs,0);this.addSegment(segs[0]);return path;}return null;},split:function(index,time){var curve,location=time===undefined?index:(curve=this.getCurves()[index])&&curve.getLocationAtTime(time);return location!=null?this.splitAt(location):null;},join:function(path,tolerance){var epsilon=tolerance||0;if(path&&path!==this){var segments=path._segments,last1=this.getLastSegment(),last2=path.getLastSegment();if(!last2)return this;if(last1&&last1._point.isClose(last2._point,epsilon))path.reverse();var first2=path.getFirstSegment();if(last1&&last1._point.isClose(first2._point,epsilon)){last1.setHandleOut(first2._handleOut);this._add(segments.slice(1));}else{var first1=this.getFirstSegment();if(first1&&first1._point.isClose(first2._point,epsilon))path.reverse();last2=path.getLastSegment();if(first1&&first1._point.isClose(last2._point,epsilon)){first1.setHandleIn(last2._handleIn);this._add(segments.slice(0,segments.length-1),0);}else{this._add(segments.slice());}}if(path._closed)this._add([segments[0]]);path.remove();}var first=this.getFirstSegment(),last=this.getLastSegment();if(first!==last&&first._point.isClose(last._point,epsilon)){first.setHandleIn(last._handleIn);last.remove();this.setClosed(true);}return this;},reduce:function(options){var curves=this.getCurves(),simplify=options&&options.simplify,tolerance=simplify?1e-7:0;for(var i=curves.length-1;i>=0;i--){var curve=curves[i];if(!curve.hasHandles()&&(!curve.hasLength(tolerance)||simplify&&curve.isCollinear(curve.getNext())))curve.remove();}return this;},reverse:function(){this._segments.reverse();for(var i=0,l=this._segments.length;i<l;i++){var segment=this._segments[i];var handleIn=segment._handleIn;segment._handleIn=segment._handleOut;segment._handleOut=handleIn;segment._index=i;}this._curves=null;this._changed(9);},flatten:function(flatness){var flattener=new PathFlattener(this,flatness||0.25,256,true),parts=flattener.parts,length=parts.length,segments=[];for(var i=0;i<length;i++){segments.push(new Segment(parts[i].curve.slice(0,2)));}if(!this._closed&&length>0){segments.push(new Segment(parts[length-1].curve.slice(6)));}this.setSegments(segments);},simplify:function(tolerance){var segments=new PathFitter(this).fit(tolerance||2.5);if(segments)this.setSegments(segments);return!!segments;},smooth:function(options){var that=this,opts=options||{},type=opts.type||'asymmetric',segments=this._segments,length=segments.length,closed=this._closed;function getIndex(value,_default){var index=value&&value.index;if(index!=null){var path=value.path;if(path&&path!==that)throw new Error(value._class+' '+index+' of '+path+' is not part of '+that);if(_default&&value instanceof Curve)index++;}else{index=typeof value==='number'?value:_default;}return Math.min(index<0&&closed?index%length:index<0?index+length:index,length-1);}var loop=closed&&opts.from===undefined&&opts.to===undefined,from=getIndex(opts.from,0),to=getIndex(opts.to,length-1);if(from>to){if(closed){from-=length;}else{var tmp=from;from=to;to=tmp;}}if(/^(?:asymmetric|continuous)$/.test(type)){var asymmetric=type==='asymmetric',min=Math.min,amount=to-from+1,n=amount-1,padding=loop?min(amount,4):1,paddingLeft=padding,paddingRight=padding,knots=[];if(!closed){paddingLeft=min(1,from);paddingRight=min(1,length-to-1);}n+=paddingLeft+paddingRight;if(n<=1)return;for(var i=0,j=from-paddingLeft;i<=n;i++,j++){knots[i]=segments[(j<0?j+length:j)%length]._point;}var x=knots[0]._x+2*knots[1]._x,y=knots[0]._y+2*knots[1]._y,f=2,n_1=n-1,rx=[x],ry=[y],rf=[f],px=[],py=[];for(var i=1;i<n;i++){var internal=i<n_1,a=internal?1:asymmetric?1:2,b=internal?4:asymmetric?2:7,u=internal?4:asymmetric?3:8,v=internal?2:asymmetric?0:1,m=a/f;f=rf[i]=b-m;x=rx[i]=u*knots[i]._x+v*knots[i+1]._x-m*x;y=ry[i]=u*knots[i]._y+v*knots[i+1]._y-m*y;}px[n_1]=rx[n_1]/rf[n_1];py[n_1]=ry[n_1]/rf[n_1];for(var i=n-2;i>=0;i--){px[i]=(rx[i]-px[i+1])/rf[i];py[i]=(ry[i]-py[i+1])/rf[i];}px[n]=(3*knots[n]._x-px[n_1])/2;py[n]=(3*knots[n]._y-py[n_1])/2;for(var i=paddingLeft,max=n-paddingRight,j=from;i<=max;i++,j++){var segment=segments[j<0?j+length:j],pt=segment._point,hx=px[i]-pt._x,hy=py[i]-pt._y;if(loop||i<max)segment.setHandleOut(hx,hy);if(loop||i>paddingLeft)segment.setHandleIn(-hx,-hy);}}else{for(var i=from;i<=to;i++){segments[i<0?i+length:i].smooth(opts,!loop&&i===from,!loop&&i===to);}}},toShape:function(insert){if(!this._closed)return null;var segments=this._segments,type,size,radius,topCenter;function isCollinear(i,j){var seg1=segments[i],seg2=seg1.getNext(),seg3=segments[j],seg4=seg3.getNext();return seg1._handleOut.isZero()&&seg2._handleIn.isZero()&&seg3._handleOut.isZero()&&seg4._handleIn.isZero()&&seg2._point.subtract(seg1._point).isCollinear(seg4._point.subtract(seg3._point));}function isOrthogonal(i){var seg2=segments[i],seg1=seg2.getPrevious(),seg3=seg2.getNext();return seg1._handleOut.isZero()&&seg2._handleIn.isZero()&&seg2._handleOut.isZero()&&seg3._handleIn.isZero()&&seg2._point.subtract(seg1._point).isOrthogonal(seg3._point.subtract(seg2._point));}function isArc(i){var seg1=segments[i],seg2=seg1.getNext(),handle1=seg1._handleOut,handle2=seg2._handleIn,kappa=0.5522847498307936;if(handle1.isOrthogonal(handle2)){var pt1=seg1._point,pt2=seg2._point,corner=new Line(pt1,handle1,true).intersect(new Line(pt2,handle2,true),true);return corner&&Numerical.isZero(handle1.getLength()/corner.subtract(pt1).getLength()-kappa)&&Numerical.isZero(handle2.getLength()/corner.subtract(pt2).getLength()-kappa);}return false;}function getDistance(i,j){return segments[i]._point.getDistance(segments[j]._point);}if(!this.hasHandles()&&segments.length===4&&isCollinear(0,2)&&isCollinear(1,3)&&isOrthogonal(1)){type=Shape.Rectangle;size=new Size(getDistance(0,3),getDistance(0,1));topCenter=segments[1]._point.add(segments[2]._point).divide(2);}else if(segments.length===8&&isArc(0)&&isArc(2)&&isArc(4)&&isArc(6)&&isCollinear(1,5)&&isCollinear(3,7)){type=Shape.Rectangle;size=new Size(getDistance(1,6),getDistance(0,3));radius=size.subtract(new Size(getDistance(0,7),getDistance(1,2))).divide(2);topCenter=segments[3]._point.add(segments[4]._point).divide(2);}else if(segments.length===4&&isArc(0)&&isArc(1)&&isArc(2)&&isArc(3)){if(Numerical.isZero(getDistance(0,2)-getDistance(1,3))){type=Shape.Circle;radius=getDistance(0,2)/2;}else{type=Shape.Ellipse;radius=new Size(getDistance(2,0)/2,getDistance(3,1)/2);}topCenter=segments[1]._point;}if(type){var center=this.getPosition(true),shape=new type({center:center,size:size,radius:radius,insert:false});shape.copyAttributes(this,true);shape._matrix.prepend(this._matrix);shape.rotate(topCenter.subtract(center).getAngle()+90);if(insert===undefined||insert)shape.insertAbove(this);return shape;}return null;},toPath:'#clone',compare:function compare(path){if(!path||path instanceof CompoundPath)return compare.base.call(this,path);var curves1=this.getCurves(),curves2=path.getCurves(),length1=curves1.length,length2=curves2.length;if(!length1||!length2){return length1==length2;}var v1=curves1[0].getValues(),values2=[],pos1=0,pos2,end1=0,end2;for(var i=0;i<length2;i++){var v2=curves2[i].getValues();values2.push(v2);var overlaps=Curve.getOverlaps(v1,v2);if(overlaps){pos2=!i&&overlaps[0][0]>0?length2-1:i;end2=overlaps[0][1];break;}}var abs=Math.abs,epsilon=1e-8,v2=values2[pos2],start2;while(v1&&v2){var overlaps=Curve.getOverlaps(v1,v2);if(overlaps){var t1=overlaps[0][0];if(abs(t1-end1)<epsilon){end1=overlaps[1][0];if(end1===1){v1=++pos1<length1?curves1[pos1].getValues():null;end1=0;}var t2=overlaps[0][1];if(abs(t2-end2)<epsilon){if(!start2)start2=[pos2,t2];end2=overlaps[1][1];if(end2===1){if(++pos2>=length2)pos2=0;v2=values2[pos2]||curves2[pos2].getValues();end2=0;}if(!v1){return start2[0]===pos2&&start2[1]===end2;}continue;}}}break;}return false;},_hitTestSelf:function(point,options,viewMatrix,strokeMatrix){var that=this,style=this.getStyle(),segments=this._segments,numSegments=segments.length,closed=this._closed,tolerancePadding=options._tolerancePadding,strokePadding=tolerancePadding,join,cap,miterLimit,area,loc,res,hitStroke=options.stroke&&style.hasStroke(),hitFill=options.fill&&style.hasFill(),hitCurves=options.curves,strokeRadius=hitStroke?style.getStrokeWidth()/2:hitFill&&options.tolerance>0||hitCurves?0:null;if(strokeRadius!==null){if(strokeRadius>0){join=style.getStrokeJoin();cap=style.getStrokeCap();miterLimit=style.getMiterLimit();strokePadding=strokePadding.add(Path._getStrokePadding(strokeRadius,strokeMatrix));}else{join=cap='round';}}function isCloseEnough(pt,padding){return point.subtract(pt).divide(padding).length<=1;}function checkSegmentPoint(seg,pt,name){if(!options.selected||pt.isSelected()){var anchor=seg._point;if(pt!==anchor)pt=pt.add(anchor);if(isCloseEnough(pt,strokePadding)){return new HitResult(name,that,{segment:seg,point:pt});}}}function checkSegmentPoints(seg,ends){return(ends||options.segments)&&checkSegmentPoint(seg,seg._point,'segment')||!ends&&options.handles&&(checkSegmentPoint(seg,seg._handleIn,'handle-in')||checkSegmentPoint(seg,seg._handleOut,'handle-out'));}function addToArea(point){area.add(point);}function checkSegmentStroke(segment){var isJoin=closed||segment._index>0&&segment._index<numSegments-1;if((isJoin?join:cap)==='round'){return isCloseEnough(segment._point,strokePadding);}else{area=new Path({internal:true,closed:true});if(isJoin){if(!segment.isSmooth()){Path._addBevelJoin(segment,join,strokeRadius,miterLimit,null,strokeMatrix,addToArea,true);}}else if(cap==='square'){Path._addSquareCap(segment,cap,strokeRadius,null,strokeMatrix,addToArea,true);}if(!area.isEmpty()){var loc;return area.contains(point)||(loc=area.getNearestLocation(point))&&isCloseEnough(loc.getPoint(),tolerancePadding);}}}if(options.ends&&!options.segments&&!closed){if(res=checkSegmentPoints(segments[0],true)||checkSegmentPoints(segments[numSegments-1],true))return res;}else if(options.segments||options.handles){for(var i=0;i<numSegments;i++)if(res=checkSegmentPoints(segments[i]))return res;}if(strokeRadius!==null){loc=this.getNearestLocation(point);if(loc){var time=loc.getTime();if(time===0||time===1&&numSegments>1){if(!checkSegmentStroke(loc.getSegment()))loc=null;}else if(!isCloseEnough(loc.getPoint(),strokePadding)){loc=null;}}if(!loc&&join==='miter'&&numSegments>1){for(var i=0;i<numSegments;i++){var segment=segments[i];if(point.getDistance(segment._point)<=miterLimit*strokeRadius&&checkSegmentStroke(segment)){loc=segment.getLocation();break;}}}}return!loc&&hitFill&&this._contains(point)||loc&&!hitStroke&&!hitCurves?new HitResult('fill',this):loc?new HitResult(hitStroke?'stroke':'curve',this,{location:loc,point:loc.getPoint()}):null;}},Base.each(Curve._evaluateMethods,function(name){this[name+'At']=function(offset){var loc=this.getLocationAt(offset);return loc&&loc[name]();};},{beans:false,getLocationOf:function(){var point=Point.read(arguments),curves=this.getCurves();for(var i=0,l=curves.length;i<l;i++){var loc=curves[i].getLocationOf(point);if(loc)return loc;}return null;},getOffsetOf:function(){var loc=this.getLocationOf.apply(this,arguments);return loc?loc.getOffset():null;},getLocationAt:function(offset){if(typeof offset==='number'){var curves=this.getCurves(),length=0;for(var i=0,l=curves.length;i<l;i++){var start=length,curve=curves[i];length+=curve.getLength();if(length>offset){return curve.getLocationAt(offset-start);}}if(curves.length>0&&offset<=this.getLength()){return new CurveLocation(curves[curves.length-1],1);}}else if(offset&&offset.getPath&&offset.getPath()===this){return offset;}return null;}}),new function(){function drawHandles(ctx,segments,matrix,size){var half=size/2,coords=new Array(6),pX,pY;function drawHandle(index){var hX=coords[index],hY=coords[index+1];if(pX!=hX||pY!=hY){ctx.beginPath();ctx.moveTo(pX,pY);ctx.lineTo(hX,hY);ctx.stroke();ctx.beginPath();ctx.arc(hX,hY,half,0,Math.PI*2,true);ctx.fill();}}for(var i=0,l=segments.length;i<l;i++){var segment=segments[i],selection=segment._selection;segment._transformCoordinates(matrix,coords);pX=coords[0];pY=coords[1];if(selection&2)drawHandle(2);if(selection&4)drawHandle(4);ctx.fillRect(pX-half,pY-half,size,size);if(!(selection&1)){var fillStyle=ctx.fillStyle;ctx.fillStyle='#ffffff';ctx.fillRect(pX-half+1,pY-half+1,size-2,size-2);ctx.fillStyle=fillStyle;}}}function drawSegments(ctx,path,matrix){var segments=path._segments,length=segments.length,coords=new Array(6),first=true,curX,curY,prevX,prevY,inX,inY,outX,outY;function drawSegment(segment){if(matrix){segment._transformCoordinates(matrix,coords);curX=coords[0];curY=coords[1];}else{var point=segment._point;curX=point._x;curY=point._y;}if(first){ctx.moveTo(curX,curY);first=false;}else{if(matrix){inX=coords[2];inY=coords[3];}else{var handle=segment._handleIn;inX=curX+handle._x;inY=curY+handle._y;}if(inX===curX&&inY===curY&&outX===prevX&&outY===prevY){ctx.lineTo(curX,curY);}else{ctx.bezierCurveTo(outX,outY,inX,inY,curX,curY);}}prevX=curX;prevY=curY;if(matrix){outX=coords[4];outY=coords[5];}else{var handle=segment._handleOut;outX=prevX+handle._x;outY=prevY+handle._y;}}for(var i=0;i<length;i++)drawSegment(segments[i]);if(path._closed&&length>0)drawSegment(segments[0]);}return{_draw:function(ctx,param,viewMatrix,strokeMatrix){var dontStart=param.dontStart,dontPaint=param.dontFinish||param.clip,style=this.getStyle(),hasFill=style.hasFill(),hasStroke=style.hasStroke(),dashArray=style.getDashArray(),dashLength=!paper.support.nativeDash&&hasStroke&&dashArray&&dashArray.length;if(!dontStart)ctx.beginPath();if(hasFill||hasStroke&&!dashLength||dontPaint){drawSegments(ctx,this,strokeMatrix);if(this._closed)ctx.closePath();}function getOffset(i){return dashArray[(i%dashLength+dashLength)%dashLength];}if(!dontPaint&&(hasFill||hasStroke)){this._setStyles(ctx,param,viewMatrix);if(hasFill){ctx.fill(style.getFillRule());ctx.shadowColor='rgba(0,0,0,0)';}if(hasStroke){if(dashLength){if(!dontStart)ctx.beginPath();var flattener=new PathFlattener(this,0.25,32,false,strokeMatrix),length=flattener.length,from=-style.getDashOffset(),to,i=0;from=from%length;while(from>0){from-=getOffset(i--)+getOffset(i--);}while(from<length){to=from+getOffset(i++);if(from>0||to>0)flattener.drawPart(ctx,Math.max(from,0),Math.max(to,0));from=to+getOffset(i++);}}ctx.stroke();}}},_drawSelected:function(ctx,matrix){ctx.beginPath();drawSegments(ctx,this,matrix);ctx.stroke();drawHandles(ctx,this._segments,matrix,paper.settings.handleSize);}};}(),new function(){function getCurrentSegment(that){var segments=that._segments;if(!segments.length)throw new Error('Use a moveTo() command first');return segments[segments.length-1];}return{moveTo:function(){var segments=this._segments;if(segments.length===1)this.removeSegment(0);if(!segments.length)this._add([new Segment(Point.read(arguments))]);},moveBy:function(){throw new Error('moveBy() is unsupported on Path items.');},lineTo:function(){this._add([new Segment(Point.read(arguments))]);},cubicCurveTo:function(){var handle1=Point.read(arguments),handle2=Point.read(arguments),to=Point.read(arguments),current=getCurrentSegment(this);current.setHandleOut(handle1.subtract(current._point));this._add([new Segment(to,handle2.subtract(to))]);},quadraticCurveTo:function(){var handle=Point.read(arguments),to=Point.read(arguments),current=getCurrentSegment(this)._point;this.cubicCurveTo(handle.add(current.subtract(handle).multiply(1/3)),handle.add(to.subtract(handle).multiply(1/3)),to);},curveTo:function(){var through=Point.read(arguments),to=Point.read(arguments),t=Base.pick(Base.read(arguments),0.5),t1=1-t,current=getCurrentSegment(this)._point,handle=through.subtract(current.multiply(t1*t1)).subtract(to.multiply(t*t)).divide(2*t*t1);if(handle.isNaN())throw new Error('Cannot put a curve through points with parameter = '+t);this.quadraticCurveTo(handle,to);},arcTo:function(){var abs=Math.abs,sqrt=Math.sqrt,current=getCurrentSegment(this),from=current._point,to=Point.read(arguments),through,peek=Base.peek(arguments),clockwise=Base.pick(peek,true),center,extent,vector,matrix;if(typeof clockwise==='boolean'){var middle=from.add(to).divide(2),through=middle.add(middle.subtract(from).rotate(clockwise?-90:90));}else if(Base.remain(arguments)<=2){through=to;to=Point.read(arguments);}else{var radius=Size.read(arguments),isZero=Numerical.isZero;if(isZero(radius.width)||isZero(radius.height))return this.lineTo(to);var rotation=Base.read(arguments),clockwise=!!Base.read(arguments),large=!!Base.read(arguments),middle=from.add(to).divide(2),pt=from.subtract(middle).rotate(-rotation),x=pt.x,y=pt.y,rx=abs(radius.width),ry=abs(radius.height),rxSq=rx*rx,rySq=ry*ry,xSq=x*x,ySq=y*y;var factor=sqrt(xSq/rxSq+ySq/rySq);if(factor>1){rx*=factor;ry*=factor;rxSq=rx*rx;rySq=ry*ry;}factor=(rxSq*rySq-rxSq*ySq-rySq*xSq)/(rxSq*ySq+rySq*xSq);if(abs(factor)<1e-12)factor=0;if(factor<0)throw new Error('Cannot create an arc with the given arguments');center=new Point(rx*y/ry,-ry*x/rx).multiply((large===clockwise?-1:1)*sqrt(factor)).rotate(rotation).add(middle);matrix=new Matrix().translate(center).rotate(rotation).scale(rx,ry);vector=matrix._inverseTransform(from);extent=vector.getDirectedAngle(matrix._inverseTransform(to));if(!clockwise&&extent>0)extent-=360;else if(clockwise&&extent<0)extent+=360;}if(through){var l1=new Line(from.add(through).divide(2),through.subtract(from).rotate(90),true),l2=new Line(through.add(to).divide(2),to.subtract(through).rotate(90),true),line=new Line(from,to),throughSide=line.getSide(through);center=l1.intersect(l2,true);if(!center){if(!throughSide)return this.lineTo(to);throw new Error('Cannot create an arc with the given arguments');}vector=from.subtract(center);extent=vector.getDirectedAngle(to.subtract(center));var centerSide=line.getSide(center);if(centerSide===0){extent=throughSide*abs(extent);}else if(throughSide===centerSide){extent+=extent<0?360:-360;}}var epsilon=1e-7,ext=abs(extent),count=ext>=360?4:Math.ceil((ext-epsilon)/90),inc=extent/count,half=inc*Math.PI/360,z=4/3*Math.sin(half)/(1+Math.cos(half)),segments=[];for(var i=0;i<=count;i++){var pt=to,out=null;if(i<count){out=vector.rotate(90).multiply(z);if(matrix){pt=matrix._transformPoint(vector);out=matrix._transformPoint(vector.add(out)).subtract(pt);}else{pt=center.add(vector);}}if(!i){current.setHandleOut(out);}else{var _in=vector.rotate(-90).multiply(z);if(matrix){_in=matrix._transformPoint(vector.add(_in)).subtract(pt);}segments.push(new Segment(pt,_in,out));}vector=vector.rotate(inc);}this._add(segments);},lineBy:function(){var to=Point.read(arguments),current=getCurrentSegment(this)._point;this.lineTo(current.add(to));},curveBy:function(){var through=Point.read(arguments),to=Point.read(arguments),parameter=Base.read(arguments),current=getCurrentSegment(this)._point;this.curveTo(current.add(through),current.add(to),parameter);},cubicCurveBy:function(){var handle1=Point.read(arguments),handle2=Point.read(arguments),to=Point.read(arguments),current=getCurrentSegment(this)._point;this.cubicCurveTo(current.add(handle1),current.add(handle2),current.add(to));},quadraticCurveBy:function(){var handle=Point.read(arguments),to=Point.read(arguments),current=getCurrentSegment(this)._point;this.quadraticCurveTo(current.add(handle),current.add(to));},arcBy:function(){var current=getCurrentSegment(this)._point,point=current.add(Point.read(arguments)),clockwise=Base.pick(Base.peek(arguments),true);if(typeof clockwise==='boolean'){this.arcTo(point,clockwise);}else{this.arcTo(point,current.add(Point.read(arguments)));}},closePath:function(tolerance){this.setClosed(true);this.join(this,tolerance);}};}(),{_getBounds:function(matrix,options){var method=options.handle?'getHandleBounds':options.stroke?'getStrokeBounds':'getBounds';return Path[method](this._segments,this._closed,this,matrix,options);},statics:{getBounds:function(segments,closed,path,matrix,options,strokePadding){var first=segments[0];if(!first)return new Rectangle();var coords=new Array(6),prevCoords=first._transformCoordinates(matrix,new Array(6)),min=prevCoords.slice(0,2),max=min.slice(),roots=new Array(2);function processSegment(segment){segment._transformCoordinates(matrix,coords);for(var i=0;i<2;i++){Curve._addBounds(prevCoords[i],prevCoords[i+4],coords[i+2],coords[i],i,strokePadding?strokePadding[i]:0,min,max,roots);}var tmp=prevCoords;prevCoords=coords;coords=tmp;}for(var i=1,l=segments.length;i<l;i++)processSegment(segments[i]);if(closed)processSegment(first);return new Rectangle(min[0],min[1],max[0]-min[0],max[1]-min[1]);},getStrokeBounds:function(segments,closed,path,matrix,options){var style=path.getStyle(),stroke=style.hasStroke(),strokeWidth=style.getStrokeWidth(),strokeMatrix=stroke&&path._getStrokeMatrix(matrix,options),strokePadding=stroke&&Path._getStrokePadding(strokeWidth,strokeMatrix),bounds=Path.getBounds(segments,closed,path,matrix,options,strokePadding);if(!stroke)return bounds;var strokeRadius=strokeWidth/2,join=style.getStrokeJoin(),cap=style.getStrokeCap(),miterLimit=style.getMiterLimit(),joinBounds=new Rectangle(new Size(strokePadding));function addPoint(point){bounds=bounds.include(point);}function addRound(segment){bounds=bounds.unite(joinBounds.setCenter(segment._point.transform(matrix)));}function addJoin(segment,join){if(join==='round'||segment.isSmooth()){addRound(segment);}else{Path._addBevelJoin(segment,join,strokeRadius,miterLimit,matrix,strokeMatrix,addPoint);}}function addCap(segment,cap){if(cap==='round'){addRound(segment);}else{Path._addSquareCap(segment,cap,strokeRadius,matrix,strokeMatrix,addPoint);}}var length=segments.length-(closed?0:1);for(var i=1;i<length;i++)addJoin(segments[i],join);if(closed){addJoin(segments[0],join);}else if(length>0){addCap(segments[0],cap);addCap(segments[segments.length-1],cap);}return bounds;},_getStrokePadding:function(radius,matrix){if(!matrix)return[radius,radius];var hor=new Point(radius,0).transform(matrix),ver=new Point(0,radius).transform(matrix),phi=hor.getAngleInRadians(),a=hor.getLength(),b=ver.getLength();var sin=Math.sin(phi),cos=Math.cos(phi),tan=Math.tan(phi),tx=Math.atan2(b*tan,a),ty=Math.atan2(b,tan*a);return[Math.abs(a*Math.cos(tx)*cos+b*Math.sin(tx)*sin),Math.abs(b*Math.sin(ty)*cos+a*Math.cos(ty)*sin)];},_addBevelJoin:function(segment,join,radius,miterLimit,matrix,strokeMatrix,addPoint,isArea){var curve2=segment.getCurve(),curve1=curve2.getPrevious(),point=curve2.getPoint1().transform(matrix),normal1=curve1.getNormalAtTime(1).multiply(radius).transform(strokeMatrix),normal2=curve2.getNormalAtTime(0).multiply(radius).transform(strokeMatrix);if(normal1.getDirectedAngle(normal2)<0){normal1=normal1.negate();normal2=normal2.negate();}if(isArea)addPoint(point);addPoint(point.add(normal1));if(join==='miter'){var corner=new Line(point.add(normal1),new Point(-normal1.y,normal1.x),true).intersect(new Line(point.add(normal2),new Point(-normal2.y,normal2.x),true),true);if(corner&&point.getDistance(corner)<=miterLimit*radius){addPoint(corner);}}addPoint(point.add(normal2));},_addSquareCap:function(segment,cap,radius,matrix,strokeMatrix,addPoint,isArea){var point=segment._point.transform(matrix),loc=segment.getLocation(),normal=loc.getNormal().multiply(loc.getTime()===0?radius:-radius).transform(strokeMatrix);if(cap==='square'){if(isArea){addPoint(point.subtract(normal));addPoint(point.add(normal));}point=point.add(normal.rotate(-90));}addPoint(point.add(normal));addPoint(point.subtract(normal));},getHandleBounds:function(segments,closed,path,matrix,options){var style=path.getStyle(),stroke=options.stroke&&style.hasStroke(),strokePadding,joinPadding;if(stroke){var strokeMatrix=path._getStrokeMatrix(matrix,options),strokeRadius=style.getStrokeWidth()/2,joinRadius=strokeRadius;if(style.getStrokeJoin()==='miter')joinRadius=strokeRadius*style.getMiterLimit();if(style.getStrokeCap()==='square')joinRadius=Math.max(joinRadius,strokeRadius*Math.SQRT2);strokePadding=Path._getStrokePadding(strokeRadius,strokeMatrix);joinPadding=Path._getStrokePadding(joinRadius,strokeMatrix);}var coords=new Array(6),x1=Infinity,x2=-x1,y1=x1,y2=x2;for(var i=0,l=segments.length;i<l;i++){var segment=segments[i];segment._transformCoordinates(matrix,coords);for(var j=0;j<6;j+=2){var padding=!j?joinPadding:strokePadding,paddingX=padding?padding[0]:0,paddingY=padding?padding[1]:0,x=coords[j],y=coords[j+1],xn=x-paddingX,xx=x+paddingX,yn=y-paddingY,yx=y+paddingY;if(xn<x1)x1=xn;if(xx>x2)x2=xx;if(yn<y1)y1=yn;if(yx>y2)y2=yx;}}return new Rectangle(x1,y1,x2-x1,y2-y1);}}});Path.inject({statics:new function(){var kappa=0.5522847498307936,ellipseSegments=[new Segment([-1,0],[0,kappa],[0,-kappa]),new Segment([0,-1],[-kappa,0],[kappa,0]),new Segment([1,0],[0,-kappa],[0,kappa]),new Segment([0,1],[kappa,0],[-kappa,0])];function createPath(segments,closed,args){var props=Base.getNamed(args),path=new Path(props&&props.insert==false&&Item.NO_INSERT);path._add(segments);path._closed=closed;return path.set(props,{insert:true});}function createEllipse(center,radius,args){var segments=new Array(4);for(var i=0;i<4;i++){var segment=ellipseSegments[i];segments[i]=new Segment(segment._point.multiply(radius).add(center),segment._handleIn.multiply(radius),segment._handleOut.multiply(radius));}return createPath(segments,true,args);}return{Line:function(){return createPath([new Segment(Point.readNamed(arguments,'from')),new Segment(Point.readNamed(arguments,'to'))],false,arguments);},Circle:function(){var center=Point.readNamed(arguments,'center'),radius=Base.readNamed(arguments,'radius');return createEllipse(center,new Size(radius),arguments);},Rectangle:function(){var rect=Rectangle.readNamed(arguments,'rectangle'),radius=Size.readNamed(arguments,'radius',0,{readNull:true}),bl=rect.getBottomLeft(true),tl=rect.getTopLeft(true),tr=rect.getTopRight(true),br=rect.getBottomRight(true),segments;if(!radius||radius.isZero()){segments=[new Segment(bl),new Segment(tl),new Segment(tr),new Segment(br)];}else{radius=Size.min(radius,rect.getSize(true).divide(2));var rx=radius.width,ry=radius.height,hx=rx*kappa,hy=ry*kappa;segments=[new Segment(bl.add(rx,0),null,[-hx,0]),new Segment(bl.subtract(0,ry),[0,hy]),new Segment(tl.add(0,ry),null,[0,-hy]),new Segment(tl.add(rx,0),[-hx,0],null),new Segment(tr.subtract(rx,0),null,[hx,0]),new Segment(tr.add(0,ry),[0,-hy],null),new Segment(br.subtract(0,ry),null,[0,hy]),new Segment(br.subtract(rx,0),[hx,0])];}return createPath(segments,true,arguments);},RoundRectangle:'#Rectangle',Ellipse:function(){var ellipse=Shape._readEllipse(arguments);return createEllipse(ellipse.center,ellipse.radius,arguments);},Oval:'#Ellipse',Arc:function(){var from=Point.readNamed(arguments,'from'),through=Point.readNamed(arguments,'through'),to=Point.readNamed(arguments,'to'),props=Base.getNamed(arguments),path=new Path(props&&props.insert==false&&Item.NO_INSERT);path.moveTo(from);path.arcTo(through,to);return path.set(props);},RegularPolygon:function(){var center=Point.readNamed(arguments,'center'),sides=Base.readNamed(arguments,'sides'),radius=Base.readNamed(arguments,'radius'),step=360/sides,three=sides%3===0,vector=new Point(0,three?-radius:radius),offset=three?-1:0.5,segments=new Array(sides);for(var i=0;i<sides;i++)segments[i]=new Segment(center.add(vector.rotate((i+offset)*step)));return createPath(segments,true,arguments);},Star:function(){var center=Point.readNamed(arguments,'center'),points=Base.readNamed(arguments,'points')*2,radius1=Base.readNamed(arguments,'radius1'),radius2=Base.readNamed(arguments,'radius2'),step=360/points,vector=new Point(0,-1),segments=new Array(points);for(var i=0;i<points;i++)segments[i]=new Segment(center.add(vector.rotate(step*i).multiply(i%2?radius2:radius1)));return createPath(segments,true,arguments);}};}()});var CompoundPath=PathItem.extend({_class:'CompoundPath',_serializeFields:{children:[]},beans:true,initialize:function CompoundPath(arg){this._children=[];this._namedChildren={};if(!this._initialize(arg)){if(typeof arg==='string'){this.setPathData(arg);}else{this.addChildren(Array.isArray(arg)?arg:arguments);}}},insertChildren:function insertChildren(index,items){var list=items,first=list[0];if(first&&typeof first[0]==='number')list=[list];for(var i=items.length-1;i>=0;i--){var item=list[i];if(list===items&&!(item instanceof Path))list=Base.slice(list);if(Array.isArray(item)){list[i]=new Path({segments:item,insert:false});}else if(item instanceof CompoundPath){list.splice.apply(list,[i,1].concat(item.removeChildren()));item.remove();}}return insertChildren.base.call(this,index,list);},reduce:function reduce(options){var children=this._children;for(var i=children.length-1;i>=0;i--){var path=children[i].reduce(options);if(path.isEmpty())path.remove();}if(!children.length){var path=new Path(Item.NO_INSERT);path.copyAttributes(this);path.insertAbove(this);this.remove();return path;}return reduce.base.call(this);},isClosed:function(){var children=this._children;for(var i=0,l=children.length;i<l;i++){if(!children[i]._closed)return false;}return true;},setClosed:function(closed){var children=this._children;for(var i=0,l=children.length;i<l;i++){children[i].setClosed(closed);}},getFirstSegment:function(){var first=this.getFirstChild();return first&&first.getFirstSegment();},getLastSegment:function(){var last=this.getLastChild();return last&&last.getLastSegment();},getCurves:function(){var children=this._children,curves=[];for(var i=0,l=children.length;i<l;i++)curves.push.apply(curves,children[i].getCurves());return curves;},getFirstCurve:function(){var first=this.getFirstChild();return first&&first.getFirstCurve();},getLastCurve:function(){var last=this.getLastChild();return last&&last.getLastCurve();},getArea:function(){var children=this._children,area=0;for(var i=0,l=children.length;i<l;i++)area+=children[i].getArea();return area;},getLength:function(){var children=this._children,length=0;for(var i=0,l=children.length;i<l;i++)length+=children[i].getLength();return length;},getPathData:function(_matrix,_precision){var children=this._children,paths=[];for(var i=0,l=children.length;i<l;i++){var child=children[i],mx=child._matrix;paths.push(child.getPathData(_matrix&&!mx.isIdentity()?_matrix.appended(mx):_matrix,_precision));}return paths.join('');},_hitTestChildren:function _hitTestChildren(point,options,viewMatrix){return _hitTestChildren.base.call(this,point,options.class===Path||options.type==='path'?options:Base.set({},options,{fill:false}),viewMatrix);},_draw:function(ctx,param,viewMatrix,strokeMatrix){var children=this._children;if(!children.length)return;param=param.extend({dontStart:true,dontFinish:true});ctx.beginPath();for(var i=0,l=children.length;i<l;i++)children[i].draw(ctx,param,strokeMatrix);if(!param.clip){this._setStyles(ctx,param,viewMatrix);var style=this._style;if(style.hasFill()){ctx.fill(style.getFillRule());ctx.shadowColor='rgba(0,0,0,0)';}if(style.hasStroke())ctx.stroke();}},_drawSelected:function(ctx,matrix,selectionItems){var children=this._children;for(var i=0,l=children.length;i<l;i++){var child=children[i],mx=child._matrix;if(!selectionItems[child._id]){child._drawSelected(ctx,mx.isIdentity()?matrix:matrix.appended(mx));}}}},new function(){function getCurrentPath(that,check){var children=that._children;if(check&&!children.length)throw new Error('Use a moveTo() command first');return children[children.length-1];}return Base.each(['lineTo','cubicCurveTo','quadraticCurveTo','curveTo','arcTo','lineBy','cubicCurveBy','quadraticCurveBy','curveBy','arcBy'],function(key){this[key]=function(){var path=getCurrentPath(this,true);path[key].apply(path,arguments);};},{moveTo:function(){var current=getCurrentPath(this),path=current&&current.isEmpty()?current:new Path(Item.NO_INSERT);if(path!==current)this.addChild(path);path.moveTo.apply(path,arguments);},moveBy:function(){var current=getCurrentPath(this,true),last=current&&current.getLastSegment(),point=Point.read(arguments);this.moveTo(last?point.add(last._point):point);},closePath:function(tolerance){getCurrentPath(this,true).closePath(tolerance);}});}(),Base.each(['reverse','flatten','simplify','smooth'],function(key){this[key]=function(param){var children=this._children,res;for(var i=0,l=children.length;i<l;i++){res=children[i][key](param)||res;}return res;};},{}));PathItem.inject(new function(){var min=Math.min,max=Math.max,abs=Math.abs,operators={unite:{'1':true,'2':true},intersect:{'2':true},subtract:{'1':true},exclude:{'1':true,'-1':true}};function preparePath(path,resolve){var res=path.clone(false).reduce({simplify:true}).transform(null,true,true);return resolve?res.resolveCrossings().reorient(res.getFillRule()==='nonzero',true):res;}function createResult(paths,simplify,path1,path2,options){var result=new CompoundPath(Item.NO_INSERT);result.addChildren(paths,true);result=result.reduce({simplify:simplify});if(!(options&&options.insert==false)){result.insertAbove(path2&&path1.isSibling(path2)&&path1.getIndex()<path2.getIndex()?path2:path1);}result.copyAttributes(path1,true);return result;}function traceBoolean(path1,path2,operation,options){if(options&&(options.trace==false||options.stroke)&&/^(subtract|intersect)$/.test(operation))return splitBoolean(path1,path2,operation);var _path1=preparePath(path1,true),_path2=path2&&path1!==path2&&preparePath(path2,true),operator=operators[operation];operator[operation]=true;if(_path2&&(operator.subtract||operator.exclude)^(_path2.isClockwise()^_path1.isClockwise()))_path2.reverse();var crossings=divideLocations(CurveLocation.expand(_path1.getCrossings(_path2))),paths1=_path1._children||[_path1],paths2=_path2&&(_path2._children||[_path2]),segments=[],curves=[],paths;function collect(paths){for(var i=0,l=paths.length;i<l;i++){var path=paths[i];segments.push.apply(segments,path._segments);curves.push.apply(curves,path.getCurves());path._overlapsOnly=true;}}if(crossings.length){collect(paths1);if(paths2)collect(paths2);for(var i=0,l=crossings.length;i<l;i++){propagateWinding(crossings[i]._segment,_path1,_path2,curves,operator);}for(var i=0,l=segments.length;i<l;i++){var segment=segments[i],inter=segment._intersection;if(!segment._winding){propagateWinding(segment,_path1,_path2,curves,operator);}if(!(inter&&inter._overlap))segment._path._overlapsOnly=false;}paths=tracePaths(segments,operator);}else{paths=reorientPaths(paths2?paths1.concat(paths2):paths1.slice(),function(w){return!!operator[w];});}return createResult(paths,true,path1,path2,options);}function splitBoolean(path1,path2,operation){var _path1=preparePath(path1),_path2=preparePath(path2),crossings=_path1.getCrossings(_path2),subtract=operation==='subtract',divide=operation==='divide',added={},paths=[];function addPath(path){if(!added[path._id]&&(divide||_path2.contains(path.getPointAt(path.getLength()/2))^subtract)){paths.unshift(path);return added[path._id]=true;}}for(var i=crossings.length-1;i>=0;i--){var path=crossings[i].split();if(path){if(addPath(path))path.getFirstSegment().setHandleIn(0,0);_path1.getLastSegment().setHandleOut(0,0);}}addPath(_path1);return createResult(paths,false,path1,path2);}function linkIntersections(from,to){var prev=from;while(prev){if(prev===to)return;prev=prev._previous;}while(from._next&&from._next!==to)from=from._next;if(!from._next){while(to._previous)to=to._previous;from._next=to;to._previous=from;}}function clearCurveHandles(curves){for(var i=curves.length-1;i>=0;i--)curves[i].clearHandles();}function reorientPaths(paths,isInside,clockwise){var length=paths&&paths.length;if(length){var lookup=Base.each(paths,function(path,i){this[path._id]={container:null,winding:path.isClockwise()?1:-1,index:i};},{}),sorted=paths.slice().sort(function(a,b){return abs(b.getArea())-abs(a.getArea());}),first=sorted[0];if(clockwise==null)clockwise=first.isClockwise();for(var i=0;i<length;i++){var path1=sorted[i],entry1=lookup[path1._id],point=path1.getInteriorPoint(),containerWinding=0;for(var j=i-1;j>=0;j--){var path2=sorted[j];if(path2.contains(point)){var entry2=lookup[path2._id];containerWinding=entry2.winding;entry1.winding+=containerWinding;entry1.container=entry2.exclude?entry2.container:path2;break;}}if(isInside(entry1.winding)===isInside(containerWinding)){entry1.exclude=true;paths[entry1.index]=null;}else{var container=entry1.container;path1.setClockwise(container?!container.isClockwise():clockwise);}}}return paths;}function divideLocations(locations,include,clearLater){var results=include&&[],tMin=1e-8,tMax=1-tMin,clearHandles=false,clearCurves=clearLater||[],clearLookup=clearLater&&{},renormalizeLocs,prevCurve,prevTime;function getId(curve){return curve._path._id+'.'+curve._segment1._index;}for(var i=(clearLater&&clearLater.length)-1;i>=0;i--){var curve=clearLater[i];if(curve._path)clearLookup[getId(curve)]=true;}for(var i=locations.length-1;i>=0;i--){var loc=locations[i],time=loc._time,origTime=time,exclude=include&&!include(loc),curve=loc._curve,segment;if(curve){if(curve!==prevCurve){clearHandles=!curve.hasHandles()||clearLookup&&clearLookup[getId(curve)];renormalizeLocs=[];prevTime=null;prevCurve=curve;}else if(prevTime>=tMin){time/=prevTime;}}if(exclude){if(renormalizeLocs)renormalizeLocs.push(loc);continue;}else if(include){results.unshift(loc);}prevTime=origTime;if(time<tMin){segment=curve._segment1;}else if(time>tMax){segment=curve._segment2;}else{var newCurve=curve.divideAtTime(time,true);if(clearHandles)clearCurves.push(curve,newCurve);segment=newCurve._segment1;for(var j=renormalizeLocs.length-1;j>=0;j--){var l=renormalizeLocs[j];l._time=(l._time-time)/(1-time);}}loc._setSegment(segment);var inter=segment._intersection,dest=loc._intersection;if(inter){linkIntersections(inter,dest);var other=inter;while(other){linkIntersections(other._intersection,inter);other=other._next;}}else{segment._intersection=dest;}}if(!clearLater)clearCurveHandles(clearCurves);return results||locations;}function getWinding(point,curves,dir,closed,dontFlip){var ia=dir?1:0,io=ia^1,pv=[point.x,point.y],pa=pv[ia],po=pv[io],windingEpsilon=1e-9,qualityEpsilon=1e-6,paL=pa-windingEpsilon,paR=pa+windingEpsilon,windingL=0,windingR=0,pathWindingL=0,pathWindingR=0,onPath=false,onAnyPath=false,quality=1,roots=[],vPrev,vClose;function addWinding(v){var o0=v[io+0],o3=v[io+6];if(po<min(o0,o3)||po>max(o0,o3)){return;}var a0=v[ia+0],a1=v[ia+2],a2=v[ia+4],a3=v[ia+6];if(o0===o3){if(a0<paR&&a3>paL||a3<paR&&a0>paL){onPath=true;}return;}var t=po===o0?0:po===o3?1:paL>max(a0,a1,a2,a3)||paR<min(a0,a1,a2,a3)?1:Curve.solveCubic(v,io,po,roots,0,1)>0?roots[0]:1,a=t===0?a0:t===1?a3:Curve.getPoint(v,t)[dir?'y':'x'],winding=o0>o3?1:-1,windingPrev=vPrev[io]>vPrev[io+6]?1:-1,a3Prev=vPrev[ia+6];if(po!==o0){if(a<paL){pathWindingL+=winding;}else if(a>paR){pathWindingR+=winding;}else{onPath=true;}if(a>pa-qualityEpsilon&&a<pa+qualityEpsilon)quality/=2;}else{if(winding!==windingPrev){if(a0<paL){pathWindingL+=winding;}else if(a0>paR){pathWindingR+=winding;}}else if(a0!=a3Prev){if(a3Prev<paR&&a>paR){pathWindingR+=winding;onPath=true;}else if(a3Prev>paL&&a<paL){pathWindingL+=winding;onPath=true;}}quality=0;}vPrev=v;return!dontFlip&&a>paL&&a<paR&&Curve.getTangent(v,t)[dir?'x':'y']===0&&getWinding(point,curves,!dir,closed,true);}function handleCurve(v){var o0=v[io+0],o1=v[io+2],o2=v[io+4],o3=v[io+6];if(po<=max(o0,o1,o2,o3)&&po>=min(o0,o1,o2,o3)){var a0=v[ia+0],a1=v[ia+2],a2=v[ia+4],a3=v[ia+6],monoCurves=paL>max(a0,a1,a2,a3)||paR<min(a0,a1,a2,a3)?[v]:Curve.getMonoCurves(v,dir),res;for(var i=0,l=monoCurves.length;i<l;i++){if(res=addWinding(monoCurves[i]))return res;}}}for(var i=0,l=curves.length;i<l;i++){var curve=curves[i],path=curve._path,v=curve.getValues(),res;if(!i||curves[i-1]._path!==path){vPrev=null;if(!path._closed){vClose=Curve.getValues(path.getLastCurve().getSegment2(),curve.getSegment1(),null,!closed);if(vClose[io]!==vClose[io+6]){vPrev=vClose;}}if(!vPrev){vPrev=v;var prev=path.getLastCurve();while(prev&&prev!==curve){var v2=prev.getValues();if(v2[io]!==v2[io+6]){vPrev=v2;break;}prev=prev.getPrevious();}}}if(res=handleCurve(v))return res;if(i+1===l||curves[i+1]._path!==path){if(vClose&&(res=handleCurve(vClose)))return res;if(onPath&&!pathWindingL&&!pathWindingR){pathWindingL=pathWindingR=path.isClockwise(closed)^dir?1:-1;}windingL+=pathWindingL;windingR+=pathWindingR;pathWindingL=pathWindingR=0;if(onPath){onAnyPath=true;onPath=false;}vClose=null;}}windingL=abs(windingL);windingR=abs(windingR);return{winding:max(windingL,windingR),windingL:windingL,windingR:windingR,quality:quality,onPath:onAnyPath};}function propagateWinding(segment,path1,path2,curves,operator){var chain=[],start=segment,totalLength=0,winding;do{var curve=segment.getCurve(),length=curve.getLength();chain.push({segment:segment,curve:curve,length:length});totalLength+=length;segment=segment.getNext();}while(segment&&!segment._intersection&&segment!==start);var offsets=[0.5,0.25,0.75],winding={winding:0,quality:-1},tMin=1e-8,tMax=1-tMin;for(var i=0;i<offsets.length&&winding.quality<0.5;i++){var length=totalLength*offsets[i];for(var j=0,l=chain.length;j<l;j++){var entry=chain[j],curveLength=entry.length;if(length<=curveLength){var curve=entry.curve,path=curve._path,parent=path._parent,operand=parent instanceof CompoundPath?parent:path,t=Numerical.clamp(curve.getTimeAt(length),tMin,tMax),pt=curve.getPointAtTime(t),dir=abs(curve.getTangentAtTime(t).y)<Math.SQRT1_2;var wind=!(operator.subtract&&path2&&(operand===path1&&path2._getWinding(pt,dir,true).winding||operand===path2&&!path1._getWinding(pt,dir,true).winding))?getWinding(pt,curves,dir,true):{winding:0,quality:1};if(wind.quality>winding.quality)winding=wind;break;}length-=curveLength;}}for(var j=chain.length-1;j>=0;j--){chain[j].segment._winding=winding;}}function tracePaths(segments,operator){var paths=[],starts;function isValid(seg){var winding;return!!(seg&&!seg._visited&&(!operator||operator[(winding=seg._winding||{}).winding]&&!(operator.unite&&winding.winding===2&&winding.windingL&&winding.windingR)));}function isStart(seg){if(seg){for(var i=0,l=starts.length;i<l;i++){if(seg===starts[i])return true;}}return false;}function visitPath(path){var segments=path._segments;for(var i=0,l=segments.length;i<l;i++){segments[i]._visited=true;}}function getCrossingSegments(segment,collectStarts){var inter=segment._intersection,start=inter,crossings=[];if(collectStarts)starts=[segment];function collect(inter,end){while(inter&&inter!==end){var other=inter._segment,path=other&&other._path;if(path){var next=other.getNext()||path.getFirstSegment(),nextInter=next._intersection;if(other!==segment&&(isStart(other)||isStart(next)||next&&isValid(other)&&(isValid(next)||nextInter&&isValid(nextInter._segment)))){crossings.push(other);}if(collectStarts)starts.push(other);}inter=inter._next;}}if(inter){collect(inter);while(inter&&inter._prev)inter=inter._prev;collect(inter,start);}return crossings;}segments.sort(function(seg1,seg2){var inter1=seg1._intersection,inter2=seg2._intersection,over1=!!(inter1&&inter1._overlap),over2=!!(inter2&&inter2._overlap),path1=seg1._path,path2=seg2._path;return over1^over2?over1?1:-1:!inter1^!inter2?inter1?1:-1:path1!==path2?path1._id-path2._id:seg1._index-seg2._index;});for(var i=0,l=segments.length;i<l;i++){var seg=segments[i],valid=isValid(seg),path=null,finished=false,closed=true,branches=[],branch,visited,handleIn;if(valid&&seg._path._overlapsOnly){var path1=seg._path,path2=seg._intersection._segment._path;if(path1.compare(path2)){if(path1.getArea())paths.push(path1.clone(false));visitPath(path1);visitPath(path2);valid=false;}}while(valid){var first=!path,crossings=getCrossingSegments(seg,first),other=crossings.shift(),finished=!first&&(isStart(seg)||isStart(other)),cross=!finished&&other;if(first){path=new Path(Item.NO_INSERT);branch=null;}if(finished){if(seg.isFirst()||seg.isLast())closed=seg._path._closed;seg._visited=true;break;}if(cross&&branch){branches.push(branch);branch=null;}if(!branch){if(cross)crossings.push(seg);branch={start:path._segments.length,crossings:crossings,visited:visited=[],handleIn:handleIn};}if(cross)seg=other;if(!isValid(seg)){path.removeSegments(branch.start);for(var j=0,k=visited.length;j<k;j++){visited[j]._visited=false;}visited.length=0;do{seg=branch&&branch.crossings.shift();if(!seg||!seg._path){seg=null;branch=branches.pop();if(branch){visited=branch.visited;handleIn=branch.handleIn;}}}while(branch&&!isValid(seg));if(!seg)break;}var next=seg.getNext();path.add(new Segment(seg._point,handleIn,next&&seg._handleOut));seg._visited=true;visited.push(seg);seg=next||seg._path.getFirstSegment();handleIn=next&&next._handleIn;}if(finished){if(closed){path.getFirstSegment().setHandleIn(handleIn);path.setClosed(closed);}if(path.getArea()!==0){paths.push(path);}}}return paths;}return{_getWinding:function(point,dir,closed){return getWinding(point,this.getCurves(),dir,closed);},unite:function(path,options){return traceBoolean(this,path,'unite',options);},intersect:function(path,options){return traceBoolean(this,path,'intersect',options);},subtract:function(path,options){return traceBoolean(this,path,'subtract',options);},exclude:function(path,options){return traceBoolean(this,path,'exclude',options);},divide:function(path,options){return options&&(options.trace==false||options.stroke)?splitBoolean(this,path,'divide'):createResult([this.subtract(path,options),this.intersect(path,options)],true,this,path,options);},resolveCrossings:function(){var children=this._children,paths=children||[this];function hasOverlap(seg,path){var inter=seg&&seg._intersection;return inter&&inter._overlap&&inter._path===path;}var hasOverlaps=false,hasCrossings=false,intersections=this.getIntersections(null,function(inter){return inter.hasOverlap()&&(hasOverlaps=true)||inter.isCrossing()&&(hasCrossings=true);}),clearCurves=hasOverlaps&&hasCrossings&&[];intersections=CurveLocation.expand(intersections);if(hasOverlaps){var overlaps=divideLocations(intersections,function(inter){return inter.hasOverlap();},clearCurves);for(var i=overlaps.length-1;i>=0;i--){var overlap=overlaps[i],path=overlap._path,seg=overlap._segment,prev=seg.getPrevious(),next=seg.getNext();if(hasOverlap(prev,path)&&hasOverlap(next,path)){seg.remove();prev._handleOut._set(0,0);next._handleIn._set(0,0);if(prev!==seg&&!prev.getCurve().hasLength()){next._handleIn.set(prev._handleIn);prev.remove();}}}}if(hasCrossings){divideLocations(intersections,hasOverlaps&&function(inter){var curve1=inter.getCurve(),seg1=inter.getSegment(),other=inter._intersection,curve2=other._curve,seg2=other._segment;if(curve1&&curve2&&curve1._path&&curve2._path)return true;if(seg1)seg1._intersection=null;if(seg2)seg2._intersection=null;},clearCurves);if(clearCurves)clearCurveHandles(clearCurves);paths=tracePaths(Base.each(paths,function(path){this.push.apply(this,path._segments);},[]));}var length=paths.length,item;if(length>1&&children){if(paths!==children)this.setChildren(paths);item=this;}else if(length===1&&!children){if(paths[0]!==this)this.setSegments(paths[0].removeSegments());item=this;}if(!item){item=new CompoundPath(Item.NO_INSERT);item.addChildren(paths);item=item.reduce();item.copyAttributes(this);this.replaceWith(item);}return item;},reorient:function(nonZero,clockwise){var children=this._children;if(children&&children.length){this.setChildren(reorientPaths(this.removeChildren(),function(w){return!!(nonZero?w:w&1);},clockwise));}else if(clockwise!==undefined){this.setClockwise(clockwise);}return this;},getInteriorPoint:function(){var bounds=this.getBounds(),point=bounds.getCenter(true);if(!this.contains(point)){var curves=this.getCurves(),y=point.y,intercepts=[],roots=[];for(var i=0,l=curves.length;i<l;i++){var v=curves[i].getValues(),o0=v[1],o1=v[3],o2=v[5],o3=v[7];if(y>=min(o0,o1,o2,o3)&&y<=max(o0,o1,o2,o3)){var monoCurves=Curve.getMonoCurves(v);for(var j=0,m=monoCurves.length;j<m;j++){var mv=monoCurves[j],mo0=mv[1],mo3=mv[7];if(mo0!==mo3&&(y>=mo0&&y<=mo3||y>=mo3&&y<=mo0)){var x=y===mo0?mv[0]:y===mo3?mv[6]:Curve.solveCubic(mv,1,y,roots,0,1)===1?Curve.getPoint(mv,roots[0]).x:(mv[0]+mv[6])/2;intercepts.push(x);}}}}if(intercepts.length>1){intercepts.sort(function(a,b){return a-b;});point.x=(intercepts[0]+intercepts[1])/2;}}return point;}};}());var PathFlattener=Base.extend({_class:'PathFlattener',initialize:function(path,flatness,maxRecursion,ignoreStraight,matrix){var curves=[],parts=[],length=0,minSpan=1/(maxRecursion||32),segments=path._segments,segment1=segments[0],segment2;function addCurve(segment1,segment2){var curve=Curve.getValues(segment1,segment2,matrix);curves.push(curve);computeParts(curve,segment1._index,0,1);}function computeParts(curve,index,t1,t2){if(t2-t1>minSpan&&!(ignoreStraight&&Curve.isStraight(curve))&&!Curve.isFlatEnough(curve,flatness||0.25)){var halves=Curve.subdivide(curve,0.5),tMid=(t1+t2)/2;computeParts(halves[0],index,t1,tMid);computeParts(halves[1],index,tMid,t2);}else{var dx=curve[6]-curve[0],dy=curve[7]-curve[1],dist=Math.sqrt(dx*dx+dy*dy);if(dist>0){length+=dist;parts.push({offset:length,curve:curve,index:index,time:t2});}}}for(var i=1,l=segments.length;i<l;i++){segment2=segments[i];addCurve(segment1,segment2);segment1=segment2;}if(path._closed)addCurve(segment2,segments[0]);this.curves=curves;this.parts=parts;this.length=length;this.index=0;},_get:function(offset){var parts=this.parts,length=parts.length,start,i,j=this.index;for(;;){i=j;if(!j||parts[--j].offset<offset)break;}for(;i<length;i++){var part=parts[i];if(part.offset>=offset){this.index=i;var prev=parts[i-1],prevTime=prev&&prev.index===part.index?prev.time:0,prevOffset=prev?prev.offset:0;return{index:part.index,time:prevTime+(part.time-prevTime)*(offset-prevOffset)/(part.offset-prevOffset)};}}return{index:parts[length-1].index,time:1};},drawPart:function(ctx,from,to){var start=this._get(from),end=this._get(to);for(var i=start.index,l=end.index;i<=l;i++){var curve=Curve.getPart(this.curves[i],i===start.index?start.time:0,i===end.index?end.time:1);if(i===start.index)ctx.moveTo(curve[0],curve[1]);ctx.bezierCurveTo.apply(ctx,curve.slice(2));}}},Base.each(Curve._evaluateMethods,function(name){this[name+'At']=function(offset){var param=this._get(offset);return Curve[name](this.curves[param.index],param.time);};},{}));var PathFitter=Base.extend({initialize:function(path){var points=this.points=[],segments=path._segments,closed=path._closed;for(var i=0,prev,l=segments.length;i<l;i++){var point=segments[i].point;if(!prev||!prev.equals(point)){points.push(prev=point.clone());}}if(closed){points.unshift(points[points.length-1]);points.push(points[1]);}this.closed=closed;},fit:function(error){var points=this.points,length=points.length,segments=null;if(length>0){segments=[new Segment(points[0])];if(length>1){this.fitCubic(segments,error,0,length-1,points[1].subtract(points[0]),points[length-2].subtract(points[length-1]));if(this.closed){segments.shift();segments.pop();}}}return segments;},fitCubic:function(segments,error,first,last,tan1,tan2){var points=this.points;if(last-first===1){var pt1=points[first],pt2=points[last],dist=pt1.getDistance(pt2)/3;this.addCurve(segments,[pt1,pt1.add(tan1.normalize(dist)),pt2.add(tan2.normalize(dist)),pt2]);return;}var uPrime=this.chordLengthParameterize(first,last),maxError=Math.max(error,error*error),split,parametersInOrder=true;for(var i=0;i<=4;i++){var curve=this.generateBezier(first,last,uPrime,tan1,tan2);var max=this.findMaxError(first,last,curve,uPrime);if(max.error<error&&parametersInOrder){this.addCurve(segments,curve);return;}split=max.index;if(max.error>=maxError)break;parametersInOrder=this.reparameterize(first,last,uPrime,curve);maxError=max.error;}var tanCenter=points[split-1].subtract(points[split+1]);this.fitCubic(segments,error,first,split,tan1,tanCenter);this.fitCubic(segments,error,split,last,tanCenter.negate(),tan2);},addCurve:function(segments,curve){var prev=segments[segments.length-1];prev.setHandleOut(curve[1].subtract(curve[0]));segments.push(new Segment(curve[3],curve[2].subtract(curve[3])));},generateBezier:function(first,last,uPrime,tan1,tan2){var epsilon=1e-12,abs=Math.abs,points=this.points,pt1=points[first],pt2=points[last],C=[[0,0],[0,0]],X=[0,0];for(var i=0,l=last-first+1;i<l;i++){var u=uPrime[i],t=1-u,b=3*u*t,b0=t*t*t,b1=b*t,b2=b*u,b3=u*u*u,a1=tan1.normalize(b1),a2=tan2.normalize(b2),tmp=points[first+i].subtract(pt1.multiply(b0+b1)).subtract(pt2.multiply(b2+b3));C[0][0]+=a1.dot(a1);C[0][1]+=a1.dot(a2);C[1][0]=C[0][1];C[1][1]+=a2.dot(a2);X[0]+=a1.dot(tmp);X[1]+=a2.dot(tmp);}var detC0C1=C[0][0]*C[1][1]-C[1][0]*C[0][1],alpha1,alpha2;if(abs(detC0C1)>epsilon){var detC0X=C[0][0]*X[1]-C[1][0]*X[0],detXC1=X[0]*C[1][1]-X[1]*C[0][1];alpha1=detXC1/detC0C1;alpha2=detC0X/detC0C1;}else{var c0=C[0][0]+C[0][1],c1=C[1][0]+C[1][1];alpha1=alpha2=abs(c0)>epsilon?X[0]/c0:abs(c1)>epsilon?X[1]/c1:0;}var segLength=pt2.getDistance(pt1),eps=epsilon*segLength,handle1,handle2;if(alpha1<eps||alpha2<eps){alpha1=alpha2=segLength/3;}else{var line=pt2.subtract(pt1);handle1=tan1.normalize(alpha1);handle2=tan2.normalize(alpha2);if(handle1.dot(line)-handle2.dot(line)>segLength*segLength){alpha1=alpha2=segLength/3;handle1=handle2=null;}}return[pt1,pt1.add(handle1||tan1.normalize(alpha1)),pt2.add(handle2||tan2.normalize(alpha2)),pt2];},reparameterize:function(first,last,u,curve){for(var i=first;i<=last;i++){u[i-first]=this.findRoot(curve,this.points[i],u[i-first]);}for(var i=1,l=u.length;i<l;i++){if(u[i]<=u[i-1])return false;}return true;},findRoot:function(curve,point,u){var curve1=[],curve2=[];for(var i=0;i<=2;i++){curve1[i]=curve[i+1].subtract(curve[i]).multiply(3);}for(var i=0;i<=1;i++){curve2[i]=curve1[i+1].subtract(curve1[i]).multiply(2);}var pt=this.evaluate(3,curve,u),pt1=this.evaluate(2,curve1,u),pt2=this.evaluate(1,curve2,u),diff=pt.subtract(point),df=pt1.dot(pt1)+diff.dot(pt2);return Numerical.isZero(df)?u:u-diff.dot(pt1)/df;},evaluate:function(degree,curve,t){var tmp=curve.slice();for(var i=1;i<=degree;i++){for(var j=0;j<=degree-i;j++){tmp[j]=tmp[j].multiply(1-t).add(tmp[j+1].multiply(t));}}return tmp[0];},chordLengthParameterize:function(first,last){var u=[0];for(var i=first+1;i<=last;i++){u[i-first]=u[i-first-1]+this.points[i].getDistance(this.points[i-1]);}for(var i=1,m=last-first;i<=m;i++){u[i]/=u[m];}return u;},findMaxError:function(first,last,curve,u){var index=Math.floor((last-first+1)/2),maxDist=0;for(var i=first+1;i<last;i++){var P=this.evaluate(3,curve,u[i-first]);var v=P.subtract(this.points[i]);var dist=v.x*v.x+v.y*v.y;if(dist>=maxDist){maxDist=dist;index=i;}}return{error:maxDist,index:index};}});var TextItem=Item.extend({_class:'TextItem',_applyMatrix:false,_canApplyMatrix:false,_serializeFields:{content:null},_boundsOptions:{stroke:false,handle:false},initialize:function TextItem(arg){this._content='';this._lines=[];var hasProps=arg&&Base.isPlainObject(arg)&&arg.x===undefined&&arg.y===undefined;this._initialize(hasProps&&arg,!hasProps&&Point.read(arguments));},_equals:function(item){return this._content===item._content;},copyContent:function(source){this.setContent(source._content);},getContent:function(){return this._content;},setContent:function(content){this._content=''+content;this._lines=this._content.split(/\r\n|\n|\r/mg);this._changed(265);},isEmpty:function(){return!this._content;},getCharacterStyle:'#getStyle',setCharacterStyle:'#setStyle',getParagraphStyle:'#getStyle',setParagraphStyle:'#setStyle'});var PointText=TextItem.extend({_class:'PointText',initialize:function PointText(){TextItem.apply(this,arguments);},getPoint:function(){var point=this._matrix.getTranslation();return new LinkedPoint(point.x,point.y,this,'setPoint');},setPoint:function(){var point=Point.read(arguments);this.translate(point.subtract(this._matrix.getTranslation()));},_draw:function(ctx,param,viewMatrix){if(!this._content)return;this._setStyles(ctx,param,viewMatrix);var lines=this._lines,style=this._style,hasFill=style.hasFill(),hasStroke=style.hasStroke(),leading=style.getLeading(),shadowColor=ctx.shadowColor;ctx.font=style.getFontStyle();ctx.textAlign=style.getJustification();for(var i=0,l=lines.length;i<l;i++){ctx.shadowColor=shadowColor;var line=lines[i];if(hasFill){ctx.fillText(line,0,0);ctx.shadowColor='rgba(0,0,0,0)';}if(hasStroke)ctx.strokeText(line,0,0);ctx.translate(0,leading);}},_getBounds:function(matrix,options){var style=this._style,lines=this._lines,numLines=lines.length,justification=style.getJustification(),leading=style.getLeading(),width=this.getView().getTextWidth(style.getFontStyle(),lines),x=0;if(justification!=='left')x-=width/(justification==='center'?2:1);var rect=new Rectangle(x,numLines?-0.75*leading:0,width,numLines*leading);return matrix?matrix._transformBounds(rect,rect):rect;}});var Color=Base.extend(new function(){var types={gray:['gray'],rgb:['red','green','blue'],hsb:['hue','saturation','brightness'],hsl:['hue','saturation','lightness'],gradient:['gradient','origin','destination','highlight']};var componentParsers={},colorCache={},colorCtx;function fromCSS(string){var match=string.match(/^#(\w{1,2})(\w{1,2})(\w{1,2})$/),components;if(match){components=[0,0,0];for(var i=0;i<3;i++){var value=match[i+1];components[i]=parseInt(value.length==1?value+value:value,16)/255;}}else if(match=string.match(/^rgba?\((.*)\)$/)){components=match[1].split(',');for(var i=0,l=components.length;i<l;i++){var value=+components[i];components[i]=i<3?value/255:value;}}else if(window){var cached=colorCache[string];if(!cached){if(!colorCtx){colorCtx=CanvasProvider.getContext(1,1);colorCtx.globalCompositeOperation='copy';}colorCtx.fillStyle='rgba(0,0,0,0)';colorCtx.fillStyle=string;colorCtx.fillRect(0,0,1,1);var data=colorCtx.getImageData(0,0,1,1).data;cached=colorCache[string]=[data[0]/255,data[1]/255,data[2]/255];}components=cached.slice();}else{components=[0,0,0];}return components;}var hsbIndices=[[0,3,1],[2,0,1],[1,0,3],[1,2,0],[3,1,0],[0,1,2]];var converters={'rgb-hsb':function(r,g,b){var max=Math.max(r,g,b),min=Math.min(r,g,b),delta=max-min,h=delta===0?0:(max==r?(g-b)/delta+(g<b?6:0):max==g?(b-r)/delta+2:(r-g)/delta+4)*60;return[h,max===0?0:delta/max,max];},'hsb-rgb':function(h,s,b){h=(h/60%6+6)%6;var i=Math.floor(h),f=h-i,i=hsbIndices[i],v=[b,b*(1-s),b*(1-s*f),b*(1-s*(1-f))];return[v[i[0]],v[i[1]],v[i[2]]];},'rgb-hsl':function(r,g,b){var max=Math.max(r,g,b),min=Math.min(r,g,b),delta=max-min,achromatic=delta===0,h=achromatic?0:(max==r?(g-b)/delta+(g<b?6:0):max==g?(b-r)/delta+2:(r-g)/delta+4)*60,l=(max+min)/2,s=achromatic?0:l<0.5?delta/(max+min):delta/(2-max-min);return[h,s,l];},'hsl-rgb':function(h,s,l){h=(h/360%1+1)%1;if(s===0)return[l,l,l];var t3s=[h+1/3,h,h-1/3],t2=l<0.5?l*(1+s):l+s-l*s,t1=2*l-t2,c=[];for(var i=0;i<3;i++){var t3=t3s[i];if(t3<0)t3+=1;if(t3>1)t3-=1;c[i]=6*t3<1?t1+(t2-t1)*6*t3:2*t3<1?t2:3*t3<2?t1+(t2-t1)*(2/3-t3)*6:t1;}return c;},'rgb-gray':function(r,g,b){return[r*0.2989+g*0.587+b*0.114];},'gray-rgb':function(g){return[g,g,g];},'gray-hsb':function(g){return[0,0,g];},'gray-hsl':function(g){return[0,0,g];},'gradient-rgb':function(){return[];},'rgb-gradient':function(){return[];}};return Base.each(types,function(properties,type){componentParsers[type]=[];Base.each(properties,function(name,index){var part=Base.capitalize(name),hasOverlap=/^(hue|saturation)$/.test(name),parser=componentParsers[type][index]=name==='gradient'?function(value){var current=this._components[0];value=Gradient.read(Array.isArray(value)?value:arguments,0,{readNull:true});if(current!==value){if(current)current._removeOwner(this);if(value)value._addOwner(this);}return value;}:type==='gradient'?function(){return Point.read(arguments,0,{readNull:name==='highlight',clone:true});}:function(value){return value==null||isNaN(value)?0:value;};this['get'+part]=function(){return this._type===type||hasOverlap&&/^hs[bl]$/.test(this._type)?this._components[index]:this._convert(type)[index];};this['set'+part]=function(value){if(this._type!==type&&!(hasOverlap&&/^hs[bl]$/.test(this._type))){this._components=this._convert(type);this._properties=types[type];this._type=type;}this._components[index]=parser.call(this,value);this._changed();};},this);},{_class:'Color',_readIndex:true,initialize:function Color(arg){var args=arguments,reading=this.__read,read=0,type,components,alpha,values;if(Array.isArray(arg)){args=arg;arg=args[0];}var argType=arg!=null&&typeof arg;if(argType==='string'&&arg in types){type=arg;arg=args[1];if(Array.isArray(arg)){components=arg;alpha=args[2];}else{if(reading)read=1;args=Base.slice(args,1);argType=typeof arg;}}if(!components){values=argType==='number'?args:argType==='object'&&arg.length!=null?arg:null;if(values){if(!type)type=values.length>=3?'rgb':'gray';var length=types[type].length;alpha=values[length];if(reading){read+=values===arguments?length+(alpha!=null?1:0):1;}if(values.length>length)values=Base.slice(values,0,length);}else if(argType==='string'){type='rgb';components=fromCSS(arg);if(components.length===4){alpha=components[3];components.length--;}}else if(argType==='object'){if(arg.constructor===Color){type=arg._type;components=arg._components.slice();alpha=arg._alpha;if(type==='gradient'){for(var i=1,l=components.length;i<l;i++){var point=components[i];if(point)components[i]=point.clone();}}}else if(arg.constructor===Gradient){type='gradient';values=args;}else{type='hue'in arg?'lightness'in arg?'hsl':'hsb':'gradient'in arg||'stops'in arg||'radial'in arg?'gradient':'gray'in arg?'gray':'rgb';var properties=types[type],parsers=componentParsers[type];this._components=components=[];for(var i=0,l=properties.length;i<l;i++){var value=arg[properties[i]];if(value==null&&!i&&type==='gradient'&&'stops'in arg){value={stops:arg.stops,radial:arg.radial};}value=parsers[i].call(this,value);if(value!=null)components[i]=value;}alpha=arg.alpha;}}if(reading&&type)read=1;}this._type=type||'rgb';if(!components){this._components=components=[];var parsers=componentParsers[this._type];for(var i=0,l=parsers.length;i<l;i++){var value=parsers[i].call(this,values&&values[i]);if(value!=null)components[i]=value;}}this._components=components;this._properties=types[this._type];this._alpha=alpha;if(reading)this.__read=read;return this;},set:'#initialize',_serialize:function(options,dictionary){var components=this.getComponents();return Base.serialize(/^(gray|rgb)$/.test(this._type)?components:[this._type].concat(components),options,true,dictionary);},_changed:function(){this._canvasStyle=null;if(this._owner)this._owner._changed(65);},_convert:function(type){var converter;return this._type===type?this._components.slice():(converter=converters[this._type+'-'+type])?converter.apply(this,this._components):converters['rgb-'+type].apply(this,converters[this._type+'-rgb'].apply(this,this._components));},convert:function(type){return new Color(type,this._convert(type),this._alpha);},getType:function(){return this._type;},setType:function(type){this._components=this._convert(type);this._properties=types[type];this._type=type;},getComponents:function(){var components=this._components.slice();if(this._alpha!=null)components.push(this._alpha);return components;},getAlpha:function(){return this._alpha!=null?this._alpha:1;},setAlpha:function(alpha){this._alpha=alpha==null?null:Math.min(Math.max(alpha,0),1);this._changed();},hasAlpha:function(){return this._alpha!=null;},equals:function(color){var col=Base.isPlainValue(color,true)?Color.read(arguments):color;return col===this||col&&this._class===col._class&&this._type===col._type&&this.getAlpha()===col.getAlpha()&&Base.equals(this._components,col._components)||false;},toString:function(){var properties=this._properties,parts=[],isGradient=this._type==='gradient',f=Formatter.instance;for(var i=0,l=properties.length;i<l;i++){var value=this._components[i];if(value!=null)parts.push(properties[i]+': '+(isGradient?value:f.number(value)));}if(this._alpha!=null)parts.push('alpha: '+f.number(this._alpha));return'{ '+parts.join(', ')+' }';},toCSS:function(hex){var components=this._convert('rgb'),alpha=hex||this._alpha==null?1:this._alpha;function convert(val){return Math.round((val<0?0:val>1?1:val)*255);}components=[convert(components[0]),convert(components[1]),convert(components[2])];if(alpha<1)components.push(alpha<0?0:alpha);return hex?'#'+((1<<24)+(components[0]<<16)+(components[1]<<8)+components[2]).toString(16).slice(1):(components.length==4?'rgba(':'rgb(')+components.join(',')+')';},toCanvasStyle:function(ctx,matrix){if(this._canvasStyle)return this._canvasStyle;if(this._type!=='gradient')return this._canvasStyle=this.toCSS();var components=this._components,gradient=components[0],stops=gradient._stops,origin=components[1],destination=components[2],highlight=components[3],inverse=matrix&&matrix.inverted(),canvasGradient;if(inverse){origin=inverse._transformPoint(origin);destination=inverse._transformPoint(destination);if(highlight)highlight=inverse._transformPoint(highlight);}if(gradient._radial){var radius=destination.getDistance(origin);if(highlight){var vector=highlight.subtract(origin);if(vector.getLength()>radius)highlight=origin.add(vector.normalize(radius-0.1));}var start=highlight||origin;canvasGradient=ctx.createRadialGradient(start.x,start.y,0,origin.x,origin.y,radius);}else{canvasGradient=ctx.createLinearGradient(origin.x,origin.y,destination.x,destination.y);}for(var i=0,l=stops.length;i<l;i++){var stop=stops[i],offset=stop._offset;canvasGradient.addColorStop(offset==null?i/(l-1):offset,stop._color.toCanvasStyle());}return this._canvasStyle=canvasGradient;},transform:function(matrix){if(this._type==='gradient'){var components=this._components;for(var i=1,l=components.length;i<l;i++){var point=components[i];matrix._transformPoint(point,point,true);}this._changed();}},statics:{_types:types,random:function(){var random=Math.random;return new Color(random(),random(),random());}}});}(),new function(){var operators={add:function(a,b){return a+b;},subtract:function(a,b){return a-b;},multiply:function(a,b){return a*b;},divide:function(a,b){return a/b;}};return Base.each(operators,function(operator,name){this[name]=function(color){color=Color.read(arguments);var type=this._type,components1=this._components,components2=color._convert(type);for(var i=0,l=components1.length;i<l;i++)components2[i]=operator(components1[i],components2[i]);return new Color(type,components2,this._alpha!=null?operator(this._alpha,color.getAlpha()):null);};},{});}());var Gradient=Base.extend({_class:'Gradient',initialize:function Gradient(stops,radial){this._id=UID.get();if(stops&&Base.isPlainObject(stops)){this.set(stops);stops=radial=null;}if(this._stops==null){this.setStops(stops||['white','black']);}if(this._radial==null){this.setRadial(typeof radial==='string'&&radial==='radial'||radial||false);}},_serialize:function(options,dictionary){return dictionary.add(this,function(){return Base.serialize([this._stops,this._radial],options,true,dictionary);});},_changed:function(){for(var i=0,l=this._owners&&this._owners.length;i<l;i++){this._owners[i]._changed();}},_addOwner:function(color){if(!this._owners)this._owners=[];this._owners.push(color);},_removeOwner:function(color){var index=this._owners?this._owners.indexOf(color):-1;if(index!=-1){this._owners.splice(index,1);if(!this._owners.length)this._owners=undefined;}},clone:function(){var stops=[];for(var i=0,l=this._stops.length;i<l;i++){stops[i]=this._stops[i].clone();}return new Gradient(stops,this._radial);},getStops:function(){return this._stops;},setStops:function(stops){if(stops.length<2){throw new Error('Gradient stop list needs to contain at least two stops.');}var _stops=this._stops;if(_stops){for(var i=0,l=_stops.length;i<l;i++)_stops[i]._owner=undefined;}_stops=this._stops=GradientStop.readList(stops,0,{clone:true});for(var i=0,l=_stops.length;i<l;i++)_stops[i]._owner=this;this._changed();},getRadial:function(){return this._radial;},setRadial:function(radial){this._radial=radial;this._changed();},equals:function(gradient){if(gradient===this)return true;if(gradient&&this._class===gradient._class){var stops1=this._stops,stops2=gradient._stops,length=stops1.length;if(length===stops2.length){for(var i=0;i<length;i++){if(!stops1[i].equals(stops2[i]))return false;}return true;}}return false;}});var GradientStop=Base.extend({_class:'GradientStop',initialize:function GradientStop(arg0,arg1){var color=arg0,offset=arg1;if(typeof arg0==='object'&&arg1===undefined){if(Array.isArray(arg0)&&typeof arg0[0]!=='number'){color=arg0[0];offset=arg0[1];}else if('color'in arg0||'offset'in arg0||'rampPoint'in arg0){color=arg0.color;offset=arg0.offset||arg0.rampPoint||0;}}this.setColor(color);this.setOffset(offset);},clone:function(){return new GradientStop(this._color.clone(),this._offset);},_serialize:function(options,dictionary){var color=this._color,offset=this._offset;return Base.serialize(offset==null?[color]:[color,offset],options,true,dictionary);},_changed:function(){if(this._owner)this._owner._changed(65);},getOffset:function(){return this._offset;},setOffset:function(offset){this._offset=offset;this._changed();},getRampPoint:'#getOffset',setRampPoint:'#setOffset',getColor:function(){return this._color;},setColor:function(){var color=Color.read(arguments,0,{clone:true});if(color)color._owner=this;this._color=color;this._changed();},equals:function(stop){return stop===this||stop&&this._class===stop._class&&this._color.equals(stop._color)&&this._offset==stop._offset||false;}});var Style=Base.extend(new function(){var itemDefaults={fillColor:null,fillRule:'nonzero',strokeColor:null,strokeWidth:1,strokeCap:'butt',strokeJoin:'miter',strokeScaling:true,miterLimit:10,dashOffset:0,dashArray:[],shadowColor:null,shadowBlur:0,shadowOffset:new Point(),selectedColor:null},groupDefaults=Base.set({},itemDefaults,{fontFamily:'sans-serif',fontWeight:'normal',fontStretch:'normal',fontSize:12,leading:null,justification:'left'}),textDefaults=Base.set({},groupDefaults,{fillColor:new Color()}),flags={strokeWidth:97,strokeCap:97,strokeJoin:97,strokeScaling:105,miterLimit:97,fontFamily:9,fontWeight:9,fontSize:9,fontStretch:9,font:9,leading:9,justification:9},item={beans:true},fields={_class:'Style',beans:true,initialize:function Style(style,_owner,_project){this._values={};this._owner=_owner;this._project=_owner&&_owner._project||_project||paper.project;this._defaults=!_owner||_owner instanceof Group?groupDefaults:_owner instanceof TextItem?textDefaults:itemDefaults;if(style)this.set(style);}};Base.each(groupDefaults,function(value,key){var isColor=/Color$/.test(key),isPoint=key==='shadowOffset',part=Base.capitalize(key),flag=flags[key],set='set'+part,get='get'+part;fields[set]=function(value){var owner=this._owner,children=owner&&owner._children;if(children&&children.length>0&&!(owner instanceof CompoundPath)){for(var i=0,l=children.length;i<l;i++)children[i]._style[set](value);}else if(key in this._defaults){var old=this._values[key];if(old!==value){if(isColor){if(old&&old._owner!==undefined)old._owner=undefined;if(value&&value.constructor===Color){if(value._owner)value=value.clone();value._owner=owner;}}this._values[key]=value;if(owner)owner._changed(flag||65);}}};fields[get]=function(_dontMerge){var owner=this._owner,children=owner&&owner._children,value;if(key in this._defaults&&(!children||!children.length||_dontMerge||owner instanceof CompoundPath)){var value=this._values[key];if(value===undefined){value=this._defaults[key];if(value&&value.clone)value=value.clone();}else{var ctor=isColor?Color:isPoint?Point:null;if(ctor&&!(value&&value.constructor===ctor)){this._values[key]=value=ctor.read([value],0,{readNull:true,clone:true});if(value&&isColor)value._owner=owner;}}}else if(children){for(var i=0,l=children.length;i<l;i++){var childValue=children[i]._style[get]();if(!i){value=childValue;}else if(!Base.equals(value,childValue)){return undefined;}}}return value;};item[get]=function(_dontMerge){return this._style[get](_dontMerge);};item[set]=function(value){this._style[set](value);};});Base.each({Font:'FontFamily',WindingRule:'FillRule'},function(value,key){var get='get'+key,set='set'+key;fields[get]=item[get]='#get'+value;fields[set]=item[set]='#set'+value;});Item.inject(item);return fields;}(),{set:function(style){var isStyle=style instanceof Style,values=isStyle?style._values:style;if(values){for(var key in values){if(key in this._defaults){var value=values[key];this[key]=value&&isStyle&&value.clone?value.clone():value;}}}},equals:function(style){function compare(style1,style2,secondary){var values1=style1._values,values2=style2._values,defaults2=style2._defaults;for(var key in values1){var value1=values1[key],value2=values2[key];if(!(secondary&&key in values2)&&!Base.equals(value1,value2===undefined?defaults2[key]:value2))return false;}return true;}return style===this||style&&this._class===style._class&&compare(this,style)&&compare(style,this,true)||false;},hasFill:function(){var color=this.getFillColor();return!!color&&color.alpha>0;},hasStroke:function(){var color=this.getStrokeColor();return!!color&&color.alpha>0&&this.getStrokeWidth()>0;},hasShadow:function(){var color=this.getShadowColor();return!!color&&color.alpha>0&&(this.getShadowBlur()>0||!this.getShadowOffset().isZero());},getView:function(){return this._project._view;},getFontStyle:function(){var fontSize=this.getFontSize();var fontStretch=this.getFontStretch();return this.getFontWeight()+' '+fontStretch+' '+fontSize+(/[a-z]/i.test(fontSize+'')?' ':'px ')+this.getFontFamily();},getFont:'#getFontFamily',setFont:'#setFontFamily',getLeading:function getLeading(){var leading=getLeading.base.call(this),fontSize=this.getFontSize();if(/pt|em|%|px/.test(fontSize))fontSize=this.getView().getPixelSize(fontSize);return leading!=null?leading:fontSize*1.2;}});var DomElement=new function(){function handlePrefix(el,name,set,value){var prefixes=['','webkit','moz','Moz','ms','o'],suffix=name[0].toUpperCase()+name.substring(1);for(var i=0;i<6;i++){var prefix=prefixes[i],key=prefix?prefix+suffix:name;if(key in el){if(set){el[key]=value;}else{return el[key];}break;}}}return{getStyles:function(el){var doc=el&&el.nodeType!==9?el.ownerDocument:el,view=doc&&doc.defaultView;return view&&view.getComputedStyle(el,'');},getBounds:function(el,viewport){var doc=el.ownerDocument,body=doc.body,html=doc.documentElement,rect;try{rect=el.getBoundingClientRect();}catch(e){rect={left:0,top:0,width:0,height:0};}var x=rect.left-(html.clientLeft||body.clientLeft||0),y=rect.top-(html.clientTop||body.clientTop||0);if(!viewport){var view=doc.defaultView;x+=view.pageXOffset||html.scrollLeft||body.scrollLeft;y+=view.pageYOffset||html.scrollTop||body.scrollTop;}return new Rectangle(x,y,rect.width,rect.height);},getViewportBounds:function(el){var doc=el.ownerDocument,view=doc.defaultView,html=doc.documentElement;return new Rectangle(0,0,view.innerWidth||html.clientWidth,view.innerHeight||html.clientHeight);},getOffset:function(el,viewport){return DomElement.getBounds(el,viewport).getPoint();},getSize:function(el){return DomElement.getBounds(el,true).getSize();},isInvisible:function(el){return DomElement.getSize(el).equals(new Size(0,0));},isInView:function(el){return!DomElement.isInvisible(el)&&DomElement.getViewportBounds(el).intersects(DomElement.getBounds(el,true));},isInserted:function(el){return document.body.contains(el);},getPrefixed:function(el,name){return el&&handlePrefix(el,name);},setPrefixed:function(el,name,value){if(typeof name==='object'){for(var key in name)handlePrefix(el,key,true,name[key]);}else{handlePrefix(el,name,true,value);}}};}();var DomEvent={add:function(el,events){if(el){for(var type in events){var func=events[type],parts=type.split(/[\s,]+/g);for(var i=0,l=parts.length;i<l;i++)el.addEventListener(parts[i],func,false);}}},remove:function(el,events){if(el){for(var type in events){var func=events[type],parts=type.split(/[\s,]+/g);for(var i=0,l=parts.length;i<l;i++)el.removeEventListener(parts[i],func,false);}}},getPoint:function(event){var pos=event.targetTouches?event.targetTouches.length?event.targetTouches[0]:event.changedTouches[0]:event;return new Point(pos.pageX||pos.clientX+document.documentElement.scrollLeft,pos.pageY||pos.clientY+document.documentElement.scrollTop);},getTarget:function(event){return event.target||event.srcElement;},getRelatedTarget:function(event){return event.relatedTarget||event.toElement;},getOffset:function(event,target){return DomEvent.getPoint(event).subtract(DomElement.getOffset(target||DomEvent.getTarget(event)));}};DomEvent.requestAnimationFrame=new function(){var nativeRequest=DomElement.getPrefixed(window,'requestAnimationFrame'),requested=false,callbacks=[],timer;function handleCallbacks(){var functions=callbacks;callbacks=[];for(var i=0,l=functions.length;i<l;i++)functions[i]();requested=nativeRequest&&callbacks.length;if(requested)nativeRequest(handleCallbacks);}return function(callback){callbacks.push(callback);if(nativeRequest){if(!requested){nativeRequest(handleCallbacks);requested=true;}}else if(!timer){timer=setInterval(handleCallbacks,1000/60);}};}();var View=Base.extend(Emitter,{_class:'View',initialize:function View(project,element){function getSize(name){return element[name]||parseInt(element.getAttribute(name),10);}function getCanvasSize(){var size=DomElement.getSize(element);return size.isNaN()||size.isZero()?new Size(getSize('width'),getSize('height')):size;}var size;if(window&&element){this._id=element.getAttribute('id');if(this._id==null)element.setAttribute('id',this._id='view-'+View._id++);DomEvent.add(element,this._viewEvents);var none='none';DomElement.setPrefixed(element.style,{userDrag:none,userSelect:none,touchCallout:none,contentZooming:none,tapHighlightColor:'rgba(0,0,0,0)'});if(PaperScope.hasAttribute(element,'resize')){var that=this;DomEvent.add(window,this._windowEvents={resize:function(){that.setViewSize(getCanvasSize());}});}size=getCanvasSize();if(PaperScope.hasAttribute(element,'stats')&&typeof Stats!=='undefined'){this._stats=new Stats();var stats=this._stats.domElement,style=stats.style,offset=DomElement.getOffset(element);style.position='absolute';style.left=offset.x+'px';style.top=offset.y+'px';document.body.appendChild(stats);}}else{size=new Size(element);element=null;}this._project=project;this._scope=project._scope;this._element=element;if(!this._pixelRatio)this._pixelRatio=window&&window.devicePixelRatio||1;this._setElementSize(size.width,size.height);this._viewSize=size;View._views.push(this);View._viewsById[this._id]=this;(this._matrix=new Matrix())._owner=this;if(!View._focused)View._focused=this;this._frameItems={};this._frameItemCount=0;this._itemEvents={native:{},virtual:{}};this._autoUpdate=!paper.agent.node;this._needsUpdate=false;},remove:function(){if(!this._project)return false;if(View._focused===this)View._focused=null;View._views.splice(View._views.indexOf(this),1);delete View._viewsById[this._id];var project=this._project;if(project._view===this)project._view=null;DomEvent.remove(this._element,this._viewEvents);DomEvent.remove(window,this._windowEvents);this._element=this._project=null;this.off('frame');this._animate=false;this._frameItems={};return true;},_events:Base.each(Item._itemHandlers.concat(['onResize','onKeyDown','onKeyUp']),function(name){this[name]={};},{onFrame:{install:function(){this.play();},uninstall:function(){this.pause();}}}),_animate:false,_time:0,_count:0,getAutoUpdate:function(){return this._autoUpdate;},setAutoUpdate:function(autoUpdate){this._autoUpdate=autoUpdate;if(autoUpdate)this.requestUpdate();},update:function(){},draw:function(){this.update();},requestUpdate:function(){if(!this._requested){var that=this;DomEvent.requestAnimationFrame(function(){that._requested=false;if(that._animate){that.requestUpdate();var element=that._element;if((!DomElement.getPrefixed(document,'hidden')||PaperScope.getAttribute(element,'keepalive')==='true')&&DomElement.isInView(element)){that._handleFrame();}}if(that._autoUpdate)that.update();});this._requested=true;}},play:function(){this._animate=true;this.requestUpdate();},pause:function(){this._animate=false;},_handleFrame:function(){paper=this._scope;var now=Date.now()/1000,delta=this._last?now-this._last:0;this._last=now;this.emit('frame',new Base({delta:delta,time:this._time+=delta,count:this._count++}));if(this._stats)this._stats.update();},_animateItem:function(item,animate){var items=this._frameItems;if(animate){items[item._id]={item:item,time:0,count:0};if(++this._frameItemCount===1)this.on('frame',this._handleFrameItems);}else{delete items[item._id];if(--this._frameItemCount===0){this.off('frame',this._handleFrameItems);}}},_handleFrameItems:function(event){for(var i in this._frameItems){var entry=this._frameItems[i];entry.item.emit('frame',new Base(event,{time:entry.time+=event.delta,count:entry.count++}));}},_changed:function(){this._project._changed(2049);this._bounds=this._decomposed=undefined;},getElement:function(){return this._element;},getPixelRatio:function(){return this._pixelRatio;},getResolution:function(){return this._pixelRatio*72;},getViewSize:function(){var size=this._viewSize;return new LinkedSize(size.width,size.height,this,'setViewSize');},setViewSize:function(){var size=Size.read(arguments),delta=size.subtract(this._viewSize);if(delta.isZero())return;this._setElementSize(size.width,size.height);this._viewSize.set(size);this._changed();this.emit('resize',{size:size,delta:delta});if(this._autoUpdate){this.update();}},_setElementSize:function(width,height){var element=this._element;if(element){if(element.width!==width)element.width=width;if(element.height!==height)element.height=height;}},getBounds:function(){if(!this._bounds)this._bounds=this._matrix.inverted()._transformBounds(new Rectangle(new Point(),this._viewSize));return this._bounds;},getSize:function(){return this.getBounds().getSize();},isVisible:function(){return DomElement.isInView(this._element);},isInserted:function(){return DomElement.isInserted(this._element);},getPixelSize:function(size){var element=this._element,pixels;if(element){var parent=element.parentNode,temp=document.createElement('div');temp.style.fontSize=size;parent.appendChild(temp);pixels=parseFloat(DomElement.getStyles(temp).fontSize);parent.removeChild(temp);}else{pixels=parseFloat(pixels);}return pixels;},getTextWidth:function(font,lines){return 0;}},Base.each(['rotate','scale','shear','skew'],function(key){var rotate=key==='rotate';this[key]=function(){var value=(rotate?Base:Point).read(arguments),center=Point.read(arguments,0,{readNull:true});return this.transform(new Matrix()[key](value,center||this.getCenter(true)));};},{_decompose:function(){return this._decomposed||(this._decomposed=this._matrix.decompose());},translate:function(){var mx=new Matrix();return this.transform(mx.translate.apply(mx,arguments));},getCenter:function(){return this.getBounds().getCenter();},setCenter:function(){var center=Point.read(arguments);this.translate(this.getCenter().subtract(center));},getZoom:function(){var decomposed=this._decompose(),scaling=decomposed&&decomposed.scaling;return scaling?(scaling.x+scaling.y)/2:0;},setZoom:function(zoom){this.transform(new Matrix().scale(zoom/this.getZoom(),this.getCenter()));},getRotation:function(){var decomposed=this._decompose();return decomposed&&decomposed.rotation;},setRotation:function(rotation){var current=this.getRotation();if(current!=null&&rotation!=null){this.rotate(rotation-current);}},getScaling:function(){var decomposed=this._decompose(),scaling=decomposed&&decomposed.scaling;return scaling?new LinkedPoint(scaling.x,scaling.y,this,'setScaling'):undefined;},setScaling:function(){var current=this.getScaling(),scaling=Point.read(arguments,0,{clone:true,readNull:true});if(current&&scaling){this.scale(scaling.x/current.x,scaling.y/current.y);}},getMatrix:function(){return this._matrix;},setMatrix:function(){var matrix=this._matrix;matrix.initialize.apply(matrix,arguments);},transform:function(matrix){this._matrix.append(matrix);},scrollBy:function(){this.translate(Point.read(arguments).negate());}}),{projectToView:function(){return this._matrix._transformPoint(Point.read(arguments));},viewToProject:function(){return this._matrix._inverseTransform(Point.read(arguments));},getEventPoint:function(event){return this.viewToProject(DomEvent.getOffset(event,this._element));}},{statics:{_views:[],_viewsById:{},_id:0,create:function(project,element){if(document&&typeof element==='string')element=document.getElementById(element);var ctor=window?CanvasView:View;return new ctor(project,element);}}},new function(){if(!window)return;var prevFocus,tempFocus,dragging=false,mouseDown=false;function getView(event){var target=DomEvent.getTarget(event);return target.getAttribute&&View._viewsById[target.getAttribute('id')];}function updateFocus(){var view=View._focused;if(!view||!view.isVisible()){for(var i=0,l=View._views.length;i<l;i++){if((view=View._views[i]).isVisible()){View._focused=tempFocus=view;break;}}}}function handleMouseMove(view,event,point){view._handleMouseEvent('mousemove',event,point);}var navigator=window.navigator,mousedown,mousemove,mouseup;if(navigator.pointerEnabled||navigator.msPointerEnabled){mousedown='pointerdown MSPointerDown';mousemove='pointermove MSPointerMove';mouseup='pointerup pointercancel MSPointerUp MSPointerCancel';}else{mousedown='touchstart';mousemove='touchmove';mouseup='touchend touchcancel';if(!('ontouchstart'in window&&navigator.userAgent.match(/mobile|tablet|ip(ad|hone|od)|android|silk/i))){mousedown+=' mousedown';mousemove+=' mousemove';mouseup+=' mouseup';}}var viewEvents={},docEvents={mouseout:function(event){var view=View._focused,target=DomEvent.getRelatedTarget(event);if(view&&(!target||target.nodeName==='HTML')){var offset=DomEvent.getOffset(event,view._element),x=offset.x,abs=Math.abs,ax=abs(x),max=1<<25,diff=ax-max;offset.x=abs(diff)<ax?diff*(x<0?-1:1):x;handleMouseMove(view,event,view.viewToProject(offset));}},scroll:updateFocus};viewEvents[mousedown]=function(event){var view=View._focused=getView(event);if(!dragging){dragging=true;view._handleMouseEvent('mousedown',event);}};docEvents[mousemove]=function(event){var view=View._focused;if(!mouseDown){var target=getView(event);if(target){if(view!==target){if(view)handleMouseMove(view,event);if(!prevFocus)prevFocus=view;view=View._focused=tempFocus=target;}}else if(tempFocus&&tempFocus===view){if(prevFocus&&!prevFocus.isInserted())prevFocus=null;view=View._focused=prevFocus;prevFocus=null;updateFocus();}}if(view)handleMouseMove(view,event);};docEvents[mousedown]=function(){mouseDown=true;};docEvents[mouseup]=function(event){var view=View._focused;if(view&&dragging)view._handleMouseEvent('mouseup',event);mouseDown=dragging=false;};DomEvent.add(document,docEvents);DomEvent.add(window,{load:updateFocus});var called=false,prevented=false,fallbacks={doubleclick:'click',mousedrag:'mousemove'},wasInView=false,overView,downPoint,lastPoint,downItem,overItem,dragItem,clickItem,clickTime,dblClick;function emitMouseEvent(obj,target,type,event,point,prevPoint,stopItem){var stopped=false,mouseEvent;function emit(obj,type){if(obj.responds(type)){if(!mouseEvent){mouseEvent=new MouseEvent(type,event,point,target||obj,prevPoint?point.subtract(prevPoint):null);}if(obj.emit(type,mouseEvent)){called=true;if(mouseEvent.prevented)prevented=true;if(mouseEvent.stopped)return stopped=true;}}else{var fallback=fallbacks[type];if(fallback)return emit(obj,fallback);}}while(obj&&obj!==stopItem){if(emit(obj,type))break;obj=obj._parent;}return stopped;}function emitMouseEvents(view,hitItem,type,event,point,prevPoint){view._project.removeOn(type);prevented=called=false;return dragItem&&emitMouseEvent(dragItem,null,type,event,point,prevPoint)||hitItem&&hitItem!==dragItem&&!hitItem.isDescendant(dragItem)&&emitMouseEvent(hitItem,null,type,event,point,prevPoint,dragItem)||emitMouseEvent(view,dragItem||hitItem||view,type,event,point,prevPoint);}var itemEventsMap={mousedown:{mousedown:1,mousedrag:1,click:1,doubleclick:1},mouseup:{mouseup:1,mousedrag:1,click:1,doubleclick:1},mousemove:{mousedrag:1,mousemove:1,mouseenter:1,mouseleave:1}};return{_viewEvents:viewEvents,_handleMouseEvent:function(type,event,point){var itemEvents=this._itemEvents,hitItems=itemEvents.native[type],nativeMove=type==='mousemove',tool=this._scope.tool,view=this;function responds(type){return itemEvents.virtual[type]||view.responds(type)||tool&&tool.responds(type);}if(nativeMove&&dragging&&responds('mousedrag'))type='mousedrag';if(!point)point=this.getEventPoint(event);var inView=this.getBounds().contains(point),hit=hitItems&&inView&&view._project.hitTest(point,{tolerance:0,fill:true,stroke:true}),hitItem=hit&&hit.item||null,handle=false,mouse={};mouse[type.substr(5)]=true;if(hitItems&&hitItem!==overItem){if(overItem){emitMouseEvent(overItem,null,'mouseleave',event,point);}if(hitItem){emitMouseEvent(hitItem,null,'mouseenter',event,point);}overItem=hitItem;}if(wasInView^inView){emitMouseEvent(this,null,inView?'mouseenter':'mouseleave',event,point);overView=inView?this:null;handle=true;}if((inView||mouse.drag)&&!point.equals(lastPoint)){emitMouseEvents(this,hitItem,nativeMove?type:'mousemove',event,point,lastPoint);handle=true;}wasInView=inView;if(mouse.down&&inView||mouse.up&&downPoint){emitMouseEvents(this,hitItem,type,event,point,downPoint);if(mouse.down){dblClick=hitItem===clickItem&&Date.now()-clickTime<300;downItem=clickItem=hitItem;if(!prevented&&hitItem){var item=hitItem;while(item&&!item.responds('mousedrag'))item=item._parent;if(item)dragItem=hitItem;}downPoint=point;}else if(mouse.up){if(!prevented&&hitItem===downItem){clickTime=Date.now();emitMouseEvents(this,hitItem,dblClick?'doubleclick':'click',event,point,downPoint);dblClick=false;}downItem=dragItem=null;}wasInView=false;handle=true;}lastPoint=point;if(handle&&tool){called=tool._handleMouseEvent(type,event,point,mouse)||called;}if(called&&!mouse.move||mouse.down&&responds('mouseup'))event.preventDefault();},_handleKeyEvent:function(type,event,key,character){var scope=this._scope,tool=scope.tool,keyEvent;function emit(obj){if(obj.responds(type)){paper=scope;obj.emit(type,keyEvent=keyEvent||new KeyEvent(type,event,key,character));}}if(this.isVisible()){emit(this);if(tool&&tool.responds(type))emit(tool);}},_countItemEvent:function(type,sign){var itemEvents=this._itemEvents,native=itemEvents.native,virtual=itemEvents.virtual;for(var key in itemEventsMap){native[key]=(native[key]||0)+(itemEventsMap[key][type]||0)*sign;}virtual[type]=(virtual[type]||0)+sign;},statics:{updateFocus:updateFocus}};}());var CanvasView=View.extend({_class:'CanvasView',initialize:function CanvasView(project,canvas){if(!(canvas instanceof window.HTMLCanvasElement)){var size=Size.read(arguments,1);if(size.isZero())throw new Error('Cannot create CanvasView with the provided argument: '+Base.slice(arguments,1));canvas=CanvasProvider.getCanvas(size);}var ctx=this._context=canvas.getContext('2d');ctx.save();this._pixelRatio=1;if(!/^off|false$/.test(PaperScope.getAttribute(canvas,'hidpi'))){var deviceRatio=window.devicePixelRatio||1,backingStoreRatio=DomElement.getPrefixed(ctx,'backingStorePixelRatio')||1;this._pixelRatio=deviceRatio/backingStoreRatio;}View.call(this,project,canvas);this._needsUpdate=true;},remove:function remove(){this._context.restore();return remove.base.call(this);},_setElementSize:function _setElementSize(width,height){var pixelRatio=this._pixelRatio;_setElementSize.base.call(this,width*pixelRatio,height*pixelRatio);if(pixelRatio!==1){var element=this._element,ctx=this._context;if(!PaperScope.hasAttribute(element,'resize')){var style=element.style;style.width=width+'px';style.height=height+'px';}ctx.restore();ctx.save();ctx.scale(pixelRatio,pixelRatio);}},getPixelSize:function getPixelSize(size){var agent=paper.agent,pixels;if(agent&&agent.firefox){pixels=getPixelSize.base.call(this,size);}else{var ctx=this._context,prevFont=ctx.font;ctx.font=size+' serif';pixels=parseFloat(ctx.font);ctx.font=prevFont;}return pixels;},getTextWidth:function(font,lines){var ctx=this._context,prevFont=ctx.font,width=0;ctx.font=font;for(var i=0,l=lines.length;i<l;i++)width=Math.max(width,ctx.measureText(lines[i]).width);ctx.font=prevFont;return width;},update:function(){if(!this._needsUpdate)return false;var project=this._project,ctx=this._context,size=this._viewSize;ctx.clearRect(0,0,size.width+1,size.height+1);if(project)project.draw(ctx,this._matrix,this._pixelRatio);this._needsUpdate=false;return true;}});var Event=Base.extend({_class:'Event',initialize:function Event(event){this.event=event;this.type=event&&event.type;},prevented:false,stopped:false,preventDefault:function(){this.prevented=true;this.event.preventDefault();},stopPropagation:function(){this.stopped=true;this.event.stopPropagation();},stop:function(){this.stopPropagation();this.preventDefault();},getTimeStamp:function(){return this.event.timeStamp;},getModifiers:function(){return Key.modifiers;}});var KeyEvent=Event.extend({_class:'KeyEvent',initialize:function KeyEvent(type,event,key,character){this.type=type;this.event=event;this.key=key;this.character=character;},toString:function(){return"{ type: '"+this.type+"', key: '"+this.key+"', character: '"+this.character+"', modifiers: "+this.getModifiers()+" }";}});var Key=new function(){var keyLookup={'\t':'tab',' ':'space','\b':'backspace','\x7f':'delete','Spacebar':'space','Del':'delete','Win':'meta','Esc':'escape'},charLookup={'tab':'\t','space':' ','enter':'\r'},keyMap={},charMap={},metaFixMap,downKey,modifiers=new Base({shift:false,control:false,alt:false,meta:false,capsLock:false,space:false}).inject({option:{get:function(){return this.alt;}},command:{get:function(){var agent=paper&&paper.agent;return agent&&agent.mac?this.meta:this.control;}}});function getKey(event){var key=event.key||event.keyIdentifier;key=/^U\+/.test(key)?String.fromCharCode(parseInt(key.substr(2),16)):/^Arrow[A-Z]/.test(key)?key.substr(5):key==='Unidentified'||key===undefined?String.fromCharCode(event.keyCode):key;return keyLookup[key]||(key.length>1?Base.hyphenate(key):key.toLowerCase());}function handleKey(down,key,character,event){var type=down?'keydown':'keyup',view=View._focused,name;keyMap[key]=down;if(down){charMap[key]=character;}else{delete charMap[key];}if(key.length>1&&(name=Base.camelize(key))in modifiers){modifiers[name]=down;var agent=paper&&paper.agent;if(name==='meta'&&agent&&agent.mac){if(down){metaFixMap={};}else{for(var k in metaFixMap){if(k in charMap)handleKey(false,k,metaFixMap[k],event);}metaFixMap=null;}}}else if(down&&metaFixMap){metaFixMap[key]=character;}if(view){view._handleKeyEvent(down?'keydown':'keyup',event,key,character);}}DomEvent.add(document,{keydown:function(event){var key=getKey(event),agent=paper&&paper.agent;if(key.length>1||agent&&agent.chrome&&(event.altKey||agent.mac&&event.metaKey||!agent.mac&&event.ctrlKey)){handleKey(true,key,charLookup[key]||(key.length>1?'':key),event);}else{downKey=key;}},keypress:function(event){if(downKey){var key=getKey(event),code=event.charCode,character=code>=32?String.fromCharCode(code):key.length>1?'':key;if(key!==downKey){key=character.toLowerCase();}handleKey(true,key,character,event);downKey=null;}},keyup:function(event){var key=getKey(event);if(key in charMap)handleKey(false,key,charMap[key],event);}});DomEvent.add(window,{blur:function(event){for(var key in charMap)handleKey(false,key,charMap[key],event);}});return{modifiers:modifiers,isDown:function(key){return!!keyMap[key];}};}();var MouseEvent=Event.extend({_class:'MouseEvent',initialize:function MouseEvent(type,event,point,target,delta){this.type=type;this.event=event;this.point=point;this.target=target;this.delta=delta;},toString:function(){return"{ type: '"+this.type+"', point: "+this.point+', target: '+this.target+(this.delta?', delta: '+this.delta:'')+', modifiers: '+this.getModifiers()+' }';}});var ToolEvent=Event.extend({_class:'ToolEvent',_item:null,initialize:function ToolEvent(tool,type,event){this.tool=tool;this.type=type;this.event=event;},_choosePoint:function(point,toolPoint){return point?point:toolPoint?toolPoint.clone():null;},getPoint:function(){return this._choosePoint(this._point,this.tool._point);},setPoint:function(point){this._point=point;},getLastPoint:function(){return this._choosePoint(this._lastPoint,this.tool._lastPoint);},setLastPoint:function(lastPoint){this._lastPoint=lastPoint;},getDownPoint:function(){return this._choosePoint(this._downPoint,this.tool._downPoint);},setDownPoint:function(downPoint){this._downPoint=downPoint;},getMiddlePoint:function(){if(!this._middlePoint&&this.tool._lastPoint){return this.tool._point.add(this.tool._lastPoint).divide(2);}return this._middlePoint;},setMiddlePoint:function(middlePoint){this._middlePoint=middlePoint;},getDelta:function(){return!this._delta&&this.tool._lastPoint?this.tool._point.subtract(this.tool._lastPoint):this._delta;},setDelta:function(delta){this._delta=delta;},getCount:function(){return this.tool[/^mouse(down|up)$/.test(this.type)?'_downCount':'_moveCount'];},setCount:function(count){this.tool[/^mouse(down|up)$/.test(this.type)?'downCount':'count']=count;},getItem:function(){if(!this._item){var result=this.tool._scope.project.hitTest(this.getPoint());if(result){var item=result.item,parent=item._parent;while(/^(Group|CompoundPath)$/.test(parent._class)){item=parent;parent=parent._parent;}this._item=item;}}return this._item;},setItem:function(item){this._item=item;},toString:function(){return'{ type: '+this.type+', point: '+this.getPoint()+', count: '+this.getCount()+', modifiers: '+this.getModifiers()+' }';}});var Tool=PaperScopeItem.extend({_class:'Tool',_list:'tools',_reference:'tool',_events:['onMouseDown','onMouseUp','onMouseDrag','onMouseMove','onActivate','onDeactivate','onEditOptions','onKeyDown','onKeyUp'],initialize:function Tool(props){PaperScopeItem.call(this);this._moveCount=-1;this._downCount=-1;this.set(props);},getMinDistance:function(){return this._minDistance;},setMinDistance:function(minDistance){this._minDistance=minDistance;if(minDistance!=null&&this._maxDistance!=null&&minDistance>this._maxDistance){this._maxDistance=minDistance;}},getMaxDistance:function(){return this._maxDistance;},setMaxDistance:function(maxDistance){this._maxDistance=maxDistance;if(this._minDistance!=null&&maxDistance!=null&&maxDistance<this._minDistance){this._minDistance=maxDistance;}},getFixedDistance:function(){return this._minDistance==this._maxDistance?this._minDistance:null;},setFixedDistance:function(distance){this._minDistance=this._maxDistance=distance;},_handleMouseEvent:function(type,event,point,mouse){paper=this._scope;if(mouse.drag&&!this.responds(type))type='mousemove';var move=mouse.move||mouse.drag,responds=this.responds(type),minDistance=this.minDistance,maxDistance=this.maxDistance,called=false,tool=this;function update(minDistance,maxDistance){var pt=point,toolPoint=move?tool._point:tool._downPoint||pt;if(move){if(tool._moveCount&&pt.equals(toolPoint)){return false;}if(toolPoint&&(minDistance!=null||maxDistance!=null)){var vector=pt.subtract(toolPoint),distance=vector.getLength();if(distance<(minDistance||0))return false;if(maxDistance){pt=toolPoint.add(vector.normalize(Math.min(distance,maxDistance)));}}tool._moveCount++;}tool._point=pt;tool._lastPoint=toolPoint||pt;if(mouse.down){tool._moveCount=-1;tool._downPoint=pt;tool._downCount++;}return true;}function emit(){if(responds){called=tool.emit(type,new ToolEvent(tool,type,event))||called;}}if(mouse.down){update();emit();}else if(mouse.up){update(null,maxDistance);emit();}else if(responds){while(update(minDistance,maxDistance))emit();}return called;}});var Http={request:function(options){var xhr=new self.XMLHttpRequest();xhr.open((options.method||'get').toUpperCase(),options.url,Base.pick(options.async,true));if(options.mimeType)xhr.overrideMimeType(options.mimeType);xhr.onload=function(){var status=xhr.status;if(status===0||status===200){if(options.onLoad){options.onLoad.call(xhr,xhr.responseText);}}else{xhr.onerror();}};xhr.onerror=function(){var status=xhr.status,message='Could not load "'+options.url+'" (Status: '+status+')';if(options.onError){options.onError(message,status);}else{throw new Error(message);}};return xhr.send(null);}};var CanvasProvider={canvases:[],getCanvas:function(width,height){if(!window)return null;var canvas,clear=true;if(typeof width==='object'){height=width.height;width=width.width;}if(this.canvases.length){canvas=this.canvases.pop();}else{canvas=document.createElement('canvas');clear=false;}var ctx=canvas.getContext('2d');if(!ctx){throw new Error('Canvas '+canvas+' is unable to provide a 2D context.');}if(canvas.width===width&&canvas.height===height){if(clear)ctx.clearRect(0,0,width+1,height+1);}else{canvas.width=width;canvas.height=height;}ctx.save();return canvas;},getContext:function(width,height){var canvas=this.getCanvas(width,height);return canvas?canvas.getContext('2d'):null;},release:function(obj){var canvas=obj&&obj.canvas?obj.canvas:obj;if(canvas&&canvas.getContext){canvas.getContext('2d').restore();this.canvases.push(canvas);}}};var BlendMode=new function(){var min=Math.min,max=Math.max,abs=Math.abs,sr,sg,sb,sa,br,bg,bb,ba,dr,dg,db;function getLum(r,g,b){return 0.2989*r+0.587*g+0.114*b;}function setLum(r,g,b,l){var d=l-getLum(r,g,b);dr=r+d;dg=g+d;db=b+d;var l=getLum(dr,dg,db),mn=min(dr,dg,db),mx=max(dr,dg,db);if(mn<0){var lmn=l-mn;dr=l+(dr-l)*l/lmn;dg=l+(dg-l)*l/lmn;db=l+(db-l)*l/lmn;}if(mx>255){var ln=255-l,mxl=mx-l;dr=l+(dr-l)*ln/mxl;dg=l+(dg-l)*ln/mxl;db=l+(db-l)*ln/mxl;}}function getSat(r,g,b){return max(r,g,b)-min(r,g,b);}function setSat(r,g,b,s){var col=[r,g,b],mx=max(r,g,b),mn=min(r,g,b),md;mn=mn===r?0:mn===g?1:2;mx=mx===r?0:mx===g?1:2;md=min(mn,mx)===0?max(mn,mx)===1?2:1:0;if(col[mx]>col[mn]){col[md]=(col[md]-col[mn])*s/(col[mx]-col[mn]);col[mx]=s;}else{col[md]=col[mx]=0;}col[mn]=0;dr=col[0];dg=col[1];db=col[2];}var modes={multiply:function(){dr=br*sr/255;dg=bg*sg/255;db=bb*sb/255;},screen:function(){dr=br+sr-br*sr/255;dg=bg+sg-bg*sg/255;db=bb+sb-bb*sb/255;},overlay:function(){dr=br<128?2*br*sr/255:255-2*(255-br)*(255-sr)/255;dg=bg<128?2*bg*sg/255:255-2*(255-bg)*(255-sg)/255;db=bb<128?2*bb*sb/255:255-2*(255-bb)*(255-sb)/255;},'soft-light':function(){var t=sr*br/255;dr=t+br*(255-(255-br)*(255-sr)/255-t)/255;t=sg*bg/255;dg=t+bg*(255-(255-bg)*(255-sg)/255-t)/255;t=sb*bb/255;db=t+bb*(255-(255-bb)*(255-sb)/255-t)/255;},'hard-light':function(){dr=sr<128?2*sr*br/255:255-2*(255-sr)*(255-br)/255;dg=sg<128?2*sg*bg/255:255-2*(255-sg)*(255-bg)/255;db=sb<128?2*sb*bb/255:255-2*(255-sb)*(255-bb)/255;},'color-dodge':function(){dr=br===0?0:sr===255?255:min(255,255*br/(255-sr));dg=bg===0?0:sg===255?255:min(255,255*bg/(255-sg));db=bb===0?0:sb===255?255:min(255,255*bb/(255-sb));},'color-burn':function(){dr=br===255?255:sr===0?0:max(0,255-(255-br)*255/sr);dg=bg===255?255:sg===0?0:max(0,255-(255-bg)*255/sg);db=bb===255?255:sb===0?0:max(0,255-(255-bb)*255/sb);},darken:function(){dr=br<sr?br:sr;dg=bg<sg?bg:sg;db=bb<sb?bb:sb;},lighten:function(){dr=br>sr?br:sr;dg=bg>sg?bg:sg;db=bb>sb?bb:sb;},difference:function(){dr=br-sr;if(dr<0)dr=-dr;dg=bg-sg;if(dg<0)dg=-dg;db=bb-sb;if(db<0)db=-db;},exclusion:function(){dr=br+sr*(255-br-br)/255;dg=bg+sg*(255-bg-bg)/255;db=bb+sb*(255-bb-bb)/255;},hue:function(){setSat(sr,sg,sb,getSat(br,bg,bb));setLum(dr,dg,db,getLum(br,bg,bb));},saturation:function(){setSat(br,bg,bb,getSat(sr,sg,sb));setLum(dr,dg,db,getLum(br,bg,bb));},luminosity:function(){setLum(br,bg,bb,getLum(sr,sg,sb));},color:function(){setLum(sr,sg,sb,getLum(br,bg,bb));},add:function(){dr=min(br+sr,255);dg=min(bg+sg,255);db=min(bb+sb,255);},subtract:function(){dr=max(br-sr,0);dg=max(bg-sg,0);db=max(bb-sb,0);},average:function(){dr=(br+sr)/2;dg=(bg+sg)/2;db=(bb+sb)/2;},negation:function(){dr=255-abs(255-sr-br);dg=255-abs(255-sg-bg);db=255-abs(255-sb-bb);}};var nativeModes=this.nativeModes=Base.each(['source-over','source-in','source-out','source-atop','destination-over','destination-in','destination-out','destination-atop','lighter','darker','copy','xor'],function(mode){this[mode]=true;},{});var ctx=CanvasProvider.getContext(1,1);if(ctx){Base.each(modes,function(func,mode){var darken=mode==='darken',ok=false;ctx.save();try{ctx.fillStyle=darken?'#300':'#a00';ctx.fillRect(0,0,1,1);ctx.globalCompositeOperation=mode;if(ctx.globalCompositeOperation===mode){ctx.fillStyle=darken?'#a00':'#300';ctx.fillRect(0,0,1,1);ok=ctx.getImageData(0,0,1,1).data[0]!==darken?170:51;}}catch(e){}ctx.restore();nativeModes[mode]=ok;});CanvasProvider.release(ctx);}this.process=function(mode,srcContext,dstContext,alpha,offset){var srcCanvas=srcContext.canvas,normal=mode==='normal';if(normal||nativeModes[mode]){dstContext.save();dstContext.setTransform(1,0,0,1,0,0);dstContext.globalAlpha=alpha;if(!normal)dstContext.globalCompositeOperation=mode;dstContext.drawImage(srcCanvas,offset.x,offset.y);dstContext.restore();}else{var process=modes[mode];if(!process)return;var dstData=dstContext.getImageData(offset.x,offset.y,srcCanvas.width,srcCanvas.height),dst=dstData.data,src=srcContext.getImageData(0,0,srcCanvas.width,srcCanvas.height).data;for(var i=0,l=dst.length;i<l;i+=4){sr=src[i];br=dst[i];sg=src[i+1];bg=dst[i+1];sb=src[i+2];bb=dst[i+2];sa=src[i+3];ba=dst[i+3];process();var a1=sa*alpha/255,a2=1-a1;dst[i]=a1*dr+a2*br;dst[i+1]=a1*dg+a2*bg;dst[i+2]=a1*db+a2*bb;dst[i+3]=sa*alpha+a2*ba;}dstContext.putImageData(dstData,offset.x,offset.y);}};}();var SvgElement=new function(){var svg='http://www.w3.org/2000/svg',xmlns='http://www.w3.org/2000/xmlns',xlink='http://www.w3.org/1999/xlink',attributeNamespace={href:xlink,xlink:xmlns,xmlns:xmlns+'/','xmlns:xlink':xmlns+'/'};function create(tag,attributes,formatter){return set(document.createElementNS(svg,tag),attributes,formatter);}function get(node,name){var namespace=attributeNamespace[name],value=namespace?node.getAttributeNS(namespace,name):node.getAttribute(name);return value==='null'?null:value;}function set(node,attributes,formatter){for(var name in attributes){var value=attributes[name],namespace=attributeNamespace[name];if(typeof value==='number'&&formatter)value=formatter.number(value);if(namespace){node.setAttributeNS(namespace,name,value);}else{node.setAttribute(name,value);}}return node;}return{svg:svg,xmlns:xmlns,xlink:xlink,create:create,get:get,set:set};}();var SvgStyles=Base.each({fillColor:['fill','color'],fillRule:['fill-rule','string'],strokeColor:['stroke','color'],strokeWidth:['stroke-width','number'],strokeCap:['stroke-linecap','string'],strokeJoin:['stroke-linejoin','string'],strokeScaling:['vector-effect','lookup',{true:'none',false:'non-scaling-stroke'},function(item,value){return!value&&(item instanceof PathItem||item instanceof Shape||item instanceof TextItem);}],miterLimit:['stroke-miterlimit','number'],dashArray:['stroke-dasharray','array'],dashOffset:['stroke-dashoffset','number'],fontFamily:['font-family','string'],fontWeight:['font-weight','string'],fontSize:['font-size','number'],fontStretch:['font-stretch','string'],justification:['text-anchor','lookup',{left:'start',center:'middle',right:'end'}],opacity:['opacity','number'],blendMode:['mix-blend-mode','style']},function(entry,key){var part=Base.capitalize(key),lookup=entry[2];this[key]={type:entry[1],property:key,attribute:entry[0],toSVG:lookup,fromSVG:lookup&&Base.each(lookup,function(value,name){this[value]=name;},{}),exportFilter:entry[3],get:'get'+part,set:'set'+part};},{});new function(){var formatter;function getTransform(matrix,coordinates,center){var attrs=new Base(),trans=matrix.getTranslation();if(coordinates){matrix=matrix._shiftless();var point=matrix._inverseTransform(trans);attrs[center?'cx':'x']=point.x;attrs[center?'cy':'y']=point.y;trans=null;}if(!matrix.isIdentity()){var decomposed=matrix.decompose();if(decomposed){var parts=[],angle=decomposed.rotation,scale=decomposed.scaling,skew=decomposed.skewing;if(trans&&!trans.isZero())parts.push('translate('+formatter.point(trans)+')');if(angle)parts.push('rotate('+formatter.number(angle)+')');if(!Numerical.isZero(scale.x-1)||!Numerical.isZero(scale.y-1))parts.push('scale('+formatter.point(scale)+')');if(skew.x)parts.push('skewX('+formatter.number(skew.x)+')');if(skew.y)parts.push('skewY('+formatter.number(skew.y)+')');attrs.transform=parts.join(' ');}else{attrs.transform='matrix('+matrix.getValues().join(',')+')';}}return attrs;}function exportGroup(item,options){var attrs=getTransform(item._matrix),children=item._children;var node=SvgElement.create('g',attrs,formatter);for(var i=0,l=children.length;i<l;i++){var child=children[i];var childNode=exportSVG(child,options);if(childNode){if(child.isClipMask()){var clip=SvgElement.create('clipPath');clip.appendChild(childNode);setDefinition(child,clip,'clip');SvgElement.set(node,{'clip-path':'url(#'+clip.id+')'});}else{node.appendChild(childNode);}}}return node;}function exportRaster(item,options){var attrs=getTransform(item._matrix,true),size=item.getSize(),image=item.getImage();attrs.x-=size.width/2;attrs.y-=size.height/2;attrs.width=size.width;attrs.height=size.height;attrs.href=options.embedImages==false&&image&&image.src||item.toDataURL();return SvgElement.create('image',attrs,formatter);}function exportPath(item,options){var matchShapes=options.matchShapes;if(matchShapes){var shape=item.toShape(false);if(shape)return exportShape(shape,options);}var segments=item._segments,length=segments.length,type,attrs=getTransform(item._matrix);if(matchShapes&&length>=2&&!item.hasHandles()){if(length>2){type=item._closed?'polygon':'polyline';var parts=[];for(var i=0;i<length;i++){parts.push(formatter.point(segments[i]._point));}attrs.points=parts.join(' ');}else{type='line';var start=segments[0]._point,end=segments[1]._point;attrs.set({x1:start.x,y1:start.y,x2:end.x,y2:end.y});}}else{type='path';attrs.d=item.getPathData(null,options.precision);}return SvgElement.create(type,attrs,formatter);}function exportShape(item){var type=item._type,radius=item._radius,attrs=getTransform(item._matrix,true,type!=='rectangle');if(type==='rectangle'){type='rect';var size=item._size,width=size.width,height=size.height;attrs.x-=width/2;attrs.y-=height/2;attrs.width=width;attrs.height=height;if(radius.isZero())radius=null;}if(radius){if(type==='circle'){attrs.r=radius;}else{attrs.rx=radius.width;attrs.ry=radius.height;}}return SvgElement.create(type,attrs,formatter);}function exportCompoundPath(item,options){var attrs=getTransform(item._matrix);var data=item.getPathData(null,options.precision);if(data)attrs.d=data;return SvgElement.create('path',attrs,formatter);}function exportSymbolItem(item,options){var attrs=getTransform(item._matrix,true),definition=item._definition,node=getDefinition(definition,'symbol'),definitionItem=definition._item,bounds=definitionItem.getBounds();if(!node){node=SvgElement.create('symbol',{viewBox:formatter.rectangle(bounds)});node.appendChild(exportSVG(definitionItem,options));setDefinition(definition,node,'symbol');}attrs.href='#'+node.id;attrs.x+=bounds.x;attrs.y+=bounds.y;attrs.width=bounds.width;attrs.height=bounds.height;attrs.overflow='visible';return SvgElement.create('use',attrs,formatter);}function exportGradient(color){var gradientNode=getDefinition(color,'color');if(!gradientNode){var gradient=color.getGradient(),radial=gradient._radial,origin=color.getOrigin(),destination=color.getDestination(),attrs;if(radial){attrs={cx:origin.x,cy:origin.y,r:origin.getDistance(destination)};var highlight=color.getHighlight();if(highlight){attrs.fx=highlight.x;attrs.fy=highlight.y;}}else{attrs={x1:origin.x,y1:origin.y,x2:destination.x,y2:destination.y};}attrs.gradientUnits='userSpaceOnUse';gradientNode=SvgElement.create((radial?'radial':'linear')+'Gradient',attrs,formatter);var stops=gradient._stops;for(var i=0,l=stops.length;i<l;i++){var stop=stops[i],stopColor=stop._color,alpha=stopColor.getAlpha(),offset=stop._offset;attrs={offset:offset==null?i/(l-1):offset};if(stopColor)attrs['stop-color']=stopColor.toCSS(true);if(alpha<1)attrs['stop-opacity']=alpha;gradientNode.appendChild(SvgElement.create('stop',attrs,formatter));}setDefinition(color,gradientNode,'color');}return'url(#'+gradientNode.id+')';}function exportText(item){var node=SvgElement.create('text',getTransform(item._matrix,true),formatter);// Codice Originale...
// node.textContent = item._content;
// return node;
if(item.content==""||item.content=="⠀")return null;if(/[\u0590-\u05ff\u0600-\u06ff]/.test(item.content)){node.style.direction="rtl";node.style.textAnchor="end";}var dy=item.leading;// Modifica per gestire il multilinea...
for(var i=0;i<item._lines.length;i++){var tspan=document.createElementNS("http://www.w3.org/2000/svg","tspan");tspan.textContent=item._lines[i];// DO NOT UNCOMMENT! This caused strange Xs characters to appear in the SVG files when opening with Illustrator
//
//if (!tspan.textContent) {
//    // Se la riga è solo un ritorno a capo imposto il textcontent a un carattere unicode vuoto
//    // Unicode (U+2800)
//    tspan.textContent = String.fromCharCode(0x2800);
//}
if(i===0)dy=0;tspan.setAttributeNS(null,"x",node.getAttribute('x'));tspan.setAttributeNS(null,"dy",dy);if(tspan.textContent.trim()=="")dy+=item.leading;else dy=item.leading;node.appendChild(tspan);}return node;}var exporters={Group:exportGroup,Layer:exportGroup,Raster:exportRaster,Path:exportPath,Shape:exportShape,CompoundPath:exportCompoundPath,SymbolItem:exportSymbolItem,PointText:exportText};function applyStyle(item,node,isRoot){var attrs={},parent=!isRoot&&item.getParent(),style=[];if(item._name!=null)attrs.id=item._name;Base.each(SvgStyles,function(entry){var get=entry.get,type=entry.type,value=item[get]();if(entry.exportFilter?entry.exportFilter(item,value):!parent||!Base.equals(parent[get](),value)){if(type==='color'&&value!=null){var alpha=value.getAlpha();if(alpha<1)attrs[entry.attribute+'-opacity']=alpha;}if(type==='style'){style.push(entry.attribute+': '+value);}else{attrs[entry.attribute]=value==null?'none':type==='color'?value.gradient?exportGradient(value,item):value.toCSS(true):type==='array'?value.join(','):type==='lookup'?entry.toSVG[value]:value;}}});if(style.length)attrs.style=style.join(';');if(attrs.opacity===1)delete attrs.opacity;if(!item._visible)attrs.visibility='hidden';return SvgElement.set(node,attrs,formatter);}var definitions;function getDefinition(item,type){if(!definitions)definitions={ids:{},svgs:{}};return item&&definitions.svgs[type+'-'+(item._id||item.__id||(item.__id=UID.get('svg')))];}function setDefinition(item,node,type){if(!definitions)getDefinition();var typeId=definitions.ids[type]=(definitions.ids[type]||0)+1;node.id=type+'-'+typeId;definitions.svgs[type+'-'+(item._id||item.__id)]=node;}function exportDefinitions(node,options){var svg=node,defs=null;if(definitions){svg=node.nodeName.toLowerCase()==='svg'&&node;for(var i in definitions.svgs){if(!defs){if(!svg){svg=SvgElement.create('svg');svg.appendChild(node);}defs=svg.insertBefore(SvgElement.create('defs'),svg.firstChild);}defs.appendChild(definitions.svgs[i]);}definitions=null;}return options.asString?new self.XMLSerializer().serializeToString(svg):svg;}function exportSVG(item,options,isRoot){var exporter=exporters[item._class],node=exporter&&exporter(item,options);if(node){var onExport=options.onExport;if(onExport)node=onExport(item,node,options)||node;var data=JSON.stringify(item._data);if(data&&data!=='{}'&&data!=='null')node.setAttribute('data-paper-data',data);}return node&&applyStyle(item,node,isRoot);}function setOptions(options){if(!options)options={};formatter=new Formatter(options.precision);return options;}Item.inject({exportSVG:function(options){options=setOptions(options);return exportDefinitions(exportSVG(this,options,true),options);}});Project.inject({exportSVG:function(options){options=setOptions(options);var children=this._children,view=this.getView(),bounds=Base.pick(options.bounds,'view'),mx=options.matrix||bounds==='view'&&view._matrix,matrix=mx&&Matrix.read([mx]),rect=bounds==='view'?new Rectangle([0,0],view.getViewSize()):bounds==='content'?Item._getBounds(children,matrix,{stroke:true}).rect:Rectangle.read([bounds],0,{readNull:true}),attrs={version:'1.1',xmlns:SvgElement.svg,'xmlns:xlink':SvgElement.xlink};if(rect){attrs.width=rect.width;attrs.height=rect.height;if(rect.x||rect.y)attrs.viewBox=formatter.rectangle(rect);}var node=SvgElement.create('svg',attrs,formatter),parent=node;if(matrix&&!matrix.isIdentity()){parent=node.appendChild(SvgElement.create('g',getTransform(matrix),formatter));}for(var i=0,l=children.length;i<l;i++){parent.appendChild(exportSVG(children[i],options,true));}return exportDefinitions(node,options);}});}();new function(){var definitions={},rootSize;function getValue(node,name,isString,allowNull,allowPercent){var value=SvgElement.get(node,name),res=value==null?allowNull?null:isString?'':0:isString?value:parseFloat(value);return /%\s*$/.test(value)?res/100*(allowPercent?1:rootSize[/x|^width/.test(name)?'width':'height']):res;}function getPoint(node,x,y,allowNull,allowPercent){x=getValue(node,x||'x',false,allowNull,allowPercent);y=getValue(node,y||'y',false,allowNull,allowPercent);return allowNull&&(x==null||y==null)?null:new Point(x,y);}function getSize(node,w,h,allowNull,allowPercent){w=getValue(node,w||'width',false,allowNull,allowPercent);h=getValue(node,h||'height',false,allowNull,allowPercent);return allowNull&&(w==null||h==null)?null:new Size(w,h);}function convertValue(value,type,lookup){return value==='none'?null:type==='number'?parseFloat(value):type==='array'?value?value.split(/[\s,]+/g).map(parseFloat):[]:type==='color'?getDefinition(value)||value:type==='lookup'?lookup[value]:value;}function importGroup(node,type,options,isRoot){var nodes=node.childNodes,isClip=type==='clippath',isDefs=type==='defs',item=new Group(),project=item._project,currentStyle=project._currentStyle,children=[];if(!isClip&&!isDefs){item=applyAttributes(item,node,isRoot);project._currentStyle=item._style.clone();}if(isRoot){var defs=node.querySelectorAll('defs');for(var i=0,l=defs.length;i<l;i++){importNode(defs[i],options,false);}}for(var i=0,l=nodes.length;i<l;i++){var childNode=nodes[i],child;if(childNode.nodeType===1&&!/^defs$/i.test(childNode.nodeName)&&(child=importNode(childNode,options,false))&&!(child instanceof SymbolDefinition))children.push(child);}item.addChildren(children);if(isClip)item=applyAttributes(item.reduce(),node,isRoot);project._currentStyle=currentStyle;if(isClip||isDefs){item.remove();item=null;}return item;}function importPoly(node,type){var coords=node.getAttribute('points').match(/[+-]?(?:\d*\.\d+|\d+\.?)(?:[eE][+-]?\d+)?/g),points=[];for(var i=0,l=coords.length;i<l;i+=2)points.push(new Point(parseFloat(coords[i]),parseFloat(coords[i+1])));var path=new Path(points);if(type==='polygon')path.closePath();return path;}function importPath(node){return PathItem.create(node.getAttribute('d'));}function importGradient(node,type){var id=(getValue(node,'href',true)||'').substring(1),radial=type==='radialgradient',gradient;if(id){gradient=definitions[id].getGradient();if(gradient._radial^radial){gradient=gradient.clone();gradient._radial=radial;}}else{var nodes=node.childNodes,stops=[];for(var i=0,l=nodes.length;i<l;i++){var child=nodes[i];if(child.nodeType===1)stops.push(applyAttributes(new GradientStop(),child));}gradient=new Gradient(stops,radial);}var origin,destination,highlight,scaleToBounds=getValue(node,'gradientUnits',true)!=='userSpaceOnUse';if(radial){origin=getPoint(node,'cx','cy',false,scaleToBounds);destination=origin.add(getValue(node,'r',false,false,scaleToBounds),0);highlight=getPoint(node,'fx','fy',true,scaleToBounds);}else{origin=getPoint(node,'x1','y1',false,scaleToBounds);destination=getPoint(node,'x2','y2',false,scaleToBounds);}var color=applyAttributes(new Color(gradient,origin,destination,highlight),node);color._scaleToBounds=scaleToBounds;return null;}var importers={'#document':function(node,type,options,isRoot){var nodes=node.childNodes;for(var i=0,l=nodes.length;i<l;i++){var child=nodes[i];if(child.nodeType===1)return importNode(child,options,isRoot);}},g:importGroup,svg:importGroup,clippath:importGroup,polygon:importPoly,polyline:importPoly,path:importPath,lineargradient:importGradient,radialgradient:importGradient,image:function(node){var raster=new Raster(getValue(node,'href',true));raster.on('load',function(){var size=getSize(node);this.setSize(size);var center=this._matrix._transformPoint(getPoint(node).add(size.divide(2)));this.translate(center);});return raster;},symbol:function(node,type,options,isRoot){return new SymbolDefinition(importGroup(node,type,options,isRoot),true);},defs:importGroup,use:function(node){var id=(getValue(node,'href',true)||'').substring(1),definition=definitions[id],point=getPoint(node);return definition?definition instanceof SymbolDefinition?definition.place(point):definition.clone().translate(point):null;},circle:function(node){return new Shape.Circle(getPoint(node,'cx','cy'),getValue(node,'r'));},ellipse:function(node){return new Shape.Ellipse({center:getPoint(node,'cx','cy'),radius:getSize(node,'rx','ry')});},rect:function(node){return new Shape.Rectangle(new Rectangle(getPoint(node),getSize(node)),getSize(node,'rx','ry'));},line:function(node){return new Path.Line(getPoint(node,'x1','y1'),getPoint(node,'x2','y2'));},text:function(node){var text=new PointText(getPoint(node).add(getPoint(node,'dx','dy')));text.setContent(node.textContent.trim()||'');return text;}};function applyTransform(item,value,name,node){if(item.transform){var transforms=(node.getAttribute(name)||'').split(/\)\s*/g),matrix=new Matrix();for(var i=0,l=transforms.length;i<l;i++){var transform=transforms[i];if(!transform)break;var parts=transform.split(/\(\s*/),command=parts[0],v=parts[1].split(/[\s,]+/g);for(var j=0,m=v.length;j<m;j++)v[j]=parseFloat(v[j]);switch(command){case'matrix':matrix.append(new Matrix(v[0],v[1],v[2],v[3],v[4],v[5]));break;case'rotate':matrix.rotate(v[0],v[1],v[2]);break;case'translate':matrix.translate(v[0],v[1]);break;case'scale':matrix.scale(v);break;case'skewX':matrix.skew(v[0],0);break;case'skewY':matrix.skew(0,v[0]);break;}}item.transform(matrix);}}function applyOpacity(item,value,name){var key=name==='fill-opacity'?'getFillColor':'getStrokeColor',color=item[key]&&item[key]();if(color)color.setAlpha(parseFloat(value));}var attributes=Base.set(Base.each(SvgStyles,function(entry){this[entry.attribute]=function(item,value){if(item[entry.set]){item[entry.set](convertValue(value,entry.type,entry.fromSVG));if(entry.type==='color'){var color=item[entry.get]();if(color){if(color._scaleToBounds){var bounds=item.getBounds();color.transform(new Matrix().translate(bounds.getPoint()).scale(bounds.getSize()));}}}}};},{}),{id:function(item,value){definitions[value]=item;if(item.setName)item.setName(value);},'clip-path':function(item,value){var clip=getDefinition(value);if(clip){clip=clip.clone();clip.setClipMask(true);if(item instanceof Group){item.insertChild(0,clip);}else{return new Group(clip,item);}}},gradientTransform:applyTransform,transform:applyTransform,'fill-opacity':applyOpacity,'stroke-opacity':applyOpacity,visibility:function(item,value){if(item.setVisible)item.setVisible(value==='visible');},display:function(item,value){if(item.setVisible)item.setVisible(value!==null);},'stop-color':function(item,value){if(item.setColor)item.setColor(value);},'stop-opacity':function(item,value){if(item._color)item._color.setAlpha(parseFloat(value));},offset:function(item,value){if(item.setOffset){var percent=value.match(/(.*)%$/);item.setOffset(percent?percent[1]/100:parseFloat(value));}},viewBox:function(item,value,name,node,styles){var rect=new Rectangle(convertValue(value,'array')),size=getSize(node,null,null,true),group,matrix;if(item instanceof Group){var scale=size?size.divide(rect.getSize()):1,matrix=new Matrix().scale(scale).translate(rect.getPoint().negate());group=item;}else if(item instanceof SymbolDefinition){if(size)rect.setSize(size);group=item._item;}if(group){if(getAttribute(node,'overflow',styles)!=='visible'){var clip=new Shape.Rectangle(rect);clip.setClipMask(true);group.addChild(clip);}if(matrix)group.transform(matrix);}}});function getAttribute(node,name,styles){var attr=node.attributes[name],value=attr&&attr.value;if(!value){var style=Base.camelize(name);value=node.style[style];if(!value&&styles.node[style]!==styles.parent[style])value=styles.node[style];}return!value?undefined:value==='none'?null:value;}function applyAttributes(item,node,isRoot){if(node.style){var parent=node.parentNode,styles={node:DomElement.getStyles(node)||{},parent:!isRoot&&!/^defs$/i.test(parent.tagName)&&DomElement.getStyles(parent)||{}};Base.each(attributes,function(apply,name){var value=getAttribute(node,name,styles);item=value!==undefined&&apply(item,value,name,node,styles)||item;});}return item;}function getDefinition(value){var match=value&&value.match(/\((?:["'#]*)([^"')]+)/),name=match&&match[1],res=name&&definitions[window?name.replace(window.location.href.split('#')[0]+'#',''):name];if(res&&res._scaleToBounds){res=res.clone();res._scaleToBounds=true;}return res;}function importNode(node,options,isRoot){var type=node.nodeName.toLowerCase(),isElement=type!=='#document',body=document.body,container,parent,next;if(isRoot&&isElement){rootSize=paper.getView().getSize();rootSize=getSize(node,null,null,true)||rootSize;container=SvgElement.create('svg',{style:'stroke-width: 1px; stroke-miterlimit: 10'});parent=node.parentNode;next=node.nextSibling;container.appendChild(node);body.appendChild(container);}var settings=paper.settings,applyMatrix=settings.applyMatrix,insertItems=settings.insertItems;settings.applyMatrix=false;settings.insertItems=false;var importer=importers[type],item=importer&&importer(node,type,options,isRoot)||null;settings.insertItems=insertItems;settings.applyMatrix=applyMatrix;if(item){if(isElement&&!(item instanceof Group))item=applyAttributes(item,node,isRoot);var onImport=options.onImport,data=isElement&&node.getAttribute('data-paper-data');if(onImport)item=onImport(node,item,options)||item;if(options.expandShapes&&item instanceof Shape){item.remove();item=item.toPath();}if(data)item._data=JSON.parse(data);}if(container){body.removeChild(container);if(parent){if(next){parent.insertBefore(node,next);}else{parent.appendChild(node);}}}if(isRoot){definitions={};if(item&&Base.pick(options.applyMatrix,applyMatrix))item.matrix.apply(true,true);}return item;}function importSVG(source,options,owner){if(!source)return null;options=typeof options==='function'?{onLoad:options}:options||{};var scope=paper,item=null;function onLoad(svg){try{var node=typeof svg==='object'?svg:new self.DOMParser().parseFromString(svg,'image/svg+xml');if(!node.nodeName){node=null;throw new Error('Unsupported SVG source: '+source);}paper=scope;item=importNode(node,options,true);if(!options||options.insert!==false){owner._insertItem(undefined,item);}var onLoad=options.onLoad;if(onLoad)onLoad(item,svg);}catch(e){onError(e);}}function onError(message,status){var onError=options.onError;if(onError){onError(message,status);}else{throw new Error(message);}}if(typeof source==='string'&&!/^.*</.test(source)){var node=document.getElementById(source);if(node){onLoad(node);}else{Http.request({url:source,async:true,onLoad:onLoad,onError:onError});}}else if(typeof File!=='undefined'&&source instanceof File){var reader=new FileReader();reader.onload=function(){onLoad(reader.result);};reader.onerror=function(){onError(reader.error);};return reader.readAsText(source);}else{onLoad(source);}return item;}Item.inject({importSVG:function(node,options){return importSVG(node,options,this);}});Project.inject({importSVG:function(node,options){this.activate();return importSVG(node,options,this);}});}();paper=new(PaperScope.inject(Base.exports,{Base:Base,Numerical:Numerical,Key:Key,DomEvent:DomEvent,DomElement:DomElement,document:document,window:window,Symbol:SymbolDefinition,PlacedSymbol:SymbolItem}))();if(paper.agent.node){require('./node/extend.js')(paper);}if(typeof define==='function'&&define.amd){define('paper',paper);}else if(typeof module==='object'&&module){module.exports=paper;}return paper;}.call(this,typeof self==='object'?self:null);/* Web Font Loader v1.6.28 - (c) Adobe Systems, Google. License: Apache 2.0 */(function(){function aa(a,b,c){return a.call.apply(a.bind,arguments);}function ba(a,b,c){if(!a)throw Error();if(2<arguments.length){var d=Array.prototype.slice.call(arguments,2);return function(){var c=Array.prototype.slice.call(arguments);Array.prototype.unshift.apply(c,d);return a.apply(b,c);};}return function(){return a.apply(b,arguments);};}function p(a,b,c){p=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?aa:ba;return p.apply(null,arguments);}var q=Date.now||function(){return+new Date();};function ca(a,b){this.a=a;this.o=b||a;this.c=this.o.document;}var da=!!window.FontFace;function t(a,b,c,d){b=a.c.createElement(b);if(c)for(var e in c)c.hasOwnProperty(e)&&("style"==e?b.style.cssText=c[e]:b.setAttribute(e,c[e]));d&&b.appendChild(a.c.createTextNode(d));return b;}function u(a,b,c){a=a.c.getElementsByTagName(b)[0];a||(a=document.documentElement);a.insertBefore(c,a.lastChild);}function v(a){a.parentNode&&a.parentNode.removeChild(a);}function w(a,b,c){b=b||[];c=c||[];for(var d=a.className.split(/\s+/),e=0;e<b.length;e+=1){for(var f=!1,g=0;g<d.length;g+=1)if(b[e]===d[g]){f=!0;break;}f||d.push(b[e]);}b=[];for(e=0;e<d.length;e+=1){f=!1;for(g=0;g<c.length;g+=1)if(d[e]===c[g]){f=!0;break;}f||b.push(d[e]);}a.className=b.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"");}function y(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;d<e;d++)if(c[d]==b)return!0;return!1;}function ea(a){return a.o.location.hostname||a.a.location.hostname;}function z(a,b,c){function d(){m&&e&&f&&(m(g),m=null);}b=t(a,"link",{rel:"stylesheet",href:b,media:"all"});var e=!1,f=!0,g=null,m=c||null;da?(b.onload=function(){e=!0;d();},b.onerror=function(){e=!0;g=Error("Stylesheet failed to load");d();}):setTimeout(function(){e=!0;d();},0);u(a,"head",b);}function A(a,b,c,d){var e=a.c.getElementsByTagName("head")[0];if(e){var f=t(a,"script",{src:b}),g=!1;f.onload=f.onreadystatechange=function(){g||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(g=!0,c&&c(null),f.onload=f.onreadystatechange=null,"HEAD"==f.parentNode.tagName&&e.removeChild(f));};e.appendChild(f);setTimeout(function(){g||(g=!0,c&&c(Error("Script load timeout")));},d||5E3);return f;}return null;};function B(){this.a=0;this.c=null;}function C(a){a.a++;return function(){a.a--;D(a);};}function E(a,b){a.c=b;D(a);}function D(a){0==a.a&&a.c&&(a.c(),a.c=null);};function F(a){this.a=a||"-";}F.prototype.c=function(a){for(var b=[],c=0;c<arguments.length;c++)b.push(arguments[c].replace(/[\W_]+/g,"").toLowerCase());return b.join(this.a);};function G(a,b){this.c=a;this.f=4;this.a="n";var c=(b||"n4").match(/^([nio])([1-9])$/i);c&&(this.a=c[1],this.f=parseInt(c[2],10));}function fa(a){var result=H(a)+" "+(a.f+"00")+" 300px "+I(a.c);//console.log(result);
return result;}function I(a){var b=[];a=a.split(/,\s*/);for(var c=0;c<a.length;c++){var d=a[c].replace(/["]/g,"");-1!=d.indexOf(" ")||/^\d/.test(d)?b.push("\""+d+"\""):b.push(d);}return b.join(",");}function J(a){return a.a+a.f;}function H(a){var b="normal";"o"===a.a?b="oblique":"i"===a.a&&(b="italic");return b;}function ga(a){var b=4,c="n",d=null;a&&((d=a.match(/(normal|oblique|italic)/i))&&d[1]&&(c=d[1].substr(0,1).toLowerCase()),(d=a.match(/([1-9]00|normal|bold)/i))&&d[1]&&(/bold/i.test(d[1])?b=7:/[1-9]00/.test(d[1])&&(b=parseInt(d[1].substr(0,1),10))));return c+b;};function ha(a,b){this.c=a;this.f=a.o.document.documentElement;this.h=b;this.a=new F("-");this.j=!1!==b.events;this.g=!1!==b.classes;}function ia(a){a.g&&w(a.f,[a.a.c("wf","loading")]);K(a,"loading");}function L(a){if(a.g){var b=y(a.f,a.a.c("wf","active")),c=[],d=[a.a.c("wf","loading")];b||c.push(a.a.c("wf","inactive"));w(a.f,c,d);}K(a,"inactive");}function K(a,b,c){if(a.j&&a.h[b])if(c)a.h[b](c.c,J(c));else a.h[b]();};function ja(){this.c={};}function ka(a,b,c){var d=[],e;for(e in b)if(b.hasOwnProperty(e)){var f=a.c[e];f&&d.push(f(b[e],c));}return d;};function M(a,b){this.c=a;this.f=b;this.a=t(this.c,"span",{"aria-hidden":"true"},this.f);}function N(a){u(a.c,"body",a.a);}function O(a){return"display:block;position:absolute;top:-9999px;left:-9999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+I(a.c)+";"+("font-style:"+H(a)+";font-weight:"+(a.f+"00")+";");};function P(a,b,c,d,e,f){this.g=a;this.j=b;this.a=d;this.c=c;this.f=e||3E3;this.h=f||void 0;}P.prototype.start=function(){var a=this.c.o.document,b=this,c=q(),d=new Promise(function(d,e){function f(){q()-c>=b.f?e():a.fonts.load(fa(b.a),b.h).then(function(a){1<=a.length?d():setTimeout(f,25);},function(){e();});}f();}),e=null,f=new Promise(function(a,d){e=setTimeout(d,b.f);});Promise.race([f,d]).then(function(){e&&(clearTimeout(e),e=null);b.g(b.a);},function(){b.j(b.a);});};function Q(a,b,c,d,e,f,g){this.v=a;this.B=b;this.c=c;this.a=d;this.s=g||"BESbswy";this.f={};this.w=e||3E3;this.u=f||null;this.m=this.j=this.h=this.g=null;this.g=new M(this.c,this.s);this.h=new M(this.c,this.s);this.j=new M(this.c,this.s);this.m=new M(this.c,this.s);a=new G(this.a.c+",serif",J(this.a));a=O(a);this.g.a.style.cssText=a;a=new G(this.a.c+",sans-serif",J(this.a));a=O(a);this.h.a.style.cssText=a;a=new G("serif",J(this.a));a=O(a);this.j.a.style.cssText=a;a=new G("sans-serif",J(this.a));a=O(a);this.m.a.style.cssText=a;N(this.g);N(this.h);N(this.j);N(this.m);}var R={D:"serif",C:"sans-serif"},S=null;function T(){if(null===S){var a=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent);S=!!a&&(536>parseInt(a[1],10)||536===parseInt(a[1],10)&&11>=parseInt(a[2],10));}return S;}Q.prototype.start=function(){this.f.serif=this.j.a.offsetWidth;this.f["sans-serif"]=this.m.a.offsetWidth;this.A=q();U(this);};function la(a,b,c){for(var d in R)if(R.hasOwnProperty(d)&&b===a.f[R[d]]&&c===a.f[R[d]])return!0;return!1;}function U(a){var b=a.g.a.offsetWidth,c=a.h.a.offsetWidth,d;(d=b===a.f.serif&&c===a.f["sans-serif"])||(d=T()&&la(a,b,c));d?q()-a.A>=a.w?T()&&la(a,b,c)&&(null===a.u||a.u.hasOwnProperty(a.a.c))?V(a,a.v):V(a,a.B):ma(a):V(a,a.v);}function ma(a){setTimeout(p(function(){U(this);},a),50);}function V(a,b){setTimeout(p(function(){v(this.g.a);v(this.h.a);v(this.j.a);v(this.m.a);b(this.a);},a),0);};function W(a,b,c){this.c=a;this.a=b;this.f=0;this.m=this.j=!1;this.s=c;}var X=null;W.prototype.g=function(a){var b=this.a;b.g&&w(b.f,[b.a.c("wf",a.c,J(a).toString(),"active")],[b.a.c("wf",a.c,J(a).toString(),"loading"),b.a.c("wf",a.c,J(a).toString(),"inactive")]);K(b,"fontactive",a);this.m=!0;na(this);};W.prototype.h=function(a){var b=this.a;if(b.g){var c=y(b.f,b.a.c("wf",a.c,J(a).toString(),"active")),d=[],e=[b.a.c("wf",a.c,J(a).toString(),"loading")];c||d.push(b.a.c("wf",a.c,J(a).toString(),"inactive"));w(b.f,d,e);}K(b,"fontinactive",a);na(this);};function na(a){0==--a.f&&a.j&&(a.m?(a=a.a,a.g&&w(a.f,[a.a.c("wf","active")],[a.a.c("wf","loading"),a.a.c("wf","inactive")]),K(a,"active")):L(a.a));};function oa(a){this.j=a;this.a=new ja();this.h=0;this.f=this.g=!0;}oa.prototype.load=function(a){this.c=new ca(this.j,a.context||this.j);this.g=!1!==a.events;this.f=!1!==a.classes;pa(this,new ha(this.c,a),a);};function qa(a,b,c,d,e){var f=0==--a.h;(a.f||a.g)&&setTimeout(function(){var a=e||null,m=d||null||{};if(0===c.length&&f)L(b.a);else{b.f+=c.length;f&&(b.j=f);var h,l=[];for(h=0;h<c.length;h++){var k=c[h],n=m[k.c],r=b.a,x=k;r.g&&w(r.f,[r.a.c("wf",x.c,J(x).toString(),"loading")]);K(r,"fontloading",x);r=null;if(null===X)if(window.FontFace){var x=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),xa=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);X=x?42<parseInt(x[1],10):xa?!1:!0;}else X=!1;X?r=new P(p(b.g,b),p(b.h,b),b.c,k,b.s,n):r=new Q(p(b.g,b),p(b.h,b),b.c,k,b.s,a,n);l.push(r);}for(h=0;h<l.length;h++)l[h].start();}},0);}function pa(a,b,c){var d=[],e=c.timeout;ia(b);var d=ka(a.a,c,a.c),f=new W(a.c,b,e);a.h=d.length;b=0;for(c=d.length;b<c;b++)d[b].load(function(b,d,c){qa(a,f,b,d,c);});};function ra(a,b){this.c=a;this.a=b;}ra.prototype.load=function(a){function b(){if(f["__mti_fntLst"+d]){var c=f["__mti_fntLst"+d](),e=[],h;if(c)for(var l=0;l<c.length;l++){var k=c[l].fontfamily;void 0!=c[l].fontStyle&&void 0!=c[l].fontWeight?(h=c[l].fontStyle+c[l].fontWeight,e.push(new G(k,h))):e.push(new G(k));}a(e);}else setTimeout(function(){b();},50);}var c=this,d=c.a.projectId,e=c.a.version;if(d){var f=c.c.o;A(this.c,(c.a.api||"https://fast.fonts.net/jsapi")+"/"+d+".js"+(e?"?v="+e:""),function(e){e?a([]):(f["__MonotypeConfiguration__"+d]=function(){return c.a;},b());}).id="__MonotypeAPIScript__"+d;}else a([]);};function sa(a,b){this.c=a;this.a=b;}sa.prototype.load=function(a){var b,c,d=this.a.urls||[],e=this.a.families||[],f=this.a.testStrings||{},g=new B();b=0;for(c=d.length;b<c;b++)z(this.c,d[b],C(g));var m=[];b=0;for(c=e.length;b<c;b++)if(d=e[b].split(":"),d[1])for(var h=d[1].split(","),l=0;l<h.length;l+=1)m.push(new G(d[0],h[l]));else m.push(new G(d[0]));E(g,function(){a(m,f);});};function ta(a,b){a?this.c=a:this.c=ua;this.a=[];this.f=[];this.g=b||"";}var ua="https://fonts.googleapis.com/css";function va(a,b){for(var c=b.length,d=0;d<c;d++){var e=b[d].split(":");3==e.length&&a.f.push(e.pop());var f="";2==e.length&&""!=e[1]&&(f=":");a.a.push(e.join(f));}}function wa(a){if(0==a.a.length)throw Error("No fonts to load!");if(-1!=a.c.indexOf("kit="))return a.c;for(var b=a.a.length,c=[],d=0;d<b;d++)c.push(a.a[d].replace(/ /g,"+"));b=a.c+"?family="+c.join("%7C");0<a.f.length&&(b+="&subset="+a.f.join(","));0<a.g.length&&(b+="&text="+encodeURIComponent(a.g));return b;};function ya(a){this.f=a;this.a=[];this.c={};}var za={latin:"BESbswy","latin-ext":"\u00e7\u00f6\u00fc\u011f\u015f",cyrillic:"\u0439\u044f\u0416",greek:"\u03b1\u03b2\u03a3",khmer:"\u1780\u1781\u1782",Hanuman:"\u1780\u1781\u1782"},Aa={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},Ba={i:"i",italic:"i",n:"n",normal:"n"},Ca=/^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$/;function Da(a){for(var b=a.f.length,c=0;c<b;c++){var d=a.f[c].split(":"),e=d[0].replace(/\+/g," "),f=["n4"];if(2<=d.length){var g;var m=d[1];g=[];if(m)for(var m=m.split(","),h=m.length,l=0;l<h;l++){var k;k=m[l];if(k.match(/^[\w-]+$/)){var n=Ca.exec(k.toLowerCase());if(null==n)k="";else{k=n[2];k=null==k||""==k?"n":Ba[k];n=n[1];if(null==n||""==n)n="4";else var r=Aa[n],n=r?r:isNaN(n)?"4":n.substr(0,1);k=[k,n].join("");}}else k="";k&&g.push(k);}0<g.length&&(f=g);3==d.length&&(d=d[2],g=[],d=d?d.split(","):g,0<d.length&&(d=za[d[0]])&&(a.c[e]=d));}a.c[e]||(d=za[e])&&(a.c[e]=d);for(d=0;d<f.length;d+=1)a.a.push(new G(e,f[d]));}};function Ea(a,b){this.c=a;this.a=b;}var Fa={Arimo:!0,Cousine:!0,Tinos:!0};Ea.prototype.load=function(a){var b=new B(),c=this.c,d=new ta(this.a.api,this.a.text),e=this.a.families;va(d,e);var f=new ya(e);Da(f);z(c,wa(d),C(b));E(b,function(){a(f.a,f.c,Fa);});};function Ga(a,b){this.c=a;this.a=b;}Ga.prototype.load=function(a){var b=this.a.id,c=this.c.o;b?A(this.c,(this.a.api||"https://use.typekit.net")+"/"+b+".js",function(b){if(b)a([]);else if(c.Typekit&&c.Typekit.config&&c.Typekit.config.fn){b=c.Typekit.config.fn;for(var e=[],f=0;f<b.length;f+=2)for(var g=b[f],m=b[f+1],h=0;h<m.length;h++)e.push(new G(g,m[h]));try{c.Typekit.load({events:!1,classes:!1,async:!0});}catch(l){}a(e);}},2E3):a([]);};function Ha(a,b){this.c=a;this.f=b;this.a=[];}Ha.prototype.load=function(a){var b=this.f.id,c=this.c.o,d=this;b?(c.__webfontfontdeckmodule__||(c.__webfontfontdeckmodule__={}),c.__webfontfontdeckmodule__[b]=function(b,c){for(var g=0,m=c.fonts.length;g<m;++g){var h=c.fonts[g];d.a.push(new G(h.name,ga("font-weight:"+h.weight+";font-style:"+h.style)));}a(d.a);},A(this.c,(this.f.api||"https://f.fontdeck.com/s/css/js/")+ea(this.c)+"/"+b+".js",function(b){b&&a([]);})):a([]);};var Y=new oa(window);Y.a.c.custom=function(a,b){return new sa(b,a);};Y.a.c.fontdeck=function(a,b){return new Ha(b,a);};Y.a.c.monotype=function(a,b){return new ra(b,a);};Y.a.c.typekit=function(a,b){return new Ga(b,a);};Y.a.c.google=function(a,b){return new Ea(b,a);};var Z={load:p(Y.load,Y)};"function"===typeof define&&define.amd?define(function(){return Z;}):"undefined"!==typeof module&&module.exports?module.exports=Z:(window.WebFont=Z,window.WebFontConfig&&Y.load(window.WebFontConfig));})();// Copyright (c) 2013 Pieroxy <pieroxy@pieroxy.net>
// This work is free. You can redistribute it and/or modify it
// under the terms of the WTFPL, Version 2
// For more information see LICENSE.txt or http://www.wtfpl.net/
//
// For more information, the home page:
// http://pieroxy.net/blog/pages/lz-string/testing.html
//
// LZ-based compression algorithm, version 1.4.4
var LZString=function(){// private property
var f=String.fromCharCode;var keyStrBase64="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var keyStrUriSafe="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";var baseReverseDic={};function getBaseValue(alphabet,character){if(!baseReverseDic[alphabet]){baseReverseDic[alphabet]={};for(var i=0;i<alphabet.length;i++){baseReverseDic[alphabet][alphabet.charAt(i)]=i;}}return baseReverseDic[alphabet][character];}var LZString={compressToBase64:function(input){if(input==null)return"";var res=LZString._compress(input,6,function(a){return keyStrBase64.charAt(a);});switch(res.length%4){// To produce valid Base64
default:// When could this happen ?
case 0:return res;case 1:return res+"===";case 2:return res+"==";case 3:return res+"=";}},decompressFromBase64:function(input){if(input==null)return"";if(input=="")return null;return LZString._decompress(input.length,32,function(index){return getBaseValue(keyStrBase64,input.charAt(index));});},compressToUTF16:function(input){if(input==null)return"";return LZString._compress(input,15,function(a){return f(a+32);})+" ";},decompressFromUTF16:function(compressed){if(compressed==null)return"";if(compressed=="")return null;return LZString._decompress(compressed.length,16384,function(index){return compressed.charCodeAt(index)-32;});},//compress into uint8array (UCS-2 big endian format)
compressToUint8Array:function(uncompressed){var compressed=LZString.compress(uncompressed);var buf=new Uint8Array(compressed.length*2);// 2 bytes per character
for(var i=0,TotalLen=compressed.length;i<TotalLen;i++){var current_value=compressed.charCodeAt(i);buf[i*2]=current_value>>>8;buf[i*2+1]=current_value%256;}return buf;},//decompress from uint8array (UCS-2 big endian format)
decompressFromUint8Array:function(compressed){if(compressed===null||compressed===undefined){return LZString.decompress(compressed);}else{var buf=new Array(compressed.length/2);// 2 bytes per character
for(var i=0,TotalLen=buf.length;i<TotalLen;i++){buf[i]=compressed[i*2]*256+compressed[i*2+1];}var result=[];buf.forEach(function(c){result.push(f(c));});return LZString.decompress(result.join(''));}},//compress into a string that is already URI encoded
compressToEncodedURIComponent:function(input){if(input==null)return"";return LZString._compress(input,6,function(a){return keyStrUriSafe.charAt(a);});},//decompress from an output of compressToEncodedURIComponent
decompressFromEncodedURIComponent:function(input){if(input==null)return"";if(input=="")return null;input=input.replace(/ /g,"+");return LZString._decompress(input.length,32,function(index){return getBaseValue(keyStrUriSafe,input.charAt(index));});},compress:function(uncompressed){return LZString._compress(uncompressed,16,function(a){return f(a);});},_compress:function(uncompressed,bitsPerChar,getCharFromInt){if(uncompressed==null)return"";var i,value,context_dictionary={},context_dictionaryToCreate={},context_c="",context_wc="",context_w="",context_enlargeIn=2,// Compensate for the first entry which should not count
context_dictSize=3,context_numBits=2,context_data=[],context_data_val=0,context_data_position=0,ii;for(ii=0;ii<uncompressed.length;ii+=1){context_c=uncompressed.charAt(ii);if(!Object.prototype.hasOwnProperty.call(context_dictionary,context_c)){context_dictionary[context_c]=context_dictSize++;context_dictionaryToCreate[context_c]=true;}context_wc=context_w+context_c;if(Object.prototype.hasOwnProperty.call(context_dictionary,context_wc)){context_w=context_wc;}else{if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=0;}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}delete context_dictionaryToCreate[context_w];}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}// Add wc to the dictionary.
context_dictionary[context_wc]=context_dictSize++;context_w=String(context_c);}}// Output the code for w.
if(context_w!==""){if(Object.prototype.hasOwnProperty.call(context_dictionaryToCreate,context_w)){if(context_w.charCodeAt(0)<256){for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}}value=context_w.charCodeAt(0);for(i=0;i<8;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}else{value=1;for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=0;}value=context_w.charCodeAt(0);for(i=0;i<16;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}delete context_dictionaryToCreate[context_w];}else{value=context_dictionary[context_w];for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}}context_enlargeIn--;if(context_enlargeIn==0){context_enlargeIn=Math.pow(2,context_numBits);context_numBits++;}}// Mark the end of the stream
value=2;for(i=0;i<context_numBits;i++){context_data_val=context_data_val<<1|value&1;if(context_data_position==bitsPerChar-1){context_data_position=0;context_data.push(getCharFromInt(context_data_val));context_data_val=0;}else{context_data_position++;}value=value>>1;}// Flush the last char
while(true){context_data_val=context_data_val<<1;if(context_data_position==bitsPerChar-1){context_data.push(getCharFromInt(context_data_val));break;}else context_data_position++;}return context_data.join('');},decompress:function(compressed){if(compressed==null)return"";if(compressed=="")return null;return LZString._decompress(compressed.length,32768,function(index){return compressed.charCodeAt(index);});},_decompress:function(length,resetValue,getNextValue){var dictionary=[],next,enlargeIn=4,dictSize=4,numBits=3,entry="",result=[],i,w,bits,resb,maxpower,power,c,data={val:getNextValue(0),position:resetValue,index:1};for(i=0;i<3;i+=1){dictionary[i]=i;}bits=0;maxpower=Math.pow(2,2);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}switch(next=bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}c=f(bits);break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}c=f(bits);break;case 2:return"";}dictionary[3]=c;w=c;result.push(c);while(true){if(data.index>length){return"";}bits=0;maxpower=Math.pow(2,numBits);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}switch(c=bits){case 0:bits=0;maxpower=Math.pow(2,8);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}dictionary[dictSize++]=f(bits);c=dictSize-1;enlargeIn--;break;case 1:bits=0;maxpower=Math.pow(2,16);power=1;while(power!=maxpower){resb=data.val&data.position;data.position>>=1;if(data.position==0){data.position=resetValue;data.val=getNextValue(data.index++);}bits|=(resb>0?1:0)*power;power<<=1;}dictionary[dictSize++]=f(bits);c=dictSize-1;enlargeIn--;break;case 2:return result.join('');}if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++;}if(dictionary[c]){entry=dictionary[c];}else{if(c===dictSize){entry=w+w.charAt(0);}else{return null;}}result.push(entry);// Add w+entry[0] to the dictionary.
dictionary[dictSize++]=w+entry.charAt(0);enlargeIn--;w=entry;if(enlargeIn==0){enlargeIn=Math.pow(2,numBits);numBits++;}}}};return LZString;}();if(typeof define==='function'&&define.amd){define(function(){return LZString;});}else if(typeof module!=='undefined'&&module!=null){module.exports=LZString;}else if(typeof angular!=='undefined'&&angular!=null){angular.module('LZString',[]).factory('LZString',function(){return LZString;});}/*!

JSZip v3.2.1 - A JavaScript class for generating and reading zip files
<http://stuartk.com/jszip>

(c) 2009-2016 Stuart Knightley <stuart [at] stuartk.com>
Dual licenced under the MIT license or GPLv3. See https://raw.github.com/Stuk/jszip/master/LICENSE.markdown.

JSZip uses the library pako released under the MIT license :
https://github.com/nodeca/pako/blob/master/LICENSE
*/!function(t){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).JSZip=t();}}(function(){return function s(a,o,h){function u(r,t){if(!o[r]){if(!a[r]){var e="function"==typeof require&&require;if(!t&&e)return e(r,!0);if(l)return l(r,!0);var i=new Error("Cannot find module '"+r+"'");throw i.code="MODULE_NOT_FOUND",i;}var n=o[r]={exports:{}};a[r][0].call(n.exports,function(t){var e=a[r][1][t];return u(e||t);},n,n.exports,s,a,o,h);}return o[r].exports;}for(var l="function"==typeof require&&require,t=0;t<h.length;t++)u(h[t]);return u;}({1:[function(t,e,r){"use strict";var c=t("./utils"),d=t("./support"),p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";r.encode=function(t){for(var e,r,i,n,s,a,o,h=[],u=0,l=t.length,f=l,d="string"!==c.getTypeOf(t);u<t.length;)f=l-u,i=d?(e=t[u++],r=u<l?t[u++]:0,u<l?t[u++]:0):(e=t.charCodeAt(u++),r=u<l?t.charCodeAt(u++):0,u<l?t.charCodeAt(u++):0),n=e>>2,s=(3&e)<<4|r>>4,a=1<f?(15&r)<<2|i>>6:64,o=2<f?63&i:64,h.push(p.charAt(n)+p.charAt(s)+p.charAt(a)+p.charAt(o));return h.join("");},r.decode=function(t){var e,r,i,n,s,a,o=0,h=0,u="data:";if(t.substr(0,u.length)===u)throw new Error("Invalid base64 input, it looks like a data url.");var l,f=3*(t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"")).length/4;if(t.charAt(t.length-1)===p.charAt(64)&&f--,t.charAt(t.length-2)===p.charAt(64)&&f--,f%1!=0)throw new Error("Invalid base64 input, bad content length.");for(l=d.uint8array?new Uint8Array(0|f):new Array(0|f);o<t.length;)e=p.indexOf(t.charAt(o++))<<2|(n=p.indexOf(t.charAt(o++)))>>4,r=(15&n)<<4|(s=p.indexOf(t.charAt(o++)))>>2,i=(3&s)<<6|(a=p.indexOf(t.charAt(o++))),l[h++]=e,64!==s&&(l[h++]=r),64!==a&&(l[h++]=i);return l;};},{"./support":30,"./utils":32}],2:[function(t,e,r){"use strict";var i=t("./external"),n=t("./stream/DataWorker"),s=t("./stream/DataLengthProbe"),a=t("./stream/Crc32Probe");s=t("./stream/DataLengthProbe");function o(t,e,r,i,n){this.compressedSize=t,this.uncompressedSize=e,this.crc32=r,this.compression=i,this.compressedContent=n;}o.prototype={getContentWorker:function(){var t=new n(i.Promise.resolve(this.compressedContent)).pipe(this.compression.uncompressWorker()).pipe(new s("data_length")),e=this;return t.on("end",function(){if(this.streamInfo.data_length!==e.uncompressedSize)throw new Error("Bug : uncompressed data size mismatch");}),t;},getCompressedWorker:function(){return new n(i.Promise.resolve(this.compressedContent)).withStreamInfo("compressedSize",this.compressedSize).withStreamInfo("uncompressedSize",this.uncompressedSize).withStreamInfo("crc32",this.crc32).withStreamInfo("compression",this.compression);}},o.createWorkerFrom=function(t,e,r){return t.pipe(new a()).pipe(new s("uncompressedSize")).pipe(e.compressWorker(r)).pipe(new s("compressedSize")).withStreamInfo("compression",e);},e.exports=o;},{"./external":6,"./stream/Crc32Probe":25,"./stream/DataLengthProbe":26,"./stream/DataWorker":27}],3:[function(t,e,r){"use strict";var i=t("./stream/GenericWorker");r.STORE={magic:"\0\0",compressWorker:function(t){return new i("STORE compression");},uncompressWorker:function(){return new i("STORE decompression");}},r.DEFLATE=t("./flate");},{"./flate":7,"./stream/GenericWorker":28}],4:[function(t,e,r){"use strict";var i=t("./utils");var o=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t;}return e;}();e.exports=function(t,e){return void 0!==t&&t.length?"string"!==i.getTypeOf(t)?function(t,e,r,i){var n=o,s=i+r;t^=-1;for(var a=i;a<s;a++)t=t>>>8^n[255&(t^e[a])];return-1^t;}(0|e,t,t.length,0):function(t,e,r,i){var n=o,s=i+r;t^=-1;for(var a=i;a<s;a++)t=t>>>8^n[255&(t^e.charCodeAt(a))];return-1^t;}(0|e,t,t.length,0):0;};},{"./utils":32}],5:[function(t,e,r){"use strict";r.base64=!1,r.binary=!1,r.dir=!1,r.createFolders=!0,r.date=null,r.compression=null,r.compressionOptions=null,r.comment=null,r.unixPermissions=null,r.dosPermissions=null;},{}],6:[function(t,e,r){"use strict";var i=null;i="undefined"!=typeof Promise?Promise:t("lie"),e.exports={Promise:i};},{lie:37}],7:[function(t,e,r){"use strict";var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Uint32Array,n=t("pako"),s=t("./utils"),a=t("./stream/GenericWorker"),o=i?"uint8array":"array";function h(t,e){a.call(this,"FlateWorker/"+t),this._pako=null,this._pakoAction=t,this._pakoOptions=e,this.meta={};}r.magic="\b\0",s.inherits(h,a),h.prototype.processChunk=function(t){this.meta=t.meta,null===this._pako&&this._createPako(),this._pako.push(s.transformTo(o,t.data),!1);},h.prototype.flush=function(){a.prototype.flush.call(this),null===this._pako&&this._createPako(),this._pako.push([],!0);},h.prototype.cleanUp=function(){a.prototype.cleanUp.call(this),this._pako=null;},h.prototype._createPako=function(){this._pako=new n[this._pakoAction]({raw:!0,level:this._pakoOptions.level||-1});var e=this;this._pako.onData=function(t){e.push({data:t,meta:e.meta});};},r.compressWorker=function(t){return new h("Deflate",t);},r.uncompressWorker=function(){return new h("Inflate",{});};},{"./stream/GenericWorker":28,"./utils":32,pako:38}],8:[function(t,e,r){"use strict";function A(t,e){var r,i="";for(r=0;r<e;r++)i+=String.fromCharCode(255&t),t>>>=8;return i;}function i(t,e,r,i,n,s){var a,o,h=t.file,u=t.compression,l=s!==O.utf8encode,f=I.transformTo("string",s(h.name)),d=I.transformTo("string",O.utf8encode(h.name)),c=h.comment,p=I.transformTo("string",s(c)),m=I.transformTo("string",O.utf8encode(c)),_=d.length!==h.name.length,g=m.length!==c.length,b="",v="",y="",w=h.dir,k=h.date,x={crc32:0,compressedSize:0,uncompressedSize:0};e&&!r||(x.crc32=t.crc32,x.compressedSize=t.compressedSize,x.uncompressedSize=t.uncompressedSize);var S=0;e&&(S|=8),l||!_&&!g||(S|=2048);var z=0,C=0;w&&(z|=16),"UNIX"===n?(C=798,z|=function(t,e){var r=t;return t||(r=e?16893:33204),(65535&r)<<16;}(h.unixPermissions,w)):(C=20,z|=function(t){return 63&(t||0);}(h.dosPermissions)),a=k.getUTCHours(),a<<=6,a|=k.getUTCMinutes(),a<<=5,a|=k.getUTCSeconds()/2,o=k.getUTCFullYear()-1980,o<<=4,o|=k.getUTCMonth()+1,o<<=5,o|=k.getUTCDate(),_&&(v=A(1,1)+A(B(f),4)+d,b+="up"+A(v.length,2)+v),g&&(y=A(1,1)+A(B(p),4)+m,b+="uc"+A(y.length,2)+y);var E="";return E+="\n\0",E+=A(S,2),E+=u.magic,E+=A(a,2),E+=A(o,2),E+=A(x.crc32,4),E+=A(x.compressedSize,4),E+=A(x.uncompressedSize,4),E+=A(f.length,2),E+=A(b.length,2),{fileRecord:R.LOCAL_FILE_HEADER+E+f+b,dirRecord:R.CENTRAL_FILE_HEADER+A(C,2)+E+A(p.length,2)+"\0\0\0\0"+A(z,4)+A(i,4)+f+b+p};}var I=t("../utils"),n=t("../stream/GenericWorker"),O=t("../utf8"),B=t("../crc32"),R=t("../signature");function s(t,e,r,i){n.call(this,"ZipFileWorker"),this.bytesWritten=0,this.zipComment=e,this.zipPlatform=r,this.encodeFileName=i,this.streamFiles=t,this.accumulate=!1,this.contentBuffer=[],this.dirRecords=[],this.currentSourceOffset=0,this.entriesCount=0,this.currentFile=null,this._sources=[];}I.inherits(s,n),s.prototype.push=function(t){var e=t.meta.percent||0,r=this.entriesCount,i=this._sources.length;this.accumulate?this.contentBuffer.push(t):(this.bytesWritten+=t.data.length,n.prototype.push.call(this,{data:t.data,meta:{currentFile:this.currentFile,percent:r?(e+100*(r-i-1))/r:100}}));},s.prototype.openedSource=function(t){this.currentSourceOffset=this.bytesWritten,this.currentFile=t.file.name;var e=this.streamFiles&&!t.file.dir;if(e){var r=i(t,e,!1,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);this.push({data:r.fileRecord,meta:{percent:0}});}else this.accumulate=!0;},s.prototype.closedSource=function(t){this.accumulate=!1;var e=this.streamFiles&&!t.file.dir,r=i(t,e,!0,this.currentSourceOffset,this.zipPlatform,this.encodeFileName);if(this.dirRecords.push(r.dirRecord),e)this.push({data:function(t){return R.DATA_DESCRIPTOR+A(t.crc32,4)+A(t.compressedSize,4)+A(t.uncompressedSize,4);}(t),meta:{percent:100}});else for(this.push({data:r.fileRecord,meta:{percent:0}});this.contentBuffer.length;)this.push(this.contentBuffer.shift());this.currentFile=null;},s.prototype.flush=function(){for(var t=this.bytesWritten,e=0;e<this.dirRecords.length;e++)this.push({data:this.dirRecords[e],meta:{percent:100}});var r=this.bytesWritten-t,i=function(t,e,r,i,n){var s=I.transformTo("string",n(i));return R.CENTRAL_DIRECTORY_END+"\0\0\0\0"+A(t,2)+A(t,2)+A(e,4)+A(r,4)+A(s.length,2)+s;}(this.dirRecords.length,r,t,this.zipComment,this.encodeFileName);this.push({data:i,meta:{percent:100}});},s.prototype.prepareNextSource=function(){this.previous=this._sources.shift(),this.openedSource(this.previous.streamInfo),this.isPaused?this.previous.pause():this.previous.resume();},s.prototype.registerPrevious=function(t){this._sources.push(t);var e=this;return t.on("data",function(t){e.processChunk(t);}),t.on("end",function(){e.closedSource(e.previous.streamInfo),e._sources.length?e.prepareNextSource():e.end();}),t.on("error",function(t){e.error(t);}),this;},s.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this.previous&&this._sources.length?(this.prepareNextSource(),!0):this.previous||this._sources.length||this.generatedError?void 0:(this.end(),!0));},s.prototype.error=function(t){var e=this._sources;if(!n.prototype.error.call(this,t))return!1;for(var r=0;r<e.length;r++)try{e[r].error(t);}catch(t){}return!0;},s.prototype.lock=function(){n.prototype.lock.call(this);for(var t=this._sources,e=0;e<t.length;e++)t[e].lock();},e.exports=s;},{"../crc32":4,"../signature":23,"../stream/GenericWorker":28,"../utf8":31,"../utils":32}],9:[function(t,e,r){"use strict";var u=t("../compressions"),i=t("./ZipFileWorker");r.generateWorker=function(t,a,e){var o=new i(a.streamFiles,e,a.platform,a.encodeFileName),h=0;try{t.forEach(function(t,e){h++;var r=function(t,e){var r=t||e,i=u[r];if(!i)throw new Error(r+" is not a valid compression method !");return i;}(e.options.compression,a.compression),i=e.options.compressionOptions||a.compressionOptions||{},n=e.dir,s=e.date;e._compressWorker(r,i).withStreamInfo("file",{name:t,dir:n,date:s,comment:e.comment||"",unixPermissions:e.unixPermissions,dosPermissions:e.dosPermissions}).pipe(o);}),o.entriesCount=h;}catch(t){o.error(t);}return o;};},{"../compressions":3,"./ZipFileWorker":8}],10:[function(t,e,r){"use strict";function i(){if(!(this instanceof i))return new i();if(arguments.length)throw new Error("The constructor with parameters has been removed in JSZip 3.0, please check the upgrade guide.");this.files={},this.comment=null,this.root="",this.clone=function(){var t=new i();for(var e in this)"function"!=typeof this[e]&&(t[e]=this[e]);return t;};}(i.prototype=t("./object")).loadAsync=t("./load"),i.support=t("./support"),i.defaults=t("./defaults"),i.version="3.2.0",i.loadAsync=function(t,e){return new i().loadAsync(t,e);},i.external=t("./external"),e.exports=i;},{"./defaults":5,"./external":6,"./load":11,"./object":15,"./support":30}],11:[function(t,e,r){"use strict";var i=t("./utils"),n=t("./external"),o=t("./utf8"),h=(i=t("./utils"),t("./zipEntries")),s=t("./stream/Crc32Probe"),u=t("./nodejsUtils");function l(i){return new n.Promise(function(t,e){var r=i.decompressed.getContentWorker().pipe(new s());r.on("error",function(t){e(t);}).on("end",function(){r.streamInfo.crc32!==i.decompressed.crc32?e(new Error("Corrupted zip : CRC32 mismatch")):t();}).resume();});}e.exports=function(t,s){var a=this;return s=i.extend(s||{},{base64:!1,checkCRC32:!1,optimizedBinaryString:!1,createFolders:!1,decodeFileName:o.utf8decode}),u.isNode&&u.isStream(t)?n.Promise.reject(new Error("JSZip can't accept a stream when loading a zip file.")):i.prepareContent("the loaded zip file",t,!0,s.optimizedBinaryString,s.base64).then(function(t){var e=new h(s);return e.load(t),e;}).then(function(t){var e=[n.Promise.resolve(t)],r=t.files;if(s.checkCRC32)for(var i=0;i<r.length;i++)e.push(l(r[i]));return n.Promise.all(e);}).then(function(t){for(var e=t.shift(),r=e.files,i=0;i<r.length;i++){var n=r[i];a.file(n.fileNameStr,n.decompressed,{binary:!0,optimizedBinaryString:!0,date:n.date,dir:n.dir,comment:n.fileCommentStr.length?n.fileCommentStr:null,unixPermissions:n.unixPermissions,dosPermissions:n.dosPermissions,createFolders:s.createFolders});}return e.zipComment.length&&(a.comment=e.zipComment),a;});};},{"./external":6,"./nodejsUtils":14,"./stream/Crc32Probe":25,"./utf8":31,"./utils":32,"./zipEntries":33}],12:[function(t,e,r){"use strict";var i=t("../utils"),n=t("../stream/GenericWorker");function s(t,e){n.call(this,"Nodejs stream input adapter for "+t),this._upstreamEnded=!1,this._bindStream(e);}i.inherits(s,n),s.prototype._bindStream=function(t){var e=this;(this._stream=t).pause(),t.on("data",function(t){e.push({data:t,meta:{percent:0}});}).on("error",function(t){e.isPaused?this.generatedError=t:e.error(t);}).on("end",function(){e.isPaused?e._upstreamEnded=!0:e.end();});},s.prototype.pause=function(){return!!n.prototype.pause.call(this)&&(this._stream.pause(),!0);},s.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(this._upstreamEnded?this.end():this._stream.resume(),!0);},e.exports=s;},{"../stream/GenericWorker":28,"../utils":32}],13:[function(t,e,r){"use strict";var n=t("readable-stream").Readable;function i(t,e,r){n.call(this,e),this._helper=t;var i=this;t.on("data",function(t,e){i.push(t)||i._helper.pause(),r&&r(e);}).on("error",function(t){i.emit("error",t);}).on("end",function(){i.push(null);});}t("../utils").inherits(i,n),i.prototype._read=function(){this._helper.resume();},e.exports=i;},{"../utils":32,"readable-stream":16}],14:[function(t,e,r){"use strict";e.exports={isNode:"undefined"!=typeof Buffer,newBufferFrom:function(t,e){if(Buffer.from&&Buffer.from!==Uint8Array.from)return Buffer.from(t,e);if("number"==typeof t)throw new Error('The "data" argument must not be a number');return new Buffer(t,e);},allocBuffer:function(t){if(Buffer.alloc)return Buffer.alloc(t);var e=new Buffer(t);return e.fill(0),e;},isBuffer:function(t){return Buffer.isBuffer(t);},isStream:function(t){return t&&"function"==typeof t.on&&"function"==typeof t.pause&&"function"==typeof t.resume;}};},{}],15:[function(t,e,r){"use strict";function s(t,e,r){var i,n=u.getTypeOf(e),s=u.extend(r||{},f);s.date=s.date||new Date(),null!==s.compression&&(s.compression=s.compression.toUpperCase()),"string"==typeof s.unixPermissions&&(s.unixPermissions=parseInt(s.unixPermissions,8)),s.unixPermissions&&16384&s.unixPermissions&&(s.dir=!0),s.dosPermissions&&16&s.dosPermissions&&(s.dir=!0),s.dir&&(t=g(t)),s.createFolders&&(i=_(t))&&b.call(this,i,!0);var a="string"===n&&!1===s.binary&&!1===s.base64;r&&void 0!==r.binary||(s.binary=!a),(e instanceof d&&0===e.uncompressedSize||s.dir||!e||0===e.length)&&(s.base64=!1,s.binary=!0,e="",s.compression="STORE",n="string");var o=null;o=e instanceof d||e instanceof l?e:p.isNode&&p.isStream(e)?new m(t,e):u.prepareContent(t,e,s.binary,s.optimizedBinaryString,s.base64);var h=new c(t,o,s);this.files[t]=h;}var n=t("./utf8"),u=t("./utils"),l=t("./stream/GenericWorker"),a=t("./stream/StreamHelper"),f=t("./defaults"),d=t("./compressedObject"),c=t("./zipObject"),o=t("./generate"),p=t("./nodejsUtils"),m=t("./nodejs/NodejsStreamInputAdapter"),_=function(t){"/"===t.slice(-1)&&(t=t.substring(0,t.length-1));var e=t.lastIndexOf("/");return 0<e?t.substring(0,e):"";},g=function(t){return"/"!==t.slice(-1)&&(t+="/"),t;},b=function(t,e){return e=void 0!==e?e:f.createFolders,t=g(t),this.files[t]||s.call(this,t,null,{dir:!0,createFolders:e}),this.files[t];};function h(t){return"[object RegExp]"===Object.prototype.toString.call(t);}var i={load:function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.");},forEach:function(t){var e,r,i;for(e in this.files)this.files.hasOwnProperty(e)&&(i=this.files[e],(r=e.slice(this.root.length,e.length))&&e.slice(0,this.root.length)===this.root&&t(r,i));},filter:function(r){var i=[];return this.forEach(function(t,e){r(t,e)&&i.push(e);}),i;},file:function(t,e,r){if(1!==arguments.length)return t=this.root+t,s.call(this,t,e,r),this;if(h(t)){var i=t;return this.filter(function(t,e){return!e.dir&&i.test(t);});}var n=this.files[this.root+t];return n&&!n.dir?n:null;},folder:function(r){if(!r)return this;if(h(r))return this.filter(function(t,e){return e.dir&&r.test(t);});var t=this.root+r,e=b.call(this,t),i=this.clone();return i.root=e.name,i;},remove:function(r){r=this.root+r;var t=this.files[r];if(t||("/"!==r.slice(-1)&&(r+="/"),t=this.files[r]),t&&!t.dir)delete this.files[r];else for(var e=this.filter(function(t,e){return e.name.slice(0,r.length)===r;}),i=0;i<e.length;i++)delete this.files[e[i].name];return this;},generate:function(t){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.");},generateInternalStream:function(t){var e,r={};try{if((r=u.extend(t||{},{streamFiles:!1,compression:"STORE",compressionOptions:null,type:"",platform:"DOS",comment:null,mimeType:"application/zip",encodeFileName:n.utf8encode})).type=r.type.toLowerCase(),r.compression=r.compression.toUpperCase(),"binarystring"===r.type&&(r.type="string"),!r.type)throw new Error("No output type specified.");u.checkSupport(r.type),"darwin"!==r.platform&&"freebsd"!==r.platform&&"linux"!==r.platform&&"sunos"!==r.platform||(r.platform="UNIX"),"win32"===r.platform&&(r.platform="DOS");var i=r.comment||this.comment||"";e=o.generateWorker(this,r,i);}catch(t){(e=new l("error")).error(t);}return new a(e,r.type||"string",r.mimeType);},generateAsync:function(t,e){return this.generateInternalStream(t).accumulate(e);},generateNodeStream:function(t,e){return(t=t||{}).type||(t.type="nodebuffer"),this.generateInternalStream(t).toNodejsStream(e);}};e.exports=i;},{"./compressedObject":2,"./defaults":5,"./generate":9,"./nodejs/NodejsStreamInputAdapter":12,"./nodejsUtils":14,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31,"./utils":32,"./zipObject":35}],16:[function(t,e,r){e.exports=t("stream");},{stream:void 0}],17:[function(t,e,r){"use strict";var i=t("./DataReader");function n(t){i.call(this,t);for(var e=0;e<this.data.length;e++)t[e]=255&t[e];}t("../utils").inherits(n,i),n.prototype.byteAt=function(t){return this.data[this.zero+t];},n.prototype.lastIndexOfSignature=function(t){for(var e=t.charCodeAt(0),r=t.charCodeAt(1),i=t.charCodeAt(2),n=t.charCodeAt(3),s=this.length-4;0<=s;--s)if(this.data[s]===e&&this.data[s+1]===r&&this.data[s+2]===i&&this.data[s+3]===n)return s-this.zero;return-1;},n.prototype.readAndCheckSignature=function(t){var e=t.charCodeAt(0),r=t.charCodeAt(1),i=t.charCodeAt(2),n=t.charCodeAt(3),s=this.readData(4);return e===s[0]&&r===s[1]&&i===s[2]&&n===s[3];},n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return[];var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e;},e.exports=n;},{"../utils":32,"./DataReader":18}],18:[function(t,e,r){"use strict";var i=t("../utils");function n(t){this.data=t,this.length=t.length,this.index=0,this.zero=0;}n.prototype={checkOffset:function(t){this.checkIndex(this.index+t);},checkIndex:function(t){if(this.length<this.zero+t||t<0)throw new Error("End of data reached (data length = "+this.length+", asked index = "+t+"). Corrupted zip ?");},setIndex:function(t){this.checkIndex(t),this.index=t;},skip:function(t){this.setIndex(this.index+t);},byteAt:function(t){},readInt:function(t){var e,r=0;for(this.checkOffset(t),e=this.index+t-1;e>=this.index;e--)r=(r<<8)+this.byteAt(e);return this.index+=t,r;},readString:function(t){return i.transformTo("string",this.readData(t));},readData:function(t){},lastIndexOfSignature:function(t){},readAndCheckSignature:function(t){},readDate:function(){var t=this.readInt(4);return new Date(Date.UTC(1980+(t>>25&127),(t>>21&15)-1,t>>16&31,t>>11&31,t>>5&63,(31&t)<<1));}},e.exports=n;},{"../utils":32}],19:[function(t,e,r){"use strict";var i=t("./Uint8ArrayReader");function n(t){i.call(this,t);}t("../utils").inherits(n,i),n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e;},e.exports=n;},{"../utils":32,"./Uint8ArrayReader":21}],20:[function(t,e,r){"use strict";var i=t("./DataReader");function n(t){i.call(this,t);}t("../utils").inherits(n,i),n.prototype.byteAt=function(t){return this.data.charCodeAt(this.zero+t);},n.prototype.lastIndexOfSignature=function(t){return this.data.lastIndexOf(t)-this.zero;},n.prototype.readAndCheckSignature=function(t){return t===this.readData(4);},n.prototype.readData=function(t){this.checkOffset(t);var e=this.data.slice(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e;},e.exports=n;},{"../utils":32,"./DataReader":18}],21:[function(t,e,r){"use strict";var i=t("./ArrayReader");function n(t){i.call(this,t);}t("../utils").inherits(n,i),n.prototype.readData=function(t){if(this.checkOffset(t),0===t)return new Uint8Array(0);var e=this.data.subarray(this.zero+this.index,this.zero+this.index+t);return this.index+=t,e;},e.exports=n;},{"../utils":32,"./ArrayReader":17}],22:[function(t,e,r){"use strict";var i=t("../utils"),n=t("../support"),s=t("./ArrayReader"),a=t("./StringReader"),o=t("./NodeBufferReader"),h=t("./Uint8ArrayReader");e.exports=function(t){var e=i.getTypeOf(t);return i.checkSupport(e),"string"!==e||n.uint8array?"nodebuffer"===e?new o(t):n.uint8array?new h(i.transformTo("uint8array",t)):new s(i.transformTo("array",t)):new a(t);};},{"../support":30,"../utils":32,"./ArrayReader":17,"./NodeBufferReader":19,"./StringReader":20,"./Uint8ArrayReader":21}],23:[function(t,e,r){"use strict";r.LOCAL_FILE_HEADER="PK",r.CENTRAL_FILE_HEADER="PK",r.CENTRAL_DIRECTORY_END="PK",r.ZIP64_CENTRAL_DIRECTORY_LOCATOR="PK",r.ZIP64_CENTRAL_DIRECTORY_END="PK",r.DATA_DESCRIPTOR="PK\b";},{}],24:[function(t,e,r){"use strict";var i=t("./GenericWorker"),n=t("../utils");function s(t){i.call(this,"ConvertWorker to "+t),this.destType=t;}n.inherits(s,i),s.prototype.processChunk=function(t){this.push({data:n.transformTo(this.destType,t.data),meta:t.meta});},e.exports=s;},{"../utils":32,"./GenericWorker":28}],25:[function(t,e,r){"use strict";var i=t("./GenericWorker"),n=t("../crc32");function s(){i.call(this,"Crc32Probe"),this.withStreamInfo("crc32",0);}t("../utils").inherits(s,i),s.prototype.processChunk=function(t){this.streamInfo.crc32=n(t.data,this.streamInfo.crc32||0),this.push(t);},e.exports=s;},{"../crc32":4,"../utils":32,"./GenericWorker":28}],26:[function(t,e,r){"use strict";var i=t("../utils"),n=t("./GenericWorker");function s(t){n.call(this,"DataLengthProbe for "+t),this.propName=t,this.withStreamInfo(t,0);}i.inherits(s,n),s.prototype.processChunk=function(t){if(t){var e=this.streamInfo[this.propName]||0;this.streamInfo[this.propName]=e+t.data.length;}n.prototype.processChunk.call(this,t);},e.exports=s;},{"../utils":32,"./GenericWorker":28}],27:[function(t,e,r){"use strict";var i=t("../utils"),n=t("./GenericWorker");function s(t){n.call(this,"DataWorker");var e=this;this.dataIsReady=!1,this.index=0,this.max=0,this.data=null,this.type="",this._tickScheduled=!1,t.then(function(t){e.dataIsReady=!0,e.data=t,e.max=t&&t.length||0,e.type=i.getTypeOf(t),e.isPaused||e._tickAndRepeat();},function(t){e.error(t);});}i.inherits(s,n),s.prototype.cleanUp=function(){n.prototype.cleanUp.call(this),this.data=null;},s.prototype.resume=function(){return!!n.prototype.resume.call(this)&&(!this._tickScheduled&&this.dataIsReady&&(this._tickScheduled=!0,i.delay(this._tickAndRepeat,[],this)),!0);},s.prototype._tickAndRepeat=function(){this._tickScheduled=!1,this.isPaused||this.isFinished||(this._tick(),this.isFinished||(i.delay(this._tickAndRepeat,[],this),this._tickScheduled=!0));},s.prototype._tick=function(){if(this.isPaused||this.isFinished)return!1;var t=null,e=Math.min(this.max,this.index+16384);if(this.index>=this.max)return this.end();switch(this.type){case"string":t=this.data.substring(this.index,e);break;case"uint8array":t=this.data.subarray(this.index,e);break;case"array":case"nodebuffer":t=this.data.slice(this.index,e);}return this.index=e,this.push({data:t,meta:{percent:this.max?this.index/this.max*100:0}});},e.exports=s;},{"../utils":32,"./GenericWorker":28}],28:[function(t,e,r){"use strict";function i(t){this.name=t||"default",this.streamInfo={},this.generatedError=null,this.extraStreamInfo={},this.isPaused=!0,this.isFinished=!1,this.isLocked=!1,this._listeners={data:[],end:[],error:[]},this.previous=null;}i.prototype={push:function(t){this.emit("data",t);},end:function(){if(this.isFinished)return!1;this.flush();try{this.emit("end"),this.cleanUp(),this.isFinished=!0;}catch(t){this.emit("error",t);}return!0;},error:function(t){return!this.isFinished&&(this.isPaused?this.generatedError=t:(this.isFinished=!0,this.emit("error",t),this.previous&&this.previous.error(t),this.cleanUp()),!0);},on:function(t,e){return this._listeners[t].push(e),this;},cleanUp:function(){this.streamInfo=this.generatedError=this.extraStreamInfo=null,this._listeners=[];},emit:function(t,e){if(this._listeners[t])for(var r=0;r<this._listeners[t].length;r++)this._listeners[t][r].call(this,e);},pipe:function(t){return t.registerPrevious(this);},registerPrevious:function(t){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.streamInfo=t.streamInfo,this.mergeStreamInfo(),this.previous=t;var e=this;return t.on("data",function(t){e.processChunk(t);}),t.on("end",function(){e.end();}),t.on("error",function(t){e.error(t);}),this;},pause:function(){return!this.isPaused&&!this.isFinished&&(this.isPaused=!0,this.previous&&this.previous.pause(),!0);},resume:function(){if(!this.isPaused||this.isFinished)return!1;var t=this.isPaused=!1;return this.generatedError&&(this.error(this.generatedError),t=!0),this.previous&&this.previous.resume(),!t;},flush:function(){},processChunk:function(t){this.push(t);},withStreamInfo:function(t,e){return this.extraStreamInfo[t]=e,this.mergeStreamInfo(),this;},mergeStreamInfo:function(){for(var t in this.extraStreamInfo)this.extraStreamInfo.hasOwnProperty(t)&&(this.streamInfo[t]=this.extraStreamInfo[t]);},lock:function(){if(this.isLocked)throw new Error("The stream '"+this+"' has already been used.");this.isLocked=!0,this.previous&&this.previous.lock();},toString:function(){var t="Worker "+this.name;return this.previous?this.previous+" -> "+t:t;}},e.exports=i;},{}],29:[function(t,e,r){"use strict";var h=t("../utils"),n=t("./ConvertWorker"),s=t("./GenericWorker"),u=t("../base64"),i=t("../support"),a=t("../external"),o=null;if(i.nodestream)try{o=t("../nodejs/NodejsStreamOutputAdapter");}catch(t){}function l(t,o){return new a.Promise(function(e,r){var i=[],n=t._internalType,s=t._outputType,a=t._mimeType;t.on("data",function(t,e){i.push(t),o&&o(e);}).on("error",function(t){i=[],r(t);}).on("end",function(){try{var t=function(t,e,r){switch(t){case"blob":return h.newBlob(h.transformTo("arraybuffer",e),r);case"base64":return u.encode(e);default:return h.transformTo(t,e);}}(s,function(t,e){var r,i=0,n=null,s=0;for(r=0;r<e.length;r++)s+=e[r].length;switch(t){case"string":return e.join("");case"array":return Array.prototype.concat.apply([],e);case"uint8array":for(n=new Uint8Array(s),r=0;r<e.length;r++)n.set(e[r],i),i+=e[r].length;return n;case"nodebuffer":return Buffer.concat(e);default:throw new Error("concat : unsupported type '"+t+"'");}}(n,i),a);e(t);}catch(t){r(t);}i=[];}).resume();});}function f(t,e,r){var i=e;switch(e){case"blob":case"arraybuffer":i="uint8array";break;case"base64":i="string";}try{this._internalType=i,this._outputType=e,this._mimeType=r,h.checkSupport(i),this._worker=t.pipe(new n(i)),t.lock();}catch(t){this._worker=new s("error"),this._worker.error(t);}}f.prototype={accumulate:function(t){return l(this,t);},on:function(t,e){var r=this;return"data"===t?this._worker.on(t,function(t){e.call(r,t.data,t.meta);}):this._worker.on(t,function(){h.delay(e,arguments,r);}),this;},resume:function(){return h.delay(this._worker.resume,[],this._worker),this;},pause:function(){return this._worker.pause(),this;},toNodejsStream:function(t){if(h.checkSupport("nodestream"),"nodebuffer"!==this._outputType)throw new Error(this._outputType+" is not supported by this method");return new o(this,{objectMode:"nodebuffer"!==this._outputType},t);}},e.exports=f;},{"../base64":1,"../external":6,"../nodejs/NodejsStreamOutputAdapter":13,"../support":30,"../utils":32,"./ConvertWorker":24,"./GenericWorker":28}],30:[function(t,e,r){"use strict";if(r.base64=!0,r.array=!0,r.string=!0,r.arraybuffer="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array,r.nodebuffer="undefined"!=typeof Buffer,r.uint8array="undefined"!=typeof Uint8Array,"undefined"==typeof ArrayBuffer)r.blob=!1;else{var i=new ArrayBuffer(0);try{r.blob=0===new Blob([i],{type:"application/zip"}).size;}catch(t){try{var n=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder)();n.append(i),r.blob=0===n.getBlob("application/zip").size;}catch(t){r.blob=!1;}}}try{r.nodestream=!!t("readable-stream").Readable;}catch(t){r.nodestream=!1;}},{"readable-stream":16}],31:[function(t,e,s){"use strict";for(var o=t("./utils"),h=t("./support"),r=t("./nodejsUtils"),i=t("./stream/GenericWorker"),u=new Array(256),n=0;n<256;n++)u[n]=252<=n?6:248<=n?5:240<=n?4:224<=n?3:192<=n?2:1;u[254]=u[254]=1;function a(){i.call(this,"utf-8 decode"),this.leftOver=null;}function l(){i.call(this,"utf-8 encode");}s.utf8encode=function(t){return h.nodebuffer?r.newBufferFrom(t,"utf-8"):function(t){var e,r,i,n,s,a=t.length,o=0;for(n=0;n<a;n++)55296==(64512&(r=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(i=t.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(i-56320),n++),o+=r<128?1:r<2048?2:r<65536?3:4;for(e=h.uint8array?new Uint8Array(o):new Array(o),n=s=0;s<o;n++)55296==(64512&(r=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(i=t.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(i-56320),n++),r<128?e[s++]=r:(r<2048?e[s++]=192|r>>>6:(r<65536?e[s++]=224|r>>>12:(e[s++]=240|r>>>18,e[s++]=128|r>>>12&63),e[s++]=128|r>>>6&63),e[s++]=128|63&r);return e;}(t);},s.utf8decode=function(t){return h.nodebuffer?o.transformTo("nodebuffer",t).toString("utf-8"):function(t){var e,r,i,n,s=t.length,a=new Array(2*s);for(e=r=0;e<s;)if((i=t[e++])<128)a[r++]=i;else if(4<(n=u[i]))a[r++]=65533,e+=n-1;else{for(i&=2===n?31:3===n?15:7;1<n&&e<s;)i=i<<6|63&t[e++],n--;1<n?a[r++]=65533:i<65536?a[r++]=i:(i-=65536,a[r++]=55296|i>>10&1023,a[r++]=56320|1023&i);}return a.length!==r&&(a.subarray?a=a.subarray(0,r):a.length=r),o.applyFromCharCode(a);}(t=o.transformTo(h.uint8array?"uint8array":"array",t));},o.inherits(a,i),a.prototype.processChunk=function(t){var e=o.transformTo(h.uint8array?"uint8array":"array",t.data);if(this.leftOver&&this.leftOver.length){if(h.uint8array){var r=e;(e=new Uint8Array(r.length+this.leftOver.length)).set(this.leftOver,0),e.set(r,this.leftOver.length);}else e=this.leftOver.concat(e);this.leftOver=null;}var i=function(t,e){var r;for((e=e||t.length)>t.length&&(e=t.length),r=e-1;0<=r&&128==(192&t[r]);)r--;return r<0?e:0===r?e:r+u[t[r]]>e?r:e;}(e),n=e;i!==e.length&&(h.uint8array?(n=e.subarray(0,i),this.leftOver=e.subarray(i,e.length)):(n=e.slice(0,i),this.leftOver=e.slice(i,e.length))),this.push({data:s.utf8decode(n),meta:t.meta});},a.prototype.flush=function(){this.leftOver&&this.leftOver.length&&(this.push({data:s.utf8decode(this.leftOver),meta:{}}),this.leftOver=null);},s.Utf8DecodeWorker=a,o.inherits(l,i),l.prototype.processChunk=function(t){this.push({data:s.utf8encode(t.data),meta:t.meta});},s.Utf8EncodeWorker=l;},{"./nodejsUtils":14,"./stream/GenericWorker":28,"./support":30,"./utils":32}],32:[function(t,e,a){"use strict";var o=t("./support"),h=t("./base64"),r=t("./nodejsUtils"),i=t("set-immediate-shim"),u=t("./external");function n(t){return t;}function l(t,e){for(var r=0;r<t.length;++r)e[r]=255&t.charCodeAt(r);return e;}a.newBlob=function(e,r){a.checkSupport("blob");try{return new Blob([e],{type:r});}catch(t){try{var i=new(self.BlobBuilder||self.WebKitBlobBuilder||self.MozBlobBuilder||self.MSBlobBuilder)();return i.append(e),i.getBlob(r);}catch(t){throw new Error("Bug : can't construct the Blob.");}}};var s={stringifyByChunk:function(t,e,r){var i=[],n=0,s=t.length;if(s<=r)return String.fromCharCode.apply(null,t);for(;n<s;)"array"===e||"nodebuffer"===e?i.push(String.fromCharCode.apply(null,t.slice(n,Math.min(n+r,s)))):i.push(String.fromCharCode.apply(null,t.subarray(n,Math.min(n+r,s)))),n+=r;return i.join("");},stringifyByChar:function(t){for(var e="",r=0;r<t.length;r++)e+=String.fromCharCode(t[r]);return e;},applyCanBeUsed:{uint8array:function(){try{return o.uint8array&&1===String.fromCharCode.apply(null,new Uint8Array(1)).length;}catch(t){return!1;}}(),nodebuffer:function(){try{return o.nodebuffer&&1===String.fromCharCode.apply(null,r.allocBuffer(1)).length;}catch(t){return!1;}}()}};function f(t){var e=65536,r=a.getTypeOf(t),i=!0;if("uint8array"===r?i=s.applyCanBeUsed.uint8array:"nodebuffer"===r&&(i=s.applyCanBeUsed.nodebuffer),i)for(;1<e;)try{return s.stringifyByChunk(t,r,e);}catch(t){e=Math.floor(e/2);}return s.stringifyByChar(t);}function d(t,e){for(var r=0;r<t.length;r++)e[r]=t[r];return e;}a.applyFromCharCode=f;var c={};c.string={string:n,array:function(t){return l(t,new Array(t.length));},arraybuffer:function(t){return c.string.uint8array(t).buffer;},uint8array:function(t){return l(t,new Uint8Array(t.length));},nodebuffer:function(t){return l(t,r.allocBuffer(t.length));}},c.array={string:f,array:n,arraybuffer:function(t){return new Uint8Array(t).buffer;},uint8array:function(t){return new Uint8Array(t);},nodebuffer:function(t){return r.newBufferFrom(t);}},c.arraybuffer={string:function(t){return f(new Uint8Array(t));},array:function(t){return d(new Uint8Array(t),new Array(t.byteLength));},arraybuffer:n,uint8array:function(t){return new Uint8Array(t);},nodebuffer:function(t){return r.newBufferFrom(new Uint8Array(t));}},c.uint8array={string:f,array:function(t){return d(t,new Array(t.length));},arraybuffer:function(t){return t.buffer;},uint8array:n,nodebuffer:function(t){return r.newBufferFrom(t);}},c.nodebuffer={string:f,array:function(t){return d(t,new Array(t.length));},arraybuffer:function(t){return c.nodebuffer.uint8array(t).buffer;},uint8array:function(t){return d(t,new Uint8Array(t.length));},nodebuffer:n},a.transformTo=function(t,e){if(e=e||"",!t)return e;a.checkSupport(t);var r=a.getTypeOf(e);return c[r][t](e);},a.getTypeOf=function(t){return"string"==typeof t?"string":"[object Array]"===Object.prototype.toString.call(t)?"array":o.nodebuffer&&r.isBuffer(t)?"nodebuffer":o.uint8array&&t instanceof Uint8Array?"uint8array":o.arraybuffer&&t instanceof ArrayBuffer?"arraybuffer":void 0;},a.checkSupport=function(t){if(!o[t.toLowerCase()])throw new Error(t+" is not supported by this platform");},a.MAX_VALUE_16BITS=65535,a.MAX_VALUE_32BITS=-1,a.pretty=function(t){var e,r,i="";for(r=0;r<(t||"").length;r++)i+="\\x"+((e=t.charCodeAt(r))<16?"0":"")+e.toString(16).toUpperCase();return i;},a.delay=function(t,e,r){i(function(){t.apply(r||null,e||[]);});},a.inherits=function(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r();},a.extend=function(){var t,e,r={};for(t=0;t<arguments.length;t++)for(e in arguments[t])arguments[t].hasOwnProperty(e)&&void 0===r[e]&&(r[e]=arguments[t][e]);return r;},a.prepareContent=function(r,t,i,n,s){return u.Promise.resolve(t).then(function(i){return o.blob&&(i instanceof Blob||-1!==["[object File]","[object Blob]"].indexOf(Object.prototype.toString.call(i)))&&"undefined"!=typeof FileReader?new u.Promise(function(e,r){var t=new FileReader();t.onload=function(t){e(t.target.result);},t.onerror=function(t){r(t.target.error);},t.readAsArrayBuffer(i);}):i;}).then(function(t){var e=a.getTypeOf(t);return e?("arraybuffer"===e?t=a.transformTo("uint8array",t):"string"===e&&(s?t=h.decode(t):i&&!0!==n&&(t=function(t){return l(t,o.uint8array?new Uint8Array(t.length):new Array(t.length));}(t))),t):u.Promise.reject(new Error("Can't read the data of '"+r+"'. Is it in a supported JavaScript type (String, Blob, ArrayBuffer, etc) ?"));});};},{"./base64":1,"./external":6,"./nodejsUtils":14,"./support":30,"set-immediate-shim":54}],33:[function(t,e,r){"use strict";var i=t("./reader/readerFor"),n=t("./utils"),s=t("./signature"),a=t("./zipEntry"),o=(t("./utf8"),t("./support"));function h(t){this.files=[],this.loadOptions=t;}h.prototype={checkSignature:function(t){if(!this.reader.readAndCheckSignature(t)){this.reader.index-=4;var e=this.reader.readString(4);throw new Error("Corrupted zip or bug: unexpected signature ("+n.pretty(e)+", expected "+n.pretty(t)+")");}},isSignature:function(t,e){var r=this.reader.index;this.reader.setIndex(t);var i=this.reader.readString(4)===e;return this.reader.setIndex(r),i;},readBlockEndOfCentral:function(){this.diskNumber=this.reader.readInt(2),this.diskWithCentralDirStart=this.reader.readInt(2),this.centralDirRecordsOnThisDisk=this.reader.readInt(2),this.centralDirRecords=this.reader.readInt(2),this.centralDirSize=this.reader.readInt(4),this.centralDirOffset=this.reader.readInt(4),this.zipCommentLength=this.reader.readInt(2);var t=this.reader.readData(this.zipCommentLength),e=o.uint8array?"uint8array":"array",r=n.transformTo(e,t);this.zipComment=this.loadOptions.decodeFileName(r);},readBlockZip64EndOfCentral:function(){this.zip64EndOfCentralSize=this.reader.readInt(8),this.reader.skip(4),this.diskNumber=this.reader.readInt(4),this.diskWithCentralDirStart=this.reader.readInt(4),this.centralDirRecordsOnThisDisk=this.reader.readInt(8),this.centralDirRecords=this.reader.readInt(8),this.centralDirSize=this.reader.readInt(8),this.centralDirOffset=this.reader.readInt(8),this.zip64ExtensibleData={};for(var t,e,r,i=this.zip64EndOfCentralSize-44;0<i;)t=this.reader.readInt(2),e=this.reader.readInt(4),r=this.reader.readData(e),this.zip64ExtensibleData[t]={id:t,length:e,value:r};},readBlockZip64EndOfCentralLocator:function(){if(this.diskWithZip64CentralDirStart=this.reader.readInt(4),this.relativeOffsetEndOfZip64CentralDir=this.reader.readInt(8),this.disksCount=this.reader.readInt(4),1<this.disksCount)throw new Error("Multi-volumes zip are not supported");},readLocalFiles:function(){var t,e;for(t=0;t<this.files.length;t++)e=this.files[t],this.reader.setIndex(e.localHeaderOffset),this.checkSignature(s.LOCAL_FILE_HEADER),e.readLocalPart(this.reader),e.handleUTF8(),e.processAttributes();},readCentralDir:function(){var t;for(this.reader.setIndex(this.centralDirOffset);this.reader.readAndCheckSignature(s.CENTRAL_FILE_HEADER);)(t=new a({zip64:this.zip64},this.loadOptions)).readCentralPart(this.reader),this.files.push(t);if(this.centralDirRecords!==this.files.length&&0!==this.centralDirRecords&&0===this.files.length)throw new Error("Corrupted zip or bug: expected "+this.centralDirRecords+" records in central dir, got "+this.files.length);},readEndOfCentral:function(){var t=this.reader.lastIndexOfSignature(s.CENTRAL_DIRECTORY_END);if(t<0)throw!this.isSignature(0,s.LOCAL_FILE_HEADER)?new Error("Can't find end of central directory : is this a zip file ? If it is, see https://stuk.github.io/jszip/documentation/howto/read_zip.html"):new Error("Corrupted zip: can't find end of central directory");this.reader.setIndex(t);var e=t;if(this.checkSignature(s.CENTRAL_DIRECTORY_END),this.readBlockEndOfCentral(),this.diskNumber===n.MAX_VALUE_16BITS||this.diskWithCentralDirStart===n.MAX_VALUE_16BITS||this.centralDirRecordsOnThisDisk===n.MAX_VALUE_16BITS||this.centralDirRecords===n.MAX_VALUE_16BITS||this.centralDirSize===n.MAX_VALUE_32BITS||this.centralDirOffset===n.MAX_VALUE_32BITS){if(this.zip64=!0,(t=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR))<0)throw new Error("Corrupted zip: can't find the ZIP64 end of central directory locator");if(this.reader.setIndex(t),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_LOCATOR),this.readBlockZip64EndOfCentralLocator(),!this.isSignature(this.relativeOffsetEndOfZip64CentralDir,s.ZIP64_CENTRAL_DIRECTORY_END)&&(this.relativeOffsetEndOfZip64CentralDir=this.reader.lastIndexOfSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.relativeOffsetEndOfZip64CentralDir<0))throw new Error("Corrupted zip: can't find the ZIP64 end of central directory");this.reader.setIndex(this.relativeOffsetEndOfZip64CentralDir),this.checkSignature(s.ZIP64_CENTRAL_DIRECTORY_END),this.readBlockZip64EndOfCentral();}var r=this.centralDirOffset+this.centralDirSize;this.zip64&&(r+=20,r+=12+this.zip64EndOfCentralSize);var i=e-r;if(0<i)this.isSignature(e,s.CENTRAL_FILE_HEADER)||(this.reader.zero=i);else if(i<0)throw new Error("Corrupted zip: missing "+Math.abs(i)+" bytes.");},prepareReader:function(t){this.reader=i(t);},load:function(t){this.prepareReader(t),this.readEndOfCentral(),this.readCentralDir(),this.readLocalFiles();}},e.exports=h;},{"./reader/readerFor":22,"./signature":23,"./support":30,"./utf8":31,"./utils":32,"./zipEntry":34}],34:[function(t,e,r){"use strict";var i=t("./reader/readerFor"),s=t("./utils"),n=t("./compressedObject"),a=t("./crc32"),o=t("./utf8"),h=t("./compressions"),u=t("./support");function l(t,e){this.options=t,this.loadOptions=e;}l.prototype={isEncrypted:function(){return 1==(1&this.bitFlag);},useUTF8:function(){return 2048==(2048&this.bitFlag);},readLocalPart:function(t){var e,r;if(t.skip(22),this.fileNameLength=t.readInt(2),r=t.readInt(2),this.fileName=t.readData(this.fileNameLength),t.skip(r),-1===this.compressedSize||-1===this.uncompressedSize)throw new Error("Bug or corrupted zip : didn't get enough informations from the central directory (compressedSize === -1 || uncompressedSize === -1)");if(null===(e=function(t){for(var e in h)if(h.hasOwnProperty(e)&&h[e].magic===t)return h[e];return null;}(this.compressionMethod)))throw new Error("Corrupted zip : compression "+s.pretty(this.compressionMethod)+" unknown (inner file : "+s.transformTo("string",this.fileName)+")");this.decompressed=new n(this.compressedSize,this.uncompressedSize,this.crc32,e,t.readData(this.compressedSize));},readCentralPart:function(t){this.versionMadeBy=t.readInt(2),t.skip(2),this.bitFlag=t.readInt(2),this.compressionMethod=t.readString(2),this.date=t.readDate(),this.crc32=t.readInt(4),this.compressedSize=t.readInt(4),this.uncompressedSize=t.readInt(4);var e=t.readInt(2);if(this.extraFieldsLength=t.readInt(2),this.fileCommentLength=t.readInt(2),this.diskNumberStart=t.readInt(2),this.internalFileAttributes=t.readInt(2),this.externalFileAttributes=t.readInt(4),this.localHeaderOffset=t.readInt(4),this.isEncrypted())throw new Error("Encrypted zip are not supported");t.skip(e),this.readExtraFields(t),this.parseZIP64ExtraField(t),this.fileComment=t.readData(this.fileCommentLength);},processAttributes:function(){this.unixPermissions=null,this.dosPermissions=null;var t=this.versionMadeBy>>8;this.dir=!!(16&this.externalFileAttributes),0==t&&(this.dosPermissions=63&this.externalFileAttributes),3==t&&(this.unixPermissions=this.externalFileAttributes>>16&65535),this.dir||"/"!==this.fileNameStr.slice(-1)||(this.dir=!0);},parseZIP64ExtraField:function(t){if(this.extraFields[1]){var e=i(this.extraFields[1].value);this.uncompressedSize===s.MAX_VALUE_32BITS&&(this.uncompressedSize=e.readInt(8)),this.compressedSize===s.MAX_VALUE_32BITS&&(this.compressedSize=e.readInt(8)),this.localHeaderOffset===s.MAX_VALUE_32BITS&&(this.localHeaderOffset=e.readInt(8)),this.diskNumberStart===s.MAX_VALUE_32BITS&&(this.diskNumberStart=e.readInt(4));}},readExtraFields:function(t){var e,r,i,n=t.index+this.extraFieldsLength;for(this.extraFields||(this.extraFields={});t.index<n;)e=t.readInt(2),r=t.readInt(2),i=t.readData(r),this.extraFields[e]={id:e,length:r,value:i};},handleUTF8:function(){var t=u.uint8array?"uint8array":"array";if(this.useUTF8())this.fileNameStr=o.utf8decode(this.fileName),this.fileCommentStr=o.utf8decode(this.fileComment);else{var e=this.findExtraFieldUnicodePath();if(null!==e)this.fileNameStr=e;else{var r=s.transformTo(t,this.fileName);this.fileNameStr=this.loadOptions.decodeFileName(r);}var i=this.findExtraFieldUnicodeComment();if(null!==i)this.fileCommentStr=i;else{var n=s.transformTo(t,this.fileComment);this.fileCommentStr=this.loadOptions.decodeFileName(n);}}},findExtraFieldUnicodePath:function(){var t=this.extraFields[28789];if(t){var e=i(t.value);return 1!==e.readInt(1)?null:a(this.fileName)!==e.readInt(4)?null:o.utf8decode(e.readData(t.length-5));}return null;},findExtraFieldUnicodeComment:function(){var t=this.extraFields[25461];if(t){var e=i(t.value);return 1!==e.readInt(1)?null:a(this.fileComment)!==e.readInt(4)?null:o.utf8decode(e.readData(t.length-5));}return null;}},e.exports=l;},{"./compressedObject":2,"./compressions":3,"./crc32":4,"./reader/readerFor":22,"./support":30,"./utf8":31,"./utils":32}],35:[function(t,e,r){"use strict";function i(t,e,r){this.name=t,this.dir=r.dir,this.date=r.date,this.comment=r.comment,this.unixPermissions=r.unixPermissions,this.dosPermissions=r.dosPermissions,this._data=e,this._dataBinary=r.binary,this.options={compression:r.compression,compressionOptions:r.compressionOptions};}var s=t("./stream/StreamHelper"),n=t("./stream/DataWorker"),a=t("./utf8"),o=t("./compressedObject"),h=t("./stream/GenericWorker");i.prototype={internalStream:function(t){var e=null,r="string";try{if(!t)throw new Error("No output type specified.");var i="string"===(r=t.toLowerCase())||"text"===r;"binarystring"!==r&&"text"!==r||(r="string"),e=this._decompressWorker();var n=!this._dataBinary;n&&!i&&(e=e.pipe(new a.Utf8EncodeWorker())),!n&&i&&(e=e.pipe(new a.Utf8DecodeWorker()));}catch(t){(e=new h("error")).error(t);}return new s(e,r,"");},async:function(t,e){return this.internalStream(t).accumulate(e);},nodeStream:function(t,e){return this.internalStream(t||"nodebuffer").toNodejsStream(e);},_compressWorker:function(t,e){if(this._data instanceof o&&this._data.compression.magic===t.magic)return this._data.getCompressedWorker();var r=this._decompressWorker();return this._dataBinary||(r=r.pipe(new a.Utf8EncodeWorker())),o.createWorkerFrom(r,t,e);},_decompressWorker:function(){return this._data instanceof o?this._data.getContentWorker():this._data instanceof h?this._data:new n(this._data);}};for(var u=["asText","asBinary","asNodeBuffer","asUint8Array","asArrayBuffer"],l=function(){throw new Error("This method has been removed in JSZip 3.0, please check the upgrade guide.");},f=0;f<u.length;f++)i.prototype[u[f]]=l;e.exports=i;},{"./compressedObject":2,"./stream/DataWorker":27,"./stream/GenericWorker":28,"./stream/StreamHelper":29,"./utf8":31}],36:[function(t,l,e){(function(e){"use strict";var r,i,t=e.MutationObserver||e.WebKitMutationObserver;if(t){var n=0,s=new t(u),a=e.document.createTextNode("");s.observe(a,{characterData:!0}),r=function(){a.data=n=++n%2;};}else if(e.setImmediate||void 0===e.MessageChannel)r="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){u(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null;},e.document.documentElement.appendChild(t);}:function(){setTimeout(u,0);};else{var o=new e.MessageChannel();o.port1.onmessage=u,r=function(){o.port2.postMessage(0);};}var h=[];function u(){var t,e;i=!0;for(var r=h.length;r;){for(e=h,h=[],t=-1;++t<r;)e[t]();r=h.length;}i=!1;}l.exports=function(t){1!==h.push(t)||i||r();};}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});},{}],37:[function(t,e,r){"use strict";var n=t("immediate");function u(){}var l={},s=["REJECTED"],a=["FULFILLED"],i=["PENDING"];function o(t){if("function"!=typeof t)throw new TypeError("resolver must be a function");this.state=i,this.queue=[],this.outcome=void 0,t!==u&&c(this,t);}function h(t,e,r){this.promise=t,"function"==typeof e&&(this.onFulfilled=e,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected);}function f(e,r,i){n(function(){var t;try{t=r(i);}catch(t){return l.reject(e,t);}t===e?l.reject(e,new TypeError("Cannot resolve promise with itself")):l.resolve(e,t);});}function d(t){var e=t&&t.then;if(t&&("object"==typeof t||"function"==typeof t)&&"function"==typeof e)return function(){e.apply(t,arguments);};}function c(e,t){var r=!1;function i(t){r||(r=!0,l.reject(e,t));}function n(t){r||(r=!0,l.resolve(e,t));}var s=p(function(){t(n,i);});"error"===s.status&&i(s.value);}function p(t,e){var r={};try{r.value=t(e),r.status="success";}catch(t){r.status="error",r.value=t;}return r;}(e.exports=o).prototype.finally=function(e){if("function"!=typeof e)return this;var r=this.constructor;return this.then(function(t){return r.resolve(e()).then(function(){return t;});},function(t){return r.resolve(e()).then(function(){throw t;});});},o.prototype.catch=function(t){return this.then(null,t);},o.prototype.then=function(t,e){if("function"!=typeof t&&this.state===a||"function"!=typeof e&&this.state===s)return this;var r=new this.constructor(u);this.state!==i?f(r,this.state===a?t:e,this.outcome):this.queue.push(new h(r,t,e));return r;},h.prototype.callFulfilled=function(t){l.resolve(this.promise,t);},h.prototype.otherCallFulfilled=function(t){f(this.promise,this.onFulfilled,t);},h.prototype.callRejected=function(t){l.reject(this.promise,t);},h.prototype.otherCallRejected=function(t){f(this.promise,this.onRejected,t);},l.resolve=function(t,e){var r=p(d,e);if("error"===r.status)return l.reject(t,r.value);var i=r.value;if(i)c(t,i);else{t.state=a,t.outcome=e;for(var n=-1,s=t.queue.length;++n<s;)t.queue[n].callFulfilled(e);}return t;},l.reject=function(t,e){t.state=s,t.outcome=e;for(var r=-1,i=t.queue.length;++r<i;)t.queue[r].callRejected(e);return t;},o.resolve=function(t){if(t instanceof this)return t;return l.resolve(new this(u),t);},o.reject=function(t){var e=new this(u);return l.reject(e,t);},o.all=function(t){var r=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var i=t.length,n=!1;if(!i)return this.resolve([]);var s=new Array(i),a=0,e=-1,o=new this(u);for(;++e<i;)h(t[e],e);return o;function h(t,e){r.resolve(t).then(function(t){s[e]=t,++a!==i||n||(n=!0,l.resolve(o,s));},function(t){n||(n=!0,l.reject(o,t));});}},o.race=function(t){var e=this;if("[object Array]"!==Object.prototype.toString.call(t))return this.reject(new TypeError("must be an array"));var r=t.length,i=!1;if(!r)return this.resolve([]);var n=-1,s=new this(u);for(;++n<r;)a=t[n],e.resolve(a).then(function(t){i||(i=!0,l.resolve(s,t));},function(t){i||(i=!0,l.reject(s,t));});var a;return s;};},{immediate:36}],38:[function(t,e,r){"use strict";var i={};(0,t("./lib/utils/common").assign)(i,t("./lib/deflate"),t("./lib/inflate"),t("./lib/zlib/constants")),e.exports=i;},{"./lib/deflate":39,"./lib/inflate":40,"./lib/utils/common":41,"./lib/zlib/constants":44}],39:[function(t,e,r){"use strict";var a=t("./zlib/deflate"),o=t("./utils/common"),h=t("./utils/strings"),n=t("./zlib/messages"),s=t("./zlib/zstream"),u=Object.prototype.toString,l=0,f=-1,d=0,c=8;function p(t){if(!(this instanceof p))return new p(t);this.options=o.assign({level:f,method:c,chunkSize:16384,windowBits:15,memLevel:8,strategy:d,to:""},t||{});var e=this.options;e.raw&&0<e.windowBits?e.windowBits=-e.windowBits:e.gzip&&0<e.windowBits&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new s(),this.strm.avail_out=0;var r=a.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(r!==l)throw new Error(n[r]);if(e.header&&a.deflateSetHeader(this.strm,e.header),e.dictionary){var i;if(i="string"==typeof e.dictionary?h.string2buf(e.dictionary):"[object ArrayBuffer]"===u.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,(r=a.deflateSetDictionary(this.strm,i))!==l)throw new Error(n[r]);this._dict_set=!0;}}function i(t,e){var r=new p(e);if(r.push(t,!0),r.err)throw r.msg||n[r.err];return r.result;}p.prototype.push=function(t,e){var r,i,n=this.strm,s=this.options.chunkSize;if(this.ended)return!1;i=e===~~e?e:!0===e?4:0,"string"==typeof t?n.input=h.string2buf(t):"[object ArrayBuffer]"===u.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;do{if(0===n.avail_out&&(n.output=new o.Buf8(s),n.next_out=0,n.avail_out=s),1!==(r=a.deflate(n,i))&&r!==l)return this.onEnd(r),!(this.ended=!0);0!==n.avail_out&&(0!==n.avail_in||4!==i&&2!==i)||("string"===this.options.to?this.onData(h.buf2binstring(o.shrinkBuf(n.output,n.next_out))):this.onData(o.shrinkBuf(n.output,n.next_out)));}while((0<n.avail_in||0===n.avail_out)&&1!==r);return 4===i?(r=a.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===l):2!==i||(this.onEnd(l),!(n.avail_out=0));},p.prototype.onData=function(t){this.chunks.push(t);},p.prototype.onEnd=function(t){t===l&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=o.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg;},r.Deflate=p,r.deflate=i,r.deflateRaw=function(t,e){return(e=e||{}).raw=!0,i(t,e);},r.gzip=function(t,e){return(e=e||{}).gzip=!0,i(t,e);};},{"./utils/common":41,"./utils/strings":42,"./zlib/deflate":46,"./zlib/messages":51,"./zlib/zstream":53}],40:[function(t,e,r){"use strict";var d=t("./zlib/inflate"),c=t("./utils/common"),p=t("./utils/strings"),m=t("./zlib/constants"),i=t("./zlib/messages"),n=t("./zlib/zstream"),s=t("./zlib/gzheader"),_=Object.prototype.toString;function a(t){if(!(this instanceof a))return new a(t);this.options=c.assign({chunkSize:16384,windowBits:0,to:""},t||{});var e=this.options;e.raw&&0<=e.windowBits&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(0<=e.windowBits&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),15<e.windowBits&&e.windowBits<48&&0==(15&e.windowBits)&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new n(),this.strm.avail_out=0;var r=d.inflateInit2(this.strm,e.windowBits);if(r!==m.Z_OK)throw new Error(i[r]);this.header=new s(),d.inflateGetHeader(this.strm,this.header);}function o(t,e){var r=new a(e);if(r.push(t,!0),r.err)throw r.msg||i[r.err];return r.result;}a.prototype.push=function(t,e){var r,i,n,s,a,o,h=this.strm,u=this.options.chunkSize,l=this.options.dictionary,f=!1;if(this.ended)return!1;i=e===~~e?e:!0===e?m.Z_FINISH:m.Z_NO_FLUSH,"string"==typeof t?h.input=p.binstring2buf(t):"[object ArrayBuffer]"===_.call(t)?h.input=new Uint8Array(t):h.input=t,h.next_in=0,h.avail_in=h.input.length;do{if(0===h.avail_out&&(h.output=new c.Buf8(u),h.next_out=0,h.avail_out=u),(r=d.inflate(h,m.Z_NO_FLUSH))===m.Z_NEED_DICT&&l&&(o="string"==typeof l?p.string2buf(l):"[object ArrayBuffer]"===_.call(l)?new Uint8Array(l):l,r=d.inflateSetDictionary(this.strm,o)),r===m.Z_BUF_ERROR&&!0===f&&(r=m.Z_OK,f=!1),r!==m.Z_STREAM_END&&r!==m.Z_OK)return this.onEnd(r),!(this.ended=!0);h.next_out&&(0!==h.avail_out&&r!==m.Z_STREAM_END&&(0!==h.avail_in||i!==m.Z_FINISH&&i!==m.Z_SYNC_FLUSH)||("string"===this.options.to?(n=p.utf8border(h.output,h.next_out),s=h.next_out-n,a=p.buf2string(h.output,n),h.next_out=s,h.avail_out=u-s,s&&c.arraySet(h.output,h.output,n,s,0),this.onData(a)):this.onData(c.shrinkBuf(h.output,h.next_out)))),0===h.avail_in&&0===h.avail_out&&(f=!0);}while((0<h.avail_in||0===h.avail_out)&&r!==m.Z_STREAM_END);return r===m.Z_STREAM_END&&(i=m.Z_FINISH),i===m.Z_FINISH?(r=d.inflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===m.Z_OK):i!==m.Z_SYNC_FLUSH||(this.onEnd(m.Z_OK),!(h.avail_out=0));},a.prototype.onData=function(t){this.chunks.push(t);},a.prototype.onEnd=function(t){t===m.Z_OK&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=c.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg;},r.Inflate=a,r.inflate=o,r.inflateRaw=function(t,e){return(e=e||{}).raw=!0,o(t,e);},r.ungzip=o;},{"./utils/common":41,"./utils/strings":42,"./zlib/constants":44,"./zlib/gzheader":47,"./zlib/inflate":49,"./zlib/messages":51,"./zlib/zstream":53}],41:[function(t,e,r){"use strict";var i="undefined"!=typeof Uint8Array&&"undefined"!=typeof Uint16Array&&"undefined"!=typeof Int32Array;r.assign=function(t){for(var e=Array.prototype.slice.call(arguments,1);e.length;){var r=e.shift();if(r){if("object"!=typeof r)throw new TypeError(r+"must be non-object");for(var i in r)r.hasOwnProperty(i)&&(t[i]=r[i]);}}return t;},r.shrinkBuf=function(t,e){return t.length===e?t:t.subarray?t.subarray(0,e):(t.length=e,t);};var n={arraySet:function(t,e,r,i,n){if(e.subarray&&t.subarray)t.set(e.subarray(r,r+i),n);else for(var s=0;s<i;s++)t[n+s]=e[r+s];},flattenChunks:function(t){var e,r,i,n,s,a;for(e=i=0,r=t.length;e<r;e++)i+=t[e].length;for(a=new Uint8Array(i),e=n=0,r=t.length;e<r;e++)s=t[e],a.set(s,n),n+=s.length;return a;}},s={arraySet:function(t,e,r,i,n){for(var s=0;s<i;s++)t[n+s]=e[r+s];},flattenChunks:function(t){return[].concat.apply([],t);}};r.setTyped=function(t){t?(r.Buf8=Uint8Array,r.Buf16=Uint16Array,r.Buf32=Int32Array,r.assign(r,n)):(r.Buf8=Array,r.Buf16=Array,r.Buf32=Array,r.assign(r,s));},r.setTyped(i);},{}],42:[function(t,e,r){"use strict";var h=t("./common"),n=!0,s=!0;try{String.fromCharCode.apply(null,[0]);}catch(t){n=!1;}try{String.fromCharCode.apply(null,new Uint8Array(1));}catch(t){s=!1;}for(var u=new h.Buf8(256),i=0;i<256;i++)u[i]=252<=i?6:248<=i?5:240<=i?4:224<=i?3:192<=i?2:1;function l(t,e){if(e<65537&&(t.subarray&&s||!t.subarray&&n))return String.fromCharCode.apply(null,h.shrinkBuf(t,e));for(var r="",i=0;i<e;i++)r+=String.fromCharCode(t[i]);return r;}u[254]=u[254]=1,r.string2buf=function(t){var e,r,i,n,s,a=t.length,o=0;for(n=0;n<a;n++)55296==(64512&(r=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(i=t.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(i-56320),n++),o+=r<128?1:r<2048?2:r<65536?3:4;for(e=new h.Buf8(o),n=s=0;s<o;n++)55296==(64512&(r=t.charCodeAt(n)))&&n+1<a&&56320==(64512&(i=t.charCodeAt(n+1)))&&(r=65536+(r-55296<<10)+(i-56320),n++),r<128?e[s++]=r:(r<2048?e[s++]=192|r>>>6:(r<65536?e[s++]=224|r>>>12:(e[s++]=240|r>>>18,e[s++]=128|r>>>12&63),e[s++]=128|r>>>6&63),e[s++]=128|63&r);return e;},r.buf2binstring=function(t){return l(t,t.length);},r.binstring2buf=function(t){for(var e=new h.Buf8(t.length),r=0,i=e.length;r<i;r++)e[r]=t.charCodeAt(r);return e;},r.buf2string=function(t,e){var r,i,n,s,a=e||t.length,o=new Array(2*a);for(r=i=0;r<a;)if((n=t[r++])<128)o[i++]=n;else if(4<(s=u[n]))o[i++]=65533,r+=s-1;else{for(n&=2===s?31:3===s?15:7;1<s&&r<a;)n=n<<6|63&t[r++],s--;1<s?o[i++]=65533:n<65536?o[i++]=n:(n-=65536,o[i++]=55296|n>>10&1023,o[i++]=56320|1023&n);}return l(o,i);},r.utf8border=function(t,e){var r;for((e=e||t.length)>t.length&&(e=t.length),r=e-1;0<=r&&128==(192&t[r]);)r--;return r<0?e:0===r?e:r+u[t[r]]>e?r:e;};},{"./common":41}],43:[function(t,e,r){"use strict";e.exports=function(t,e,r,i){for(var n=65535&t|0,s=t>>>16&65535|0,a=0;0!==r;){for(r-=a=2e3<r?2e3:r;s=s+(n=n+e[i++]|0)|0,--a;);n%=65521,s%=65521;}return n|s<<16|0;};},{}],44:[function(t,e,r){"use strict";e.exports={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};},{}],45:[function(t,e,r){"use strict";var o=function(){for(var t,e=[],r=0;r<256;r++){t=r;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[r]=t;}return e;}();e.exports=function(t,e,r,i){var n=o,s=i+r;t^=-1;for(var a=i;a<s;a++)t=t>>>8^n[255&(t^e[a])];return-1^t;};},{}],46:[function(t,e,r){"use strict";var h,d=t("../utils/common"),u=t("./trees"),c=t("./adler32"),p=t("./crc32"),i=t("./messages"),l=0,f=4,m=0,_=-2,g=-1,b=4,n=2,v=8,y=9,s=286,a=30,o=19,w=2*s+1,k=15,x=3,S=258,z=S+x+1,C=42,E=113,A=1,I=2,O=3,B=4;function R(t,e){return t.msg=i[e],e;}function T(t){return(t<<1)-(4<t?9:0);}function D(t){for(var e=t.length;0<=--e;)t[e]=0;}function F(t){var e=t.state,r=e.pending;r>t.avail_out&&(r=t.avail_out),0!==r&&(d.arraySet(t.output,e.pending_buf,e.pending_out,r,t.next_out),t.next_out+=r,e.pending_out+=r,t.total_out+=r,t.avail_out-=r,e.pending-=r,0===e.pending&&(e.pending_out=0));}function N(t,e){u._tr_flush_block(t,0<=t.block_start?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,F(t.strm);}function U(t,e){t.pending_buf[t.pending++]=e;}function P(t,e){t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e;}function L(t,e){var r,i,n=t.max_chain_length,s=t.strstart,a=t.prev_length,o=t.nice_match,h=t.strstart>t.w_size-z?t.strstart-(t.w_size-z):0,u=t.window,l=t.w_mask,f=t.prev,d=t.strstart+S,c=u[s+a-1],p=u[s+a];t.prev_length>=t.good_match&&(n>>=2),o>t.lookahead&&(o=t.lookahead);do{if(u[(r=e)+a]===p&&u[r+a-1]===c&&u[r]===u[s]&&u[++r]===u[s+1]){s+=2,r++;do{}while(u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&u[++s]===u[++r]&&s<d);if(i=S-(d-s),s=d-S,a<i){if(t.match_start=e,o<=(a=i))break;c=u[s+a-1],p=u[s+a];}}}while((e=f[e&l])>h&&0!=--n);return a<=t.lookahead?a:t.lookahead;}function j(t){var e,r,i,n,s,a,o,h,u,l,f=t.w_size;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=f+(f-z)){for(d.arraySet(t.window,t.window,f,f,0),t.match_start-=f,t.strstart-=f,t.block_start-=f,e=r=t.hash_size;i=t.head[--e],t.head[e]=f<=i?i-f:0,--r;);for(e=r=f;i=t.prev[--e],t.prev[e]=f<=i?i-f:0,--r;);n+=f;}if(0===t.strm.avail_in)break;if(a=t.strm,o=t.window,h=t.strstart+t.lookahead,u=n,l=void 0,l=a.avail_in,u<l&&(l=u),r=0===l?0:(a.avail_in-=l,d.arraySet(o,a.input,a.next_in,l,h),1===a.state.wrap?a.adler=c(a.adler,o,l,h):2===a.state.wrap&&(a.adler=p(a.adler,o,l,h)),a.next_in+=l,a.total_in+=l,l),t.lookahead+=r,t.lookahead+t.insert>=x)for(s=t.strstart-t.insert,t.ins_h=t.window[s],t.ins_h=(t.ins_h<<t.hash_shift^t.window[s+1])&t.hash_mask;t.insert&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[s+x-1])&t.hash_mask,t.prev[s&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=s,s++,t.insert--,!(t.lookahead+t.insert<x)););}while(t.lookahead<z&&0!==t.strm.avail_in);}function Z(t,e){for(var r,i;;){if(t.lookahead<z){if(j(t),t.lookahead<z&&e===l)return A;if(0===t.lookahead)break;}if(r=0,t.lookahead>=x&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+x-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==r&&t.strstart-r<=t.w_size-z&&(t.match_length=L(t,r)),t.match_length>=x){if(i=u._tr_tally(t,t.strstart-t.match_start,t.match_length-x),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=x){for(t.match_length--;t.strstart++,t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+x-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart,0!=--t.match_length;);t.strstart++;}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+1])&t.hash_mask;}else i=u._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(N(t,!1),0===t.strm.avail_out))return A;}return t.insert=t.strstart<x-1?t.strstart:x-1,e===f?(N(t,!0),0===t.strm.avail_out?O:B):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:I;}function W(t,e){for(var r,i,n;;){if(t.lookahead<z){if(j(t),t.lookahead<z&&e===l)return A;if(0===t.lookahead)break;}if(r=0,t.lookahead>=x&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+x-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=x-1,0!==r&&t.prev_length<t.max_lazy_match&&t.strstart-r<=t.w_size-z&&(t.match_length=L(t,r),t.match_length<=5&&(1===t.strategy||t.match_length===x&&4096<t.strstart-t.match_start)&&(t.match_length=x-1)),t.prev_length>=x&&t.match_length<=t.prev_length){for(n=t.strstart+t.lookahead-x,i=u._tr_tally(t,t.strstart-1-t.prev_match,t.prev_length-x),t.lookahead-=t.prev_length-1,t.prev_length-=2;++t.strstart<=n&&(t.ins_h=(t.ins_h<<t.hash_shift^t.window[t.strstart+x-1])&t.hash_mask,r=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!=--t.prev_length;);if(t.match_available=0,t.match_length=x-1,t.strstart++,i&&(N(t,!1),0===t.strm.avail_out))return A;}else if(t.match_available){if((i=u._tr_tally(t,0,t.window[t.strstart-1]))&&N(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return A;}else t.match_available=1,t.strstart++,t.lookahead--;}return t.match_available&&(i=u._tr_tally(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<x-1?t.strstart:x-1,e===f?(N(t,!0),0===t.strm.avail_out?O:B):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:I;}function M(t,e,r,i,n){this.good_length=t,this.max_lazy=e,this.nice_length=r,this.max_chain=i,this.func=n;}function H(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=v,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new d.Buf16(2*w),this.dyn_dtree=new d.Buf16(2*(2*a+1)),this.bl_tree=new d.Buf16(2*(2*o+1)),D(this.dyn_ltree),D(this.dyn_dtree),D(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new d.Buf16(k+1),this.heap=new d.Buf16(2*s+1),D(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new d.Buf16(2*s+1),D(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0;}function G(t){var e;return t&&t.state?(t.total_in=t.total_out=0,t.data_type=n,(e=t.state).pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?C:E,t.adler=2===e.wrap?0:1,e.last_flush=l,u._tr_init(e),m):R(t,_);}function K(t){var e=G(t);return e===m&&function(t){t.window_size=2*t.w_size,D(t.head),t.max_lazy_match=h[t.level].max_lazy,t.good_match=h[t.level].good_length,t.nice_match=h[t.level].nice_length,t.max_chain_length=h[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=x-1,t.match_available=0,t.ins_h=0;}(t.state),e;}function Y(t,e,r,i,n,s){if(!t)return _;var a=1;if(e===g&&(e=6),i<0?(a=0,i=-i):15<i&&(a=2,i-=16),n<1||y<n||r!==v||i<8||15<i||e<0||9<e||s<0||b<s)return R(t,_);8===i&&(i=9);var o=new H();return(t.state=o).strm=t,o.wrap=a,o.gzhead=null,o.w_bits=i,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=n+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+x-1)/x),o.window=new d.Buf8(2*o.w_size),o.head=new d.Buf16(o.hash_size),o.prev=new d.Buf16(o.w_size),o.lit_bufsize=1<<n+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new d.Buf8(o.pending_buf_size),o.d_buf=1*o.lit_bufsize,o.l_buf=3*o.lit_bufsize,o.level=e,o.strategy=s,o.method=r,K(t);}h=[new M(0,0,0,0,function(t,e){var r=65535;for(r>t.pending_buf_size-5&&(r=t.pending_buf_size-5);;){if(t.lookahead<=1){if(j(t),0===t.lookahead&&e===l)return A;if(0===t.lookahead)break;}t.strstart+=t.lookahead,t.lookahead=0;var i=t.block_start+r;if((0===t.strstart||t.strstart>=i)&&(t.lookahead=t.strstart-i,t.strstart=i,N(t,!1),0===t.strm.avail_out))return A;if(t.strstart-t.block_start>=t.w_size-z&&(N(t,!1),0===t.strm.avail_out))return A;}return t.insert=0,e===f?(N(t,!0),0===t.strm.avail_out?O:B):(t.strstart>t.block_start&&(N(t,!1),t.strm.avail_out),A);}),new M(4,4,8,4,Z),new M(4,5,16,8,Z),new M(4,6,32,32,Z),new M(4,4,16,16,W),new M(8,16,32,32,W),new M(8,16,128,128,W),new M(8,32,128,256,W),new M(32,128,258,1024,W),new M(32,258,258,4096,W)],r.deflateInit=function(t,e){return Y(t,e,v,15,8,0);},r.deflateInit2=Y,r.deflateReset=K,r.deflateResetKeep=G,r.deflateSetHeader=function(t,e){return t&&t.state?2!==t.state.wrap?_:(t.state.gzhead=e,m):_;},r.deflate=function(t,e){var r,i,n,s;if(!t||!t.state||5<e||e<0)return t?R(t,_):_;if(i=t.state,!t.output||!t.input&&0!==t.avail_in||666===i.status&&e!==f)return R(t,0===t.avail_out?-5:_);if(i.strm=t,r=i.last_flush,i.last_flush=e,i.status===C)if(2===i.wrap)t.adler=0,U(i,31),U(i,139),U(i,8),i.gzhead?(U(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),U(i,255&i.gzhead.time),U(i,i.gzhead.time>>8&255),U(i,i.gzhead.time>>16&255),U(i,i.gzhead.time>>24&255),U(i,9===i.level?2:2<=i.strategy||i.level<2?4:0),U(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(U(i,255&i.gzhead.extra.length),U(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=p(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69):(U(i,0),U(i,0),U(i,0),U(i,0),U(i,0),U(i,9===i.level?2:2<=i.strategy||i.level<2?4:0),U(i,3),i.status=E);else{var a=v+(i.w_bits-8<<4)<<8;a|=(2<=i.strategy||i.level<2?0:i.level<6?1:6===i.level?2:3)<<6,0!==i.strstart&&(a|=32),a+=31-a%31,i.status=E,P(i,a),0!==i.strstart&&(P(i,t.adler>>>16),P(i,65535&t.adler)),t.adler=1;}if(69===i.status)if(i.gzhead.extra){for(n=i.pending;i.gzindex<(65535&i.gzhead.extra.length)&&(i.pending!==i.pending_buf_size||(i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),F(t),n=i.pending,i.pending!==i.pending_buf_size));)U(i,255&i.gzhead.extra[i.gzindex]),i.gzindex++;i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),i.gzindex===i.gzhead.extra.length&&(i.gzindex=0,i.status=73);}else i.status=73;if(73===i.status)if(i.gzhead.name){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),F(t),n=i.pending,i.pending===i.pending_buf_size)){s=1;break;}s=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,U(i,s);}while(0!==s);i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),0===s&&(i.gzindex=0,i.status=91);}else i.status=91;if(91===i.status)if(i.gzhead.comment){n=i.pending;do{if(i.pending===i.pending_buf_size&&(i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),F(t),n=i.pending,i.pending===i.pending_buf_size)){s=1;break;}s=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,U(i,s);}while(0!==s);i.gzhead.hcrc&&i.pending>n&&(t.adler=p(t.adler,i.pending_buf,i.pending-n,n)),0===s&&(i.status=103);}else i.status=103;if(103===i.status&&(i.gzhead.hcrc?(i.pending+2>i.pending_buf_size&&F(t),i.pending+2<=i.pending_buf_size&&(U(i,255&t.adler),U(i,t.adler>>8&255),t.adler=0,i.status=E)):i.status=E),0!==i.pending){if(F(t),0===t.avail_out)return i.last_flush=-1,m;}else if(0===t.avail_in&&T(e)<=T(r)&&e!==f)return R(t,-5);if(666===i.status&&0!==t.avail_in)return R(t,-5);if(0!==t.avail_in||0!==i.lookahead||e!==l&&666!==i.status){var o=2===i.strategy?function(t,e){for(var r;;){if(0===t.lookahead&&(j(t),0===t.lookahead)){if(e===l)return A;break;}if(t.match_length=0,r=u._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,r&&(N(t,!1),0===t.strm.avail_out))return A;}return t.insert=0,e===f?(N(t,!0),0===t.strm.avail_out?O:B):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:I;}(i,e):3===i.strategy?function(t,e){for(var r,i,n,s,a=t.window;;){if(t.lookahead<=S){if(j(t),t.lookahead<=S&&e===l)return A;if(0===t.lookahead)break;}if(t.match_length=0,t.lookahead>=x&&0<t.strstart&&(i=a[n=t.strstart-1])===a[++n]&&i===a[++n]&&i===a[++n]){s=t.strstart+S;do{}while(i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&i===a[++n]&&n<s);t.match_length=S-(s-n),t.match_length>t.lookahead&&(t.match_length=t.lookahead);}if(t.match_length>=x?(r=u._tr_tally(t,1,t.match_length-x),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(r=u._tr_tally(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),r&&(N(t,!1),0===t.strm.avail_out))return A;}return t.insert=0,e===f?(N(t,!0),0===t.strm.avail_out?O:B):t.last_lit&&(N(t,!1),0===t.strm.avail_out)?A:I;}(i,e):h[i.level].func(i,e);if(o!==O&&o!==B||(i.status=666),o===A||o===O)return 0===t.avail_out&&(i.last_flush=-1),m;if(o===I&&(1===e?u._tr_align(i):5!==e&&(u._tr_stored_block(i,0,0,!1),3===e&&(D(i.head),0===i.lookahead&&(i.strstart=0,i.block_start=0,i.insert=0))),F(t),0===t.avail_out))return i.last_flush=-1,m;}return e!==f?m:i.wrap<=0?1:(2===i.wrap?(U(i,255&t.adler),U(i,t.adler>>8&255),U(i,t.adler>>16&255),U(i,t.adler>>24&255),U(i,255&t.total_in),U(i,t.total_in>>8&255),U(i,t.total_in>>16&255),U(i,t.total_in>>24&255)):(P(i,t.adler>>>16),P(i,65535&t.adler)),F(t),0<i.wrap&&(i.wrap=-i.wrap),0!==i.pending?m:1);},r.deflateEnd=function(t){var e;return t&&t.state?(e=t.state.status)!==C&&69!==e&&73!==e&&91!==e&&103!==e&&e!==E&&666!==e?R(t,_):(t.state=null,e===E?R(t,-3):m):_;},r.deflateSetDictionary=function(t,e){var r,i,n,s,a,o,h,u,l=e.length;if(!t||!t.state)return _;if(2===(s=(r=t.state).wrap)||1===s&&r.status!==C||r.lookahead)return _;for(1===s&&(t.adler=c(t.adler,e,l,0)),r.wrap=0,l>=r.w_size&&(0===s&&(D(r.head),r.strstart=0,r.block_start=0,r.insert=0),u=new d.Buf8(r.w_size),d.arraySet(u,e,l-r.w_size,r.w_size,0),e=u,l=r.w_size),a=t.avail_in,o=t.next_in,h=t.input,t.avail_in=l,t.next_in=0,t.input=e,j(r);r.lookahead>=x;){for(i=r.strstart,n=r.lookahead-(x-1);r.ins_h=(r.ins_h<<r.hash_shift^r.window[i+x-1])&r.hash_mask,r.prev[i&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=i,i++,--n;);r.strstart=i,r.lookahead=x-1,j(r);}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=x-1,r.match_available=0,t.next_in=o,t.input=h,t.avail_in=a,r.wrap=s,m;},r.deflateInfo="pako deflate (from Nodeca project)";},{"../utils/common":41,"./adler32":43,"./crc32":45,"./messages":51,"./trees":52}],47:[function(t,e,r){"use strict";e.exports=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1;};},{}],48:[function(t,e,r){"use strict";e.exports=function(t,e){var r,i,n,s,a,o,h,u,l,f,d,c,p,m,_,g,b,v,y,w,k,x,S,z,C;r=t.state,i=t.next_in,z=t.input,n=i+(t.avail_in-5),s=t.next_out,C=t.output,a=s-(e-t.avail_out),o=s+(t.avail_out-257),h=r.dmax,u=r.wsize,l=r.whave,f=r.wnext,d=r.window,c=r.hold,p=r.bits,m=r.lencode,_=r.distcode,g=(1<<r.lenbits)-1,b=(1<<r.distbits)-1;t:do{p<15&&(c+=z[i++]<<p,p+=8,c+=z[i++]<<p,p+=8),v=m[c&g];e:for(;;){if(c>>>=y=v>>>24,p-=y,0===(y=v>>>16&255))C[s++]=65535&v;else{if(!(16&y)){if(0==(64&y)){v=m[(65535&v)+(c&(1<<y)-1)];continue e;}if(32&y){r.mode=12;break t;}t.msg="invalid literal/length code",r.mode=30;break t;}w=65535&v,(y&=15)&&(p<y&&(c+=z[i++]<<p,p+=8),w+=c&(1<<y)-1,c>>>=y,p-=y),p<15&&(c+=z[i++]<<p,p+=8,c+=z[i++]<<p,p+=8),v=_[c&b];r:for(;;){if(c>>>=y=v>>>24,p-=y,!(16&(y=v>>>16&255))){if(0==(64&y)){v=_[(65535&v)+(c&(1<<y)-1)];continue r;}t.msg="invalid distance code",r.mode=30;break t;}if(k=65535&v,p<(y&=15)&&(c+=z[i++]<<p,(p+=8)<y&&(c+=z[i++]<<p,p+=8)),h<(k+=c&(1<<y)-1)){t.msg="invalid distance too far back",r.mode=30;break t;}if(c>>>=y,p-=y,(y=s-a)<k){if(l<(y=k-y)&&r.sane){t.msg="invalid distance too far back",r.mode=30;break t;}if(S=d,(x=0)===f){if(x+=u-y,y<w){for(w-=y;C[s++]=d[x++],--y;);x=s-k,S=C;}}else if(f<y){if(x+=u+f-y,(y-=f)<w){for(w-=y;C[s++]=d[x++],--y;);if(x=0,f<w){for(w-=y=f;C[s++]=d[x++],--y;);x=s-k,S=C;}}}else if(x+=f-y,y<w){for(w-=y;C[s++]=d[x++],--y;);x=s-k,S=C;}for(;2<w;)C[s++]=S[x++],C[s++]=S[x++],C[s++]=S[x++],w-=3;w&&(C[s++]=S[x++],1<w&&(C[s++]=S[x++]));}else{for(x=s-k;C[s++]=C[x++],C[s++]=C[x++],C[s++]=C[x++],2<(w-=3););w&&(C[s++]=C[x++],1<w&&(C[s++]=C[x++]));}break;}}break;}}while(i<n&&s<o);i-=w=p>>3,c&=(1<<(p-=w<<3))-1,t.next_in=i,t.next_out=s,t.avail_in=i<n?n-i+5:5-(i-n),t.avail_out=s<o?o-s+257:257-(s-o),r.hold=c,r.bits=p;};},{}],49:[function(t,e,r){"use strict";var I=t("../utils/common"),O=t("./adler32"),B=t("./crc32"),R=t("./inffast"),T=t("./inftrees"),D=1,F=2,N=0,U=-2,P=1,i=852,n=592;function L(t){return(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);}function s(){this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new I.Buf16(320),this.work=new I.Buf16(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0;}function a(t){var e;return t&&t.state?(e=t.state,t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=P,e.last=0,e.havedict=0,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new I.Buf32(i),e.distcode=e.distdyn=new I.Buf32(n),e.sane=1,e.back=-1,N):U;}function o(t){var e;return t&&t.state?((e=t.state).wsize=0,e.whave=0,e.wnext=0,a(t)):U;}function h(t,e){var r,i;return t&&t.state?(i=t.state,e<0?(r=0,e=-e):(r=1+(e>>4),e<48&&(e&=15)),e&&(e<8||15<e)?U:(null!==i.window&&i.wbits!==e&&(i.window=null),i.wrap=r,i.wbits=e,o(t))):U;}function u(t,e){var r,i;return t?(i=new s(),(t.state=i).window=null,(r=h(t,e))!==N&&(t.state=null),r):U;}var l,f,d=!0;function j(t){if(d){var e;for(l=new I.Buf32(512),f=new I.Buf32(32),e=0;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(T(D,t.lens,0,288,l,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;T(F,t.lens,0,32,f,0,t.work,{bits:5}),d=!1;}t.lencode=l,t.lenbits=9,t.distcode=f,t.distbits=5;}function Z(t,e,r,i){var n,s=t.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new I.Buf8(s.wsize)),i>=s.wsize?(I.arraySet(s.window,e,r-s.wsize,s.wsize,0),s.wnext=0,s.whave=s.wsize):(i<(n=s.wsize-s.wnext)&&(n=i),I.arraySet(s.window,e,r-i,n,s.wnext),(i-=n)?(I.arraySet(s.window,e,r-i,i,0),s.wnext=i,s.whave=s.wsize):(s.wnext+=n,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=n))),0;}r.inflateReset=o,r.inflateReset2=h,r.inflateResetKeep=a,r.inflateInit=function(t){return u(t,15);},r.inflateInit2=u,r.inflate=function(t,e){var r,i,n,s,a,o,h,u,l,f,d,c,p,m,_,g,b,v,y,w,k,x,S,z,C=0,E=new I.Buf8(4),A=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15];if(!t||!t.state||!t.output||!t.input&&0!==t.avail_in)return U;12===(r=t.state).mode&&(r.mode=13),a=t.next_out,n=t.output,h=t.avail_out,s=t.next_in,i=t.input,o=t.avail_in,u=r.hold,l=r.bits,f=o,d=h,x=N;t:for(;;)switch(r.mode){case P:if(0===r.wrap){r.mode=13;break;}for(;l<16;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(2&r.wrap&&35615===u){E[r.check=0]=255&u,E[1]=u>>>8&255,r.check=B(r.check,E,2,0),l=u=0,r.mode=2;break;}if(r.flags=0,r.head&&(r.head.done=!1),!(1&r.wrap)||(((255&u)<<8)+(u>>8))%31){t.msg="incorrect header check",r.mode=30;break;}if(8!=(15&u)){t.msg="unknown compression method",r.mode=30;break;}if(l-=4,k=8+(15&(u>>>=4)),0===r.wbits)r.wbits=k;else if(k>r.wbits){t.msg="invalid window size",r.mode=30;break;}r.dmax=1<<k,t.adler=r.check=1,r.mode=512&u?10:12,l=u=0;break;case 2:for(;l<16;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(r.flags=u,8!=(255&r.flags)){t.msg="unknown compression method",r.mode=30;break;}if(57344&r.flags){t.msg="unknown header flags set",r.mode=30;break;}r.head&&(r.head.text=u>>8&1),512&r.flags&&(E[0]=255&u,E[1]=u>>>8&255,r.check=B(r.check,E,2,0)),l=u=0,r.mode=3;case 3:for(;l<32;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.head&&(r.head.time=u),512&r.flags&&(E[0]=255&u,E[1]=u>>>8&255,E[2]=u>>>16&255,E[3]=u>>>24&255,r.check=B(r.check,E,4,0)),l=u=0,r.mode=4;case 4:for(;l<16;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.head&&(r.head.xflags=255&u,r.head.os=u>>8),512&r.flags&&(E[0]=255&u,E[1]=u>>>8&255,r.check=B(r.check,E,2,0)),l=u=0,r.mode=5;case 5:if(1024&r.flags){for(;l<16;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.length=u,r.head&&(r.head.extra_len=u),512&r.flags&&(E[0]=255&u,E[1]=u>>>8&255,r.check=B(r.check,E,2,0)),l=u=0;}else r.head&&(r.head.extra=null);r.mode=6;case 6:if(1024&r.flags&&(o<(c=r.length)&&(c=o),c&&(r.head&&(k=r.head.extra_len-r.length,r.head.extra||(r.head.extra=new Array(r.head.extra_len)),I.arraySet(r.head.extra,i,s,c,k)),512&r.flags&&(r.check=B(r.check,i,c,s)),o-=c,s+=c,r.length-=c),r.length))break t;r.length=0,r.mode=7;case 7:if(2048&r.flags){if(0===o)break t;for(c=0;k=i[s+c++],r.head&&k&&r.length<65536&&(r.head.name+=String.fromCharCode(k)),k&&c<o;);if(512&r.flags&&(r.check=B(r.check,i,c,s)),o-=c,s+=c,k)break t;}else r.head&&(r.head.name=null);r.length=0,r.mode=8;case 8:if(4096&r.flags){if(0===o)break t;for(c=0;k=i[s+c++],r.head&&k&&r.length<65536&&(r.head.comment+=String.fromCharCode(k)),k&&c<o;);if(512&r.flags&&(r.check=B(r.check,i,c,s)),o-=c,s+=c,k)break t;}else r.head&&(r.head.comment=null);r.mode=9;case 9:if(512&r.flags){for(;l<16;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(u!==(65535&r.check)){t.msg="header crc mismatch",r.mode=30;break;}l=u=0;}r.head&&(r.head.hcrc=r.flags>>9&1,r.head.done=!0),t.adler=r.check=0,r.mode=12;break;case 10:for(;l<32;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}t.adler=r.check=L(u),l=u=0,r.mode=11;case 11:if(0===r.havedict)return t.next_out=a,t.avail_out=h,t.next_in=s,t.avail_in=o,r.hold=u,r.bits=l,2;t.adler=r.check=1,r.mode=12;case 12:if(5===e||6===e)break t;case 13:if(r.last){u>>>=7&l,l-=7&l,r.mode=27;break;}for(;l<3;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}switch(r.last=1&u,l-=1,3&(u>>>=1)){case 0:r.mode=14;break;case 1:if(j(r),r.mode=20,6!==e)break;u>>>=2,l-=2;break t;case 2:r.mode=17;break;case 3:t.msg="invalid block type",r.mode=30;}u>>>=2,l-=2;break;case 14:for(u>>>=7&l,l-=7&l;l<32;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if((65535&u)!=(u>>>16^65535)){t.msg="invalid stored block lengths",r.mode=30;break;}if(r.length=65535&u,l=u=0,r.mode=15,6===e)break t;case 15:r.mode=16;case 16:if(c=r.length){if(o<c&&(c=o),h<c&&(c=h),0===c)break t;I.arraySet(n,i,s,c,a),o-=c,s+=c,h-=c,a+=c,r.length-=c;break;}r.mode=12;break;case 17:for(;l<14;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(r.nlen=257+(31&u),u>>>=5,l-=5,r.ndist=1+(31&u),u>>>=5,l-=5,r.ncode=4+(15&u),u>>>=4,l-=4,286<r.nlen||30<r.ndist){t.msg="too many length or distance symbols",r.mode=30;break;}r.have=0,r.mode=18;case 18:for(;r.have<r.ncode;){for(;l<3;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.lens[A[r.have++]]=7&u,u>>>=3,l-=3;}for(;r.have<19;)r.lens[A[r.have++]]=0;if(r.lencode=r.lendyn,r.lenbits=7,S={bits:r.lenbits},x=T(0,r.lens,0,19,r.lencode,0,r.work,S),r.lenbits=S.bits,x){t.msg="invalid code lengths set",r.mode=30;break;}r.have=0,r.mode=19;case 19:for(;r.have<r.nlen+r.ndist;){for(;g=(C=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,b=65535&C,!((_=C>>>24)<=l);){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(b<16)u>>>=_,l-=_,r.lens[r.have++]=b;else{if(16===b){for(z=_+2;l<z;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(u>>>=_,l-=_,0===r.have){t.msg="invalid bit length repeat",r.mode=30;break;}k=r.lens[r.have-1],c=3+(3&u),u>>>=2,l-=2;}else if(17===b){for(z=_+3;l<z;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}l-=_,k=0,c=3+(7&(u>>>=_)),u>>>=3,l-=3;}else{for(z=_+7;l<z;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}l-=_,k=0,c=11+(127&(u>>>=_)),u>>>=7,l-=7;}if(r.have+c>r.nlen+r.ndist){t.msg="invalid bit length repeat",r.mode=30;break;}for(;c--;)r.lens[r.have++]=k;}}if(30===r.mode)break;if(0===r.lens[256]){t.msg="invalid code -- missing end-of-block",r.mode=30;break;}if(r.lenbits=9,S={bits:r.lenbits},x=T(D,r.lens,0,r.nlen,r.lencode,0,r.work,S),r.lenbits=S.bits,x){t.msg="invalid literal/lengths set",r.mode=30;break;}if(r.distbits=6,r.distcode=r.distdyn,S={bits:r.distbits},x=T(F,r.lens,r.nlen,r.ndist,r.distcode,0,r.work,S),r.distbits=S.bits,x){t.msg="invalid distances set",r.mode=30;break;}if(r.mode=20,6===e)break t;case 20:r.mode=21;case 21:if(6<=o&&258<=h){t.next_out=a,t.avail_out=h,t.next_in=s,t.avail_in=o,r.hold=u,r.bits=l,R(t,d),a=t.next_out,n=t.output,h=t.avail_out,s=t.next_in,i=t.input,o=t.avail_in,u=r.hold,l=r.bits,12===r.mode&&(r.back=-1);break;}for(r.back=0;g=(C=r.lencode[u&(1<<r.lenbits)-1])>>>16&255,b=65535&C,!((_=C>>>24)<=l);){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(g&&0==(240&g)){for(v=_,y=g,w=b;g=(C=r.lencode[w+((u&(1<<v+y)-1)>>v)])>>>16&255,b=65535&C,!(v+(_=C>>>24)<=l);){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}u>>>=v,l-=v,r.back+=v;}if(u>>>=_,l-=_,r.back+=_,r.length=b,0===g){r.mode=26;break;}if(32&g){r.back=-1,r.mode=12;break;}if(64&g){t.msg="invalid literal/length code",r.mode=30;break;}r.extra=15&g,r.mode=22;case 22:if(r.extra){for(z=r.extra;l<z;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.length+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra;}r.was=r.length,r.mode=23;case 23:for(;g=(C=r.distcode[u&(1<<r.distbits)-1])>>>16&255,b=65535&C,!((_=C>>>24)<=l);){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(0==(240&g)){for(v=_,y=g,w=b;g=(C=r.distcode[w+((u&(1<<v+y)-1)>>v)])>>>16&255,b=65535&C,!(v+(_=C>>>24)<=l);){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}u>>>=v,l-=v,r.back+=v;}if(u>>>=_,l-=_,r.back+=_,64&g){t.msg="invalid distance code",r.mode=30;break;}r.offset=b,r.extra=15&g,r.mode=24;case 24:if(r.extra){for(z=r.extra;l<z;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}r.offset+=u&(1<<r.extra)-1,u>>>=r.extra,l-=r.extra,r.back+=r.extra;}if(r.offset>r.dmax){t.msg="invalid distance too far back",r.mode=30;break;}r.mode=25;case 25:if(0===h)break t;if(c=d-h,r.offset>c){if((c=r.offset-c)>r.whave&&r.sane){t.msg="invalid distance too far back",r.mode=30;break;}p=c>r.wnext?(c-=r.wnext,r.wsize-c):r.wnext-c,c>r.length&&(c=r.length),m=r.window;}else m=n,p=a-r.offset,c=r.length;for(h<c&&(c=h),h-=c,r.length-=c;n[a++]=m[p++],--c;);0===r.length&&(r.mode=21);break;case 26:if(0===h)break t;n[a++]=r.length,h--,r.mode=21;break;case 27:if(r.wrap){for(;l<32;){if(0===o)break t;o--,u|=i[s++]<<l,l+=8;}if(d-=h,t.total_out+=d,r.total+=d,d&&(t.adler=r.check=r.flags?B(r.check,n,d,a-d):O(r.check,n,d,a-d)),d=h,(r.flags?u:L(u))!==r.check){t.msg="incorrect data check",r.mode=30;break;}l=u=0;}r.mode=28;case 28:if(r.wrap&&r.flags){for(;l<32;){if(0===o)break t;o--,u+=i[s++]<<l,l+=8;}if(u!==(4294967295&r.total)){t.msg="incorrect length check",r.mode=30;break;}l=u=0;}r.mode=29;case 29:x=1;break t;case 30:x=-3;break t;case 31:return-4;case 32:default:return U;}return t.next_out=a,t.avail_out=h,t.next_in=s,t.avail_in=o,r.hold=u,r.bits=l,(r.wsize||d!==t.avail_out&&r.mode<30&&(r.mode<27||4!==e))&&Z(t,t.output,t.next_out,d-t.avail_out)?(r.mode=31,-4):(f-=t.avail_in,d-=t.avail_out,t.total_in+=f,t.total_out+=d,r.total+=d,r.wrap&&d&&(t.adler=r.check=r.flags?B(r.check,n,d,t.next_out-d):O(r.check,n,d,t.next_out-d)),t.data_type=r.bits+(r.last?64:0)+(12===r.mode?128:0)+(20===r.mode||15===r.mode?256:0),(0==f&&0===d||4===e)&&x===N&&(x=-5),x);},r.inflateEnd=function(t){if(!t||!t.state)return U;var e=t.state;return e.window&&(e.window=null),t.state=null,N;},r.inflateGetHeader=function(t,e){var r;return t&&t.state?0==(2&(r=t.state).wrap)?U:((r.head=e).done=!1,N):U;},r.inflateSetDictionary=function(t,e){var r,i=e.length;return t&&t.state?0!==(r=t.state).wrap&&11!==r.mode?U:11===r.mode&&O(1,e,i,0)!==r.check?-3:Z(t,e,i,i)?(r.mode=31,-4):(r.havedict=1,N):U;},r.inflateInfo="pako inflate (from Nodeca project)";},{"../utils/common":41,"./adler32":43,"./crc32":45,"./inffast":48,"./inftrees":50}],50:[function(t,e,r){"use strict";var D=t("../utils/common"),F=[3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0],N=[16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78],U=[1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0],P=[16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64];e.exports=function(t,e,r,i,n,s,a,o){var h,u,l,f,d,c,p,m,_,g=o.bits,b=0,v=0,y=0,w=0,k=0,x=0,S=0,z=0,C=0,E=0,A=null,I=0,O=new D.Buf16(16),B=new D.Buf16(16),R=null,T=0;for(b=0;b<=15;b++)O[b]=0;for(v=0;v<i;v++)O[e[r+v]]++;for(k=g,w=15;1<=w&&0===O[w];w--);if(w<k&&(k=w),0===w)return n[s++]=20971520,n[s++]=20971520,o.bits=1,0;for(y=1;y<w&&0===O[y];y++);for(k<y&&(k=y),b=z=1;b<=15;b++)if(z<<=1,(z-=O[b])<0)return-1;if(0<z&&(0===t||1!==w))return-1;for(B[1]=0,b=1;b<15;b++)B[b+1]=B[b]+O[b];for(v=0;v<i;v++)0!==e[r+v]&&(a[B[e[r+v]]++]=v);if(c=0===t?(A=R=a,19):1===t?(A=F,I-=257,R=N,T-=257,256):(A=U,R=P,-1),b=y,d=s,S=v=E=0,l=-1,f=(C=1<<(x=k))-1,1===t&&852<C||2===t&&592<C)return 1;for(;;){for(p=b-S,_=a[v]<c?(m=0,a[v]):a[v]>c?(m=R[T+a[v]],A[I+a[v]]):(m=96,0),h=1<<b-S,y=u=1<<x;n[d+(E>>S)+(u-=h)]=p<<24|m<<16|_|0,0!==u;);for(h=1<<b-1;E&h;)h>>=1;if(0!==h?(E&=h-1,E+=h):E=0,v++,0==--O[b]){if(b===w)break;b=e[r+a[v]];}if(k<b&&(E&f)!==l){for(0===S&&(S=k),d+=y,z=1<<(x=b-S);x+S<w&&!((z-=O[x+S])<=0);)x++,z<<=1;if(C+=1<<x,1===t&&852<C||2===t&&592<C)return 1;n[l=E&f]=k<<24|x<<16|d-s|0;}}return 0!==E&&(n[d+E]=b-S<<24|64<<16|0),o.bits=k,0;};},{"../utils/common":41}],51:[function(t,e,r){"use strict";e.exports={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"};},{}],52:[function(t,e,r){"use strict";var n=t("../utils/common"),o=0,h=1;function i(t){for(var e=t.length;0<=--e;)t[e]=0;}var s=0,a=29,u=256,l=u+1+a,f=30,d=19,_=2*l+1,g=15,c=16,p=7,m=256,b=16,v=17,y=18,w=[0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0],k=[0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13],x=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7],S=[16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15],z=new Array(2*(l+2));i(z);var C=new Array(2*f);i(C);var E=new Array(512);i(E);var A=new Array(256);i(A);var I=new Array(a);i(I);var O,B,R,T=new Array(f);function D(t,e,r,i,n){this.static_tree=t,this.extra_bits=e,this.extra_base=r,this.elems=i,this.max_length=n,this.has_stree=t&&t.length;}function F(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e;}function N(t){return t<256?E[t]:E[256+(t>>>7)];}function U(t,e){t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255;}function P(t,e,r){t.bi_valid>c-r?(t.bi_buf|=e<<t.bi_valid&65535,U(t,t.bi_buf),t.bi_buf=e>>c-t.bi_valid,t.bi_valid+=r-c):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=r);}function L(t,e,r){P(t,r[2*e],r[2*e+1]);}function j(t,e){for(var r=0;r|=1&t,t>>>=1,r<<=1,0<--e;);return r>>>1;}function Z(t,e,r){var i,n,s=new Array(g+1),a=0;for(i=1;i<=g;i++)s[i]=a=a+r[i-1]<<1;for(n=0;n<=e;n++){var o=t[2*n+1];0!==o&&(t[2*n]=j(s[o]++,o));}}function W(t){var e;for(e=0;e<l;e++)t.dyn_ltree[2*e]=0;for(e=0;e<f;e++)t.dyn_dtree[2*e]=0;for(e=0;e<d;e++)t.bl_tree[2*e]=0;t.dyn_ltree[2*m]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0;}function M(t){8<t.bi_valid?U(t,t.bi_buf):0<t.bi_valid&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0;}function H(t,e,r,i){var n=2*e,s=2*r;return t[n]<t[s]||t[n]===t[s]&&i[e]<=i[r];}function G(t,e,r){for(var i=t.heap[r],n=r<<1;n<=t.heap_len&&(n<t.heap_len&&H(e,t.heap[n+1],t.heap[n],t.depth)&&n++,!H(e,i,t.heap[n],t.depth));)t.heap[r]=t.heap[n],r=n,n<<=1;t.heap[r]=i;}function K(t,e,r){var i,n,s,a,o=0;if(0!==t.last_lit)for(;i=t.pending_buf[t.d_buf+2*o]<<8|t.pending_buf[t.d_buf+2*o+1],n=t.pending_buf[t.l_buf+o],o++,0===i?L(t,n,e):(L(t,(s=A[n])+u+1,e),0!==(a=w[s])&&P(t,n-=I[s],a),L(t,s=N(--i),r),0!==(a=k[s])&&P(t,i-=T[s],a)),o<t.last_lit;);L(t,m,e);}function Y(t,e){var r,i,n,s=e.dyn_tree,a=e.stat_desc.static_tree,o=e.stat_desc.has_stree,h=e.stat_desc.elems,u=-1;for(t.heap_len=0,t.heap_max=_,r=0;r<h;r++)0!==s[2*r]?(t.heap[++t.heap_len]=u=r,t.depth[r]=0):s[2*r+1]=0;for(;t.heap_len<2;)s[2*(n=t.heap[++t.heap_len]=u<2?++u:0)]=1,t.depth[n]=0,t.opt_len--,o&&(t.static_len-=a[2*n+1]);for(e.max_code=u,r=t.heap_len>>1;1<=r;r--)G(t,s,r);for(n=h;r=t.heap[1],t.heap[1]=t.heap[t.heap_len--],G(t,s,1),i=t.heap[1],t.heap[--t.heap_max]=r,t.heap[--t.heap_max]=i,s[2*n]=s[2*r]+s[2*i],t.depth[n]=(t.depth[r]>=t.depth[i]?t.depth[r]:t.depth[i])+1,s[2*r+1]=s[2*i+1]=n,t.heap[1]=n++,G(t,s,1),2<=t.heap_len;);t.heap[--t.heap_max]=t.heap[1],function(t,e){var r,i,n,s,a,o,h=e.dyn_tree,u=e.max_code,l=e.stat_desc.static_tree,f=e.stat_desc.has_stree,d=e.stat_desc.extra_bits,c=e.stat_desc.extra_base,p=e.stat_desc.max_length,m=0;for(s=0;s<=g;s++)t.bl_count[s]=0;for(h[2*t.heap[t.heap_max]+1]=0,r=t.heap_max+1;r<_;r++)p<(s=h[2*h[2*(i=t.heap[r])+1]+1]+1)&&(s=p,m++),h[2*i+1]=s,u<i||(t.bl_count[s]++,a=0,c<=i&&(a=d[i-c]),o=h[2*i],t.opt_len+=o*(s+a),f&&(t.static_len+=o*(l[2*i+1]+a)));if(0!==m){do{for(s=p-1;0===t.bl_count[s];)s--;t.bl_count[s]--,t.bl_count[s+1]+=2,t.bl_count[p]--,m-=2;}while(0<m);for(s=p;0!==s;s--)for(i=t.bl_count[s];0!==i;)u<(n=t.heap[--r])||(h[2*n+1]!==s&&(t.opt_len+=(s-h[2*n+1])*h[2*n],h[2*n+1]=s),i--);}}(t,e),Z(s,u,t.bl_count);}function X(t,e,r){var i,n,s=-1,a=e[1],o=0,h=7,u=4;for(0===a&&(h=138,u=3),e[2*(r+1)+1]=65535,i=0;i<=r;i++)n=a,a=e[2*(i+1)+1],++o<h&&n===a||(o<u?t.bl_tree[2*n]+=o:0!==n?(n!==s&&t.bl_tree[2*n]++,t.bl_tree[2*b]++):o<=10?t.bl_tree[2*v]++:t.bl_tree[2*y]++,s=n,u=(o=0)===a?(h=138,3):n===a?(h=6,3):(h=7,4));}function V(t,e,r){var i,n,s=-1,a=e[1],o=0,h=7,u=4;for(0===a&&(h=138,u=3),i=0;i<=r;i++)if(n=a,a=e[2*(i+1)+1],!(++o<h&&n===a)){if(o<u)for(;L(t,n,t.bl_tree),0!=--o;);else 0!==n?(n!==s&&(L(t,n,t.bl_tree),o--),L(t,b,t.bl_tree),P(t,o-3,2)):o<=10?(L(t,v,t.bl_tree),P(t,o-3,3)):(L(t,y,t.bl_tree),P(t,o-11,7));s=n,u=(o=0)===a?(h=138,3):n===a?(h=6,3):(h=7,4);}}i(T);var q=!1;function J(t,e,r,i){P(t,(s<<1)+(i?1:0),3),function(t,e,r,i){M(t),i&&(U(t,r),U(t,~r)),n.arraySet(t.pending_buf,t.window,e,r,t.pending),t.pending+=r;}(t,e,r,!0);}r._tr_init=function(t){q||(function(){var t,e,r,i,n,s=new Array(g+1);for(i=r=0;i<a-1;i++)for(I[i]=r,t=0;t<1<<w[i];t++)A[r++]=i;for(A[r-1]=i,i=n=0;i<16;i++)for(T[i]=n,t=0;t<1<<k[i];t++)E[n++]=i;for(n>>=7;i<f;i++)for(T[i]=n<<7,t=0;t<1<<k[i]-7;t++)E[256+n++]=i;for(e=0;e<=g;e++)s[e]=0;for(t=0;t<=143;)z[2*t+1]=8,t++,s[8]++;for(;t<=255;)z[2*t+1]=9,t++,s[9]++;for(;t<=279;)z[2*t+1]=7,t++,s[7]++;for(;t<=287;)z[2*t+1]=8,t++,s[8]++;for(Z(z,l+1,s),t=0;t<f;t++)C[2*t+1]=5,C[2*t]=j(t,5);O=new D(z,w,u+1,l,g),B=new D(C,k,0,f,g),R=new D(new Array(0),x,0,d,p);}(),q=!0),t.l_desc=new F(t.dyn_ltree,O),t.d_desc=new F(t.dyn_dtree,B),t.bl_desc=new F(t.bl_tree,R),t.bi_buf=0,t.bi_valid=0,W(t);},r._tr_stored_block=J,r._tr_flush_block=function(t,e,r,i){var n,s,a=0;0<t.level?(2===t.strm.data_type&&(t.strm.data_type=function(t){var e,r=4093624447;for(e=0;e<=31;e++,r>>>=1)if(1&r&&0!==t.dyn_ltree[2*e])return o;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return h;for(e=32;e<u;e++)if(0!==t.dyn_ltree[2*e])return h;return o;}(t)),Y(t,t.l_desc),Y(t,t.d_desc),a=function(t){var e;for(X(t,t.dyn_ltree,t.l_desc.max_code),X(t,t.dyn_dtree,t.d_desc.max_code),Y(t,t.bl_desc),e=d-1;3<=e&&0===t.bl_tree[2*S[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e;}(t),n=t.opt_len+3+7>>>3,(s=t.static_len+3+7>>>3)<=n&&(n=s)):n=s=r+5,r+4<=n&&-1!==e?J(t,e,r,i):4===t.strategy||s===n?(P(t,2+(i?1:0),3),K(t,z,C)):(P(t,4+(i?1:0),3),function(t,e,r,i){var n;for(P(t,e-257,5),P(t,r-1,5),P(t,i-4,4),n=0;n<i;n++)P(t,t.bl_tree[2*S[n]+1],3);V(t,t.dyn_ltree,e-1),V(t,t.dyn_dtree,r-1);}(t,t.l_desc.max_code+1,t.d_desc.max_code+1,a+1),K(t,t.dyn_ltree,t.dyn_dtree)),W(t),i&&M(t);},r._tr_tally=function(t,e,r){return t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&r,t.last_lit++,0===e?t.dyn_ltree[2*r]++:(t.matches++,e--,t.dyn_ltree[2*(A[r]+u+1)]++,t.dyn_dtree[2*N(e)]++),t.last_lit===t.lit_bufsize-1;},r._tr_align=function(t){P(t,2,3),L(t,m,z),function(t){16===t.bi_valid?(U(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):8<=t.bi_valid&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8);}(t);};},{"../utils/common":41}],53:[function(t,e,r){"use strict";e.exports=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0;};},{}],54:[function(t,e,r){"use strict";e.exports="function"==typeof setImmediate?setImmediate:function(){var t=[].slice.apply(arguments);t.splice(1,0,0),setTimeout.apply(null,t);};},{}]},{},[10])(10);});/*
CryptoJS v3.1.2
code.google.com/p/crypto-js
(c) 2009-2013 by Jeff Mott. All rights reserved.
code.google.com/p/crypto-js/wiki/License
*/var CryptoJS=CryptoJS||function(e,m){var p={},j=p.lib={},l=function(){},f=j.Base={extend:function(a){l.prototype=this;var c=new l();a&&c.mixIn(a);c.hasOwnProperty("init")||(c.init=function(){c.$super.init.apply(this,arguments);});c.init.prototype=c;c.$super=this;return c;},create:function(){var a=this.extend();a.init.apply(a,arguments);return a;},init:function(){},mixIn:function(a){for(var c in a)a.hasOwnProperty(c)&&(this[c]=a[c]);a.hasOwnProperty("toString")&&(this.toString=a.toString);},clone:function(){return this.init.prototype.extend(this);}},n=j.WordArray=f.extend({init:function(a,c){a=this.words=a||[];this.sigBytes=c!=m?c:4*a.length;},toString:function(a){return(a||h).stringify(this);},concat:function(a){var c=this.words,q=a.words,d=this.sigBytes;a=a.sigBytes;this.clamp();if(d%4)for(var b=0;b<a;b++)c[d+b>>>2]|=(q[b>>>2]>>>24-8*(b%4)&255)<<24-8*((d+b)%4);else if(65535<q.length)for(b=0;b<a;b+=4)c[d+b>>>2]=q[b>>>2];else c.push.apply(c,q);this.sigBytes+=a;return this;},clamp:function(){var a=this.words,c=this.sigBytes;a[c>>>2]&=4294967295<<32-8*(c%4);a.length=e.ceil(c/4);},clone:function(){var a=f.clone.call(this);a.words=this.words.slice(0);return a;},random:function(a){for(var c=[],b=0;b<a;b+=4)c.push(4294967296*e.random()|0);return new n.init(c,a);}}),b=p.enc={},h=b.Hex={stringify:function(a){var c=a.words;a=a.sigBytes;for(var b=[],d=0;d<a;d++){var f=c[d>>>2]>>>24-8*(d%4)&255;b.push((f>>>4).toString(16));b.push((f&15).toString(16));}return b.join("");},parse:function(a){for(var c=a.length,b=[],d=0;d<c;d+=2)b[d>>>3]|=parseInt(a.substr(d,2),16)<<24-4*(d%8);return new n.init(b,c/2);}},g=b.Latin1={stringify:function(a){var c=a.words;a=a.sigBytes;for(var b=[],d=0;d<a;d++)b.push(String.fromCharCode(c[d>>>2]>>>24-8*(d%4)&255));return b.join("");},parse:function(a){for(var c=a.length,b=[],d=0;d<c;d++)b[d>>>2]|=(a.charCodeAt(d)&255)<<24-8*(d%4);return new n.init(b,c);}},r=b.Utf8={stringify:function(a){try{return decodeURIComponent(escape(g.stringify(a)));}catch(c){throw Error("Malformed UTF-8 data");}},parse:function(a){return g.parse(unescape(encodeURIComponent(a)));}},k=j.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new n.init();this._nDataBytes=0;},_append:function(a){"string"==typeof a&&(a=r.parse(a));this._data.concat(a);this._nDataBytes+=a.sigBytes;},_process:function(a){var c=this._data,b=c.words,d=c.sigBytes,f=this.blockSize,h=d/(4*f),h=a?e.ceil(h):e.max((h|0)-this._minBufferSize,0);a=h*f;d=e.min(4*a,d);if(a){for(var g=0;g<a;g+=f)this._doProcessBlock(b,g);g=b.splice(0,a);c.sigBytes-=d;}return new n.init(g,d);},clone:function(){var a=f.clone.call(this);a._data=this._data.clone();return a;},_minBufferSize:0});j.Hasher=k.extend({cfg:f.extend(),init:function(a){this.cfg=this.cfg.extend(a);this.reset();},reset:function(){k.reset.call(this);this._doReset();},update:function(a){this._append(a);this._process();return this;},finalize:function(a){a&&this._append(a);return this._doFinalize();},blockSize:16,_createHelper:function(a){return function(c,b){return new a.init(b).finalize(c);};},_createHmacHelper:function(a){return function(b,f){return new s.HMAC.init(a,f).finalize(b);};}});var s=p.algo={};return p;}(Math);(function(){var e=CryptoJS,m=e.lib,p=m.WordArray,j=m.Hasher,l=[],m=e.algo.SHA1=j.extend({_doReset:function(){this._hash=new p.init([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(f,n){for(var b=this._hash.words,h=b[0],g=b[1],e=b[2],k=b[3],j=b[4],a=0;80>a;a++){if(16>a)l[a]=f[n+a]|0;else{var c=l[a-3]^l[a-8]^l[a-14]^l[a-16];l[a]=c<<1|c>>>31;}c=(h<<5|h>>>27)+j+l[a];c=20>a?c+((g&e|~g&k)+1518500249):40>a?c+((g^e^k)+1859775393):60>a?c+((g&e|g&k|e&k)-1894007588):c+((g^e^k)-899497514);j=k;k=e;e=g<<30|g>>>2;g=h;h=c;}b[0]=b[0]+h|0;b[1]=b[1]+g|0;b[2]=b[2]+e|0;b[3]=b[3]+k|0;b[4]=b[4]+j|0;},_doFinalize:function(){var f=this._data,e=f.words,b=8*this._nDataBytes,h=8*f.sigBytes;e[h>>>5]|=128<<24-h%32;e[(h+64>>>9<<4)+14]=Math.floor(b/4294967296);e[(h+64>>>9<<4)+15]=b;f.sigBytes=4*e.length;this._process();return this._hash;},clone:function(){var e=j.clone.call(this);e._hash=this._hash.clone();return e;}});e.SHA1=j._createHelper(m);e.HmacSHA1=j._createHmacHelper(m);})();// Non più usata. Da cancellare. Era un tentativo di raccogliere delle definizioni
// di materiali Babylon JS
var Zakeke=Zakeke||{};Zakeke.MaterialLibrary={materialNames:["stainless steel","gold"],getMaterial:function(name,scene){switch(name){case"stainless steel":return this.getStainlessSteel(scene);case"gold":return this.getGold(scene);}return null;},getStainlessSteel:function(scene){var name=this.getUnusedMaterialName("steel",scene);var material=new BABYLON.StandardMaterial(name,scene);material.id=Zakeke.generateUUID();material.reflectionTexture=new BABYLON.CubeTexture("../Content/textures/cubemaps/yokohama/Yokohama",scene);material.diffuseColor=new BABYLON.Color3(0,0,0);material.specularPower=128;material.reflectionFresnelParameters=new BABYLON.FresnelParameters();material.reflectionFresnelParameters.power=2;material.reflectionFresnelParameters.leftColor=new BABYLON.Color3(1,1,1);material.reflectionFresnelParameters.rightColor=BABYLON.Color3.White();return material;},getGold:function(scene){var name=this.getUnusedMaterialName("gold",scene);var material=new BABYLON.StandardMaterial(name,scene);material.id=Zakeke.generateUUID();material.reflectionTexture=new BABYLON.CubeTexture("../Content/textures/cubemaps/yokohama_dark/Yokohama",scene);//material.reflectionTexture.hasAlpha = true;
//material.diffuseColor = new BABYLON.Color3(0, 0, 0);
material.diffuseColor=new BABYLON.Color3(204/255,153/255,0);//material.specularPower = 128;
material.specularPower=12;material.reflectionFresnelParameters=new BABYLON.FresnelParameters();material.reflectionFresnelParameters.power=2;material.reflectionFresnelParameters.leftColor=new BABYLON.Color3(1,1,1);material.reflectionFresnelParameters.rightColor=BABYLON.Color3.White();return material;},getUnusedMaterialName:function(prefix,scene){var count=1;var name=prefix+" - "+count;var mat=scene.getMaterialByName(name);while(mat){count++;name=prefix+" - "+count;mat=scene.getMaterialByName(name);}return name;}};/*
Zakeke.MaterialLibrary = function (scene) {
    this.scene = scene;
    this.materialNames = ["stainless steel", "gold"];
}

Zakeke.MaterialLibrary.prototype = {

    getMaterial: function (name) {
        switch (name) {
            case "stainless steel":
                return this.getStainlessSteel();
            case "gold":
                return this.getGold();
        }
        return null;
    },

    getStainlessSteel: function () {

        var material = new BABYLON.StandardMaterial("steel-"+Zakeke.makeID(), this.scene);

        material.reflectionTexture = new BABYLON.CubeTexture("../Content/textures/cubemaps/yokohama/Yokohama", this.scene);
        material.diffuseColor = new BABYLON.Color3(0, 0, 0);
        material.specularPower = 128;
        material.reflectionFresnelParameters = new BABYLON.FresnelParameters();
        material.reflectionFresnelParameters.power = 2;
        material.reflectionFresnelParameters.leftColor = new BABYLON.Color3(1, 1, 1);
        material.reflectionFresnelParameters.rightColor = BABYLON.Color3.White();

        return material;
    },

    getGold: function () {
        var material = new BABYLON.StandardMaterial("steel", this.scene);

        material.reflectionTexture = new BABYLON.CubeTexture("../Content/textures/cubemaps/yokohama_dark/Yokohama", this.scene);
        //material.reflectionTexture.hasAlpha = true;
        //material.diffuseColor = new BABYLON.Color3(0, 0, 0);
        material.diffuseColor = new BABYLON.Color3(204 / 255, 153 / 255, 0);
        //material.specularPower = 128;
        material.specularPower = 12;
        material.reflectionFresnelParameters = new BABYLON.FresnelParameters();
        material.reflectionFresnelParameters.power = 2;
        material.reflectionFresnelParameters.leftColor = new BABYLON.Color3(1, 1, 1);
        material.reflectionFresnelParameters.rightColor = BABYLON.Color3.White();

        return material;
    }
}
*/ // -----------------------------------------------------------
// Utility functions
// -----------------------------------------------------------
var Zakeke=Zakeke||{};Zakeke.isIPhoneX=function(){// Really basic check for the ios platform
// https://stackoverflow.com/questions/9038625/detect-if-device-is-ios
var iOS=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;// Get the device pixel ratio
var ratio=window.devicePixelRatio||1;// Define the users device screen dimensions
var screen={width:window.screen.width*ratio,height:window.screen.height*ratio};// iPhone X Detection
if(iOS&&screen.width===1125&&screen.height===2436){return true;}else{return false;}};// Get Viewport
Zakeke.getViewport=function(){var m=document.compatMode==='CSS1Compat';return{l:window.pageXOffset||(m?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(m?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(m?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(m?document.documentElement.clientHeight:document.body.clientHeight)};};Zakeke.getContrastYIQ=function(r,g,b){var yiq=(r*299+g*587+b*114)/1000;return yiq>=128?'black':'white';};Zakeke.getContrastYIQHex=function(hexcolor){var r=parseInt(hexcolor.substr(0,2),16);var g=parseInt(hexcolor.substr(2,2),16);var b=parseInt(hexcolor.substr(4,2),16);var yiq=(r*299+g*587+b*114)/1000;return yiq>=128?'black':'white';};Zakeke.arrayContains=function(array,itemToSearch){if(itemToSearch==undefined||itemToSearch==null)return false;if(Object.prototype.toString.call(array)!=='[object Array]')return false;var contains=function(needle){// Per spec, the way to identify NaN is that it is not equal to itself
var findNaN=needle!==needle;var indexOf;if(!findNaN&&typeof Array.prototype.indexOf==='function'){indexOf=Array.prototype.indexOf;}else{indexOf=function(needle){var i=-1,index=-1;for(i=0;i<this.length;i++){var item=this[i];if(findNaN&&item!==item||item===needle){index=i;break;}}return index;};}return indexOf.call(this,needle)>-1;};return contains.call(array,itemToSearch);};Zakeke.getColorBrightness=function(hex){// validate hex string
hex=String(hex).replace(/[^0-9a-f]/gi,'');if(hex.length<6){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];}var r=parseInt(hex.substr(0*2,2),16);var g=parseInt(hex.substr(1*2,2),16);var b=parseInt(hex.substr(2*2,2),16);var brightness=Math.sqrt(r*r*0.241+g*g*0.691+b*b*0.068);return brightness;};Zakeke.isColorDark=function(hex){return Zakeke.getColorBrightness(hex)<130;};// hex — a hex color value such as “#abc” or “#123456” (the hash is optional)
// lum — the luminosity factor, i.e. -0.1 is 10% darker, 0.2 is 20% lighter, etc.
Zakeke.changeColorLuminosity=function ColorLuminance(hex,lum){// validate hex string
hex=String(hex).replace(/[^0-9a-f]/gi,'');if(hex.length<6){hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];}lum=lum||0;// convert to decimal and change luminosity
var rgb="#",c,i;for(i=0;i<3;i++){c=parseInt(hex.substr(i*2,2),16);c=Math.round(Math.min(Math.max(0,c+c*lum),255)).toString(16);rgb+=("00"+c).substr(c.length);}return rgb;};Zakeke.cropImageTransparency=function(imageDataURI,targetWidth,targetHeight,callback){var img=new Image();var $canvas=$("<canvas>");// create an offscreen canvas
var canvas=$canvas[0];var context=canvas.getContext("2d");var removeBlanks=function(imgWidth,imgHeight){var imageData=context.getImageData(0,0,canvas.width,canvas.height),data=imageData.data,getAlpha=function(x,y){return data[(imgWidth*y+x)*4+3];},getRBGA=function(x,y){return{red:data[(imgWidth*y+x)*4],green:data[(imgWidth*y+x)*4+1],blue:data[(imgWidth*y+x)*4+2],alpha:data[(imgWidth*y+x)*4+3]};},isTransparent=function(alpha){return alpha==0;},scanY=function(fromTop){var offset=fromTop?1:-1;// loop through each row
for(var y=fromTop?0:imgHeight-1;fromTop?y<imgHeight:y>-1;y+=offset){// loop through each column
for(var x=0;x<imgWidth;x++){if(!isTransparent(getAlpha(x,y))){return y;}}}return null;// all image is transparent
},scanX=function(fromLeft){var offset=fromLeft?1:-1;// loop through each column
for(var x=fromLeft?0:imgWidth-1;fromLeft?x<imgWidth:x>-1;x+=offset){// loop through each row
for(var y=0;y<imgHeight;y++){if(!isTransparent(getAlpha(x,y))){return x;}}}return null;// all image is transparent
};var cropTop=scanY(true);var cropBottom=scanY(false);var cropLeft=scanX(true);var cropRight=scanX(false);var cropWidth=cropRight-cropLeft;var cropHeight=cropBottom-cropTop;// Matain proportions in canvas
var canvasWidth=targetWidth;var canvasHeight=targetHeight;var ratioX=canvasWidth/cropWidth;var ratioY=canvasHeight/cropHeight;var finalWidth=cropWidth*ratioX;var finalHeight=cropHeight*ratioX;if(finalHeight>canvasHeight){finalWidth=cropWidth*ratioY;finalHeight=cropHeight*ratioY;}var $croppedCanvas=$("<canvas>").attr({width:canvasWidth,height:canvasHeight});$croppedCanvas[0].getContext("2d").drawImage(canvas,cropLeft,cropTop,cropWidth,cropHeight,(canvasWidth-finalWidth)/2,(canvasHeight-finalHeight)/2,finalWidth,finalHeight);var croppedCanvas=$croppedCanvas[0];var croppedContext=$croppedCanvas[0].getContext("2d");var croppedImageData=croppedContext.getImageData(0,0,croppedCanvas.width,croppedCanvas.height);var croppedDataUrl=croppedCanvas.toDataURL();if(callback)callback(croppedDataUrl);};img.crossOrigin="anonymous";img.onload=function(){$canvas.attr({width:this.width,height:this.height});context=canvas.getContext("2d");if(context){context.drawImage(this,0,0);removeBlanks(this.width,this.height);}else{alert('Get a real browser!');}};img.src=imageDataURI;};Zakeke.getColorImage=function(hex,width,height){var $canvas=$("<canvas>");// create an offscreen canvas
$canvas.attr({width:width,height:height});var canvas=$canvas[0];var context=canvas.getContext("2d");context.fillStyle=hex;context.fillRect(0,0,width,height);var dataUrl=canvas.toDataURL();return dataUrl;};/**
 * Split a string into chunks of the given size
 * @param  {String} str is the String to split
 * @param  {Number} size is the size you of the cuts
 * @return {Array} an Array with the strings
 */Zakeke.chunkString=function(str,size){//return str.match(new RegExp('.|[\\r\\n]){1,' + length + '}', 'g'));
// Rollup will try to execute this function with str as undefined. IDK
if(!str)return null;return str.match(new RegExp('.[^]{1,'+size+'}','g'));};Zakeke.getStringHashCode=function(str){var hash=0,i,chr;if(str.length===0)return hash;for(i=0;i<str.length;i++){chr=str.charCodeAt(i);hash=(hash<<5)-hash+chr;hash|=0;// Convert to 32bit integer
}return hash;};var MPlaza=MPlaza||{};// -----------------------------------------------------------
// Utility functions
// -----------------------------------------------------------
MPlaza.EmptyUUID="00000000-0000-0000-0000-000000000000";MPlaza.generateUUID=function(){var d=new Date().getTime();var uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c=='x'?r:r&0x7|0x8).toString(16);});return uuid;};MPlaza.getContrastYIQ=function(r,g,b){var yiq=(r*299+g*587+b*114)/1000;return yiq>=128?'black':'white';};MPlaza.getContrastYIQHex=function(hexcolor){var r=parseInt(hexcolor.substr(0,2),16);var g=parseInt(hexcolor.substr(2,2),16);var b=parseInt(hexcolor.substr(4,2),16);var yiq=(r*299+g*587+b*114)/1000;return yiq>=128?'black':'white';};MPlaza.makeID=function(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text;};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// Enums
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MPlaza.PricingModel={Simple:1,Advanced:2,RuleBased:3};MPlaza.PricingType={Undefined:1,Global:2,PerColor:3};MPlaza.PricingApplicationType={Undefined:1,Global:2,PerSide:3,PerArea:4};MPlaza.AttributeType={Options:1,Color:2,Number:3,String:4};MPlaza.LogicalOperator={AND:"AND",OR:"OR"};MPlaza.ComparisonOperator={Equal:"Equal",NotEqual:"NotEqual",In:"In",NotIn:"NotIn"};MPlaza.SceneElementType={None:0,Mesh:1,Material:2,Light:4,Camera:8,CameraLocation:16,SubMesh:32};MPlaza.SceneElementType.All=MPlaza.SceneElementType.Mesh|MPlaza.SceneElementType.Material|MPlaza.SceneElementType.Light|MPlaza.SceneElementType.Camera|MPlaza.SceneElementType.CameraLocation|MPlaza.SceneElementType.SubMesh;MPlaza.SceneActionType={Filter:1,ShowHideMesh:2,SetMeshMaterial:3,SetMaterialColor:4,SetCameraLocation:5,AdjustCamera:6,SetSubMeshMaterial:7,SetCameraPivot:8,ResetCameraPivot:9,EnableDiableZoom:10,SetMeshDesignMaterial:11,SetMeshDesignEffect:12};MPlaza.PaddingType={Start:1,End:2,StartEnd:3};MPlaza.AttributeOptionPreviewShape={Rectangle:1,Circle:2};MPlaza.AttributeGroupDirection={Horizontal:0,Vertical:1};MPlaza.DeviceType={Any:0,PC:1,Phone:2,Tablet:4};MPlaza.DeviceType.All=MPlaza.DeviceType.PC|MPlaza.DeviceType.Phone|MPlaza.DeviceType.Tablet;MPlaza.ExtensionFieldDataType={Money:1,Integer:2,Decimal:3};MPlaza.ExtensionFieldOperationType={None:1,Addition:2};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Temp state interface
// -----------------------------------------------------------
var TempStateObjectInterface={tempState:null,initTempState:function(){this.tempState=this.clone();this.callToTempStateChildren("initTempState");},applyTempState:function(){if(this.tempState)this.set(this.tempState.attributes);this.callToTempStateChildren("applyTempState");},resetTempState:function(){this.tempState=null;},childHasTempState:function(child){if(child&&child.hasOwnProperty("tempState"))return true;else return false;},hasTempStateChildren:function(){if(this.tempStateChildren&&Array.isArray(this.tempStateChildren)&&this.tempStateChildren.length>0)return true;else return false;},callToTempStateChildren:function(callback){if(!this.hasTempStateChildren()||!this.tempState)return;for(var i=0;i<this.tempStateChildren.length;i++){var child=this.tempState.get(this.tempStateChildren[i]);if(this.childHasTempState(child)&&callback)child[callback]();}}};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// UserIdentity
// -----------------------------------------------------------
MPlaza.UserIdentity=Backbone.AssociatedModel.extend({defaults:{nominative:"",token:""},idAttribute:"userID",initialize:function(){},url:function(){var urlRoot=Zakeke.config.baseApiUrl+'login';return urlRoot;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeProposition
// -----------------------------------------------------------
MPlaza.AttributeProposition=Backbone.AssociatedModel.extend({defaults:{attributeGuid:"",op:"Equal",value:""},initialize:function(){},relations:[],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// AttributePropositions
// -----------------------------------------------------------
MPlaza.AttributePropositions=Backbone.Collection.extend({model:MPlaza.AttributeProposition});// -----------------------------------------------------------
// AttributeExpression
// -----------------------------------------------------------
MPlaza.AttributeExpression=Backbone.AssociatedModel.extend({defaults:{op:"AND",propositions:null,expressions:null},initialize:function(){var model=this;// Gestisco il fetch, in quel caso gli array sono pieni e non vanno reinizializzati.
if(!this.get("propositions"))this.set("propositions",[]);if(!this.get("expressions"))this.set("expressions",[]);this.get("propositions").parentModel=this;this.get('expressions').parentModel=this;},getAllAttributeGuids:function(){var guids=[];var addPropositionGuids=function(proposition){var guid=proposition.attributeGuid;if(!Zakeke.arrayContains(guids,guid))guids.push(guid);};var addExpressionGuids=function(expression){for(var i=0;i<expression.propositions.length;i++){var prop=expression.proposition[i];addPropositionGuids(prop);}};for(var i=0;i<this.get("propositions").length;i++){var prop=this.get("propositions")[i];addPropositionGuids(prop);}for(var i=0;i<this.get("expressions").length;i++){var expr=this.get("expressions")[i];addExpressionGuids(expr);}return guids;},isEmpty:function(){return this.get("propositions").length==0&&this.get("expressions").length==0;}});// -----------------------------------------------------------
// AttributeExpressions
// -----------------------------------------------------------
MPlaza.AttributeExpressions=Backbone.Collection.extend({model:MPlaza.AttributeExpression});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeSelectionColor
// -----------------------------------------------------------
MPlaza.AttributeSelectionColor=Backbone.AssociatedModel.extend({defaults:{selectionExpression:null,colorID:-1},idAttribute:"selectionID"});// -----------------------------------------------------------
// AttributeSelectionColors
// -----------------------------------------------------------
MPlaza.AttributeSelectionColors=Backbone.Collection.extend({model:MPlaza.AttributeSelectionColor,getAttributeSelectionColor:function(selectionID){for(var i=0;i<this.length;i++){var attributeSelectionColor=this.at(i);if(attributeSelectionColor.get("selectionID")==selectionID)return attributeSelectionColor;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ComposerPricingPrice
// -----------------------------------------------------------
MPlaza.ComposerPricingPrice=Backbone.AssociatedModel.extend({defaults:{qtyFrom:0,qtyTo:null,price:0},idAttribute:"priceID",initialize:function(){},relations:[],getPricingID:function(){if(this.collection&&this.collection.getPricingID){return this.collection.getPricingID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ComposerPricingPrices
// -----------------------------------------------------------
MPlaza.ComposerPricingPrices=Backbone.Collection.extend({model:MPlaza.ComposerPricingPrice,getPricingID:function(){if(this.parentModel&&this.parentModel.getPricingID){return this.parentModel.getPricingID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ComposerPricing
// -----------------------------------------------------------
MPlaza.ComposerPricing=Backbone.AssociatedModel.extend({defaults:{prices:[]},// modificare in docID per salvare su NoSQL
//idAttribute: "designID",
idAttribute:"pricingID",initialize:function(){var model=this;this.get("prices").parentModel=this;this.on("change",function(){model._fireEvent("change");});this.get("prices").on("add",function(){model._fireEvent("change");});this.get("prices").on("remove",function(){model._fireEvent("change");});this.get("prices").on("change",function(){model._fireEvent("change");});},_eventListeners:{change:[]},_fireEvent:function(eventName,e){if(this._eventListeners&&_.isObject(this._eventListeners)&&_.has(this._eventListeners,eventName)&&_.isArray(this._eventListeners[eventName])){var listeners=this._eventListeners[eventName];for(var i=0;i<listeners.length;++i){listeners[i](e);}}},trigger:function(eventName){this._fireEvent(eventName);},addEventListener:function(eventName,listenerFunction){if(this._eventListeners&&_.isObject(this._eventListeners)){if(!_.has(this._eventListeners,eventName)){this._eventListeners[eventName]=[];}this._eventListeners[eventName].push(listenerFunction);}},relations:[{type:Backbone.Many,key:'prices',collectionType:MPlaza.ComposerPricingPrices}],url:function(){// da modificare per utilizzare NoSQL
// url: pricings/<pricingID>
var urlRoot=Zakeke.config.baseApiUrl+'composerpricings';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getPricingID:function(){return this.get("pricingID");},toString:function(){// todo.......
},getComposerPricingPriceForQuantity:function(quantity){for(var i=0;i<this.get("prices").length;i++){var price=this.get("prices").at(i);if(price.get("qtyFrom")<=quantity&&(!price.get("qtyTo")||quantity<price.get("qtyTo"))){return price;}}return null;}});// -----------------------------------------------------------
// ComposerPricings
// -----------------------------------------------------------
MPlaza.ComposerPricings=Backbone.Collection.extend({model:MPlaza.ComposerPricing,url:function(){return Zakeke.config.baseApiUrl+'composerpricings';},getComposerPricing:function(pricingID){for(var i=0;i<this.length;i++){var pricing=this.at(i);if(pricing.get("pricingID")==pricingID)return pricing;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributePricing
// -----------------------------------------------------------
MPlaza.AttributePricing=Backbone.AssociatedModel.extend({defaults:{selectedOptionID:null,selectedOptionGuid:null,selectedValue:"",constraintExpression:null,price:0,pricingID:-1// ComposerPricing.PricingID
},idAttribute:"attributePricingID",initialize:function(){var model=this;},resetIDs:function(){this.unset("attributePricingID");},relations:[{type:Backbone.One,key:'constraintExpression',relatedModel:MPlaza.AttributeExpression}]});// -----------------------------------------------------------
// AttributePricings
// -----------------------------------------------------------
MPlaza.AttributePricings=Backbone.Collection.extend({model:MPlaza.AttributePricing,resetIDs:function(){for(var i=0;i<this.length;i++){var pricing=this.at(i);pricing.resetIDs();}}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeSceneAction
// -----------------------------------------------------------
MPlaza.AttributeSceneAction=Backbone.AssociatedModel.extend({defaults:{//actionGuid: "",
name:"",actionTypeID:MPlaza.SceneActionType.ShowHideMesh,sceneElementTypeID:MPlaza.SceneElementType.Mesh,selector:"",propertyName:"",value:"",execOrder:0,deviceTypes:MPlaza.DeviceType.Any},idAttribute:"actionID",initialize:function(){if(!this.get("actionGuid")){this.set("actionGuid",MPlaza.generateUUID());}},relations:[],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},resetIDs:function(){this.tempID=Zakeke.generateUUID();this.unset("actionID");}});// -----------------------------------------------------------
// AttributeSceneActions
// -----------------------------------------------------------
MPlaza.AttributeSceneActions=Backbone.Collection.extend({model:MPlaza.AttributeSceneAction,resetIDs:function(){for(var i=0;i<this.length;i++){var action=this.at(i);action.resetIDs();}},comparator:function(model){return model.get("execOrder");},getActionByID:function(actionID){for(var i=0;i<this.length;i++){var action=this.at(i);if(action.get("actionID")===actionID)return action;}return null;},getActionByGuid:function(actionGuid){for(var i=0;i<this.length;i++){var action=this.at(i);if(action.get("actionGuid")===actionGuid)return action;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeOptionExtensionField
// -----------------------------------------------------------
MPlaza.AttributeOptionExtensionField=Backbone.AssociatedModel.extend({defaults:{name:"",dataTypeID:MPlaza.ExtensionFieldDataType.Integer,operationTypeID:MPlaza.ExtensionFieldOperationType.Addition,label:"",formatString:"",value:""},idAttribute:"extensionFieldID",relations:[],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},resetIDs:function(){this.unset("extensionFieldID");}});// -----------------------------------------------------------
// AttributeOptionExtensionFields
// -----------------------------------------------------------
MPlaza.AttributeOptionExtensionFields=Backbone.Collection.extend({model:MPlaza.AttributeOptionExtensionField,resetIDs:function(){for(var i=0;i<this.length;i++){var optionExtensionField=this.at(i);optionExtensionField.resetIDs();}}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeOption
// -----------------------------------------------------------
MPlaza.AttributeOption=Backbone.AssociatedModel.extend({defaults:{optionCode:"",tempImageFileKey:"",imageUrl:"",imageFileObjectID:-1,tempImageFileObjectID:-1,displayOrder:0,name:"",description:"",isDefault:false,constraintExpression:null,actions:[],optionExtensionFields:[]},idAttribute:"optionID",initialize:function(){var model=this;this.get("actions").parentModel=this;this.get("optionExtensionFields").parentModel=this;if(!this.get("optionGuid")){this.set("optionGuid",MPlaza.generateUUID());}},relations:[{type:Backbone.Many,key:'actions',collectionType:MPlaza.AttributeSceneActions},{type:Backbone.One,key:'constraintExpression',relatedModel:MPlaza.AttributeExpression},{type:Backbone.Many,key:'optionExtensionFields',collectionType:MPlaza.AttributeOptionExtensionFields}],resetIDs:function(){this.tempID=Zakeke.generateUUID();this.unset("optionID");this.set("optionGuid",MPlaza.generateUUID());this.get("actions").resetIDs();this.get("optionExtensionFields").resetIDs();},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},getPricings:function(){var pricings=[];var attribute=this.getParentModel();if(attribute){pricings=attribute.getOptionPricings(this.get("optionGuid"));}return pricings;},addSimplePricing:function(price,constraintExpression){var attribute=this.getParentModel();if(attribute){var pricing=new MPlaza.AttributePricing();if(this.get("optionID"))pricing.set("selectedOptionID",this.get("optionID"));pricing.set("selectedOptionGuid",this.get("optionGuid"));if(constraintExpression&&constraintExpression instanceof MPlaza.AttributeExpression)pricing.set("constraintExpression",constraintExpression);pricing.set("price",price);attribute.get("pricings").add(pricing);return pricing;}return null;},addAdvancedPricing:function(composerPricing,constraintExpression){var attribute=this.getParentModel();if(attribute&&composerPricing&&composerPricing instanceof MPlaza.ComposerPricing){var pricing=new MPlaza.AttributePricing();if(this.get("optionID"))pricing.set("selectedOptionID",this.get("optionID"));pricing.set("selectedOptionGuid",this.get("optionGuid"));if(constraintExpression&&constraintExpression instanceof MPlaza.AttributeExpression)pricing.set("constraintExpression",constraintExpression);pricing.set("pricingID",composerPricing.get("pricingID"));attribute.get("pricings").add(pricing);}},removePricing:function(attributePricing){var attribute=this.getParentModel();if(attribute){attribute.get("pricings").remove(attributePricing);}},getActionByID:function(actionID){return this.get("actions").getActionByID(actionID);},getExtensionField:function(fieldID){return this.get("extensionFields")&&this.get("extensionFields").filter(item=>item.extensionFieldID===fieldID)[0];},getExtensionFields:function(){return this.get("extensionFields");},getActionByGuid:function(actionGuid){return this.get("actions").getActionByGuid(actionGuid);}});// -----------------------------------------------------------
// AttributeOptions
// -----------------------------------------------------------
MPlaza.AttributeOptions=Backbone.Collection.extend({model:MPlaza.AttributeOption,comparator:function(model){return model.get("displayOrder");},resetIDs:function(){for(var i=0;i<this.length;i++){var option=this.at(i);option.resetIDs();}}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Attribute
// -----------------------------------------------------------
MPlaza.Attribute=Backbone.AssociatedModel.extend({defaults:{//attributeGuid: "",
attributeCode:"",attributeTypeID:MPlaza.AttributeType.Options,name:"",description:"",groupID:-1,groupGuid:MPlaza.EmptyUUID,stepID:-1,stepGuid:MPlaza.EmptyUUID,defaultValue:"",displayOrder:0,optionPreviewShapeID:MPlaza.AttributeOptionPreviewShape.Rectangle,options:[],preActions:[],valueActions:[],postActions:[],pricings:[],constraintExpression:null,meshSelector:"",sceneCameraLocationID:MPlaza.EmptyUUID,hideOptionsLabel:false},idAttribute:"attributeID",initialize:function(){var model=this;if(!this.get("attributeGuid")){this.set("attributeGuid",MPlaza.generateUUID());}this.get("options").parentModel=this;this.get("preActions").parentModel=this;this.get('valueActions').parentModel=this;this.get('postActions').parentModel=this;this.get('pricings').parentModel=this;},relations:[{type:Backbone.Many,key:'options',collectionType:MPlaza.AttributeOptions},{type:Backbone.Many,key:'preActions',collectionType:MPlaza.AttributeSceneActions},{type:Backbone.Many,key:'valueActions',collectionType:MPlaza.AttributeSceneActions},{type:Backbone.Many,key:'postActions',collectionType:MPlaza.AttributeSceneActions},{type:Backbone.Many,key:'pricings',collectionType:MPlaza.AttributePricings},{type:Backbone.One,key:'constraintExpression',relatedModel:MPlaza.AttributeExpression}],getOption:function(optionID){return this.get("options").findWhere({optionID:optionID});},getOptionByGuid:function(optionGuid){return this.get("options").findWhere({optionGuid:optionGuid});},getOptionByCode:function(optionCode){if(!optionCode)return null;for(var i=0;i<this.get("options").length;i++){var option=this.get("options").at(i);if(option.get("optionCode")&&option.get("optionCode")===optionCode)return option;}return null;},cloneAttribute:function(newName){// Get all options pricings indexes
const pricings=[];for(let i=0;i<this.get('options').length;i++){const option=this.get('options').at(i);const pricing=this.get('pricings').find(x=>x.get('selectedOptionGuid')===option.get('optionGuid'));if(pricing){pricings.push({optionIndex:this.get('options').indexOf(option),pricingIndex:this.get('pricings').indexOf(pricing)});}}var clone=this.clone();if(newName!==undefined)clone.set("name",newName);for(var i=0;i<this.get("options").length;i++){var option=this.get("options").at(i);var clonedOption=clone.get("options").at(i);clonedOption.resetIDs();clonedOption.set("tempImageFileObjectID",option.get("imageFileObjectID"));}clone.resetIDs();// Assign the new correct guids
for(const{optionIndex,pricingIndex}of pricings){const option=clone.get('options').at(optionIndex);const pricing=clone.get('pricings').at(pricingIndex);pricing.set('selectedOptionID',option.get('optionID'));;pricing.set('selectedOptionGuid',option.get('optionGuid'));}return clone;},addClonedOption:function(originalOption,newName){var clone=originalOption.clone();if(newName!==undefined)clone.set("name",newName);clone.resetIDs();clone.set("isDefault",false);clone.set("tempImageFileObjectID",originalOption.get("imageFileObjectID"));this.get("options").add(clone);// Clone pricing
const pricingOriginal=this.get('pricings').find(x=>x.get('selectedOptionGuid')===originalOption.get('optionGuid'));if(pricingOriginal){const pricingClone=pricingOriginal.clone();pricingClone.resetIDs();pricingClone.set('selectedOptionID',clone.get('optionID'));;pricingClone.set('selectedOptionGuid',clone.get('optionGuid'));this.get('pricings').add(pricingClone);}return clone;},getOptionPricings:function(optionGuid){return this.get("pricings").where({selectedOptionGuid:optionGuid});},resetIDs:function(){this.tempID=Zakeke.generateUUID();this.unset("attributeID");this.set("attributeGuid",MPlaza.generateUUID());this.get("options").resetIDs();this.get("pricings").resetIDs();}});// -----------------------------------------------------------
// Attributes
// -----------------------------------------------------------
MPlaza.Attributes=Backbone.Collection.extend({model:MPlaza.Attribute,getAttribute:function(attributeID){for(var i=0;i<this.length;i++){var attribute=this.at(i);if(attribute.get("attributeID")===attributeID)return attribute;}return null;},getAttributeByGuid:function(attributeGuid){for(var i=0;i<this.length;i++){var attribute=this.at(i);if(attribute.get("attributeGuid")===attributeGuid)return attribute;}return null;},getAttributeByCode:function(attributeCode){for(var i=0;i<this.length;i++){var attribute=this.at(i);if(attribute.get("attributeCode")===attributeCode)return attribute;}return null;},comparator:function(model){return model.get('displayOrder');}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeGroup
// -----------------------------------------------------------
MPlaza.AttributeGroup=Backbone.AssociatedModel.extend({defaults:{tempImageFileKey:"",imageUrl:"",name:"",displayOrder:0,sceneCameraLocationID:MPlaza.EmptyUUID,meshSelector:"",direction:0,attributesAlwaysOpened:false},idAttribute:"groupID",initialize:function(){if(!this.get("groupGuid")){this.set("groupGuid",MPlaza.generateUUID());}},relations:[],resetIDs:function(){this.tempID=Zakeke.generateUUID();this.unset("groupID");this.set("groupGuid",MPlaza.generateUUID());},cloneGroup:function(newName){var clone=this.clone();if(newName!==undefined)clone.set("name",newName);clone.resetIDs();return clone;}});// -----------------------------------------------------------
// AttributeGroups
// -----------------------------------------------------------
MPlaza.AttributeGroups=Backbone.Collection.extend({model:MPlaza.AttributeGroup});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// AttributeStep
// -----------------------------------------------------------
MPlaza.AttributeStep=Backbone.AssociatedModel.extend({defaults:{groupID:-1,groupGuid:null,name:"",displayOrder:0},idAttribute:"stepID",initialize:function(){if(!this.get("stepGuid")){this.set("stepGuid",MPlaza.generateUUID());}},relations:[],resetIDs:function(){this.tempID=Zakeke.generateUUID();this.unset("stepID");this.set("stepGuid",MPlaza.generateUUID());},cloneStep:function(newName){var clone=this.clone();if(newName!==undefined)clone.set("name",newName);clone.resetIDs();return clone;}});// -----------------------------------------------------------
// AttributeSteps
// -----------------------------------------------------------
MPlaza.AttributeSteps=Backbone.Collection.extend({model:MPlaza.AttributeStep,comparator:function(model){return model.get("displayOrder");}});// -----------------------------------------------------------
// ExtensionField
// -----------------------------------------------------------
MPlaza.ExtensionField=Backbone.AssociatedModel.extend({defaults:{fieldID:null,name:"",dataTypeID:MPlaza.ExtensionFieldDataType.Integer,operationTypeID:MPlaza.ExtensionFieldOperationType.None,dataTypeName:"",operationTypeName:"",label:"",formatString:""},idAttribute:"fieldID",relations:[],resetIDs:function(){this.unset("fieldID");},url:function(){if(this.id!==null){return Zakeke.config.baseApiUrl+'extensionFields/'+this.id;}else{return Zakeke.config.baseApiUrl+'extensionFields/';}}});// -----------------------------------------------------------
// SellerSetting
// -----------------------------------------------------------
MPlaza.SellerSetting=Backbone.AssociatedModel.extend({defaults:{sellerID:null,minimumFractionDigits:2,isCompositionRecapEnabled:false,isCompositionRecapVisibleFromStart:false,canUserCloseCompositionRecap:false,hotJarSiteID:null,googleTagManagerID:null},idAttribute:"sellerID",relations:[],resetIDs:function(){this.unset("sellerID");},url:function(){return Zakeke.config.baseApiUrl+'sellerSetting/';}});// -----------------------------------------------------------
// ExtensionFields
// -----------------------------------------------------------
MPlaza.ExtensionFields=Backbone.AssociatedModel.extend({model:MPlaza.ExtensionField,url:function(){return Zakeke.config.baseApiUrl+'extensionFields';}});// -----------------------------------------------------------
// DiffuseConfig
// -----------------------------------------------------------
MPlaza.DiffuseConfig=Backbone.AssociatedModel.extend({defaults:{enabled:true,blendMode:"normal",// normal, multiply, overlay
level:1// 0 = down, 1 = up
},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// OpacityConfig
// -----------------------------------------------------------
MPlaza.OpacityConfig=Backbone.AssociatedModel.extend({defaults:{enabled:true},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// MeshDesignGeneralConfig
// -----------------------------------------------------------
MPlaza.MeshDesignGeneralConfig=Backbone.AssociatedModel.extend({defaults:{showDesign:false},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// InnerShadowConfig
// -----------------------------------------------------------
MPlaza.InnerShadowConfig=Backbone.AssociatedModel.extend({defaults:{enabled:false,color:"#000000",angle:135,distance:2.0,size:5.0},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// OuterShadowConfig
// -----------------------------------------------------------
MPlaza.OuterShadowConfig=Backbone.AssociatedModel.extend({defaults:{enabled:false,color:"#000000",angle:135,distance:2.0,size:5.0},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// NormalmapConfig
// -----------------------------------------------------------
MPlaza.NormalmapConfig=Backbone.AssociatedModel.extend({defaults:{showDesign:true,showOnDesign:true,showOnMesh:true,bias:50.0,invertR:false,invertG:false,preBlurEnabled:false,preBlur:1,postBlurEnabled:false,postBlur:1,intensity:0.5,bevel:true},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// MeshDesignConfig
// -----------------------------------------------------------
MPlaza.MeshDesignConfig=Backbone.AssociatedModel.extend({defaults:{general:null,diffuse:null,opacity:null,normalmap:null,innerShadow:null,outerShadow:null},initialize:function(){if(this.get("general"))this.get("general").parentModel=this;if(this.get("diffuse"))this.get("diffuse").parentModel=this;if(this.get("opacity"))this.get("opacity").parentModel=this;if(this.get("normalmap"))this.get("normalmap").parentModel=this;if(this.get("innerShadow"))this.get("innerShadow").parentModel=this;if(this.get("outerShadow"))this.get("outerShadow").parentModel=this;},relations:[{type:Backbone.One,key:'general',relatedModel:MPlaza.MeshDesignGeneralConfig},{type:Backbone.One,key:'diffuse',relatedModel:MPlaza.DiffuseConfig},{type:Backbone.One,key:'opacity',relatedModel:MPlaza.OpacityConfig},{type:Backbone.One,key:'normalmap',relatedModel:MPlaza.NormalmapConfig},{type:Backbone.One,key:'innerShadow',relatedModel:MPlaza.InnerShadowConfig},{type:Backbone.One,key:'outerShadow',relatedModel:MPlaza.OuterShadowConfig}],getParentModel:function(){return this.parentModel;},toString:function(){},getGeneralConfig:function(){if(this.get("general")&&this.get("general")instanceof MPlaza.MeshDesignGeneralConfig)return this.get("general");return null;},getOrCreateGeneralConfig:function(){var generalConfig=this.get("general");if(!generalConfig){generalConfig=new MPlaza.MeshDesignGeneralConfig();this.set("general",generalConfig);}return generalConfig;},getShowDesign:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("showDesign");return true;},setShowDesign:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("showDesign",value);},getDiffuseConfig:function(){if(this.get("diffuse")&&this.get("diffuse")instanceof MPlaza.DiffuseConfig)return this.get("diffuse");return null;},getOrCreateDiffuseConfing:function(){var diffuseConfig=this.get("diffuse");if(!diffuseConfig){diffuseConfig=new MPlaza.DiffuseConfig();this.set("diffuse",diffuseConfig);}return diffuseConfig;},getDiffuseEnabled:function(){var diffuseConfig=this.getDiffuseConfig();if(diffuseConfig)return diffuseConfig.get("enabled");return true;},setDiffuseEnabled:function(value){var diffuseConfig=this.getOrCreateDiffuseConfing();diffuseConfig.set("enabled",value);},getDiffuseBlendMode:function(){var diffuseConfig=this.getDiffuseConfig();if(diffuseConfig&&diffuseConfig.get("blendMode"))return diffuseConfig.get("blendMode");return"normal";},setDiffuseBlendMode:function(value){var diffuseConfig=this.getOrCreateDiffuseConfing();diffuseConfig.set("blendMode",value);},getDiffuseLevel:function(){var diffuseConfig=this.getDiffuseConfig();if(diffuseConfig&&diffuseConfig.get("level")!=undefined&&diffuseConfig.get("level")!=null)return diffuseConfig.get("level");return 1;},setDiffuseLevel:function(value){var diffuseConfig=this.getOrCreateDiffuseConfing();diffuseConfig.set("level",value);},getOpacityConfig:function(){if(this.get("opacity")&&this.get("opacity")instanceof MPlaza.OpacityConfig)return this.get("opacity");return null;},getOrCreateOpacityConfig:function(){var opacityConfig=this.get("opacity");if(!opacityConfig){opacityConfig=new MPlaza.OpacityConfig();this.set("opacity",opacityConfig);}return opacityConfig;},getOpacityEnabled:function(){var opacityConfig=this.getOpacityConfig();if(opacityConfig)return opacityConfig.get("enabled");return false;},setOpacityEnabled:function(value){var opacityConfig=this.getOrCreateOpacityConfig();opacityConfig.set("enabled",value);},getNormalmapConfig:function(){if(this.get("normalmap")&&this.get("normalmap")instanceof MPlaza.NormalmapConfig)return this.get("normalmap");return null;},getOrCreateNormalmapConfig:function(){var normalmapConfig=this.get("normalmap");if(!normalmapConfig){normalmapConfig=new MPlaza.NormalmapConfig();this.set("normalmap",normalmapConfig);}return normalmapConfig;},getNormalmapEnabled:function(){var normalmapConfig=this.getNormalmapConfig();if(normalmapConfig)return normalmapConfig.get("enabled");return false;},setNormalmapEnabled:function(value){var normalmapConfig=this.getOrCreateNormalmapConfig();normalmapConfig.set("enabled",value);},getInnerShadowConfig:function(){if(this.get("innerShadow")&&this.get("innerShadow")instanceof MPlaza.InnerShadowConfig)return this.get("innerShadow");return null;},getOrCreateInnerShadowConfig:function(){var innerShadowConfig=this.get("innerShadow");if(!innerShadowConfig){innerShadowConfig=new MPlaza.InnerShadowConfig();this.set("innerShadow",innerShadowConfig);}return innerShadowConfig;},getInnerShadowEnabled:function(){var innerShadowConfig=this.getInnerShadowConfig();if(innerShadowConfig)return innerShadowConfig.get("enabled");return false;},setInnerShadowEnabled:function(value){var innerShadowConfig=this.getOrCreateInnerShadowConfig();innerShadowConfig.set("enabled",value);},getOuterShadowConfig:function(){if(this.get("outerShadow")&&this.get("outerShadow")instanceof MPlaza.OuterShadowConfig)return this.get("outerShadow");return null;},getOrCreateOuterShadowConfig:function(){var outerShadowConfig=this.get("outerShadow");if(!outerShadowConfig){outerShadowConfig=new MPlaza.OuterShadowConfig();this.set("outerShadow",outerShadowConfig);}return outerShadowConfig;},getOuterShadowEnabled:function(){var outerShadowConfig=this.getOuterShadowConfig();if(outerShadowConfig)return outerShadowConfig.get("enabled");return false;},setOuterShadowEnabled:function(value){var outerShadowConfig=this.getOrCreateOuterShadowConfig();outerShadowConfig.set("enabled",value);}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ModelSceneMeshSide
// -----------------------------------------------------------
MPlaza.ModelSceneMeshSide=Backbone.AssociatedModel.extend({defaults:{meshID:"",subMeshID:0,sideID:-1,matrix:"",percWidth:1,percHeight:1,uvChannel:0,materialID:null,materialTexture:"",config:null},idAttribute:"key",initialize:function(){},relations:[{type:Backbone.One,key:'config',relatedModel:MPlaza.MeshDesignConfig}],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},getConfig:function(){return this.get("config");},getOrCreateConfig:function(){var config=this.getConfig();if(!config){config=new MPlaza.MeshDesignConfig();this.set("config",config);}return config;}});// -----------------------------------------------------------
// ModelSceneMeshSides
// -----------------------------------------------------------
MPlaza.ModelSceneMeshSides=Backbone.Collection.extend({model:MPlaza.ModelSceneMeshSide});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ModelSceneMeshDesignEffect
// -----------------------------------------------------------
MPlaza.ModelSceneMeshDesignEffect=Backbone.AssociatedModel.extend({defaults:{meshID:"",subMeshID:0,name:"",materialID:null,config:null,isDefault:false},idAttribute:"effectID",initialize:function(){if(!this.get("effectID")){this.set("effectID",MPlaza.generateUUID());}},relations:[{type:Backbone.One,key:'config',relatedModel:MPlaza.MeshDesignConfig}],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},getConfig:function(){return this.get("config");},getOrCreateConfig:function(){var config=this.getConfig();if(!config){config=new MPlaza.MeshDesignConfig();this.set("config",config);}return config;}});// -----------------------------------------------------------
// ModelSceneMeshDesignEffects
// -----------------------------------------------------------
MPlaza.ModelSceneMeshDesignEffects=Backbone.Collection.extend({model:MPlaza.ModelSceneMeshDesignEffect});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ModelScene
// -----------------------------------------------------------
MPlaza.ModelScene=Backbone.AssociatedModel.extend({defaults:{sceneID:"",isDefault:false,meshSides:[],meshDesignEffects:[]},initialize:function(){var model=this;this.get("meshSides").parentModel=this;this.get("meshDesignEffects").parentModel=this;},relations:[{type:Backbone.Many,key:'meshSides',collectionType:MPlaza.ModelSceneMeshSides},{type:Backbone.Many,key:'meshDesignEffects',collectionType:MPlaza.ModelSceneMeshDesignEffects}],isEffectForMesh:function(meshID,subMeshID,effectID){var effects=this.get("meshDesignEffects");if(effects){for(var i=0;i<effects.length;i++){var effect=effects.at(i);if(effect.get("meshID")===meshID&&effect.get("subMeshID")===subMeshID&&effect.get("effectID")===effectID){return true;}}}return false;},getMeshDesignEffect:function(effectID){var effects=this.get("meshDesignEffects");if(effects){for(var i=0;i<effects.length;i++){var effect=effects.at(i);if(effect.get("effectID")===effectID){return effect;}}}return null;},getMeshDesignEffects:function(meshID,subMeshID){var effects=this.get("meshDesignEffects");if(effects){for(var i=0;i<effects.length;i++){var effect=effects.at(i);if(effect.get("meshID")==meshID&&effect.get("subMeshID")==subMeshID){return effect;}}}return null;},getDefaultDesignEffect:function(meshID,subMeshID){var effects=this.get("meshDesignEffects");if(effects){for(var i=0;i<effects.length;i++){var effect=effects.at(i);if(effect.get("meshID")==meshID&&effect.get("subMeshID")==subMeshID&&effect.get("isDefault")){return effect;}}}return null;}});// -----------------------------------------------------------
// ModelScenes
// -----------------------------------------------------------
MPlaza.ModelScenes=Backbone.Collection.extend({model:MPlaza.ModelScene});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
MPlaza.AttributeSelectionScript=function(){this.attributeID=-1;this.selectedValue="";this.actions=[];};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignPrice
// -----------------------------------------------------------
MPlaza.DesignPrice=Backbone.AssociatedModel.extend({defaults:{qtyFrom:0,qtyTo:null,price:0,firstColorPrice:null},idAttribute:"priceID",initialize:function(){},relations:[],getPricingID:function(){if(this.collection&&this.collection.getPricingID){return this.collection.getPricingID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignPrices
// -----------------------------------------------------------
MPlaza.DesignPrices=Backbone.Collection.extend({model:MPlaza.DesignPrice,getPricingID:function(){if(this.parentModel&&this.parentModel.getPricingID){return this.parentModel.getPricingID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SetupPrice
// -----------------------------------------------------------
MPlaza.SetupPrice=Backbone.AssociatedModel.extend({defaults:{qtyFrom:0,qtyTo:null,price:0,firstColorPrice:null},idAttribute:"priceID",initialize:function(){},relations:[],getPricingID:function(){if(this.collection&&this.collection.getPricingID){return this.collection.getPricingID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SetupPrices
// -----------------------------------------------------------
MPlaza.SetupPrices=Backbone.Collection.extend({model:MPlaza.SetupPrice,getPricingID:function(){if(this.parentModel&&this.parentModel.getPricingID){return this.parentModel.getPricingID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Pricing
// -----------------------------------------------------------
MPlaza.Pricing=Backbone.AssociatedModel.extend({defaults:{setupPriceTypeID:MPlaza.PricingType.Global,designPriceTypeID:MPlaza.PricingType.Global,setupPrices:[],designPrices:[]},// modificare in docID per salvare su NoSQL
//idAttribute: "designID",
idAttribute:"pricingID",initialize:function(){var model=this;this.get("setupPrices").parentModel=this;this.get('designPrices').parentModel=this;this.on("change",function(){model._fireEvent("change");});this.get("setupPrices").on("add",function(){model._fireEvent("change");});this.get("setupPrices").on("remove",function(){model._fireEvent("change");});this.get("setupPrices").on("change",function(){model._fireEvent("change");});this.get("designPrices").on("add",function(){model._fireEvent("change");});this.get("designPrices").on("remove",function(){model._fireEvent("change");});this.get("designPrices").on("change",function(){model._fireEvent("change");});},_eventListeners:{change:[]},_fireEvent:function(eventName,e){if(this._eventListeners&&_.isObject(this._eventListeners)&&_.has(this._eventListeners,eventName)&&_.isArray(this._eventListeners[eventName])){var listeners=this._eventListeners[eventName];for(var i=0;i<listeners.length;++i){listeners[i](e);}}},trigger:function(eventName){this._fireEvent(eventName);},addEventListener:function(eventName,listenerFunction){if(this._eventListeners&&_.isObject(this._eventListeners)){if(!_.has(this._eventListeners,eventName)){this._eventListeners[eventName]=[];}this._eventListeners[eventName].push(listenerFunction);}},relations:[{type:Backbone.Many,key:'setupPrices',collectionType:MPlaza.SetupPrices},{type:Backbone.Many,key:'designPrices',collectionType:MPlaza.DesignPrices}],url:function(){// da modificare per utilizzare NoSQL
// url: pricings/<pricingID>
var urlRoot=Zakeke.config.baseApiUrl+'pricings';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getPricingID:function(){return this.get("pricingID");},toString:function(){// todo.......
},getSetupPriceForQuantity:function(quantity){for(var i=0;i<this.get("setupPrices").length;i++){var setupPrice=this.get("setupPrices").at(i);if(setupPrice.get("qtyFrom")<=quantity&&(!setupPrice.get("qtyTo")||quantity<setupPrice.get("qtyTo"))){return setupPrice;}}return null;},getDesignPriceForQuantity:function(quantity){for(var i=0;i<this.get("designPrices").length;i++){var designPrice=this.get("designPrices").at(i);if(designPrice.get("qtyFrom")<=quantity&&(!designPrice.get("qtyTo")||quantity<designPrice.get("qtyTo"))){return designPrice;}}return null;}});// -----------------------------------------------------------
// Pricings
// -----------------------------------------------------------
MPlaza.Pricings=Backbone.Collection.extend({model:MPlaza.Pricing,url:function(){return Zakeke.config.baseApiUrl+'pricings';},getPricing:function(pricingID){for(var i=0;i<this.length;i++){var pricing=this.at(i);if(pricing.get("pricingID")==pricingID)return pricing;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ImageEffectParameterValue
// -----------------------------------------------------------
MPlaza.ImageEffectParameterValue=Backbone.AssociatedModel.extend({defaults:{/*
        name: string,
        value: string
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){},toJSON:function(){return{name:this.get("name"),value:this.get("value")};},copyAttributes:function(source){this.set("name",source.get("name"));this.set("value",source.get("value"));}});// -----------------------------------------------------------
// ImageEffectParameterValues
// -----------------------------------------------------------
MPlaza.ImageEffectParameterValues=Backbone.Collection.extend({model:MPlaza.ImageEffectParameterValue,getValue:function(name){for(var i=0;i<this.length;i++){if(this.at(i).get("name").toLowerCase()===name.toLowerCase())return this.at(i).get("value");}},getValueNumber:function(name){var val=this.getValue(name);if(val){return Number(val);}return undefined;},getValueInt:function(name){var val=this.getValue(name);if(val){return parseInt(val);}return undefined;},getValueFloat:function(name){var val=this.getValue(name);if(val){return parseFloat(val);}return undefined;},getValueBoolean:function(name){var val=this.getValue(name);if(val){return val.toLowerCase()==="true";}return undefined;}});// -----------------------------------------------------------
// DesignEffect
// -----------------------------------------------------------
MPlaza.DesignEffect=Backbone.AssociatedModel.extend({defaults:{blendMode:"normal",enhancedBlendMode:false,opacity:1,textColor:null,imageEffectTypeName:null,imageEffectParameterValues:[]},initialize:function(){var model=this;this.get('imageEffectParameterValues').parentModel=this;},relations:[{type:Backbone.Many,key:'imageEffectParameterValues',collectionType:MPlaza.ImageEffectParameterValues}]});// -----------------------------------------------------------
// ImageEffectParameterOption
// -----------------------------------------------------------
MPlaza.ImageEffectParameterOption=Backbone.AssociatedModel.extend({defaults:{/*
        nameKey: string,
        value: string
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){},toJSON:function(){return{nameKey:this.get("nameKey"),value:this.get("value")};},copyAttributes:function(source){this.set("nameKey",source.get("nameKey"));this.set("value",source.get("value"));}});// -----------------------------------------------------------
// ImageEffectParameterOptions
// -----------------------------------------------------------
MPlaza.ImageEffectParameterOptions=Backbone.Collection.extend({model:MPlaza.ImageEffectParameterOption});// -----------------------------------------------------------
// ImageEffectParameter
// -----------------------------------------------------------
MPlaza.ImageEffectParameter=Backbone.AssociatedModel.extend({defaults:{/*
        name: string,
        labelKey: string,
        type: string, // "number", "boolean", "string", "options"
        min: number,
        max: number,
        step: number
        required: boolean
        defaultVale: string
        displayOrder: number,
        */name:"",options:[]},initialize:function(){},relations:[{type:Backbone.Many,key:'options',collectionType:MPlaza.ImageEffectParameterOptions}],getParentModel:function(){return this.parentModel;},toString:function(){},toJSON:function(){return{name:this.get("name"),labelKey:this.get("labelKey"),type:this.get("type"),min:this.get("min"),max:this.get("max"),step:this.get("step"),required:this.get("required"),defaultValue:this.get("defaultValue"),displayOrder:this.get("displayOrder"),options:this.get("options").toJSON()};},copyAttributes:function(source){this.set("name",source.get("name"));this.set("labelKey",source.get("labelKey"));this.set("type",source.get("type"));this.set("min",source.get("min"));this.set("max",source.get("max"));this.set("step",source.get("step"));this.set("required",source.get("required"));this.set("defaultValue",source.get("defaultValue"));this.set("displayOrder",source.get("displayOrder"));var options=[];for(var i=0;i<source.get("options").length;i++){var sourceOption=source.get("options").at(i);var newOption=new MPlaza.ImageEffectParameterOption();newOption.copyAttributes(sourceOption);options.push(newOption);}this.set("options",options);}});// -----------------------------------------------------------
// ImageEffectParameters
// -----------------------------------------------------------
MPlaza.ImageEffectParameters=Backbone.Collection.extend({model:MPlaza.ImageEffectParameter});// -----------------------------------------------------------
// ImageEffectType
// -----------------------------------------------------------
MPlaza.ImageEffectType=Backbone.AssociatedModel.extend({defaults:{name:"",parameters:[]},idAttribute:"imageEffectTypeID",initialize:function(){var model=this;this.get('parameters').parentModel=this;},relations:[{type:Backbone.Many,key:'parameters',collectionType:MPlaza.ImageEffectParameters}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'imageeffects/types';if(this.id!==undefined&&this.id!==null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getImageEffectTypeID:function(){return this.get("imageEffectTypeID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ImageEffectTypes
// -----------------------------------------------------------
MPlaza.ImageEffectTypes=Backbone.Collection.extend({model:MPlaza.ImageEffectType,url:function(){return Zakeke.config.baseApiUrl+'imageeffects/types';}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PrintTypeFont
// -----------------------------------------------------------
MPlaza.PrintTypeFont=Backbone.AssociatedModel.extend({defaults:{printTypeID:-1,fontFamilyID:-1,fontFamilyName:null},idAttribute:"fontFamilyID",initialize:function(){},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// PrintTypeFonts
// -----------------------------------------------------------
MPlaza.PrintTypeFonts=Backbone.Collection.extend({model:MPlaza.PrintTypeFont,getModelID:function(){if(this.parentModel)return this.parentModel.getModelID();return null;},getFont:function(fontFamilyID){for(var i=0;i<this.length;i++){var font=this.at(i);if(font.get("fontFamilyID")==fontFamilyID)return font;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PartPrintTypeRestriction
// -----------------------------------------------------------
MPlaza.PartPrintTypeRestriction=Backbone.AssociatedModel.extend({defaults:{disableTextColors:null,textColors:null,disableSellerImages:null,disableUserImages:null,useImagesFixedSize:null,canAddText:null,canChangeSvgColors:null,canUseImageFilters:null,uploadRestrictions:null,canIgnoreDPIWarning:null,canPreviewDesignsPDF:null,useCustomFonts:null,defaultFontFamilyID:null,fonts:[],showLayerButtons:null,showDuplicateButton:null,showFlipButtons:null,showImageProvider:null,canUseTextArt:null,imageEditingToolSettingsToExclude:null,imageInsertScalingUpload:null,imageInsertScalingCliparts:null},idAttribute:"partPrintTypeRestrictionID",initialize:function(){var printType=this;this.get("fonts").url=function(){return printType.url()+'/fonts';};this.get('fonts').parentModel=this;},relations:[{type:Backbone.Many,key:'fonts',collectionType:MPlaza.PrintTypeFonts}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'partPrintTypeRestrictions';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getPartPrintTypeRestrictionID:function(){return this.get("partPrintTypeRestrictionID");},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;}});// -----------------------------------------------------------
// PartPrintTypeOutputSettings
// -----------------------------------------------------------
MPlaza.PartPrintTypeOutputSettings=Backbone.AssociatedModel.extend({defaults:{width:0,height:0,partPrintTypeOutputSettingsID:-1,rows:0,columns:0,marginH:0,marginV:0,rotation:0,flowDirectionH:1,flowDirectionV:1,flowDirectionPriority:1},idAttribute:"partPrintTypeOutputSettingsID"});// -----------------------------------------------------------
// PartPrintType
// -----------------------------------------------------------
MPlaza.PartPrintType=Backbone.AssociatedModel.extend({defaults:{isEnabled:true,pricingID:-1,patID:MPlaza.PricingApplicationType.Global,partPrintTypeRestrictionID:null,dpi:null,restrictions:null,outputSettings:null},idAttribute:"printTypeID",initialize:function(){if(this.get("restrictions"))this.get("restrictions").parentModel=this;if(this.get("outputSettings"))this.get("outputSettings").parentModel=this;},relations:[{type:Backbone.One,key:'restrictions',relatedModel:MPlaza.PartPrintTypeRestriction},{type:Backbone.One,key:'outputSettings',relatedModel:MPlaza.PartPrintTypeOutputSettings}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'partprintTypes';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getPrintTypeID:function(){return this.get("printTypeID");},toString:function(){// todo.......
},setRestrictions:function(restrictions){this.set("restrictions",restrictions);if(restrictions)this.get("restrictions").parentModel=this;},setOutputSettings:function(settings){this.set("outputSettings",settings);if(settings)this.get("outputSettings").parentModel=this;}});// -----------------------------------------------------------
// PartPrintTypes
// -----------------------------------------------------------
MPlaza.PartPrintTypes=Backbone.Collection.extend({model:MPlaza.PartPrintType,url:function(){return Zakeke.config.baseApiUrl+'partprinttypes';},getPrintType:function(printTypeID){for(var i=0;i<this.length;i++){var printType=this.at(i);if(printType.get("printTypeID")>0?printType.get("printTypeID")===printTypeID:printType.tempID&&printType.tempID===printTypeID)return printType;}return null;}});// -----------------------------------------------------------
// AreaLayer
// -----------------------------------------------------------
MPlaza.AreaLayer=Backbone.AssociatedModel.extend({defaults:{name:"",json:"",svg:"",displayOrder:0,isVisibleInCanvas:true,isVisibleInCart:true,isVisibleInOutput:true,showLabel:true,isClipMask:false},idAttribute:"layerID",initialize:function(){if(!this.get("layerID")){this.set("layerID",MPlaza.generateUUID());}},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getColorID:function(){if(this.collection&&this.collection.getColorID){return this.collection.getColorID();}return null;},getSideID:function(){if(this.collection&&this.collection.getSideID){return this.collection.getSideID();}return null;},getAreaID:function(){if(this.collection&&this.collection.getAreaID){return this.collection.getAreaID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},getArea:function(){return this.getParentModel();},getSide:function(){var area=this.getArea();if(area&&area instanceof MPlaza.Area){return area.getSide();}return null;},getColor:function(){var side=this.getSide();if(side&&side instanceof MPlaza.Side){return side.getParentModel();}return null;},getModel:function(){var color=this.getColor();if(color&&color instanceof MPlaza.Color){return color.getParentModel();}return null;}});// -----------------------------------------------------------
// AreaLayers
// -----------------------------------------------------------
MPlaza.AreaLayers=Backbone.Collection.extend({model:MPlaza.AreaLayer,getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getColorID:function(){if(this.parentModel&&this.parentModel.getColorID){return this.parentModel.getColorID();}return null;},getSideID:function(){if(this.parentModel&&this.parentModel.getSideID){return this.parentModel.getSideID();}return null;},getAreaID:function(){if(this.parentModel&&this.parentModel.getAreaID){return this.parentModel.getAreaID();}return null;}});// -----------------------------------------------------------
// AreaTextConstraints
// -----------------------------------------------------------
MPlaza.AreaTextConstraints=Backbone.AssociatedModel.extend({defaults:{maxNumItems:-1,maxNumChars:-1,fitArea:false,canMove:true,canResize:true,canRotate:true,fixedDirection:0},//idAttribute: "modelID",
initialize:function(){},url:function(){return"";},getModelID:function(){if(this.parentModel)return this.parentModel.getModelID();return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// AreaTemplateFile
// -----------------------------------------------------------
MPlaza.AreaTemplateFile=Backbone.AssociatedModel.extend({defaults:{fileID:"",fileUrl:""},//idAttribute: "modelID",
initialize:function(){},url:function(){return"";},getModelID:function(){if(this.parentModel)return this.parentModel.getModelID();return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Area
// -----------------------------------------------------------
MPlaza.Area=Backbone.AssociatedModel.extend({defaults:{guid:"",name:"",path:"",pathSVG:"",boundsX:0,boundsY:0,boundsWidth:0,boundsHeight:0,clipOut:true,screenPPI:0,textConstraints:null,templateFile:null,printTypes:[],layers:[]},idAttribute:"areaID",relations:[{type:Backbone.One,key:'textConstraints',relatedModel:MPlaza.AreaTextConstraints},{type:Backbone.One,key:'templateFile',relatedModel:MPlaza.AreaTemplateFile},{type:Backbone.Many,key:'printTypes',collectionType:MPlaza.PartPrintTypes},{type:Backbone.Many,key:'layers',collectionType:MPlaza.AreaLayers}],initialize:function(){if(!this.get("guid")){this.set("guid",MPlaza.generateUUID());}if(this.get('textConstraints'))this.get('textConstraints').parentModel=this;if(this.get('templateFile'))this.get('templateFile').parentModel=this;if(this.get('layers'))this.get('layers').parentModel=this;},url:function(){var urlRoot=Zakeke.config.baseApiUrl+'areas';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getColorID:function(){if(this.collection&&this.collection.getColorID){return this.collection.getColorID();}return null;},getSideID:function(){if(this.collection&&this.collection.getSideID){return this.collection.getSideID();}return null;},getAreaID:function(){return this.get("areaID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},getPrintType:function(printTypeID){for(var i=0;i<this.get("printTypes").length;i++){var printType=this.get("printTypes").at(i);if(printType.get("printTypeID")>0?printType.get("printTypeID")===printTypeID:printType.tempID&&printType.tempID===printTypeID)return printType;}return null;},getSide:function(){return this.getParentModel();},getColor:function(){var side=this.getParentModel();if(side&&side instanceof MPlaza.Side){return side.getParentModel();}return null;},getModel:function(){var side=this.getParentModel();if(side&&side instanceof MPlaza.Side){var color=side.getParentModel();if(color&&color instanceof MPlaza.Color){return color.getParentModel();}}return null;}});// -----------------------------------------------------------
// Areas
// -----------------------------------------------------------
MPlaza.Areas=Backbone.Collection.extend({model:MPlaza.Area,getArea:function(guid){for(var i=0;i<this.length;i++){var area=this.at(i);if(area.get("guid")==guid)return area;}return null;},getAreaByID:function(areaID){for(var i=0;i<this.length;i++){var area=this.at(i);if(area.get("areaID")==areaID)return area;}return null;},getMaxArea:function(){var max=0;var maxArea=null;for(var i=0;i<this.length;i++){var area=this.at(i);var rect=new paper.Rectangle(area.get("boundsX"),area.get("boundsY"),area.get("boundsWidth"),area.get("boundsHeight"));var a=rect.area;if(max<a){max=a;maxArea=area;}}return maxArea;},url:function(){return Zakeke.config.baseApiUrl+'areas';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getColorID:function(){if(this.parentModel&&this.parentModel.getColorID){return this.parentModel.getColorID();}return null;},getSideID:function(){if(this.parentModel&&this.parentModel.getSideID){return this.parentModel.getSideID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Side
// -----------------------------------------------------------
MPlaza.Side=Backbone.AssociatedModel.extend({defaults:{name:"",code:"",ppcm:0,tempImageFileKey:"",imageUrl:"",colorable:false,sortOrder:null,isDefault:false,printTypes:[],areas:[]},idAttribute:"sideID",initialize:function(){var side=this;this.get("areas").url=function(){return side.url()+'/areas';};this.get('areas').parentModel=this;},relations:[{type:Backbone.Many,key:'areas',collectionType:MPlaza.Areas},{type:Backbone.Many,key:'printTypes',collectionType:MPlaza.PartPrintTypes}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'sides';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getColorID:function(){if(this.collection&&this.collection.getColorID){return this.collection.getColorID();}return null;},getSideID:function(){return this.get("sideID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},findAreaByID:function(areaID){var areas=this.get("areas");if(areas){return areas.findWhere({areaID:areaID});}return null;},findAreaByGuid:function(guid){var areas=this.get("areas");if(areas){return areas.findWhere({guid:guid});}return null;},getPrintType:function(printTypeID){for(var i=0;i<this.get("printTypes").length;i++){var printType=this.get("printTypes").at(i);if(printType.get("printTypeID")>0?printType.get("printTypeID")===printTypeID:printType.tempID&&printType.tempID===printTypeID)return printType;}return null;},toString:function(){// todo.......
},getColor:function(){return this.getParentModel();},getModel:function(){var color=this.getParentModel();if(color&&color instanceof MPlaza.Color){return color.getParentModel();}return null;}});// -----------------------------------------------------------
// Sides
// -----------------------------------------------------------
MPlaza.Sides=Backbone.Collection.extend({model:MPlaza.Side,url:function(){return Zakeke.config.baseApiUrl+'sides';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getColorID:function(){if(this.parentModel&&this.parentModel.getColorID){return this.parentModel.getColorID();}return null;},getSide:function(sideID){for(var i=0;i<this.length;i++){var side=this.at(i);if(side.get("sideID")==sideID)return side;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// CompliantColor
// -----------------------------------------------------------
MPlaza.CompliantColor=Backbone.AssociatedModel.extend({defaults:{},idAttribute:"colorCode",url:function(){var urlRoot=Zakeke.config.baseApiUrl+'compliantColors';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){var modelID;if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return modelID;},getColorID:function(){var colorID;if(this.collection&&this.collection.getColorID){return this.collection.getColorID();}return colorID;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// CompliantColors
// -----------------------------------------------------------
MPlaza.CompliantColors=Backbone.Collection.extend({model:MPlaza.CompliantColor,getCompliantColor:function(code){for(var i=0;i<this.length;i++){var color=this.at(i);if(color.get("colorCode")==code)return color;}return null;},url:function(){return Zakeke.config.baseApiUrl+'compliantColors';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID())return this.parentModel.getModelID();return null;},getColorID:function(){if(this.parentModel&&this.parentModel.getColorID())return this.parentModel.getColorID();return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Size
// -----------------------------------------------------------
MPlaza.Size=Backbone.AssociatedModel.extend({defaults:{name:"",genre:""},idAttribute:"sizeID",url:function(){var urlRoot=Zakeke.config.baseApiUrl+'sizes';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){var modelID;if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return modelID;},getColorID:function(){var colorID;if(this.collection&&this.collection.getColorID){return this.collection.getColorID();}return colorID;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// Sizes
// -----------------------------------------------------------
MPlaza.Sizes=Backbone.Collection.extend({model:MPlaza.Size,getSize:function(sizeID){for(var i=0;i<this.length;i++){var size=this.at(i);if(size.get("sizeID")==sizeID)return size;}return null;},url:function(){return Zakeke.config.baseApiUrl+'sizes';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getColorID:function(){if(this.parentModel&&this.parentModel.getColorID){return this.parentModel.getColorID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Color
// -----------------------------------------------------------
MPlaza.Color=Backbone.AssociatedModel.extend({defaults:{name:"",colorCode:"",colorHexCode:"",code:"",imageUrl:"",showSideImage:false,position:0,sizes:[],compliantColors:[],printTypes:[],sides:[]},idAttribute:"colorID",initialize:function(){var color=this;this.get("sizes").url=function(){return color.url()+'/sizes';};this.get("compliantColors").url=function(){return color.url()+'/compliantColors';};this.get("sides").url=function(){return color.url()+'/sides';};this.get('sizes').parentModel=this;this.get('compliantColors').parentModel=this;this.get('sides').parentModel=this;},relations:[{type:Backbone.Many,key:'sizes',collectionType:MPlaza.Sizes},{type:Backbone.Many,key:'compliantColors',collectionType:MPlaza.CompliantColors},{type:Backbone.Many,key:'sides',collectionType:MPlaza.Sides},{type:Backbone.Many,key:'printTypes',collectionType:MPlaza.PartPrintTypes}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'colors';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getColorID:function(){return this.get("colorID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},findSize:function(sizeID){var sizes=this.get("sizes");if(sizes){return sizes.findWhere({sizeID:sizeID});}return null;},findCompliantColor:function(colorCode){var compliantColors=this.get("compliantColors");if(compliantColors){return sizes.findWhere({colorCode:colorCode});}return null;},findSide:function(sideID){var sides=this.get("sides");if(sides){return sides.findWhere({sideID:sideID});}return null;},getAreaWithGuid:function(guid){var sides=this.get("sides");for(var i=0;i<sides.length;i++){var side=sides.at(i);var area=side.getArea(guid);if(area)return area;}return null;},getPrintType:function(printTypeID){for(var i=0;i<this.get("printTypes").length;i++){var printType=this.get("printTypes").at(i);if(printType.get("printTypeID")>0?printType.get("printTypeID")===printTypeID:printType.tempID&&printType.tempID===printTypeID)return printType;}return null;},toString:function(){// todo.......
},getModel:function(){return this.getParentModel();}});// -----------------------------------------------------------
// Colors
// -----------------------------------------------------------
MPlaza.Colors=Backbone.Collection.extend({model:MPlaza.Color,url:function(){return Zakeke.config.baseApiUrl+'colors';},getModelID:function(){if(this.parentModel)return this.parentModel.getModelID();return null;},getColor:function(colorID){for(var i=0;i<this.length;i++){var color=this.at(i);if(color.get("colorID")==colorID)return color;}return null;},comparator:function(color){return color.get('position');}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PrintType
// -----------------------------------------------------------
MPlaza.PrintType=Backbone.AssociatedModel.extend({defaults:{name:"",dpi:300,printTypeDPI:0,priceDeltaPerc:0,priceDeltaValue:0,price:0,textBasePrice:0,imageBasePrice:0,pricingID:-1,patID:MPlaza.PricingApplicationType.Global,disableTextColors:null,disableImageColors:null,disableSellerImages:null,disableUserImages:null,useImagesFixedSize:null,textColors:null,imageColors:null,canAddText:null,canChangeSvgColors:null,canUseImageFilters:null,uploadRestrictions:null,canIgnoreDPIWarning:null,useCustomFonts:null,printTypeFonts:[],printTypeDefaultFontFamilyID:null,fonts:[],defaultFontFamilyID:null,pantoneEnabled:false,canPreviewDesignsPDF:null,outputTypeID:1,outputSettings:null,showLayerButtons:null,showDuplicateButton:null,showFlipButtons:null,showImageProvider:null,canUseTextArt:null,imageEditingToolSettingsToExclude:null,printTypeRestrictionsID:null,printTypeRestrictions:null,previewDesignEffect:null,outputDesignEffect:null,maxColors:null,paletteID:null,paletteColors:[],splitColorFiles:false,layeredPdf:false},idAttribute:"printTypeID",initialize:function(){var printType=this;this.get("printTypeFonts").url=function(){return printType.url()+'/printtypefonts';};this.get("fonts").url=function(){return printType.url()+'/fonts';};this.get('printTypeFonts').parentModel=this;this.get('fonts').parentModel=this;if(this.get("printTypeRestrictions"))this.get("printTypeRestrictions").parentModel=this;},relations:[{type:Backbone.One,key:'printTypeRestrictions',relatedModel:MPlaza.PartPrintTypeRestriction},{type:Backbone.Many,key:'printTypeFonts',collectionType:MPlaza.PrintTypeFonts},{type:Backbone.Many,key:'fonts',collectionType:MPlaza.PrintTypeFonts},{type:Backbone.One,key:'outputSettings',relatedModel:MPlaza.PartPrintTypeOutputSettings},{type:Backbone.One,key:'previewDesignEffect',relatedModel:MPlaza.DesignEffect},{type:Backbone.One,key:'outputDesignEffect',relatedModel:MPlaza.DesignEffect}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'printTypes';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getPrintTypeID:function(){return this.get("printTypeID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},setOutputSettings:function(settings){this.set("outputSettings",settings);if(settings)this.get("outputSettings").parentModel=this;}});// -----------------------------------------------------------
// PrintTypes
// -----------------------------------------------------------
MPlaza.PrintTypes=Backbone.Collection.extend({model:MPlaza.PrintType,url:function(){return Zakeke.config.baseApiUrl+'printtypes';},getModelID:function(){if(this.parentModel)return this.parentModel.getModelID();return null;},getPrintType:function(printTypeID){for(var i=0;i<this.length;i++){var printType=this.at(i);if(printType.get("printTypeID")>0?printType.get("printTypeID")===printTypeID:printType.tempID&&printType.tempID===printTypeID)return printType;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PreviewColor
// -----------------------------------------------------------
MPlaza.PreviewColor=Backbone.AssociatedModel.extend({defaults:{color:"",hasTexture:false,textureUrl:"",tempTextureFileKey:"",isCustomTexture:false,refractionMode:null,reflectivity:null,opacity:null,opacityAffectCustomization:null,textureWidth:null,textureHeight:null,itemsPositionX:null,itemsPositionY:null,itemsScaleX:null,itemsScaleY:null},idAttribute:"colorID",initialize:function(){},url:function(){var urlRoot=Zakeke.config.baseApiUrl+'previewcolors';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getPreviewModelID:function(){if(this.collection&&this.collection.getPreviewModelID){return this.collection.getPreviewModelID();}return null;},getPartID:function(){if(this.collection&&this.collection.getPartID){return this.collection.getPartID();}return null;},getColorID:function(){return this.get("colorID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// PreviewColors
// -----------------------------------------------------------
MPlaza.PreviewColors=Backbone.Collection.extend({model:MPlaza.PreviewColor,getPreviewColor:function(colorID){for(var i=0;i<this.length;i++){var previewColor=this.at(i);if(previewColor.get("colorID")==colorID)return previewColor;}return null;},url:function(){return Zakeke.config.baseApiUrl+'previewcolors';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getPreviewModelID:function(){if(this.parentModel&&this.parentModel.getPreviewModelID){return this.parentModel.getPreviewModelID();}return null;},getPartID:function(){if(this.parentModel&&this.parentModel.getPartID){return this.parentModel.getPartID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PreviewPart
// -----------------------------------------------------------
MPlaza.PreviewPart=Backbone.AssociatedModel.extend({defaults:{materialIndex:-1,sideID:-1,color:"",hasTexture:false,textureWidth:0,textureHeight:0,textureUrl:"",tempTextureFileKey:"",reflectivity:0,opacity:1,opacityAffectCustomization:true,itemsPositionX:0,itemsPositionY:0,itemsScaleX:0,itemsScaleY:0,refractionMode:false,colors:[]},idAttribute:"partID",initialize:function(){var previewPart=this;this.get("colors").url=function(){return previewPart.url()+'/previewcolors';};this.get('colors').parentModel=this;},relations:[{type:Backbone.Many,key:'colors',collectionType:MPlaza.PreviewColors}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'previewparts';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getPreviewModelID:function(){if(this.collection&&this.collection.getPreviewModelID){return this.collection.getPreviewModelID();}return null;},getPartID:function(){return this.get("partID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},findColor:function(colorID){var previewColors=this.get("colors");if(previewColors){return previewColors.findWhere({colorID:colorID});}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// PreviewParts
// -----------------------------------------------------------
MPlaza.PreviewParts=Backbone.Collection.extend({model:MPlaza.PreviewPart,url:function(){return Zakeke.config.baseApiUrl+'previewparts';},getModelID:function(){if(this.parentModel&&this.parentModel.getModelID){return this.parentModel.getModelID();}return null;},getPreviewModelID:function(){if(this.parentModel&&this.parentModel.getPreviewModelID){return this.parentModel.getPreviewModelID();}return null;},getPreviewPart:function(partID){for(var i=0;i<this.length;i++){var previewPart=this.at(i);if(previewPart.get("partID")==partID)return previewPart;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// PreviewModel
// -----------------------------------------------------------
MPlaza.PreviewModel=Backbone.AssociatedModel.extend({defaults:{backface:false,scale:1,tempModel3DFileKey:"",model3DUrl:"",parts:[]},idAttribute:"modelID",initialize:function(){var previewModel=this;this.get("parts").url=function(){return previewModel.url()+'/previewparts';};this.get('parts').parentModel=this;},relations:[{type:Backbone.Many,key:'parts',collectionType:MPlaza.PreviewParts}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'previewmodels';if(this.collection&&this.collection.url){urlRoot=this.collection.url();}if(this.id!=undefined&&this.id!=null&&this.id>=0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getModelID();}return null;},getPreviewModelID:function(){return this.get("modelID");},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},findPart:function(partID){var previewParts=this.get("parts");if(previewParts){return previewParts.findWhere({partID:partID});}return null;},toString:function(){// todo.......
}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Quantity Rule
// -----------------------------------------------------------
MPlaza.QuantityRule=Backbone.AssociatedModel.extend({defaults:{minQuantity:null,maxQuantity:null,step:null}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// New 3D Preview objects
// -----------------------------------------------------------
// VariantOptionMaterialAction
// -----------------------------------------------------------
MPlaza.VariantOptionMaterialAction=Backbone.AssociatedModel.extend({defaults:{actionGuid:"",meshID:""},initialize:function(){},relations:[],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){}});// -----------------------------------------------------------
// VariantOptionMaterialActions
// -----------------------------------------------------------
MPlaza.VariantOptionMaterialActions=Backbone.Collection.extend({model:MPlaza.VariantOptionMaterialAction,getActionForMesh(meshID){for(var i=0;i<this.length;i++){if(this.at(i).get("meshID")===meshID)return this.at(i);}return null;}});// -----------------------------------------------------------
// VariantOptionMaterial
// -----------------------------------------------------------
MPlaza.VariantOptionMaterial=Backbone.AssociatedModel.extend({defaults:{optionMaterialID:"",variableMaterialID:"",actions:[]},initialize:function(){this.get('actions').parentModel=this;},relations:[{type:Backbone.Many,key:'actions',collectionType:MPlaza.VariantOptionMaterialActions}],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// VariantOptionMaterials
// -----------------------------------------------------------
MPlaza.VariantOptionMaterials=Backbone.Collection.extend({model:MPlaza.VariantOptionMaterial});// -----------------------------------------------------------
// VariantOption
// -----------------------------------------------------------
MPlaza.VariantOption=Backbone.AssociatedModel.extend({defaults:{variantID:"",optionGuid:"",materials:[]},initialize:function(){this.get('materials').parentModel=this;},relations:[{type:Backbone.Many,key:'materials',collectionType:MPlaza.VariantOptionMaterials}],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// VariantOptions
// -----------------------------------------------------------
MPlaza.VariantOptions=Backbone.Collection.extend({model:MPlaza.VariantOption,getVariantOption(variantID){for(var i=0;i<this.length;i++){if(this.at(i).get("variantID")===variantID)return this.at(i);}return null;}});// -----------------------------------------------------------
// VariableMaterial
// -----------------------------------------------------------
MPlaza.VariableMaterial=Backbone.AssociatedModel.extend({defaults:{materialID:"",meshes:[]},initialize:function(){},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// VariableMaterials
// -----------------------------------------------------------
MPlaza.VariableMaterials=Backbone.Collection.extend({model:MPlaza.VariableMaterial,getVariableMaterial(materialID){for(var i=0;i<this.length;i++){if(this.at(i).get("materialID")===materialID)return this.at(i);}return null;}});// -----------------------------------------------------------
// VariantsAttributeOptions
// -----------------------------------------------------------
MPlaza.VariantsAttributeOptions=Backbone.AssociatedModel.extend({defaults:{attributeGuid:"",variableMaterials:[],variantOptions:[]},initialize:function(){this.get('variableMaterials').parentModel=this;this.get('variantOptions').parentModel=this;},relations:[{type:Backbone.Many,key:'variableMaterials',collectionType:MPlaza.VariableMaterials},{type:Backbone.Many,key:'variantOptions',collectionType:MPlaza.VariantOptions}],getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},// restituisce l'elenco di tutti gli id dei materiali clonati per rappresentare la variazione
// del modello 3D per variante
getOptionsMaterialIDs:function(){var ids=[];for(var i=0;i<this.get("variantOptions").length;i++){var variantOption=this.get("variantOptions").at(i);for(var j=0;j<variantOption.get("materials").length;j++){var variantOptionMaterial=variantOption.get("materials").at(j);var materialID=variantOptionMaterial.get("optionMaterialID");if(ids.indexOf(materialID)===-1){ids.push(materialID);}}}return ids;},setVariableMaterial:function(materialID,meshIDs){var variableMaterial=this.get("variableMaterials").getVariableMaterial(materialID);if(!variableMaterial){variableMaterial=new MPlaza.VariableMaterial();variableMaterial.set("materialID",materialID);this.get("variableMaterials").push(variableMaterial);}variableMaterial.set("meshes",meshIDs);},removeVariableMaterial:function(materialID){var variableMaterial=this.get("variableMaterials").getVariableMaterial(materialID);if(variableMaterial)this.get("variableMaterials").remove(variableMaterial);},getVariantOption:function(variantID){return this.get("variantOptions").getVariantOption(variantID);}});// -----------------------------------------------------------
// Preview3D
// -----------------------------------------------------------
MPlaza.Preview3D=Backbone.AssociatedModel.extend({defaults:{variantsAttributeOptions:null},initialize:function(){if(this.get('variantsAttributeOptions'))this.get('variantsAttributeOptions').parentModel=this;},relations:[{type:Backbone.One,key:'variantsAttributeOptions',relatedModel:MPlaza.VariantsAttributeOptions}],getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},getVariantsAttributeOptions:function(){return this.get("variantsAttributeOptions");},getOrCreateVariantsAttributeOptions:function(){var variantsAttributeOptions=this.getVariantsAttributeOptions();if(!variantsAttributeOptions){variantsAttributeOptions=new MPlaza.VariantsAttributeOptions();this.set("variantsAttributeOptions",variantsAttributeOptions);}return variantsAttributeOptions;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Model
// -----------------------------------------------------------
MPlaza.Model=Backbone.AssociatedModel.extend({defaults:{name:"",description:"",code:"",statusID:1,tempSmallImageFileKey:"",smallImageUrl:"",tempLargeImageFileKey:"",largeImageUrl:"",price:0,variantIconCode:"",variantTypeName:"",pricingModelID:MPlaza.PricingModel.Simple,defaultDesignTemplateID:-1,loadFirstDesignTemplate:false,showTemplateSelection:false,printTypes:[],colors:[],preview3D:null,// new 3D preview
previewModel:null,pricings:[],composerPricings:[],scenes:[],attributeGroups:[],attributeSteps:[],attributes:[],attributeSelectionColors:[],backgroundColorRules:null,areaBackgroundRules:null,quoteRule:null,quantityRule:null,hasAdditionalFeeOnImagesProvider:false,environment:1},idAttribute:"modelID",initialize:function(){var model=this;this.get("printTypes").url=function(){return model.url()+'/printTypes';};this.get("colors").url=function(){return model.url()+'/colors';};this.get('printTypes').parentModel=this;this.get('colors').parentModel=this;if(this.get('preview3D'))this.get('preview3D').parentModel=this;if(this.get('previewModel'))this.get('previewModel').parentModel=this;this.get("scenes").parentModel=this;this.get("attributeGroups").parentModel=this;this.get("attributeSteps").parentModel=this;this.get("attributes").parentModel=this;this.get("attributeSelectionColors").parentModel=this;/* OK solo quando saranno modelli Backbone, altrimenti se avvalorati si avrebbe un riferimento
         * circolare in fase di serializzazione in JSON
        if (this.get('backgroundColorRules'))
            this.get('backgroundColorRules').parentModel = this;

        if (this.get('areaBackgroundRules'))
            this.get('areaBackgroundRules').parentModel = this;
        */},relations:[{type:Backbone.One,key:'preview3D',relatedModel:MPlaza.Preview3D},{type:Backbone.One,key:'previewModel',relatedModel:MPlaza.PreviewModel},{type:Backbone.One,key:'quantityRule',relatedModel:MPlaza.QuantityRule},{type:Backbone.Many,key:'printTypes',collectionType:MPlaza.PrintTypes},{type:Backbone.Many,key:'colors',collectionType:MPlaza.Colors},{type:Backbone.Many,key:'pricings',collectionType:MPlaza.Pricings},{type:Backbone.Many,key:'composerPricings',collectionType:MPlaza.ComposerPricings},{type:Backbone.Many,key:'scenes',collectionType:MPlaza.ModelScenes},{type:Backbone.Many,key:'attributeGroups',collectionType:MPlaza.AttributeGroups},{type:Backbone.Many,key:'attributeSteps',collectionType:MPlaza.AttributeSteps},{type:Backbone.Many,key:'attributes',collectionType:MPlaza.Attributes},{type:Backbone.Many,key:'attributeSelectionColors',collectionType:MPlaza.AttributeSelectionColors}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'models';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getModelID:function(){return this.get("modelID");},toString:function(){// todo.......
},getPreview3D:function(){return this.get("preview3D");},getOrCreatePreview3D:function(){var preview3D=this.getPreview3D();if(!preview3D){preview3D=new MPlaza.Preview3D();this.set("preview3D",preview3D);}return preview3D;},getModelPriceDeltaPerc:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes){var printType=printTypes.getPrintType(printTypeID);if(printType)return printType.get("priceDeltaPerc");}return 0;},getModelPriceDeltaValue:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes){var printType=printTypes.getPrintType(printTypeID);if(printType)return printType.get("priceDeltaValue");}return 0;},getModelPrice:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes){var printType=printTypes.getPrintType(printTypeID);if(printType)return printType.get("price");}return 0;},getModelTextBasePrice:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes){var printType=printTypes.getPrintType(printTypeID);if(printType)return printType.get("textBasePrice");}return 0;},getModelImageBasePrice:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes){var printType=printTypes.getPrintType(printTypeID);if(printType)return printType.get("imageBasePrice");}return 0;},getPrintType:function(printTypeID){var printTypes=this.get("printTypes");if(printTypes)return printTypes.getPrintType(printTypeID);return null;},getDefaultSceneID:function(){for(var i=0;i<this.get("scenes").length;i++){var scene=this.get("scenes").at(i);if(scene.get("isDefault"))return scene.get("sceneID");}return null;},getAttributesByGroupID:function(groupID){var attributes=[];for(var i=0;i<this.get("attributes").length;i++){var attribute=this.get("attributes").at(i);if(attribute.get("groupID")==groupID){attributes.push(attribute);}}return attributes;},getAttributesWithoutGroup:function(){var attributes=[];for(var i=0;i<this.get("attributes").length;i++){var attribute=this.get("attributes").at(i);if(attribute.get("groupID")<=0){attributes.push(attribute);}}return attributes;},getAttribute:function(attributeID){return this.get("attributes").getAttribute(attributeID);},getAttributeByGuid:function(attributeGuid){return this.get("attributes").getAttributeByGuid(attributeGuid);},getOption:function(optionID){for(var i=0;i<this.get("attributes").length;i++){var attribute=this.get("attributes").at(i);var option=attribute.get("options").findWhere({optionID:optionID});if(option)return option;}return null;},getOptionByGuid:function(optionGuid){for(var i=0;i<this.get("attributes").length;i++){var attribute=this.get("attributes").at(i);var option=attribute.get("options").findWhere({optionGuid:optionGuid});if(option)return option;}return null;},getComposerPricing:function(pricingID){for(var i=0;i<this.get("composerPricings").length;i++){var pricing=this.get("composerPricings").at(i);if(pricing.get("pricingID")==pricingID)return pricing;}return null;},getModelSide:function(colorID,sideID){for(var i=0;i<this.get("colors").length;i++){var color=this.get("colors").at(i);if(color.get("colorID")==colorID){for(var j=0;j<color.get("sides").length;j++){var side=color.get("sides").at(j);if(side.get("sideID")==sideID)return side;}}}return null;},getAttributeSelectionColor:function(selectionID){return this.get("attributeSelectionColors").getAttributeSelectionColor(selectionID);},setShowTemplateSelection(show){this.set("showTemplateSelection",show);}});// -----------------------------------------------------------
// Models
// -----------------------------------------------------------
MPlaza.Models=Backbone.Collection.extend({model:MPlaza.Model,url:function(){return Zakeke.config.baseApiUrl+'models';},getModel:function(modelID){for(var i=0;i<this.length;i++){var model=this.at(i);if(model.get("modelID")==modelID)return model;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MPlaza.ColorMapping
// -----------------------------------------------------------
MPlaza.ColorMapping=Backbone.AssociatedModel.extend({defaults:{src:"",dest:""},initialize:function(){},copyAttributes:function(source){this.set("src",source.get("src"));this.set("dest",source.get("dest"));},toJSON:function(){return{src:this.get("src"),dest:this.get("dest")};}});// -----------------------------------------------------------
// MPlaza.ColorMappings
// -----------------------------------------------------------
MPlaza.ColorMappings=Backbone.Collection.extend({model:MPlaza.ColorMapping,toJSON:function(){var arr=[];this.forEach(m=>arr.push(m.toJSON()));return arr;}});// -----------------------------------------------------------
// TextArtConfig
// -----------------------------------------------------------
MPlaza.TextArtConfig=Backbone.AssociatedModel.extend({defaults:{/*
        angleValue: number
        curveValue: number
        intensT: number,
        intensB: number,
        isTriangle: boolean,
        isBridge: boolean,
        isTop: boolean,
        isBottom: boolean,
        isMiddle: boolean
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){},toJSON:function(){return{angleValue:this.get("angleValue"),curveValue:this.get("curveValue"),intensT:this.get("intensT"),intensB:this.get("intensB"),isTriangle:this.get("isTriangle"),isBridge:this.get("isBridge"),isTop:this.get("isTop"),isBottom:this.get("isBottom"),isMiddle:this.get("isMiddle")};},copyAttributes:function(source){this.set("angleValue",source.get("angleValue"));this.set("curveValue",source.get("curveValue"));this.set("intensT",source.get("intensT"));this.set("intensB",source.get("intensB"));this.set("isTriangle",source.get("isTriangle"));this.set("isBridge",source.get("isBridge"));this.set("isTop",source.get("isTop"));this.set("isBottom",source.get("isBottom"));this.set("isMiddle",source.get("isMiddle"));}});// -----------------------------------------------------------
// TextArtControl
// -----------------------------------------------------------
MPlaza.TextArtControl=Backbone.AssociatedModel.extend({defaults:{/*
        property: string,
        labelKey: string,
        type: string, // "number", "boolean", "string"
        min: number,
        max: number,
        step: number
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){},toJSON:function(){return{property:this.get("property"),labelKey:this.get("labelKey"),type:this.get("type"),min:this.get("min"),max:this.get("max"),step:this.get("step")};},copyAttributes:function(source){this.set("property",source.get("property"));this.set("labelKey",source.get("labelKey"));this.set("type",source.get("type"));this.set("min",source.get("min"));this.set("max",source.get("max"));this.set("step",source.get("step"));}});// -----------------------------------------------------------
// TextArtControls
// -----------------------------------------------------------
MPlaza.TextArtControls=Backbone.Collection.extend({model:MPlaza.TextArtControl});// -----------------------------------------------------------
// TextArtType
// -----------------------------------------------------------
MPlaza.TextArtType=Backbone.AssociatedModel.extend({defaults:{name:"",imageUrl:"",config:null,controls:[]},idAttribute:"textArtTypeID",initialize:function(){var model=this;this.get('controls').parentModel=this;if(this.get('config'))this.get('config').parentModel=this;},relations:[{type:Backbone.One,key:'config',relatedModel:MPlaza.TextArtConfig},{type:Backbone.Many,key:'controls',collectionType:MPlaza.TextArtControls}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'textart/types';if(this.id!==undefined&&this.id!==null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getTextArtTypeID:function(){return this.get("textArtTypeID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// TextArtTypes
// -----------------------------------------------------------
MPlaza.TextArtTypes=Backbone.Collection.extend({model:MPlaza.TextArtType,url:function(){return Zakeke.config.baseApiUrl+'textart/types';}});// -----------------------------------------------------------
// DesignItemColor
// -----------------------------------------------------------
MPlaza.DesignItemColor=Backbone.AssociatedModel.extend({defaults:{imageID:-1,colorID:-1,colorCode:""},idAttribute:"key",initialize:function(){},getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getDesignItemID:function(){if(this.collection&&this.collection.getDesignItemID){return this.collection.getDesignItemID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// DesignItemColors
// -----------------------------------------------------------
MPlaza.DesignItemColors=Backbone.Collection.extend({model:MPlaza.DesignItemColor,getDesignItemColor:function(imageID,colorID){for(var i=0;i<this.length;i++){var color=this.at(i);if(color.get("imageID")==imageID&&color.get("colorID")==colorID)return color;}return null;},getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},getDesignItemID:function(){if(this.parentModel&&this.parentModel.getDesignItemID){return this.parentModel.getDesignItemID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignItemArea
// -----------------------------------------------------------
MPlaza.DesignItemArea=Backbone.AssociatedModel.extend({defaults:{modelID:-1,colorID:-1,sideID:-1,areaID:-1},idAttribute:"id",initialize:function(){},getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getDesignItemID:function(){if(this.collection&&this.collection.getDesignItemID){return this.collection.getDesignItemID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;}});// -----------------------------------------------------------
// DesignItemAreas
// -----------------------------------------------------------
MPlaza.DesignItemAreas=Backbone.Collection.extend({model:MPlaza.DesignItemArea,getDesignItemArea:function(modelID,colorID,sideID,areaID){for(var i=0;i<this.length;i++){var area=this.at(i);if(area.get("modelID")==modelID&&area.get("colorID")==colorID&&area.get("sideID")==sideID&&area.get("areaID")==areaID)return area;}return null;},getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},getDesignItemID:function(){if(this.parentModel&&this.parentModel.getDesignItemID){return this.parentModel.getDesignItemID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignItemConstraints
// -----------------------------------------------------------
MPlaza.DesignItemConstraints=Backbone.AssociatedModel.extend({defaults:{itemID:-1,canMove:true,canRotate:true,canResize:true,canDelete:true,canEdit:true,keepNrChars:false,minNrChars:0,maxNrChars:0,paddingTypeID:MPlaza.PaddingType.Start,paddingString:"",canChangeFontFamily:true,canChangeFontSize:true,canChangeFontColor:true,canChangeFontWeight:true,canChangeFontItalic:true,canChangeTextPathMode:true,canChangeJustification:true,canTransform:true,canChangeSvgColors:true,isAlwaysOnTop:false,isPrintable:true,mandatoryToEdit:false,canSyncContent:true,canSyncAlignment:true,canSyncFontFamily:true,canSyncFontStyle:true,canSyncFontColor:true,canSyncCurved:true,canSyncTransforms:false,canResizeTextBox:true,canChangeTextBoxMode:true,toUppercase:false,canChangeTextBoxMode:true,toUppercase:false,canAddMask:true,canReplaceMask:true,canEditMask:true,canDeleteMask:true,canEditMaskedImage:true,canChangeMaskStrokeColor:true,canChangeMaskStrokeWidth:true,canFillShape:true,canReplaceShapeFilling:true,canEditShapeFilling:true,canDeleteShapeFilling:true,canEditFilledShape:true,canChangeShapeStrokeColor:true,canChangeShapeStrokeWidth:true,canChangeShapeFillColor:true,canChangeLetterSpacing:false,minLetterSpacing:null,maxLetterSpacing:null,canChangeLineSpacing:false,minLineSpacing:null,maxLineSpacing:null,canChangeAdaptText:true,minFontSize:null,maxFontSize:null,canChangeVerticalAlignment:true,canChangeShadowColor:true,canChangeShadowBlur:true,canChangeShadowDistance:true,canChangeShadowAngle:true,minShadowBlur:null,maxShadowBlur:null,minShadowDistance:null,maxShadowDistance:null,minShadowAngle:null,maxShadowAngle:null},idAttribute:"itemID",initialize:function(){},url:function(){return"";},getDesignID:function(){if(this.parentModel)return this.parentModel.getDesignID();return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
},copyAttributes:function(source){this.set("canMove",source.get("canMove"));this.set("canRotate",source.get("canRotate"));this.set("canResize",source.get("canResize"));this.set("canDelete",source.get("canDelete"));this.set("canEdit",source.get("canEdit"));this.set("keepNrChars",source.get("keepNrChars"));this.set("minNrChars",source.get("minNrChars"));this.set("maxNrChars",source.get("maxNrChars"));this.set("paddingTypeID",source.get("paddingTypeID"));this.set("paddingString",source.get("paddingString"));this.set("canChangeFontFamily",source.get("canChangeFontFamily"));this.set("canChangeFontSize",source.get("canChangeFontSize"));this.set("canChangeFontColor",source.get("canChangeFontColor"));this.set("canChangeFontWeight",source.get("canChangeFontWeight"));this.set("canChangeTextPathMode",source.get("canChangeTextPathMode"));this.set("canChangeJustification",source.get("canChangeJustification"));this.set("canTransform",source.get("canTransform"));this.set("canChangeSvgColors",source.get("canChangeSvgColors"));this.set("isAlwaysOnTop",source.get("isAlwaysOnTop"));this.set("isPrintable",source.get("isPrintable"));this.set("mandatoryToEdit",source.get("mandatoryToEdit"));this.set("canSyncContent",source.get("canSyncContent"));this.set("canSyncAlignment",source.get("canSyncAlignment"));this.set("canSyncFontFamily",source.get("canSyncFontFamily"));this.set("canSyncFontStyle",source.get("canSyncFontStyle"));this.set("canSyncFontColor",source.get("canSyncFontColor"));this.set("canSyncCurved",source.get("canSyncCurved"));this.set("canSyncTransforms",source.get("canSyncTransforms"));this.set("canResizeTextBox",source.get("canResizeTextBox"));this.set("canChangeTextBoxMode",source.get("canChangeTextBoxMode"));this.set("toUppercase",source.get("toUppercase"));this.set("canAddMask",source.get("canAddMask"));this.set("canReplaceMask",source.get("canReplaceMask"));this.set("canEditMask",source.get("canEditMask"));this.set("canDeleteMask",source.get("canDeleteMask"));this.set("canEditMaskedImage",source.get("canEditMaskedImage"));this.set("canChangeMaskStrokeColor",source.get("canChangeMaskStrokeColor"));this.set("canChangeMaskStrokeWidth",source.get("canChangeMaskStrokeWidth"));this.set("canFillShape",source.get("canFillShape"));this.set("canReplaceShapeFilling",source.get("canReplaceShapeFilling"));this.set("canEditShapeFilling",source.get("canEditShapeFilling"));this.set("canDeleteShapeFilling",source.get("canDeleteShapeFilling"));this.set("canEditFilledShape",source.get("canEditFilledShape"));this.set("canChangeShapeStrokeColor",source.get("canChangeShapeStrokeColor"));this.set("canChangeShapeStrokeWidth",source.get("canChangeShapeStrokeWidth"));this.set("canChangeShapeFillColor",source.get("canChangeShapeFillColor"));this.set("canChangeLetterSpacing",source.get("canChangeLetterSpacing"));this.set("minLetterSpacing",source.get("minLetterSpacing"));this.set("maxLetterSpacing",source.get("maxLetterSpacing"));this.set("canChangeLineSpacing",source.get("canChangeLineSpacing"));this.set("minLineSpacing",source.get("minLineSpacing"));this.set("canChangeAdaptText",source.get("canChangeAdaptText"));this.set("minFontSize",source.get("minFontSize"));this.set("maxFontSize",source.get("maxFontSize"));this.set("canChangeVerticalAlignment",source.get("canChangeVerticalAlignment"));this.set("canChangeShadowColor",source.get("canChangeShadowColor"));this.set("canChangeShadowBlur",source.get("canChangeShadowBlur"));this.set("canChangeShadowDistance",source.get("canChangeShadowDistance"));this.set("canChangeShadowAngle",source.get("canChangeShadowAngle"));this.set("minShadowBlur",source.get("minShadowBlur"));this.set("maxShadowBlur",source.get("maxShadowBlur"));this.set("minShadowDistance",source.get("minShadowDistance"));this.set("maxShadowDistance",source.get("maxShadowDistance"));this.set("minShadowAngle",source.get("minShadowAngle"));this.set("maxShadowAngle",source.get("maxShadowAngle"));}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignItemTextArt
// -----------------------------------------------------------
MPlaza.DesignItemTextArt=Backbone.AssociatedModel.extend({defaults:{itemID:-1,text:"",fontFamilyID:-1,fontFaceID:-1,textArtTypeID:-1,config:null},idAttribute:"itemID",initialize:function(){if(this.get('config'))this.get('config').parentModel=this;},relations:[{type:Backbone.One,key:'config',relatedModel:MPlaza.TextArtConfig}],url:function(){return"";},getDesignID:function(){if(this.parentModel)return this.parentModel.getDesignID();return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
},copyAttributes:function(source){this.set("text",source.get("text"));this.set("fontFamilyID",source.get("fontFamilyID"));this.set("fontFaceID",source.get("fontFaceID"));this.set("textArtTypeID",source.get("textArtTypeID"));this.unset("config");if(source.get("config")){var sourceConfig=source.get("config");var config=new MPlaza.TextArtConfig();config.set("itemID",this.get("itemID"));config.copyAttributes(sourceConfig);this.set("config",config);}}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignItemShape
// -----------------------------------------------------------
MPlaza.DesignItemShape=Backbone.AssociatedModel.extend({defaults:{itemID:-1,shapeID:-1,isMask:true},idAttribute:"itemID",initialize:function(){},relations:[],url:function(){return"";},getDesignID:function(){if(this.parentModel)return this.parentModel.getDesignID();return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
},copyAttributes:function(source){this.set("shapeID",source.get("shapeID"));this.set("isMask",source.get("isMask"));}});// -----------------------------------------------------------
// DesignItem
// -----------------------------------------------------------
MPlaza.DesignItem=Backbone.AssociatedModel.extend({defaults:{name:"",index:0,json:"",svg:"",imageID:-1,imageType:"",imageFormat:"",imageWidth:0,imageHeight:0,imageDpiX:0,imageDpiY:0,imageFileSize:0,imageCustomerID:-1,imageVisitorID:-1,imagePrice:0,providerImageID:null,applyImagePriceForQuantity:null,imageIsMulticolor:false,imageContainsRaster:false,imagePreferredWidth:null,imagePreferredHeight:null,//non è possibile settarlo del default altrimenti la referenza è condivisa tra più design item
//itemColors: [],
syncGuid:null,isChanged:true,areas:[],colors:[],constraints:null,textArt:null,shape:null,colorMappings:[]},copyAttributes:function(source){this.set("index",source.get("index"));this.set("name",source.get("name"));this.set("json",source.get("json"));this.set("svg",source.get("svg"));this.set("imageID",source.get("imageID"));this.set("imageType",source.get("imageType"));this.set("imageFormat",source.get("imageFormat"));this.set("imageWidth",source.get("imageWidth"));this.set("imageHeight",source.get("imageHeight"));this.set("imageDpiX",source.get("imageDpiX"));this.set("imageDpiY",source.get("imageDpiY"));this.set("imageFileSize",source.get("imageFileSize"));this.set("imageCustomerID",source.get("imageCustomerID"));this.set("imageVisitorID",source.get("imageVisitorID"));this.set("imagePrice",source.get("imagePrice"));this.set("applyImagePriceForQuantity",source.get("applyImagePriceForQuantity"));this.set("providerImageID",source.get("providerImageID"));this.set("imageIsMulticolor",source.get("imageIsMulticolor"));this.set("imageContainsRaster",source.get("imageContainsRaster"));this.set("imagePreferredWidth",source.get("imagePreferredWidth"));this.set("imagePreferredHeight",source.get("imagePreferredHeight"));this.set("isChanged",source.get("isChanged"));this.set("itemColors",[]);if(source.get("itemColors")){for(var i=0;i<source.get("itemColors").length;i++){this.get("itemColors").push(source.get("itemColors")[i]);}}this.unset("colorMappings");this.set("colorMappings",new MPlaza.ColorMappings());if(source.get("colorMappings")){for(var i=0;i<source.get("colorMappings").length;i++){var colorMapping=new MPlaza.ColorMapping();colorMapping.copyAttributes(source.get("colorMappings").at(i));this.get("colorMappings").add(colorMapping);}}this.set("syncGuid",source.get("syncGuid"));for(var i=0;i<source.get("colors").length;i++){var sourceColor=source.get("colors").at(i);var color=this.get('colors').find(x=>x.get('colorID')==sourceColor.get('colorID'));if(!color){color=new MPlaza.DesignItemColor();this.get("colors").add(color);}color.set("imageID",sourceColor.get("imageID"));color.set("colorID",sourceColor.get("colorID"));color.set("colorCode",sourceColor.get("colorCode"));}this.unset("constraints");if(source.get("constraints")){var sourceConstraints=source.get("constraints");var constraints=new MPlaza.DesignItemConstraints();constraints.set("itemID",this.get("itemID"));constraints.copyAttributes(sourceConstraints);this.set("constraints",constraints);}this.unset("textArt");if(source.get("textArt")){var sourceTextArt=source.get("textArt");var textArt=new MPlaza.DesignItemTextArt();textArt.set("itemID",this.get("itemID"));textArt.copyAttributes(sourceTextArt);this.set("textArt",textArt);}this.unset("shape");if(source.get("shape")){var sourceShape=source.get("shape");var shape=new MPlaza.DesignItemShape();shape.set("itemID",this.get("itemID"));shape.copyAttributes(sourceShape);this.set("shape",shape);}},copyConstraints:function(sourceConstraints){this.unset("constraints");if(sourceConstraints){var constraints=new MPlaza.DesignItemConstraints();constraints.set("itemID",this.get("itemID"));constraints.copyAttributes(sourceConstraints);this.set("constraints",constraints);}},copyTextArt:function(sourceTextArt){this.unset("textArt");if(source.get("textArt")){var textArt=new MPlaza.DesignItemTextArt();textArt.set("itemID",this.get("itemID"));textArt.copyAttributes(sourceTextArt);this.set("textArt",textArt);}},copyShape:function(sourceShape){this.unset("shape");if(source.get("shape")){var shape=new MPlaza.DesignItemShape();shape.set("itemID",this.get("itemID"));shape.copyAttributes(sourceShape);this.set("shape",shape);}},idAttribute:"itemGuid",initialize:function(){this.get('areas').parentModel=this;this.get('colors').parentModel=this;if(this.get('constraints'))this.get('constraints').parentModel=this;if(this.get("textArt"))this.get("textArt").parentModel=this;if(!this.get("itemGuid")){this.set("itemGuid",MPlaza.generateUUID());}//non è possibile settarlo del default altrimenti la referenza è condivisa tra più design item
if(!this.get('itemColors')){this.set('itemColors',[]);}},relations:[{type:Backbone.Many,key:'areas',collectionType:MPlaza.DesignItemAreas},{type:Backbone.Many,key:'colors',collectionType:MPlaza.DesignItemColors},{type:Backbone.One,key:'constraints',relatedModel:MPlaza.DesignItemConstraints},{type:Backbone.One,key:'textArt',relatedModel:MPlaza.DesignItemTextArt},{type:Backbone.One,key:'shape',relatedModel:MPlaza.DesignItemShape},{type:Backbone.Many,key:'colorMappings',collectionType:MPlaza.ColorMappings}],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getDesignItemID:function(){return this.get("itemID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},findArea:function(modelID,colorID,sideID,areaID){var areas=this.get("areas");if(areas){return areas.getDesignItemArea(modelID,colorID,sideID,areaID);}return null;},findColor:function(imageID,colorID){var colors=this.get("colors");if(colors){return colors.getDesignItemColor(imageID,colorID);}return null;},toString:function(){// todo.......
},isOnSide:function(side){if(!side||!(side instanceof MPlaza.Side))return false;var areas=this.get("areas");for(var i=0;i<areas.length;i++){var area=areas.at(i);// Used when the side / area are not saved yet
if(area.get("areaGuid")&&(!area.get("areaID")||area.get("areaID")<=0)){for(var k=0;k<side.get("areas").length;k++){if(side.get("areas").at(k).get("guid")==area.get("areaGuid"))return true;}}else{if(// Rimossi controlli su model e color (modifica design applicabili su prodotti diversi)
//area.get("modelID") == side.getModelID() &&
//area.get("colorID") == side.getColorID() &&
area.get("sideID")==side.getSideID())return true;}}return false;},inOnArea:function(area){if(!area&&!(area instanceof MPlaza.Area))return false;return this.findArea(area.getModelID(),area.getColorID(),area.getSideID(),area.getAreaID())!=null;},updateAreas:function(areas){while(this.get("areas").length>0)this.get("areas").pop();for(var i=0;i<areas.length;i++){this.addArea(areas[i]);}},addArea:function(area){if(area&&area instanceof MPlaza.Area){var existingArea=this.findArea(area.getModelID(),area.getColorID(),area.getSideID(),area.getAreaID());if(!existingArea){var designItemArea=new MPlaza.DesignItemArea();designItemArea.set("modelID",area.getModelID());designItemArea.set("colorID",area.getColorID());designItemArea.set("sideID",area.getSideID());designItemArea.set("areaID",area.getAreaID());designItemArea.set("areaGuid",area.get("guid"));// Not saved but used for areas not saved yet
this.get("areas").add(designItemArea);}}},changeColor:function(imageID,colorID,colorCode){if(imageID===this.get("imageID")){var color=this.findColor(imageID,colorID);if(!color){color=new MPlaza.DesignItemColor();color.set("imageID",imageID);color.set("colorID",colorID);this.get("colors").add(color);}color.set("colorCode",colorCode);}},setConstraintsFromSource:function(source){this.unset("constraints");var constraints=new MPlaza.DesignItemConstraints();constraints.itemID=this.get("itemID");constraints.copyAttributes(source);this.set("constraints",constraints);},setTextArtFromSource:function(source){this.unset("textArt");var textArt=new MPlaza.DesignItemTextArt();textArt.itemID=this.get("itemID");textArt.copyAttributes(source);this.set("textArt",textArt);},isTextArt:function(){return this.get("textArt")!==null&&this.get("textArt")!==undefined;}});// -----------------------------------------------------------
// DesignItems
// -----------------------------------------------------------
MPlaza.DesignItems=Backbone.Collection.extend({model:MPlaza.DesignItem,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},getDesignItemByGuid:function(guid){for(var i=0;i<this.length;i++){var designItem=this.at(i);if(designItem.get("itemGuid")==guid)return designItem;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignTemplateCategory
// -----------------------------------------------------------
MPlaza.DesignTemplateCategory=Backbone.AssociatedModel.extend({defaults:{categoryID:-1,name:""},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignTemplateCategories
// -----------------------------------------------------------
MPlaza.DesignTemplateCategories=Backbone.Collection.extend({model:MPlaza.DesignTemplateCategory,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findCategory:function(categoryID){for(var i=0;i<this.length;i++){var category=this.at(i);if(category.get("categoryID")==categoryID)return category;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignTemplateColor
// -----------------------------------------------------------
MPlaza.DesignTemplateColor=Backbone.AssociatedModel.extend({defaults:{colorID:-1,name:"",isDefault:false},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignTemplateColors
// -----------------------------------------------------------
MPlaza.DesignTemplateColors=Backbone.Collection.extend({model:MPlaza.DesignTemplateColor,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findColor:function(colorID){for(var i=0;i<this.length;i++){var color=this.at(i);if(color.get("colorID")==colorID)return color;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignArea
// -----------------------------------------------------------
MPlaza.DesignArea=Backbone.AssociatedModel.extend({defaults:{modelID:-1,colorID:-1,sideID:-1,areaID:-1,printTypeID:-1},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignAreas
// -----------------------------------------------------------
MPlaza.DesignAreas=Backbone.Collection.extend({model:MPlaza.DesignArea,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findArea:function(modelID,colorID,sideID,areaID){for(var i=0;i<this.length;i++){var area=this.at(i);if(area.get("modelID")==modelID&&area.get("colorID")==colorID&&area.get("sideID")==sideID&&area.get("areaID")==areaID)return area;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignAreaGrid
// -----------------------------------------------------------
MPlaza.DesignAreaGrid=Backbone.AssociatedModel.extend({defaults:{modelID:-1,colorID:-1,sideID:-1,areaID:-1,gridID:-1},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignAreasGrids
// -----------------------------------------------------------
MPlaza.DesignAreasGrids=Backbone.Collection.extend({model:MPlaza.DesignAreaGrid,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findAreaGrid:function(modelID,colorID,sideID,areaID,gridID){for(var i=0;i<this.length;i++){var areaGrid=this.at(i);if(areaGrid.get("modelID")==modelID&&areaGrid.get("colorID")==colorID&&areaGrid.get("sideID")==sideID&&areaGrid.get("areaID")==areaID&&areaGrid.get("gridID")==gridID)return areaGrid;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignSidePrintType
// -----------------------------------------------------------
MPlaza.DesignSidePrintType=Backbone.AssociatedModel.extend({defaults:{modelID:-1,colorID:-1,sideID:-1,printTypeID:-1},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignSide
// -----------------------------------------------------------
MPlaza.DesignSidesPrintTypes=Backbone.Collection.extend({model:MPlaza.DesignSidePrintType,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findSidePrintType:function(modelID,colorID,sideID,printTypeID){for(var i=0;i<this.length;i++){var sidePrintType=this.at(i);if(sidePrintType.get("modelID")==modelID&&sidePrintType.get("colorID")==colorID&&sidePrintType.get("sideID")==sideID&&sidePrintType.get("printTypeID")==printTypeID)return sidePrintType;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignSide
// -----------------------------------------------------------
MPlaza.DesignSide=Backbone.AssociatedModel.extend({defaults:{modelID:-1,colorID:-1,sideID:-1,fillColor:"",canAddText:true,canAddImage:true,canAddShape:true,canMaskImages:true,maxNrTexts:null,maxNrImages:null,maxNrShapes:null,canChangeSvgColors:true,uploadRestrictions:null,disableSellerImages:false},initialize:function(){},relations:[],getDesignID:function(){if(this.collection&&this.collection.getDesignID){return this.collection.getDesignID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});MPlaza.DesignSides=Backbone.Collection.extend({model:MPlaza.DesignSide,getDesignID:function(){if(this.parentModel&&this.parentModel.getDesignID){return this.parentModel.getDesignID();}return null;},findSide:function(modelID,colorID,sideID){for(var i=0;i<this.length;i++){var side=this.at(i);if(side.get("modelID")==modelID&&side.get("colorID")==colorID&&side.get("sideID")==sideID)return side;}return null;}});// -----------------------------------------------------------
// DesignClientPreviews
// -----------------------------------------------------------
MPlaza.DesignClientPreview=Backbone.AssociatedModel.extend({defaults:{sideID:-1,fileObjectID:-1,url:""},initialize:function(){},relations:[]});MPlaza.DesignClientPreviews=Backbone.Collection.extend({model:MPlaza.DesignClientPreview});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Design
// -----------------------------------------------------------
MPlaza.Design=Backbone.AssociatedModel.extend({defaults:{modelID:-1,modelName:"",pricingModelID:-1,modelPriceDeltaPerc:0,modelPriceDeltaValue:0,modelPrice:0,modelTextBasePrice:0,modelImageBasePrice:0,printTypeID:-1,description:"",info:"",isTemplate:false,isDraft:false,name:"",templateDesignID:-1,customerID:-1,visitorID:-1,sells:0,finalPrice:0,tempPreviewImageData:null,tempPreviewImageUrl:"",canAddText:true,canAddImage:true,canAddShape:true,canMaskImages:true,maxNrTexts:null,maxNrImages:null,maxNrShapes:null,filterCode:"",canChangeSvgColors:true,uploadRestrictions:null,disableSellerImages:false,hasSyncEnabled:false,sides:[],sidesPrintTypes:[],areasGrids:[],areas:[],designItems:[],categories:[],colors:[],tags:[],clientPreviews:[]},// modificare in docID per salvare su NoSQL
//idAttribute: "designID",
idAttribute:"docID",initialize:function(){var model=this;this.get("sides").parentModel=this;this.get("sidesPrintTypes").parentModel=this;if(!this.get("areasGrids"))this.set("areasGrids",new MPlaza.DesignAreasGrids());this.get("areasGrids").parentModel=this;this.get("areas").parentModel=this;this.get('designItems').parentModel=this;if(!this.get("colors"))this.set("colors",new MPlaza.DesignTemplateColors());this.get("categories").parentModel=this;this.get("colors").parentModel=this;this.on("change",function(){model._fireEvent("change");});this.get("designItems").on("add",function(){model._fireEvent("change");});this.get("designItems").on("remove",function(){model._fireEvent("change");});this.get("designItems").on("change",function(){model._fireEvent("change");});this.get("categories").on("change",function(){model._fireEvent("change");});this.get("colors").on("change",function(){model._fireEvent("change");});this.get("clientPreviews").on("change",function(){model._fireEvent("change");});this.get("sidesPrintTypes").on("change",function(){model._fireEvent("change");});},_eventListeners:{change:[]},_fireEvent:function(eventName,e){if(this._eventListeners&&_.isObject(this._eventListeners)&&_.has(this._eventListeners,eventName)&&_.isArray(this._eventListeners[eventName])){var listeners=this._eventListeners[eventName];for(var i=0;i<listeners.length;++i){listeners[i](e);}}},trigger:function(eventName){this._fireEvent(eventName);},addEventListener:function(eventName,listenerFunction){if(this._eventListeners&&_.isObject(this._eventListeners)){if(!_.has(this._eventListeners,eventName)){this._eventListeners[eventName]=[];}this._eventListeners[eventName].push(listenerFunction);}},isEmpty:function(){return this.get("designItems").length==0;},relations:[{type:Backbone.Many,key:'sides',collectionType:MPlaza.DesignSides},{type:Backbone.Many,key:'sidesPrintTypes',collectionType:MPlaza.DesignSidesPrintTypes},{type:Backbone.Many,key:'areasGrids',collectionType:MPlaza.DesignAreasGrids},{type:Backbone.Many,key:'areas',collectionType:MPlaza.DesignAreas},{type:Backbone.Many,key:'designItems',collectionType:MPlaza.DesignItems},{type:Backbone.Many,key:'categories',collectionType:MPlaza.DesignTemplateCategories},{type:Backbone.Many,key:'colors',collectionType:MPlaza.DesignTemplateColors},{type:Backbone.Many,key:'clientPreviews',collectionType:MPlaza.DesignClientPreviews}],url:function(){// da modificare per utilizzare NoSQL
// url: designdocs/<docID>
//var urlRoot = Zakeke.config.baseApiUrl + 'designs';
//if (this.id != undefined && this.id != null && this.id > 0) {
//    urlRoot = urlRoot + "/" + this.id;
//}
//var urlRoot = Zakeke.config.baseApiUrl + 'designdocs';
// Test per la versione unificata
var urlRoot=Zakeke.config.baseApiUrl+'proxydesigns';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}if(this.attributes.isDraft===true){urlRoot=urlRoot+"/?draft=true";}return urlRoot;},getDesignID:function(){return this.get("designID");},toString:function(){// todo.......
},getDesignItems:function(){return this.get("designItems");},getSideDesignItems:function(side){var items=[];for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.isOnSide(side))items.push(designItem);}items.sort(function(a,b){return a.get("index")-b.get("index");});return items;},getAreaDesignItems:function(area){var items=[];if(area&&area instanceof MPlaza.Area){for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.inOnArea(area))items.push(designItem);}}items.sort(function(a,b){return a.get("index")-b.get("index");});return items;},setModel:function(model){if(!model||!(model instanceof MPlaza.Model))return;this.set("modelID",model.get("modelID"));this.set("modelName",model.get("name"));this.set("pricingModelID",model.get("pricingModelID"));var printTypeID=this.get("printTypeID");this.set("modelPriceDeltaPerc",model.getModelPriceDeltaPerc(printTypeID));this.set("modelPriceDeltaValue",model.getModelPriceDeltaValue(printTypeID));this.set("modelPrice",model.getModelPrice(printTypeID));this.set("modelTextBasePrice",model.getModelTextBasePrice(printTypeID));this.set("modelImageBasePrice",model.getModelImageBasePrice(printTypeID));},setPrintType:function(printType){if(!printType||!(printType instanceof MPlaza.PrintType))return;this.set("printTypeID",printType.get("printTypeID")||printType.tempID);this.set("modelPriceDeltaPerc",printType.get("priceDeltaPerc"));this.set("modelPriceDeltaValue",printType.get("priceDeltaValue"));this.set("modelPrice",printType.get("price"));this.set("modelTextBasePrice",printType.get("textBasePrice"));this.set("modelImageBasePrice",printType.get("imageBasePrice"));},cloneWithDifferentModel:function(model){var design=new MPlaza.Design();if(!model||!(model instanceof MPlaza.Model))return design;if(model.get("modelID")==this.get("modelID"))return this.clone();if(model.get("colors").length==0)return design;design.setModel(model);//design.set("modelID", model.get("modelID"));
// Print Type
var printType=model.get("printTypes").getPrintType(this.get("printTypeID"));if(!printType&&model.get("printTypes").length>0)printType=model.get("printTypes").at(0);if(printType)design.set("printTypeID",printType.get("printTypeID"));else design.set("printTypeID",-1);// Assegno gli elmenti grafici al primo colore disponibile
var modelColor=model.get("colors").at(0);if(modelColor){// Design Items
for(var i=0;i<this.get("designItems").length;i++){var sourceDesignItem=this.get("designItems").at(i);var designItem=new MPlaza.DesignItem();designItem.copyAttributes(sourceDesignItem);// Reassign areas
for(var j=0;j<sourceDesignItem.get("areas").length;j++){var sourceDesignItemArea=sourceDesignItem.get("areas").at(j);var modelSide=modelColor.get("sides").getSide(sourceDesignItemArea.get("sideID"));if(modelSide){var modelArea=modelSide.get("areas").getAreaByID(sourceDesignItemArea.get("areaID"));if(modelArea){designItem.addArea(modelArea);}}}if(designItem.get("areas").length>0)design.get("designItems").add(designItem);}}// categorie
for(var k=0;k<this.get("categories").length;k++){var sourceCategory=this.get("categories").at(k);var category=new MPlaza.DesignTemplateCategory();category.set("categoryID",sourceCategory.get("categoryID"));category.set("name",sourceCategory.get("name"));designs.get("categories").add(category);}// colors
for(var k=0;k<this.get("colors").length;k++){var sourceColor=this.get("colors").at(k);var color=new MPlaza.DesignTemplateColor();color.set("colorID",sourceColor.get("colorID"));color.set("name",sourceColor.get("name"));designs.get("colors").add(color);}return design;},changeColor:function(color){if(!color)return;// Modifico il colore dei lati corrispondenti ed elimino
// i lati non presenti nella versione del nuovo colore
var sidesToRemove=[];var sidesPrintTypesToRemove=[];var areasGridsToRemove=[];for(let map of this.get("areasGrids").models){map.set("modelID",color.getModelID());if(color.get("sides").find(s=>s.id==map.get("sideID")))map.set("colorID",color.getColorID());}for(var k=0;k<this.get("sides").length;k++){var designSide=this.get("sides").at(k);var sideFound=null;if(designSide.get("modelID")==color.getModelID()){var modelSide=color.get("sides").getSide(designSide.get("sideID"));if(modelSide){sideFound=modelSide;}}var designSidePrintType=null;let areaGrids=null;for(var j=0;j<this.get("sidesPrintTypes").length;j++){var print=this.get("sidesPrintTypes").at(j);if(print.get("modelID")==designSide.get("modelID")&&print.get("colorID")==designSide.get("colorID")&&print.get("sideID")==designSide.get("sideID"))designSidePrintType=print;}for(var z=0;z<this.get("areasGrids").length;z++){let map=this.get("areasGrids").at(z);if(map.get("modelID")==designSide.get("modelID")&&map.get("colorID")==designSide.get("colorID")&&map.get("sideID")==designSide.get("sideID"))areaGrids=map;}if(sideFound){var oldDesignSide=null;for(var side of this.get("sides").models){if(side!==designSide&&side.get("modelID")===color.getModelID()&&side.get("colorID")===color.getColorID()&&side.get("sideID")===designSide.get("sideID"))oldDesignSide=side;}if(oldDesignSide)sidesToRemove.push(designSide);else designSide.set("colorID",color.get("colorID"));var oldDesignSidePrintType=null;for(var sidePrint of this.get("sidesPrintTypes").models){if(sidePrint!==designSidePrintType&&sidePrint.get("modelID")===color.getModelID()&&sidePrint.get("colorID")===color.getColorID()&&sidePrint.get("sideID")===designSide.get("sideID"))oldDesignSidePrintType=sidePrint;}if(oldDesignSidePrintType&&designSidePrintType){sidesPrintTypesToRemove.push(designSidePrintType);}else if(designSidePrintType){designSidePrintType.set("colorID",color.get("colorID"));}else if(!oldDesignSidePrintType){var newPrintTypeID=-1;if(sideFound.get("printTypes").length>0)newPrintTypeID=sideFound.get("printTypes").at(0);else newPrintTypeID=color.getParentModel().get("printTypes").at(0);var newSidePrint=new MPlaza.DesignSidePrintType();newSidePrint.set("modelID",designSide.get("modelID"));newSidePrint.set("colorID",designSide.get("colorID"));newSidePrint.set("sideID",designSide.get("sideID"));newSidePrint.set("printTypeID",newPrintTypeID);this.get("sidesPrintTypes").add(newSidePrint);}}else{sidesToRemove.push(designSide);if(designSidePrintType)sidesPrintTypesToRemove.push(designSidePrintType);if(areaGrids)areasGridsToRemove.push(areaGrids);}}for(var sideToRemove of sidesToRemove)this.get("sides").remove(sideToRemove);for(var sidePrintTypeToRemove of sidesPrintTypesToRemove)this.get("sidesPrintTypes").remove(sidePrintTypeToRemove);for(let areaGridsToRemove of areasGridsToRemove)this.get("areasGrids").remove(areaGridsToRemove);// Assegno i designItem alle aree corrispondenti nel nuovo colore
var designItemsToRemove=[];for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);// Modifico il colore delle aree corrispondenti ed elimino
// le aree non presenti nella versione del nuovo colore
var areasToRemove=[];for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);var found=false;if(designItemArea.get("modelID")==color.getModelID()){var side=color.get("sides").getSide(designItemArea.get("sideID"));if(side){var area=side.get("areas").getAreaByID(designItemArea.get("areaID"));if(area){found=true;}}}if(found){designItemArea.set("colorID",color.get("colorID"));}else{areasToRemove.push(designItemArea);}}if(areasToRemove.length>0)designItem.get("areas").remove(areasToRemove);if(designItem.get("areas").length==0)designItemsToRemove.push(designItem);}if(designItemsToRemove.length>0)this.get("designItems").remove(designItemsToRemove);// Force trigger the change event
this._fireEvent("change");},addSide:function(side){if(side&&side instanceof MPlaza.Side){var existingSide=this.get("sides").findSide(side.getModelID(),side.getColorID(),side.getSideID());if(!existingSide){var designSide=new MPlaza.DesignSide();designSide.set("modelID",area.getModelID());designSide.set("colorID",area.getColorID());designSide.set("sideID",area.getSideID());this.get("sides").add(designSide);}}},addSidePrintType:function(side,sidePrintType){if(side&&sidePrintType&&side instanceof MPlaza.Side&&sidePrintType instanceof MPlaza.PartPrintType){var existingSidePrintType=this.get("sidesPrintTypes").findSidePrintType(side.getModelID(),side.getColorID(),side.getSideID(),sidePrintType.getPrintTypeID());if(!existingSidePrintType){var designSidePrintType=new MPlaza.DesignSidePrintType();designSidePrintType.set("modelID",side.getModelID());designSidePrintType.set("colorID",side.getColorID());designSidePrintType.set("sideID",side.getSideID());designSidePrintType.set("printTypeID",sidePrintType.getPrintTypeID());this.get("sidesPrintTypes").add(designSidePrintType);}}},addArea:function(area){if(area&&side instanceof MPlaza.Area){var existingArea=this.get("areas").findArea(area.getModelID(),area.getColorID(),area.getSideID(),area.getAreaID());if(!existingArea){var designArea=new MPlaza.DesignArea();designArea.set("modelID",area.getModelID());designArea.set("colorID",area.getColorID());designArea.set("sideID",area.getSideID());designArea.set("areaID",area.getAreaID());designArea.set("areaGuid",area.get("guid"));// Not saved but used for areas not saved yet
this.get("areas").add(designArea);}}},getDesignSide:function(side){if(side&&side instanceof MPlaza.Side){return this.get("sides").findSide(side.getModelID(),side.getColorID(),side.getSideID());}},getDesignSidePrintType:function(side,sidePrintType){if(side&&sidePrintType&&side instanceof MPlaza.Side&&sidePrintType instanceof MPlaza.PartPrintType){return this.get("sidesPrintTypes").findSide(side.getModelID(),side.getColorID(),side.getSideID(),sidePrintType.getPrintTypeID());}},getDesignArea:function(area){if(area&&area instanceof MPlaza.Area){return this.get("areas").findArea(area.getModelID(),area.getColorID(),area.getSideID(),area.getAreaID());}},getSelectedPrintTypeForArea:function(area){if(!area)return this.get("printTypeID");var designArea=this.getDesignArea(area);// If design has custom area print use it
if(designArea&&designArea.get("printTypeID")&&designArea.get("printTypeID")>0)return parseInt(designArea.get("printTypeID"));// Else check for side
var designSidePrintType=null;for(var j=0;j<this.get("sidesPrintTypes").length;j++){var print=this.get("sidesPrintTypes").at(j);if(print.get("modelID")==area.getModelID()&&print.get("colorID")==area.getColorID()&&print.get("sideID")==area.getSideID())designSidePrintType=print;}if(designSidePrintType)return parseInt(designSidePrintType.get("printTypeID"));// Else use design print type
return parseInt(this.get("printTypeID"));},getImageDesignItems:function(imageID){var items=[];for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")==imageID)items.push(designItem);}return items;},getDesignPrice:function(model,quantity=1){var price=0;var customerID=this.get("customerID");var visitorID=this.get("visitorID");var imageItemsGroups=[];for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")>0){price+=this.get("modelImageBasePrice");var pricePerImage=designItem.get("imagePrice");if(pricePerImage>0&&!imageItemsGroups.find(x=>x.get("providerImageID")===designItem.get("providerImageID"))){imageItemsGroups.push(designItem);if(!model.get("hasAdditionalFeeOnImagesProvider"))pricePerImage=designItem.get("applyImagePriceForQuantity")==null||designItem.get("applyImagePriceForQuantity")?pricePerImage:pricePerImage/quantity;if(customerID>0){if(customerID!=designItem.get("imageCustomerID"))price+=pricePerImage;}else if(visitorID>0){if(visitorID!=designItem.get("imageVisitorID"))price+=pricePerImage;}else{price+=pricePerImage;}}}else{price+=this.get("modelTextBasePrice");}}return price*quantity;},getPrice:function(){var price=this.get("modelFinalPrice");return Math.round(price*100)/100;},getDesignPriceEx:function(model,quantity){counter={};if(model&&model instanceof MPlaza.Model&&quantity>0){for(var i=0;i<model.get("colors").length;i++){var color=model.get("colors").at(i);for(var j=0;j<color.get("sides").length;j++){var side=color.get("sides").at(j);for(var k=0;k<side.get("areas").length;k++){var area=side.get("areas").at(k);var designItems=this.getAreaDesignItems(area).filter(function(item){var constraints=item.get("constraints");if(!constraints)return true;return constraints.get("isPrintable")==true;});if(designItems.length>0){this.addAreaPrice(area,designItems,quantity,counter);}}}}}// Il prezzo finale è dato dalla somma di tutti i valori in counterS
var sum=0;for(var key in counter){if(counter.hasOwnProperty(key)){var value=counter[key];if(!isNaN(value)){sum+=value;}}}var price=Math.round(sum*100)/100;return price;},// Aggiunge a counter il prezzo dovuto per l'area
addAreaPrice:function(area,items,quantity,counter){//var printTypeID = this.get("printTypeID"); // In futuro il tipo di stampa sarà assegnabile alla singola area
var printTypeID=this.getSelectedPrintTypeForArea(area);// Quel futuro è arrivato
var pricingRef=this.getAreaPricingRef(area,printTypeID);var pricingApplicationType=pricingRef.pricingApplicationType;var model=area.getModel();if(model&&model instanceof MPlaza.Model&&model.get("pricings")){var setupPrice=0;var designPrice=0;var pricing=pricingRef.pricingID>0?model.get("pricings").getPricing(pricingRef.pricingID):null;if(pricing&&pricing instanceof MPlaza.Pricing){var areaColorsCount=0;if(pricing.get("setupPriceTypeID")==MPlaza.PricingType.PerColor||pricing.get("designPriceTypeID")==MPlaza.PricingType.PerColor){areaColorsCount=this.getAreaColorsCount(area,items);}// Prezzo di setup
var setupPriceInfo=pricing.getSetupPriceForQuantity(quantity);if(setupPriceInfo){if(pricing.get("setupPriceTypeID")==MPlaza.PricingType.PerColor){// Il prezzo del setup va calcolato in base al numero di colori del design
if(areaColorsCount>0){var remainder=areaColorsCount;if(setupPriceInfo.get("firstColorPrice")!=undefined&&setupPriceInfo.get("firstColorPrice")!=null){setupPrice+=setupPriceInfo.get("firstColorPrice");remainder--;}setupPrice+=remainder*setupPriceInfo.get("price");}}else if(pricing.get("setupPriceTypeID")==MPlaza.PricingType.Global){setupPrice+=setupPriceInfo.get("price");}}// Prezzo di design
var designPriceInfo=pricing.getDesignPriceForQuantity(quantity);if(designPriceInfo){if(pricing.get("designPriceTypeID")==MPlaza.PricingType.PerColor){// Il prezzo del design va calcolato in base al numero di colori del design
if(areaColorsCount>0){var remainder=areaColorsCount;if(designPriceInfo.get("firstColorPrice")!=undefined&&designPriceInfo.get("firstColorPrice")!=null){designPrice+=designPriceInfo.get("firstColorPrice")*quantity;remainder--;}designPrice+=remainder*designPriceInfo.get("price")*quantity;}}else if(pricing.get("designPriceTypeID")==MPlaza.PricingType.Global){designPrice+=designPriceInfo.get("price")*quantity;}}}// Ora il prezzo (setup + design) va assegnato
var counterKey=null;switch(pricingApplicationType){case MPlaza.PricingApplicationType.Global:counterKey=this.getModelCounterKey(area.getModel(),printTypeID);break;case MPlaza.PricingApplicationType.PerSide:counterKey=this.getSideCounterKey(area.getSide(),printTypeID);break;case MPlaza.PricingApplicationType.PerArea:counterKey=this.getAreaCounterKey(area,printTypeID);break;}if(counterKey!=null)counter[counterKey]=setupPrice+designPrice;// Aggiungo il prezzo delle immagini esterne utilizzate
var imageItemsGroups=[];for(var i=0;i<items.length;i++){var item=items[i];if(item.get("imageID")>0&&item.get("imagePrice")>0&&!imageItemsGroups.find(x=>x.get("providerImageID")===item.get("providerImageID"))){imageItemsGroups.push(item);var pricePerImage=item.get("imagePrice");if(!model.get("hasAdditionalFeeOnImagesProvider"))pricePerImage=item.get("applyImagePriceForQuantity")===null||item.get("applyImagePriceForQuantity")?item.get("imagePrice")*quantity:item.get("imagePrice");else pricePerImage=item.get("imagePrice")*quantity;// TODO aggiungere la verifica del customerCode/visitorCode per l'immagine
var key=this.getImageCounterKey(item.get("providerImageID"));if(!(key in counter)){var imagePrice=pricePerImage;counter[key]=imagePrice+(counter[key]||0);}}}}},// Per l'area e il tipo di stampa in input determina il pricing con il tipo di applicazione
getAreaPricingRef:function(area,printTypeID){var pricingID=-1;var pat=MPlaza.PricingApplicationType.Undefined;var areaPrintType=area.getPrintType(printTypeID);if(areaPrintType&&areaPrintType.get("pricingID")>0){pricingID=areaPrintType.get("pricingID");pat=areaPrintType.get("patID");}else{var side=area.getParentModel();var sidePrintType=side.getPrintType(printTypeID);if(sidePrintType&&sidePrintType.get("pricingID")>0){pricingID=sidePrintType.get("pricingID");pat=sidePrintType.get("patID");}else{var color=side.getParentModel();var colorPrintType=color.getPrintType(printTypeID);if(colorPrintType&&colorPrintType.get("pricingID")>0){pricingID=colorPrintType.get("pricingID");pat=colorPrintType.get("patID");}else{var model=color.getParentModel();var modelPrintType=model.getPrintType(printTypeID);if(modelPrintType&&modelPrintType.get("pricingID")>0){pricingID=modelPrintType.get("pricingID");pat=modelPrintType.get("patID");}}}}return{pricingID:pricingID,pricingApplicationType:pat};},getAreaColorsCount:function(area,items){var counts={};for(var i=0;i<items.length;i++){var colors=items[i].get("itemColors");for(var j=0;j<colors.length;j++){counts[colors[j]]=1+(counts[colors[j]]||0);}}return Object.keys(counts).length;},getModelCounterKey:function(model,printTypeID){return printTypeID+"_"+model.get("modelID");},getColorCounterKey:function(color,printTypeID){return printTypeID+"_"+color.getModelID()+"_"+color.get("colorID");},getSideCounterKey:function(side,printTypeID){return printTypeID+"_"+side.getModelID()+"_"+side.getColorID()+"_"+side.get("sideID");},getAreaCounterKey:function(area,printTypeID){return printTypeID+"_"+area.getModelID()+"_"+area.getColorID()+"_"+area.getSideID()+"_"+area.get("areaID");},getImageCounterKey:function(imageID){return"img_"+imageID;},countTextItemsForColor:function(modelID,colorID){var hash={};// serve per contare un elemento una sola volta
var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")<=0){// Elemento di testo
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}return count;},countTextItemsForSide:function(modelID,colorID,sideID){var hash={};// serve per contare un elemento una sola volta
var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")<=0){// Elemento di testo
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID&&designItemArea.get("sideID")==sideID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}return count;},countImageItemsForColor:function(modelID,colorID){var hash={};var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")>0){// Immagine
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}return count;},countImageItemsForSide:function(modelID,colorID,sideID){var hash={};var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")>0){// Immagine
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID&&designItemArea.get("sideID")==sideID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}return count;},countShapeItemsForColor:function(modelID,colorID){var hash={};var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);var designShape=designItem.get("shape");if(designShape&&!designShape.get("isMask")){// è una shape non usata come maschera di immagine
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}return count;},countShapeItemsForSide:function(modelID,colorID,sideID){var hash={};var count=0;for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")>0){var designShape=designItem.get("shape");if(designShape&&!designShape.get("isMask")){// è una shape non usata come maschera di immagine
for(var j=0;j<designItem.get("areas").length;j++){var designItemArea=designItem.get("areas").at(j);if(designItemArea.get("modelID")==modelID&&designItemArea.get("colorID")==colorID&&designItemArea.get("sideID")==sideID){if(!hash.hasOwnProperty(designItem.get("itemGuid"))){count++;hash[designItem.get("itemGuid")]=true;}}}}}}return count;},getTextItemsFonts:function(){var fonts=[];for(var i=0;i<this.get("designItems").length;i++){var designItem=this.get("designItems").at(i);if(designItem.get("imageID")<=0){var json=designItem.get("json");var data=JSON.parse(json);var attributes=data[1];//Get the global font family or from the first letter (in case of curved text)
var font=attributes.fontFamily||(attributes.children&&attributes.children.length>0&&attributes.children[0].length>1?attributes.children[0][1].fontFamily:null);font=font.replace(/"/g,'');if(!_.contains(fonts,font))fonts.push(font);}}return fonts;}});// -----------------------------------------------------------
// Designs
// -----------------------------------------------------------
MPlaza.Designs=Backbone.Collection.extend({model:MPlaza.Design,url:function(){return Zakeke.config.baseApiUrl+'designs';},getDesign:function(designID){for(var i=0;i<this.length;i++){var design=this.at(i);if(design.get("designID")==designID)return design;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ImageColor
// -----------------------------------------------------------
MPlaza.ImageColor=Backbone.AssociatedModel.extend({defaults:{colorID:-1,code:""},initialize:function(){},relations:[],getImageID:function(){if(this.collection&&this.collection.getImageID){return this.collection.getImageID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ImageColors
// -----------------------------------------------------------
MPlaza.ImageColors=Backbone.Collection.extend({model:MPlaza.ImageColor,getImageID:function(){if(this.parentModel&&this.parentModel.getImageID){return this.parentModel.getImageID();}return null;},findColor:function(colorID){for(var i=0;i<this.length;i++){var imageColor=this.at(i);if(imageColor.get("colorID")==colorID)return imageColor;}return null;},setupUrlForImageID:function(imageID){this.url=function(){return Zakeke.config.baseApiUrl+'images/'+imageID+"/colors";};}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ImageAssignedCategory
// -----------------------------------------------------------
MPlaza.ImageAssignedCategory=Backbone.AssociatedModel.extend({defaults:{categoryID:-1,name:""},initialize:function(){},relations:[],getImageID:function(){if(this.collection&&this.collection.getImageID){return this.collection.getImageID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ImageAssignedCategories
// -----------------------------------------------------------
MPlaza.ImageAssignedCategories=Backbone.Collection.extend({model:MPlaza.ImageAssignedCategory,getImageID:function(){if(this.parentModel&&this.parentModel.getImageID){return this.parentModel.getImageID();}return null;},findCategory:function(categoryID){for(var i=0;i<this.length;i++){var category=this.at(i);if(category.get("categoryID")==categoryID)return category;}return null;},setupUrlForImageID:function(imageID){this.url=function(){return Zakeke.config.baseApiUrl+'images/'+imageID+"/categories";};}});// -----------------------------------------------------------
// Image
// -----------------------------------------------------------
MPlaza.Image=Backbone.AssociatedModel.extend({defaults:{imageID:-1,name:"",type:"",format:"",width:0,height:0,dpiX:0,dpiY:0,isMulticolor:false,containsRaster:false,isFilterApplied:false,imageFileSize:0,sellerID:-1,visitorID:-1,customerID:-1,price:0,url:"",previewUrl:"",choiceUrl:"",preferredWidth:null,preferredHeight:null,colors:[],categories:[],selectionColors:"",sourceUrlImage:"",applyPriceForQuantity:null},idAttribute:"imageID",initialize:function(){var image=this;this.get("colors").parentModel=this;this.get('colors').url=function(){return image.url()+'/'+image.id+'/imagecolors';};this.get("categories").parentModel=this;this.get('categories').url=function(){return image.url()+'/'+image.id+'/categories';};},relations:[{type:Backbone.Many,key:'colors',collectionType:MPlaza.ImageColors},{type:Backbone.Many,key:'categories',collectionType:MPlaza.ImageAssignedCategories}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'images';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getImageID:function(){return this.get("imageID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Images
// -----------------------------------------------------------
MPlaza.Images=Backbone.Collection.extend({model:MPlaza.Image,url:function(){return Zakeke.config.baseApiUrl+'images';},getImage:function(imageID){for(var i=0;i<this.length;i++){var image=this.at(i);if(image.get("imageID")==imageID)return image;}return null;}});// -----------------------------------------------------------
// Images for backgrounds
// -----------------------------------------------------------
MPlaza.BgImages=Backbone.Collection.extend({model:MPlaza.Image,url:function(){return Zakeke.config.baseApiUrl+'images?onlybackground=true';},getImage:function(imageID){for(var i=0;i<this.length;i++){var image=this.at(i);if(image.get("imageID")==imageID)return image;}return null;}});// -----------------------------------------------------------
// Image Format Count
// -----------------------------------------------------------
MPlaza.ImageFormatCount=Backbone.AssociatedModel.extend({defaults:{fileFormat:"",rastersCount:0,vectorsCount:0},idAttribute:"fileFormat",url:function(){return null;}});// -----------------------------------------------------------
// Image Formats Counts
// -----------------------------------------------------------
MPlaza.ImageFormatsCounts=Backbone.Collection.extend({model:MPlaza.ImageFormatCount,url:function(){return null;},comparator:function(model){return model.get("fileFormat");}});// -----------------------------------------------------------
// Image Category
// -----------------------------------------------------------
MPlaza.ImageCategory=Backbone.AssociatedModel.extend({defaults:{categoryID:-1,name:"",imagesCount:0,imageFormatsCounts:[]},idAttribute:"categoryID",initialize:function(){this.get("imageFormatsCounts").parentModel=this;},relations:[{type:Backbone.Many,key:'imageFormatsCounts',collectionType:MPlaza.ImageFormatsCounts}],url:function(){return null;}});// -----------------------------------------------------------
// Images Categories
// -----------------------------------------------------------
MPlaza.ImageCategories=Backbone.Collection.extend({model:MPlaza.ImageCategory,url:function(){return null;},comparator:function(model){return model.get("name");}});// -----------------------------------------------------------
// Image Macro Category
// -----------------------------------------------------------
MPlaza.ImageMacroCategory=Backbone.AssociatedModel.extend({defaults:{macroCategoryID:-1,name:"",onlyForBackgrounds:false,imagesCount:0,categories:[]},idAttribute:"macroCategoryID",initialize:function(){this.get("categories").parentModel=this;},relations:[{type:Backbone.Many,key:'categories',collectionType:MPlaza.ImageCategories}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'imagesMacroCategories';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;}});// -----------------------------------------------------------
// Images Macro Categories
// -----------------------------------------------------------
MPlaza.ImageMacroCategories=Backbone.Collection.extend({model:MPlaza.ImageMacroCategory,url:function(){return Zakeke.config.baseApiUrl+'imageMacroCategories';},comparator:function(model){return model.get("name");}});MPlaza.ImageMacroCategoriesBackground=Backbone.Collection.extend({model:MPlaza.ImageMacroCategory,url:function(){return Zakeke.config.baseApiUrl+'imageMacroCategories?onlybackground=true';},comparator:function(model){return model.get("name");}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ColorChange
// -----------------------------------------------------------
MPlaza.ColorChange=Backbone.AssociatedModel.extend({defaults:{colorID:-1,code:""},initialize:function(){},relations:[],getImageID:function(){if(this.collection&&this.collection.getImageID){return this.collection.getImageID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ColorChanges
// -----------------------------------------------------------
MPlaza.ColorChanges=Backbone.Collection.extend({model:MPlaza.ColorChange,getImageID:function(){if(this.parentModel&&this.parentModel.getImageID){return this.parentModel.getImageID();}return null;},findColor:function(colorID){for(var i=0;i<this.length;i++){var change=this.at(i);if(change.get("colorID")==colorID)return change;}return null;}});// -----------------------------------------------------------
// RecoloredImage
// -----------------------------------------------------------
MPlaza.RecoloredImage=Backbone.AssociatedModel.extend({defaults:{imageID:-1,colorChanges:[],versionKey:"",imageUrl:""},idAttribute:"imageID",initialize:function(){this.get("colorChanges").parentModel=this;},relations:[{type:Backbone.Many,key:'colorChanges',collectionType:MPlaza.ColorChanges}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'recoloredimages';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getImageID:function(){return this.get("imageID");},toString:function(){// todo.......
}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Drawing Item
// -----------------------------------------------------------
MPlaza.DrawingItem=Backbone.Model.extend({defaults:{guid:null,info:""},initialize:function(){this.set("guid",MPlaza.generateUUID());}});// -----------------------------------------------------------
// Drawing Items
// -----------------------------------------------------------
MPlaza.DrawingItems=Backbone.Collection.extend({model:MPlaza.DrawingItem,getDrawingItem:function(guid){for(var i=0;i<this.length;i++){var item=this.at(i);if(item.get("guid")==guid)return item;}return null;}});// ------------------------------------------------------------
// Compositions 
// ------------------------------------------------------------
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// CompositionItem
// -----------------------------------------------------------
MPlaza.CompositionItem=Backbone.AssociatedModel.extend({defaults:{attributeID:-1,attributeGuid:"",attributeTypeID:MPlaza.AttributeType.Options,attributeCode:"",attributeName:"",selectedOptionID:null,selectedOptionGuid:null,selectedOptionCode:"",selectedOptionName:null,selectedValue:null},copyAttributes:function(source){this.set("attributeID",source.get("attributeID"));this.set("attributeGuid",source.get("attributeGuid"));this.set("attributeTypeID",source.get("attributeTypeID"));this.set("attributeCode",source.get("attributeCode"));this.set("attributeName",source.get("attributeName"));this.set("selectedOptionID",source.get("selectedOptionID"));this.set("selectedOptionGuid",source.get("selectedOptionGuid"));this.set("selectedOptionCode",source.get("selectedOptionCode"));this.set("selectedOptionName",source.get("selectedOptionName"));this.set("selectedValue",source.get("selectedValue"));},idAttribute:"itemGuid",initialize:function(){if(!this.get("itemGuid")){this.set("itemGuid",MPlaza.generateUUID());}},getCompositionID:function(){if(this.collection&&this.collection.getCompositionID){return this.collection.getCompositionID();}return null;},getCompositionItemID:function(){return this.get("itemID");},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// CompositionItems
// -----------------------------------------------------------
MPlaza.CompositionItems=Backbone.Collection.extend({model:MPlaza.CompositionItem,getCompositionID:function(){if(this.parentModel&&this.parentModel.getCompositionID){return this.parentModel.getCompositionID();}return null;},getCompositionItem:function(itemID){for(var i=0;i<this.length;i++){var item=this.at(i);if(item.get("itemID")==itemID)return item;}return null;},getCompositionItemByAttributeID:function(attributeID){for(var i=0;i<this.length;i++){var item=this.at(i);if(item.get("attributeID")==attributeID)return item;}return null;},getCompositionItemByAttributeGuid:function(attributeGuid){for(var i=0;i<this.length;i++){var item=this.at(i);if(item.get("attributeGuid")==attributeGuid)return item;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Composition
// -----------------------------------------------------------
MPlaza.Composition=Backbone.AssociatedModel.extend({defaults:{name:"",designID:-1,designDocID:"",modelID:-1,modelName:"",modelPrice:0,customerID:-1,visitorID:-1,finalPrice:0,previewImageData:null,previewImageUrl:"",compositionItems:[]},// modificare in docID per salvare su NoSQL
//idAttribute: "designID",
idAttribute:"docID",initialize:function(){var model=this;this.get('compositionItems').parentModel=this;this.on("change",function(){model._fireEvent("change");});this.get("compositionItems").on("add",function(){model._fireEvent("change");});this.get("compositionItems").on("remove",function(){model._fireEvent("change");});this.get("compositionItems").on("change",function(){model._fireEvent("change");});},_eventListeners:{change:[]},_fireEvent:function(eventName,e){if(this._eventListeners&&_.isObject(this._eventListeners)&&_.has(this._eventListeners,eventName)&&_.isArray(this._eventListeners[eventName])){var listeners=this._eventListeners[eventName];for(var i=0;i<listeners.length;++i){listeners[i](e);}}},trigger:function(eventName){this._fireEvent(eventName);},addEventListener:function(eventName,listenerFunction){if(this._eventListeners&&_.isObject(this._eventListeners)){if(!_.has(this._eventListeners,eventName)){this._eventListeners[eventName]=[];}this._eventListeners[eventName].push(listenerFunction);}},isEmpty:function(){return this.get("compositionItems").length==0;},relations:[{type:Backbone.Many,key:'compositionItems',collectionType:MPlaza.CompositionItems}],url:function(){// da modificare per utilizzare NoSQL
// url: designdocs/<docID>
//var urlRoot = Zakeke.config.baseApiUrl + 'designs';
//if (this.id != undefined && this.id != null && this.id > 0) {
//    urlRoot = urlRoot + "/" + this.id;
//}
var urlRoot=Zakeke.config.baseApiUrl+'compositiondocs';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getCompositionID:function(){return this.get("compositionID");},toString:function(){// todo.......
},setModel:function(model){if(!model||!(model instanceof MPlaza.Model))return;this.set("modelID",model.get("modelID"));this.set("modelName",model.get("name"));this.set("modelPrice",model.getModelPrice(printTypeID));},getCompositionItemByAttributeID:function(attributeID){return this.get("compositionItems").getCompositionItemByAttributeID(attributeID);},getCompositionItemByAttributeGuid:function(attributeGuid){return this.get("compositionItems").getCompositionItemByAttributeGuid(attributeGuid);},getPrice:function(model,quantity){var price=model.get("price");for(var i=0;i<this.get("compositionItems").length;i++){var item=this.get("compositionItems").at(i);var attribute=model.getAttribute(item.get("attributeID"));var attributePricing=this.getAttributePricing(item,model);if(attributePricing){if(attributePricing.get("pricingID")!=undefined&&attributePricing.get("pricingID")>0){// Pricing avanzato
var pricing=model.getComposerPricing(attributePricing.get("pricingID"));if(pricing){var composerPrice=pricing.getComposerPricingPriceForQuantity(quantity);if(composerPrice){price+=composerPrice.get("price");}}}else{// Pricing semplice
price+=attributePricing.get("price");}}}return price*quantity;},getAttributePricing:function(compositionItem,model){var attributePricing=null;var attribute=model.getAttribute(compositionItem.get("attributeID"));// Verifico prima se ci sono pricing legati alla specifica opzione
if(compositionItem.get("attributeTypeID")==MPlaza.AttributeType.Options&&compositionItem.get("selectedOptionID")){// Attributo di tipo elenco opzioni
for(var i=0;i<attribute.get("pricings").length;i++){var pricing=attribute.get("pricings").at(i);if(pricing.get("selectedOptionID")==compositionItem.get("selectedOptionID")){var attributeExpression=pricing.get("constraintExpression");if(!attributeExpression||this.evaluateAttributeExpression(attributeExpression)){attributePricing=pricing;break;}}}}else if(compositionItem.get("selectedValue")){// Attributo a valore aperto
for(var i=0;i<attribute.get("pricings").length;i++){var pricing=attribute.get("pricings").at(i);if(pricing.get("selectedValue")==compositionItem.get("selectedValue")){var attributeExpression=pricing.get("constraintExpression");if(!attributeExpression||this.evaluateAttributeExpression(attributeExpression)){attributePricing=pricing;break;}}}}// Se non c'è un pricing specifico per opzione/valore cerco verifico se
// c'è un pricing generico per l'attributo
if(!attributePricing){// Attributo di tipo elenco opzioni
for(var i=0;i<attribute.get("pricings").length;i++){var pricing=attribute.get("pricings").at(i);if(!pricing.get("selectedOptionID")&&!pricing.get("selectedValue")){attributePricing=pricing;break;}}}return attributePricing;},// Per la valutazione delle espressioni, sono necessarie due funzioni, una per l'espressione
// principale e una per le espressione figlie. Questo perché l'espressione principale è un
// modello Backbone JS e quelle secondarie risultano come semplici oggetti javascript.
// Il codice andrebbe unificato con quello presente in ComposerSelection
// Valuta l'espressione principale (modello backbone js)
evaluateAttributeExpression:function(expression){if(!expression||!(expression instanceof MPlaza.AttributeExpression))return false;var op=expression.get("op");var result=op==MPlaza.LogicalOperator.AND?true:false;for(var i=0;i<expression.get("propositions").length;i++){var proposition=expression.get("propositions")[i];var partial=this.evaluateAttributeProposition(proposition);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}for(var i=0;i<expression.get("expressions").length;i++){var childExpression=expression.get("expressions")[i];var partial=this.evaluateChildAttributeExpression(childExpression);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}return result;},// Valuta un'espressione figlia (oggetto plain javascript object)
evaluateChildAttributeExpression:function(expression){var op=expression.op;var result=op==MPlaza.LogicalOperator.AND?true:false;for(var i=0;i<expression.propositions.length;i++){var proposition=expression.propositions[i];var partial=this.evaluateAttributeProposition(proposition);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}for(var i=0;i<expression.expressions.length;i++){var childExpression=expression.expressions[i];var partial=this.evaluateChildAttributeExpression(childExpression);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}return result;},// Valuta una singola proposizione (semplice oggetto javascript)
evaluateAttributeProposition:function(proposition){if(proposition&&proposition.hasOwnProperty("attributeGuid")&&proposition.hasOwnProperty("op")&&proposition.hasOwnProperty("value")){var guid=proposition.attributeGuid;var compositionItem=this.getCompositionItemByAttributeGuid(guid);// se l'attributo non è stato selezionato la preposizione deve essere falsa
if(compositionItem){var selectedValue=compositionItem.get("selectedValue");if(compositionItem.get("attributeTypeID")==MPlaza.AttributeType.Options){// Nel caso di attributi con opzioni, deve essere considerato il guid dell'opzione selezionata
selectedValue=compositionItem.get("selectedOptionGuid");}var result=false;if(proposition.op==MPlaza.ComparisonOperator.Equal)result=selectedValue==proposition.value;else if(proposition.op==MPlaza.ComparisonOperator.NotEqual)result=selectedValue!=proposition.value;else if(proposition.op==MPlaza.ComparisonOperator.In||proposition.op==MPlaza.ComparisonOperator.NotIn){var parts=proposition.value.split(';');if(proposition.op==MPlaza.ComparisonOperator.In)result=Zakeke.arrayContains(parts,selectedValue);else result=!Zakeke.arrayContains(parts,selectedValue);}return result;}}return false;}});// -----------------------------------------------------------
// Compositions
// -----------------------------------------------------------
MPlaza.Compositions=Backbone.Collection.extend({model:MPlaza.Composition,url:function(){return Zakeke.config.baseApiUrl+'compositiondocs';},getComposition:function(compositionID){for(var i=0;i<this.length;i++){var composition=this.at(i);if(composition.get("compositionID")==compositionID)return composition;}return null;},getCompositionByDocID:function(docID){for(var i=0;i<this.length;i++){var composition=this.at(i);if(composition.get("docID")==docID)return composition;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Template Category
// -----------------------------------------------------------
MPlaza.TemplateCategory=Backbone.AssociatedModel.extend({defaults:{id:-1,name:"",isDummy:false,displayOrder:0},url:function(){return null;}});// -----------------------------------------------------------
// Template Categories
// -----------------------------------------------------------
MPlaza.TemplateCategories=Backbone.Collection.extend({model:MPlaza.TemplateCategory,url:function(){return null;}});// -----------------------------------------------------------
// Template Macro Category
// -----------------------------------------------------------
MPlaza.TemplateMacroCategory=Backbone.AssociatedModel.extend({defaults:{id:-1,name:"",isDummy:false,displayOrder:0,categories:[]},initialize:function(){this.get("categories").parentModel=this;},relations:[{type:Backbone.Many,key:'categories',collectionType:MPlaza.TemplateCategories}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'designs/templatemacrocategories';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;}});// -----------------------------------------------------------
// Template Macro Categories
// -----------------------------------------------------------
MPlaza.TemplateMacroCategories=Backbone.Collection.extend({model:MPlaza.TemplateMacroCategory,url:function(){return Zakeke.config.baseApiUrl+'designs/templatemacrocategories';}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Grid
// -----------------------------------------------------------
MPlaza.Grid=Backbone.AssociatedModel.extend({defaults:{json:"",svg:"",name:"",sellerID:-1,isDeleted:false},idAttribute:"gridID",initialize:function(){},relations:[],getGridRuleID:function(){if(this.collection&&this.collection.getGridRuleID){return this.collection.getGridRuleID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Grids
// -----------------------------------------------------------
MPlaza.Grids=Backbone.Collection.extend({model:MPlaza.Grid,getGridRuleID:function(){if(this.parentModel&&this.parentModel.getGridRuleID){return this.parentModel.getGridRuleID();}return null;},findGrid:function(gridID){for(var i=0;i<this.length;i++){var grid=this.at(i);if(grid.get("gridID")==gridID)return grid;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// GridRuleGridSideMapping
// -----------------------------------------------------------
MPlaza.GridRuleGridSideMapping=Backbone.AssociatedModel.extend({defaults:{gridRuleID:-1,gridID:-1,productID:null,sideID:null},initialize:function(){},relations:[],getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// GridRuleGridSideMappings
// -----------------------------------------------------------
MPlaza.GridRuleGridSideMappings=Backbone.Collection.extend({model:MPlaza.GridRuleGridSideMapping,modelId:function(attrs){return attrs.gridID+"-"+attrs.productID+"-"+attrs.sideID;},getGridRuleID:function(){if(this.parentModel&&this.parentModel.getGridRuleID){return this.parentModel.getGridRuleID();}return null;},findAssociation:function(gridRuleID,gridID,productID,sideID){for(var i=0;i<this.length;i++){var mapping=this.at(i);if(mapping.get("gridRuleID")==gridRuleID&&mapping.get("gridID")==gridID&&mapping.get("productID")==productID&&mapping.get("sideID")==sideID)return mapping;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// GridRule
// -----------------------------------------------------------
MPlaza.GridRule=Backbone.AssociatedModel.extend({defaults:{name:"",sellerID:-1,associations:[],grids:[]},// modificare in docID per salvare su NoSQL
//idAttribute: "designID",
idAttribute:"gridRuleID",initialize:function(){var model=this;this.get('associations').parentModel=this;this.get('grids').parentModel=this;this.on("change",function(){model._fireEvent("change");});this.get("associations").on("add",function(){model._fireEvent("change");});this.get("associations").on("remove",function(){model._fireEvent("change");});this.get("associations").on("change",function(){model._fireEvent("change");});},relations:[{type:Backbone.Many,key:'associations',collectionType:MPlaza.GridRuleGridSideMappings},{type:Backbone.Many,key:'grids',collectionType:MPlaza.Grids}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'gridrules';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getGridRuleID:function(){return this.get("gridRuleID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Grid rules
// -----------------------------------------------------------
MPlaza.GridRules=Backbone.Collection.extend({model:MPlaza.GridRule,url:function(){return Zakeke.config.baseApiUrl+'gridrules/';},findGridRule:function(gridRuleID){for(var i=0;i<this.length;i++){var gridRule=this.at(i);if(gridRule.get("gridRuleID")==gridRuleID)return gridRule;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Quote
// -----------------------------------------------------------
MPlaza.Quote=Backbone.AssociatedModel.extend({defaults:{sellerID:-1,designDocID:"",compositionDocID:"",orderDocID:"",visitorID:-1,visitorCode:"",customerID:-1,customerCode:"",formData:"",subject:"",statusID:1,createdOn:null,amount:0,shippingAmount:0,additionalAmountLabel:"",additionalAmount:0,modelPrice:0,variantName:"",quantity:1},idAttribute:"quoteID",initialize:function(){},relations:[],getQuoteID:function(){if(this.collection&&this.collection.getQuoteID){return this.collection.getQuoteID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},url:function(){var urlRoot=Zakeke.config.baseApiUrl+'quotes';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Quotes
// -----------------------------------------------------------
MPlaza.Quotes=Backbone.Collection.extend({model:MPlaza.Quote,getQuoteID:function(){if(this.parentModel&&this.parentModel.getQuoteID){return this.parentModel.getQuoteID();}return null;},findQuote:function(quoteID){for(var i=0;i<this.length;i++){var quote=this.at(i);if(quote.get("quoteID")==quoteID)return quote;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// DesignEffectTemplate
// -----------------------------------------------------------
MPlaza.DesignEffectTemplate=Backbone.AssociatedModel.extend({defaults:{name:"",sellerID:-1,previewDesignEffect:null,outputDesignEffect:null},idAttribute:"templateID",initialize:function(){var model=this;},relations:[{type:Backbone.One,key:'previewDesignEffect',relatedModel:MPlaza.DesignEffect},{type:Backbone.One,key:'outputDesignEffect',relatedModel:MPlaza.DesignEffect}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'gridrules';if(this.id!==undefined&&this.id!==null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getTemplateID:function(){return this.get("templateID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// DesignEffectTemplates
// -----------------------------------------------------------
MPlaza.DesignEffectTemplates=Backbone.Collection.extend({model:MPlaza.DesignEffectTemplate,url:function(){return Zakeke.config.baseApiUrl+'designeffecttemplates/';},findTemplate:function(templateID){for(var i=0;i<this.length;i++){var template=this.at(i);if(template.get("templateID")==templateID)return template;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ShapeCategory
// -----------------------------------------------------------
MPlaza.ShapeCategory=Backbone.AssociatedModel.extend({defaults:{name:"",imagesCount:0},idAttribute:"shapeCategoryID",initialize:function(){},relations:[],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'shapeCategories';if(this.id!=undefined&&this.id!=null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;}});// -----------------------------------------------------------
// ShapeCategories
// -----------------------------------------------------------
MPlaza.ShapeCategories=Backbone.Collection.extend({model:MPlaza.ShapeCategory,url:function(){return Zakeke.config.baseApiUrl+'shapeCategories';},comparator:function(model){return model.get("name");}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ShapeAssignedCategory
// -----------------------------------------------------------
MPlaza.ShapeAssignedCategory=Backbone.AssociatedModel.extend({defaults:{shapeCategoryID:-1,name:""},initialize:function(){},relations:[],getShapeID:function(){if(this.collection&&this.collection.getShapeID){return this.collection.getShapeID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// ShapeAssignedCategories
// -----------------------------------------------------------
MPlaza.ShapeAssignedCategories=Backbone.Collection.extend({model:MPlaza.ShapeAssignedCategory,getShapeID:function(){if(this.parentModel&&this.parentModel.getShapeID){return this.parentModel.getShapeID();}return null;},findShapeCategory:function(shapeCategoryID){for(var i=0;i<this.length;i++){var category=this.at(i);if(category.get("shapeCategoryID")===shapeCategoryID)return category;}return null;},setupUrlForShapeID:function(shapeID){this.url=function(){return Zakeke.config.baseApiUrl+'shapes/'+shapeID+"/categories";};}});// -----------------------------------------------------------
// Shape
// -----------------------------------------------------------
MPlaza.Shape=Backbone.AssociatedModel.extend({defaults:{name:"",tags:"",pathDataUrl:"",imageUrl:"",maskImageUrl:"",categories:[]},idAttribute:"shapeID",initialize:function(){var shape=this;this.get("categories").parentModel=this;this.get('categories').url=function(){return shape.url()+'/'+shape.id+'/categories';};if(!this.get("shapeGuid")){this.set("shapeGuid",MPlaza.generateUUID());}},relations:[{type:Backbone.Many,key:'categories',collectionType:MPlaza.ShapeAssignedCategories}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'shapes';if(this.id!==undefined&&this.id!==null&&this.id>0){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},getShapeID:function(){return this.get("shapeID");},toString:function(){// todo.......
}});// -----------------------------------------------------------
// Shapes
// -----------------------------------------------------------
MPlaza.Shapes=Backbone.Collection.extend({model:MPlaza.Shape,url:function(){return Zakeke.config.baseApiUrl+'shapes';},getShape:function(shapeID){for(var i=0;i<this.length;i++){var shape=this.at(i);if(shape.get("shapeID")===shapeID)return shape;}return null;}});var Zakeke;(function(Zakeke){var Customizer;(function(Customizer){var Stack=/** @class */function(){function Stack(){this._topNode=undefined;this._count=0;this._changedEventListeners=[];this._enableChangedEvent=true;}Stack.prototype.count=function(){return this._count;};Stack.prototype.isEmpty=function(){return this._topNode===undefined;};Stack.prototype.push=function(value){// create a new Node and add it to the top
var node=new Node(value,this._topNode);this._topNode=node;this._count++;this.fireChangedEventListener();};Stack.prototype.pop=function(){// remove the top node from the stack.
// the node at the top now is the one before it
if(this._count==0)return undefined;var poppedNode=this._topNode;this._topNode=poppedNode.previous;this._count--;this.fireChangedEventListener();return poppedNode.data;};Stack.prototype.peek=function(){return this._topNode.data;};Stack.prototype.clear=function(){if(this._topNode&&this._count>0){this._topNode=undefined;this._count=0;this.fireChangedEventListener();}};Stack.prototype.addChangedEventListener=function(listener){this._changedEventListeners.push(listener);};Stack.prototype.removeChangedEventListener=function(listener){for(var i=0;i<this._changedEventListeners.length;i++){if(this._changedEventListeners[i]==listener)this._changedEventListeners.splice(i--,1);}};Stack.prototype.fireChangedEventListener=function(){if(this._enableChangedEvent){for(var i=0;i<this._changedEventListeners.length;i++){var listener=this._changedEventListeners[i];listener();}}};Stack.prototype.getAllData=function(){var arr=new Array(this._count);var index=this._count-1;var current=this._topNode;while(current){arr[index]=current.data;current=current.previous;index--;}return arr;};Stack.prototype.getLastData=function(predicate){var current=this._topNode;while(current){if(!predicate||predicate(current.data))return current.data;current=current.previous;}return null;};Stack.prototype.getAllDataAfter=function(data){var arr=[];var current=this._topNode;while(current&&current.data!=data){arr.push(current.data);current=current.previous;}return arr.reverse();};Stack.prototype.removeDataArray=function(dataArray){var _this=this;this._enableChangedEvent=false;dataArray.forEach(function(data){_this.removeData(data);});this._enableChangedEvent=true;this.fireChangedEventListener();};Stack.prototype.removeData=function(data){var node=this.getNodeHavingData(data);if(node){this.removeNode(node);this.fireChangedEventListener();}};Stack.prototype.getNodeHavingData=function(data){var current=this._topNode;while(current){if(current.data==data)return current;current=current.previous;}return null;};Stack.prototype.removeNode=function(node){if(node){if(this._topNode==node){this._topNode=node.previous;this._count--;}else{var following=this.getFollowingNode(node);if(following){following.previous=node.previous;this._count--;}}}};Stack.prototype.getFollowingNode=function(node){var current=this._topNode;while(current){if(current.previous==node)return current;current=current.previous;}return undefined;};return Stack;}();Customizer.Stack=Stack;var Node=/** @class */function(){function Node(data,previous){this.previous=previous;this.data=data;}return Node;}();})(Customizer=Zakeke.Customizer||(Zakeke.Customizer={}));})(Zakeke||(Zakeke={}));var __assign=this&&this.__assign||function(){__assign=Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p];}return t;};return __assign.apply(this,arguments);};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator["throw"](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __generator=this&&this.__generator||function(thisArg,body){var _={label:0,sent:function(){if(t[0]&1)throw t[1];return t[1];},trys:[],ops:[]},f,y,t,g;return g={next:verb(0),"throw":verb(1),"return":verb(2)},typeof Symbol==="function"&&(g[Symbol.iterator]=function(){return this;}),g;function verb(n){return function(v){return step([n,v]);};}function step(op){if(f)throw new TypeError("Generator is already executing.");while(_)try{if(f=1,y&&(t=op[0]&2?y["return"]:op[0]?y["throw"]||((t=y["return"])&&t.call(y),0):y.next)&&!(t=t.call(y,op[1])).done)return t;if(y=0,t)op=[op[0]&2,t.value];switch(op[0]){case 0:case 1:t=op;break;case 4:_.label++;return{value:op[1],done:false};case 5:_.label++;y=op[1];op=[0];continue;case 7:op=_.ops.pop();_.trys.pop();continue;default:if(!(t=_.trys,t=t.length>0&&t[t.length-1])&&(op[0]===6||op[0]===2)){_=0;continue;}if(op[0]===3&&(!t||op[1]>t[0]&&op[1]<t[3])){_.label=op[1];break;}if(op[0]===6&&_.label<t[1]){_.label=t[1];t=op;break;}if(t&&_.label<t[2]){_.label=t[2];_.ops.push(op);break;}if(t[2])_.ops.pop();_.trys.pop();continue;}op=body.call(thisArg,_);}catch(e){op=[6,e];y=0;}finally{f=t=0;}if(op[0]&5)throw op[1];return{value:op[0]?op[1]:void 0,done:true};}};var __spreadArrays=this&&this.__spreadArrays||function(){for(var s=0,i=0,il=arguments.length;i<il;i++)s+=arguments[i].length;for(var r=Array(s),k=0,i=0;i<il;i++)for(var a=arguments[i],j=0,jl=a.length;j<jl;j++,k++)r[k]=a[j];return r;};var _this_1=this;var MPlaza=MPlaza||{};// String utils, da spostare
// https://github.com/uxitten/polyfill/blob/master/string.polyfill.js
// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padStart
if(!String.prototype.padStart){String.prototype.padStart=function padStart(targetLength,padString){targetLength=targetLength>>0;//floor if number or convert non-number to 0;
padString=String(padString||' ');if(this.length>targetLength){return String(this);}else{targetLength=targetLength-this.length;if(targetLength>padString.length){padString+=padString.repeat(targetLength/padString.length);//append to original to ensure we are longer than needed
}return padString.slice(0,targetLength)+String(this);}};}// https://github.com/uxitten/polyfill/blob/master/string.polyfill.js
// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/padEnd
if(!String.prototype.padEnd){String.prototype.padEnd=function padEnd(targetLength,padString){targetLength=targetLength>>0;//floor if number or convert non-number to 0;
padString=String(padString||' ');if(this.length>targetLength){return String(this);}else{targetLength=targetLength-this.length;if(targetLength>padString.length){padString+=padString.repeat(targetLength/padString.length);//append to original to ensure we are longer than needed
}return String(this)+padString.slice(0,targetLength);}};}// Matteo D'Avena
if(!String.prototype.padStartEnd){String.prototype.padStartEnd=function padStartEnd(targetLength,padString){targetLength=targetLength>>0;//floor if number or convert non-number to 0;
padString=String(padString||' ');if(this.length>targetLength){return String(this);}else{targetLength=targetLength-this.length;// divido la lunghezza residua in due, per la parte destra e quella sinistra
// se dispari, la parte destra sarà più lunga di 1
var semiLength=Math.floor(targetLength/2);var mod=targetLength%2;var leftLength=mod>0?semiLength+1:semiLength;var rightLength=semiLength;// parte sinistra
var padLeft=padString;if(leftLength>padLeft.length){padLeft+=padLeft.repeat(leftLength/padLeft.length);//append to original to ensure we are longer than needed
}// parte destra
var padRight=padString;if(rightLength>padRight.length){padRight+=padRight.repeat(rightLength/padRight.length);//append to original to ensure we are longer than needed
}return padLeft.slice(0,leftLength)+String(this)+padRight.slice(0,rightLength);}};}// -----------------------------------------------------------
// Enums
// -----------------------------------------------------------
MPlaza.EventMessages={DPIWarning:1,UploadLimit:2,AddToCartConfirmation:4,ItemsClippedWarning:7};MPlaza.CustomizerElementType={None:"none",Rectangle:"rectangle",Oval:"oval",Line:"line",Path:"pen",Free:"freeHand",Text:"text",Image:"image",TextArt:"textart",Shape:"shape"};MPlaza.CustomizerInteractionMode={None:"none",Select:"select",Create:"create",Move:"move",Rotate:"rotate",Resize:"resize",ResizeTop:"resizeTop",ResizeBottom:"resizeBottom",ResizeLeft:"resizeLeft",ResizeRight:"resizeRight",Delete:"delete",Edit:"edit",MoveTextOnPathFirstEnd:"moveTextOnPathFirstEnd",MoveTextOnPathMiddleEnd:"moveTextOnPathMiddleEnd",MoveTextOnPathLastEnd:"moveTextOnPathLastEnd",MoveTextAreaTopEnd:"moveTextAreaTopEnd",MoveTextAreaRightEnd:"moveTextAreaRightEnd",MoveTextAreaBottomEnd:"moveTextAreaBottomEnd",MoveTextAreaLeftEnd:"moveTextAreaLeftEnd"};var MaskedImageSelectionMode;(function(MaskedImageSelectionMode){MaskedImageSelectionMode[MaskedImageSelectionMode["Element"]=1]="Element";MaskedImageSelectionMode[MaskedImageSelectionMode["Raster"]=2]="Raster";MaskedImageSelectionMode[MaskedImageSelectionMode["Mask"]=3]="Mask";})(MaskedImageSelectionMode||(MaskedImageSelectionMode={}));;MPlaza.PointingInfo=function(){this.modifiers={option:false,control:false,shift:false};this.point=undefined;this.delta=undefined;return this;};// Get Viewport
var getViewport=function(){var m=document.compatMode=='CSS1Compat';return{l:window.pageXOffset||(m?document.documentElement.scrollLeft:document.body.scrollLeft),t:window.pageYOffset||(m?document.documentElement.scrollTop:document.body.scrollTop),w:window.innerWidth||(m?document.documentElement.clientWidth:document.body.clientWidth),h:window.innerHeight||(m?document.documentElement.clientHeight:document.body.clientHeight)};};// Support Types
MPlaza.ItemInfo=function(designItem,item){this.designItem=designItem;this.item=item;this.elementType=MPlaza.CustomizerElementType.None;this.sideID=-1;this.itemGuid=MPlaza.EmptyUUID;this.constraints=[];if(designItem&&designItem instanceof MPlaza.DesignItem)this.itemGuid=designItem.get("itemGuid");};// TextItemInfo -> ItemInfo
MPlaza.TextItemInfo=function(designItem,item){MPlaza.ItemInfo.call(this,designItem,item);this.elementType=MPlaza.CustomizerElementType.Text;this.text="";this.strokeColor="black";this.strokeWidth=0;this.fillColor="black";this.fontFamily="Arial";this.fontSize=18;this.fontWeight="normal";this.fontStyle="normal";this.fontStretch="normal";this.justification="center";this.isTextOnPath=false;this.isTextArea=false;this.adaptText=false;this.letterSpacing=0;this.lineSpacing=0;this.scaling=1;this.verticalAlignment="top";this.shadowColor=null;this.shadowBlur=0;this.shadowDistance=7;this.shadowAngle=45;this.__defineGetter__("totalFontSizePt",function(){return this.fontSize*this.scaling*4/3;});/*
    this.shadowOffset = new paper.Point(5, 5);

    // shadow distance (alternative to shadowOffset)
    this.__defineGetter__("shadowDistance", function () {
        if (this.shadowOffset && this.shadowOffset instanceof paper.Point)
            Math.round(this.shadowOffset.length);
        return 0;
    });

    this.__defineSetter__("shadowDistance", function (value) {
        const length = Math.round(Math.abs(value));
        if (!this.shadowOffset) {
            this.shadowOffset = new paper.Point({
                length,
                angle: 45
            });
        } else {
            this.shadowOffset.length = length;
        }
    });

    // shadow angle (alternative to shadowOffset)
    this.__defineGetter__("shadowAngle", function () {
        if (this.shadowOffset && this.shadowOffset instanceof paper.Point) {
            let angle = this.shadowOffset.angle;
            if (angle < 0)
                angle += 360;
            angle = Math.round(angle);
            return angle;
        }
        return 0;
    });

    this.__defineSetter__("shadowAngle", function (value) {
        let angle = value % 360;
        if (angle < 0)
            angle += 360;
        
        angle = Math.round(angle);
        this.shadowOffset.angle = angle;
    });
    */};MPlaza.TextItemInfo.prototype=Object.create(MPlaza.ItemInfo.prototype);MPlaza.TextItemInfo.prototype.constructor=MPlaza.TextItemInfo;// ImageItemInfo -> ItemInfo
MPlaza.ImageItemInfo=function(designItem,item){MPlaza.ItemInfo.call(this,designItem,item);this.elementType=MPlaza.CustomizerElementType.Image;this.url="";this.deleted=false;this.isMasked=false;this.maskID=-1;this.maskStyle={strokeColor:undefined,strokeWidth:undefined,strokeCap:undefined,strokeJoin:undefined,dashArray:undefined,dashOffset:undefined};};MPlaza.ImageItemInfo.prototype=Object.create(MPlaza.ItemInfo.prototype);MPlaza.ImageItemInfo.prototype.constructor=MPlaza.ImageItemInfo;MPlaza.ShapeItemInfo=function(designItem,item){MPlaza.ItemInfo.call(this,designItem,item);this.elementType=MPlaza.CustomizerElementType.Shape;this.style={strokeColor:undefined,strokeWidth:undefined,strokeCap:undefined,strokeJoin:undefined,dashArray:undefined,dashOffset:undefined,fillColor:undefined};this.isImagePlaceholder=false;this.fillerImageID=-1;};MPlaza.ShapeItemInfo.prototype=Object.create(MPlaza.ItemInfo.prototype);MPlaza.ShapeItemInfo.prototype.constructor=MPlaza.ShapeItemInfo;// TextArtItemInfo -> ItemInfo
MPlaza.TextArtItemInfo=function(designItem,item){MPlaza.ItemInfo.call(this,designItem,item);this.elementType=MPlaza.CustomizerElementType.TextArt;this.text="";this.fontFamilyID=-1;this.fontFaceID=-1;this.text="";this.textArtTypeID=-1;this.style={strokeColor:undefined,strokeWidth:undefined,strokeCap:undefined,strokeJoin:undefined,dashArray:undefined,dashOffset:undefined,fillColor:undefined,shadowColor:undefined,shadowBlur:undefined,shadowDistance:undefined,shadowAngle:undefined};this.config={angleValue:0,curveValue:0,intensT:0,intensB:0,isTriangle:false,isBridge:false,isTop:false,isBottom:false,isMiddle:false};};MPlaza.TextArtItemInfo.prototype=Object.create(MPlaza.ItemInfo.prototype);MPlaza.TextArtItemInfo.prototype.constructor=MPlaza.TextArtItemInfo;// Constructor
MPlaza.Customizer=function(isViewer,isMobile,canvas,isConfigurator){this.isViewer=isViewer||false;this.isMobile=isMobile||false;this.isConfigurator=isConfigurator||false;this.isCartPreview=false;this.isImageScalingEnabled=true;this.showSideImage=true;this.fitToScreenMargin=this.isMobile?18:13;this.canvasID="mp-canvas-customizer_"+MPlaza.makeID(5);this.canvas=null;this.context=null;if(canvas!==undefined&&canvas!==null){this.canvas=canvas;this.context=this.canvas.getContext("2d");}this._paper=new paper.PaperScope();//  Paper scopes issues
this.__defineGetter__("paper",function(){paper=this._paper;return this._paper;});this.__defineSetter__("viewMatrix",function(values){var matrix=new this.paper.Matrix(values);this.paper.view.matrix=matrix;});this.rasterLayer=null;this.zooming=false;this.frozen=false;this.tool=null;// Mouse & keyboard events on canvas
this.clipboard=null;this.selectionBounds=null;this.selectionBoundsShape=null;this.selectionMoveHandle=null;this.selectionRotateHandle=null;this.selectionResizeHandle=null;this.selectionDeleteHandle=null;this.selectionMaskMoveImage=null;this.selectionMaskMoveShape=null;this.selectionResizeTopHandle=null;this.selectionResizeBottomHandle=null;this.selectionResizeLeftHandle=null;this.selectionResizeRightHandle=null;this.selectionLateralResizeDimension=this.isMobile?15:8;this.drawSelectionBounds=0;this.model=null;this.grids=[];this.loadingCircles=[];this.interactionMode=MPlaza.CustomizerInteractionMode.None;this.elementType=MPlaza.CustomizerElementType.None;this.hammertime=null;// Per la gestione del touch
this.hitItem=null;this.hitTestEnabled=true;this.mouseStartPos=null;this.adjustmentDelta=null;this.originalPositions=null;this.element=null;this.pivot=null;this.corner=null;this.topCorner=null;this.bottomCorner=null;this.leftCorner=null;this.rightCorner=null;this.originalSize=null;this.originalCenter=null;this.originalScaleCenter=null;this.originalContent=null;this.originalMatrix=null;this.originalShape=null;this.originalAngle=null;this.imageLayer=null;this.imageItem=null;// Rappresenta l'immagine del prodotto da personalizzare, per il lato selezionato - Represents the image of the product to be customized, for the selected side
this.imageWidth=500;this.imageHeight=516;this.mask=null;this.verticalCenterLine=null;this.horizontalCenterLine=null;if(canvas!==undefined&&canvas!=null){this.setupCanvas();}else{this.createCanvas();this.createDOMElement();}this.setupImageLayer();this.lastPanPoint=new this.paper.Point(0,0);this.iconsBytes=null;this.masterGroup=null;this.snapCache=null;this.oldScale=1;var viewPort=getViewport();if(!this.isViewer){this.iconsBytes={move:"iVBORw0KGgoAAAANSUhEUgAAAJIAAACSCAYAAACue5OOAAAACXBIWXMAAC4jAAAuIwF4pT92AAAOQElEQVR42u2dTUxT6RrH/2NMWlhIJwIpi9aaMBGjCQVXIMnQScYMK4+zmRk2Uq9rL4suXDFMV96EZNA1Y+sGrxssm+nEmwAmiCtpSTDUaEJtF5DK5LYuarvyLvp2LkOg53nP5/uenidpjHDO6aHn1//z9X588fnzZ7jmml475X4ErrkgueaC5Jqz7HS7fwDRmbkQgBD77/gJh4UA5I/5+Rr7N5+Ix/Lt/Dl+0S7BNgMmfOgVAjBo8NtsASgzwLIAsu0CmGNBYuCMH3qds+lW3jOo1gCknAqWo0CKzsyFAUwxcAYFvc33AFIAkol4LOuCJJbyTANQbFSdtodKWpCiM3NTTH2+dsiXegvAfCIeS7ogmQ+Pj6nPlITqQ7UKgHkGVdkFyRyApgF0tUlGLRVQQoNkNUAdXg+C/l7SsYX9Ej7V6i5QooPEYqBZM1zYhVAAwb4edPu6EPT3ovvLM+j2aeO0WqujsFdCYb+Eg3IFhb0PeJMvmgXUbCIem3dBoqfw80YF0R1eDwZCAQycb7yoiqPXCvsl5HaLjVe+aKR6bQGYTsRjay5IJ0M0C+BnI+AZHujH8MWvMHyxX4i/LbdbxGbuLTZ33uHP8kcjLnmfKVTZBenvKpSEziLi1fAloeBpBdV6ZhubuXd6leo9gCkR1Ml2kKIzc9MAftV6/lnfGVwbuYKxocvo9HqkSsuqtTo2d94itbqhV6V+ScRjs20JEsvIkgCuawVIiYxibOiyI3L99cw21jOv9QTqzwEodrk6W0BiriylJSNzGkDHub3F9AqK+x+0ZnbjdrRbLAcpOjOnMCXiyrc7vB4okVFcG7mCdrD1zDYW06taY6io1a0WS0FitaEE73nfjgxDiVyVLgYyIoZKrb7Af15uCh83WQZSdGZuHsA/ed3Y7RsTGDgfQDtbYb+EhaW0Fnf3KBGPTTkGpOjMXBLATVeF9FlqdQPLqxtCwmQ6SLwQdXg9uH1jQvhakJ3B+IPHKd7YyXSYTAWJF6KAvwd3JhXNfa92ip0eLKZ4SwWmwmQaSLwx0dXwJdz+fsKlhMMW0yu8gbhpMJkCEm929tNEpG3SejPKBL89/cP2bM5wkFid6Cn1+H/c+M6xxUUrYeKsORleZzIUJFaxXgOx2OhCZGyJ4N7DJzwwDRlZATcMJNY7y4LY9nAhsh2mCoCQUb05I+f+J50I0cJSGgtLaSnuNejvxd1bP6CDVnvrwv+nnIsBEhsKct2JEL3IvsaL7GupYLp9g5z9DrLBhPa7NhYXZZyWnTUhkrVEwZnNRfQOjjNCkUjR/9XwJakhAiCVMo0NXca3I8PkZ8hiXHtAYrKoOjw24O+R5pt8EkQywjQ58Q0uhEgN73NozNixHiTm0lQH6nd4Pbh760dHQCQjTHcmFZz1naEc+s/ozNy4HYpEml915ydFig4+FSLZYOr0enBnUjE0TDEMJNYCUZ139u3IsBRjiXghkg2moL8X1yOjJBenNYs7pQEiH0WNAv4eTE5841iIZINJiYwi4O+hHDqtJfDWokikefjtAJFsMBETni5q2KIZpEOLOkjv0oyCSCaYOFzcTbaAmWmKpKpGjdkeV9sKIplgUiKj1Cxu1hSQqGo0OREROkszCyKZYCKGHVyqxKNIqmp01ndG6D6a2RDJAtPwxX5qoXLWLJCkDbCtgkgWmBRarKRQMzgSSKxu1KWW7os688NqiGSAaeB8gKJKXWis12mYIqmqkagNWbsgkgEmoipNGwIS66kNyhgb2Q2R6DANnA9QipTnKD04iiKpSpuIaiQKRKLDRHx2qgxQdkdq2fHr8HqEU6NqrY6xocvk+9KxjAx3K6haqwtVHhkbukyZgaLoAom5tZbjsIcH+oWrG3V6PVyV9U6vV8d7eaVf5GJs6JLaRMuu6MyckojHUlpd2xSFaNfkNqJ7U/TESIpakC3Kt7FqzeLpjrznbl8XJejWBhIrj7d2a4LUjRaW0ijslaQDqbBXEiYAJ3iWLhbqcCuSYsCbt112Jms2RxQFRQtI42rZmlWr6DsVIpFg6vZ1UUYFjBsO0kAo4ELkMJgIqvQ1F0gsPuoSNT5yGkSiwDQQCqoec1KV+yRFCqtdMNjX60LkMJiIGXjYMJDsio+cDpHdMHV6PZQ46Vg2TmuJj5wGUbCvx5Zz1WACYPkM5aC/V21flBAPSCEDJFAaJRJ1QJ4dMAX7epHJveMOuE9ybedap4pnHAOR6+b4s/HjRk2eOuYg1UDbquWL2x0iO2Dq/pIkEmGKa1Mdo2tFxsYL0WJ6hdzFD/aZNwt4Mb2Cwh5tSEq1VhPOzRFFwkcBKUSJ7kVTIq3jiYw2EzdHtgyms74zagF3c5u0ljFSS5CI88dddyaxm9MSunDP/dczCMyFSM4AnOLaTony4bgQiQNTt4aiJLdrcyFyPkzdXxrj2lqCZHQx0oVIejdnv2tzIXIOTLaCVNgvuRQY+FnaOQbcVpDu3vrR9HJCO1jA34O7t360dVrYcSC13OTEyEH2nWzpZBcmuSE6CaSWWy8ZLZ8uTOJBxNO6EcK1uTCJqUSEXmFWN0haaHVhcpw7K1NAyre6gpnNURcmMSA6KFe4zznNC5JVbu7ew39zQRvw93ANIzHLeK5drdW4/0YrlEil838sI6e1vFFut2jqcFstME1OfCPEOgQ845xyu0X8K/FEKIiIapRXdW2UDeCsKHy5bs6emOjgvx+NAYlZSyytqki7MFkfWFOebSIeI7u2LFpMz83tFoGI2DETj61ntnFQ/qjp3G4T18+0IzsjFJy3qMG2KkhaonqRYVrPvNY8PPZCKGAKSHal+ARFOrZgfYrn4MNRvV0wtYObswuiaq1O+aLmDQPpL/dmU2nAyTDZWWwkPtM1MkiJeCyrFnDbAZLTYbK7Yp3LFyiBNh0kiirl8kXbPnAnwiRCF58gDlsn/aIVSCm1OMnOgWlOgkkEiA7KFUp8tKYFpDW1q27uvLP1ATgBJlHGExGfJT9IlDhpPbNt+4NowmTXwl96LNjXKwRE1GepZ8F2od3bYZhE3rVS9PsmurXlVr/UBZIoquSaJW4tpRkkJmUq7s2dTiS7PXv5SjdIp4kXuHnSLz/V6ljPbAu1J0m1Vje1N3fY3uSLiM7MSRVYH1Ujwvij5UQ8Vtbj2gAgaRDRbZ3NiQgRx7NTZUAVJFbJfN/qmOL+B9sq3TLAJCpEB+UKpVldaZWt8SgSAMyr+r/VDSGzIrthEhUiAEitbBjy7HlASqoF3W/yReFUyW6YRIbooFyhrruQNAwkFmipypuIqmQXTCJDBACLv69SDnt03GhIPYoEALOUDEZEVbIaJtEhyu0W1dbS5nJrXCAxMh+pHbfwVMw97q2CSXSIODzHc9YmMxYkqir9Wf4orIszGyYZIHr28hV1WPEsz3W5QKKq0rOXrywfims3TDJAVK3VqV/yR5RpaXoUCQCm1TK4T7U6Fpb+gMhmJEwyQAQ0Vsj7RJuTOMt7bW6QWAanGoS9yReFq3ibAZMsEG3uvKMG2PepmZpeRUIiHpuFSrUbAB6nV4Vf3k8PTLJAdFCuUJOgihY10gwSsymqnIqyv72RMMkCEQA8WExRXdqUWnPWcJBYMLasdlxx/wMWf18R/sPmgUkmiBaW0tRREM8pPTUzFKmpSqrp2Yvsa6FLAjwwyQTRemab2gapUD2MKSAxGSTdwPLqhhSjKVvBJBNEud0ifntKzpyntQTYRipScxTlfcqxixIE3yfBJBNEhf0SHjwme6nlRDyW1PuehixGmojHptFi8lzTPtXquPfwiXQwyQbRvYdPqMH1e70urWlffP782ZA/IDozF0Jjdq7qjigdXg/u3vrBlt26ea2ZcToQogqAcZ5+mumKxFQpD0ChHCubMjkQomZclDXq/Q1dZ5uVBKJOg8mBEP1iRFxkims74uaSaDHz5Kibm5yICDULRSbL7Rbx4HGKB6JHiXhsyuj7MAUkXpgA4KeJCK6NXHHJ4LD1zDZPig80io7jZtyLaVtIMOqXqcc/Tq9K0U4RxRaW0rwQbVFjWC122uS/dwqNFSwGKQe/yL5GYb+E299PSJHR2WEH5QoeLKZ4J39usQytbNZ9mebaDrk4HxoTB76mntPh9UCJjLqu7oht7rzDwtM0TzxkCUSWgKQ1ZgIaK8be/v47TfvQO8mqtToWltLU8UR/i4kAKGZDZClIWmFqd3Vaz2xjMb3Kq0KmZWdCgMRgmgbwK+95AX+PMPuNWJXWp1Y3tK7/fZ+1reBYkBhMChozOLl9ltPd3UG5gtTKhtbdxytoVKyTVt+3LSAxmMIMpkEt518NX8K10SuOye50AgQ0GrCKkW0PKUA6lNHN88ZNRxXq2sgVDF/sl9aFPXv5SksgfdiWoWOYrPQgGeHqmnaWbS4zNnRJeLdXZYuTPXv5irLIlZCuTEiQDqlTEsB1vde6EApg+GI/hi/2CwNVtVbH5s5bnmlBlNR+Su/IRseBdESd5gGcM+J6AX8PBs4HMDzwleUZX263iFy+iM2dt0YuQyiMCgkN0iF1mgbws9HXboLV7etC0N+LYF+v7vFG1Vodhb0SDsoVFPZLKOx90Lxtl1paD2DWzlhIKpAOARVCY8LeTbPf60KooVadXo/q4u+FvdJfzeU31uzJIpQbkw4kO4ASzJ4zBVoT/UalAKkNgXoEICkDQFKCdASoKfY65xB4KixrnRfZhTkKpGOyvCkjygY22TKAlGhZWNuBdCTTU9jrugzwMIDKTvj8HQPSCUo1zl6DNt/OFhojRdcArDkFnrYA6Ri1CjOowgBCJsL1Ho2JolkGTtaJ4LQlSC0ACwNoQuZjPx4nnt7MqMoMmrJdnXcXJNccY6fcj8A1FyTXXJBcc5b9D4O1t0lsiFUUAAAAAElFTkSuQmCC",rotate:"iVBORw0KGgoAAAANSUhEUgAAAJIAAACSCAYAAACue5OOAAAACXBIWXMAAC4jAAAuIwF4pT92AAAQUElEQVR42u2dTUwb1xbH/0WR+FiAqxBEFgZHIgookQJmBYkUiFQUusHJJg2LPkhRF5Ee5VV+alaUePGUSqiieVIWfUkMXdBmU8ymREQqVCKwCgaJKEZBwtiLWIQqdhZgVn0LX6cuBd8z4ztz74znSIi0DB4z/t3zdc8594M//vgDjjhSqJQ4j8ARByRHHJAcsZccK/YH0D886gHgYf/ZccglLvY9ecjP5tn3lWDAnyzm5/hBsTjbDJhm9tXB4KkXfJtVAFEAK+xrvlgAsy1IDBwfg6YDQJWkt7LFNNc8AyvqgKQ+PB0MHp8B2kak1poHMB4M+FcckNSBpxlAn+Lw5NNW4wyqqAOS+fC4GDhDAM7bZFH/xoAad0AyB6Ah9lUFe8oWgDEGVdIBSbzjPALgH0UUUacYUGNWAEppkHI00Ndm3O+4qxLVLpqiiyW2sZfeNw2oYMA/4oCkD6IhpoWEmrDyslLU1dag8ZQb1QycupM1qCgr1fV6O8kUdt6+QyyxjZ1kCrHXb7AejRtl8oaCAX/IAYkewo+JcqLLy0rR6HHD29SAupM1qKutMeXviCW2EdmMI7IZRziyIdop71MtylMGJGbGRgB8IcJEeZsacLHlnGng8GT55QaWX77CcmRDlEm8o5K5UwIkpoXGUUAeqLysFN7GBnS1tyoDDw+qZysvCn2pVaadVooepP7h0ZFCnOnjrkr4OtvhbTqt28+RJbvpfcwuPcdCeA2/J98V4oyPBAP+saIEiZmyeb2+0BmPG77OdjSectsi1l8IryE0t1gIUNNMOyWLBiS2rTGvJyKzG0CCgZJm6kwHqX94tA9AUK8Ju9hyDsUgs0vPEZpb1OOYpwD4ggH/vG1B6h8eHdMTlfV0tqOrrdVyPpAIH2ryl1/1OuX9Zu7bmQZS//DoODRucbhrT2DgWrfyUZjREtmM48HUjB5z9y+znHBTQNIDUU9nO3yd7XDkT+0UmnuGp0vLWn91Ihjw91keJK0QHXdVYrDXV/Ra6ChZfrmBB1MzWn0nw2EyFCStELU0NmDgWnfR+UJaZSeZwr3JEOKJN8rAZBhIWiH6qM2L3u7LDiXGOuKG+UyGgKQVos+uXimasF60hOYWMT23KD2aEw6SljxReVkpBm/4bJtcNEsWwmt4OPVEy690is4zCQWJbb7OUSG6ffO641TLgSkFoENkBlwYSKwcdgWEbQ8HIiVgWmUwCdmbE9n7H7IbRLvpfQzfn7AMSBdbzuGzq1eol59HpnQHyoDEtj5Iu/hWgujuo5+0hthWg6mHlTTLB6l/eNQH4v7ZZ1evOBCZBFMPfVdghFVjyAOJ1RSR1GOPRXburQ5RVnyd7bjQfJZyaZUIE1eoRhqn+EUtjQ2W2DezC0RZ6f34Mty1J0j+EqtUNR8kZtJ6eNdld/AdiMyXirJSDPb6UE7bcvqaRd7mgcRMGinVboW9MztClJVqVxUGrpIX8ripICHT/crt+LjR3am8c21niLLibWrAR21eyqWXmKUxHiSm/rgh4xmPG11trQ5EyjjfF3DcVUm5dMwUkEBooy4vK8XAtSsORIr5S0QTV6/H8dYEEtNG3F39rrZW8jAGByLzpPGUm5oSGGJ+MFm0TrXlkprt9rATRKGcMo0KNoSi+sNKpRdLvpQAoW28irkvZM1E3rRl2miTd91X/deVLQsRrYmyAyoaT2WGVFgFrNml5/hxhlukkQLgoW7qlojURmfYQy0Wc7aX3kc4soEfZ+bw72//h7uPHmMhvKY8SF1trRTHuwqZ2ZzifCRmL7m+kaomzSyfaD0ax8OpJ7j1n/8iNLeIXXMGcemM4kif1ZBQkKjhvqraKLIZN9Wx3kvvY3puEf5vv1dWQ11sOUfRSvWs4lUYSH2CCJci3qYGLaUVQoF6OPUEdx89RiyxbVWtJAYklumst6o2yl2BMmDKmjwV/SeiVrpE2YOjaCRuylz1DLYKMGW104OfZ5R7JiK00rFCnezsmD2rSPbBaem6+Kr/OnbT+4gltrGbThc0cPTZygvsJN9hsNenxGZ2V1srpZ2pjxe18xKSPkFEWxqmrNk+uGD0zoXMmLqfcPvmJ9JhqigrxYXms7xGy/r+4dHmfF0nJYWDdBZWFBFmztuUaTEf/fJz9HS2U+t+AADxxBvcm1Rj0rG36XTB5o0HUke+H7prT1hym0C0z1RRVgpfZ/t7oLRoJhV8Jm9TA2URdOgCiUVrVXYza0Y64Fmg7tz6lFriimcrL5SI5ryNXD/3fL7orUQvgYf5DA5MGamrrcHtm59Qd9oxOTMnPc9ENG8dwkGSbdZ20/vYSaaUhamirBQD17pJMO2l9zH5y5xkkBoMA+k8JZKRJbNLzzF8/wehK9mIPBMVpvVoXLqJa+GbN20gsWEQ+UNiT520P3gnmcI0m/gqevtBJkyTM3NSN3oJyqH+qIK3Er3+kUyNFPp18S9mwQowUXrM9thJAAqDdCQbR4HUzPOPZCXSdpKpvyXPrABT1meimGxZQuz4adYCkkfADQ2RhfCLI1ez6jDV1dZw80x76X2pvtIZj1soSHkd7bqTMkFay/sh5Jo9UTCJlK62Vm7y76jFYopWOsnNf3lIIFEmU8jSSJHNOHdoueqVCBVlpdz3uB6NC01taBFCSuc8VSO5+NTKAWk58irvz4+7Ki0xj5KilZZfbkh5bxQlcVjkVqLV0c6uKlkaycraKPf58bYkeH+rYRrpQ1I3bnPBGom6hyRadtP73LprK23Z8LYkIlFJIOncrSjRvprKpPyBsdfbXLNmpUoEHvR7greAtIieSgDNpk2aWeOs0EaP9WZ180LtnbfvpLwvPcGUZtMmM/S34vsqJNRWsfNEmGmTJTzn04ozu3lugsoNlpYFyY5ip4H1DkiS0wAOSI4Us3gckBwRIVEHJJUCCElJx6I2bXYKle3oQ2kGaedtStJDzR8qy8oCF6SRbJTSOAyk+fwfmJxsKy9zLWuTsxDhzQ8gbqAKFz2L0jKmjfdQ44k3lkrg8cAvLyuVtnf4O19ZzFNAShayigwDyVXFneWz/PKVZUDi1VbJ2jvUuxgPA2nFqJsZbd5kFs5rFV45rawCPV6VhZbwPynoZsKFV8MTT7yxhK+0EF7jjsGRVVtF8Y+CAT8fJMrJy7IiJMrUjNDcovIg8d6jzHZ4QhplVYuzvVXgzYyDiVOiuh6NC9VKO8mU8L+XNwRUZslw7DV3+m9SC0grBd7MMOlq5z/kyZlfxYH09p2p/XLlZaXUySCyNNK8MJDWJab262pruJWF8cQboTCZ2XzZ1dYqLaMdS2xTRhiuCAOJkgcxUijzoZ8uLQvtWDUDpnJCz5uRQvxMNYE0z72pRK3UeMpNGcEifICV0TDJ1EZEkFKHRWxHgsROxFnN94qyk3+9H3dyIzgjPnijYPrnDZ/00xMIyuFIBVOi55eyfojMLYlqVxXpwWc/eNXNnOyePKJ/JB4kFbRSV1srycRlp+6r7oDLFOJCCxkE0ob0BzBwrZvc/ft0aRnD9yeEBQp2gonwWW4d5R/lBYn5SdP5Xjkc2ZC+454dYEUdlh5PvME3wce4++ixEKDsAFMssU3Z8c87XZ5XRsLVSirMiM6MI76uafL+ejSOb4KPMXx/AgvhtYIWhNVhml0kbXbnBSnvmbZsfMnbfC9w3FWJ0S8/V2Zl3X30WNO5ILnirj2BxlNuVLuq3lcnxhLblPNf3+eBbt+8bqnKxt30Pvzffs97ZlvBgN+jGyQGUwhAT75rVDoQOZbYxoOfZ6QdxW41mBbCa5TDfb4LBvxDhZg2rkpTxbz91cx9QormjBCrmTlitcQ47wIuSMGAfxyZo7uPlMwZZOoU31eUlWKw14cb3Z2a/KZig4kyShHAKqW0iFqzzSVS9BBQEdLV1orArU+laKcsTCp3txC10RjlIipI3BdTTStlpdpVhcFeH77qv04Z/Sv43pXSBpNRtBGhiiNFcW3IILFE1LQVtVJWGk+5cfvmddy59SkuNJ813OS5a08ocUJkodqI5RO5ckzDvcd40duzlRfoam9VOmKpq615P4E/e5RoJEryFWwD0UJ4jVpTNkZ9TW74fyAVMA/gUr5rzngyK99qspNMYeftO0Si8fcHIGfyLGlNqQTVIdpN72P4/gRl4UwEA/4+6use0/g+RgDkzc5lj4uy2umS1a4qVLuq/pYPi2xmMuB2gAjItGwRte+IltfV1GkbDPjnAfzGu072cVEyxAoQxRLblKPZAeBOvg3agkFiMkQJfVU49NeB6K9C/ExSWnwj3SCx5NQE77pwZEOJMhMHoj+jNKKvN0KN1ArVSFmtxE0aPZiasbWJswpEGkzaajDgH9NzD10gMWK5ztheeh/3JkMORJKjNA2fwZDe++gea8PI5Tre69G40BJXByLtfhExSvuOBVPmgsSkj2LiRPeYORDRZHLmV4QjJD91S2u4LxQkFiKS3sDDqSeWr222EkQL4TU8XVomKwQ9DrZIjZQ1cdOUa61cjmoliCKbcUqxWlbuFGLShIGUY+K2KM636qUVVocoltjGvR/JzvVqMOAfEXFfISAxteijXJuN5KySFqg7WWMpiDTUrKdwyLlrekXTpi1P+odH+wAEqat8sNdnqcP6bAQRALRQKh+lgMRgGgPwBeVaK3Zd2ASiflZCDWVBYjCNA/iHA5M50ZkGxxogdITIdLYPyhA400xyfaav7/9gmzyTmRKaW9QK0YQREBmmkZhWciHTqXue+jsftXnR233ZIYQju6y6gphszIWoz6j3ZBhIemE643FjsNdnq0PxRPtDOhpADYXIcJD0wlReVoqBq93SZwapJrNLz8nt42ZCZApIemECgJbGBgxc6y567bSTTOHBz0/0DIE1BSLTQMqBaYwazeVqp97uTsvVgIt0qGeXnusZjGEaRKaClAMUOc900Hfq/bizaNIEkc04HkzN6G2TEp4nUg4kBlMfiBnwg3Kh+Sx8l9ttmxGPbMYRmlvUO8s8BcAnYhPWEiAxmJqRaQeud4AqGCAgk7fzae3+sDxIOX7TODgdvDygLracU2Y+k1ZZfrmB2aXnhZ6m8J1RiUZLgJQD1BAyBXK61ctxVyW62lpxseWc8lHeTjKFhfALLITXCm0VTyFTlCa9MF4JkBhMHqadLhX6Wi2NDfA2NcDbdFoZqHaSKSy/3MBCeE3UNLlpCKhstB1IIrVTrrhrT8DbdBqNHrep5m83vY/Y620sR14hshkXOYpwC8CQClpIaZByfCfNOSdqGqHu5AnU1dYc2utfCDSxxPb77wbMsMx2wI6pooWUB+lAZDcmwtxRAAMyw7GqP8yvDGOvt7Gb3tc8qaQAmUCmAzaq6melNEg5QHUwc3cJxSXKA2QpkA4ANVRIusAByAHpYIQ3hEz3il1S3FssalXSB7IlSAeg6kOmg8WqWmoCQEi1KKzoQDoQ6fUh02KjOlTTyGwPhayofWwN0iFQdeR8nZf8llaRqceat7rmKSqQ8oDVnPNVbyA0UWQOEZ6XsRPvgGQ+YM0AXAwsF/vfHYRfTeLP06az/06KbDh0QHKkKKXEeQSOOCA54oDkiL3k/xH7i8FYmXomAAAAAElFTkSuQmCC",resize:"iVBORw0KGgoAAAANSUhEUgAAAJMAAACSCAYAAABBufiwAAAACXBIWXMAAC4jAAAuIwF4pT92AAAO80lEQVR42u2dT0wbVx7Hv0WVMBzAVSAiBxNHIgKUSDHkFBIpGGmjOJc4XNJy2OAU9ZBDN7vySjl5XR9WWQltaVbqZZ3Y7IE2F3Av6yiVApEInIJBIsJRkfjjQxChqp0DMafswW9aLzUzb968efNsv6+EkJLxzHjeh9/v937v937z0YcPH6CkxEMN6hEoKZiUFExKtauP1SMAQpFxLwAvADcAX4VD3OR3vsL/zZHfy4lYOF/Pz/GjegrACTQ+8jNIADrJ+TIrADYBLBPQ6gaymoYpFBnXoNF+Wh26lS0C1hyAuUQsvKlgqg6AggScoA1Wh6f1SgFIJWLhZQWTfBZolPy0VtntbwGYIGBtKpicAchNrM9dAOdq5I/7BwDJRCycUjCJC6JHCUStqE1p1ipZTcF71cBEIIoCuFVHs+0CgWqiGqCSHibizqIA/iTiesfcLWhz/7/Ba3Y1Yr948Ltjt3d28b7Cv9sEVTQRC08omNhBitrhzppcjejsOI6eUx60EXg6TxxHs6uR6Xx7+QL2fnmH7Z1d7OUL2H7zFq83c3a5v7uyxlRSwhSKjA8CSPKa2je5GtHf04WeUx50njiOzo7jQr5HdiOH7Z1dZDdyyGTXeZ76OYBR2WZ/UsFEXNoEj7jomLsF/b1duNR3Vhg8RlpaW8fS2k9Yyq7zcI8FEktFFUyVrVHKikvTLNCVgfPSAKQH1nxmlYfFWgEQlMFKSQFTKDI+YSXAPuZuQdA/gP7e08xxj1Payxcwn3mFp4svrVirAomlknULE5nup8CYdOz2ehD0D6DnlKcm8gDzmVWkZhfwc/4d6ykmCVT5uoLJilurNYg4Q+WY23MEplBkfBRAgsWdjQSG0N/bhXpQanaB1f0VAAyKXkQWDlMoMp5kma1d9w8g6B9AvWm/eID4dJo1UA+JjKOEwsQCUrfXg7Hhq7/LStebshs5xGfSLK5PGFBCYGLNH30W8OPKhfNQ+s1KTf33GV4svzL70a9E5KNsh4mANGdmxnbM3YIvR4LS54qc0tLaOuIzabOx1GQiFh61875E7E5JmgGpr6cLsTu3FEg66u/twr3bN+HpaDfzsVtkrbM6LZPZGKleg2zBwbltMZRtMJkF6fMbV3Gp76wihEHx6bTZOMoWoGyBKRQZvwvga5pjm1yNuHf7pnJrFjWfWcXDmSdmPtLHOw/FHSayO2RGgSQ9UAUAPp6Z8gbOIPlIwK1AckCX+s7i8xtXaQ9vBZAis225YCI3lQTFWpsCSRqgzqGU/5POMk3QpAAUSNIBdYuslcoBE4mTqGZuIwG/AkkQUBd9Z6gNASkHchamMvdmqM8CfjX9F6ix4QD6eqgqLFppx9Buy0QVJ130nVHrbA4BRZkpv0xSOs7ARNzbdaPjPB3tGLk2pEbWATW7GjE2HEATXTlz1Iq7a7AAEpV7ayJfptpqs2tJnR3HMRLw2+7urHSOo9ocGfQPMAfc9x89tu2v9cuRoG2DN59ZxXzmlS3nvnf7JnNAvrS2TrOOdzkUGR9MxMJzQmAipvBvRsf19XRZipPs2BWrpSbsnkllN3IsdUe2x0+RbydpCuySKHXVE+LmojSDNnLNL9XDFJnjGhsOmJmaC4ufRgJUsetJltyTaZjIrhLDnFLQPyBVqa0TyVIZgerv7aJNF0yYXWphsUyGVsnT0S5VGsDJrLuMQI1c89PM7lpJXGwPTGQh97LhzQaGFEgSA9XmbqX9Y7cPJpqT95FuIwokuYG6cuE8jrlbDK2TmdiJGiYygzOMlWQJumVcUJYJqGZXI22JdJQ7TCj1kdTVRd8ZKYJumSsTZALqUt9ZGut0kqx0cIXJ0MUFh+TYDNBWoZWg0tGzbh6GhBom4jd1R6fb65FmAHM7b3H/0fcV+1A6LYbif9utE8XM7jrNmh2tZQpyIryugZINpPJgnAcDhjCRxJVuZcAxd4uU7W1kAWq/eID7jx5LCVLJOlHFcKOWYaIhUuY6JaeBKoH0vV3ddznFmK00WfFzRq6OC0xO9UuirNFBbuctHkylHAMpt/PW8FhPR7ujszzKMQwyw0Tj4vp6uhwJvLXpP23h/OvNHOLTaWlBunf7U0fTBpSB+KgVyzQoo1UqzyOZ2YnxYvmVEKBYQNKKB50Eqp/O1blthOm0YyCV/1XJApQZkErf5dPfVaE6BRTlWA7aApOno11oOa5eZtvM1h67gNrLF0yCdPPI5+cEUJQzcvMwEXN2TharRLNEYmYAeAO1ly8g8u1/TIFktNwjGqhmVyO6vR5bLJOhi+vxeqQBiWUAlrLr2MsXOA2EC23G61ym1w1FA0VhnY6Mm/Rg8nEyi8JAMjMA2nl5zUSbSfyjt0eNdQFaJFCUBsLH1TJ1e+UEiWYA7Koq0APK6jVFAWUlbtKDyat3ts4T7bZ/sdidP1oa8EoDYHd5SiWgeF1zbDggxDpR7AD2moVJ911vImqFeLig8v32ouqcDgM1diNQVc06KO61IkwfHzGTGxQx0KI0NhxAfDqN4NCAsEHVgMpu5Kru9RxtnxiO7WWWPJOjwTfPgXWir3izq7Eq3/PCOktvYAm+m1TfgJpWc5Px+FbyXkyWSTXrqm2xjm8Dy0xOSakSI0wwiUgLKDkrlvQAk5trdrnU0671uIlhjBvUY1PiJQWTkoJJScGkpGBSUlIwKSmYlBRMSgqmCtrU+1B2I6eeXI2LYjv7JheYlJTMwKSr7Z1d9ShrWKzjexRMui8Cfi9hEy0lftp/TzW+y7Qw5WvNOm3v7GI+syr8mnf+/i/h1xVhmRKxcJ4KJpqXsOz98q6qHs79R4/xcOaJsIHVrvm+eCD0ujxEsTH1udnUQMFpy8SjQVf5oAIQMrCHr8nruvvFAyFQbr8x3OKeNwvTstPpgaeLLy09vEqDajdQR11Tuy7rH6HWXcWuV4+ZTAssm4VpzuIFuYh14PUG1S6gjK4JlN6hZxYoM216BM3k5rhaJpFBuNmBpxlUO4BKPVswvOZ70iyV9tmJBMmEx1nmDpPITDjtwO8XDxCfTlOlL5pcjeg8wW+nDe3LlWmBEg0S5ZhuVZrJ6cKUiIU3AWzpnXVpbR0iZQSU+a5tfLeK03RCoQXKCZAAIGscvhwZ/jSwflCLm0S3RD4KKKdB4gmUUyAtra3TWHR7YCrdwE/C8yCHgTLbkNRqdxU7gXIKJBNjyQxTioZmJ6QBxdLZVkTTDbNAxafTpnpiOuTiVkj4Yx4mEmit6B2Tya471v3/4cwTRL6dZGqRLELNrkbE7tyiatKV23mLv/7z346BtLS2TvNWcV1PRVM1kJTR1WmieACOgHR4lifbe3oZxzBpFSZDV/d08aW0D8lpkKoBqP3iAc1LgrYSsfCyJZiIj1wxMtEyVhHIApLsQFEmbg2NCm1x3IShdVqQyzp1ez1SgSQzUJSeZYIXTCkYVBG8WH7Frac2H5BuSgeSppFrQ9I0TJvPrNLEnc/1ZnGmYCKzOkMzl3q2IMUDer2Zk7Z+SEtlyFKtmpqlGrMkzUFmasCjRgfIZJ1kLEhzMiFpIR1QSMTCfGEiZu55tVgn2YCSDSQAmEo/4xIrsVimqrNOsgAlI0iUsVLBNphIbbihdYpPP5HKvTgJlIwg7RcPMJWepbJKR5Wb8LBMVNbp9WbOsTU7mYCSEaRS0P2CZgJgyioxwURrnabSzxx/BbyTQMkK0vbOLn5cXOJulVgtE5V1+jn/DqnZF9JNzUUAJStIpRCE6oWNpq0ScMS7U2isUygyPgnglt5xPy4uob/ntHSvxng48wSX+s7aeo2RwJAt56V5e8DR7m2BFvC7Zq0SAHz04cMHphsLRca9KNWJ6xYHNbkaMf6XL6TNRteLshs5/CPxmObQlUQs7GO5BnN/JpJ3MnR374sHeDCVUqPp8OztwXfUYzDKeh1Lzb4SsfAEDCoKtNkdZdpeyQY9mErRLt98Y1RmYhtMZkj+YXah6ho41ILi02naDbNbNJ7GVpgIyX+mOXYqPat6OwnUfGaVpuhNU5Al6OZtmTR3Z5h7MrubVckaSA9nqFcivrLi3rjCpJENg5onDaj4dFq6hGYtaXtnl3a5BCjVKkV5XJcbTMREBmmOze28xf1H3yugbAKJps8CUYF2zERbJm2pJaSAqhqQBq3GSeViTlrqKRQZT8IgO67J09GOseGAelWrRS2trSM+kzZTwRmiLXpzFCYCVArAdZpj7dz7r4LtIwPuKO/7sPMNBaOgSGiWz/JUHsq8ptLPzII0aQdItlomYp3cKG0pPkf7mev+AQT9A4oSA2l9qDLZdbMgjdp1T7bCxApUt9eDL0eCanFYJ9B+MJWi2hovCiQhMLEC1eRqxNiNAPp7uxQ9ZXq6+BLf0eeQhIEkDCZWoADgDxf6EfRfrHsrtZcvID79hKUxrRCQhMJUBlSSdpanrFRJqdkFPF18ybJx8yu7gm3HYSqDKgnKPNThWGps+KqQZl0yKLuRQ3wmbTY2+vUx884jSQkTAWoUQILlsxd9ZxAcGqhZqLIbpfovxl7rWmZ7WfR9OwYTAcpH4qhWBZVliIBSXo/rEknVwFQWR6UAXGY9x0XfGVzqOyvdxgVazWdWMZ95ZfWtD98kYuG7Tn4Px2Eqg+ougK+tnMPT0Y4rF86jv/e09LO/vXwB85lXtNu0jdxakOZNXHUDU5nbm7BipTT19XShv7dLKrD28gUsra1jPrPKa0/dJBi3JdU8TIesVJQ1lqo0C+w55UEP+S1K+8UDZDdyyG5uI7uR47kpcwvAqAzWSHqYymKpCZYUAg1cnSfa0dlxHG3uVi6A7RcPsP1mF9s7u7/+tmFHbwGlbdtRGcdMWpjKoBokVuqy3dfq9paganO3oO0TfaO4/WYX+8UD7BeLoraBTwKI0rQDVDBJBJVkkh6iqoOpDqGqGoiqFqYyqLwEqiCvQF0CbaG0djkhywytLmA6FKgHUarsrFZrNQkglYiFq7opQ9XDVMFaBcmPzGAVUFpGShGI8rXw/GsKpgoWa5CANQjgpMO3tKIBJFt+SMHEDpeP/PbaCNgKgE2U+lfN1So8dQuTDmQ+AG4CmZv88yDFR/P47aXYm9pPNc2+FExK0qpBPQIlBZOSgkmpdvU/qa4Z7QH/pAsAAAAASUVORK5CYII=",remove:"iVBORw0KGgoAAAANSUhEUgAAAJIAAACSCAYAAACue5OOAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKi0lEQVR42u2d73XiOhPGH+fc7+atALYCvBXgrQBuBXArgK0AtoLlVgCpIKQCnApwKsBUgKlg3g+Czd1NgsaWbEv2POfoZHePNzHSL/NHGkkBEUEkMtWDdIFIQBIJSKJ26a/O90AQ9ABE17/Fnzw1AJB98O/J9WsGoqzT3diZYFsBE1+hia5wDC3/lFcA+RWwFEDaFcDaC1IQDK7g3Fq/oTe5XMFKAOzaCla7QAqCCMDsCs7Q0bc8AdgB2IIoFZDcsjyza+t79vatgcpfkILgBs+oJb/UrwDWV/eXC0jVB8wLT61PkZhqDWDtE1B+gPQG0AJA2KGs+hHAyocA3W2Q6gYoDIEo4j2bZcDpVFdP/HDdQrkLkoqBVpW4sNFIATMYvH0dDMp9rzwH0lSBlaZv7XKpwuWtQLQWkPhZ2NZqED0eA3GsGtfimCpNgSR5a/bAegWwAFHi1LgRkTsNWBFAxi0MiaZToqcnckaHA9F8TtTvk5XPCKwJ6Lkydq4AFBGQGneua/Dcg2o6VcCbfeaMgFhAUhAtCMhLd2a/T7RcEp3P5J3OZ6LNxoaVWnUXJKBHwM4IoM2GWqOnJ6LRyASmtElX558raxtAf2q/NwEqJyDqBkhAXMqVhSHRz5/UGZm5vFm7QQJmpYNoH2MgGzHUclk+q2slSCqoLu7G9nvqvA4HouGwDEzbdoEEbAt3wnzeTSt0T+Ws07YdIBWFKAz9mAtq0joVj522foNUFKLhkOh4FFg4sdN47BRM7sREXQ2oTTSfOwOTG9nZcilQmEwTOJDNVTVPxP9gbZ5crHNWvNi6nfV5JrtlJGoXR8IuQttsgNkMIktlK3FcpFzlm81SFHsgqWrGBNxtQAJR0zBdAES2ynht7v3fCkQNK4pUEV3Icggh1FYouANSECwAjAUiR2DasfkYIgjslO5aWsmX7MzvbC5uPmvjloNMpzK47i6p5Ka1TGbBdhCsACz1BnSofHevJ66nbk0mwPMz58lnEE3qz9pUqn/Qh3ShyibKbvcRmSnPVdzE24NXekrAJNjmBWnbrUDUpHq9IsH39jqNU5NFUpsXN9rn5nNgvXa3k9dr9Rtra8AWC7c/6/fvnCd/gGhVfdamivYzVlGay4uw06mt/WX+JBS8WvCcgEH1WRt3E6PLlY1VQOQDTMcjd01uWy1IyhrlXndmlRD58Pn5UwKD6tJ/TrofhupAhapT/e1W/Zyia1G8VNhc43G5cwZWq+rfbTDgZHGPIJrZj5G41qiuLUNmmwndbXVov7dulYqk//ozivp9tzMXkVIcq6N9GPaxinmkmRNmWWRHvLGacueVeCCpeaO+1hrJqn4brdLCHkhijbpslWZ2QFInqI3EGnXWKvURBBNzkDimTSDyV7yx04Kkn0cKgkwbH53P9ZeIpKm9dTLXrETd4s0r/e/eqbp/aSCKtBBNp83UGdV1qGhXrNKPHxyrtC3r2vR2bzKRgRD3pnFtQZDi3s6QMHTHvSSJuDJTC//6eu+JC4h6xV2bytaG3lijb9/8BMmVc85nM129UoggiD+roLzn2vS/KuLW2iPeWE7KxEj3QQpDAalNGgzUJg2NI7YPkiu+XVRnvDYsBpKKj/oCkoD0ARtxEYsUWfmhojZmkJZBkgnB9qnX48RJA3sgjUbS6W2V3kBERUAaiDUSkIoE3A9Fo/NfqaKoqyDdkjENSB88JBapQ+IZCQZIOrcmFklAYoIEAanjKpG5PXDnCX4pDKWjuzANUFDFLZLER6IPpgAepE9E731SrLVZApKoEpXL2kQiY5BksVZkJdgWiZggZXf/h69F9iLHQBKJxLWJBCRRfUpT3RO5OUhFz20U+Sf9pteUA9J9HHlXEYjEtSG3QKzIZ728WHFtet+l96Gi9ro1pmvj3HEqcVKXA+1CwfZJQBKQPhVRygXpPikyu91e6Y3EKzfYBtS16xIjiUViG5kHbjD1my4XcW/dzdhSeyCJe2uneGOa8EFSmdtFQBKQTC2SPk7i35Mq8kX6MX397Ijk8iBdLhJ0t0l5rjuM9C4T5UEC1OV7oq5Yo5IgqUmnk7g3AcnUIgHA/e9+Ool7a4tb01/R+nzvComHsgT+0notA+G7eCHKXaPCudQmx70rSOu6DFmnIPBzEF04sN3CpTacCsmtNnuTWMlfJQkHortuzQ5IgNwe6bN4oYnWUuhdm3Ib9y+3AYD9vtlduOLaiivLgC9fdE/dvcymiEUCAD22YpX8E2/MWJE41yL1oMoHQmetklikKqwRAHzhVM0+MD9s7rxV0h9X556aPP2ON1aPrNJrFNvXpjdxLy/NLZv4eEpKU7dLJQnw+GjNrV2NDfEbsCVljD9v/T7R+Uy163gkCkPSvp9Lbb+nRjQacd4vKcJGUZAGrA5aLpvpoJ8//YFoPm+mjzYb7jvG1YGkYFqzXuRwaKajplP3IZpOm+mb85lrtZOiXJQBqUdArn2Z0Yga09OTcrGuARSGymo2pfGY+66Dolzw0v/3qfYKwFL73HLZbCaXJO6UBEdRs1e37nbA339znvwXRIvCSFDZeYwgyKC7ZRIADgc5m7tpZZkag8tFP4sNDHTraqbp/5+asVNcOXSi+WkGPUQAsCgDkRlI6v73f7XPnU7qTnlRM1osOLXYAPACoq0BD1S+qcA7c3pKoMvip/p5mQDbPNj+PVaKAexZz242Yp3qUpoCX79yn/4OIqNSV3OQFExrAHPWs02Xm3QFojjmxkXPIDJOJ+2ApGDS1ywBaqEySSSTcwOiE4CobIBtK2t7lxtAt80bUB8wjmX3SRXKcxU68CBSY2YBIrsgqXIDnokUmKqzRLwMDQD++ejArOZd25uLmwHYsJ4VN9eEOwNKzl7X5dpulmnLml+6WaavX2Xrd70QPdqGyHweybR2SeaZ6ponurW0qvGuDqQyME2nzRTF+aj5vDhEQM9PkMrANBw2V8vkg45H1UcOQVQPSGVgarpux1U9PZUpJ64covpAKgPTrTjueBSAzuciRWm1Q1QvSGVh6rp12mzKbmrY1gVR/SApmGalylT7/eZ2XTShw4G72+Ojtq57XOsHScEUs+q+P3N3bQ7Gj0fTDQyzJsa0GZDetjalRjsx2mShzAHKCIiaGs/mQHorjFsb7cwYjVQ246v2extbqHZ1xkPugfQG1KS0q/tvDLVc+pHlnc8qgTDfMpUTsHBhDN0A6c067azsHxsO1UC5BNX5rDKwcmn8x5sYDctjbTb7q//m1QMTqJNP+la+33CoFjUnk/orM2/76na7IuUd2qVuACvT0ljrw+YcSAqmHoAFOJswy4AVRb8304NU81ytwmeZ+pqmnFuGyugRBluGugfSG1ADACsA08p/1nCogOr19PVRWfZ2zVg1wPypFwAz7llFApILQLmll6sbS5wfIi9A6h5QzwDWPgDkJ0i/AzW7tn5L4LlAnZC2dtmFtQuk91neDMDYY+uzM9ouLSBZz/Qm1zb2Ah4FUCtO2GgPSB9bqvjamj7y9hXqgiDVWgJPN0B6b62iK1QRgEGFcJ2g7n1Nr+CkbQSnmyB9DlgE4AbZbVbyv3++p1tGlV+hyW1uOBSQRJ3Ug3SBSEASCUiidun/DlECl01FAtQAAAAASUVORK5CYII=",itemAlert:"iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3FpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQyIDc5LjE2MDkyNCwgMjAxNy8wNy8xMy0wMTowNjozOSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkZmM5M2YyZi1hYzg1LTVlNGUtODE2Zi0yN2UzOTNjNTM0ZjgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RTk1OEVGRDQyRUI0MTFFOEJGQzRCQjY0RDUzNERGMzYiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RTk1OEVGRDMyRUI0MTFFOEJGQzRCQjY0RDUzNERGMzYiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOmFjYjg5M2U2LTllNTktYmY0ZS04MWVjLTM4NmQyOGQ1NjEwZiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpkZmM5M2YyZi1hYzg1LTVlNGUtODE2Zi0yN2UzOTNjNTM0ZjgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz53t8IQAAACGUlEQVR42qyVz0sbQRTH36YhblAJCtYKHqonBW3soWB78VCKCkppBCFeevBWKCiekj/AnIT0klsPXhQKLbQWtIgXDyp4UgNtQcSDP1APkhYxDZrt9zvOxkXdTUJ88GFmZ998Z/btvDeGZVniYnUgCvrBE/AI5MAe2AbzYBac3jmbwjcwQQycWsWNPnEQvKlj2Ds2DIMDj9GdAx2Sz0tucUly3+flYmVN8scnys/3sEH8L7olMNAvgVcvMeDjcBoMQmO3oOcIRTNYZXuxlZaziZhc/vwlXvagvU2qpxLi7+wQHaLnui0Im2AZPOMuz96NiZXNSilmmKZUp5JXuxdZBz3g3Kffj1FU7bQMUfWP4Ms5nEsNraV2XI92BzENZfpeu35+1fCQav99+uwaltDCV8Y8g8dWnz5SIYbAK6bB8fcKN+NcalCLmhTu5RP/fqXm0OijcBd7PFKVmkMjTOFG9uxzWok5NBr9/B8gUHTS4WFZi1CYM2qZUV67/hOJFhWjhrYjhuK3WgFp6rmDp2GFp8+1xgaFf7DH3PeymtQHhZc5NBZKThBz9K1qsx+nS0oQu1bEwCTT8i9iWU5K2/Wi9susXYziIGHXiiTY4gsWFDqWI8o5WjSttcQWPgcRcMAqxdX5acWMPvTVlW0fvNFatwp9C7rf7qPQ33U1BfV1cz9Xk8tlOsKCoi/TJj3OhNrkkQIzbpfpfwEGAB0OebpeExhfAAAAAElFTkSuQmCC",itemAlertDark:"iVBORw0KGgoAAAANSUhEUgAAABYAAAAWCAYAAADEtGw7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3FpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNi1jMTQyIDc5LjE2MDkyNCwgMjAxNy8wNy8xMy0wMTowNjozOSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDpkZmM5M2YyZi1hYzg1LTVlNGUtODE2Zi0yN2UzOTNjNTM0ZjgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6RjQzNTRGRTYyRUI0MTFFODlFNDdCODEyNTEzMUI5NkQiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6RjQzNTRGRTUyRUI0MTFFODlFNDdCODEyNTEzMUI5NkQiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChXaW5kb3dzKSI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOmFjYjg5M2U2LTllNTktYmY0ZS04MWVjLTM4NmQyOGQ1NjEwZiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDpkZmM5M2YyZi1hYzg1LTVlNGUtODE2Zi0yN2UzOTNjNTM0ZjgiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7DiQshAAACAklEQVR42qyVvS9DURjG3yuiDNLQwUcMNNKkidDFoB1qU4M/gIQJo1oQgsFnsGDEzMLCoDYkarDUx6KRxkBEaMQktdTz3JwrV7m3qp7kl3Puvec899xzz/u+WjqdFguVgU7QDhpBJXgHd+AG7IMt8PLjbBpnUAxGwUs6uzhmDJRk+mgZK64Fe6CB909OonJ0eCSxWEySyaQ+wOVyic/nk2BrUAIBv2iaxttXoAPcGkZm4xpwyjYej8viwpIkEgmxk9vtluGRIfF4PKK2qEW1n8bF4Bg0R6NRmZ6akVQqJb+Rw+GQiclx8fv9vDwDQfBWoJ4P0pQrzcWU4ljO4Vx6KC99xeVoE2idfb39lp8fag/pbWQ/Yrkt6xtr3PNXXhaoI+Xkj7Lb056ebh0rcS496EVPGrfxin8/X5k8QjT2sccjla9MHk00rmDPOKf5yORRUcgfC4qyTXp6es7pJTR+AKWMKLtVhwfCWc3oofTIrbhmj2FqJ6/Xq2Mnk8c5jQ/YY+zbidFF7GTyiBSq1DeLhOLkIbc6yzvbO1nzBpMSxADZMnLFKJhjWIYHBnMKaSNfrKwuG8loDMwbuWIZXPIBP5cDczHlHGV6pby+pM16Bg+o/mPavAetqrp8S/R1YPc/Ev1PpalElZt/LU2ZxbSLCUUV0yp1nwF1wSMFNq2K6YcAAwCfZ3CwpLDluwAAAABJRU5ErkJggg==",maskMoveShape:"iVBORw0KGgoAAAANSUhEUgAAAIIAAACCCAYAAACKAxD9AAAACXBIWXMAAC4jAAAuIwF4pT92AAAI3klEQVR42u2dvXMTRxjGH90w6jw2Yxq78dGYivgYqOxCR0WVQZmhSgqLSiXKX4D4C3J0uEIUScUMctIkFaeeDBJUoeHU2A1MpFGnRineUywJfZx0u3f77u4zo5E/5fPtT+8+7+67u4XRaARjdFbYAeAl+MkI1VEEg1TQDoSzghc3ths/7wAopXjFVvwcAohiSEILgnrvcD9+eCkbfF11YjjaAJqojnoWhGwb3wVQjh8lha6sA6AZQ9G2IMht/AqAIwb3tRtDEXDxGmqDcFYYN/5DxlG3BaCB6qhhQVgfgAqAOoADjfxYF0AjjhI9C8JyAOpxBNAJgFn1AQSqAaEGCHpGAFZA5AvCWcGPb8YRzFUXQA3VUdM8ECj/DwCcwmrSVFbyyjKcnDKByELwjUoA2rFP0jgiUBRoME8FtY0O2YBA4/9Nw8ygCDNZyco7OBlAUAPw3kKwtrYBvMFZIeAfEc4KDesFhHUVZZlpphwQyA+EhqeFotWJu4o2DxAsBLJ9gy8DBkcwBF6cGloI5PmGML7PioJAFxfGF2vFDAbHQmBhEOMRyBNEFgLensERAIGNBBpEhrRdQ5OtMdz3dYKhEb8pcwCBBotKLG/drgd8/5ae9dBR/KbMGAQqJOE7YngSTD/roVKa4WhnAwg8AC/Z3q5bFWAvDmR7JfpcHz2Jp/klZw3UD7XBdQKpuAP8FAHFCW877AO/usCwpwsMfQDeulPY60aEOjjPIp4E0xAA9LleXQSZR2ldA4WcJ2xvz74PHC6wNYenOmURY79QF981cO8SAOBRG9hdkul+7QCvPZ1gWKuLSBoReHcJt2vLIQDo+7drxnYRqyMCZQnv2d6OLZeiQTHB4OewT1FhEOkExA9Jyt2SRATeTuo4SAbB2Dgea2Ucqf0SjDo6CQxiie0t2PcBd82iafehbsbxAEAtbUTg/fbwG9n+nrqqrYoKzpJoUGFtEO/Vga0NL3/rgH5fL+NY28wsnhUitiBsucCPn9O/zm83dTKOfQDuokpoZ4k34BsN7jfUeh0GUcFZ2KdwlVu+mlRKq70SvZ4+qiQHgcYNeGYKxR3x6d9xQK+rSwZB3i9RROAbDdIYRHOMYyWZWTwr9MCxBnHXAx5JHAB9fQf42tYFhpuzcxDOnJSRZyGq7Klkvaaqa6u6Bp7OaLLqSJb0qmYqL+4aaOTpX5YGcbbqSJb0qma6M7kewmEfDU6CbCAAdKtmKi/qGnx2/8qyqiNZ0qeaaSEI/CJCXlPGekxVH01ORDmxP/DYZQtJqo6kparaVDP5sxGBV6zbcvMf5LlXp+vQDAReVZvHGRrEZcaRfxfBOCJsUnUkS/yrmY5mQeAz5axa9RD3aibaDxvO+AMWkjGplNqvsJ+UcscRgYfj2XKBu0/VvLa7TzkbR2YgqF4txLeayR+DoH7GILLqSJaYVzM5oAMy1ZWMqiOpaS27aqYSj65BRYOooXEsjF5A3fP+ZFcdyRK/aqbr15S+vGEP+OM+PxD41St4aoMwiHRbmay0WbSysiBYWRCsLAhWFgQrC4LVYl2zt0CAdj2afbwxZ9rmImSRBqs9sqiy3DJws0zPScrmBl3gMgQ+BCqOOl4vjF6gDdlnLqgw/n4R0iOtblWAu/V08x+XLeBdXcz1iFB1VLgGQP54qCoFJWlu/K5HNQciSuj3SnRexGULeFtRottwQOcxWa2KAo/ei19HsVeizUDzrWNoWRCS6H4D8CUeT1HcBh68yXOldc+CsErHQXZrK/2XecHQtiCs6g5uZ3wqgf8yj3USEYFQHYW21ecYw7zK4x40sy53+z8iAHQSudVYJzkuqct6D4Z4swxnkgorZLMNzyodnma1TqI1mT4CdJqrFUCDRSoom0G4tgVhnvZ9dSqmD0+z8ArhNAi0517XdgsV064nnI0INioAwJ6v1vXITSVbkzu1T4LQNBqC4o56C2nkgjDV3s5EGtEE7elvpm4ouAS0uC3TJywAwfSooOqydjmAdpbvxWxBMEWN2S9Mg0Ddg80e9FdzOQjWNJqg83nHBM8DITDy9nwxZpS9Me+L34JAtJwbB4KqK5gvQpGv1l10PPCidQ3mRQWxN1yMBsLtWn3RN+aDQDUKLeNg+KrYbPyl8GjQWA+EFfRoq38aal3PZ6G+fek/txgEE6NCpFDCNOyLvJ4uqqP6ZiCYGBUGEfDplRrX8lGoTVvZjstBoKhgVgbxrq5GNPggDITOMm+QNCIAdDRc36io8PF5/jCKS2cTnTCyGgQaVwiMiwp5ZRCXLZHdwqukVerJ9kcgo2FOpfOwR2sShxkHwkEX+FPY8rc+1jjeeZ2NMipmjSm0gd/97GAY9oG/yiK7hMpkBZI4EKj+/ZmFQcbf6dDfEbdvwvmioWQREcG8LmIMw2tPnmeIzkVD0N0kem+yh1IZppW0DSKC4e9n4qLDsA+Ej0V3B9Q+a3QJY12dDb2O6Pift4l/XoUDsETtY1TcAb6r0bmPmyyLG3SBTw0aJxA/4/kzqqONUo7NQCAYagB+gcka76O06y3fROOyRfUOF6HMYexXqI42NvSbg0AwNACcwoq05U7XPn5pZ1Xn0EF1lKrKNR0IBEOI+BQQq1zUAeBv4gvSmsV55tEuq89HfREQiAGBLsK3MPCFQFREsDDkB4GwwQdxezFbGNhCIBaEaRhatr2kGUNXNARisgabWmalFjYcNcwXBILBDjqJUarBovxBIBh80DK6bdueG+lxklIz9UEgGNwYhiPbronVjbuCTNbiZQPCFRB1AE9tG6/UcwB1WX4gfxAIBg+02MJGh/lRoLZuUQlPEKajQ816h/yigBogXHmHAMBDw9PCWlZeQE0QpjOLOsyaxcytG1AXBLOA6MZdQEOli1ILhGkgapp1GS0AgSoRgAcI0x6iBqp5OGDY+H3Q+EmQtwfgDcI0FOUYiDKDTOMcQFO18K8HCPOh8BWJFON3fhgD0ON2S3mC8G334ccPD9kMVHXjRm8DCFUP+2aAsNhsujOPnTUh6YIOvurFDR4BiHQ9A+s/810wc9nms20AAAAASUVORK5CYII=",maskMoveImage:"iVBORw0KGgoAAAANSUhEUgAAAIIAAACCCAYAAACKAxD9AAAACXBIWXMAAC4jAAAuIwF4pT92AAAI1ElEQVR42u2dP2gbZxjGn5yDiiHOGbtBaYodBYqHJsFXsqWDRQaDoRB1SuliebmxUSFjQhU6ZpGzVUvkzR5CZDqYdsllqLM09EySIaIQOa6THMEiig0GgXEHfUpk+2Tdne9035/3AREIPumk93fP977f32O7u7tQSUU7aQAY7PZ3puFYKv0ux2QDoWgnBwEY7JVi/w4CGA/4lnUANoAqe9kAbNNwqgQCX4FPAciwgKcBnO3RR7cAsQBYojuIkCAU7WSGBT3Tw8B7AcMCUAZQNg3nPYEQTfDTALIs+LoAt7woEhRcg8Da+yyAHEdPfhCnKAMomIZjEwj+2/28QE+/Vz0CkOcxn+AKhDYApiWv1lYYEGUCQU0AuHWIWEFgOUCOvXSoq0UAuTj7JmIDgVUBJYGTwCiSyoJpOHklQGAuUFCwGfCTP2R7XWFoMbiATRAcqnEA/xTtZF5KR2Bf7BeKs+9kMtOLDqnIQWBNQRnABMU1cO6Qibqy0CKGwGBNAUEQXDqAh0U7mRUSBDYwZFFVEJruFe1kSSgQGL0PFO8biELTUcEQeo7AILhHMYu8xEyHmURqBIGwJabFEnG+QCAIxIZBIwiEh6HMBQgEQeyaCCOBPFKyyPoJrCiqgzMnLgMAvjjxbey/dGOnjqfvirwDcfsoA1aBQWBtUzVMCBJ9Oi5/+StS+hQSfSe5+pUrtQVYr37iHYYZ03ACucNRmoZQnSClT+HHr//G2NA17iAAgLGha0iP3uUdhAJz6d6AULSTBQRfMOIKweS5EpcACAaDDqAcpJLQAkCQAXA9zOZAgCdNJBjOojnhJzoQGGmlMO/64imTeycQEIar7IGNzBHKYVcIF0+ZQtZsAsBQYpOCwwWBERbqcPJw/wUu3WBj+7kMMOhoTgkMD4QomgQA+IzTJqFaX4L16roMMHhuIrw6Qh6KDSlXavOywFDwUkVoHtzACLNKIBhiqSJyYThCAQpLEhhy3RJHrYsbpEHzDWWAQWfNe2BHyIMkCwzTh7mCRm6gFAz5II5AbiAfDNOdKgitgxukyA2khSHnxxHIDeSFwRsIzDoyFGppYdDdVk25OYJs+xYRDO4x7gpCjsIrPQxX95eSmkuSOE6hVQKGzGGOQLmBOjBkCQSCAQDG25sHbV+1QH0HasGQdnOENIUwPhhimrKXcQOBmoUYYUj06dw4gkGhixeGGKS3FsRobfkBlY1qwmAAwHFyg4MaSIx8XIQblrYar1CpLWBs6BpvXzcNoHRcxESxUltAtb6Eje1n2GysYSAxguH+C0jpU6H80GND13gMWFRKtTtCSoQ73th+jj9fTmOzsbbn/zcba9hsrKFaX8KTt3cweW4Ow/3nydq8aaI9WUyJ4AL3X1w5AMF+bTbWcP/FFVRqCxRijyrayZTWTgXPTrC8fsvXNcvrtzyvWCIhpYlwl4/Xb6KxU/d1TWOnjsfrNynEHisHjU1S5doNXm8tB7r29dYyuYI3DXLvCNX6UqzXq9Q0pPh2hGexXk8gcCK/uUHY16si7puG4f4LsV5PIBAIBAJXjZc+FXiINtGnI6VPUZRlACHRdzLwpA0RN+qi8vEQXTp9w/do4JkTl3Hp9A0u7p/jIeiW3muiIDt5bs6zzTc38JzjBoJKbZ6ahjCbiMlzJaRH72IgMeL6NwOJEaRH73Kzi6soEACfhqGFUWuuwMb28wPzEXgaehYJghYINgTUcP95bucciAZBq2l4D5LSEACwNQqd8hA0q4aoj5olCIRQteUIyo7MNE9mua4yBABQbVUNSp7fvP94nvTorIoQ7HGEquoQBFmEIgkEMA3nIwi2yhAEgUEWCAA8apWPSoHQ7bQ2LzBIBMHH2GvMGiyCwBsMkkGwFwSmFYLgcBgkhABoHtu4BwSLIOgMg6QQrJqGUwX2DjpZkPCAjqOe4FqpzePN1l9dl9qJ7AZ7HME0nDJB4C5JIXAHgWmRIFBK5U4glAkCZbRoGs57aUEgCPy7wQEQGCGLBIHiIIjsCgSBL821NwuuIJiGU4Jgw9IEwdHcoJMjABEc/0sQcKNVt66CTiAUCAJp5RpbVxBYt+McQSCd6p3cXsjj/giC4G6wP0nsCgJzhUcEgVRu0LHJ7zadPUsQyO8GXUHgKVcgCKJzAy+O0MoV6gSB0Mof5gaAh0WwpuFUi3ayAOCXOL7BxvZzVGrzoe+WrpBWTMPp2h3gaTW0aTh5dnro2V5/i+H+8/juqwcUzuDydI6nn7WPoSeOEk/44EWzXicmewaBveFs2CBsNf6jcCGSHWJX4aMvyO9q6Dz7gND0Qr4Job71Zms5ih1is90SxMAgsDcO9TS4p++KyrvCk7d3YmsSgjoCTMOxAfwc1h03dur44+U0GjsflITAenU98O7zh1QJvg96D7RRBitHQpvJtLH9DL//+71SW+o3dj5EsVaijoDncx3b3d0N9InsiEALIR8TODb0Ay6eMqU9k6mx8wGV2gKevvstiqrpG+bYvQOBwZBCc+1c6MeYJvp0fC4ZDK1DyCLSDJtdhp6DwGAwmDPoIMWl26bh5I/yBkcGgcGQBvCQ4hGL5kzDyR71TULZVY2VKjMUEzEhCA0EBkOJYBATglBBIBjEhSC0HIESyJ5qNkiHUU8doc0ZbNaxsUpxC71EzEXxxpE4QpszRNLppKDqADJR7nUVKQhtQJQATFM8A2mFQVCN8kN6sik3S2xmoPBWv0GTQgDpqCHomSO0OUMKzZU2ExTjrk1BtpfbGfUUhDYg8mjOpaOq4qAW4XNSibAgkDu4ahVALq5NzWIDoQ2IDJqLL84qDMFtdFmJJD0IijcXc2guPqnGfSPcgNDW75BTAAhuAOAShH1AZNCcNS1Lk1FHc8sargDgGgSXHCIL4KqgAKywpLgUZw4gPAj7XCLLXrx3Wa+yp78UdA4hgeC99MygObB1laMn3xIp+MKD4AJGmkFhsH97kWg+QnPirgXA4tn2lQGhQzNisNcgPs31N3xC0to6yEbzxFwbQFXEJ76b/geXEooCwBQ2IQAAAABJRU5ErkJggg=="};}this.side=null;this.design=null;this.editTextCallback=null;this.itemRemovedListeners=[];this.designItemRemovingListeners=[];this.itemChangedListeners=[];this.itemCreatedListeners=[];this.designItemChangedListeners=[];this.selectionChangedListeners=[];this.deselectionChangedListeners=[];this.imageLoadedListeners=[];this.textArtLoadedListeners=[];this.notifyMessageListeners=[];this.removeMessageListeners=[];this.gridImageSelectedListeners=[];this.shapeLoadedListeners=[];this.fillShapeRequestedListeners=[];this.undoChangedListeners=[];this.redoChangedListeners=[];this.bindedUndoStackChanged=this.onUndoStackChanged.bind(this);this.bindedRedoStackChanged=this.onRedoStackChanged.bind(this);this.areaAlertItems=[];this.areasSizeCountCollection=[];this.areasSizeLimit=52428800;this.panOrigin=null;this.preventViewMoving=true;this.preventAreasAndIndexUpdate=false;this.usedColorsItemsToCheck=null;this.touchEnabled=false;this.isSafari=/^((?!chrome|android).)*safari/i.test(window.navigator.userAgent);// Event messages customized
this.customizedMessages=[];this.fontAscentCache={};this.originalBgImage=null;this.currentDesignOperation=null;this.undoStack=new Zakeke.Customizer.Stack();this.redoStack=new Zakeke.Customizer.Stack();this.setupUndoRedoStacks();this.executingUndoRedo=false;this.showDashedEdge=false;this.DashedEdgeColor="black";this.showSelectedElementDimensions=false;this.showUnselectedElementsDimensions=false;this.showTotalSizeOfCurrentSide=false;this.unitOfMeasurement="cm";this.RGB_HEX=/^#?(?:([\da-f]{3})[\da-f]?|([\da-f]{6})(?:[\da-f]{2})?)$/i;this.supportedBlendModes=['normal','multiply','screen','overlay','soft-light','hard-light','color-dodge','color-burn','darken','lighten','difference','exclusion','hue','saturation','luminosity','color','add','average','negation','lighter','darker','copy','xor'];window.imageEffectCache={};// cache degli url dei blob risutanti dall'applicazione degli effeti sulle immagini
this.maskedImageSelectionMode=MaskedImageSelectionMode.Element;this.shapeImagePlaceholderIconPathd="M 15.2,12 A 3.2,3.2 0 0 1 12,15.2 3.2,3.2 0 0 1 8.8,12 3.2,3.2 0 0 1 12,8.8 3.2,3.2 0 0 1 15.2,12 ZM9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z";this.shapeImagePlaceholderIconFillerSize=8;this.selectedDesignItem=null;this.areaLayersPaperLayer=null;this.areaLayerIcon="<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 32 32\"><path d=\"M 16 5.9375 L 15.625 6.0625 L 5.625 10.0625 L 3.3125 11 L 5.625 11.9375 L 9.53125 13.5 L 5.625 15.0625 L 3.3125 16 L 5.625 16.9375 L 9.53125 18.5 L 5.625 20.0625 L 3.3125 21 L 5.625 21.9375 L 15.625 25.9375 L 16 26.0625 L 16.375 25.9375 L 26.375 21.9375 L 28.6875 21 L 26.375 20.0625 L 22.46875 18.5 L 26.375 16.9375 L 28.6875 16 L 26.375 15.0625 L 22.46875 13.5 L 26.375 11.9375 L 28.6875 11 L 26.375 10.0625 L 16.375 6.0625 Z M 16 8.09375 L 23.28125 11 L 16 13.90625 L 8.71875 11 Z M 12.25 14.59375 L 15.625 15.9375 L 16 16.0625 L 16.375 15.9375 L 19.75 14.59375 L 23.28125 16 L 16 18.90625 L 8.71875 16 Z M 12.25 19.59375 L 15.625 20.9375 L 16 21.0625 L 16.375 20.9375 L 19.75 19.59375 L 23.28125 21 L 16 23.90625 L 8.71875 21 Z\"/></svg>";this.areaLayerArrowIcon="<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 32 32\"><path d=\"M 4.21875 10.78125 L 2.78125 12.21875 L 15.28125 24.71875 L 16 25.40625 L 16.71875 24.71875 L 29.21875 12.21875 L 27.78125 10.78125 L 16 22.5625 Z\"/></svg>";return this;};MPlaza.Customizer.prototype={debounce:function(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(function(){timeout=null;if(!immediate)func.apply(context,args);},wait);if(callNow)func.apply(context,args);};},throttle:function(func,limit){var inThrottle;return function(){var args=arguments;var context=this;if(!inThrottle){func.apply(context,args);inThrottle=true;setTimeout(function(){return inThrottle=false;},limit);}};},createCanvas:function(){this.canvas=document.createElement('canvas');this.canvas.setAttribute("id",this.canvasID);this.context=this.canvas.getContext('2d');this.setupCanvas();if(!this.isViewer){this.setupTouchEvents();this.setupTool();this.showSelectionBounds();}// Set the quality after Paper setup because it seems to be overwritten
this.updateCanvasImageQuality();return this.canvas;},updateCanvasImageQuality:function(){this.context.imageSmoothingQuality="high";this.context.imageSmoothingEnabled=true;},setupCanvas:function(){var ad=this;if(!this.isViewer)$(this.canvas).mousewheel(function(e){//ad.onMouseWheel(e) 
});var options={preventDefault:true};this.paper.setup(this.canvas);// HACK: Do not select the children of layers, or else
// the layers of selected objects will become selected
// after importJSON().
this.paper.Layer.inject({_selectChildren:false});this.paper.view.draw();//Start the rotation animation
var that=this;this.paper.view.onFrame=function(event){that.loadingCircles.forEach(function(x){x.rotate(3);});};},appendViewMatrix:function(values){var matrix=new this.paper.Matrix(values);// test
//matrix = matrix.scale(0.5);
this.paper.view.matrix.append(matrix);},translateView:function(dx,dy){var matrix=new this.paper.Matrix();matrix=matrix.translate(dx,dy);this.paper.view.matrix.append(matrix);},rotateView:function(angle,centerX,centerY){var matrix=new this.paper.Matrix();if(centerX!==undefined&&centerX!==null&&centerY!==undefined&&centerY!==null)matrix=matrix.rotate(angle,centerX,centerY);else matrix=matrix.rotate(angle);this.paper.view.matrix.append(matrix);},scaleView:function(hor,ver,centerX,centerY){var matrix=new this.paper.Matrix();if(centerX!==undefined&&centerX!==null&&centerY!==undefined&&centerY!==null)matrix=matrix.scale(hor,ver,centerX,centerY);else matrix=matrix.scale(hor,ver);this.paper.view.matrix.append(matrix);},getIdentityMatrixValues:function(){var matrix=new this.paper.Matrix();return matrix.values;},getTranslatedMatrixValues:function(matrixValues,dx,dy){var matrix=new this.paper.Matrix(matrixValues);matrix=matrix.translate(dx,dy);return matrix.values;},getRotatedMatrixValues:function(matrixValues,angle,centerX,centerY){var matrix=new this.paper.Matrix(matrixValues);if(centerX!==undefined&&centerX!==null&&centerY!==undefined&&centerY!==null)matrix=matrix.rotate(angle,centerX,centerY);else matrix=matrix.rotate(angle);return matrix.values;},getScaledMatrixValues:function(matrixValues,hor,ver,centerX,centerY){var matrix=new this.paper.Matrix(matrixValues);if(centerX!==undefined&&centerX!==null&&centerY!==undefined&&centerY!==null)matrix=matrix.scale(hor,ver,centerX,centerY);else matrix=matrix.scale(hor,ver);return matrix.values;},setupTouchEvents:function(){var customizer=this;var myOptions={};//this.canvas.ontouchstart = function (e) { customizer.onTouchStart(e); };
//this.canvas.ontouchend = function (e) { customizer.onTouchEnd(e); };
var mc=new Hammer.Manager(this.canvas);mc.add(new Hammer.Pan({threshold:5,pointers:0}));mc.add(new Hammer.Tap({event:'doubletap',taps:2,threshold:100,posThreshold:1000}));mc.add(new Hammer.Pinch());mc.on("panstart panmove panend pan",function(event){customizer.onPan(event);});mc.on("doubletap",function(event){customizer.onDoubleTap(event);});mc.on("pinchstart pinch",function(event){customizer.onPinch(event);});},setupTool:function(){this.tool=new this.paper.Tool();var customizer=this;this.tool.on({mousedown:function(event){customizer.onMouseDown(event);},mousemove:function(event){customizer.onMouseMove(event);},//mousedrag: function (event) {
//    customizer.onMouseDrag(event);
//},
mouseup:function(event){customizer.onMouseUp(event);},keydown:function(event){customizer.onKeyDown(event);},keyup:function(event){customizer.onKeyUp(event);}});this.tool.minDistance=1;this.tool.activate();},createDOMElement:function(){this.domElement=document.createElement('div');this.domElement.setAttribute("id","mp-canvas-customizer-div_"+MPlaza.makeID(5));this.domElement.appendChild(this.canvas);this.domElement.style.position="relative";},appendTo:function(element){element.appendChild(this.domElement);// Senza la doppia chiamata al resize si hanno dei problemi su mobile
// In particolare gli eventi vengono catturati ad una frequenza molto bassa
this.resize(element.offsetWidth,element.offsetHeight);this.resize(element.offsetWidth,element.offsetHeight);this.moveOriginToViewCenter();if(!this.isViewer)this.setupZoomControl();var viewer=this;$(window).resize(function(){viewer.resize(element.offsetWidth,element.offsetHeight);setTimeout(viewer.resize(element.offsetWidth,element.offsetHeight),200);});// var that = this;
$(window).on("orientationchange",function(){//viewer.resize(element.offsetWidth, element.offsetHeight);
//viewer.fitToScreen(true);
//viewer.paper.view.update(false);
setTimeout(function(){element.offsetHeight;viewer.paper.view.center=new paper.Point(0,0);viewer.paper.view.update(false);viewer.fitToScreen(false,true);},200);//viewer.resize(element.offsetWidth, element.offsetHeight);
//setTimeout(
//    function () {
//        //$('.Landscape').css({
//        //    'height': window.innerHeight,
//        //    'width': window.innerWidth
//        //});
//        // that.paper.view.center = new paper.Point(0, 0);
//        // that.paper.view.update(false);
//        viewer.fitToScreen(true);
//    }, 500);
});},resize:function(width,height){if(!width)width=this.domElement.offsetWidth;if(!height)height=this.domElement.offsetHeight;//this.canvas.width = this.domElement.offsetWidth;
//this.canvas.height = height;
// When we open ClipArt, UploadImage or MyImages the window height change and the resize
// is triggered, so the view is re-centered and is weird to see.
//this.moveOriginToViewCenter();
//if (!this.isViewer) {
//    this.setZoomControlPosition();
//    this.setMoveControlPosition();
//}
if(!this.isMobile){this.fitToScreen(false,true);}this.paper.view.viewSize=[width,height];this.paper.view.zoom=this.paper.view.zoom;// forzo il ridisegno
this.checkAllAlertItems();},moveOriginToViewCenter:function(){this.paper.view.center=new this.paper.Point(0,0);},setupZoomControl:function(){if($('body').find('#mp-canvas-zoomControl').attr('id')!='mp-canvas-zoomControl'){$('<div id="mp-canvas-zoomControl" class="olControlZoom" unselectable="on"> '+' <a class="olControlZoomOut olButton" id="mp-canvas-zoomout" href="#zoomOut">'+' <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAMAAADW3miqAAABklBMVEVkZGT///9kZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGSZMFejAAAAhXRSTlMAAAECBAUGBwgKCwwNDg8QERITFRYXGRocICEiIyQlJykqLC0uMDM1Njc5Oj0+QEFCRUhKTE1OT1BRUlNUVVZYWltdX2BiY2RnaWprbG9wcnN0dXd5ent8f4CCg4WGh4uMjo+RkpOUlZaXmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKzHueo5wAAAfZJREFUeAGF0PtTElEYxvGXTQVrUYmyC5WlGZpd0sKETLBE7VKkoFnSpSgrKlRAAkFY2Kf/u3fB4ZxDzfb9bWc+8+w7hw5z+oKJrdzej2TUr2sk5eCoWffF1SoOa3yecv8L9UVqkKonh/5G3jiszOJOJt/S2audaCABrv7+4bXhS/6ZtRy4wpiKXA+slZ93vdSsy/8SXPq0jI6MGmxSI9ROX7KG12Skr7P5NuKQ6n0KoOSX0DCAyh3+ENGJFE8lJDQPNDZ1FXVPAfg6KNAmD82RisiTAfLXBdoBtq8QkdY2GtHROHAQEagK89NZot7fIiLXAlB7LJAJ8yO/iVtBznnAeCZQBebWOaIedWmJlx4JlAayE52HH3sFlO8LtA5UFzrRqQKwOy7QNGCmBlVknYSULpDvwJpSkHZhFzCekECuZQD5SZLyvgGQ80lIO58FkA20iXYmCR5fJAlR1yS4cvxyi3jC3wE0NkhB5IqAMwtvo4Hb4XimBgu9uzkmI1ZzBqzqRq1ugjM+pE1jL6Qg6hr/YkL0a1EPAyjekxGnh1Kl1n/K27Eh6pkGtz+rIM45Ovt843UieuMkcX0r4CohTUUd6astJZCNCtoicq+0lC2i/hdNNWOLyNPc2g92k13Hm6oUJXsVs1CA7BuIoTjRQ/+pf/mWw/EHz+jJTaZSlbAAAAAASUVORK5CYII="> '+' </a> '+'  <a class="olControlZoomIn olButton" id="mp-canvas-zoomin" href="#zoomIn">'+'  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAMAAADW3miqAAABklBMVEVkZGT///9kZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGRkZGSZMFejAAAAhXRSTlMAAAECBAUGBwgKCwwNDg8QERITFRYXGRocICEiIyQlJykqLC0uMDM1Njc5Oj0+QEFCRUhKTE1OT1BRUlNUVVZYWltdX2BiY2RnaWprbG9wcnN0dXd5ent8f4CCg4WGh4uMjo+RkpOUlZaXmZqbnJ2en6ChoqOkpaanqKmqq6ytrq+wsbKzHueo5wAAAftJREFUeAGF0PtXEk0cx/Ev+3DBp0Ulyi5UlmZodkkLEzLBErVLkYJmSZeirKhQAQkEYWE//N/N7nqYGeps799mz+t8ds7QUZ5gJL1d3P+RSYRUhYQcLDJzXVxr4Kj252nf31B/vAmhVmb4TxRIwUiv7OZLli5c7UWDabBa7x9eG7kUml0vglUel5H3gbHy826AzJyhl2DlTovovzGNmewodVOXjeF1EakbzHwbdQj1PQVQDQloBED9jnXodDrmtxNZNpUW0ALQ3lJl5JoG8HWIoy02NE8yIn8eKF3naBfYucIOShcpRP+ngMM4Rw3on84S9XV4RN5FoPmYIx36R/YmPgl5FgDtGUd16NvniNzy0jJbesRRDihM9l782Cugdp+jDaCx2ItOlYG9CY5mAD07JCPjSsiqHAUPjSkJKRf2AO0JceRdAVCaIqHAGwDFoICU8wUAhXCXKGcyYONLJCByToFVS122iD/2HUB7kyRE3jhYevltInw7lso3YaB3N8dFxNS8BqOW1mzpYGkfcrq2H5UQOSe+6OD9WlJjACr3RMRSo9mq9Z/aTnKY3DNgHcxJiOUZm3u++TqduHGSWP2rYNWjiox6UtcsZYO4itgi8q1ayhbRwAtTzdoi8ptbBxEX2XXcVNUE2aukgcJk32ASlUk3/aOBlVsOx29IL9WtgmuD+QAAAABJRU5ErkJggg=="> '+'  </a> '+'  <a class="olControl3D olButton" id="mp-canvas-show3d" href="#show3d">'+'  <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACQAAAAkCAQAAABLCVATAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAJ1SURBVHjapNZBiFZVFADg848zDTnhWItQx9oIYWiU2bgIyUVERdAiazMYldlOg0hIBwLpgzBHsGGIqGB0FxS5ys3gIBIUFAONLWoWQzWLSENplTqO/2nha3xv/t9G3s/ZXO6774N3zj333RDLxkEL5nznhD0eXfo0i4jbgLqMysU45fW6UAgjJSpN2VkXCkcK5E/zUhpzRz0oHJZmbLDNhJTOGqgHhbeKZDcMS+lHa+tB5RiyIJ22olMovKQpjXUOhf1SerZzKExK03o6h7a6Ig3dGlqp313FuGGVfv2lmXJ8JZ3WaId0O+CSlD62Rljtd39L6brPbV+y+mmpaWMr0/CZNOMDZ6VpK/VakCYc942UXq6s7/Wr9FordL/0mwEhTEnPCPOa1gsNL7gmbS43rePSJ63QKk/aVIy/lIaEq5o2FHPvSx9WoHeluf87PHa45II1elzVtLGYf/xGwUvQZofsvRVz0kXpL4PC3RXoYenCzfot12vHnDMrjVihrwI9Ip1vB73pkAfbYg0/SM8XOfoPekKavnEWVaE/pHdKr9/nFduK8T7pvSXJPiaNtTtqx6VPS9Bj0i/uEcIp6dWi/ANCj11Seqgd9IY0e7MKup2UfnbUGWnG6sUNecL3stgQbaBNUnqqsleHXZTmjbq30iL/GF/87BaoyxnpiyWJvlO/vpam7WstSbn8u6TLrb++24sy1OMnabJzKDwnpbc7h8JHUtOLnUPdJqVr1dLWgcI656Q0rCGEQfvrQWF9cQJOGPSAWelwPSj0GpPSFeeLK8ORelAIO01VrjAjdaEQdvu6RI3qqguFsMVu4741Z8GB5aF/BwBgaLXGzqeljgAAAABJRU5ErkJggg=="> '+'  </a> '+'</div>').appendTo('#zoomPanel');}var customizer=this;this.setZoomControlPosition();},setZoomControlPosition:function(){// Control position
var canvasOffset=$("#"+this.canvasID).offset();var cx=canvasOffset.left;var cy=canvasOffset.top;var cw=$("#"+this.canvasID).width();var ch=$("#"+this.canvasID).height();var zcw=$('#mp-canvas-zoomControl').width();var zch=$('#mp-canvas-zoomControl').height();var x=cx+cw-zcw-10;var y=cy+ch-zch-10;//$('#mp-canvas-zoomControl').css("display", "");
//  $('#mp-canvas-zoomControl').css({ top: y, left: x, position: 'absolute' });
},setupMoveControl:function(){if($('body').find('#mp-canvas-moveControl').attr('id')!='mp-canvas-moveControl'){$('<div id="mp-canvas-moveControl" class="olControlMove" style="position: absolute; z-index: 1003;" unselectable="on">   '+'  <div id="mp-canvas-moveVerticalControl" class="olControlMoveVertical"> '+'    <a class="olControlMoveUp olButton" id="mp-canvas-moveup" href="#moveUp">&#708;</a> '+'    <a class="olControlMoveDown olButton" id="mp-canvas-movedown" href="#moveDown">&#709;</a> '+'  </div>'+'  <div id="mp-canvas-moveHorizontalControl" class="olControlMoveHorizontal"> '+'    <a class="olControlMoveLeft olButton" id="mp-canvas-moveleft" href="#moveLeft">&#706;</a> '+'    <a class="olControlMoveRight olButton" id="mp-canvas-moveright" href="#moveRight">&#707;</a> '+'  </div>'+'</div>').appendTo('body');}var customizer=this;$('#mp-canvas-moveup').click(function(e){customizer.moveSelectionUp();});$('#mp-canvas-movedown').click(function(e){customizer.moveSelectionDown();});$('#mp-canvas-moveleft').click(function(e){customizer.moveSelectionLeft();});$('#mp-canvas-moveright').click(function(e){customizer.moveSelectionRight();});this.setMoveControlPosition();},setMoveControlPosition:function(){// Control position
var canvasOffset=$("#"+this.canvasID).offset();var cx=canvasOffset.left;var cy=canvasOffset.top;var cw=$("#"+this.canvasID).width();var ch=$("#"+this.canvasID).height();var zcw=$('#mp-canvas-moveControl').width();var zch=$('#mp-canvas-moveControl').height();var x=cx+ +10;var y=cy+ch-zch-100;$('#mp-canvas-moveControl').css({top:y,left:x,position:'absolute'});},setCustomizedMessages:function(messages){var self=this;messages.forEach(function(x){self.customizedMessages.push(x);});},setShowDashedEdge:function(state){this.showDashedEdge=state;},setShowSelectedElementDimensions:function(state){this.showSelectedElementDimensions=state;},setShowUnselectedElementsDimensions:function(state){this.showUnselectedElementsDimensions=state;},setShowTotalSizeOfCurrentSide:function(state){this.showTotalSizeOfCurrentSide=state;},setUnitOfMeasurement:function(state){this.unitOfMeasurement=state;},setDashedEdgeColor:function(color){this.DashedEdgeColor=color;},// -------------------------------------------------------------
// Events 
// -------------------------------------------------------------
// Selection Changed
fireSelectionChangedEvent:function(e){for(var i=0;i<this.selectionChangedListeners.length;++i){this.selectionChangedListeners[i](e);}// Check if at last one item is selected
var designItems=this.design.getSideDesignItems(this.side);if(designItems){for(i=0;i<designItems.length;i++){var item=this.findItemForDesignItem(designItems[i]);if(item&&item.data.selected){this.showAreaItems();break;}}}},fireDeselectionChangedEvent:function(e){for(var i=0;i<this.deselectionChangedListeners.length;++i){this.deselectionChangedListeners[i](e);}},// Item removed
fireItemRemovedEvent:function(e){for(var i=0;i<this.itemRemovedListeners.length;++i){this.itemRemovedListeners[i](e);}},fireDesignItemRemovingEvent:function(designItem,item){for(var i=0;i<this.designItemRemovingListeners.length;++i){this.designItemRemovingListeners[i](designItem,item);}},fireItemChangedEvent:function(e){for(var i=0;i<this.itemChangedListeners.length;i++){this.itemChangedListeners[i](e);}},fireDesignItemChangedEvent:function(e){for(var i=0;i<this.designItemChangedListeners.length;i++){this.designItemChangedListeners[i](e);}},fireItemCreatedEvent:function(e){for(var i=0;i<this.itemCreatedListeners.length;i++){this.itemCreatedListeners[i](e);}},fireImageLoadedEvent:function(e){for(var i=0;i<this.imageLoadedListeners.length;i++){this.imageLoadedListeners[i](e);}},fireTextArtLoadedEvent:function(e){for(var i=0;i<this.textArtLoadedListeners.length;i++){this.textArtLoadedListeners[i](e);}},fireShapeLoadedEvent:function(e){for(var i=0;i<this.shapeLoadedListeners.length;i++){this.shapeLoadedListeners[i](e);}},fireGridImageSelectedEvent:function(e){for(var i=0;i<this.gridImageSelectedListeners.length;i++){this.gridImageSelectedListeners[i](e);}},// Notification events
fireNotifyMessageEvent:function(id,messageType,title,message,canBeClosed,onClick,onClose,data){for(var i=0;i<this.notifyMessageListeners.length;i++){this.notifyMessageListeners[i](id,messageType,title,message,canBeClosed,onClick,onClose,data);}},fireRemoveMessageEvent:function(id){for(var i=0;i<this.removeMessageListeners.length;i++){this.removeMessageListeners[i](id);}},fireUndoChangedEvent:function(){for(var i=0;i<this.undoChangedListeners.length;i++){this.undoChangedListeners[i]();}},fireRedoChangedEvent:function(){for(var i=0;i<this.redoChangedListeners.length;i++){this.redoChangedListeners[i]();}},fireFillShapeRequestedEvent:function(e){for(var i=0;i<this.fillShapeRequestedListeners.length;i++){this.fillShapeRequestedListeners[i](e);}},addSelectionChangedListener:function(listenerFunction){this.selectionChangedListeners.push(listenerFunction);},addDeselectionListener:function(listenerFunction){this.deselectionChangedListeners.push(listenerFunction);},addItemRemovedListener:function(listenerFunction){this.itemRemovedListeners.push(listenerFunction);},addDesignItemRemovingListener:function(listenerFunction){this.designItemRemovingListeners.push(listenerFunction);},addItemChangedListener:function(listenerFunction){this.itemChangedListeners.push(listenerFunction);},addItemCreatedListener:function(listenerFunction){this.itemCreatedListeners.push(listenerFunction);},addImageLoadedListener:function(listenerFunction){this.imageLoadedListeners.push(listenerFunction);},addTextArtLoadedListener:function(listenerFunction){this.textArtLoadedListeners.push(listenerFunction);},addShapeLoadedListener:function(listenerFunction){this.shapeLoadedListeners.push(listenerFunction);},addGridImageSelectedListener:function(listenerFunction){this.gridImageSelectedListeners.push(listenerFunction);},addNotifyMessageListeners:function(listenerFunction){this.notifyMessageListeners.push(listenerFunction);},addRemoveMessageListeners:function(listenerFunction){this.removeMessageListeners.push(listenerFunction);},addDesignItemChangedListener:function(listenerFunction){this.designItemChangedListeners.push(listenerFunction);},addUndoChangedListener:function(listenerFunction){this.undoChangedListeners.push(listenerFunction);},addRedoChangedListener:function(listenerFunction){this.redoChangedListeners.push(listenerFunction);},addFillShapeRequestedListener:function(listenerFunction){this.fillShapeRequestedListeners.push(listenerFunction);},// -------------------------------------------------------------
getScreenPoint:function(canvasPoint){var point=this.paper.view.projectToView(canvasPoint);var offset=$("#"+this.canvasID).offset();point.x+=offset.left;point.y+=offset.top;return point;},onMouseWheel:function(event){var itemsBounds=this.getAllItemsBounds();var viewBounds=this.paper.project.view.bounds;if(this.zooming||itemsBounds==null)return;/*
        var allInBefore = viewBounds.contains(itemsBounds);

        if (event.deltaY < 0 && this.areAllItemsInView())
            return;
        */event.preventDefault();var zoomFactor=1.3;var mousePosition=new this.paper.Point(event.offsetX,event.offsetY);mousePosition=this.paper.project.view.viewToProject(mousePosition);var zoomCenter=mousePosition.subtract(this.paper.view.center);var moveFactor=zoomFactor-1.0;if(event.deltaY>0){if(this.paper.view.zoom<4){this.paper.view.zoom*=zoomFactor;this.paper.view.center=this.paper.view.center.add(zoomCenter.multiply(moveFactor/zoomFactor));// Fisso al centro
}}else if(event.deltaY<0){if(itemsBounds.width<viewBounds.width&&itemsBounds.height<viewBounds.height)return;this.paper.view.zoom/=zoomFactor;this.paper.view.center=this.paper.view.center.subtract(zoomCenter.multiply(moveFactor));// Fisso al centro
}this.hitItem=null;this.updateSelectionState();this.paper.project.view.update();// Update alert items
this.checkAllAlertItems();this.checkImagesSizeLimit();//viewBounds = paper.project.view.bounds;
/*
        var allInNow = viewBounds.contains(itemsBounds);
        if (!allInBefore && allInNow)
            this.fitToScreen();
        */ // this.updateZoomIndicators(); TODO
//this.activateMagnifiedModel(mousePosition);
},// Converte da coordinate di schermo a coordinate relative al canvas
windowToCanvas:function(x,y){var bbox=this.canvas.getBoundingClientRect();return{x:x-bbox.left*($(this.canvas).width()/bbox.width),y:y-bbox.top*($(this.canvas).height()/bbox.height)};},clearCanvas:function(){for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];layer.removeChildren();}this.paper.project.view.update();},// -------------------------------------------------------------
// Zoom Model
// -------------------------------------------------------------
// Returns bounding box of all items.
getAllAreasBounds:function(){var _this_1=this;var bounds=null;if(this.side){this.side.get("areas").forEach(function(area){var areaItem=_this_1.findItemForArea(area);if(areaItem){if(!bounds)bounds=areaItem.bounds.clone();else bounds=bounds.unite(areaItem.bounds);}});}return bounds;},getAllItemsBounds:function(itemsList){if(itemsList===void 0){itemsList=[];}var bounds=null;var items=itemsList.length>0?itemsList:this.getAllItems();for(var i=0;i<items.length;i++){var itemBounds=this.getItemBounds(items[i]);if(!itemBounds||isNaN(itemBounds.width)||isNaN(itemBounds.height))continue;if(bounds==null)bounds=itemBounds.clone();else bounds=bounds.unite(itemBounds);}return bounds;},getAllItems:function(paperProject,paperMasterGroup){if(paperProject===void 0){paperProject=this.paper.project;}if(paperMasterGroup===void 0){paperMasterGroup=this.masterGroup;}var items=[];var customizer=this;function addChildren(item){if(customizer.isItemGroup(item)&&item!=paperMasterGroup)return;if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide)items.push(child);addChildren(child);}}}for(var i=0,l=paperProject.layers.length;i<l;i++){var layer=paperProject.layers[i];if(!layer.guide)addChildren(layer);}return items;},getAllShapeItems:function(){var shapeItems=[];var items=this.getAllItems();for(var i=0;i<items.length;i++){var item=items[i];if(this.isFilledShape(item)||this.isShape(item))shapeItems.push(item);}return shapeItems;},getAllShapeImagePlaceholders:function(){var placeholders=[];var shapeItems=this.getAllShapeItems();for(var i=0;i<shapeItems.length;i++){var item=shapeItems[i];if(!this.isFilledShape(item)&&this.isShape(item)&&item.data&&item.data.isImagePlaceholder)placeholders.push(item);}return placeholders;},getAllMaskedImages:function(){var _this_1=this;return this.getAllItems().filter(function(i){return _this_1.isMaskedImage(i);});},getAllFilledShapes:function(){var _this_1=this;return this.getAllItems().filter(function(i){return _this_1.isFilledShape(i);});},getAllSimpleImages:function(){var _this_1=this;return this.getAllItems().filter(function(i){return i instanceof _this_1.paper.Raster&&!_this_1.isMaskedImage(i)&&!_this_1.isFilledShape(i);});},getAllShapesAndMasks:function(){var shapes=[];var items=this.getAllItems();for(var i=0;i<items.length;i++){var item=items[i];if(this.isShape(item))shapes.push(item);else if(this.isMaskedImage(item))shapes.push(this.getMaskedImageShapeItem(item));}return shapes;},zoomIn:function(){var _this_1=this;if(this.paper.view.zoom>=2)return;this.preventViewMoving=false;var zoomFactor=1.3;this.paper.view.zoom*=zoomFactor;this.updateZoomIndicators();this.updateSelectionState();this.clampView();this.checkAllAlertItems();this.checkImagesSizeLimit();this.placeHandleOut();this.getAllShapeImagePlaceholders().forEach(function(x){return _this_1.updateShapeImagePlaceholder(x);});this.updateAreaLayerNamesSizes();},zoomOut:function(){var _this_1=this;var itemsBounds=this.getAllItemsBounds();var viewBounds=this.paper.project.view.bounds;if(itemsBounds&&itemsBounds.width<viewBounds.width-100&&itemsBounds.height<viewBounds.height-100)return;this.preventViewMoving=false;var zoomFactor=1.3;this.paper.view.zoom/=zoomFactor;this.updateZoomIndicators();this.updateSelectionState();this.clampView();this.checkAllAlertItems();this.checkImagesSizeLimit();this.getAllShapeImagePlaceholders().forEach(function(x){return _this_1.updateShapeImagePlaceholder(x);});this.updateAreaLayerNamesSizes();},setZoom:function(val){this.animatedZoom(this.paper.view.zoom,val/100,this.paper.view.center,this.paper.view.center,30);this.clampView();this.checkAllAlertItems();this.checkImagesSizeLimit();this.updateAreaLayerNamesSizes();},zoomToBounds:function(bounds,marginPerc,useAnimation,zoomIn){var _this_1=this;if(!bounds||bounds.width==0||bounds.height==0)return;var animated=true;if(useAnimation===false)animated=false;var targetBounds=bounds.clone();var factor=1;if(marginPerc>0){factor=1+marginPerc/100;}targetBounds.width*=factor;targetBounds.height*=factor;var viewBounds=this.paper.view.bounds;if(targetBounds.width>viewBounds.width||targetBounds.height>viewBounds.height||zoomIn){var sx=1.0;var sy=1.0;if(Math.abs(viewBounds.width)>0.0000001)sx=viewBounds.width/targetBounds.width;if(Math.abs(viewBounds.height)>0.0000001)sy=viewBounds.height/targetBounds.height;var s=Math.min(sx,sy);var steps=15;var zoomFrom=this.paper.view.zoom;var zoomTo=this.paper.view.zoom*s;var deltaZoom=(zoomTo-zoomFrom)/steps;var centerFrom=this.paper.view.center;var centerTo=bounds.center;if(animated)this.animatedZoom(zoomFrom,zoomTo,centerFrom,centerTo,steps);else{this.paper.view.zoom=zoomTo;this.paper.view.center=centerTo;}this.preventViewMoving=true;this.clampView();this.checkAllAlertItems();this.checkImagesSizeLimit();// Update shapes placeholder icon size
this.getAllShapeImagePlaceholders().forEach(function(x){return _this_1.updateShapeImagePlaceholder(x);});}},updateRasterLayer:function(){var bounds=this.getAllItemsBounds();if(this.rasterLayer==null){this.rasterLayer=this.findItemByName("rasterLayer");}if(!this.rasterLayer){this.rasterLayer=new this.paper.Layer();this.rasterLayer.name="rasterLayer";this.rasterLayer.insertAbove(this.paper.project.layers[1]);this.rasterLayer.guide=true;}else{this.rasterLayer.removeChildren();this.paper.project.view.update();}var maxSize=Math.max(bounds.width,bounds.height);var res=96;if(maxSize>2000)res=72;this.rasterLayer.activate();var raster1=this.paper.project.layers[0].rasterize(res,false);var raster2=this.paper.project.layers[1].rasterize(res,false);this.rasterLayer.addChild(raster1);this.rasterLayer.addChild(raster2);},toDataURL:function(){return this.canvas.toDataURL();},getDesignDataUrl:function(){var raster=this.paper.project.layers[1].rasterize(96,false);var dataUrl=raster.toDataURL();return dataUrl;},showRasterLayer:function(){if(this.rasterLayer==null)this.updateRasterLayer();for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer!=this.rasterLayer){layer.visible=false;}}this.rasterLayer.visible=true;this.paper.project.view.update();},hideRasterLayer:function(){for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer!=this.rasterLayer){layer.visible=true;layer.activate();}}this.rasterLayer.visible=false;this.paper.project.view.update();},setImageScalingEnabled:function(enabled){this.isImageScalingEnabled=enabled;},animatedZoom:function(zoomFrom,zoomTo,centerFrom,centerTo,steps){if(this.zooming)return;this.zooming=true;var customizer=this;if(steps<=0)return;var deltaZoom=(zoomTo-zoomFrom)/steps;var vector=centerTo.subtract(centerFrom);var deltaCenter=vector.clone();deltaCenter=deltaCenter.divide(steps);//this.updateRasterLayer();
//this.showRasterLayer();
var step=0;var timer=setInterval(function(){var dz=step==steps-1?zoomTo-customizer.paper.view.zoom:deltaZoom;var dc=step==steps-1?centerTo.subtract(customizer.paper.view.center):deltaCenter;customizer.paper.view.zoom+=dz;customizer.paper.view.center=customizer.paper.view.center.add(dc);customizer.updateZoomIndicators();if(step==steps-1){//customizer.hideRasterLayer();
//customizer.drawMap();
}step++;if(step==steps){clearInterval(timer);customizer.zooming=false;customizer.clampView();customizer.checkAllAlertItems();customizer.checkImagesSizeLimit();customizer.updateSelectionState();customizer.updateAreaLayerNamesSizes();// Update shapes placeholder icon size
customizer.getAllShapeImagePlaceholders().forEach(function(x){return customizer.updateShapeImagePlaceholder(x);});}},30);},fitToScreen:function(useAnimation,zoomIn){var itemsBounds=this.getAllItemsBounds();if(itemsBounds){var margin=this.fitToScreenMargin;// If the area bounds is large as the side image then add more margin to the zoom. (Pixobloom ticket);
if(this.imageItem&&this.isMobile){// In configuratore we don't have the image item
var ratioX=itemsBounds.width/this.imageItem.bounds.width;var ratioY=itemsBounds.height/this.imageItem.bounds.height;var ratio=Math.max(ratioX,ratioY);// If the ratio is at least of 0.8, the margin can go from 20 to 40
if(ratio>=0.8){var ratioDelta=Math.min(ratio,1)-0.8;margin=ratioDelta*100+20;}}this.zoomToBounds(itemsBounds,margin,useAnimation,zoomIn);this.paper.view.update();}},fitToScreenForPreview:function(){if(this.imageItem){var areasBounds=this.getAllAreasBounds();var sideImageBound=this.imageItem.bounds;var itemsBounds=this.getAllItemsBounds();if(areasBounds&&sideImageBound){itemsBounds=areasBounds.area>sideImageBound.area?areasBounds:sideImageBound;}if(itemsBounds){var margin=this.fitToScreenMargin;// If the area bounds is large as the side image then add more margin to the zoom. (Pixobloom ticket);
if(this.isMobile){var ratioX=itemsBounds.width/this.imageItem.bounds.width;var ratioY=itemsBounds.height/this.imageItem.bounds.height;var ratio=Math.max(ratioX,ratioY);// If the ratio is at least of 0.8, the margin can go from 20 to 40
if(ratio>=0.8){var ratioDelta=Math.min(ratio,1)-0.8;margin=ratioDelta*100+20;}}this.zoomToBounds(itemsBounds,margin,false,true);this.paper.view.update();}}},updateZoomIndicators:function(){},areAllItemsInView:function(){var itemsBounds=this.getAllItemsBounds();var viewBounds=this.paper.project.view.bounds;return viewBounds.contains(itemsBounds);},// -------------------------------------------------------------
// Items functions
// -------------------------------------------------------------
setElementType:function(elementType){if(elementType==MPlaza.CustomizerElementType.None||elementType==MPlaza.CustomizerElementType.Rectangle||elementType==MPlaza.CustomizerElementType.Oval||elementType==MPlaza.CustomizerElementType.Path||elementType==MPlaza.CustomizerElementType.Free||elementType==MPlaza.CustomizerElementType.Text||elementType==MPlaza.CustomizerElementType.TextArt)this.elementType=elementType;},/*
    createGridBoxIcon: async function() {
        return new Promise(resolve => {
            var item = new this.paper.Raster({
                crossOrigin: "anonymous",
                source: Zakeke.config.baseUrl + "/images/other/camera_image_grids.png",
                onMouseEnter: () => this.paper.project.view.element.style.setProperty('cursor', 'pointer'),
                onMouseLeave: () => this.paper.project.view.element.style.setProperty('cursor', null)
            });

            item.onLoad = () => {
                item.onLoad = undefined;
                resolve(item);
            }
        });
    },
    */setSide:function(side){return __awaiter(this,void 0,void 0,function(){var _this_1=this;return __generator(this,function(_a){switch(_a.label){case 0:this.removeAllAlertItems();this.clearCanvas();this.resetUndoRedo();// qui si potrebbe pensare di raggruppare gli stack undo/redo per lato
this.imageItem=null;//reset and clean dimension labels
this.resetAllDimensionLabels();this.side=side;return[4/*yield*/,new Promise(function(resolve){return _this_1.updateImageItem(resolve);})];case 1:_a.sent();// Re-create the master group
this.masterGroup=new this.paper.Group();this.paper.project.layers[1].addChild(this.masterGroup);// Creo il layer per i layers delle aree
if(!this.areaLayersPaperLayer){this.areaLayersPaperLayer=new this.paper.Layer();this.areaLayersPaperLayer.bringToFront();this.areaLayersPaperLayer.data.isAreaLayersLayer=true;}this.updateAreaItems();return[4/*yield*/,this.updateDesignItemsCanvasItems()];case 2:_a.sent();return[4/*yield*/,this.updateGrids()];case 3:_a.sent();return[2/*return*/];}});});},setSide_old:function(side,callback){this.removeAllAlertItems();this.clearCanvas();this.resetUndoRedo();// qui si potrebbe pensare di raggruppare gli stack undo/redo per lato
this.masterGroup=null;this.imageItem=null;this.side=side;var customizer=this;this.updateImageItem(function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:// Re-create the master group
customizer.masterGroup=new this.paper.Group();customizer.paper.project.layers[1].addChild(customizer.masterGroup);return[4/*yield*/,customizer.rebuildItems()];case 1:_a.sent();if(callback)callback();return[2/*return*/];}});});});},getCurrentModel:function(){var _model=null;if(this.side&&this.side instanceof MPlaza.Side){var color=this.side.getParentModel();if(color&&color instanceof MPlaza.Color){var model=color.getParentModel();if(model&&model instanceof MPlaza.Model){_model=model;}}}if(!_model)_model=this.model;return _model;},refresh:_.debounce(function(settings,callback){var customizer=this;this.updateImageItem(function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4/*yield*/,customizer.rebuildItems()];case 1:_a.sent();if(callback)callback();return[2/*return*/];}});});},settings);},100),rebuildItems:function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:// Clear master group
if(this.masterGroup){Array.from(this.masterGroup.children).forEach(function(x){return x.remove();});}else{// Re-create the master group
this.masterGroup=new this.paper.Group();this.paper.project.layers[1].addChild(this.masterGroup);}// Clear masks
paper.project.activeLayer.children.filter(function(x){return x.isMaskPath;}).forEach(function(x){return x.remove();});this.updateAreaItems();return[4/*yield*/,this.updateDesignItemsCanvasItems()];case 1:_a.sent();return[4/*yield*/,this.updateGrids()];case 2:_a.sent();return[2/*return*/];}});});},setDesign:function(design){this.deselectAll();// todo
this.clearDesignItemsCanvasItems();this.resetUndoRedo();this.design=design;//Since this will be called in the setSide too, it is better to do this there to avoid problems like images loading before areas (this will make the blue mask always visible even if an item is completely in an area)
//this.updateDesignItemsCanvasItems();
this.checkAllAlertItems();this.checkImagesSizeLimit();var customizer=this;if(this.isViewer){//this.design.addEventListener("change", function () { customizer.refreshDesign(); })
}},refreshDesign:function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){switch(_a.label){case 0:return[4/*yield*/,this.updateDesignItemsCanvasItems()];case 1:_a.sent();return[4/*yield*/,this.updateGrids()];case 2:_a.sent();return[2/*return*/];}});});},setupImageLayer:function(){if(!this.imageLayer){// Creo layer inferiore (dello sfondo)
this.imageLayer=new this.paper.Layer({name:'image-backLayer'});this.imageLayer.sendToBack();// Creo layer superiore (delle immagini e testo)
var defaultLayer=new this.paper.Layer({name:'image-frontLayer'});defaultLayer.bringToFront();defaultLayer.activate();}},// Aggiorna l'immagine di sfondo del modello
// Nel caso in cui debba essere applicato un colore di sfondo, utilizza CamanJS
// per la sovrapposizione del colore (very cool)
updateImageItem:function(callback,settings){//if (this.imageItem)
//    this.imageItem.remove();
if(!this.showSideImage||!this.side||!this.side.get("imageUrl")){if(this.imageItem)this.imageItem.remove();if(settings&&settings.boundsToAreas){this.adaptZoomToSideAreas(false);}else{this.fitToScreen(false,true);}if(callback)callback();return;}var designSide=null;if(this.design){designSide=this.design.getDesignSide(this.side);}var customizer=this;var replaceImageItem=function(newImageItem,callback){if(customizer.imageItem)customizer.imageItem.remove();customizer.imageItem=newImageItem;//customizer.imageItem.sendToBack();
// Assegno la nuova immagine al layer di sfondo
customizer.imageLayer.addChild(newImageItem);customizer.paper.project.view.update();customizer.fitToScreen(false,true);callback();};if(!this.side.get("colorable")||!designSide||!designSide.get("fillColor")){if(!customizer.imageLayer){// Creo layer inferiore (dello sfondo)
customizer.imageLayer=new customizer.paper.Layer();customizer.imageLayer.sendToBack();// Creo layer superiore (delle immagini e testo)
var defaultLayer=new customizer.paper.Layer();defaultLayer.bringToFront();defaultLayer.activate();}// Non bisogna sovrapporre un colore all'immagine
var newImageItem=new this.paper.Raster({crossOrigin:"anonymous",source:this.side.get("imageUrl"),position:new this.paper.Point(0,0)});newImageItem.onLoad=function(){replaceImageItem(newImageItem,function(){if(callback)callback();});return;};}else{// Ricoloro l'immagine
var fillColor='#'+designSide.get("fillColor");// Creo un canvas offscreen delle dimensioni dell'immagine
var offscreenCanvasID="customizerOffscreen";var offscreenCanvas=document.createElement('canvas');offscreenCanvas.setAttribute("id",offscreenCanvasID);var offscreenContext=offscreenCanvas.getContext('2d');offscreenCanvas.width=customizer.imageWidth;offscreenCanvas.height=customizer.imageHeight;if(this.domElement)this.domElement.appendChild(offscreenCanvas);// Utilizzo CamanJS per sovrapporre il colore di sfondo all'immagine
Caman("#"+offscreenCanvasID,this.side.get("imageUrl"),function(){this.newLayer(function(){this.setBlendingMode("multiply");this.opacity(100);this.fillColor(fillColor);});this.render(function(){// Costruisco l'immagine copiando i bit dal canvas offscreen
var imageData=offscreenContext.getImageData(0,0,offscreenCanvas.width,offscreenCanvas.height);var newImageItem=new customizer.paper.Raster({position:customizer.paper.view.center});newImageItem.setSize(new customizer.paper.Size(customizer.imageWidth,customizer.imageHeight));newImageItem.setImageData(imageData,new customizer.paper.Point(0,0));replaceImageItem(newImageItem,function(){if(customizer.domElement)customizer.domElement.removeChild(offscreenCanvas);if(callback)callback();});return;});});}},updateAreaItems:function(){if(this.side&&this.side instanceof MPlaza.Side){var areas=this.side.get("areas");if(areas){for(var i=0;i<areas.length;i++){var area=areas.at(i);this.createItemForArea(area);}var paths=[];var pathsToRemove=[];// Find all paths
for(i=0;i<areas.length;i++){var area=areas.at(i);var path=this.paper.project.activeLayer.importJSON(area.get("path"));if(path instanceof this.paper.CompoundPath){for(var j=0;j<path.children.length;j++){paths.push(path.children[j]);// TODO: Check multi level nested areas / compunds
}// Remove parent compund path
pathsToRemove.push(path);}else paths.push(path);}// Set them as not selected and remove any guid reference
paths.forEach(function(path){path.data=undefined;});// Create the final compound path
var clip=new this.paper.CompoundPath({children:paths});clip.isClippingArea=true;clip.data=undefined;this.masterGroup.addChild(clip);// Must be after addChild
clip.sendToBack();clip.fillRule="nonzero";clip.clipMask=true;clip.reorient(false,true);pathsToRemove.forEach(function(path){path.remove();});}}this.deselectAll();this.paper.project.view.update();},createItemForArea:function(area){if(area&&area instanceof MPlaza.Area){// Remove area
var item=this.findItemForArea(area);if(item)item.remove();// Create area
item=this.paper.project.activeLayer.importJSON(area.get("path"));item.data.guid=area.get("guid");item.data.isArea=true;item.data.selected=true;this.masterGroup.addChild(item);if(this.isViewer)item.visible=false;this.updateAreaItemColor(item);this.createAreaLayersItemsForArea(area,item);}},createAreaLayersItemsForArea:function(area,areaItem){var _this_1=this;// Remove old layers
this.getAllItems().filter(function(x){return x.data.connectedAreaGuid==area.get('guid');}).forEach(function(x){return x.remove();});// Create new layers
var index=0;area.get('layers').each(function(layer){var isCanvas=!_this_1.isViewer;var isViewerOnly=_this_1.isViewer&&!_this_1.isCartPreview;var isCartPreview=_this_1.isViewer&&_this_1.isCartPreview;if(isViewerOnly)return;// Layer should be visible in canvas if isVisible in canvas
// or in cart preview if isVisibleInCart
if(isCanvas&&layer.get('isVisibleInCanvas')||isCartPreview&&layer.get('isVisibleInCart')){var item=_this_1.areaLayersPaperLayer.importJSON(layer.get('json'));item.data.connectedAreaGuid=area.get('guid');item.data.layerID=layer.get('layerID');item.data.isAreaLayer=true;if(layer.get('showLabel')&&isCanvas)_this_1.createAreaLayerName(area,areaItem,layer,item,index++);}});this.updateAreaLayerNamesSizes();},createAreaLayerName:function(area,areaItem,layer,layerItem,index){var _this_1=this;var _a;var paths=this.getAreaLayerPaths(layerItem);var tipWidth=150;var tipHeight=26;var padding=10;if(paths.length===0)return;var color=(_a=paths[0].strokeColor.toCSS(true))!==null&&_a!==void 0?_a:'#000000';var group=new this.paper.Group({onMouseEnter:function(){return _this_1.paper.project.view.element.style.setProperty('cursor',layer.get('description')!=''?'pointer':'default');},onMouseLeave:function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);}});group.data.connectedAreaGuid=area.get('guid');group.data.layerID=layer.get('layerID');group.data.isAreaLayerName=true;group.data.isOpened=false;group.data.layerIndex=index;this.areaLayersPaperLayer.addChild(group);var center=new this.paper.Point(0,0);var clipItem=new this.paper.Path.Rectangle(new this.paper.Rectangle(0,0,tipWidth,tipHeight));clipItem.position=center;clipItem.isClipMask=true;var rectItem=new this.paper.Path.Rectangle(new this.paper.Rectangle(0,0,tipWidth,tipHeight));rectItem.position=center;rectItem.fillColor='#FFFFFF';rectItem.strokeColor='#EEEEEE';var nameItem=new this.paper.PointText(new this.paper.Point(0,0));nameItem.content=layer.get('displayName');nameItem.fillColor=color;nameItem.fontSize=16;nameItem.position=rectItem.position;var descriptionItem=new this.paper.PointText(new this.paper.Point(0,20));descriptionItem.content=this.simpleWordWrap(layer.get('description'),25);descriptionItem.fillColor='#555';descriptionItem.visible=false;descriptionItem.justify='left';descriptionItem.position=rectItem.position.add(new this.paper.Point(0-tipWidth/2+descriptionItem.bounds.width/2+padding,15+descriptionItem.bounds.height/2+padding));var descriptionItemHeight=descriptionItem.bounds.height;var layerIconItemSVG=this.paper.project.activeLayer.importSVG(this.areaLayerIcon);var layerIconItem=layerIconItemSVG.children[1];layerIconItem.position=new this.paper.Point(-tipWidth/2+20,0);layerIconItem.scale(0.7);layerIconItem.fillColor=color;group.addChild(clipItem);group.addChild(rectItem);group.addChild(nameItem);group.addChild(descriptionItem);group.addChild(layerIconItem);layerIconItemSVG.remove();group.clipped=true;if(layer.get('description')!=''){var layerArrowIconItemSVG=this.paper.project.activeLayer.importSVG(this.areaLayerArrowIcon);var layerArrowIconItem=layerArrowIconItemSVG.children[1];layerArrowIconItem.position=new this.paper.Point(tipWidth/2-20,0);layerArrowIconItem.scale(0.4);layerArrowIconItem.fillColor=color;group.addChild(layerArrowIconItem);layerArrowIconItemSVG.remove();group.onClick=function(){var height=(group.data.isOpened?tipHeight:15+descriptionItemHeight+padding*2)/_this_1.paper.view.zoom;var scale=height/rectItem.bounds.height;rectItem.scale(new _this_1.paper.Point(1,scale),group.bounds.topCenter);clipItem.scale(new _this_1.paper.Point(1,scale),group.bounds.topCenter);group.data.isOpened=!group.data.isOpened;descriptionItem.visible=group.data.isOpened;};}},updateAreaLayerNamesSizes:function(index){var _this_1=this;this.areaLayersPaperLayer.children.filter(function(x){return x.data.isAreaLayerName;}).forEach(function(x){var index=x.data.layerIndex;var width=140/_this_1.paper.view.zoom;var scale=width/x.bounds.width;var layerItem=_this_1.areaLayersPaperLayer.children.find(function(j){return j.data.layerID==x.data.layerID;});x.scale(scale,scale);if(layerItem){var paths=_this_1.getAreaLayerPaths(layerItem);if(paths.length>0){var bounds=new _this_1.paper.Rectangle(paths[0].bounds);for(var _i=0,paths_1=paths;_i<paths_1.length;_i++){var path=paths_1[_i];bounds=bounds.unite(path.bounds);}// Position round-robin to avoid stacks
var positions=[bounds.bottomCenter,bounds.rightCenter,bounds.topCenter,bounds.leftCenter];var factorX=[0,1,0,-1];var factorY=[1,0,-1,0];x.position=positions[index%positions.length].add(new _this_1.paper.Point(x.bounds.width/2*factorX[index%positions.length],x.bounds.height/2*factorY[index%positions.length]));}}});},getAreaLayerPaths:function(layerItem){var _this_1=this;var items=[];var findItem=function(parent){if(parent instanceof _this_1.paper.CompoundPath&&parent.strokeColor){items.push(parent);return;}if(parent.children){for(var _i=0,_a=parent.children;_i<_a.length;_i++){var child=_a[_i];findItem(child);}}};findItem(layerItem);return items;},simpleWordWrap:function(txt,max){var lines=[];var space=-1;var times=0;function cut(){for(var i=0;i<txt.length;i++){txt[i]==' '&&(space=i);if(i>=max){(space==-1||txt[i]==' ')&&(space=i);if(space>0){lines.push(txt.slice(txt[0]==' '?1:0,space));}txt=txt.slice(txt[0]==' '?space+1:space);space=-1;break;}}check();}function check(){if(txt.length<=max){lines.push(txt[0]==' '?txt.slice(1):txt);txt='';}else if(txt.length){cut();}return;}check();return this.content=lines.join('\n');},hideAreaItems:function(){// If there is no side image, don't hide the areas
if(!this.showSideImage)return;var areas=this.getAllAreaItems();for(var i=0;i<areas.length;i++){var area=areas[i];area.visible=false;}this.updateSelectionState();this.paper.project.view.update();},showAreaItems:function(){var areas=this.getAllAreaItems();for(var i=0;i<areas.length;i++){var area=areas[i];area.visible=true;area.strokeWidth=2;}this.updateSelectionState();this.paper.project.view.update();},adaptZoomToSideAreas:function(animate){if(animate===void 0){animate=true;}var bounds=this.getAllAreasBounds();this.zoomToBounds(bounds,this.fitToScreenMargin,animate,true);this.updateSelectionState();this.paper.project.view.update();},updateAreaItemsColor:function(){var items=this.getAllAreaItems();for(var i=0;i<items.length;i++){var item=items[i];this.updateAreaItemColor(item);}this.paper.project.view.update();},updateAreaItemColor:function(item){if(item&&item.bounds){item.strokeColor=this.getContrastedColor(item.bounds);}},getAllAreaItems:function(){var items=[];function addChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide&&child.data&&child.data.guid&&child.data.isArea)items.push(child);addChildren(child);}}}for(var i=0,l=this.paper.project.layers.length;i<l;i++){var layer=this.paper.project.layers[i];if(!layer.guide)addChildren(layer);}return items;},getAreasIntersectingItem:function(item){var _this_1=this;var areas=[];if(item&&item.data&&item.data.guid&&!item.data.isArea&&this.side&&this.side instanceof MPlaza.Side&&this.side.get("areas")){var tempItem=item;if(item.realBounds)tempItem=new this.paper.Path.Rectangle(item.realBounds);for(var i=0;i<this.side.get("areas").length;i++){var area=this.side.get("areas").at(i);var areaItem=this.findItemForArea(area);var areaPaths=[];if(area&&areaItem){if(areaItem instanceof this.paper.CompoundPath&&areaItem.children&&areaItem.children.length>0)areaPaths=__spreadArrays(areaItem.children);else areaPaths=[areaItem];if(areaPaths.some(function(areaPath){return tempItem.bounds.intersects(areaPath.bounds)&&(!item.data.isImageForBackground&&!item.data.isAreaForBackground||area.get("guid")===item.data.areaGuid)&&(!item.data.isGridImage||item.data.isGridImage&&_this_1.design.get("areasGrids")&&_this_1.design.get("areasGrids").find(function(x){return x.get("sideID")==_this_1.side.id&&x.get("areaID")==area.id;}));})){areas.push(area);}}}if(item.realBounds)tempItem.remove();}return areas;},getAreasContainingItem:function(item){var _this_1=this;var areas=[];if(item&&item.data&&item.data.guid&&!item.data.isArea&&this.side&&this.side instanceof MPlaza.Side&&this.side.get("areas")){var tempItem=item;if(item.realBounds)tempItem=new this.paper.Path.Rectangle(item.realBounds);for(var i=0;i<this.side.get("areas").length;i++){var area=this.side.get("areas").at(i);var areaItem=this.findItemForArea(area);var areaPaths=[];if(area&&areaItem){if(areaItem instanceof this.paper.CompoundPath&&areaItem.children&&areaItem.children.length>0)areaPaths=__spreadArrays(areaItem.children);else areaPaths=[areaItem];if(areaPaths.some(function(areaPath){return!tempItem.bounds.intersects(areaPath.bounds)&&areaPath.bounds.contains(tempItem.bounds)&&areaPath.contains(tempItem.position)&&(!item.data.isImageForBackground&&!item.data.isAreaForBackground||area.get("guid")===item.data.areaGuid)&&(!item.data.isGridImage||item.data.isGridImage&&_this_1.design.get("areasGrids")&&_this_1.design.get("areasGrids").find(function(x){return x.get("sideID")==_this_1.side.id&&x.get("areaID")==area.id;}));})){areas.push(area);}}}if(item.realBounds)tempItem.remove();}return areas;},getAreasIntersectingOrContainingItem:function(item){var _this_1=this;var areas=[];if(item&&item.data&&item.data.guid&&!item.data.isArea&&this.side&&this.side instanceof MPlaza.Side&&this.side.get("areas")){var tempItem=item;if(item.realBounds)tempItem=new this.paper.Path.Rectangle(item.realBounds);for(var i=0;i<this.side.get("areas").length;i++){var area=this.side.get("areas").at(i);var areaItem=this.findItemForArea(area);var areaPaths=[];if(area&&areaItem){if(areaItem instanceof this.paper.CompoundPath&&areaItem.children&&areaItem.children.length>0)areaPaths=__spreadArrays(areaItem.children);else areaPaths=[areaItem];if(areaPaths.some(function(areaPath){return(tempItem.bounds.intersects(areaPath.bounds)||tempItem.bounds.contains(areaPath.bounds)||areaPath.bounds.contains(tempItem.bounds)||areaPath.contains(tempItem.position))&&(!item.data.isImageForBackground&&!item.data.isAreaForBackground||area.get("guid")===item.data.areaGuid)&&(!item.data.isGridImage||item.data.isGridImage&&_this_1.design.get("areasGrids")&&_this_1.design.get("areasGrids").find(function(x){return x.get("sideID")==_this_1.side.id&&x.get("areaID")==area.id;}));})){areas.push(area);}}}if(item.realBounds)tempItem.remove();}return areas;},getItemArea:function(item){var area=null;var areas=this.getAreasIntersectingOrContainingItem(item);if(areas.length>1||areas.length==0)return null;return areas[0];},clearDesignItemsCanvasItems:function(){var _this=this;_this.removeAllAlertItems();function removeChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];removeChildren(child);if(child.data&&child.data.maskPath)child.data.maskPath.remove();if(child.data&&child.data.maskAlertPath)child.data.maskAlertPath.remove();if(!child.guide&&child.data&&child.data.guid&&!child.data.isArea||child.data.isDashedEdge)child.remove();}}}for(var i=0,l=this.paper.project.layers.length;i<l;i++){var layer=this.paper.project.layers[i];if(!layer.guide)removeChildren(layer);}},updateDesignItemsCanvasItems:function(){return __awaiter(this,void 0,void 0,function(){var designItems,i,designItem,item;return __generator(this,function(_a){switch(_a.label){case 0:this.clearDesignItemsCanvasItems();if(!(this.side&&this.side instanceof MPlaza.Side&&this.design&&this.design instanceof MPlaza.Design))return[3/*break*/,4];designItems=this.design.getSideDesignItems(this.side).sort(function(a,b){return a.get('index')>b.get('index');});if(!designItems)return[3/*break*/,4];i=0;_a.label=1;case 1:if(!(i<designItems.length))return[3/*break*/,4];designItem=designItems[i];return[4/*yield*/,this.createItemForDesignItem(designItem)];case 2:item=_a.sent();item.data.selected=false;_a.label=3;case 3:i++;return[3/*break*/,1];case 4:this.deselectAll();this.paper.project.view.update();return[2/*return*/];}});});},createItemForDesignItem:function(designItem){return __awaiter(this,void 0,void 0,function(){var item,imageItem,areaItem,groupAreaBackground,newChildren,childrenToRemove,_i,_a,child,_b,childrenToRemove_1,child,constraints;return __generator(this,function(_c){switch(_c.label){case 0:item=null;if(!(designItem&&designItem instanceof MPlaza.DesignItem))return[3/*break*/,2];item=this.findItemForDesignItem(designItem);if(item){item.remove();if(item.data.maskPath)item.data.maskPath.remove();if(item.data.dashedEdgeID>0)this.removeDashedEdgeForItem(item);}return[4/*yield*/,this.getOrCreateItemFromDesignItem(designItem)];case 1:// design effect application
//item = this.paper.project.activeLayer.importJSON(json);
//item.data.guid = designItem.get("itemGuid");
item=_c.sent();imageItem=this.getMaskedImageRasterItem(item);if(imageItem&&imageItem instanceof this.paper.Raster&&!(imageItem.data&&imageItem.data.originalBounds&&imageItem.data.originalMatrix)){imageItem.data.originalBounds=new this.paper.Rectangle(0,0,imageItem.width,imageItem.height);imageItem.data.originalMatrix=imageItem.matrix.clone();}// --------------------------------
// Check if item is a background image, in this case re-create background group with item
if(item.data&&(item.data.isImageForBackground||item.data.isAreaForBackground)){areaItem=this.findItemByGuid(item.data.areaGuid);if(areaItem){groupAreaBackground=this.getOrCreateBackgroundGroupItem(areaItem);groupAreaBackground.addChild(item);this.masterGroup.addChild(groupAreaBackground);groupAreaBackground.sendToBack();}}else{this.masterGroup.addChild(item);this.updateShapeImagePlaceholder(item);}if(this.getItemIsTextArea(item)&&item.children){newChildren=[];childrenToRemove=[];for(_i=0,_a=item.children;_i<_a.length;_i++){child=_a[_i];if(child instanceof this.paper.PointText&&(child.content==""||child.content=="⠀"))childrenToRemove.push(child);else newChildren.push(child);}for(_b=0,childrenToRemove_1=childrenToRemove;_b<childrenToRemove_1.length;_b++){child=childrenToRemove_1[_b];child.remove();}if(childrenToRemove.length>0){item.children=newChildren;this.onItemUpdated(item);}}constraints=designItem.get("constraints");if(this.isViewer&&constraints&&!constraints.get("isPrintable"))item.visible=false;// Create the mask rectangle, wait to load for rasters
if(item instanceof this.paper.Raster){if(this.getAllItems().find(function(x){return x==item;})){this.paper.project.view.update();this.createMaskForItem(item);this.createDashedEdgeForItem(item);this.checkAlertItems(item);this.fireItemCreatedEvent(item);this.fireImageLoadedEvent(item);}}else{this.createMaskForItem(item);this.createDashedEdgeForItem(item);this.checkAlertItems(item);this.fireItemCreatedEvent(item);}_c.label=2;case 2:return[2/*return*/,item];}});});},findAreaByGuid:function(guid){if(this.side&&this.side instanceof MPlaza.Side&&this.side.get("areas")){return this.side.get("areas").getArea(guid);}return null;},findItemByGuid:function(guid,paperScope){if(paperScope===void 0){paperScope=null;}paperScope=paperScope||this.paper;var upperGuid=guid.toUpperCase();var findChildByGuid=function(parent,guid){if(parent.data.guid&&parent.data.guid.toUpperCase()==guid){return parent;}if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];var item=findChildByGuid(child,guid);if(item){return item;}}}};for(var i=0;i<paperScope.project.layers.length;i++){var layer=paperScope.project.layers[i];if(layer.guide)continue;var item=findChildByGuid(layer,upperGuid);if(item){return item;}}return null;},getChildrens:function(item){var items=[];var getChilds=function(parent){items=__spreadArrays(items,[parent]);if(parent.children){for(var _i=0,_a=parent.children;_i<_a.length;_i++){var child=_a[_i];getChilds(child);}}};getChilds(item);return items;},removeItemByGuid:function(guid){var item=this.findItemByGuid(guid);item.remove();this.onItemRemoved(item);},findItemForArea:function(area){if(area&&area instanceof MPlaza.Area){return this.findItemByGuid(area.get("guid"));}return null;},findDesignItemByGuid:function(guid){var di=null;if(this.design){di=this.design.get("designItems").getDesignItemByGuid(guid);}return di;},findDesignItemForItem:function(item){if(item&&item.data&&item.data.guid){return this.findDesignItemByGuid(item.data.guid);}return null;},findItemForDesignItem:function(designItem){var item=null;if(designItem&&designItem instanceof MPlaza.DesignItem){return this.findItemByGuid(designItem.get("itemGuid"));}},snapDeltaToAngle:function(delta,snapAngle){var snap=180/Math.PI*snapAngle;var angle=delta.angle;angle=Math.round(angle/snap)*snap;var newDelta=delta.clone();newDelta.angle=angle;return newDelta;},onItemsCreated:function(items){for(var i=0;i<items.length;i++){this.onItemCreated(items[i],null);}},onItemCreated:function(item,image){var designItem=this.createDesignItem(item,image);this.updateItemsIndexes();this.checkAllAlertItems();if(!this.isViewer){this.checkImagesSizeLimit();}this.registerItemOperation("create",designItem.get("itemGuid"),null,designItem.clone());return designItem;},onTextArtItemCreated:function(item,options){var designItem=this.createTextArtDesignItem(item,options);this.updateItemsIndexes();this.checkAllAlertItems();if(!this.isViewer){this.checkImagesSizeLimit();}this.registerItemOperation("create",designItem.get("itemGuid"),null,designItem.clone());return designItem;},onShapeItemCreated:function(item,shape,options){var designItem=this.createShapeDesignItem(item,shape,options);this.updateItemsIndexes();this.checkAllAlertItems();this.updateShapeImagePlaceholder(item);if(!this.isViewer){this.checkImagesSizeLimit();}this.registerItemOperation("create",designItem.get("itemGuid"),null,designItem.clone());return designItem;},onItemsUpdated:function(items){for(var i=0;i<items.length;i++){this.onItemUpdated(items[i]);}},onItemUpdated:function(item){var realBounds=this.getItemRealBounds(item);item.realBounds=realBounds;var oldDesignItem=null;var newDesignItem=null;var designItem=this.findDesignItemForItem(item);if(designItem)oldDesignItem=designItem.clone();this.checkAlertItems(item);this.checkImagesSizeLimit();this.updateTransformsData(item);this.updateDesignItem(item);this.updateDesignItemAreasAndIndex(item);this.fireItemChangedEvent(item);this.updateShapeImagePlaceholder(item);designItem=this.findDesignItemForItem(item);if(designItem)newDesignItem=designItem.clone();if(oldDesignItem&&newDesignItem)this.registerItemOperation("update",item.data.guid,oldDesignItem,newDesignItem);// Test real bounds
//this.drawRealBounds(item);
},onImageItemUpdated:function(item,image,maskShape){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){var oldDesignItem=designItem.clone();this.updateImageDesignItem(item,designItem,image,maskShape);this.checkAlertItems(item);this.checkImagesSizeLimit();this.updateTransformsData(item);this.updateDesignItem(item);this.fireItemChangedEvent(item);designItem=this.findDesignItemByGuid(item.data.guid);var newDesignItem=designItem.clone();if(oldDesignItem&&newDesignItem)this.registerItemOperation("update",item.data.guid,oldDesignItem,newDesignItem);}},onTextArtItemUpdated:function(item,options){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){var oldDesignItem=designItem.clone();this.updateTextArtDesignItem(item,designItem,options);this.fireItemChangedEvent(item);this.updateTransformsData(item);designItem=this.findDesignItemByGuid(item.data.guid);var newDesignItem=designItem.clone();if(oldDesignItem&&newDesignItem)this.registerItemOperation("update",item.data.guid,oldDesignItem,newDesignItem);}},onShapeItemUpdated:function(item,shape,image){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){var oldDesignItem=designItem.clone();this.updateShapeDesignItem(item,designItem,shape,image);this.fireItemChangedEvent(item);this.updateTransformsData(item);this.updateShapeImagePlaceholder(item);designItem=this.findDesignItemByGuid(item.data.guid);var newDesignItem=designItem.clone();if(oldDesignItem&&newDesignItem)this.registerItemOperation("update",item.data.guid,oldDesignItem,newDesignItem);}},onDesignItemChanged:function(item){var designItem=this.findDesignItemForItem(item);if(designItem){this.fireDesignItemChangedEvent(designItem);}},onItemsRemoved:function(items){for(var i=0;i<items.length;i++){this.onItemRemoved(items[i]);}},onItemRemoved:function(item){var designItem=this.findDesignItemByGuid(item.data.guid);//if (designItem) {
//    this.registerItemOperation("delete", item.data.guid, designItem.clone(), null);
//}
this._onItemRemovedInternal(item);if(designItem){this.registerItemOperation("delete",item.data.guid,designItem.clone(),null);}},_onItemRemovedInternal:function(item){this.removeAlertItems(item);this.checkImagesSizeLimit();this.removeTextOnPathGuide(item);this.removeTextOnPathHandles(item);this.removeTextAreaGuide(item);this.removeTextAreaHandles(item);this.removeDesignItem(item);//Check if design item has been correctly removed
if(this.findDesignItemByGuid(item.data.guid)){console.trace("Item removed, but the design item is still present.",item,this.findDesignItemByGuid(item.data.guid));throw"There was an error during item deletion";}this.fireItemRemovedEvent(item);// Remove mask path MUST BE AFTER EVENT FIRE or item selection will re-add it!!
if(item.data.maskPath)item.data.maskPath.remove();if(item.data.dashedEdgeID>0){this.removeDashedEdgeForItem(item);}// Remove mask alert path
if(item.data.maskAlertPath)item.data.maskAlertPath.remove();},getSerializedPaperItem:function(item){var guideRaster=this.getMaskedImageGuideRasterItem(item);var guideRasterId=null;var guideShape=this.getMaskedImageGuideShapeItem(item);var guideShapeId=null;if(guideRaster){guideRasterId=guideRaster.id;guideRaster.remove();}if(guideShape){guideShapeId=guideShape.id;guideShape.remove();}var serialization={json:item.exportJSON({asString:true}),svg:item.exportSVG({asString:true,embedImages:false})};if(guideRaster){var newGuideRaster=this.createMaskedImageGuideRaster(item);if(newGuideRaster&&guideRasterId)newGuideRaster._id=guideRasterId;}if(guideShape){var newGuideShape=this.createMaskedImageGuideShape(item);if(newGuideShape&&guideShapeId)newGuideShape._id=guideShapeId;}return serialization;},createDesignItem:function(item,image){if(item&&!item.guide){var designItem=null;if(item.data.guid){designItem=this.findDesignItemByGuid(item.data.guid);}if(designItem==null){designItem=new MPlaza.DesignItem();item.data.guid=designItem.get("itemGuid");this.design.get("designItems").add(designItem);}if(designItem!=null){designItem.set("index",item.index);var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);if(image&&image instanceof MPlaza.Image){designItem.set("imageID",image.get("imageID"));designItem.set("imageType",image.get("type"));designItem.set("imageFormat",image.get("format"));designItem.set("imageWidth",image.get("width"));designItem.set("imageHeight",image.get("height"));designItem.set("imageDpiX",image.get("dpiX"));designItem.set("imageDpiY",image.get("dpiY"));designItem.set("imageUserID",image.get("userID"));designItem.set("imageVisitorID",image.get("visitorID"));designItem.set("imagePrice",image.get("price"));designItem.set("applyImagePriceForQuantity",image.get("applyPriceForQuantity"));designItem.set("providerImageID",image.get("providerImageID"));designItem.set("imageIsMulticolor",image.get("isMulticolor"));designItem.set("imagePreferredWidth",image.get("preferredWidth"));designItem.set("imagePreferredHeight",image.get("preferredHeight"));designItem.set("imageFileSize",image.get("imageFileSize"));designItem.set("imageCustomerID",image.get("customerID"));// salvo l'array di colori distinti (nel caso di immagine vettoriale)
if(image.get("type")=="Vector"&&image.get("colors")&&image.get("colors").length>0){for(var i=0;i<image.get("colors").length;i++){designItem.get("itemColors").push(image.get("colors").at(i).get("code"));}}}else{this.updateDesignItemDistinctColors(designItem,item);}if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}}return designItem;}return null;},createTextArtDesignItem:function(item,options){if(item&&!item.guide&&options){var designItem=null;if(item.data.guid){designItem=this.findDesignItemByGuid(item.data.guid);}if(designItem==null){designItem=new MPlaza.DesignItem();item.data.guid=designItem.get("itemGuid");this.design.get("designItems").add(designItem);}if(designItem!=null){designItem.set("index",item.index);var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);var textArt=new MPlaza.DesignItemTextArt();textArt.set("text",options.text);textArt.set("fontFamilyID",options.fontFamilyID);textArt.set("fontFaceID",options.fontFaceID);textArt.set("textArtTypeID",options.textArtTypeID);var config=new MPlaza.TextArtConfig(options.config);textArt.set("config",config);designItem.set("textArt",textArt);if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}}return designItem;}return null;},createShapeDesignItem:function(item,shape,options){if(item&&!item.guide&&options&&shape&&shape instanceof MPlaza.Shape){var designItem=null;if(item.data.guid){designItem=this.findDesignItemByGuid(item.data.guid);}if(designItem==null){designItem=new MPlaza.DesignItem();item.data.guid=designItem.get("itemGuid");this.design.get("designItems").add(designItem);}if(designItem!=null){designItem.set("index",item.index);var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);var designItemShape=new MPlaza.DesignItemShape();designItemShape.set("shapeID",shape.get("shapeID"));designItemShape.set("isMask",false);designItem.set("shape",designItemShape);if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}}return designItem;}return null;},updateTransformsData:function(item){if(item&&item.data&&(item.data.guid||item.data.isTextOnPath||item.data.isTextArea)&&!item.data.isArea){var originalDimensions=null;if(!item.data.transformsData||!item.data.transformsData.dimensions||item.data.needsTransformsDataUpdate){var clone=item.clone();clone.visible=false;clone.rotate(0-clone.rotation);//var rect = new this.paper.Path.Rectangle(clone.bounds);
var rect=new this.paper.Path.Rectangle(this.getItemBounds(clone));rect.visible=false;originalDimensions={width:rect.bounds.width,height:rect.bounds.height};rect.remove();clone.remove();}else{originalDimensions=item.data.transformsData.dimensions;}item.data.transformsData={position:{x:item.position.x,y:item.position.y},rotation:item.rotation,dimensions:originalDimensions};}},updateDesignItem:function(item){if(item&&item.data&&item.data.guid&&!item.data.isArea){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){// This is used in configurator because
// non-printable items are not visibile in
// 3d viewer, but they will update the designItem 
// and it will disapper from the customizer editor too.
// this will prevent this, so all items will be always visible 
// except for 3d viewer.
var oldVisible=item.visible;item.visible=true;designItem.set("index",item.index);var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);item.visible=oldVisible;// Se non si tratta di un'immagine aggiorno i colori
// Nel caso di immagine, l'aggiornamento dei colori avviene solo 
// nel cambio colori
this.updateDesignItemDistinctColors(designItem,item);}}},updateDesignItemDistinctColors:function(designItem,item){var codes=[];var raster=this.getMaskedImageRasterItem(item);var shape=this.getMaskedImageShapeItem();var colorMappings=designItem.get('colorMappings');if(colorMappings&&colorMappings.length>0){// Recolored element with global reduce colors
for(var i=0;i<colorMappings.length;i++){var mapping=colorMappings.at(i);// Check null (removed) colors
if(mapping.get('dest')&&codes.indexOf(mapping.get('dest'))===-1)codes.push(mapping.get('dest'));}this.updateDesignItemColors(designItem,codes);}else if(!raster&&!shape||raster&&shape){var child=item;if(shape){child=shape;}else if(item.data.isTextOnPath||item.data.isTextArea){child=null;if(item.children.length>0){child=item.children[0];}}if(child){var strokeColor=null;if(child.strokeWidth>0&&child.strokeColor){strokeColor=child.strokeColor.toCSS(true);codes.push(strokeColor);}var fillColor=null;if(child.fillColor&&(!strokeColor||child.fillColor!=strokeColor)){fillColor=child.fillColor;codes.push(child.fillColor.toCSS(true));}var shadowColor=null;if(child.shadowColor&&(!strokeColor||child.shadowColor!=strokeColor)&&(!fillColor||child.shadowColor!=fillColor)){shadowColor=child.shadowColor;codes.push(child.shadowColor.toCSS(true));}}this.updateDesignItemColors(designItem,codes);}},updateDesignItemAreasAndIndex:function(item){if(item&&item.data&&item.data.guid&&!item.data.isArea&&!this.preventAreasAndIndexUpdate){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);// We must update the correct indexes of other items
var sideDesignItems=this.design.getSideDesignItems(this.side);for(var i=0;i<sideDesignItems.length;i++){var sideDesignItem=sideDesignItems[i];var sideItem=this.findItemForDesignItem(sideDesignItem);if(sideItem){var oldDesignItem=sideDesignItem.clone();sideDesignItem.set("index",sideItem.index);this.registerItemOperation("update",sideItem.data.guid,oldDesignItem,sideDesignItem.clone());}}}}},updateDesignItemColors:function(designItem,codes){// svuoto l'array attuale
while(designItem.get("itemColors").length>0){designItem.get("itemColors").pop();}for(var _i=0,codes_1=codes;_i<codes_1.length;_i++){var code=codes_1[_i];designItem.get("itemColors").push(code);}},updateDesignItemColorMappings:function(designItem,colorMappings){if(designItem&&designItem instanceof MPlaza.DesignItem){designItem.set("colorMappings",new MPlaza.ColorMappings());if(colorMappings){for(var i=0;i<colorMappings.length;i++){var colorMapping=new MPlaza.ColorMapping(colorMappings[i]);designItem.get("colorMappings").add(colorMapping);}}}},// Aggiorna il designItem nel caso di sostituzione dell'immagine
// per un item paper.js
updateImageDesignItem:function(item,designItem,image,maskShape){if(!this.canEditItem(item))return;var raster=this.getMaskedImageRasterItem(item);if(item&&!item.guide&&raster&&raster instanceof this.paper.Raster&&designItem&&designItem instanceof MPlaza.DesignItem&&image&&image instanceof MPlaza.Image){var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);designItem.set("imageID",image.get("imageID"));designItem.set("imageType",image.get("type"));designItem.set("imageFormat",image.get("format"));designItem.set("imageWidth",image.get("width"));designItem.set("imageHeight",image.get("height"));designItem.set("imageDpiX",image.get("dpiX"));designItem.set("imageDpiY",image.get("dpiY"));designItem.set("imageUserID",image.get("userID"));designItem.set("imageVisitorID",image.get("visitorID"));designItem.set("imagePrice",image.get("price"));designItem.set("imageIsMulticolor",image.get("isMulticolor"));designItem.set("imagePreferredWidth",image.get("preferredWidth"));designItem.set("imagePreferredHeight",image.get("preferredHeight"));designItem.set("imageFileSize",image.get("imageFileSize"));designItem.set("imageCustomerID",image.get("customerID"));designItem.set("isChanged",true);// salvo l'array di colori distinti (nel caso di immagine vettoriale)
while(designItem.get("itemColors").length>0)designItem.get("itemColors").pop();if(image.get("type")=="Vector"&&image.get("colors")&&image.get("colors").length>0){for(var i=0;i<image.get("colors").length;i++){designItem.get("itemColors").push(image.get("colors").at(i).get("code"));}}// salvo i dati dell'eventuale maschera
designItem.unset("shape");if(maskShape&&maskShape instanceof MPlaza.Shape&&maskShape.get("shapeID")!==-1&&maskShape.get("shapeID")!==undefined){var designItemShape=new MPlaza.DesignItemShape();designItemShape.set("itemID",designItem.getDesignItemID());designItemShape.set("shapeID",maskShape.get("shapeID"));designItemShape.set("isMask",true);designItem.set("shape",designItemShape);}if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}}},updateTextArtDesignItem:function(item,designItem,options){if(!this.canEditItem(item))return;if(item&&!item.guide&&(item instanceof this.paper.CompoundPath||item instanceof this.paper.Path)&&item.data&&item.data.isTextArt&&designItem&&designItem instanceof MPlaza.DesignItem&&designItem.isTextArt()&&options){var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);var textArt=designItem.get("textArt");if(textArt){textArt.set("text",options.text);textArt.set("fontFamilyID",options.fontFamilyID);textArt.set("fontFaceID",options.fontFaceID);textArt.set("textArtTypeID",options.textArtTypeID);var config=new MPlaza.TextArtConfig(options.config);textArt.set("config",config);}if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}}},updateShapeDesignItem:function(item,designItem,shape,image){if(!this.canEditItem(item))return;if(item&&!item.guide&&(item instanceof this.paper.CompoundPath||item instanceof this.paper.Path)&&item.data&&item.data.isShape&&shape&&shape instanceof MPlaza.Shape&&designItem&&designItem instanceof MPlaza.DesignItem){var serialization=this.getSerializedPaperItem(item);designItem.set("json",serialization.json);designItem.set("svg",serialization.svg);var designItemShape=designItem.get("shape");if(designItemShape){designItemShape.set("shapeID",shape.get("shapeID"));designItemShape.set("isMask",false);}if(!this.preventAreasAndIndexUpdate){var areas=this.getAreasIntersectingOrContainingItem(item);designItem.updateAreas(areas);}if(image&&image instanceof MPlaza.Image){designItem.set("imageID",image.get("imageID"));designItem.set("imageType",image.get("type"));designItem.set("imageFormat",image.get("format"));designItem.set("imageWidth",image.get("width"));designItem.set("imageHeight",image.get("height"));designItem.set("imageDpiX",image.get("dpiX"));designItem.set("imageDpiY",image.get("dpiY"));designItem.set("imageUserID",image.get("userID"));designItem.set("imageVisitorID",image.get("visitorID"));designItem.set("imagePrice",image.get("price"));designItem.set("imageIsMulticolor",image.get("isMulticolor"));designItem.set("imagePreferredWidth",image.get("preferredWidth"));designItem.set("imagePreferredHeight",image.get("preferredHeight"));designItem.set("imageFileSize",image.get("imageFileSize"));designItem.set("isChanged",true);}else{designItem.unset("imageID");designItem.unset("imageType");designItem.unset("imageFormat");designItem.unset("imageWidth");designItem.unset("imageHeight");designItem.unset("imageDpiX");designItem.unset("imageDpiY");designItem.unset("imageUserID");designItem.unset("imageVisitorID");designItem.unset("imagePrice");designItem.unset("imageIsMulticolor");designItem.unset("imagePreferredWidth");designItem.unset("imagePreferredHeight");designItem.unset("imageFileSize");designItem.unset("isChanged");}// salvo l'array di colori distinti (nel caso di immagine vettoriale)
while(designItem.get("itemColors").length>0)designItem.get("itemColors").pop();if(image&&image.get("ImageID")>0&&image.get("type")=="Vector"&&image.get("colors")&&image.get("colors").length>0){for(var i=0;i<image.get("colors").length;i++){designItem.get("itemColors").push(image.get("colors").at(i).get("code"));}}}},removeDesignItem:function(item){if(item&&item.data&&item.data.guid&&!item.data.isArea){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){this.design.get("designItems").remove(designItem);}}},checkImagesSizeLimit:function(profileLimit){var _this_1=this;if(profileLimit==undefined||isNaN(profileLimit)||profileLimit<=0)profileLimit=this.areasSizeLimit;else this.areasSizeLimit=profileLimit;this.removeSizeLimitAlert();if(this.side==null)return;var sides=this.side.collection.models;var images=this.getAllImageItems();if(!sides||!images)return;this.side.get("areas").forEach(function(area){var index=_this_1.areasSizeCountCollection.findIndex(function(x){return x.sideID==_this_1.side.get("sideID")&&x.areaID==area.get("areaID");});if(index==-1)_this_1.areasSizeCountCollection.push({sideID:_this_1.side.get("sideID"),areaID:area.get("areaID"),sizeCount:0});else if(_this_1.areasSizeCountCollection[index].sideID==_this_1.side.get("sideID"))_this_1.areasSizeCountCollection[index].sizeCount=0;});images.forEach(function(image){var designImage=_this_1.findDesignItemForItem(image);if(!designImage)return;_this_1.getAreasIntersectingOrContainingItem(image).forEach(function(area){var index=_this_1.areasSizeCountCollection.findIndex(function(x){return x.sideID==_this_1.side.get("sideID")&&x.areaID==area.get("areaID");});_this_1.areasSizeCountCollection[index].sizeCount+=designImage.get("imageFileSize");});});this.areasSizeCountCollection.filter(function(x){return x.sideID==_this_1.side.get("sideID");}).forEach(function(x){_this_1.side.get("areas").models.forEach(function(area){if(area.get("areaID")==x.areaID&&x.sizeCount>profileLimit){var message=StringHelper.format(T._("Total size of uploaded pictures must be less than {0} MB per each print-area","Customizer"),(parseInt(profileLimit)/1024/1024).toFixed(2));var customizedMessage=_this_1.customizedMessages.find(function(y){return y.EventID==MPlaza.EventMessages.UploadLimit;});if(customizedMessage){message=StringHelper.format(customizedMessage.Description);if(customizedMessage.Visible===false)return;}var areaItem_1=_this_1.findItemForArea(area);if(areaItem_1)_this_1.fireNotifyMessageEvent(area.get("guid"),2/* Error */,T._("Warning!","Customizer"),message,customizedMessage?customizedMessage.Closeable:true,function(){return _this_1.zoomToBounds(areaItem_1.bounds,_this_1.fitToScreenMargin,true,true);},null,null);}});});},removeSizeLimitAlert:function(){this.areaAlertItems.forEach(function(group){group.icon.remove();group.tooltip.remove();});this.areaAlertItems=[];},checkAlertItems:function(item){if(!item||item.data&&item.data.isImageForBackground)return;if(item.data&&(item.data.isTextArt||item.data.isTextOnPath))return;this.removeAlertItems(item);var customizedMessages=[];var that=this;//var intersectingAreas = this.getAreasIntersectingItem(item);
//var containingAreas = this.getAreasContainingItem(item);
//if (intersectingAreas.length > 0 || containingAreas.length == 0) {
//    messages = T._("The element extends beyond the print area.", "Customizer");
//}
var areas=this.getAreasIntersectingOrContainingItem(item);var clipCustomizedMessage=that.customizedMessages.filter(function(cwm){return cwm.Visible;}).find(function(cwm){return cwm.EventID==MPlaza.EventMessages.ItemsClippedWarning;});if(clipCustomizedMessage&&!this.isViewer){if(areas.length>0){areas.forEach(function(area){var areaItem=that.findItemForArea(area);var tmpRect=new that.paper.Path.Rectangle(item.bounds);if(areaItem&&areaItem.intersects(tmpRect)){customizedMessages.push(clipCustomizedMessage);}tmpRect.remove();});}else{customizedMessages.push(clipCustomizedMessage);}}var requiredWidth=1;var requiredHeight=1;for(var i=0;i<areas.length;i++){var area=areas[i];if(!this.checkItemQualityForArea(item,area)){var raster=this.getMaskedImageRasterItem(item);if(!raster)return;// Params
var designItem=this.findDesignItemForItem(item);if(designItem&&designItem.attributes&&designItem.attributes.imageFormat.toLowerCase()=="svg")break;var itemConstraints=designItem.get("constraints");if(itemConstraints&&!itemConstraints.get("isPrintable"))break;var ppcm=this.side.get("ppcm");var dpi=300;var selectedPrintType=this.getSelectedPrintType(area);if(selectedPrintType){var printTypeDPI=selectedPrintType.get("dpi");// Side print type DPI
if(selectedPrintType instanceof MPlaza.PartPrintType&&printTypeDPI&&printTypeDPI>0){dpi=printTypeDPI;}else{// If no side print type, fallback to model print type dpi and print type dpi.
selectedPrintType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(area));dpi=selectedPrintType.get('dpi')||selectedPrintType.get('printTypeDPI');}// For new printful products, we must fake the print type for check the warning
if(selectedPrintType.get('name')=="PrintfulPrintType"&&dpi>120)dpi=dpi*0.75;}else{console.warn("Can't determinate the print type DPI");}// Actual values
var cmWidth=raster.bounds.width/ppcm;// Item width in CM
var cmHeight=raster.bounds.height/ppcm;// Item height in CM
// Required values
requiredWidth=cmWidth/2.54*dpi;requiredHeight=cmHeight/2.54*dpi;var customizedMessage=that.customizedMessages.find(function(x){return x.EventID==MPlaza.EventMessages.DPIWarning;});if(customizedMessage){// Customer images uploaded
if(customizedMessage.Visible===false&&(designItem.get('imageCustomerID')>0||designItem.get('imageVisitorID')>0)&&!this.model.get("providerID"))break;// Clipart merchant images
if(customizedMessage.EnableCheckForSellerImages===false&&designItem.get('imageCustomerID')<=0&&designItem.get('imageVisitorID')<=0)break;customizedMessages.push(__assign(__assign({},customizedMessage),{Description:StringHelper.format(customizedMessage.Description,requiredWidth.toFixed(0),requiredHeight.toFixed(0))}));}else{// Create tooltip
customizedMessages.push(__assign(__assign({},customizedMessage),{Description:StringHelper.format(T._("We strongly suggest file with a higher resolution to get better results.<br/>(at least {0} x {1} pixels)","Customizer"),requiredWidth.toFixed(0),requiredHeight.toFixed(0))}));}break;}}if(customizedMessages.length>0){var designItem=this.findDesignItemForItem(item);if(designItem){for(var _i=0,customizedMessages_1=customizedMessages;_i<customizedMessages_1.length;_i++){var customizedMessage=customizedMessages_1[_i];this.fireNotifyMessageEvent(designItem.get("itemGuid"),2/* Error */,T._("Warning!","Customizer"),customizedMessage.Description,customizedMessage.Closeable?customizedMessage.Closeable:true,this.zoomToItem(item),null,{requiredWidth:requiredWidth,requiredHeight:requiredHeight});};return{itemGuid:designItem.get("itemGuid"),customizedMessages:customizedMessages};}}return;},zoomToItem:function(item){var _this_1=this;return function(){if(!item)return;_this_1.zoomToBounds(item.bounds,_this_1.fitToScreenMargin,true,true);_this_1.selectItems([item]);};},checkAllAlertItems:function(){var alertItems=[];// Update alert items
var items=this.getAllItems();for(var i=0;i<items.length;i++){var item=items[i];if(item&&item.data&&item.data.guid&&!item.data.isArea&&!item.guide/*&& item.alertItems && item.alertItems.length > 0*/){var alertItem=this.checkAlertItems(item);if(alertItem)alertItems.push(alertItem);}}return alertItems;},// just for debug
drawRealBounds:function(item){if(this.realRect)this.realRect.remove();var raster=this.getMaskedImageRasterItem(item);if(raster){var bounds=this.getItemRealBounds(item);this.realRect=new this.paper.Path.Rectangle(bounds);this.realRect.strokeColor="red";this.realRect.strokeWidth=1;}},getItemRealBounds:function(item){var raster=this.getMaskedImageRasterItem(item);if(!raster)return item.bounds;var bounds=item.bounds;var rasterized=item.rasterize(72);// Capire come impostare la giusta risoluzione
// anche per gli smartphone
try{var x0=rasterized.position.x-rasterized.width/2;var y0=rasterized.position.y-rasterized.height/2;var w=rasterized.width;var h=rasterized.height;var idata=rasterized.getImageData(),buffer=idata.data,buffer32=new Uint32Array(buffer.buffer),x,y,x1=w,y1=h,x2=0,y2=0;for(y=0;y<h;y++){// get left edge
for(x=0;x<w;x++){if(buffer32[x+y*w]>0){if(x<x1)x1=x;}}// get right edge
for(x=w;x>=0;x--){if(buffer32[x+y*w]>0){if(x>x2)x2=x;}}}for(x=0;x<w;x++){// get top edge
for(y=0;y<h;y++){if(buffer32[x+y*w]>0){if(y<y1)y1=y;}}// get bottom edge
for(y=h;y>=0;y--){if(buffer32[x+y*w]>0){if(y>y2)y2=y;}}}bounds=new this.paper.Rectangle(x0+x1,y0+y1,x2-x1,y2-y1);}catch(e){Logger.info(e.message);}finally{rasterized.remove();}return bounds;},createAlertIcon:function(point,isDark){if(!point)return null;isDark=isDark||false;var s=25/this.paper.view.zoom;//var s = 20;
var bytes=isDark?this.iconsBytes["itemAlertDark"]:this.iconsBytes["itemAlert"];var url='data:image/png;base64,'+bytes;var icon=new this.paper.Raster({source:url,position:point});var resizeIcon=function(){var originalSize=icon.size;var size=new this.paper.Size(s,s);var sx=1.0,sy=1.0;if(Math.abs(originalSize.width)>0.0000001)sx=size.width/originalSize.width;if(Math.abs(originalSize.height)>0.0000001)sy=size.height/originalSize.height;icon.scale(sx,sy);};if(icon.size.width>0&&icon.size.height>0){resizeIcon();}else{icon.onLoad=function(){resizeIcon();};}return icon;},checkSelectionAlertItems:function(){var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[0];this.checkAlertItems(item);}},removeAlertItems:function(item){if(item){this.fireRemoveMessageEvent(item.data.guid);}},removeAllAlertItems:function(){var _this_1=this;this.getAllItems().forEach(function(item){return _this_1.removeAlertItems(item);});},removeSelectionAlertItems:function(){var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[0];this.removeAlertItems(item);}},checkItemQualityForArea:function(item,area){var raster=this.getMaskedImageRasterItem(item);if(item&&raster&&item.data&&item.data.guid&&!item.data.isArea&&!item.data.isTextArt&&!item.data.isTextOnPath){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem&&designItem.get("imageType")!="Vector"){var bounds=raster.bounds;var scaleSize=this.getAreaScaleFactor(area);if(scaleSize){// MD
var isMaskedImage=this.isMaskedImage(item);// Masked image must keep multply scaling for item and internal raster, normal images only the item.
var newImageWidth=raster.size.width*(isMaskedImage?raster.scaling.x:1)*item.scaling.x;var newImageHeight=raster.size.height*(isMaskedImage?raster.scaling.y:1)*item.scaling.y;var scaledWidth=newImageWidth*scaleSize.width;var scaledHeight=newImageHeight*scaleSize.height;if(scaledWidth>designItem.get("imageWidth")+designItem.get("imageWidth")*0.10||scaledHeight>designItem.get("imageHeight")+designItem.get("imageHeight")*0.10){return false;}/*
                    var newWidth = bounds.width * scaleSize.width;
                    var newHeight = bounds.height * scaleSize.height;
                    if (newWidth > designItem.get("imageWidth") ||
                        newHeight > designItem.get("imageHeight")) {
                        return false;
                    }
                    */}}}return true;},getAreaScaleFactor:function(area){var size=new this.paper.Size(1,1);var printType=this.getSelectedPrintType(area);if(!printType||printType.get("dpi")<=0)printType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(area));var pixelSize=this.getScaledAreaPixelSize(area,printType);if(pixelSize){size.width=pixelSize.width/area.get("boundsWidth");size.height=pixelSize.height/area.get("boundsHeight");}return size;},getSelectedPrintType:function(area){var printTypeID=this.design.getSelectedPrintTypeForArea(area);var printType=null;if(area){var sideID=area.getSideID();var colorID=area.getColorID();var model=this.getCurrentModel();if(model&&sideID>0&&colorID>0){printType=model.get("colors").getColor(colorID).get("sides").getSide(sideID).get("printTypes").getPrintType(printTypeID)||model.get("printTypes").getPrintType(printTypeID);}}return printType;},getModelPrintType:function(printTypeID){var printType=null;var model=this.getCurrentModel();if(model&&this.design&&this.design instanceof MPlaza.Design&&model.get("printTypes")instanceof MPlaza.PrintTypes){printType=model.get("printTypes").getPrintType(printTypeID);}return printType;},getScaledAreaPixelSize:function(area,printType){var size=new this.paper.Size(0,0);var side=null;if(area instanceof MPlaza.Area)side=area.getParentModel();if(side&&side.get("ppcm")>0){// Dimensioni di stampa in centimetri
var printWidthCM=area.get("boundsWidth")/side.get("ppcm");var printHeightCM=area.get("boundsHeight")/side.get("ppcm");if((!printType||printType.get("dpi")<=0)&&area.get("screenPPI")>0){var widthCM=area.get("boundsWidth")/area.get("screenPPI")*2.54;var heightCM=area.get("boundsHeight")/area.get("screenPPI")*2.54;var sx=printWidthCM/widthCM;var sy=printHeightCM/heightCM;size.width=Math.round(sx*area.get("boundsWidth"));size.height=Math.round(sy*area.get("boundsHeight"));}else if(printType){var dpi=printType.get('dpi')||printType.get('printTypeDPI');// For new printful products, we must fake the print type for check the warning
if(printType.get('name')=="PrintfulPrintType"&&dpi>120)dpi=dpi*0.75;var widthPX=printWidthCM*0.39370*dpi;var heightPX=printHeightCM*0.39370*dpi;size.width=Math.round(widthPX);size.height=Math.round(heightPX);}}return size;},cloneSelectedItems:function(){var operationId=this.getLastUndoOperationId();this.beginDesignOperation();var items=this.getSelectedItems();var newItems=[];for(var i=0;i<items.length;i++){var item=items[i];var raster=this.getMaskedImageRasterItem(item);if(raster&&!this.canAddImage())continue;if(item instanceof this.paper.PointText&&!this.canAddText())continue;if(item.data&&(item.data.isTextOnPath||item.data.isTextArea)&&!this.canAddText())continue;// item && item.data && item.data.isTextArt;
if(item.data&&item.data.isTextArt&&!this.canAddTextArt())continue;var originalDesignItem=this.findDesignItemForItem(item);if(!originalDesignItem)continue;if(item.data&&item.data.isTextArt&&!originalDesignItem.get("textArt"))continue;var newItem=item.clone();newItem.data.guid=undefined;if(item.data&&item.data.isTextOnPath&&item.data.points){newItem.data.points=[item.data.points[0].clone(),item.data.points[1].clone(),item.data.points[2].clone()];}if(item.data&&item.data.isTextArea&&item.data.rect){newItem.data.rect=item.data.rect.clone();}if(item.data&&item.data.originalBounds)newItem.data.originaBounds=item.data.originalBounds.clone();if(item.data&&item.data.originalMatrix)newItem.data.originalMatrix=item.data.originalMatrix.clone();if(item.data&&item.data.originalPosition)newItem.data.originalPosition=item.data.originalPosition.clone();var delta=new this.paper.Point(25,25);newItem.position.x+=delta.x;newItem.position.y+=delta.y;if(newItem.data.originalPosition){var matrix=new this.paper.Matrix().translate(delta.x,delta.y);newItem.data.originalPosition=newItem.data.originalPosition.transform(matrix);}newItem.data.needsTransformsDataUpdate=true;this.onTextOnPathMoved(newItem,delta);this.onTextAreaMoved(newItem,delta);newItems.push(newItem);var designItem=null;if(item.data&&item.data.isTextArt){var originalTextArt=originalDesignItem.get("textArt");var options={fontFamilyID:originalTextArt.get("fontFamilyID"),fontFaceID:originalTextArt.get("fontFaceID"),text:originalTextArt.get("text"),textArtTypeID:originalTextArt.get("textArtTypeID"),style:null,config:originalTextArt.get("config").toJSON()};designItem=this.onTextArtItemCreated(newItem,options);}else if(this.isImage(item)){var image=this.createDummyImageFromDesignItem(originalDesignItem);designItem=this.onItemCreated(newItem,image);}else if(this.isMaskedImage(item)&&!this.isFilledShape(item)){var image=this.createDummyImageFromDesignItem(originalDesignItem);var shape=this.createDummyShapeFromDesignItem(originalDesignItem);designItem=this.onItemCreated(newItem,image);this.onImageItemUpdated(newItem,image,shape);}else if(this.isShape(item)){var shapeOptions={isImagePlaceholder:item.data.isImagePlaceholder,style:this.getShapeItemStyle(item)};var shape_1=this.createDummyShapeFromDesignItem(originalDesignItem);this.onShapeItemCreated(newItem,shape_1,shapeOptions);}else if(this.isFilledShape(item)){var image=this.createDummyImageFromDesignItem(originalDesignItem);var shape=this.createDummyShapeFromDesignItem(originalDesignItem);var shapeOptions={isImagePlaceholder:item.data.isImagePlaceholder,style:this.getShapeItemStyle(item)};designItem=this.onShapeItemCreated(newItem,shape,shapeOptions);this.onShapeItemUpdated(newItem,shape,image);}else if(item.data&&(item.data.isTextArea||item.data.isTextOnPath))designItem=this.onItemCreated(newItem);if(designItem){designItem.copyConstraints(originalDesignItem.get("constraints"));originalDesignItem.get("colors").each(function(color){designItem.changeColor(color.get("imageID"),color.get("colorID"),color.get("colorCode"));});designItem.unset("colorMappings");designItem.set("colorMappings",new MPlaza.ColorMappings());if(originalDesignItem.get("colorMappings")){for(var i=0;i<originalDesignItem.get("colorMappings").length;i++){var colorMapping=new MPlaza.ColorMapping();colorMapping.copyAttributes(originalDesignItem.get("colorMappings").at(i));designItem.get("colorMappings").add(colorMapping);}}}}this.deselectAll();this.selectItems(newItems);this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},mirrorSelectedItems:function(direction){var operationId=this.getLastUndoOperationId();this.beginDesignOperation();var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];item.data.needsTransformsDataUpdate=true;// Attenzione! Il mirroring viene registrato a livello di matrice anche come rotazione. Nel caso di FilledShape (shape riempita con immagine)
// qeusto causa un problema quando si sostituisce l'immagine, perché nella sostituzione dell'immagine in una shape viene
// preservata la rotazione applicata alla shape. Sono costretto quindi a resettare la trasformazione applicata alla matrice e registrare
// separatamente l'operazione in modo che venga applicata successivamente
var oldPosition=null;var oldMatrix=null;if(this.isShape||this.isFilledShape(item)){var shape=this.isShape(item)?item:this.getMaskedImageShapeItem(item);if(shape&&shape.data.originalMatrix&&shape.data.originalPosition){oldPosition=shape.data.originalPosition.clone();oldMatrix=shape.data.originalMatrix.clone();}}if(direction=="X"){item.scale(-1,-1);// Maybe a bug, i need to flip also in vertical...
var matrix=new this.paper.Matrix().scale(-1,-1);if(item.data&&item.data.originalMatrix){item.data.originalMatrix.prepend(matrix);}if(item.data&&item.data.originalPosition){item.data.originalPosition=item.data.originalPosition.transform(matrix);}this.onTextOnPathScaled(item,-1,-1,item.bounds.center);this.onTextAreaScaled(item,-1,-1,item.bounds.center);}else{item.scale(1,-1);var matrix=new this.paper.Matrix().scale(1,-1);if(item.data&&item.data.originalMatrix){item.data.originalMatrix.prepend(matrix);}if(item.data&&item.data.originalPosition){item.data.originalPosition=item.data.originalPosition.transform(matrix);}this.onTextOnPathScaled(item,1,-1,item.bounds.center);this.onTextAreaScaled(item,1,-1,item.bounds.center);}// Resetto matrice e posizione per le shape
if((this.isShape||this.isFilledShape(item))&&oldMatrix&&oldPosition){var shape=this.isShape(item)?item:this.getMaskedImageShapeItem(item);if(shape&&shape.data.originalMatrix&&shape.data.originalPosition){// Applico la trasformazione agli item figli del gruppo principale (shape and image)
this.applyTransformationsToMaskImageSubItems(item);// Resetto la matrice e la posizione
shape.data.originalPosition=oldPosition;shape.data.originalMatrix=oldMatrix;// registro il flip in modo da applicarlo quando vengono riportate le rotazioni sull'immagine di riempimento
if(!shape.data.flips){shape.data.flips=[];}shape.data.flips.push(direction);}}}this.updateTextOnPathGuides(items);this.updateTextAreaGuides(items);this.onItemsUpdated(items);this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},createDummyImageFromDesignItem:function(designItem){var image=new MPlaza.Image();image.set("imageID",designItem.get("imageID"));image.set("type",designItem.get("imageType"));image.set("format",designItem.get("imageFormat"));image.set("width",designItem.get("imageWidth"));image.set("height",designItem.get("imageHeight"));image.set("dpiX",designItem.get("imageDpiX"));image.set("dpiY",designItem.get("imageDpiY"));image.set("imageFileSize",designItem.get("imageFileSize"));image.set("providerImageID",designItem.get("providerImageID"));image.set("userID",designItem.get("imageUserID"));image.set("visitorID",designItem.get("imageVisitorID"));image.set("price",designItem.get("imagePrice"));image.set("preferredWidth",designItem.get("imagePreferredHeight"));image.set("preferredHeight",designItem.get("imagePreferredHeight"));return image;},createDummyShapeFromDesignItem:function(designItem){var shape=new MPlaza.Shape();if(designItem.get("shape")){shape.set("shapeID",designItem.get("shape").get("shapeID"));}return shape;},canAddText:function(){if(this.side&&this.side instanceof MPlaza.Side&&this.design&&this.design instanceof MPlaza.Design){var designSide=this.design.getDesignSide(this.side);// Attenzione! qui sto supponendo che l'esistenza di designSide indichi che il seller abbia specificato i vincoli
var value=designSide?designSide.get("canAddText"):this.design.get("canAddText");if(value!=undefined&&value!=null&&typeof value==="boolean"&&!value&&!this.design.get("isTemplate"))return false;var area=this.side.get("areas").at(0);var printType=this.getSelectedPrintType(area);var max=(designSide?designSide.get("maxNrTexts"):this.design.get("maxNrTexts"))||(printType&&this.model.get("printTypes").get(printType.id).get('printTypeRestrictions')?this.model.get("printTypes").get(printType.id).get('printTypeRestrictions').get("maxNrTextElements"):null);if(max!=undefined&&max!=null&&typeof max==="number"){var count=designSide?this.design.countTextItemsForSide(this.side.getModelID(),this.side.getColorID(),this.side.getSideID()):this.design.countTextItemsForColor(this.side.getModelID(),this.side.getColorID());if(count>=max)return false;}}return true;},canAddImage:function(){if(this.side&&this.side instanceof MPlaza.Side&&this.design&&this.design instanceof MPlaza.Design){var designSide=this.design.getDesignSide(this.side);var value=designSide?designSide.get("canAddImage"):this.design.get("canAddImage");if(value!=undefined&&value!=null&&typeof value==="boolean"&&!value&&!this.design.get("isTemplate"))return false;var area=this.side.get("areas").at(0);var printType=this.getSelectedPrintType(area);var max=(designSide?designSide.get("maxNrImages"):this.design.get("maxNrImages"))||(printType&&this.model.get("printTypes").get(printType.id).get('printTypeRestrictions')?this.model.get("printTypes").get(printType.id).get('printTypeRestrictions').get("maxNrImages"):null);if(max!=undefined&&max!=null&&typeof max==="number"){var count=designSide?this.design.countImageItemsForSide(this.side.getModelID(),this.side.getColorID(),this.side.getSideID()):this.design.countImageItemsForColor(this.side.getModelID(),this.side.getColorID());if(count>=max)return false;}}return true;},canMaskImages:function(){if(this.side&&this.side instanceof MPlaza.Side&&this.design&&this.design instanceof MPlaza.Design){if(this.design.get("templateDesignID")<=0)return true;var designSide=this.design.getDesignSide(this.side);var value=designSide?designSide.get("canMaskImages"):this.design.get("canMaskImages");if(value!=undefined&&value!=null&&typeof value==="boolean"&&!value)return false;}return true;},// Valutare se introdurre una limitazione dedicata
canAddTextArt:function(){return this.canAddText();},canAddShape:function(){if(this.side&&this.side instanceof MPlaza.Side&&this.design&&this.design instanceof MPlaza.Design){if(this.design.get("templateDesignID")<=0)return true;var designSide=this.design.getDesignSide(this.side);var value=designSide?designSide.get("canAddShape"):this.design.get("canAddShape");if(value!=undefined&&value!=null&&typeof value==="boolean"&&!value)return false;var max=designSide?designSide.get("maxNrShapes"):this.design.get("maxNrShapes");if(max!=undefined&&max!=null&&typeof max==="number"){var count=designSide?this.design.countShapeItemsForSide(this.side.getModelID(),this.side.getColorID(),this.side.getSideID()):this.design.countShapeItemsForColor(this.side.getModelID(),this.side.getColorID());if(count>=max)return false;}}return true;},canMoveSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(this.isMaskedImage(item)&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){if(!this.isFilledShape(item)){if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditMask(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditMaskedImage(item))return false;}else{if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditShapeFilling(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditFilledShape(item))return false;}}else if(!this.canMoveItem(item))return false;}return true;},canRotateSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(this.isMaskedImage(item)&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){if(!this.isFilledShape(item)){if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditMask(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditMaskedImage(item))return false;}else{if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditShapeFilling(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditFilledShape(item))return false;}}else if(!this.canRotateItem(item))return false;}return true;},canDeleteSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(this.isMaskedImage(item)&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){if(!this.isFilledShape(item)){if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canDeleteMask(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster)return false;}else{if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canDeleteShapeFilling(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask)return false;}}else if(!this.canDeleteItem(item))return false;}return true;},canResizeSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(this.isMaskedImage(item)&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){if(!this.isFilledShape(item)){if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditMask(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditMaskedImage(item))return false;}else{if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster&&!this.canEditShapeFilling(item))return false;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&!this.canEditFilledShape(item))return false;}}else if(item.data.isTextBox&&item.data.adaptText){return false;}else if(!this.canResizeItem(item)||item.data&&item.data.isImageForBackground)return false;var area=this.side.get("areas").at(0);var printType=this.getSelectedPrintType(area);if(printType&&this.model.get("printTypes").get(printType.id).get('printTypeRestrictions')&&this.model.get("printTypes").get(printType.id).get('printTypeRestrictions').get("allowChangeFontSize")===false&&!this.design.get("isTemplate")&&(this.getItemIsTextArea(item)||this.getItemIsTextOnPath(item)))return false;}return true;},canEditSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canEditItem(item)||item.data&&item.data.isImageForBackground)return false;}return true;},canChangeSelectionFontFamily:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemFontFamily(item))return false;}return true;},canChangeSelectionFontSize:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemFontSize(item))return false;}return true;},canChangeSelectionFontColor:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemFontColor(item))return false;}return true;},canChangeSelectionFontWeight:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemFontWeight(item))return false;}return true;},canChangeSelectionFontItalic:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemFontItalic(item))return false;}return true;},canChangeSelectionTextPathMode:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemTextPathMode(item))return false;}return true;},canChangeSelectionJustification:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemJustification(item))return false;}return true;},canChangeSelectionShadowColor:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemShadowColor(item))return false;}return true;},canChangeSelectionShadowBlur:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemShadowBlur(item))return false;}return true;},canChangeSelectionShadowDistance:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemShadowDistance(item))return false;}return true;},canChangeSelectionShadowAngle:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canChangeItemShadowAngle(item))return false;}return true;},canResizeTextBoxSelection:function(){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var item=selectedItems[i];if(!this.canResizeTextBoxItem(item))return false;}return true;},// Restituisce i constraints legati ad un item (nel caso di design derivante da template)
getItemConstraints:function(item,useInTemplate){// Se il design non deriva da un template non applico alcuna restrizione (tranne se useInTemplate è true)
if((!this.design||this.design.get("templateDesignID")<=0)&&!useInTemplate)return;var designItem=item instanceof MPlaza.DesignItem?item:this.findDesignItemForItem(item);if(designItem)return designItem.get("constraints");return null;},getItemConstraintsProperty:function(item,propertyName,defaultValue,useInTemplate){if(defaultValue===void 0){defaultValue=true;}if(useInTemplate===void 0){useInTemplate=false;}var constraints=this.getItemConstraints(item,useInTemplate);if(constraints)return constraints.get(propertyName);return defaultValue;},canMoveItem:function(item){return this.getItemConstraintsProperty(item,"canMove");},canRotateItem:function(item){return this.getItemConstraintsProperty(item,"canRotate");},canDeleteItem:function(item){return this.getItemConstraintsProperty(item,"canDelete");},canResizeItem:function(item){return this.getItemConstraintsProperty(item,"canResize");},canEditItem:function(item){return this.getItemConstraintsProperty(item,"canEdit");},canChangeItemFontFamily:function(item){return this.getItemConstraintsProperty(item,"canChangeFontFamily");},canChangeItemFontSize:function(item){var canChange=this.getItemConstraintsProperty(item,"canChangeFontSize");if(canChange){var min=this.getItemMinFontSize(item);var max=this.getItemMaxFontSize(item);if(min!=undefined&&min!=null&&max!=undefined&&max!=null)canChange=min!=max;}return canChange;},getItemMinFontSize:function(item){var constraints=this.getItemConstraints(item,false);if(constraints)return constraints.get("minFontSize");var area=this.side.get("areas").at(0);var modelPrintType=this.model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));if(modelPrintType&&modelPrintType.get('printTypeRestrictions')&&modelPrintType.get('printTypeRestrictions').get('minFontSize'))return modelPrintType.get('printTypeRestrictions').get('minFontSize');return undefined;},getItemMaxFontSize:function(item){var constraints=this.getItemConstraints(item,false);if(constraints)return constraints.get("maxFontSize");var area=this.side.get("areas").at(0);var modelPrintType=this.model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));if(modelPrintType&&modelPrintType.get('printTypeRestrictions')&&modelPrintType.get('printTypeRestrictions').get('maxFontSize'))return modelPrintType.get('printTypeRestrictions').get('maxFontSize');return undefined;},canChangeItemFontColor:function(item){return this.getItemConstraintsProperty(item,"canChangeFontColor");},canChangeItemFontWeight:function(item){return this.getItemConstraintsProperty(item,"canChangeFontWeight");},canChangeItemFontItalic:function(item){return this.getItemConstraintsProperty(item,"canChangeFontItalic");},canChangeItemTextPathMode:function(item){return this.getItemConstraintsProperty(item,"canChangeTextPathMode");},canChangeItemTextAreaMode:function(item){return this.canEditItem(item);},canChangeItemAdaptText:function(item){return this.getItemConstraintsProperty(item,"canChangeAdaptText");},canChangeItemLetterSpacing:function(item){return this.getItemConstraintsProperty(item,"canChangeLetterSpacing");},canChangeItemLineSpacing:function(item){return this.getItemConstraintsProperty(item,"canChangeLineSpacing");},canChangeItemShadowColor:function(item){return this.getItemConstraintsProperty(item,"canChangeShadowColor");},canChangeItemShadowBlur:function(item){return this.getItemConstraintsProperty(item,"canChangeShadowBlur");},canChangeItemShadowDistance:function(item){return this.getItemConstraintsProperty(item,"canChangeShadowDistance");},canChangeItemShadowAngle:function(item){return this.getItemConstraintsProperty(item,"canChangeShadowAngle");},getItemIsTextOnPath:function(item){return item&&item.data&&item.data.isTextOnPath;},getItemIsTextArea:function(item){return item&&item.data&&item.data.isTextArea;},getItemIsTextArt:function(item){return item&&item.data&&item.data.isTextArt;},getItemIsTextElement:function(item){return item&&item.data&&(item.data.isText||item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea);},canChangeItemJustification:function(item){return this.getItemConstraintsProperty(item,"canChangeJustification");},canChangeItemVerticalAlignment:function(item){return this.getItemConstraintsProperty(item,"canChangeVerticalAlignment");},canTransform:function(item){return this.getItemConstraintsProperty(item,"canTransform");},canChangeSvgColors:function(item){return this.getItemConstraintsProperty(item,"canChangeSvgColors");},canResizeTextBoxItem:function(item){return this.getItemConstraintsProperty(item,"canResizeTextBox");},canChangeItemTextBoxMode:function(item){return this.getItemConstraintsProperty(item,"canChangeTextBoxMode");},toUppercaseOption:function(item){return this.getItemConstraintsProperty(item,"toUppercase",false,true);},isAlwaysOnTop:function(item){var designItem=this.findDesignItemForItem(item);if(!designItem)return false;var constraints=designItem.get("constraints");if(constraints)return constraints.get("isAlwaysOnTop")||false;else return false;},isItemPrintable:function(item){return this.getItemConstraintsProperty(item,"isPrintable");},isItemStatic:function(item){// If this is a static template element, don't select it
var isStatic=!(this.canEditItem(item)||this.canMoveItem(item)||this.canRotateItem(item)||this.canResizeItem(item)||this.canDeleteItem(item)||this.canTransform(item));var raster=this.getMaskedImageRasterItem(item);if(raster){var designItem=this.findDesignItemForItem(item);if(!designItem)return false;if(designItem.get("imageType")=="Vector"){isStatic=isStatic&&!this.canChangeSvgColors(item);}}if(item instanceof this.paper.PointText||item&&item.data&&(item.data.isTextOnPath||item.data.isTextArea)){isStatic=isStatic&&!(this.canChangeItemFontFamily(item)||this.canChangeItemFontColor(item)||this.canChangeItemFontWeight(item)||this.canChangeItemTextPathMode(item));}return isStatic;},itemCanBeTransformed:function(item){return this.canMoveItem(item)||this.canRotateItem(item)||this.canResizeItem(item)||this.canDeleteItem(item)||this.canTransform(item);},isMandatoryToEdit:function(item){return this.getItemConstraintsProperty(item,"mandatoryToEdit");},// masked images
// Aggiungere una maschera ad un'immagine
canAddMask:function(item){return this.getItemConstraintsProperty(item,"canAddMask");},// Sostituire la maschera di un'immagine mascherata
canReplaceMask:function(item){return this.getItemConstraintsProperty(item,"canReplaceMask");},// Muovere, ruotare e ridimensionare la maschera
canEditMask:function(item){return this.getItemConstraintsProperty(item,"canEditMask");},// Eliminare una maschera
canDeleteMask:function(item){return this.getItemConstraintsProperty(item,"canDeleteMask");},// Muovere, ruotare e ridimensionare solo l'immagine con maschera
canEditMaskedImage:function(item){return this.getItemConstraintsProperty(item,"canEditMaskedImage");},// Modificare il colore del bordo di una maschera
canChangeMaskStrokeColor:function(item){return this.getItemConstraintsProperty(item,"canChangeMaskStrokeColor");},// Modificare le dimensioni del bordo di una maschera
canChangeMaskStrokeWidth:function(item){return this.getItemConstraintsProperty(item,"canChangeMaskStrokeWidth");},// shapes and filledShapes
// Riempire una shape con un'immagine
canFillShape:function(item){return this.getItemConstraintsProperty(item,"canFillShape");},// Sostituire l'immagine di riempimento con una nuova immagine
canReplaceShapeFilling:function(item){return this.getItemConstraintsProperty(item,"canReplaceShapeFilling");},// Muovere, ruotare e ridimensionare l'immagine di riempimento
canEditShapeFilling:function(item){return this.getItemConstraintsProperty(item,"canEditShapeFilling");},// Eliminare l'immagine di riempimento
canDeleteShapeFilling:function(item){return this.getItemConstraintsProperty(item,"canDeleteShapeFilling");},// Muovere, ruotare e ridimensionare solo la shape quando riempita con un'immagine
canEditFilledShape:function(item){return this.getItemConstraintsProperty(item,"canEditFilledShape");},// Cambiare il colore del contorno della shape
canChangeShapeStrokeColor:function(item){return this.getItemConstraintsProperty(item,"canChangeShapeStrokeColor");},// Cambiare le dimensioni del contorno della shape
canChangeShapeStrokeWidth:function(item){return this.getItemConstraintsProperty(item,"canChangeShapeStrokeWidth");},// Cambiare il colore di riempimento della shape
canChangeShapeFillColor:function(item){return this.getItemConstraintsProperty(item,"canChangeShapeFillColor");},allowShadows:function(){return this.getPrintTypeConstraintsProperty("allowShadows",false);},getMinShadowBlur:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("minShadowBlur")!=undefined&&itemConstraints.get("minShadowBlur")!=null)return itemConstraints.get("minShadowBlur");return this.getPrintTypeConstraintsProperty("minShadowBlur",null)||0;},getMaxShadowBlur:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("maxShadowBlur")!=undefined&&itemConstraints.get("maxShadowBlur")!=null)return itemConstraints.get("maxShadowBlur");return this.getPrintTypeConstraintsProperty("maxShadowBlur",null);},adjustInputShadowBlur:function(item,blur){var min=this.getMinShadowBlur(item);var max=this.getMaxShadowBlur(item);if(min!=undefined&&min!=null&&blur<min)blur=min;if(max!=undefined&&max!=null&&blur>max)blur=max;return blur;},getMinShadowDistance:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("minShadowDistance")!=undefined&&itemConstraints.get("minShadowDistance")!=null)return itemConstraints.get("minShadowDistance");return this.getPrintTypeConstraintsProperty("minShadowDistance",null)||0;},getMaxShadowDistance:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("maxShadowDistance")!=undefined&&itemConstraints.get("maxShadowDistance")!=null)return itemConstraints.get("maxShadowDistance");return this.getPrintTypeConstraintsProperty("maxShadowDistance",null);},adjustInputShadowDistance:function(item,distance){var min=this.getMinShadowDistance(item);var max=this.getMaxShadowDistance(item);if(min!=undefined&&min!=null&&distance<min)distance=min;if(max!=undefined&&max!=null&&distance>max)distance=max;return distance;},getMinShadowAngle:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("minShadowAngle")!=undefined&&itemConstraints.get("minShadowAngle")!=null)return itemConstraints.get("minShadowAngle");return this.getPrintTypeConstraintsProperty("minShadowAngle",null)||0;},getMaxShadowAngle:function(item){var itemConstraints=this.getItemConstraints(item);if(itemConstraints&&itemConstraints.get("maxShadowAngle")!=undefined&&itemConstraints.get("maxShadowAngle")!=null)return itemConstraints.get("maxShadowAngle");var angle=this.getPrintTypeConstraintsProperty("maxShadowAngle",null);if(angle!=undefined&&angle!=null)return Math.min(Math.max(0,angle),359);return 359;},adjustInputShadowAngle:function(item,angle){var min=this.getMinShadowAngle(item)||0;var max=this.getMaxShadowAngle(item)||359;return Math.min(Math.max(min,angle),max);},// Print type constraints
getPrintTypeConstraints:function(){if(this.side&&this.side.get("areas").length>0&&this.model){var area=this.side.get("areas").at(0);var printType=this.getSelectedPrintType(area);if(printType){return this.model.get("printTypes").get(printType.id).get('printTypeRestrictions');}}return null;},getPrintTypeConstraintsProperty:function(propertyName,defaultValue){var constraints=this.getPrintTypeConstraints();if(constraints)return constraints.get(propertyName);return defaultValue;},// -------------------------------------------------------------
// Selection
// -------------------------------------------------------------
findItemById:function(id){if(id==-1)return null;function findItem(item){if(item.id==id)return item;if(item.children){for(var j=item.children.length-1;j>=0;j--){var it=findItem(item.children[j]);if(it!=null)return it;}}return null;}for(var i=0,l=this.paper.project.layers.length;i<l;i++){var layer=this.paper.project.layers[i];var it=findItem(layer);if(it!=null)return it;}return null;},findItemByName:function(name){if(!name)return null;function findItem(item){if(item.name===name)return item;if(item.children){for(var j=item.children.length-1;j>=0;j--){var it=findItem(item.children[j]);if(it!=null)return it;}}return null;}for(var i=0,l=this.paper.project.layers.length;i<l;i++){var layer=this.paper.project.layers[i];var it=findItem(layer);if(it!=null)return it;}return null;},clearSelectionBounds:function(){if(this.selectionBoundsShape)this.selectionBoundsShape.remove();if(this.selectionMaskMoveImage)this.selectionMaskMoveImage.remove();if(this.selectionMaskMoveShape)this.selectionMaskMoveShape.remove();if(this.selectionMoveHandle)this.selectionMoveHandle.remove();if(this.selectionRotateHandle)this.selectionRotateHandle.remove();if(this.selectionResizeHandle)this.selectionResizeHandle.remove();if(this.selectionDeleteHandle)this.selectionDeleteHandle.remove();if(this.selectionResizeTopHandle)this.selectionResizeTopHandle.remove();if(this.selectionResizeBottomHandle)this.selectionResizeBottomHandle.remove();if(this.selectionResizeLeftHandle)this.selectionResizeLeftHandle.remove();if(this.selectionResizeRightHandle)this.selectionResizeRightHandle.remove();this.selectionBoundsShape=null;this.selectionBounds=null;this.selectionMoveHandle=null;this.selectionRotateHandle=null;this.selectionResizeHandle=null;this.selectionDeleteHandle=null;this.selectionMaskMoveImage=null;this.selectionMaskMoveShape=null;this.selectionResizeTopHandle=null;this.selectionResizeBottomHandle=null;this.selectionResizeLeftHandle=null;this.selectionResizeRightHandle=null;},showSelectionBounds:function(){this.drawSelectionBounds++;if(this.drawSelectionBounds>0){if(this.selectionBoundsShape)this.selectionBoundsShape.visible=true;if(this.selectionMoveHandle)this.selectionMoveHandle.visible=true;if(this.selectionRotateHandle)this.selectionRotateHandle.visible=true;if(this.selectionResizeHandle)this.selectionResizeHandle.visible=true;if(this.selectionDeleteHandle)this.selectionDeleteHandle.visible=true;if(this.selectionMaskMoveImage)this.selectionMaskMoveImage.visible=true;if(this.selectionMaskMoveShape)this.selectionMaskMoveShape.visible=true;if(this.selectionResizeTopHandle)this.selectionResizeTopHandle.visible=true;if(this.selectionResizeBottomHandle)this.selectionResizeBottomHandle.visible=true;if(this.selectionResizeLeftHandle)this.selectionResizeLeftHandle.visible=true;if(this.selectionResizeRightHandle)this.selectionResizeRightHandle.visible=true;}},hideSelectionBounds:function(){if(this.drawSelectionBounds>0)this.drawSelectionBounds--;if(this.drawSelectionBounds==0){if(this.selectionBoundsShape)this.selectionBoundsShape.visible=false;if(this.selectionMoveHandle)this.selectionMoveHandle.visible=false;if(this.selectionRotateHandle)this.selectionRotateHandle.visible=false;if(this.selectionResizeHandle)this.selectionResizeHandle.visible=false;if(this.selectionDeleteHandle)this.selectionDeleteHandle.visible=false;if(this.selectionMaskMoveImage)this.selectionMaskMoveImage.visible=false;if(this.selectionMaskMoveShape)this.selectionMaskMoveShape.visible=false;if(this.selectionResizeTopHandle)this.selectionResizeTopHandle.visible=false;if(this.selectionResizeBottomHandle)this.selectionResizeBottomHandle.visible=false;if(this.selectionResizeLeftHandle)this.selectionResizeLeftHandle.visible=false;if(this.selectionResizeRightHandle)this.selectionResizeRightHandle.visible=false;}},updateSelectionState:function(){if(this.isViewer)return;this.clearSelectionBounds();this.updateMaskedImageGuides();this.selectionBounds=this.getSelectionBounds();if(this.selectionBounds!=null){var rect=new this.paper.Path.Rectangle(this.selectionBounds);rect.strokeColor=this.getContrastedColor(this.selectionBounds);rect.strokeWidth=1.0/this.paper.view.zoom;rect.dashOffset=0.5/this.paper.view.zoom;rect.dashArray=[1.0/this.paper.view.zoom,1.0/this.paper.view.zoom];rect.guide=true;rect.visible=this.drawSelectionBounds>0;this.selectionBoundsShape=rect;this.createSelectionHandles();}this.updateTextOnPathGuides();this.updateTextAreaGuides();},moveSelectionShapes:function(delta){if(this.selectionBoundsShape){this.selectionBoundsShape.position.x+=delta.x;this.selectionBoundsShape.position.y+=delta.y;if(this.selectionMoveHandle){this.selectionMoveHandle.position.x+=delta.x;this.selectionMoveHandle.position.y+=delta.y;}if(this.selectionRotateHandle){this.selectionRotateHandle.position.x+=delta.x;this.selectionRotateHandle.position.y+=delta.y;}if(this.selectionResizeHandle){this.selectionResizeHandle.position.x+=delta.x;this.selectionResizeHandle.position.y+=delta.y;}if(this.selectionDeleteHandle){this.selectionDeleteHandle.position.x+=delta.x;this.selectionDeleteHandle.position.y+=delta.y;}if(this.selectionMaskMoveShape){this.selectionMaskMoveShape.position.x+=delta.x;this.selectionMaskMoveShape.position.y+=delta.y;}if(this.selectionMaskMoveImage){this.selectionMaskMoveImage.position.x+=delta.x;this.selectionMaskMoveImage.position.y+=delta.y;}if(this.selectionResizeTopHandle){this.selectionResizeTopHandle.position.x+=delta.x;this.selectionResizeTopHandle.position.y+=delta.y;}if(this.selectionResizeBottomHandle){this.selectionResizeBottomHandle.position.x+=delta.x;this.selectionResizeBottomHandle.position.y+=delta.y;}if(this.selectionResizeLeftHandle){this.selectionResizeLeftHandle.position.x+=delta.x;this.selectionResizeLeftHandle.position.y+=delta.y;}if(this.selectionResizeRightHandle){this.selectionResizeRightHandle.position.x+=delta.x;this.selectionResizeRightHandle.position.y+=delta.y;}this.selectionBounds=this.selectionBoundsShape.bounds;}},scaleSelectionShapes:function(sx,sy,pivot){if(this.selectionBoundsShape){this.selectionBoundsShape.scale(sx,sy,pivot);this.selectionBounds=this.selectionBoundsShape.bounds;this.placeHandleOut(this.selectionBoundsShape);}},createSelectionHandles:function(){var _a,_b;if(this.selectionMoveHandle)this.selectionMoveHandle.remove();if(this.selectionRotateHandle)this.selectionRotateHandle.remove();if(this.selectionResizeHandle)this.selectionResizeHandle.remove();if(this.selectionDeleteHandle)this.selectionDeleteHandle.remove();if(this.selectionMaskMoveShape)this.selectionMaskMoveShape.remove();if(this.selectionMaskMoveImage)this.selectionMaskMoveImage.remove();if(this.selectionResizeTopHandle)this.selectionResizeTopHandle.remove();if(this.selectionResizeBottomHandle)this.selectionResizeBottomHandle.remove();if(this.selectionResizeLeftHandle)this.selectionResizeLeftHandle.remove();if(this.selectionResizeRightHandle)this.selectionResizeRightHandle.remove();if(this.selectionBoundsShape){var segments=this.selectionBoundsShape.segments;if(segments.length==4){var bottomLeft=segments[0].point;var topLeft=segments[1].point;var topRight=segments[2].point;var bottomRight=segments[3].point;var top=topLeft.add(topRight.subtract(topLeft).divide(2));var bottom=bottomLeft.add(bottomRight.subtract(bottomLeft).divide(2));var left=bottomLeft.add(topLeft.subtract(bottomLeft).divide(2));var right=bottomRight.add(topRight.subtract(bottomRight).divide(2));var selectedItems=this.getSelectedItems();if(this.showSelectedElementDimensions)this.createDimensionLabel(top,bottomRight);if(this.showTotalSizeOfCurrentSide)this.createPrintAreaTotalDimensionLabel(top,bottomRight);if(this.showUnselectedElementsDimensions)this.createUnselectedDimensionLabel();if(this.canMoveSelection())this.selectionMoveHandle=this.createSelectionHandle("move",topLeft);if(this.canRotateSelection())this.selectionRotateHandle=this.createSelectionHandle("rotate",topRight);if(this.canDeleteSelection())this.selectionDeleteHandle=this.createSelectionHandle("remove",bottomLeft);if(this.canResizeSelection()){// TODO: manage when there will be different print type for each area
var model=this.getCurrentModel();if(model&&this.design&&this.design instanceof MPlaza.Design&&model.get("printTypes")instanceof MPlaza.PrintTypes&&selectedItems.length>0&&this.side&&this.side.get("areas").length>0){//Since print types per areas are not yet supported, just take the first area (the print type of that area's side side will be taken)
var area=this.side.get("areas").at(0);var printType=this.getSelectedPrintType(area);var modelPrintType=model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));if(!printType)printType=model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));var useImagesFixedSize=null;if(printType instanceof MPlaza.PartPrintType){var restrictions=printType.get("restrictions");useImagesFixedSize=restrictions?restrictions.get("useImagesFixedSize"):null;}if(useImagesFixedSize==null&&modelPrintType)useImagesFixedSize=(_a=modelPrintType===null||modelPrintType===void 0?void 0:modelPrintType.get("useImagesFixedSize"))!==null&&_a!==void 0?_a:(_b=modelPrintType.get("printTypeRestrictions"))===null||_b===void 0?void 0:_b.get('useImagesFixedSize');var item=selectedItems[0];var designItem=this.selectedDesignItem;if(!useImagesFixedSize||designItem&&!designItem.get("imagePreferredWidth")&&!designItem.get("imagePreferredHeight")){if(!this.isMobile||item.data&&!(item.data.isTextArea||item.data.isTextOnPath)){//enabled for textArt
this.selectionResizeHandle=this.createSelectionHandle("resize",bottomRight);if(item.data&&item.data.isTextArt||this.isMaskedImage(item)&&this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask||item.data&&item.data.isShape){this.selectionResizeTopHandle=this.createLateralSelectionHandle("top",top);this.selectionResizeBottomHandle=this.createLateralSelectionHandle("bottom",bottom);this.selectionResizeLeftHandle=this.createLateralSelectionHandle("left",left);this.selectionResizeRightHandle=this.createLateralSelectionHandle("right",right);}}}}}var selectedItem=this.getSelectedItem();if(selectedItem&&this.isMaskedImage(selectedItem)){var isStatic=!(this.canMoveItem(selectedItem)||this.canRotateItem(selectedItem)||this.canResizeItem(selectedItem));if(!this.isFilledShape(selectedItem)&&this.canEditMask(selectedItem))this.selectionMaskMoveShape=this.createSelectionHandle("maskMoveShape",right);if(this.isFilledShape(selectedItem)&&!isStatic)this.selectionMaskMoveShape=this.createSelectionHandle("maskMoveShape",right);if(this.canEditMaskedImage(selectedItem))this.selectionMaskMoveImage=this.createSelectionHandle("maskMoveImage",right);}this.placeHandleOut(this.selectionBoundsShape);}}},resetAllDimensionLabels:function(){if(this.selectedItemDimensionLabel)this.selectedItemDimensionLabel.remove();if(this.printAreaLabel)this.printAreaLabel.remove();if(this.labelLayer){this.labelLayer.remove();this.selectedItemDimensionLabel=null;this.printAreaLabel=null;this.labelLayer=null;}if(this.dimensionLabelList){this.dimensionLabelList.map(function(item){item.remove();return false;});this.dimensionLabelList=null;this.unselectedLabelsGroup.remove();this.unselectedLabelsGroup=null;}},createUnselectedDimensionLabel:function(){var _this_1=this;var selectedItem=this.getSelectedItem();if(selectedItem){if(!this.dimensionLabelList){this.dimensionLabelList=[];if(!this.unselectedLabelsGroup)this.unselectedLabelsGroup=new this.paper.Group({name:'unselectedLabelsGroup',applyMatrix:false,visible:false});var allItems=this.getAllItems();var ppcm_1=this.side.get("ppcm");var unselectedLabelsGroup_1=this.unselectedLabelsGroup;if(this.dimensionLabelList.length===0&&this.labelLayer){this.labelLayer.addChild(unselectedLabelsGroup_1);allItems.forEach(function(item){if(item.data&&item.data.guid&&!item.data.isArea){if(!_this_1.dimensionLabelList["label-"+item.id]&&!(item.id===selectedItem.id)){var width=item.data.transformsData?item.data.transformsData.dimensions.width:item.bounds.width;var height=item.data.transformsData?item.data.transformsData.dimensions.height:item.bounds.height;var labelGroup=new _this_1.paper.Group({name:"label-"+item.id,id:"label-"+item.id,applyMatrix:false});unselectedLabelsGroup_1.addChild(labelGroup);var topLeft=item.bounds.topLeft;var topRight=item.bounds.topRight;var top_1=topLeft.add(topRight.subtract(topLeft).divide(2));var areaWidth=(width/ppcm_1/(_this_1.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);var areaHeight=(height/ppcm_1/(_this_1.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);_this_1.createLabel(top_1,labelGroup,""+areaWidth+_this_1.unitOfMeasurement+" x "+areaHeight+_this_1.unitOfMeasurement);labelGroup.position=top_1.add(new _this_1.paper.Point(0,-22/_this_1.paper.view.zoom));var scaleRatio=(labelGroup.children[1].bounds.width+20)/labelGroup.children[0].bounds.width;labelGroup.children[0].scale(scaleRatio,1);_this_1.dimensionLabelList["label-"+item.id]=labelGroup;}}});}unselectedLabelsGroup_1.visible=true;this.updateUnselectedLabels();}else{this.updateUnselectedLabels();}}},updateUnselectedLabels:function(){var _this_1=this;var selectedItem=this.getSelectedItem();if(selectedItem){if(!this.dimensionLabelList)return;var allItems=this.getAllItems();var ppcm_2=this.side.get("ppcm");if(this.dimensionLabelList["label-"+selectedItem.id]){this.dimensionLabelList["label-"+selectedItem.id].remove();delete this.dimensionLabelList["label-"+selectedItem.id];}this.dimensionList=this.dimensionLabelList.map(function(item){item.remove();return false;});if(this.unselectedLabelsGroup){var unselectedLabelsGroup_2=this.unselectedLabelsGroup;allItems.forEach(function(item){if(item.data&&item.data.guid&&!item.data.isArea){if(!(item.id===selectedItem.id)){if(!_this_1.dimensionLabelList["label-"+item.id]){var width=item.data.transformsData?item.data.transformsData.dimensions.width:item.bounds.width;var height=item.data.transformsData?item.data.transformsData.dimensions.height:item.bounds.height;var labelGroup=new _this_1.paper.Group({name:"label-"+item.id,id:"label-"+item.id,applyMatrix:false});unselectedLabelsGroup_2.addChild(labelGroup);var topLeft=item.bounds.topLeft;var topRight=item.bounds.topRight;var top_2=topLeft.add(topRight.subtract(topLeft).divide(2));top_2.y-=40;var areaWidth=(width/ppcm_2/(_this_1.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);var areaHeight=(height/ppcm_2/(_this_1.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);_this_1.createLabel(top_2,labelGroup,areaWidth+" x "+areaHeight+" "+_this_1.unitOfMeasurement);var scaleRatio=(labelGroup.children[1].bounds.width+20)/labelGroup.children[0].bounds.width;labelGroup.children[0].scale(scaleRatio,1);_this_1.dimensionLabelList["label-"+item.id]=labelGroup;}else{_this_1.resizeHandle(_this_1.dimensionLabelList["label-"+item.id],110);}}}});}}},deleteDimensionLabel:function(itemId){if(itemId&&this.dimensionLabelList&&this.dimensionLabelList[itemId]){this.dimensionLabelList[itemId].remove();this.dimensionLabelList.splice(itemId,1);}},isGridImage:function(){var selectedItem=this.getSelectedItem();return selectedItem&&selectedItem.data&&selectedItem.data.isGridImage;},createDimensionLabel:function(pointTop,pointRight){var manager=this;if(!this.labelLayer){var defaultLayer=this.paper.project.activeLayer;this.labelLayer=new manager.paper.Layer({name:'labels'});defaultLayer.activate();this.labelLayer.visible=false;this.labelLayer.bringToFront();this.selectedItemDimensionLabel=new manager.paper.Group({name:'widthLabelGroup'});this.selectedItemDimensionLabel.applyMatrix=false;this.labelLayer.addChild(this.selectedItemDimensionLabel);this.createLabel(pointTop,this.selectedItemDimensionLabel,0+" x "+0+" "+this.unitOfMeasurement);this.updateLabelsPosition();var scaleRatio=(this.selectedItemDimensionLabel.children[1].bounds.width+20)/this.selectedItemDimensionLabel.children[0].bounds.width;this.selectedItemDimensionLabel.children[0].scale(scaleRatio,1);}else{this.updateLabelsPosition();}},createPrintAreaTotalDimensionLabel:function(){if(!this.printAreaLabel){if(!this.labelLayer){var defaultLayer=this.paper.project.activeLayer;this.labelLayer=new this.paper.Layer({name:'labels'});defaultLayer.activate();this.labelLayer.bringToFront();}this.printAreaLabel=new this.paper.Group({name:'heightLabelGroup'});this.printAreaLabel.applyMatrix=false;this.labelLayer.addChild(this.printAreaLabel);var ppcm=this.side.get("ppcm");if(this.paper.project.layers[1].children[0].children[1]){var printAreaPath=this.paper.project.layers[1].children[0].children[1];var printAreaWidth=(printAreaPath.bounds.width/ppcm/(this.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);var printAreaHeight=(printAreaPath.bounds.height/ppcm/(this.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);this.createLabelPrintArea(printAreaPath,this.printAreaLabel,printAreaWidth+" x "+printAreaHeight+" "+this.unitOfMeasurement);}}else{this.updatePrintAreaLabelText();}},createLabelPrintArea:function(path,labelGroup,content){var manager=this;var rect=new this.paper.Path.Rectangle(new this.paper.Rectangle(0,0,80,15),0);rect.fillColor=new this.paper.Color('#ffffff');rect.strokeScaling=false;rect.strokeWidth=0;rect.strokeColor=new this.paper.Color('#000000');rect.position=path.pointTop;rect.position.y+=28;rect.name="labelRectanglePrintArea-"+labelGroup.name;rect.opacity=1;var text=new this.paper.PointText(path.pointTop);text.content=content;text.position.y+=32;text.fontSize=10;text.fontWeight=600;text.fontFamily='Montserrat, sans-serif';text.fillColor=new this.paper.Color('#000000');text.justification='center';text.opacity=0.7;labelGroup.addChildren([rect,text]);labelGroup.position=path.bounds.topCenter.add(new manager.paper.Point(0,-22/manager.paper.view.zoom));},createLabel:function(point,labelGroup,content){var rect=new this.paper.Path.Rectangle(new this.paper.Rectangle(0,0,80,15),0);rect.fillColor=new this.paper.Color('#ffffff');rect.strokeScaling=false;rect.strokeWidth=0;rect.strokeColor=new this.paper.Color('#000000');//  theme.app.primary
rect.position=point;rect.position.y+=32;rect.name="labelRectangle-"+labelGroup.name;var text=new this.paper.PointText(point);text.content=content;text.position.y+=36;text.fontSize=10;text.fontWeight=600;text.fontFamily='Montserrat, sans-serif';text.fillColor=new this.paper.Color('#514f52');text.justification='center';labelGroup.addChildren([rect,text]);},updateLabelsPosition:function(){var manager=this;var layer=this.labelLayer;var selectedItem=this.getSelectedItem();if(selectedItem&&this.selectedItemDimensionLabel){this.selectedItemDimensionLabel.position=selectedItem.bounds.topCenter.add(new manager.paper.Point(0,-22/manager.paper.view.zoom));this.updateLabelsText();this.resizeHandle(this.selectedItemDimensionLabel,110);layer.visible=true;}this.paper.project.view.update();},updatePrintAreaLabelText:function(){var printAreaPath=this.paper.project.layers[1].children[0].children[1];var ppcm=this.side.get("ppcm");var allItems=this.getAllItems();var filterItems=[];allItems.forEach(function(item){if(item.data&&item.data.guid&&!item.data.isArea){filterItems.push(item);}});var allGridItems=this.getAllGridItems();allGridItems.forEach(function(gridItem){if(gridItem.children&&gridItem.children.length>0){gridItem.children.forEach(function(gridPathGroup){gridPathGroup.children.forEach(function(item){if(item.data&&item.data.isGridImage)filterItems.push(item);});});}});if(printAreaPath){var total=this.totalAreaCalculator(filterItems)/(this.unitOfMeasurement==='cm'?1:2.54);this.printAreaLabel.children[1].content=total.toFixed(2)+" "+this.unitOfMeasurement+"2";// Scale the label rectangle to fit the label size
var scaleRatio=(this.printAreaLabel.children[1].bounds.width+20)/this.printAreaLabel.children[0].bounds.width;this.printAreaLabel.children[0].scale(scaleRatio,1);this.resizeHandle(this.printAreaLabel,110);this.labelLayer.visible=true;}},updateLabelsText:function(labelToUpdate){var selectedItem=this.getSelectedItem();if(selectedItem){var ppcm=this.side.get("ppcm");var widthLabel=(selectedItem.bounds.width/ppcm/(this.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);var heightLabel=(selectedItem.bounds.height/ppcm/(this.unitOfMeasurement==='cm'?1:2.54)).toFixed(2);this.selectedItemDimensionLabel.children[1].content=widthLabel+" x "+heightLabel+" "+this.unitOfMeasurement;//Scale the label rectangle to fit the label size
var scaleRatio=(this.selectedItemDimensionLabel.children[1].bounds.width+10)/this.selectedItemDimensionLabel.children[0].bounds.width;this.selectedItemDimensionLabel.children[0].scale(scaleRatio,1);}else{throw new Error('Item cannot be null');}},totalAreaCalculator:function(items){var _this_1=this;var context=this;var itemsArea=0;var areas=[this.side.get('areas').models];///let's take the areas with at least one item (remember that the items of the context are already filtered by target / elements).
areas.forEach(function(area){//for each area I search, among all the items, those that are on that area
//second version sum of the areas of each item
var modelSide=_this_1.side;if(modelSide!=null&&modelSide.get('ppcm')>0){var itemsRectangles=items.map(function(item){var width=item.data.transformsData?item.data.transformsData.dimensions.width:item.bounds.width;var height=item.data.transformsData?item.data.transformsData.dimensions.height:item.bounds.height;var xPosition=item.data.transformsData?item.data.transformsData.position.x:item.bounds.x;var yPosition=item.data.transformsData?item.data.transformsData.position.y:item.bounds.y;return new Rectangle(width,height,xPosition,yPosition);});itemsArea=itemsArea+rectanglesDistinctArea(itemsRectangles,modelSide.get('ppcm'));}},context);return itemsArea;},//Places handle out of selection bounds
placeHandleOut:function(currentBounds){currentBounds=currentBounds||this.selectionBoundsShape;if(!currentBounds)return;var bottomLeft=currentBounds.segments[0].point;var topLeft=currentBounds.segments[1].point;var topRight=currentBounds.segments[2].point;var bottomRight=currentBounds.segments[3].point;var top=topLeft.add(topRight.subtract(topLeft).divide(2));var bottom=bottomLeft.add(bottomRight.subtract(bottomLeft).divide(2));var left=bottomLeft.add(topLeft.subtract(bottomLeft).divide(2));var right=bottomRight.add(topRight.subtract(bottomRight).divide(2));var dist=bottomRight.subtract(topLeft);var a=Math.atan2(dist.x,dist.y);var height=topLeft.getDistance(bottomLeft);var width=topLeft.getDistance(topRight);var m=height/width;var angle=Math.atan(m);var rBase=1/2;var currentRotation=a+angle;if(this.selectionMoveHandle){var r=this.selectionMoveHandle.bounds.width*rBase;this.selectionMoveHandle.position=topLeft;this.selectionMoveHandle.position.y-=Math.sin(currentRotation+Math.PI/4)*r;this.selectionMoveHandle.position.x+=Math.cos(currentRotation+Math.PI/4)*r;}if(this.selectionRotateHandle){var r=this.selectionRotateHandle.bounds.width*rBase;this.selectionRotateHandle.position=topRight;this.selectionRotateHandle.position.y-=Math.sin(currentRotation-Math.PI/4)*r;this.selectionRotateHandle.position.x+=Math.cos(currentRotation-Math.PI/4)*r;}if(this.selectionDeleteHandle){var r=this.selectionDeleteHandle.bounds.width*rBase;this.selectionDeleteHandle.position=bottomLeft;this.selectionDeleteHandle.position.y-=Math.sin(currentRotation+3*Math.PI/4)*r;this.selectionDeleteHandle.position.x+=Math.cos(currentRotation+3*Math.PI/4)*r;}if(this.selectionResizeHandle){var r=this.selectionResizeHandle.bounds.width*rBase;this.selectionResizeHandle.position=bottomRight;this.selectionResizeHandle.position.y-=Math.sin(currentRotation-3*Math.PI/4)*r;this.selectionResizeHandle.position.x+=Math.cos(currentRotation-3*Math.PI/4)*r;}if(this.selectionMaskMoveImage){var r=this.selectionMaskMoveImage.bounds.width*rBase;this.selectionMaskMoveImage.position=right;this.selectionMaskMoveImage.position.y-=Math.sin(currentRotation+0.7-Math.PI/2)*(r+20/this.paper.view.zoom);this.selectionMaskMoveImage.position.x+=Math.cos(currentRotation+0.7-Math.PI/2)*(r+20/this.paper.view.zoom);}if(this.selectionMaskMoveShape){var r=this.selectionMaskMoveShape.bounds.width*rBase;this.selectionMaskMoveShape.position=right;this.selectionMaskMoveShape.position.y-=Math.sin(currentRotation-0.7-Math.PI/2)*(r+20/this.paper.view.zoom);this.selectionMaskMoveShape.position.x+=Math.cos(currentRotation-0.7-Math.PI/2)*(r+20/this.paper.view.zoom);}if(this.selectionResizeTopHandle||this.selectionResizeBottomHandle||this.selectionResizeLeftHandle||this.selectionResizeRightHandle){var lr=this.selectionResizeHandle?this.selectionResizeHandle.bounds.width*rBase:this.selectionLateralResizeDimension*rBase*2;var newTopLeft=topLeft.clone();newTopLeft.y-=Math.sin(currentRotation+Math.PI/4)*lr;newTopLeft.x+=Math.cos(currentRotation+Math.PI/4)*lr;var newTopRight=topRight.clone();newTopRight.y-=Math.sin(currentRotation-Math.PI/4)*lr;newTopRight.x+=Math.cos(currentRotation-Math.PI/4)*lr;var newBottomLeft=bottomLeft.clone();newBottomLeft.y-=Math.sin(currentRotation+3*Math.PI/4)*lr;newBottomLeft.x+=Math.cos(currentRotation+3*Math.PI/4)*lr;var newBottomRight=bottomRight.clone();newBottomRight.y-=Math.sin(currentRotation-3*Math.PI/4)*lr;newBottomRight.x+=Math.cos(currentRotation-3*Math.PI/4)*lr;if(this.selectionResizeTopHandle)this.selectionResizeTopHandle.position=top;if(this.selectionResizeBottomHandle)this.selectionResizeBottomHandle.position=bottom;if(this.selectionResizeLeftHandle)this.selectionResizeLeftHandle.position=left;if(this.selectionResizeRightHandle)this.selectionResizeRightHandle.position=right;}},resizeHandle:function(handle,size){var originalSize=handle.bounds;var s=(size!==null&&size!==void 0?size:200)/_this_1.paper.view.zoom;var size=new _this_1.paper.Size(s,s);var sx=1.0,sy=1.0;if(Math.abs(originalSize.width)>0.0000001)sx=size.width/originalSize.width;if(Math.abs(originalSize.height)>0.0000001)sy=size.height/originalSize.height;handle.scale(sx);},createSelectionHandle:function(name,point){if(!this.selectionBounds)return null;var currentBounds=this.selectionBoundsShape;//var s = 16 / this.paper.view.zoom;
//var s = 24 / this.paper.view.zoom;
var ViewPort=getViewport();var s=0;if(ViewPort.w<=480){s=32/this.paper.view.zoom;}else{s=32/this.paper.view.zoom;}var bytes=this.iconsBytes[name];var url='data:image/png;base64,'+bytes;var handle=new this.paper.Raster({source:url,position:point});handle.data.isHandle=true;var resizeHandle=function(){var originalSize=handle.size;var size=new this.paper.Size(s,s);var sx=1.0,sy=1.0;if(Math.abs(originalSize.width)>0.0000001)sx=size.width/originalSize.width;if(Math.abs(originalSize.height)>0.0000001)sy=size.height/originalSize.height;handle.scale(sx,sy);};if(handle.size.width>0&&handle.size.height>0){resizeHandle();}else{var that=this;handle.onLoad=function(){resizeHandle();that.placeHandleOut(currentBounds);};}return handle;},createLateralSelectionHandle:function(type,point){var handleCircleDimension=this.selectionLateralResizeDimension/this.paper.view.zoom;var handle=new this.paper.Path.Circle(point,handleCircleDimension);handle.data.isLateralResize=true;handle.data.lateralResizeType=type;handle.strokeColor=new this.paper.Color(1,1,1,0.5);handle.strokeWidth=1;handle.fillColor=new this.paper.Color(0,0,0,0.5);return handle;},isItemFrozen:function(item){return item&&(item.data&&item.data.frozen||this.isItemGroupChild(item)&&item.parent.data&&item.parent.data.frozen);},isItemGroup:function(item){return item instanceof this.paper.Group&&!(item instanceof this.paper.Layer);},isItemGroupChild:function(item){return item.parent&&this.isItemGroup(item.parent);},isItemChild:function(item){return item.parent&&!(item.parent instanceof this.paper.Layer);},getRootDesignItemCanvasItem:function(item){if(item){if(item.isMaskPath)return item.item;if(item.data&&item.data.guid&&!item.data.isArea)return item;else if(item.parent&&!(item.parent instanceof this.paper.Layer))return this.getRootDesignItemCanvasItem(item.parent);}return null;},isDesignItemCanvasItem:function(item){return this.getRootDesignItemCanvasItem(item)!=null;},setItemDataCustomOptions:function(item,customOptions){item.data.customOptions=customOptions;this.onItemUpdated(item);console.log(item.data);},setItemSelection:function(item,selected){var root=this.getRootDesignItemCanvasItem(item);if(root&&root.data.selected!=selected){root.data.selected=selected;var designItem=this.findDesignItemForItem(root);if(root.data.maskAlertPath)root.data.maskAlertPath.remove();this.createMaskForItem(item);//remove or create a dashed edge
if(selected){this.checkAlertItems(root);this.removeDashedEdgeForItem(root);this.selectedDesignItem=designItem;}else{if(designItem)//when the design item is null, the element was removed and no need to create the dashedEdge
this.createDashedEdgeForItem(root);this.selectedDesignItem=null;}var event={designItem:designItem,selected:selected};if(designItem){this.fireSelectionChangedEvent(event);}}},// Matteo. In generale gli item di paper non vanno collegati tra loro attraverso i metadata (item.data).
// Questo perché gli item vengono serializzati e deserializzati. L'item in data, dopo la deserializzazione diventa orfano
// e non può essere più cancellato da paper. Quindi in generale è bene collegare gli item tra loro tramite riferimento.
// Ad esempio, per un maskPath, si poteva creare normalmente il path, assegnargli il ruolo di maskPath (data.isMaskPath=true)
// e l'item di riferimento (data.relatedItemGuid = ...). Per il maskPath per esempio si verifica un problema nella rotazione
// dell'item, perché quando un item viene ruotato viene deserializzata una versione precedente alla rotazione e poi applicata la rotazione.
// In questa fase, il maskPath diventa orfano e non può essere più cancellato. In sostanza ora ogni rotazione genera un nuovo maskPath
// e ne lascia uno vecchio. Quello vecchio tra l'altro risulta ancora attivo (anche se invisibile) e risponde al click selezionando l'item relativo.
// Quindi se un item viene ruotato un po' di volte, lascia "tracce" per la sua selezioen in giro per il cavas.
// Inoltre, essendo l'item serializzato per il salvataggio su DB, anche questi item collegati finiscono nella serializzazione, senza motivo, visto
// che ad esempio il maskPath serve solo per indicare la presenza dell'item fuori dall'area di stampa e può essere rigenerato all'occorrenza.
// Per ho risolto il problema che si genera nella rotazione evitando la proliferazione di path orfani di guerra.
createMaskForItem:function(item){if(item.data&&(item.data.isImageForBackground||item.data.isAreaForBackground))return;var root=this.getRootDesignItemCanvasItem(item);if(root&&root.data){// Update mask path on selection
var intersectingAreas=this.getAreasIntersectingItem(root);var containingAreas=this.getAreasContainingItem(root);var outside=intersectingAreas.length==0&&containingAreas.length==0;if(root.data.maskPath)root.data.maskPath.remove();// Create mask path as invisible
root.data.maskPath=new this.paper.Path.Rectangle(root.bounds);root.data.maskPath.strokeWidth=2;root.data.maskPath.strokeColor="blue";root.data.maskPath.dashArray=[4,10];root.data.maskPath.isMaskPath=true;root.data.maskPath.item=root;root.data.maskPath.visible=false;// Show if we have not selected the item and we are outside
if(!root.data.selected&&outside&&this.itemCanBeTransformed(item)){root.data.maskPath.visible=true;}}},removeMaskForItem:function(item){var root=this.getRootDesignItemCanvasItem(item);if(root&&root.data&&root.data.maskPath)root.data.maskPath.remove();},createMaskAlertForItem:function(item){var root=this.getRootDesignItemCanvasItem(item);// Update mask path on selection
if(root.data.maskAlertPath)root.data.maskAlertPath.remove();// Create mask path as invisible
root.data.maskAlertPath=new this.paper.Path.Rectangle(root.bounds);root.data.maskAlertPath.strokeWidth=3;root.data.maskAlertPath.strokeColor="red";root.data.maskAlertPath.dashArray=[4,10];root.data.maskAlertPath.isMaskAlertPath=true;root.data.maskAlertPath.item=root;root.data.maskAlertPath.data.isMaskAlertPath=true;},canAddDashedEdge:function(item){//It is not possible to apply the dashed edge:
if(!this.design||this.design.get("templateDesignID")<=0//if is a pre-design template
||!this.canEditItem(item)//if the element is not editable
||!item.data.isTemplateElement//if the item in not a template element
||item.data&&(item.data.isImageForBackground||item.data.isAreaForBackground))//if the item is a image or area for background
{return false;}//show only if the dashed edge option is enabled
return this.showDashedEdge;},createDashedEdgeForItem:function(item){if(this.canAddDashedEdge(item)&&!this.isViewer){var root=this.getRootDesignItemCanvasItem(item);if(root.data.dashedEdgeID>0){this.removeDashedEdgeForItem(root);}if(!root.data.maskPath.visible){var dashedEdge=new this.paper.Path.Rectangle(root.bounds);dashedEdge.strokeWidth=2;dashedEdge.strokeColor=this.DashedEdgeColor;dashedEdge.dashArray=[10,10];dashedEdge.visible=true;root.data.dashedEdgeID=dashedEdge.id;this.masterGroup.addChild(dashedEdge);dashedEdge.insertBelow(root);dashedEdge.data.isDashedEdge=true;}}},removeDashedEdgeForItem:function(item){var root=this.getRootDesignItemCanvasItem(item);if(root&&root.data&&root.data.dashedEdgeID>0){var dashedEdge=this.paper.project.getItem({id:root.data.dashedEdgeID});if(dashedEdge){dashedEdge.remove();root.data.dashedEdgeID=-1;}}},groupSelectedItems:function(){var selected=this.getSelectedItems();if(selected.length==0)return;var group=new this.paper.Group();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;group.addChild(item);}this.setItemSelection(group,true);this.updateSelectionState();this.paper.project.view.update();return group;},ungroupSelectedItems:function(){var selected=this.getSelectedItems();if(selected.length==0)return;for(var i=0;i<selected.length;i++){var item=selected[i];if(!(item instanceof this.paper.Group))continue;this.ungroup(item);}this.updateSelectionState();this.paper.project.view.update();},ungroup:function(group){this.setItemSelection(group,false);if(group&&group instanceof this.paper.Group){while(group.children.length>0){var item=group.children.pop();item.parent=this.paper.project.activeLayer;this.setItemSelection(item,true);}group.remove();}},// Returns serialized positions of selected items.
captureSelectionPosition:function(){var positions=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;if(this.isItemChild(item))continue;var itemsToChange=this.getSubItemsToChange(item);var orig=[];itemsToChange.forEach(function(itemToChange){orig.push({id:itemToChange.id,position:itemToChange.position});});positions.push(orig);}return positions;},// Restore the positions of selected items.
restoreSelectionPosition:function(originalPositions){for(var i=0;i<originalPositions.length;i++){var orig=originalPositions[i];for(var j=0;j<orig.length;j++){var element=orig[j];var item=this.findItemById(element.id);if(!item){console.log("ITEM NOT FOUND!");}if(!item)continue;item.position=element.position;}}},// Returns serialized contents of selected items.
captureSelectionState:function(){var originalContent=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];var itemsToChange=this.getSubItemsToChange(item);if(item.guide)continue;//if (this.isItemChild(item)) continue;
this.removeMaskForItem(item);var raster=this.getMaskedImageRasterItem(item);var orig=[];itemsToChange.forEach(function(itemToChange){orig.push({id:itemToChange.id,applyMatrix:itemToChange.applyMatrix,json:itemToChange.exportJSON({asString:false}),matrix:itemToChange.matrix.clone(),selectedSegments:[],boundsItemMatrix:itemToChange.data&&itemToChange.data.originalMatrix?itemToChange.data.originalMatrix.clone():null,boundsItemPosition:itemToChange.data&&itemToChange.data.originalPosition?itemToChange.data.originalPosition.clone():null});});originalContent.push(orig);}return originalContent;},// Restore the state of selected items.
restoreSelectionState:function(originalContent){// TODO: could use findItemById() instead.
for(var i=0;i<originalContent.length;i++){var orig=originalContent[i];for(var j=0;j<orig.length;j++){var element=orig[j];var item=this.findItemById(element.id);if(!item)continue;if(element.applyMatrix){// HACK: paper does not retain item IDs after importJSON,
// store the ID here, and restore after deserialization.
var id=item.id;item.importJSON(element.json);item._id=id;}else{item.matrix.set(element.matrix.a,element.matrix.b,element.matrix.c,element.matrix.d,element.matrix.tx,element.matrix.ty);}// Image Original Bounds & Matrix
if(item.data.originalBounds&&item.data.originalMatrix&&element.boundsItemMatrix){item.data.originalMatrix=element.boundsItemMatrix.clone();}if(item.data.originalPosition&&item.data.originalPosition&&element.boundsItemPosition){item.data.originalPosition=element.boundsItemPosition.clone();}}}},captureSelectionMatrix:function(){var originalMatrix=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];var refItem=item;if(this.isMaskedImage(item)){refItem=this.getReferenceItemForSelectedItem(item);}else{if(item.guide)continue;if(this.isItemChild(item))continue;}var raster=this.getMaskedImageRasterItem(item);var orig={id:item.id,refId:refItem.id,matrix:refItem.matrix.clone(),selectedSegments:[],boundsItemMatrix:item.data.originalMatrix?item.data.originalMatrix.clone():null,boundsRasterMatrix:raster&&raster.data.originalMatrix?raster.data.originalMatrix.clone():null};originalMatrix.push(orig);}return originalMatrix;},// Restore the state of selected items.
restoreSelectionMatrix:function(originalMatrix){// TODO: could use findItemById() instead.
for(var i=0;i<originalMatrix.length;i++){var orig=originalMatrix[i];var item=this.findItemById(orig.id);var refItem=this.findItemById(orig.refId);if(!item)continue;if(!refItem)continue;refItem.matrix.set(orig.matrix.a,orig.matrix.c,orig.matrix.b,orig.matrix.d,orig.matrix.tx,orig.matrix.ty);// Image Original Bounds & Matrix
if(item.data&&item.data.originalMatrix){item.data.originalMatrix=orig.boundsItemMatrix.clone();}var raster=this.getMaskedImageRasterItem(item);if(raster&&raster.data.originalMatrix&&orig.boundsRasterMatrix){raster.data.originalMatrix=orig.boundsRasterMatrix.clone();}// -------------------------            
}},deselectAll:function(){var items=this.getSelectedItems();this.fireDeselectionChangedEvent(items);this.deselectGridBoxes();for(var i=0;i<items.length;i++){var item=items[i];if(item.data&&item.data.selected)this.setItemSelection(item,false);//item.data.selected = false;
}this.paper.project.deselectAll();// If we don't have a side image don't hide the areas
this.hideAreaItems();if(this.labelLayer&&this.labelLayer.visible)this.labelLayer.visible=false;},selectItems:function(items){this.deselectAll();if(items&&Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){var item=items[i];if(item)this.setItemSelection(item,true);}}this.updateSelectionState();this.paper.project.view.update();},// Returns bounding box of all selected items.
getSelectionBounds:function(){var bounds=null;var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];var itemBounds=this.getItemBounds(item);if(bounds==null)bounds=itemBounds.clone();else bounds=bounds.unite(itemBounds);}return bounds;},// Return the first selected item
getSelectedItem:function(){var items=this.getSelectedItems();if(items.length>0)return items[0];return null;},isItemSelected:function(item){var selectedItems=this.getSelectedItems();for(var i=0;i<selectedItems.length;i++){var selectedItem=selectedItems[i];if(selectedItem===item)return true;}return false;},getSelectedItems:function(){var items=[];var addSelectedChildren=function(parent){if(parent.guide)return;if(parent.data&&parent.data.isArea)return;if(parent.data&&parent.data.selected)items.push(parent);if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];addSelectedChildren(child);}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;addSelectedChildren(layer);}return items;},getSelectedSimpleItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;if(item instanceof this.paper.Group)continue;if(item.parent&&this.isItemGroup(item.parent))continue;items.push(item);}return items;},getSelectedGroupItems:function(){var groups=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;if(this.isItemGroup(item))groups.push(item);}return groups;},getSelectedTextItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;if(item instanceof this.paper.TextItem)items.push(item);else if(item&&item.data&&item.data.isTextOnPath)items.push(item);else if(item&&item.data&&item.data.isTextArea)items.push(item);}return items;},getDefaultTextItemInfo:function(){var info={};info.text="";info.strokeColor="black";info.strokeWidth=0;info.fillColor="black";info.fontFamily="Arial";info.fontSize=18;info.fontWeight="normal";info.fontStyle="normal";info.fontStretch="normal";info.justification="center";info.isTextOnPath=false;info.isTextArea=false;info.isTextBox=false;info.adaptText=false;info.letterSpacing=0;info.lineSpacing=0;info.scaling=1;info.verticalAlignment="top";info.shadowColor=null;info.shadowBlur=0;info.shadowDistance=7;info.shadowAngle=45;return info;},getTextItemInfo:function(item){var info=this.getDefaultTextItemInfo();if(item instanceof this.paper.TextItem){info.text=item.content;info.strokeColor=item.strokeColor.toCSS(true);info.strokeWidth=item.strokeWidth;info.fillColor=item.fillColor.toCSS(true);info.fontFamily=item.fontFamily;info.fontSize=item.fontSize;info.fontWeight=item.fontWeight;info.fontStyle=item.fontStyle;info.fontStretch=item.fontStretch;info.justification=item.justification;info.scaling=item.scaling;info.shadowColor=item.shadowColor;info.shadowBlur=item.shadowBlur;info.shadowDistance=this.getOffsetDistance(item.shadowOffset);info.shadowAngle=this.getOffsetAngle(item.shadowOffset);info.letterSpacing=item.letterSpacing;info.lineSpacing=item.lineSpacing;}else if(item&&item.data&&item.data.isTextOnPath){if(item.children.length>0){var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){str+=item.children[i].content;}}info.text=str;info.isTextOnPath=item.data&&item.data.isTextOnPath;info.isTextArea=item.data&&item.data.isTextArea;info.isTextBox=item.data&&item.data.isTextBox;info.adaptText=item.data&&item.data.adaptText;info.strokeColor=item.children[0].strokeColor;info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor;info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontStyle=item.children[0].fontStyle;info.fontStretch=item.children[0].fontStretch;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.justification=item.data.isTextArea?item.data.justification:undefined;info.shadowColor=item.children[0].shadowColor;info.shadowblur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);}}else if(item&&item.data&&item.data.isTextArea){info=this.getTextAreaItemInfo(item,null);}info.isPlaceHolder=item.data&&item.data.isPlaceHolder||false;if(item.data.hasOwnProperty("originalStrokeColor"))info.strokeColor=item.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))info.fillColor=item.data.originalFillColor;if(item.data.hasOwnProperty("originalShadowColor"))info.shadowColor=item.data.originalShadowColor;if(item.data.hasOwnProperty("adaptText"))info.adaptText=item.data.adaptText;if(item.data.hasOwnProperty("letterSpacing"))info.letterSpacing=item.data.letterSpacing;if(item.data.hasOwnProperty("lineSpacing"))info.lineSpacing=item.data.lineSpacing;// Remove font family quotes
info.fontFamily=info.fontFamily.replace(/"/g,"");return info;},getSelectedTextItemsInfo:function(){var info=this.getDefaultTextItemInfo();var items=this.getSelectedTextItems();if(items&&items.length==1){var item=items[0];info=this.getTextItemInfo(item);}// Remove font family quotes
info.fontFamily=info.fontFamily.replace(/"/g,"");return info;},getSelectedTextItemsNotOnPath:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;if(item instanceof this.paper.TextItem)items.push(item);}return items;},getSelectedTextOnPathItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isTextOnPath)items.push(item);}return items;},getSelectedTextAreaItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isTextArea)items.push(item);}return items;},getSelectedSimpleTextAreaItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isTextArea&&!item.data.isTextBox)items.push(item);}return items;},getSelectedTextBoxItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isTextArea&&item.data.isTextBox)items.push(item);}return items;},getSelectedTextArtItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isTextArt)items.push(item);}return items;},getSelectedShapeItems:function(){var items=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;else if(item&&item.data&&item.data.isShape)items.push(item);}return items;},getSelectedImageItems:function(){var imageItems=[];var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];var raster=this.getMaskedImageRasterItem(item);if(raster&&item.data&&item.data.guid&&!item.data.isArea){imageItems.push(item);}}return imageItems;},getSelectedMaskedImageItems:function(){var _this_1=this;return this.getSelectedImageItems().filter(function(i){return _this_1.isMaskedImage(i);});},getSelectedFilledShapesItems:function(){var _this_1=this;return this.getSelectedImageItems().filter(function(i){return _this_1.isFilledShape(i);});},getSelectedItemsCommonImageID:function(){var imageID=null;var items=this.getSelectedImageItems();for(var i=0;i<items.length;i++){var item=items[i];var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){var id=designItem.get("imageID");if(imageID==null)imageID=id;else if(id!=imageID)return null;}}return imageID;},getSelectedDesignItems:function(){var designItems=[];var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];var designItem=this.findDesignItemForItem(item);if(item){designItems.push(designItem);}}return designItems;},countTextItems:function(){var count=0;var customizer=this;function countChildren(item){if(customizer.isItemGroup(item)&&item!=customizer.masterGroup)return;if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide&&(child instanceof this.paper.TextItem||child.data&&child.data.isTextOnPath||child.data&&child.data.isTextArea))count++;countChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)countChildren(layer);}return count;},countImageItems:function(){var count=0;var customizer=this;function countChildren(item){if(customizer.isItemGroup(item)&&!this.isMaskedImage(item)&&!this.isMaskedImageClipGroup(item)&&item!=customizer.masterGroup)return;if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(child&&child instanceof this.paper.Raster&&child.data&&child.data.guid&&!child.data.isArea)count++;countChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)countChildren(layer);}return count;},countTextArtItems:function(){var count=0;var customizer=this;function countChildren(item){if(customizer.isItemGroup(item)&&item!=customizer.masterGroup)return;if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(child&&child.data&&child.data.isTextArt)count++;countChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)countChildren(layer);}return count;},getItemsInfo:function(){var infoArray=[];var customizer=this;function checkChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(child&&!child.guide){var itemInfo=null;var designItem=customizer.findDesignItemForItem(child);if(designItem){var designItemShape=designItem.get("shape");var raster=customizer.getMaskedImageRasterItem(child);var shape=customizer.getMaskedImageShapeItem(child);if(child instanceof this.paper.TextItem||child.data&&child.data.isTextOnPath||child.data&&child.data.isTextArea){// Text Item
itemInfo=new MPlaza.TextItemInfo(designItem,child);var info=customizer.getTextItemInfo(child);itemInfo.sideID=designItem.get("areas").at(0).get("sideID");itemInfo.text=info.text;itemInfo.strokeColor=info.strokeColor;itemInfo.strokeWidth=info.strokeWidth;itemInfo.fillColor=info.fillColor instanceof paper.Color?info.fillColor.toCSS(true):info.fillColor;itemInfo.fontFamily=info.fontFamily;itemInfo.fontSize=info.fontSize;itemInfo.fontWeight=info.fontWeight;itemInfo.fontStyle=info.fontStyle;itemInfo.fontStretch=info.fontStretch;itemInfo.justification=info.justification;itemInfo.isTextOnPath=info.isTextOnPath;itemInfo.isTextArea=info.isTextArea;itemInfo.adaptText=info.adaptText;itemInfo.letterSpacing=info.letterSpacing;itemInfo.lineSpacing=info.lineSpacing;itemInfo.scaling=info.scaling;itemInfo.shadowColor=info.shadowColor;itemInfo.shadowBlur=info.shadowBlur;itemInfo.shadowDistance=customizer.getOffsetDistance(info.shadowOffset);itemInfo.shadowAngle=customizer.getOffsetAngle(info.shadowOffset);}else if(raster&&child.data&&child.data.guid&&!child.data.isArea){// Image Item (maybe masked Image)
itemInfo=new MPlaza.ImageItemInfo(designItem,child);itemInfo.imageID=designItem.get("imageID");itemInfo.sideID=designItem.get("areas").at(0).get("sideID");itemInfo.url=raster.data.originalUrl||raster.source;itemInfo.visible=child.visible;itemInfo.isMasked=customizer.isMaskedImage(child);itemInfo.maskID=designItemShape?designItemShape.get("shapeID"):undefined;if(shape){itemInfo.maskStyle.strokeColor=shape.strokeColor?shape.strokeColor.toCSS(true):undefined;itemInfo.maskStyle.strokeWidth=shape.strokeWidth;itemInfo.maskStyle.strokeCap=shape.strokeCap;itemInfo.maskStyle.strokeJoin=shape.strokeJoin;itemInfo.maskStyle.dashArray=shape.dashArray;itemInfo.maskStyle.dashOffset=shape.dashOffset;if(shape.data.hasOwnProperty("originalStrokeColor"))itemInfo.maskStyle.strokeColor=shape.data.originalStrokeColor;}}else if(child.data&&child.data.isTextArt){itemInfo=customizer.getTextArtItemInfo(child);}}if(itemInfo!=null){itemInfo.constraints=(designItem.get("constraints")||new MPlaza.DesignItemConstraints()).toJSON();infoArray.push(itemInfo);}}checkChildren(child);}}}for(var i=0;i<customizer.paper.project.layers.length;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)checkChildren(layer);}return infoArray;},// Restituisce gli areaItem contenenti gli item selezionati
getSelectedAreaItems:function(){var areaItems=[];var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];var areas=this.getAreasIntersectingOrContainingItem(item);for(var j=0;j<areas.length;j++){var area=areas[j];var areaItem=this.findItemForArea(area);if(areaItem)areaItems.push(areaItem);}}return areaItems;},log:function(msg){Logger.info(msg);if($("#logMsg").length){$("#logMsg").text(msg);}},appendLog:function(msg){var text=$("#logMsg").text();if(text){text+="\n";}text+=msg;Logger.info(msg);$("#logMsg").text(text);},getTextArtItemInfo:function(item){if(item&&item.data&&item.data.isTextArt){var designItem=this.findDesignItemForItem(item);if(designItem){var info=new MPlaza.TextArtItemInfo(designItem,item);var textArt=designItem.get("textArt");info.text=textArt.get("text");info.fontFamilyID=textArt.get("fontFamilyID");info.fontFaceID=textArt.get("fontFaceID");info.textArtTypeID=textArt.get("textArtTypeID");if(item instanceof this.paper.Item){if(item.strokeColor)info.style.strokeColor=item.strokeColor.toCSS(true);info.style.strokeWidth=item.strokeWidth;info.style.strokeCap=item.strokeCap;info.style.strokeJoin=item.strokeJoin;info.style.dashArray=item.dashArray;info.style.dashOffset=item.dashOffset;if(item.fillColor)info.style.fillColor=item.fillColor.toCSS(true);if(item.data.hasOwnProperty("originalStrokeColor"))info.style.strokeColor=item.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))info.style.fillColor=item.data.originalFillColor;if(item.shadowColor)info.style.shadowColor=item.shadowColor.toCSS(true);info.style.shadowBlur=item.shadowBlur||0;info.style.shadowDistance=this.getOffsetDistance(item.shadowOffset);info.style.shadowAngle=this.getOffsetAngle(item.shadowOffset);}var config=textArt.get("config");info.config.angleValue=config.get("angleValue");info.config.curveValue=config.get("curveValue");info.config.intensT=config.get("intensT");info.config.intensB=config.get("intensB");info.config.isTriangle=config.get("isTriangle");info.config.isBridge=config.get("isBridge");info.config.isTop=config.get("isTop");info.config.isBottom=config.get("isBottom");info.config.isMiddle=config.get("isMiddle");return info;}}return null;},getTextArtItemText:function(item){if(item&&item.data&&item.data.isTextArt){var designItem=this.findDesignItemForItem(item);if(designItem){var textArt=designItem.get("textArt");return textArt.get("text");}}return null;},getImageItemInfo:function(item){var itemInfo=null;if(item&&item.data&&item.data.guid&&!item.guide&&!item.data.isArea){var designItem=this.findDesignItemForItem(item);if(designItem){var designItemShape=designItem.get("shape");var raster=this.getMaskedImageRasterItem(item);var shape=this.getMaskedImageShapeItem(item);if(raster){// Image Item (maybe masked Image)
itemInfo=new MPlaza.ImageItemInfo(designItem,item);itemInfo.imageID=designItem.get("imageID");itemInfo.sideID=designItem.get("areas").at(0).get("sideID");itemInfo.url=raster.data.originalUrl||raster.source;itemInfo.visible=item.visible;itemInfo.isMasked=this.isMaskedImage(item);itemInfo.maskID=designItemShape?designItemShape.get("shapeID"):undefined;itemInfo.maskStyle=this.getMaskedImageMaskPathStyle(item);}itemInfo.constraints=(designItem.get("constraints")||new MPlaza.DesignItemConstraints()).toJSON();}}return itemInfo;},getShapeItemInfo:function(item){var itemInfo=null;if(item&&(this.isShape(item)||this.isFilledShape(item))){var designItem=this.findDesignItemForItem(item);if(designItem){var designItemShape=designItem.get("shape");var shapeItem=null;if(this.isShape(item))shapeItem=item;else shapeItem=this.getMaskedImageShapeItem(item);if(shapeItem){itemInfo=new MPlaza.ShapeItemInfo(designItem,item);itemInfo.style=this.getShapeItemStyle(shapeItem);itemInfo.isImagePlaceholder=shapeItem.data.isImagePlaceholder;itemInfo.fillerImageID=designItem.get("imageID");}}}return itemInfo;},// -------------------------------------------------------------
// Touch events
// -------------------------------------------------------------
onTouchStart:function(event){this.touchEnabled=true;event.preventDefault();if(event.touches.length==1){var p=this.windowToCanvas(event.touches[0].clientX,event.touches[0].clientY);var point=new this.paper.Point(p.x,p.y);point=this.paper.project.view.viewToProject(point);this.hitTest(point);this.hitTestEnabled=false;this.interactionMode=MPlaza.CustomizerInteractionMode.Create;if(this.elementType==MPlaza.CustomizerElementType.None)this.interactionMode=MPlaza.CustomizerInteractionMode.Select;this.mouseStartPos=point.clone();this.adjustmentDelta=null;this.mouseLastPos=point.clone();this.element=null;this.captureInitialSelectionState(point);if(this.hitItem){this.beginDesignOperation();if(this.hitItem.data&&this.hitItem.data.isTextOnPathFirstEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathFirstEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextOnPathMiddleEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathMiddleEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextOnPathLastEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathLastEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaTopEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaTopEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaRightEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaRightEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaBottomEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaBottomEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaLeftEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaLeftEnd;}else{var rootItem=this.getRootDesignItemCanvasItem(this.hitItem);if(rootItem){this.interactionMode=MPlaza.CustomizerInteractionMode.Select;}else if(this.hitItem==this.selectionMoveHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Move;}else if(this.hitItem==this.selectionRotateHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Rotate;}else if(this.hitItem==this.selectionResizeHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Resize;}else if(this.hitItem==this.selectionResizeTopHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeTop;}else if(this.hitItem==this.selectionResizeBottomHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeBottom;}else if(this.hitItem==this.selectionResizeLeftHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeLeft;}else if(this.hitItem==this.selectionResizeRightHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeRight;}else if(this.hitItem==this.selectionDeleteHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Delete;}}}}},onTouchEnd:function(event){this.endDesignOperation();this.hitTestEnabled=true;this.hideCenterLines();this.adjustmentDelta=null;var selected=this.getSelectedItems();if(this.interactionMode==MPlaza.CustomizerInteractionMode.Select){this.selectElement();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Create){this.onItemCreated(this.element);this.deselectAll();this.setItemSelection(this.element,true);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Move){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Rotate){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Resize){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeTop){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeBottom){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeLeft){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeRight){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Delete){this.deleteSelection();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Edit){this.editElement();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathFirstEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathMiddleEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathLastEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaTopEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaRightEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaBottomEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaLeftEnd){this.onItemsUpdated(selected);}this.updateSelectionState();this.paper.project.view.update();},onTap:function(event){alert("ok");/*
        var p = this.windowToCanvas(event.center.x, event.center.y);
        var point = new this.paper.Point(p.x, p.y);
        point = this.paper.project.view.viewToProject(point);
 
        var item = this.hitItem;
 
        if (!item || item == this.imageItem || (item.data && item.data.isArea)) {
            this.deselectAll();
        } else if (item == this.selectionDeleteHandle) {
            this.deleteSelection();
        } else {
            this.setItemSelection(item, true);
        }
        this.updateSelectionState();
        this.paper.project.view.update();
        */},onDoubleTap:function(event){//var p = this.windowToCanvas(event.center.x, event.center.y);
//var point = new this.paper.Point(p.x, p.y);
//point = this.paper.project.view.viewToProject(point);
//this.paper.view.zoom = 1;
//this.moveOriginToViewCenter();
this.fitToScreen(true,true);},onPan:function(event){event.preventDefault();var p=this.windowToCanvas(event.center.x,event.center.y);var point=new this.paper.Point(p.x,p.y);var selectedItems=this.getSelectedItems();point=this.paper.project.view.viewToProject(point);if(event.type=='panstart'){this.lastPanPoint.x=point.x;this.lastPanPoint.y=point.y;this.panOrigin=paper.view.center;// Remove alert items
this.removeAllAlertItems();this.removeSizeLimitAlert();}else if(event.type=="panend"){if(selectedItems.length>0){this.checkAlertItems(selectedItems[0]);}this.checkImagesSizeLimit();}var delta=point.subtract(this.lastPanPoint);this.lastPanPoint.x=point.x;this.lastPanPoint.y=point.y;var info=new MPlaza.PointingInfo();if(event.srcEvent){info.modifiers.option=event.srcEvent.altKey||false;info.modifiers.control=event.srcEvent.ctrlKey||false;info.modifiers.shift=event.srcEvent.shiftKey||false;}info.delta=delta;info.point=point;this.onPointerDrag(info);//this.dumpSelectionPosition();
this.paper.project.view.update();// If the selected item is nto movable, then we can move the view
var isNotMovableItem=selectedItems.length>0&&!this.canMoveItem(selectedItems[0])&&this.interactionMode==MPlaza.CustomizerInteractionMode.Move;if((selectedItems.length==0||isNotMovableItem)&&this.panOrigin&&!this.preventViewMoving){paper.view.center=this.panOrigin.subtract(new paper.Point(event.deltaX*1/paper.view.zoom,event.deltaY*1/paper.view.zoom));//paper.view.update(false);
}// Clamp view
this.clampView();},onPinch:function(event){try{// alert("ok");
//if (event.pointers.length < 2) return;
//var itemsBounds = this.getAllItemsBounds();
//var viewBounds = this.paper.project.view.bounds;
//var pointer1 = event.pointers[0];
//var pointer2 = event.pointers[1];
//var medX = (pointer1.clientX + pointer2.clientY) / 2;
//var medY = (pointer2.clientX + pointer2.clientY) / 2;
///*
//var allInBefore = viewBounds.contains(itemsBounds);
//if (event.deltaY < 0 && this.areAllItemsInView())
//    return;
//*/
// event.preventDefault();
//var zoomFactor = 1.3;
//var mousePosition = new this.paper.Point(medX, medY);
//mousePosition = this.paper.project.view.viewToProject(mousePosition);
//var zoomCenter = mousePosition.subtract(this.paper.view.center);
//var moveFactor = zoomFactor - 1.0;
//Logger.info(medX + " " + medY + " " + event.distance);
//if (event.distance > 0) {
//    this.paper.view.zoom *= zoomFactor;
//    this.paper.view.center = this.paper.view.center.add(zoomCenter.multiply(moveFactor / zoomFactor)); // Fisso al centro
//} else if (event.distance < 0) {
//    if (itemsBounds.width < viewBounds.width && itemsBounds.height < viewBounds.height)
//        return;
//    this.paper.view.zoom /= zoomFactor;
//    this.paper.view.center = this.paper.view.center.subtract(zoomCenter.multiply(moveFactor));  // Fisso al centro
//}
//this.hitItem = null;
//this.updateSelectionState();
//this.paper.project.view.update();
// new script
// alert(event.type);
var itemsBounds=this.getAllItemsBounds();var viewBounds=this.paper.project.view.bounds;if(this.zooming||!itemsBounds||!viewBounds)return;if(event.type=="pinchstart")this.oldScale=event.scale;var newScale=event.scale-this.oldScale;this.oldScale=event.scale;if(event.pointers.length<2)return;var zoomFactor=1+Math.abs(newScale);var mousePosition=new paper.Point(event.center.x,event.center.y);mousePosition=paper.project.view.viewToProject(mousePosition);var zoomCenter=mousePosition.subtract(paper.view.center);var moveFactor=zoomFactor-1.0;if(newScale>0){if(paper.view.zoom>=1.1)return;paper.view.zoom*=zoomFactor;paper.view.center=paper.view.center.add(zoomCenter.multiply(moveFactor/zoomFactor));}else if(newScale<0){if(itemsBounds.width<viewBounds.width-100&&itemsBounds.height<viewBounds.height-100)return;paper.view.zoom/=zoomFactor;paper.view.center=paper.view.center.subtract(zoomCenter.multiply(moveFactor));}this.preventViewMoving=false;// Update alert items
this.checkAllAlertItems();this.checkImagesSizeLimit();this.clampView();}catch(exc){alert(exc);}/*
        var p = this.windowToCanvas(event.center.x, event.center.y);
        var point = new this.paper.Point(p.x, p.y);
        point = this.paper.project.view.viewToProject(point);
 
        if (event.type == 'pinchstart') {
            //this.pinchScale = 1;
        }
 
        if (this.selectionBounds && this.selectionBounds.contains(point) &&
            this.originalCenter && this.originalContent) {
            var scale = event.scale;
            var pivot = this.originalCenter.clone();
            this.restoreSelectionState(this.originalContent);
            this.scaleSelectedItems(scale, scale, pivot);
        }
        */},onRotate:function(event){},// -------------------------------------------------------------
// Mouse Events
// -------------------------------------------------------------
dumpSelectionPosition:function(){var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];Logger.info("item_"+item._id+" - x: "+item.position.x+" - y: "+item.position.y);}},onMouseDown:function(event){if(this.touchEnabled)return;this.hitTest(event.point);this.hitTestEnabled=false;this.interactionMode=MPlaza.CustomizerInteractionMode.Create;if(this.elementType==MPlaza.CustomizerElementType.None)this.interactionMode=MPlaza.CustomizerInteractionMode.Select;this.mouseStartPos=event.point.clone();this.adjustmentDelta=null;this.mouseLastPos=event.point.clone();this.element=null;this.captureInitialSelectionState(event.point);if(this.hitItem){this.beginDesignOperation();if(this.hitItem.data&&this.hitItem.data.isTextOnPathFirstEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathFirstEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextOnPathMiddleEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathMiddleEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextOnPathLastEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextOnPathLastEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaTopEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaTopEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaRightEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaRightEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaBottomEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaBottomEnd;}else if(this.hitItem.data&&this.hitItem.data.isTextAreaLeftEndHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.MoveTextAreaLeftEnd;}else if(this.hitItem.data&&this.hitItem.data.isImageForBackground){this.interactionMode=MPlaza.CustomizerInteractionMode.Select;}else if(this.hitItem.data&&(this.hitItem.data.isGridIcon||this.hitItem.data.isGridImage)){this.interactionMode=MPlaza.CustomizerInteractionMode.SelectedGridImage;}else if(this.hitItem.data&&this.hitItem.data.isShapePlaceholderIcon){this.fireFillShapeRequestedEvent({itemGuid:this.hitItem.data.shapeGuid});}else{var rootItem=this.getRootDesignItemCanvasItem(this.hitItem);if(rootItem){this.interactionMode=MPlaza.CustomizerInteractionMode.Select;}else if(this.hitItem==this.selectionMoveHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Move;}else if(this.hitItem==this.selectionRotateHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Rotate;}else if(this.hitItem==this.selectionResizeHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Resize;}else if(this.hitItem==this.selectionResizeTopHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeTop;}else if(this.hitItem==this.selectionResizeBottomHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeBottom;}else if(this.hitItem==this.selectionResizeLeftHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeLeft;}else if(this.hitItem==this.selectionResizeRightHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.ResizeRight;}else if(this.hitItem==this.selectionDeleteHandle){this.interactionMode=MPlaza.CustomizerInteractionMode.Delete;}}}},onMouseMove:function(event){if(this.hitTestEnabled)this.hitTest(event.point);},onMouseDrag:function(event){event.preventDefault();var info=new MPlaza.PointingInfo();info.modifiers.option=event.modifiers.option;info.modifiers.control=event.modifiers.control;info.modifiers.shift=event.modifiers.shift;info.delta=event.delta;info.point=event.point;//Logger.info("onMouseDrag - point: " + event.point + " - delta: " + event.delta);
this.onPointerDrag(info);//this.dumpSelectionPosition();
},onPointerDrag:function(info){this.hitTestEnabled=false;if(this.labelLayer&&this.labelLayer.visible){this.labelLayer.visible=false;}if(this.frozen)return;if(this.interactionMode==MPlaza.CustomizerInteractionMode.Select||this.interactionMode==MPlaza.CustomizerInteractionMode.SelectedGridImage){this.selectElement();this.updateSelectionState();this.captureInitialSelectionState(info.point);this.interactionMode=MPlaza.CustomizerInteractionMode.Move;}if(this.interactionMode==MPlaza.CustomizerInteractionMode.Create){if(this.elementType!=MPlaza.CustomizerElementType.Text)this.createElement(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Move){this.moveSelection(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Rotate){this.rotateSelection(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Resize){this.resizeSelection(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeTop){this.resizeSelectionTop(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeBottom){this.resizeSelectionBottom(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeLeft){this.resizeSelectionLeft(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeRight){this.resizeSelectionRight(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathFirstEnd){this.moveTextOnPathFirstEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathMiddleEnd){this.moveTextOnPathMiddleEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathLastEnd){this.moveTextOnPathLastEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaTopEnd){this.moveTextAreaTopEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaRightEnd){this.moveTextAreaRightEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaBottomEnd){this.moveTextAreaBottomEnd(info);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaLeftEnd){this.moveTextAreaLeftEnd(info);}},onMouseUp:function(event){//Logger.info("onMouseUp - point: " + event.point + " - delta: " + event.delta);
this.hitTestEnabled=true;this.hideCenterLines();this.adjustmentDelta=null;var selected=this.getSelectedItems();var info=new MPlaza.PointingInfo();info.delta=event.delta;info.point=event.point;if(this.interactionMode==MPlaza.CustomizerInteractionMode.Select){this.switchMaskedImageSelectionMode(event);this.selectElement();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Create){if(this.elementType==MPlaza.CustomizerElementType.Text){this.createElement(info);}else{this.onItemCreated(this.element);this.deselectAll();this.setItemSelection(this.element,true);}}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Move){// TEST
//this.restoreSelectionState(this.originalContent); // Provo ad annullare lo spostamento
this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Rotate){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Resize){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeTop){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeBottom){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeLeft){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.ResizeRight){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Delete){this.deleteSelection();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.Edit){this.editElement();}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathFirstEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathMiddleEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextOnPathLastEnd){this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaTopEnd){this.onTextAreaGuidesUpdated(this.interactionMode);this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaRightEnd){this.onTextAreaGuidesUpdated(this.interactionMode);this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaBottomEnd){this.onTextAreaGuidesUpdated(this.interactionMode);this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.MoveTextAreaLeftEnd){this.onTextAreaGuidesUpdated(this.interactionMode);this.onItemsUpdated(selected);}else if(this.interactionMode==MPlaza.CustomizerInteractionMode.SelectedGridImage){if(this.hitItem.data.isGridImage){this.switchMaskedImageSelectionMode(event);this.selectElement();}else this.deselectAll();this.onGridImageSelected(this.hitItem);this.onItemsUpdated(selected);}this.forceSelectedTextAreasToBounds();this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();},hitTest:function(point){if(this.frozen)return;//var hitSize = 4.0; // / this.paper.view.zoom;
//var hitSize = 8;
var hitSize=8;if(this.isMobile&&(this.getSelectedTextItemsInfo().isTextOnPath||this.getSelectedTextItemsInfo().isTextArea))hitSize=25/this.paper.view.zoom;var customizer=this;this.hitItem=null;// Hit test items.
if(point&&this.paper.project.layers.length>1){var hit=this.paper.project.layers[1].hitTestAll(point,{fill:true,stroke:true,tolerance:hitSize,match:function(hit){// Ignore transparent pixels if we have an item inside an hole
if(hit.item instanceof customizer.paper.Raster){if(hit.item.getPixel(hit.offset.x,hit.offset.y).alpha==0)return false;}if(hit.item&&hit.item.data&&hit.item.data.guid&&customizer.isItemStatic(hit.item))return false;if(hit.item&&hit.item.data&&hit.item.data.isAreaForBackground)return false;if(hit.item&&hit.item.data&&hit.item.data.isGridBorderPath)return false;if(hit.item&&hit.item.data&&hit.item.data.isMaskAlertPath)return false;if(customizer.mask&&hit.item==customizer.mask||hit.item.isClippingArea)return false;return true;}});if(hit&&hit.length>0){this.hitItem=hit[0].item;}else{// Check if we clicked a maskPath
var items=this.getAllItems();for(var i=0;i<items.length;i++){var mask=items[i];if(mask.isMaskPath&&mask.contains(point)){if(!mask.visibile&&mask.item)this.hitItem=mask.item;else this.hitItem=mask;return;}}}}// Set cursor....
},captureInitialSelectionState:function(point){if(this.selectionBounds){this.originalPositions=this.captureSelectionPosition();this.originalContent=this.captureSelectionState();this.pivot=this.selectionBounds.center.clone();this.corner=this.selectionBounds.bottomRight.clone();this.cornerLeft=this.selectionBounds.leftCenter;this.cornerRight=this.selectionBounds.rightCenter;this.cornerTop=this.selectionBounds.topCenter;this.cornerBottom=this.selectionBounds.bottomCenter;this.originalSize=this.corner.subtract(this.pivot);this.originalCenter=this.selectionBounds.center;this.originalScaleCenter=this.selectionBounds.center;// Attenzione! Per le TextBox il centro di rotazione è il centro del rettangolo contentinitore
var selItems=this.getSelectedItems();if(selItems&&selItems.length==1){var selectedItem=selItems[0];if(selectedItem.data&&selectedItem.data.rect){this.originalCenter=selectedItem.data.rect.center;}}this.originalShape=this.selectionBoundsShape.exportJSON({asString:false});var delta=point.subtract(this.originalCenter);this.originalAngle=Math.atan2(delta.y,delta.x);// Snap cache (only one item at time)
var items=this.getAllItems();var selectedItems=this.getSelectedItems();var areaItems=[];var area=selectedItems.length==1?this.getItemArea(selectedItems[0]):null;// Get area items
for(var i=0;i<items.length;i++){var item=items[i];if(item&&item.data&&item.data.guid&&!item.data.isArea&&!item.guide&&item!=selectedItems[0]&&!item.data.isGroupForBackground&&!item.data.isClippingAreaForBackground&&!item.data.isImageForBackground){var designItem=this.findDesignItemForItem(item);if(designItem.inOnArea(area))areaItems.push(item);}}this.snapCache={selectedItems:selectedItems,areaItems:areaItems,area:area,areaItem:this.findItemForArea(area)};}},clampView:function(){return;/*
        if (!this.imageItem)
            return;
 
        // Clamp position
        var clampDeltaX = 0;
        var clampDeltaY = 0;
 
        // Horizontal clamp
        if (this.imageItem.bounds.width <= paper.view.bounds.width) {
            if (paper.view.bounds.left > this.imageItem.bounds.left) {
                clampDeltaX = paper.view.bounds.left - this.imageItem.bounds.left;
            }
 
            if (paper.view.bounds.right < this.imageItem.bounds.right) {
                clampDeltaX = paper.view.bounds.right - this.imageItem.bounds.right;
            }
        } else {
            if (paper.view.bounds.left < this.imageItem.bounds.left) {
                clampDeltaX = paper.view.bounds.left - this.imageItem.bounds.left;
            }
 
            if (paper.view.bounds.right > this.imageItem.bounds.right) {
                clampDeltaX = paper.view.bounds.right - this.imageItem.bounds.right;
            }
        }
 
        // Vertical clamp
        if (this.imageItem.bounds.height <= paper.view.bounds.height) {
 
            if (paper.view.bounds.top > this.imageItem.bounds.top) {
                clampDeltaY = paper.view.bounds.top - this.imageItem.bounds.top;
            }
 
            if (paper.view.bounds.bottom < this.imageItem.bounds.bottom) {
                clampDeltaY = paper.view.bounds.bottom - this.imageItem.bounds.bottom;
            }
        } else {
            if (paper.view.bounds.top < this.imageItem.bounds.top) {
                clampDeltaY = paper.view.bounds.top - this.imageItem.bounds.top;
            }
 
            if (paper.view.bounds.bottom > this.imageItem.bounds.bottom) {
                clampDeltaY = paper.view.bounds.bottom - this.imageItem.bounds.bottom;
            }
        }
 
        paper.view.center = paper.view.center.subtract(new paper.Point(clampDeltaX, clampDeltaY));
 
        // Forced zoom reassign and resize event because zoom sometimes gives
        // problem with point mapping from canvas to paper coordinates
 
        this.paper.view.viewSize = [this.canvas.width, this.canvas.height];
        this.paper.view.zoom = this.paper.view.zoom;
        $(window).resize();*/},// -------------------------------------------------------------
// Keyboard Events
// -------------------------------------------------------------
onKeyDown:function(event){},onKeyUp:function(event){if(this.frozen)return;this.beginDesignOperation();event.preventDefault();event.stopPropagation();var d=1;if(event.modifiers.control)d=0.5;var isInputFocused=event.event&&event.event.target&&["INPUT","TEXTAREA"].indexOf(event.event.target.tagName)!=-1;if(event.key=="delete"&&!isInputFocused){this.deleteSelection();}else if(event.key=="right"&&!isInputFocused){this.moveSelectionByDelta(d,0);}else if(event.key=="left"&&!isInputFocused){this.moveSelectionByDelta(-d,0);}else if(event.key=="up"&&!isInputFocused){this.moveSelectionByDelta(0,-d);}else if(event.key=="down"&&!isInputFocused){this.moveSelectionByDelta(0,d);}this.endDesignOperation();},// -------------------------------------------------------------
// Element creation and modification
// -------------------------------------------------------------
getItemAtPoint:function(point){var item=null;var hitSize=4.0;if(this.paper.view.zoom>1)hitSize=0;var hit=null;var customizer=this;// Hit test items.
if(point){var hitTest=this.paper.project.hitTest(point,{fill:true,stroke:true,tolerance:hitSize,match:function(hit){if(customizer.mask&&hit.item==customizer.mask||hit.item.isClippingArea)return false;return true;}});if(hitTest.item){var rootItem=this.getRootDesignItemCanvasItem(hitTest.item);if(rootItem){item=rootItem;}else{item=hitTest.item;}}}return item;},selectItemAtPoint:function(point){if(!point)this.deselectAll();var item=this.getItemAtPoint(point);if(!item||item==this.imageItem||item.data&&item.data.isArea){this.deselectAll();return;}this.setItemSelection(item,true);},selectElement:function(){// 05/04/2017: Changed the code for avoid the re-firing of selection change event on the same element (if I click on already selected element)
if(this.hitItem){var rootItem=this.getRootDesignItemCanvasItem(this.hitItem);// Current selected item
var selectedItems=this.getSelectedItems();var selectedItem=selectedItems.length>0?selectedItems[0]:null;var designItem=this.findDesignItemForItem(rootItem);if(!designItem){if(this.hitItem.data&&this.hitItem.data.isArea)this.deselectAll();return;}// If the clicked item is not the current selected item
if(rootItem&&(selectedItem==null||selectedItem!=rootItem)){this.element=rootItem;if(this.isItemStatic(this.element)||rootItem.data&&(rootItem.data.isAreaForBackground||rootItem.data.isGroupForBackground||rootItem.data.isClippingAreaForBackground)){this.deselectAll();return;}this.deselectAll();this.setItemSelection(this.element,true);// Deselect previous selected item
if(selectedItem)this.setItemSelection(selectedItem,false);// Test font Size
//this.modifySelectedTextItemsTotalFontSizePt(10);
}}else{this.deselectAll();}},createElement:function(info){if(this.frozen||!this.mouseStartPos)return;this.beginDesignOperation();if(this.elementType==MPlaza.CustomizerElementType.Rectangle){this.createRectangle(info);}else if(this.elementType==MPlaza.CustomizerElementType.Oval){this.createEllipse(info);}else if(this.elementType==MPlaza.CustomizerElementType.Free){this.createFreeHand(info);}else if(this.elementType==MPlaza.CustomizerElementType.Text){this.createText(info);}this.endDesignOperation();},createRectangle:function(info){if(!info.point)return;var point=info.point;if(this.element)this.element.remove();if(this.mouseStartPos&&point){var p1=this.mouseStartPos;var p2=point;this.element=new this.paper.Path.Rectangle(p1,p2);this.element.strokeColor='black';this.element.strokeWidth=1.0;this.element.fillColor='lavender';Logger.info("Rectangle created");}this.paper.project.view.update();},createEllipse:function(info){if(!info.point)return;var point=info.point;if(this.element)this.element.remove();if(this.mouseStartPos&&point){var p1=this.mouseStartPos;var p2=point;var rectangle=new this.paper.Rectangle(p1,p2);this.element=new this.paper.Path.Ellipse(rectangle);this.element.strokeColor='black';this.element.strokeWidth=1.0;this.element.fillColor='lavender';Logger.info("Ellipse created");}this.paper.project.view.update();},createLine:function(info){if(!info.point)return;var point=info.point;if(this.element)this.element.remove();if(this.mouseStartPos&&point){var p1=this.mouseStartPos;var p2=point;this.element=new this.paper.Path.Line(p1,p2);this.element.strokeColor='black';this.element.strokeWidth=1.0;Logger.info("Line created");}this.paper.project.view.update();},createFreeHand:function(info){if(!info.point)return;var point=info.point;if(point){if(!this.element){this.element=new this.paper.Path();var rect=new this.paper.Rectangle(point.x-2,point.y-2,4,4);this.element.strokeColor='black';this.element.strokeWidth=1.0;this.element.fillColor='lavender';}this.element.add(point);this.paper.project.view.update();}},sendSelectionToBack:function(){this.beginDesignOperation();var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];item.sendToBack();}if(this.imageItem){this.imageItem.sendToBack();}this.onItemsUpdated(items);this.updateItemsIndexes();this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();},bringSelectionToFront:function(){this.beginDesignOperation();var items=this.getSelectedItems();for(var i=0;i<items.length;i++){var item=items[i];item.bringToFront();}this.onItemsUpdated(items);this.updateItemsIndexes();this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();},moveSelectionToCenter:function(){if(!this.canMoveSelection())return;this.beginDesignOperation();var selected=this.getSelectedItems();var area=null;for(var i=0;i<selected.length;i++){var item=selected[i];var areas=this.getAreasIntersectingOrContainingItem(item);if(areas.length>1||areas.length==0)return;if(area==null)area=areas[0];else if(area.get("areaID")!=areas[0].get("areaID"))return;}if(area){var areaItem=this.findItemForArea(area);if(areaItem){for(i=0;i<selected.length;i++){item=selected[i];var delta=areaItem.position.subtract(item.position);item.position.x=areaItem.position.x;item.position.y=areaItem.position.y;item.data.needsTransformsDataUpdate=true;// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)
// Nel caso di masked image, la trasformazione viene applicata alla matrice originaria del gruppo contenitore
var matrix=new this.paper.Matrix().translate(delta.x,delta.y);if((item instanceof this.paper.Raster||this.getItemIsTextArt(item)||this.isMaskedImage(item))&&item.data&&item.data.originalMatrix){item.data.originalMatrix.prepend(matrix);}if(item.data&&item.data.originalPosition){item.data.originalPosition=item.data.originalPosition.transform(matrix);}// ------------------------
this.onTextOnPathMoved(item,delta);this.onTextAreaMoved(item,delta);}this.onItemsUpdated(selected);this.updateSelectionState();this.paper.project.view.update();}}this.endDesignOperation();},moveSelectionByDelta:function(dx,dy){if(this.frozen||!this.canMoveSelection())return;var created=false;if(!this.currentDesignOperation){this.beginDesignOperation();created=true;}this.removeSelectionAlertItems();var delta=new this.paper.Point(dx,dy);var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){selected[i].position=selected[i].position.add(delta);// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)            
var matrix=new this.paper.Matrix().translate(delta.x,delta.y);if((selected[i]instanceof this.paper.Raster||this.getItemIsTextArt(selected[i])||this.isMaskedImage(selected[i]))&&selected[i].data&&selected[i].data.originalMatrix){selected[i].data.originalMatrix.prepend(matrix);}if(selected[i].data&&selected[i].data.originalPosition){selected[i].data.originalPosition=selected[i].data.originalPosition.transform(matrix);}// ------------------------
this.onTextOnPathMoved(selected[i],delta);this.onTextAreaMoved(selected[i],delta);}this.onItemsUpdated(selected);this.updateSelectionState();this.paper.project.view.update();if(created)this.endDesignOperation();},moveSelectionUp:function(){if(!this.canMoveSelection())return;this.moveSelectionByDelta(0,-2);},moveSelectionDown:function(){if(!this.canMoveSelection())return;this.moveSelectionByDelta(0,2);},moveSelectionLeft:function(){if(!this.canMoveSelection())return;this.moveSelectionByDelta(-2,0);},moveSelectionRight:function(){if(!this.canMoveSelection())return;this.moveSelectionByDelta(2,0);},moveSelection:function(info){var _this_1=this;if(this.frozen||!this.canMoveSelection())return;if(!info.delta)return;var delta=info.delta;this.hideCenterLines();// Se c'è stato uno spostamento forzato per lo snapping al centro
// compenso tale forzatura
if(this.adjustmentDelta!=null){delta.x-=this.adjustmentDelta.x;delta.y-=this.adjustmentDelta.y;}this.removeSelectionAlertItems();var selected=this.getSelectedItems();if(selected.length==0)return;for(var i=0;i<selected.length;i++){// Complicazione dovuta alle immagine con maschara. Si potrebbe voler muovere solo l'immagine, solo la maschera o tutto
var selectedItem=selected[i];var itemsToMove=this.getSubItemsToChange(selectedItem);itemsToMove.forEach(function(itemToMove){if(itemToMove){itemToMove.position.x+=delta.x;itemToMove.position.y+=delta.y;var matrix=new _this_1.paper.Matrix().translate(delta.x,delta.y);if(itemToMove.data&&itemToMove.data.originalMatrix){itemToMove.data.originalMatrix.prepend(matrix);}if(itemToMove.data&&itemToMove.data.originalPosition){itemToMove.data.originalPosition=itemToMove.data.originalPosition.transform(matrix);}}});this.onTextOnPathMoved(selected[i],delta);this.onTextAreaMoved(selected[i],delta);}this.moveSelectionShapes(delta);this.snapToCenter();this.snapToItems();this.updateTextOnPathGuides(selected);this.updateTextAreaGuides(selected);this.updateShapeImagePlaceholders(selected);if(this.adjustmentDelta&&(this.adjustmentDelta.x!=0||this.adjustmentDelta.y!=0))this.moveSelectionShapes(this.adjustmentDelta);// Update mask position & Update eventual loading circles position
for(var i=0;i<selected.length;i++){if(selected[i].data.maskPath)selected[i].data.maskPath.position=selected[i].position;if(selected[i].loadingCircle)selected[i].loadingCircle.position=selected[i].bounds.center;}},snapToCenter:function(){var _this_1=this;if(!this.adjustmentDelta)this.adjustmentDelta=new this.paper.Point(0,0);this.adjustmentDelta.x=0;this.adjustmentDelta.y=0;var eps=3/this.paper.view.zoom;if(this.snapCache&&this.snapCache.area&&this.snapCache.areaItem){var areaItem=this.snapCache.areaItem;var selected=this.snapCache.selectedItems;var areaBounds=areaItem.bounds;var rect=this.selectionBounds;var center=areaBounds.center;var xPoints=[new this.paper.Point(rect.left,rect.center.y),rect.center,new this.paper.Point(rect.right,rect.center.y)];var yPoints=[new this.paper.Point(rect.center.x,rect.top),rect.center,new this.paper.Point(rect.center.x,rect.bottom)];var minAbsDeltaX=null;var minDeltaX=null;for(var i=0;i<xPoints.length;i++){var xPoint=xPoints[i];var delta=xPoint.x-center.x;var absDelta=Math.abs(delta);if(minAbsDeltaX==null||absDelta<minAbsDeltaX){minAbsDeltaX=absDelta;minDeltaX=delta;}}var minAbsDeltaY=null;var minDeltaY=null;for(var i=0;i<yPoints.length;i++){var yPoint=yPoints[i];var delta=yPoint.y-center.y;var absDelta=Math.abs(delta);if(minAbsDeltaY==null||absDelta<minAbsDeltaY){minAbsDeltaY=absDelta;minDeltaY=delta;}}var deltaX=null;if(minAbsDeltaX<=eps)deltaX=minDeltaX;var deltaY=null;if(minAbsDeltaY<=eps)deltaY=minDeltaY;this.adjustmentDelta.x=deltaX!=null?-deltaX:0;this.adjustmentDelta.y=deltaY!=null?-deltaY:0;for(var i=0;i<selected.length;i++){var selectedItem=selected[i];var itemsToMove=this.getSubItemsToChange(selectedItem);itemsToMove.forEach(function(itemToMove){if(deltaX!=null)itemToMove.position.x-=deltaX;if(deltaY!=null)itemToMove.position.y-=deltaY;// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)
var matrixX=deltaX!=null?new _this_1.paper.Matrix().translate(-deltaX,0):null;var matrixY=deltaY!=null?new _this_1.paper.Matrix().translate(0,-deltaY):null;if(itemToMove.data&&itemToMove.data.originalMatrix){if(matrixX)itemToMove.data.originalMatrix.prepend(matrixX);if(matrixY)itemToMove.data.originalMatrix.prepend(matrixY);}if(itemToMove.data&&itemToMove.data.originalPosition){if(matrixX)itemToMove.data.originalPosition=itemToMove.data.originalPosition.transform(matrixX);if(matrixY)itemToMove.data.originalPosition=itemToMove.data.originalPosition.transform(matrixY);}// ------------------------                                        
});if(deltaX!=null||deltaY!=null){this.onTextOnPathMoved(selectedItem,this.adjustmentDelta);this.onTextAreaMoved(selectedItem,this.adjustmentDelta);}}if(deltaX!=null||deltaY!=null){if(deltaX!=null){this.showVerticalCenterLine(areaBounds);}if(deltaY!=null){this.showHorizontalCenterLine(areaBounds);}}/*
            this.updateSelectionState();
            this.paper.project.view.update();
            */}},snapToItems:function(){var _this_1=this;var eps=3/this.paper.view.zoom;if(this.snapCache.selectedItems.length==0)return;if(this.snapCache&&this.snapCache.area&&this.snapCache.areaItem){var areaItem=this.snapCache.areaItem;var selected=this.snapCache.selectedItems;var items=this.getAllItems();var deltaX=null;var deltaY=null;var absX=null;var absY=null;// Try to snap to one item
for(i=0;i<this.snapCache.areaItems.length;i++){var item=this.snapCache.areaItems[i];var bounds=item.bounds;var myLeft=selected[0].bounds.leftCenter;var myRight=selected[0].bounds.rightCenter;var myTop=selected[0].bounds.topCenter;var myBottom=selected[0].bounds.bottomCenter;var myCenter=selected[0].bounds.center;// Center is at first position because is more important
// and if two elements have equal size is better to show the center line and not the left or right
var xPoints=[myCenter,myLeft,myRight];var yPoints=[myCenter,myTop,myBottom];var targetXPoints=[item.bounds.center,item.bounds.leftCenter,item.bounds.rightCenter];var targetYPoints=[item.bounds.center,item.bounds.topCenter,item.bounds.bottomCenter];// check horizontal align
// we match if one of our left-center-right can snap to one of other item left-center-right
for(var j=0;j<xPoints.length;j++){var x=xPoints[j].x;var targetX=targetXPoints[j].x;if(Math.abs(x-targetX)<eps){//Logger.info("found at " + targetX);
deltaX=x-targetX;absX=targetX;this.adjustmentDelta.x-=deltaX;break;}}for(j=0;j<yPoints.length;j++){var y=yPoints[j].y;var targetY=targetYPoints[j].y;if(Math.abs(y-targetY)<eps){deltaY=y-targetY;absY=targetY;this.adjustmentDelta.y-=deltaY;break;}}if(deltaX!=null||deltaY!=null)break;}for(var i=0;i<selected.length;i++){var selectedItem=selected[i];var itemsToMove=this.getSubItemsToChange(selectedItem);itemsToMove.forEach(function(itemToMove){if(deltaX!=null)itemToMove.position.x-=deltaX;if(deltaY!=null)itemToMove.position.y-=deltaY;if(deltaX!=null||deltaY!=null){var dx=deltaX!=null?-deltaX:0;var dy=deltaY!=null?-deltaY:0;// Image Original Bounds & Matrix
// Nel caso di immagine o di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)                    
var matrix=new _this_1.paper.Matrix().translate(dx,dy);if(itemToMove.data.originalMatrix){itemToMove.data.originalMatrix.prepend(matrix);}if(itemToMove.data.originalPosition){itemToMove.data.originalPosition=itemToMove.data.originalPosition.transform(matrix);}// ------------------------                                                        
}});if(deltaX!=null||deltaY!=null){var dx=deltaX!=null?-deltaX:0;var dy=deltaY!=null?-deltaY:0;this.onTextOnPathMoved(selectedItem,new this.paper.Point(dx,dy));this.onTextAreaMoved(selectedItem,new this.paper.Point(dx,dy));}}if(deltaX!=null||deltaY!=null){this.hideCenterLines();if(deltaX!=null){this.showVerticalCenterLine(new this.paper.Rectangle(absX-1,areaItem.bounds.topCenter.y,1,areaItem.bounds.bottomCenter.y));}if(deltaY!=null){this.showHorizontalCenterLine(new this.paper.Rectangle(areaItem.bounds.leftCenter.x,absY,areaItem.bounds.rightCenter.x,1));}}}},showVerticalCenterLine:function(areaBounds){var viewBounds=this.paper.project.view.bounds;this.verticalCenterLine=this.createGuideLine(new this.paper.Point(areaBounds.center.x,viewBounds.top),new this.paper.Point(areaBounds.center.x,viewBounds.bottom));},showHorizontalCenterLine:function(areaBounds){var viewBounds=this.paper.project.view.bounds;this.horizontalCenterLine=this.createGuideLine(new this.paper.Point(viewBounds.left,areaBounds.center.y),new this.paper.Point(viewBounds.right,areaBounds.center.y));},createGuideLine:function(p1,p2){// Create pixel perfect dotted rectable for drag selections.
var half=new this.paper.Point(0.5/this.paper.view.zoom,0.5/this.paper.view.zoom);var start=p1.add(half);var end=p2.add(half);var line=new this.paper.Path.Line(start,end);line.strokeColor='blue';line.strokeWidth=1.0/this.paper.view.zoom;line.dashOffset=0.5/this.paper.view.zoom;line.dashArray=[1.0/this.paper.view.zoom,1.0/this.paper.view.zoom];line.blendMode="xor";line.removeOn({drag:true,up:true});line.guide=true;return line;},hideCenterLines:function(){if(this.verticalCenterLine)this.verticalCenterLine.remove();if(this.horizontalCenterLine)this.horizontalCenterLine.remove();this.verticalCenterLine=null;this.horizontalCenterLine=null;},rotateSelection:function(info){var _this_1=this;if(this.frozen||!this.canRotateSelection())return;if(!info.point)return;var point=info.point;this.removeSelectionAlertItems();this.hideCenterLines();// Actualy works with only one item
var selectedItems=this.getSelectedItems();if(selectedItems.length!=1)return;var item=selectedItems[0];var delta=point.subtract(this.originalCenter);var angle=Math.atan2(delta.y,delta.x);var da=angle-this.originalAngle;this.restoreSelectionState(this.originalContent);var id=this.selectionBoundsShape.id;this.selectionBoundsShape.importJSON(this.originalShape);this.selectionBoundsShape._id=id;var deg=da/Math.PI*180;var angles=[0,90,180,270,360,-90,-180,-270,-360];for(var i=0;i<angles.length;i++){var snapAngle=angles[i];var itemRotation=item.rotation;if(item.data.isTextArea)itemRotation=item.children[0].rotation;if(Math.abs(deg+itemRotation-snapAngle)<5){deg=snapAngle-itemRotation;if(snapAngle==0||snapAngle==180||snapAngle==-180)this.showHorizontalCenterLine(item.bounds);if(snapAngle==90||snapAngle==-90)this.showVerticalCenterLine(item.bounds);}}this.selectionBoundsShape.rotate(deg,this.originalCenter);this.createSelectionHandles();this.placeHandleOut(this.selectionBoundsShape);//if (this.isItemGroup(item)) continue;
if(item.guide)return;var itemsToRotate=this.getSubItemsToChange(item);itemsToRotate.forEach(function(itemToRotate){itemToRotate.rotate(deg,_this_1.originalCenter);// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)        
if(itemToRotate.data.originalMatrix){var matrix=new _this_1.paper.Matrix().rotate(deg,_this_1.originalCenter);itemToRotate.data.originalMatrix.prepend(matrix);}if(itemToRotate.data.originalPosition){var matrix=new _this_1.paper.Matrix().rotate(deg,_this_1.originalCenter);itemToRotate.data.originalPosition=itemToRotate.data.originalPosition.transform(matrix);}// ------------------------
});this.onTextOnPathRotated(item,deg,this.originalCenter);this.onTextAreaRotated(item,deg,this.originalCenter);this.updateTextOnPathGuides(selectedItems);this.updateTextAreaGuides(selectedItems);this.updateShapeImagePlaceholders(selectedItems);},rotateSelectionAngle:function(angle){var _this_1=this;this.removeSelectionAlertItems();this.restoreSelectionState(this.originalContent);var id=this.selectionBoundsShape.id;this.selectionBoundsShape.importJSON(this.originalShape);this.selectionBoundsShape._id=id;this.selectionBoundsShape.rotate(angle,this.originalCenter);this.createSelectionHandles();var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;var itemsToRotate=this.getSubItemsToChange(item);itemsToRotate.forEach(function(itemToRotate){itemToRotate.rotate(angle,_this_1.originalCenter);// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine (o TextArt) inizialmente caricata (e che potrebbe essere sostituita)        
if(itemToRotate.data.originalMatrix){var matrix=new _this_1.paper.Matrix().rotate(angle,_this_1.originalCenter);itemToRotate.data.originalMatrix.prepend(matrix);}if(itemToRotate.data.originalPosition){var matrix=new _this_1.paper.Matrix().rotate(angle,_this_1.originalCenter);itemToRotate.data.originalPosition=itemToRotate.data.originalPosition.transform(matrix);}// ------------------------
});this.onTextOnPathRotated(item,angle,this.originalCenter);this.onTextAreaRotated(item,angle,this.originalCenter);}this.updateTextOnPathGuides(selected);this.updateTextAreaGuides(selected);},resizeSelection:function(info){if(this.frozen||!this.canResizeSelection())return;if(!info.point)return;this.removeSelectionAlertItems();var selected=this.getSelectedItems();if(selected.length==0)return;var pivot=this.originalScaleCenter.clone();var currentSize=this.corner.subtract(pivot);var point=info.point;var compensatedPoint=new this.paper.Point();compensatedPoint.x=point.x-this.selectionResizeHandle.bounds.width/2;compensatedPoint.y=point.y-this.selectionResizeHandle.bounds.width/2;var pt=this.projectPointOnLine(pivot,this.corner,compensatedPoint,false);if(pt.subtract(pivot).length<0.1)return;var newDelta=pt.subtract(this.corner);this.corner.x+=newDelta.x;this.corner.y+=newDelta.y;var size=this.corner.subtract(pivot);var sx=1.0,sy=1.0;if(Math.abs(currentSize.x)>0.0000001)sx=size.x/currentSize.x;if(Math.abs(currentSize.y)>0.0000001)sy=size.y/currentSize.y;this.scaleSelectedItems(sx,sy,pivot);},resizeSelectionTop:function(info){this.resizeSelectionLaterally(info,"top");},resizeSelectionBottom:function(info){this.resizeSelectionLaterally(info,"bottom");},resizeSelectionLeft:function(info){this.resizeSelectionLaterally(info,"left");},resizeSelectionRight:function(info){this.resizeSelectionLaterally(info,"right");},resizeSelectionLaterally:function(info,type){if(this.frozen||!this.canResizeSelection())return;if(!info.point)return;this.removeSelectionAlertItems();var selected=this.getSelectedItems();if(selected.length==0)return;var pivot=this.originalScaleCenter.clone();var corner=this._getResizeCorner(type);var currentSize=corner.subtract(pivot);var point=info.point;var compensatedPoint=this._getResizeCompensatedPoint(type,point);var dx=0,dy=0;if(type==="top"||type==="bottom")dy=compensatedPoint.y-corner.y;else dx=compensatedPoint.x-corner.x;this._moveResizeCorner(type,dx,dy);var size=corner.subtract(pivot);var sx=1.0,sy=1.0;if(type==="top"||type==="bottom")sy=size.y/currentSize.y;else sx=size.x/currentSize.x;this.scaleSelectedItems(sx,sy,pivot);},_getResizeCorner:function(type){var corner=this.corner;if(type==="top")corner=this.cornerTop;else if(type==="bottom")corner=this.cornerBottom;else if(type==="left")corner=this.cornerLeft;else if(type==="right")corner=this.cornerRight;return corner;},_moveResizeCorner:function(type,dx,dy){if(type==="top"){this.cornerTop.x+=dx;this.cornerTop.y+=dy;}else if(type==="bottom"){this.cornerBottom.x+=dx;this.cornerBottom.y+=dy;}else if(type==="left"){this.cornerLeft.x+=dx;this.cornerLeft.y+=dy;}else if(type==="right"){this.cornerRight.x+=dx;this.cornerRight.y+=dy;}else{this.corner.x+=dx;this.corner.y+=dy;}},_getResizeCompensatedPoint:function(type,point){var compensatedPoint=new this.paper.Point();if(type==="all"){compensatedPoint.x=point.x-this.selectionResizeHandle.bounds.width/2;compensatedPoint.y=point.y-this.selectionResizeHandle.bounds.width/2;}else{compensatedPoint.x=point.x-this.selectionLateralResizeDimension/2;compensatedPoint.y=point.y-this.selectionLateralResizeDimension/2;}return compensatedPoint;},projectPointOnLine:function(pt1,pt2,pt0,invert){var pt=new this.paper.Point(0,0);if(pt1.x==pt2.x){pt.x=pt1.x;pt.y=pt0.y;return pt;}if(pt1.y==pt2.y){pt.x=pt0.x;pt.y=pt1.y;return pt;}//if (pt1.x == pt2.x)
//    return pt1;
var m=(pt2.y-pt1.y)/(pt2.x-pt1.x);// Coefficiente angolare
var q=(pt2.x*pt1.y-pt1.x*pt2.y)/(pt2.x-pt1.x);// Ordinata all'origine
var d=pt0.y-m*pt0.x-q;if(!invert){if(d>0){pt.y=pt0.y;pt.x=(pt0.y-q)/m;}else if(d<0){pt.x=pt0.x;pt.y=m*pt0.x+q;}else{// Sulla retta
pt=pt0;}}else{if(d>0){pt.x=pt0.x;pt.y=m*pt0.x+q;}else if(d<0){pt.y=pt0.y;pt.x=(pt0.y-q)/m;}else{// Sulla retta
pt=pt0;}}return pt;},scaleItem:function(item,sx,sy,pivot){var _this_1=this;if(item){if(!this.canScaleTextFont(item,sx,sy))return;var itemsToResize=this.getSubItemsToChange(item);itemsToResize.forEach(function(itemToResize){itemToResize.scale(sx,sy,pivot);itemToResize.data.needsTransformsDataUpdate=true;// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine o TextArt inizialmente caricata (e che potrebbe essere sostituita)            
if(itemToResize.data.originalMatrix){var matrix=new _this_1.paper.Matrix().scale(sx,sy,pivot);itemToResize.data.originalMatrix.prepend(matrix);}if(itemToResize.data.originalPosition){var matrix=new _this_1.paper.Matrix().scale(sx,sy,pivot);itemToResize.data.originalPosition=itemToResize.data.originalPosition.transform(matrix);}// ------------------------
});this.onTextOnPathScaled(item,sx,sy,pivot);this.onTextAreaScaled(item,sx,sy,pivot);this.updateTextOnPathGuides([item]);this.updateTextAreaGuides([item]);this.updateShapeImagePlaceholders([item]);this.updateSelectionState();}},scaleSelectedItems:function(sx,sy,pivot){var _this_1=this;// Prevent flip if is disabled
if(sx<0||sy<0){var selectedPrintType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(this.side.get('areas').at(0)));if(selectedPrintType&&selectedPrintType.get('printTypeRestrictions')&&selectedPrintType.get('printTypeRestrictions').get('showFlipButtons')===false)return;}if(!this.canResizeSelection())return;if(!this.canScaleSelectedTextFont(sx,sy))return;// verifica se lo scaling farebbe superare i limiti dell'area ad eventuali TextBox
if(!this.canResizeSelectedTextAreas(sx,sy,pivot))return;var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(item.guide)continue;var itemsToResize=this.getSubItemsToChange(item);itemsToResize.forEach(function(itemToResize){itemToResize.scale(sx,sy,pivot);itemToResize.data.needsTransformsDataUpdate=true;// Image Original Bounds & Matrix
// Nel caso di immagine e di TextArt, applico la trasformazione alla matrice originaria
// relativa al contorno dell'immagine o TextArt inizialmente caricata (e che potrebbe essere sostituita)            
if(itemToResize.data.originalMatrix){var matrix=new _this_1.paper.Matrix().scale(sx,sy,pivot);itemToResize.data.originalMatrix.prepend(matrix);}if(itemToResize.data.originalPosition){var matrix=new _this_1.paper.Matrix().scale(sx,sy,pivot);itemToResize.data.originalPosition=itemToResize.data.originalPosition.transform(matrix);}// ------------------------
});this.onTextOnPathScaled(item,sx,sy,pivot);this.onTextAreaScaled(item,sx,sy,pivot);}this.scaleSelectionShapes(sx,sy,pivot);this.updateTextOnPathGuides(selected);this.updateTextAreaGuides(selected);this.updateShapeImagePlaceholders(selected);/*
        this.updateSelectionState();
        this.paper.project.view.update();
        */},deleteSelection:function(){var _this_1=this;if(!this.canDeleteSelection())return;this.removeSelectionAlertItems();var selected=this.getSelectedItems();var _loop_1=function(){item=selected[i];this_1.deleteDimensionLabel(item.id);if(this_1.isMaskedImage(item)&&!this_1.isFilledShape(item)&&this_1.maskedImageSelectionMode==MaskedImageSelectionMode.Mask&&this_1.canDeleteMask(item)){this_1.removeMaskFromImage(item);}else if(this_1.isFilledShape(item)&&this_1.maskedImageSelectionMode==MaskedImageSelectionMode.Raster){this_1.removeImageFromShape(item);}else{designItem=this_1.findDesignItemForItem(item);if(designItem)this_1.fireDesignItemRemovingEvent(designItem,item);if(item.data&&item.data.isGridImage){var box_1=item.parent;if(box_1&&box_1.data&&box_1.data.isGridPathGroup){this_1.createGridBoxIcon().then(function(cameraIcon){var path=box_1.children.find(function(x){return x.data&&x.data.isGridBorderPath;});if(path)path.fillColor=new paper.Color(1,1,1,0.9);box_1.addChild(cameraIcon);var newIconDim=_this_1.isMobile?Math.min(Math.min(box_1.bounds.width,box_1.bounds.height),180):Math.min(Math.min(box_1.bounds.width,box_1.bounds.height)*0.8,66);cameraIcon.data.isGridIcon=true;cameraIcon.position.x=box_1.position.x;cameraIcon.position.y=box_1.position.y;cameraIcon.scale(newIconDim/cameraIcon.bounds.width,newIconDim/cameraIcon.bounds.height);});}}item.remove();this_1.onItemRemoved(item);this_1.removeShapeImagePlaceholder(item);this_1.setItemSelection(item,false);}};var this_1=this,item,designItem;for(var i=0;i<selected.length;i++){_loop_1();}this.updateSelectionState();this.paper.project.view.update();},editElement:function(){if(this.frozen||!this.mouseStartPos)return;if(this.elementType==MPlaza.CustomizerElementType.Text){this.editText();}},updateItemSyncGuid:function(item,guid){var designItem=this.findDesignItemForItem(item);if(designItem)designItem.set("syncGuid",guid);},getContrastedColor:function(rect){var color='black';if(this.imageItem){rect.height=Math.max(1,rect.height);rect.width=Math.max(1,rect.width);try{var avgColor=this.imageItem.getAverageColor(rect);if(avgColor){color=MPlaza.getContrastYIQ(avgColor.red*255,avgColor.green*255,avgColor.blue*255);}}catch(e){console.trace("error getting image avarage color "+e.message);}}return color;},insertSVGFromUrl:function(url){/*
                $.ajax({
                    url: url,
                    type: 'GETT',
                    success: function () {
                        window.location = 'download.php';
                    }
                });
        */var customizer=this;$.ajax({url:url}).done(function(data){customizer.insertSVG(data);});},// Da rivedere
insertSVG:function(svg){if(this.side){var area=this.side.get("areas").getMaxArea();if(area){var item=this.paper.project.activeLayer.importSVG(svg);this.onItemCreated(item);// Test Detect colors
this.detectItemColors(item);// ------------------
// centro l'elemento all'interno dell'area
var areaItem=this.findItemForArea(area);if(areaItem){item.position=areaItem.position;var itemBounds=item.bounds;var areaBounds=areaItem.bounds;if(areaBounds.intersects(itemBounds)||itemBounds.contains(areaBounds)){var targetBounds=areaBounds.clone();targetBounds.width*=0.8;targetBounds.height*=0.8;var sx=1.0;var sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;var signx=sx>0?1:-1;var signy=sy>0?1:-1;sx=sy=Math.min(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;item.scale(sx,sy);this.masterGroup.addChild(item);this.updateItemsIndexes();this.onItemUpdated(item);this.onDesignItemChanged(item);if(this.mask)this.mask.bringToFront;}}}}},detectItemColors:function(item){var colors=[];var checkItem=function(parent){if(parent.fillColor){var color=parent.fillColor.toCSS(true);if(colors.indexOf(color)===-1)colors.push(color);}if(parent.children){for(var i=0;i<parent.children.length;i++){var child=parent.children[i];checkItem(child);}}};checkItem(item);for(var i=0;i<colors.length;i++){Logger.info("Color: "+colors[i]);}},resetShadows:function(){var _this_1=this;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();this.getAllTextItems().forEach(function(i){return _this_1.resetTextElementShadow(i);});this.getAllTextArtItems().forEach(function(i){return _this_1.resetTextArtShadow(i);});this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},// -------------------------------------------------------------
// TextArt
// -------------------------------------------------------------
/*
    TextArtOptions = {
        typrFont: any,
        fontFamilyID: number,
        fontFaceID: number,
        text: string,
        textArtTypeID: number,
        style: {
            strokeColor?: string,
            strokeWidth?: number,
            strokeCap?: "round" | "square" | "butt",
            strokeJoin?: "miter" | "round" | "bevel",
            dashArray?: number[],
            dashOffset?: number,
            fillColor?: string,
            shadowColor?: string,
            shadowBlur?: number,
            shadowDistance?: number,
            shadowAngle?: number
        },
        config: {
            angleValue: number,
            curveValue: number,
            intensT: number,
            intensB: number,
            isTriangle: boolean,
            isBridge: boolean,
            isTop: boolean,
            isBottom: boolean,
            isMiddle: boolean,
        }
    };
    */insertTextArt:function(options,callback){if(!options)return;if(!this.canAddTextArt())return;this.beginDesignOperation();var customizer=this;Zakeke.Customizer.TextArt.createTextArtPath(options.typrFont,options.opentypeFont,options.text,undefined,undefined,options.config).then(function(path_str){if(path_str){//var svg = customizer.buildTextArtPathElement(path_str, options.style);
if(customizer.side){var area=customizer.side.get("areas").getMaxArea();if(area){// Modifico i colori in base all'eventuale effetto
var designEffect=customizer.getDesignEffectForArea(area);if(!customizer.allowShadows())options.style.shadowColor=null;var originalStrokeColor=options.style["strokeWidth"]!=undefined?options.style.strokeColor:undefined;var originalFillColor=options.style.fillColor;var originalShadowColor=options.style.shadowColor;originalStrokeColor=customizer.forceColorInFixedPalette(null,originalStrokeColor);originalFillColor=customizer.forceColorInFixedPalette(null,originalFillColor);originalShadowColor=customizer.forceColorInFixedPalette(null,originalShadowColor);options.style.strokeColor=customizer.applyDesignEffectToTextColor(designEffect,originalStrokeColor);options.style.fillColor=customizer.applyDesignEffectToTextColor(designEffect,originalFillColor);options.style.shadowColor=customizer.applyDesignEffectToTextColor(designEffect,originalShadowColor);options.style.shadowBlur=customizer.adjustInputShadowBlur(null,options.style.shadowBlur);options.style.shadowDistance=customizer.adjustInputShadowDistance(null,options.style.shadowDistance);options.style.shadowAngle=customizer.adjustInputShadowDistance(null,options.style.shadowAngle);var item=new customizer.paper.CompoundPath(path_str);customizer.applyStyleToItem(item,options.style);item.applyMatrix=true;// purtroppo non funziona. i dati della trasformazione non vengono memorizzati
item.data={};item.data.isTextArt=true;item.data.originalBounds=item.bounds;item.data.originalMatrix=new customizer.paper.Matrix();// Salvo i colori originali in modo da riapplicare l'effetto su questi colori
item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.originalShadowColor=originalShadowColor;customizer.applyDesignEffectToItem(designEffect,item);var designItem=customizer.onTextArtItemCreated(item,options);// centro l'elemento all'interno dell'area
var areaItem=customizer.findItemForArea(area);if(areaItem){var delta=areaItem.position.subtract(item.position);item.position.x+=delta.x;item.position.y+=delta.y;var matrix=new customizer.paper.Matrix().translate(delta.x,delta.y);item.data.originalMatrix.prepend(matrix);var itemBounds=item.bounds;var areaBounds=areaItem.bounds;if(areaBounds.intersects(itemBounds)||itemBounds.contains(areaBounds)){var targetBounds=areaBounds.clone();targetBounds.width*=0.8;targetBounds.height*=0.8;var sx=1.0;var sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;var signx=sx>0?1:-1;var signy=sy>0?1:-1;sx=sy=Math.min(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;item.scale(sx,sy);matrix=new customizer.paper.Matrix().scale(sx,sy);item.data.originalMatrix.prepend(matrix);customizer.masterGroup.addChild(item);customizer.onItemUpdated(item);customizer.updateItemsIndexes();customizer.onDesignItemChanged(item);customizer.fireTextArtLoadedEvent();if(customizer.mask)customizer.mask.bringToFront();if(callback)callback(item);customizer.endDesignOperation();}}}}}});},buildTextArtPathElement:function(path_str,pathStyle){return'<path xmlns="http://www.w3.org/2000/svg" d="'+path_str+'" />';},replaceSelectedTextArt:function(options,callback){if(!options||!this.design)return;var items=this.getSelectedTextArtItems();if(items&&items.length>0){var item=items[0];if(!this.canEditItem(item))return;this.replaceTextArt(item,options,callback);}},replaceTextArtByGuid:function(guid,options,callback){var item=this.findItemByGuid(guid);if(item){this.replaceTextArt(item,options,callback);}},replaceTextArt:function(item,options,callback){if(!this.canEditItem(item))return;var customizer=this;options.text=this.adjustInputTextByConstraints(item,options.text)||options.text;this.beginDesignOperation();Zakeke.Customizer.TextArt.createTextArtPath(options.typrFont,options.opentypeFont,options.text,undefined,undefined,options.config).then(function(path_str){if(path_str){var designItem=customizer.findDesignItemByGuid(item.data.guid);if(designItem){// Modifico i colori in base all'eventuale effetto
var designEffect=customizer.getDesignEffectForDesignItem(designItem);if(!customizer.allowShadows())options.style.shadowColor=null;var originalStrokeColor=options.style["strokeWidth"]!=undefined?options.style.strokeColor:undefined;var originalFillColor=options.style.fillColor;var originalShadowColor=options.style.shadowColor;originalStrokeColor=customizer.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=customizer.forceColorInFixedPalette(item,originalFillColor);originalShadowColor=customizer.forceColorInFixedPalette(item,originalShadowColor);options.style.strokeColor=customizer.applyDesignEffectToTextColor(designEffect,originalStrokeColor);options.style.fillColor=customizer.applyDesignEffectToTextColor(designEffect,originalFillColor);options.style.shadowColor=customizer.applyDesignEffectToTextColor(designEffect,originalShadowColor);options.style.shadowBlur=customizer.adjustInputShadowBlur(item,options.style.shadowBlur);options.style.shadowDistance=customizer.adjustInputShadowDistance(item,options.style.shadowDistance);options.style.shadowAngle=customizer.adjustInputShadowDistance(item,options.style.shadowAngle);// Dimensioni prima della sostituzione
var oldWidth=item.bounds.width;var oldHeight=item.bounds.height;// importo il nuovo SVG e rimpiazzo il contenuto del vecchio
//var svg = customizer.buildTextArtPathElement(path_str, options.style);
//var newItem = customizer.paper.project.activeLayer.importSVG(svg);
var newItem=new customizer.paper.CompoundPath(path_str);newItem.visible=false;customizer.applyStyleToItem(newItem,options.style);newItem.transform(item.data.originalMatrix);newItem.position=item.position;item.removeChildren();item.copyContent(newItem);var data=item.data;item.copyAttributes(newItem);item.data=data;item.visible=true;item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.originalShadowColor=originalShadowColor;newItem.remove();// Riporto alle dimensioni precedenti
var newWidth=item.bounds.width;var newHeight=item.bounds.height;var sx=1.0;var sy=1.0;if(newWidth>0&&Math.abs(oldWidth)>0.0000001)sx=oldWidth/newWidth;if(newHeight>0&&Math.abs(oldHeight)>0.0000001)sy=oldHeight/newHeight;item.scale(sx,sy);var matrix=new customizer.paper.Matrix().scale(sx,sy);item.data.originalMatrix.prepend(matrix);customizer.onTextArtItemUpdated(item,options);customizer.updateSelectionState();customizer.paper.project.view.update();customizer.endDesignOperation();if(callback)callback(item);customizer.fireTextArtLoadedEvent();}}});},changeTextArtStyle:function(item,style){if(!this.canEditItem(item))return;if(item&&item instanceof this.paper.Item){this.beginDesignOperation();var designItem=this.findDesignItemByGuid(item.data.guid);// Modifico i colori in base all'eventuale effetto
var designEffect=this.getDesignEffectForDesignItem(designItem);if(!this.allowShadows())style.shadowColor=null;var originalStrokeColor=style.strokeColor;var originalFillColor=style.fillColor;var originalShadowColor=style.shadowColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(item,originalFillColor);originalShadowColor=this.forceColorInFixedPalette(item,originalShadowColor);style.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);style.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);style.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);style.shadowBlur=this.adjustInputShadowBlur(item,style.shadowBlur);style.shadowDistance=this.adjustInputShadowDistance(item,style.shadowDistance);style.shadowAngle=this.adjustInputShadowAngle(item,style.shadowAngle);this.applyStyleToItem(item,style);item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.originalShadowColor=originalShadowColor;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();}},applyStyleToItem:function(item,style){if(item&&item instanceof this.paper.Item){if(style["strokeColor"]!=undefined)item.strokeColor=style["strokeColor"];if(style["strokeWidth"]!=undefined)item.strokeWidth=style["strokeWidth"];if(style["strokeCap"])item.strokeCap=style["strokeCap"];if(style["strokeJoin"])item.strokeJoin=style["strokeJoin"];if(style["dashOffset"]!=undefined)item.dashOffset=style["dashOffset"];if(style["dashArray"])item.dashArray=style["dashArray"];if(style["fillColor"]&&!this.isFilledShape(item))item.fillColor=style["fillColor"];if(style["shadowColor"]!=undefined&&!this.isShape(item)&&!this.isMaskedImageShapeItem(item)&&!this.isMaskedImageMaskItem(item)){item.shadowColor=style["shadowColor"];item.shadowBlur=style["shadowBlur"];var distance=0;var angle=0;if(style.hasOwnProperty("shadowDistance"))distance=style["shadowDistance"];if(style.hasOwnProperty("shadowAngle"))angle=style["shadowAngle"];item.shadowOffset=this.getOffsetByDistanceAngle(distance,angle);}}},getAllTextArtItems:function(){var _this_1=this;return this.getAllItems().filter(function(i){return _this_1.getItemIsTextArt(i);});},resetTextArtShadow:function(item){if(item&&item.data&&item.data.guid&&item.data.isTextArt){var designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){this.beginDesignOperation();var designEffect=this.getDesignEffectForDesignItem(designItem);var info=this.getTextArtItemInfo(item);if(!this.allowShadows())info.style.shadowColor=null;var originalShadowColor=info.style.shadowColor;originalShadowColor=this.forceColorInFixedPalette(item,originalShadowColor);info.style.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);info.style.shadowBlur=this.adjustInputShadowBlur(item,info.style.shadowBlur);info.style.shadowDistance=this.adjustInputShadowDistance(item,info.style.shadowDistance);info.style.shadowAngle=this.adjustInputShadowDistance(item,info.style.shadowAngle);this.applyStyleToItem(item,info.style);item.data.originalShadowColor=originalShadowColor;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();}}},// -------------------------------------------------------------
// Images
// -------------------------------------------------------------
_getRandomColor:function(){//const randomColor = Math.floor(Math.random()*16777215).toString(16);
var randomColor=(Math.random()*0xFFFFFF<<0).toString(16).padStart(6,'0');return"#"+randomColor;},isImageAutofitEnabled:function(type){var area=this.side.get('areas').at(0);var selectedPrintType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(area));// Configurator 
if(!selectedPrintType)return false;if(!selectedPrintType.get('printTypeRestrictions'))return false;return selectedPrintType.get('printTypeRestrictions').get(type=='upload'?'imageInsertScalingUpload':'imageInsertScalingCliparts')==1;},insertImageById:function(imageID,colorMappings){return __awaiter(this,void 0,void 0,function(){var that,image,model;return __generator(this,function(_a){switch(_a.label){case 0:that=this;image=new MPlaza.Image();image.set('imageID',imageID);return[4/*yield*/,new Promise(function(resolve){image.fetch({success:function(model){resolve(model);}});})];case 1:model=_a.sent();return[4/*yield*/,that.insertImage(model,colorMappings)];case 2:_a.sent();return[2/*return*/];}});});},// Il metodo accetta oltre all'oggetto backbone dell'immagine, anche un remapping dei colori
// Si suppone che il remapping sia stato definito dall'utente in base al numero di colori previsti dalla tecnica di stampa
// e in base alla selezione dell'utente
insertImage:function(image,colorMappings){var _a,_b;return __awaiter(this,void 0,void 0,function(){var item,url,area,originalUrl,designEffect,designItem,model,areaItem,itemBounds,areaBounds,isUpload,ratio,targetBounds,sx,sy,signx,signy,printType,modelPrintType,useImagesFixedSize,restrictions,ppcm,ppmm,preferredWidth,preferredHeight;return __generator(this,function(_c){switch(_c.label){case 0:item=null;if(!image||!(image instanceof MPlaza.Image))return[2/*return*/];if(!this.canAddImage())return[2/*return*/];this.beginDesignOperation();url="";if(!this.isImageScalingEnabled&&image.get("format").toLowerCase()!="svg"&&image.get("type").toLowerCase()!="vector"&&["png","jpg","jpeg"].find(function(x){return x==image.get("format").toLowerCase();}))url=image.get("url");if(!url)url=image.get("previewUrl");if(!url)return[2/*return*/];if(!this.side)return[3/*break*/,7];area=this.side.get("areas").getMaxArea();if(!area)return[3/*break*/,7];originalUrl=url;designEffect=this.getDesignEffectForArea(area);return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_c.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,null)];case 2:colorMappings=_c.sent();_c.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_c.sent();_c.label=5;case 5:return[4/*yield*/,this.createRasterItem(url)];case 6:// -------
item=_c.sent();item.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);designItem=this.onItemCreated(item,image);this.updateDesignItemColorMappings(designItem,colorMappings);model=this.getCurrentModel();areaItem=this.findItemForArea(area);if(areaItem){item.position=areaItem.position;itemBounds=item.bounds;areaBounds=areaItem.bounds;if(areaBounds.intersects(itemBounds)||itemBounds.contains(areaBounds)){isUpload=image.get('customerID')>0||image.get('visitorID')>0;ratio=this.isImageAutofitEnabled(isUpload?'upload':'cliparts')?1.0:0.8;targetBounds=areaBounds.clone();targetBounds.width*=ratio;targetBounds.height*=ratio;sx=1.0;sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;signx=sx>0?1:-1;signy=sy>0?1:-1;sx=sy=this.isImageAutofitEnabled()?Math.max(Math.abs(sx),Math.abs(sy)):Math.min(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;// If the image has a fixed size
if(model&&this.design&&this.design instanceof MPlaza.Design&&model.get("printTypes")instanceof MPlaza.PrintTypes){//Since print types per areas are not yet supported, just take the first area (the print type of that area's side side will be taken)
area=this.side.get("areas").at(0);printType=this.getSelectedPrintType(area);modelPrintType=model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));if(!printType)printType=model.get("printTypes").getPrintType(this.design.getSelectedPrintTypeForArea(area));useImagesFixedSize=null;if(printType instanceof MPlaza.PartPrintType){restrictions=printType.get("restrictions");useImagesFixedSize=restrictions?restrictions.get("useImagesFixedSize"):null;}if(useImagesFixedSize==null)useImagesFixedSize=(_a=modelPrintType===null||modelPrintType===void 0?void 0:modelPrintType.get("useImagesFixedSize"))!==null&&_a!==void 0?_a:(_b=modelPrintType.get("printTypeRestrictions"))===null||_b===void 0?void 0:_b.get('useImagesFixedSize');if(useImagesFixedSize==true&&designItem.get("imagePreferredWidth")&&designItem.get("imagePreferredHeight")){ppcm=this.side.get("ppcm");ppmm=ppcm/10;preferredWidth=designItem.get("imagePreferredWidth")*ppmm;preferredHeight=designItem.get("imagePreferredHeight")*ppmm;sx=preferredWidth/itemBounds.width;sy=preferredHeight/itemBounds.height;}}item.scale(sx,sy);// Image Original Bounds & Matrix
// Tra i metadati dell'item salvo il bounds originale dell'immagine e la trasformazione applicata
// La matrice di trasformazone viene mantenuta aggiornata ad ogni trasformazione applicata all'oggetto
// Questi dati verranno utilizzati quando il contenuto dell'immagine è sostituito con il contenuto
// di una nuova. Se le dimensioni non sono le stesse, all'immagine sostitutiva verrà applicata
// una trasformazione in modo che resti nell'ambito degli stessi contorni iniziali.
item.data.originalBounds=new this.paper.Rectangle(0,0,item.width,item.height);item.data.originalMatrix=item.matrix.clone();// -------------------------
this.onItemUpdated(item);this.onDesignItemChanged(item);}}this.masterGroup.addChild(item);this.onItemUpdated(item);this.updateItemsIndexes();this.onDesignItemChanged(item);this.fireImageLoadedEvent();if(this.mask)this.mask.bringToFront();this.endDesignOperation();_c.label=7;case 7:// TEST MASK
/*
                    let shape = await this._loadRandomShapeAsync();
                    item = await this.applyMaskToImageItemAsync(item, shape, {});
                    */return[2/*return*/,item];}});});},// Rimpiazza il contenuto dell'immagine, preservando i limiti dell'immagine originaria
// per far questo, viene utilizzato il rettangolo che racchiude l'immagine iniziale e 
// quello che racchiude la nuova immagine, tenendo conto delle dovute trasformazioni (matrici)
replaceSelectedImage:function(image,colorMappings){return __awaiter(this,void 0,void 0,function(){var url,items,item;return __generator(this,function(_a){switch(_a.label){case 0:if(!image||!(image instanceof MPlaza.Image)||!this.design)return[2/*return*/,null];url=image.get("previewUrl");if(!url)return[2/*return*/,null];items=this.getSelectedImageItems();if(!(items&&items.length>0))return[3/*break*/,2];item=items[0];if(!this.canEditItem(item))return[2/*return*/,item];return[4/*yield*/,this.replaceImage(item,image,colorMappings)];case 1:_a.sent();return[2/*return*/,item];case 2:return[2/*return*/,null];}});});},replaceImageByGuid:function(guid,image,colorMappings){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){switch(_a.label){case 0:item=this.findItemByGuid(guid);if(!item)return[3/*break*/,2];return[4/*yield*/,this.replaceImage(item,image,colorMappings)];case 1:_a.sent();_a.label=2;case 2:return[2/*return*/,item];}});});},replaceImage:function(item,image,colorMappings){return __awaiter(this,void 0,void 0,function(){var url,designItem,currentImageID,shape,raster,oldWidth,oldHeight,boundsItem,oldSize,matrix,designEffect,originalUrl,newBoundsItem,newSize,newWidth,newHeight,sx,sy,scale;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.canEditItem(item))return[2/*return*/,item];url=image.get("previewUrl");if(!url)return[2/*return*/,item];this.beginDesignOperation();designItem=this.findDesignItemByGuid(item.data.guid);if(item.data.isSVGRecolored)item.data.isSVGRecolored=false;if(!designItem)return[3/*break*/,7];currentImageID=designItem.get("imageID");if(!(currentImageID!==image.get("imageID")||url.startsWith('data:')))return[3/*break*/,7];shape=this.getMaskedImageShapeItem(item);raster=this.getMaskedImageRasterItem(item);if(!raster)return[3/*break*/,7];oldWidth=raster.width;oldHeight=raster.height;// Image Original Bounds & Matrix
// Calcolo le dimensioni del contorno iniziale trasformato
if(raster.data.originalBounds&&raster.data.originalMatrix){boundsItem=new this.paper.Path.Rectangle(raster.data.originalBounds);boundsItem.visible=false;boundsItem.matrix=raster.data.originalMatrix.clone();oldSize=this.getRectangleItemSize(boundsItem);boundsItem.remove();oldWidth=oldSize.width;oldHeight=oldSize.height;}matrix=raster.matrix;designEffect=this.getDesignEffectForDesignItem(designItem);originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,item)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:// ----------------------
return[4/*yield*/,this.changeRasterItem(raster,url)];case 6:// ----------------------
_a.sent();raster.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);raster.matrix=matrix;newBoundsItem=new this.paper.Path.Rectangle(0,0,raster.width,raster.height);newBoundsItem.visible=false;newBoundsItem.matrix=matrix.clone();newSize=this.getRectangleItemSize(newBoundsItem);newBoundsItem.remove();newWidth=newSize.width;newHeight=newSize.height;if(newWidth!=oldWidth||newHeight!=oldHeight){sx=1.0,sy=1.0;if(Math.abs(newWidth)>0.0000001)sx=oldWidth/newWidth;if(Math.abs(newHeight)>0.0000001)sy=oldHeight/newHeight;scale=Math.min(sx,sy);raster.scale(scale,scale);}designItem.get("colors").reset();this.updateDesignItemColorMappings(designItem,colorMappings);this.onImageItemUpdated(item,image,this.createDummyShapeFromDesignItem(designItem));this.updateSelectionState();this.paper.project.view.update();this.fireImageLoadedEvent();_a.label=7;case 7:this.endDesignOperation();return[2/*return*/,item];}});});},getOrCreateDesignItemConstraints:function(designItem){var constraints=designItem.get("constraints");if(!constraints){constraints=new MPlaza.DesignItemConstraints();designItem.set("constraints",constraints);}return constraints;},updateItemsIndexes:function(){var _this_1=this;var orderedItems=this.design.getSideDesignItems(this.side).sort(function(a,b){return a.get("index")>b.get("index");}).map(function(x){return _this_1.findItemForDesignItem(x);});// Basic ordering
orderedItems.forEach(function(x){x===null||x===void 0?void 0:x.bringToFront();// Update correctly the shape image placeholder icons
_this_1.updateShapeImagePlaceholder(x);});// Bring to front the always-on-top items
var topItems=orderedItems.filter(function(item){return _this_1.isAlwaysOnTop(item);});topItems.forEach(function(item){return item.bringToFront();});topItems.forEach(function(item){return _this_1.onItemUpdated(item);});// Send to back the grids
this.getAllGridItems().forEach(function(item){return item.sendToBack();});// Send to back the backgrounds
var backgrounds=this.getAllItems().filter(function(item){return item.data&&item.data.isGroupForBackground;});backgrounds.forEach(function(bg){return bg.sendToBack();});backgrounds.forEach(function(bg){return bg.children.forEach(function(c){if(c.data&&(c.data.isImageForBackground||c.data.isAreaForBackground)){c.sendToBack();_this_1.onItemUpdated(c);}});});// Sui gruppi di background eseguo un send to back
var newGroupItems=[];function addChildren(item){if(item.children){for(var j=0;j<item.children.length;j++){var child=item.children[j];if(child.data&&child.data.isGroupForBackground){newGroupItems.push(child);}else addChildren(child);}}}addChildren(this.masterGroup);newGroupItems.forEach(function(x){x.sendToBack();});},// funzione di utilità che restituisce le dimensioni di un item rettangolo
// calcolando le lunghezze dei segmenti che ne costituiscono l'altezza e la larghezza.
// Nel caso di elemento ruotato, le dimensioni sono ovviamente diverse da quelle
// normalmente restituite dal bounding box
getRectangleItemSize:function(rectangle){var width=0;var height=0;var segments=rectangle.segments;if(segments.length==4){var bottomLeft=segments[0].point;var topLeft=segments[1].point;var topRight=segments[2].point;var bottomRight=segments[3].point;width=topRight.subtract(topLeft).length;height=bottomLeft.subtract(topLeft).length;}return new this.paper.Size(width,height);},modifySelectedImageElementColors:function(colorChanges){return __awaiter(this,void 0,void 0,function(){var items,item;return __generator(this,function(_a){switch(_a.label){case 0:items=this.getSelectedItems();if(!(items&&items.length>0))return[3/*break*/,2];item=items[0];return[4/*yield*/,this.modifyImageElementColors(item,colorChanges)];case 1:_a.sent();_a.label=2;case 2:return[2/*return*/];}});});},modifyImageElementColors:function(item,colorChanges){return __awaiter(this,void 0,void 0,function(){var raster,previousSide,designItem,oldDesignItem,imageID,recoloredImage,i,colorChange,change,imageUrl,matrix,url,designEffect,originalUrl,colorMappings,idx,colorChange;return __generator(this,function(_a){switch(_a.label){case 0:raster=this.getMaskedImageRasterItem(item);previousSide=this.side;if(!(this.design&&item&&raster&&Object.prototype.toString.call(colorChanges)==='[object Array]'))return[3/*break*/,7];designItem=this.findDesignItemByGuid(item.data.guid);oldDesignItem=designItem.clone();if(!(designItem&&designItem instanceof MPlaza.DesignItem&&designItem.get("imageID")>0))return[3/*break*/,7];this.beginDesignOperation();imageID=designItem.get("imageID");recoloredImage=new MPlaza.RecoloredImage();recoloredImage.set("imageID",imageID);recoloredImage.set("versionKey","preview");for(i=0;i<colorChanges.length;i++){colorChange=colorChanges[i];if(colorChange instanceof MPlaza.ColorChange)recoloredImage.get("colorChanges").push(colorChange);else if(colorChange.hasOwnProperty("colorID")&&colorChange.hasOwnProperty("code")){change=new MPlaza.ColorChange(colorChange);recoloredImage.get("colorChanges").push(change);}}return[4/*yield*/,new Promise(function(resolve,reject){recoloredImage.save(null,{success:function(model,response,options){if(model&&model.get("imageID")){resolve(recoloredImage.get("imageUrl"));}else{reject("Errore nella lettura dei dati! "+model.get("message"));}},error:function(model,response,options){reject("Errore nella lettura dei dati");}});})];case 1:imageUrl=_a.sent();if(!(imageUrl&&this.side==previousSide))return[3/*break*/,7];matrix=raster.matrix;url=imageUrl;designEffect=this.getDesignEffectForDesignItem(designItem);originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 2:url=_a.sent();return[4/*yield*/,this.getImageDefaultColorMappings(url,item)];case 3:colorMappings=_a.sent();if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:this.updateDesignItemColorMappings(designItem,colorMappings);/* Non posso riutilizzare il mapping dei colori precedente, semplicemente perché i colori di partenza potrebbero non esistere più
                        let colorMappings = designItem.get("colorMappings").toJSON();
                        if (colorMappings && colorMappings.length > 0) {
                            url = await this.recolorImage(url, colorMappings);
                        }
                        */return[4/*yield*/,this.changeRasterItem(raster,url)];case 6:/* Non posso riutilizzare il mapping dei colori precedente, semplicemente perché i colori di partenza potrebbero non esistere più
                        let colorMappings = designItem.get("colorMappings").toJSON();
                        if (colorMappings && colorMappings.length > 0) {
                            url = await this.recolorImage(url, colorMappings);
                        }
                        */_a.sent();raster.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);raster.matrix=matrix;// imposto i cambi di colore
for(idx=0;idx<colorChanges.length;idx++){colorChange=colorChanges[idx];if(colorChange instanceof MPlaza.ColorChange){designItem.changeColor(imageID,colorChange.get("colorID"),colorChange.get("code"));item.data.isSVGRecolored=true;}else if(colorChange.hasOwnProperty("colorID")&&colorChange.hasOwnProperty("code")){designItem.changeColor(imageID,colorChange["colorID"],colorChange["code"]);item.data.isSVGRecolored=true;}}this.updateDesignItemColors(designItem,designItem.get('colors').map(function(x){return x.get('colorCode');}));this.registerItemOperation("update",designItem.get("itemGuid"),oldDesignItem,designItem);console.log('item: ',item);this.onItemUpdated(item);this.onDesignItemChanged(item);this.updateSelectionState();this.paper.project.view.update();this.fireImageLoadedEvent();this.endDesignOperation();_a.label=7;case 7:return[2/*return*/];}});});},// La funzione seguente non dovrebbe essere mai chiamata, la lascio per il momento
modifySelectedImageElementsColors:function(colorChanges){if(this.design&&Object.prototype.toString.call(colorChanges)==='[object Array]'){var customizer=this;var items=this.getSelectedImageItems();if(items.length==0)return;this.beginDesignOperation();// Recupero i design items relativi agli elementi selezionati
// e determino l'id comune dell'immagine
var imageID=null;var designItemsHash={};for(var i=0;i<items.length;i++){var item=items[i];var designItem=this.findDesignItemByGuid(item.data.guid);var id=designItem.get("imageID");if(imageID==null)imageID=id;else if(imageID!=id){// Problema: immagini con id diversi
return;}designItemsHash[item.data.guid]=designItem;}// funzione che aggiorna l'url di tutti i raster item
// e inserisce i cambi di colore nei rispettivi design items
// aggiornado di questi ultimi anche l'elenco globale di colori
var setImageData=function(imageData,imageColors){if(imageData){var url='data:image/png;base64,'+imageData;var _loop_2=function(){item=items[i];designItem=designItemsHash[item.data.guid];customizer.updateDesignItemColors(designItem,imageColors);var raster=customizer.getMaskedImageRasterItem(item);matrix=raster.matrix;raster.crossOrigin="anonymous";raster.source=url;raster.onLoad=function(){raster.matrix=matrix;// imposto i cambi di colore
for(var idx=0;idx<colorChanges.length;idx++){var colorChange=colorChanges[idx];if(colorChange instanceof MPlaza.ColorChange)designItem.changeColor(imageID,colorChange.get("colorID"),colorChange.get("code"));else if(colorChange.hasOwnProperty("colorID")&&colorChange.hasOwnProperty("code")){designItem.changeColor(imageID,colorChange["colorID"],colorChange["code"]);}}customizer.onItemUpdated(item);customizer.updateSelectionState();customizer.paper.project.view.update();customizer.fireImageLoadedEvent();this.beginDesignOperation();};};var item,designItem,matrix;for(var i=0;i<items.length;i++){_loop_2();}}};// Recupero i bytes dell'immagine ricolorata
try{var recoloredImage=new MPlaza.RecoloredImage();recoloredImage.set("imageID",imageID);recoloredImage.set("versionKey","preview");for(var i=0;i<colorChanges.length;i++){var colorChange=colorChanges[i];if(colorChange instanceof MPlaza.ColorChange)recoloredImage.get("colorChanges").push(colorChange);else if(colorChange.hasOwnProperty("colorID")&&colorChange.hasOwnProperty("code")){var change=new MPlaza.ColorChange(colorChange);recoloredImage.get("colorChanges").push(change);}}recoloredImage.save(null,{success:function(model,response,options){if(model&&model.get("imageID")){Logger.info("Immagine letta correttamente");setImageData(recoloredImage.get("imageData"),recoloredImage.get("imageColors"));}else{Logger.info("Errore nella lettura dei dati! "+model.get("message"));}},error:function(model,response,options){Logger.info("Errore nella lettura dei dati");}});}catch(e){Logger.info(e);}}},setEditingItem:function(item,isEditing){if(!item||isEditing==null)return;this.removeLoadingCircle(item);if(isEditing){var areas=this.getAreasIntersectingOrContainingItem(item);if(areas&&areas.length>0){this.createLoadingCircle(item,item.bounds.center);}}},createLoadingCircle:function(item,point){if(!point)return null;var s=25/this.paper.view.zoom;var url=Zakeke.config.baseUrl+"/images/customizer/loading-circle.png";var icon=new this.paper.Raster({source:url,position:point});var resizeIcon=function(){var originalSize=icon.size;var size=new this.paper.Size(s,s);var sx=1.0,sy=1.0;if(Math.abs(originalSize.width)>0.0000001)sx=size.width/originalSize.width;if(Math.abs(originalSize.height)>0.0000001)sy=size.height/originalSize.height;icon.scale(sx,sy);};if(icon.size.width>0&&icon.size.height>0){resizeIcon();}else{icon.onLoad=function(){resizeIcon();};}icon.data.isLoadingCircle=true;item.loadingCircle=icon;this.loadingCircles.push(icon);return icon;},removeLoadingCircle:function(item){if(!item||!item.hasOwnProperty("loadingCircle")||!item.loadingCircle)return;var circle=item.loadingCircle;this.loadingCircles=this.loadingCircles.filter(function(x){return x!=circle;});circle.remove();item.loadingCircle=null;},// -------------------------------------------------------------
// Area Backgrounds functions
// -------------------------------------------------------------
scaleBgImage:function(targetArea,delta){this.beginDesignOperation();var bgGroup=this.getOrCreateBackgroundGroupItem(targetArea);var bgImage=bgGroup.children.find(function(x){return x.data&&x.data.isImageForBackground;});if(bgImage){bgImage.scaling=new this.paper.Point(delta,delta);this.onItemUpdated(bgImage);this.updateSelectionState();this.paper.view.update();this.endDesignOperation();}},insertImageAsBackground:function(image,area,colorMappings){return __awaiter(this,void 0,void 0,function(){var item,syncGuid,areaItem,groupWithAreaBackground,recoloredArea,designItem,url,originalUrl,designEffect,constraints,designItem,itemBounds,areaBounds,targetBounds,sx,sy,signx,signy;var _this_1=this;return __generator(this,function(_a){switch(_a.label){case 0:item=null;syncGuid=null;if(!image||!(image instanceof MPlaza.Image))return[2/*return*/,item];areaItem=this.findItemForArea(area);groupWithAreaBackground=this.getOrCreateBackgroundGroupItem(areaItem);recoloredArea=groupWithAreaBackground.children.find(function(x){return x.data&&x.data.isAreaForBackground;});// Removed recolored area (if exists)
if(recoloredArea){designItem=this.findDesignItemForItem(recoloredArea);if(designItem)syncGuid=designItem.get('syncGuid');recoloredArea.remove();this.onItemRemoved(recoloredArea);}url="";if(!this.isImageScalingEnabled&&image.get("format").toLowerCase()!="svg"&&image.get("type").toLowerCase()!="vector"&&["png","jpg","jpeg"].find(function(x){return x==image.get("format").toLowerCase();}))url=image.get("url");if(!url)url=image.get("previewUrl");if(!url)return[2/*return*/,item];if(!(this.side&&area))return[3/*break*/,7];this.beginDesignOperation();originalUrl=url;designEffect=this.getDesignEffectForArea(area);return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,null)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:return[4/*yield*/,this.createRasterItem(url,false)];case 6:// ------
item=_a.sent();item.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);item.data.originalImageID=image.id;item.data.isImageForBackground=true;item.data.areaGuid=groupWithAreaBackground.data.areaGuid;constraints=null;// Remove old bg images from group
groupWithAreaBackground.children.forEach(function(x){if(x.data.isImageForBackground){var designItem=_this_1.findDesignItemForItem(x);if(designItem){syncGuid=designItem.get('syncGuid');constraints=designItem.get("constraints");}x.remove();_this_1.onItemRemoved(x);}});this.onItemCreated(item,image);designItem=this.findDesignItemForItem(item);designItem.set('syncGuid',syncGuid);this.updateDesignItemColorMappings(designItem,colorMappings);if(constraints)designItem.setConstraintsFromSource(constraints);// centro l'elemento all'interno dell'area
if(areaItem){item.position=areaItem.position;itemBounds=item.bounds;areaBounds=areaItem.bounds;if(areaBounds.intersects(itemBounds)||itemBounds.contains(areaBounds)){targetBounds=areaBounds.clone();sx=1.0;sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;signx=sx>0?1:-1;signy=sy>0?1:-1;sx=sy=Math.max(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;item.scale(sx,sy);item.visible=true;item.data.initialScaleX=sx;item.data.initialScaleY=sy;// Image Original Bounds & Matrix
// Tra i metadati dell'item salvo il bounds originale dell'immagine e la trasformazione applicata
// La matrice di trasformazone viene mantenuta aggiornata ad ogni trasformazione applicata all'oggetto
// Questi dati verranno utilizzati quando il contenuto dell'immagine è sostituito con il contenuto
// di una nuova. Se le dimensioni non sono le stesse, all'immagine sostitutiva verrà applicata
// una trasformazione in modo che resti nell'ambito degli stessi contorni iniziali.
item.data.originalBounds=new this.paper.Rectangle(0,0,item.width,item.height);item.data.originalMatrix=item.matrix.clone();// -------------------------
}}groupWithAreaBackground.addChild(item);this.updateItemsIndexes();this.onItemUpdated(item);this.onDesignItemChanged(item);this.fireImageLoadedEvent();this.endDesignOperation();_a.label=7;case 7:return[2/*return*/,item];}});});},removeBackgroundColorArea:function(area){var _this_1=this;this.beginDesignOperation();var group=this.getOrCreateBackgroundGroupItem(area);// Remove old bg elements from group
group.children.forEach(function(x){if(x.data.isImageForBackground||x.data.isAreaForBackground){var designItem=_this_1.findDesignItemForItem(x);_this_1.fireDesignItemRemovingEvent(designItem,x);x.remove();_this_1.onItemRemoved(x);}});this.endDesignOperation();},changeBackgroundColorArea:function(area,color,callback){this.beginDesignOperation();var customizer=this;var syncGuid=null;var group=this.getOrCreateBackgroundGroupItem(area);// Remove old bg elements from group
group.children.forEach(function(x){if(x.data.isImageForBackground||x.data.isAreaForBackground){var designItem=customizer.findDesignItemForItem(x);if(designItem)syncGuid=designItem.get('syncGuid');x.remove();callback(x);customizer.onItemRemoved(x);}});// Create recolored area
var recoloredArea=group.children.find(function(x){return x.data&&x.data.isAreaForBackground;});if(!recoloredArea){//recoloredArea = new this.paper.Path.Rectangle(group.children[0].bounds.clone());
var maxsize=Math.max(group.children[0].bounds.width,group.children[0].bounds.height);recoloredArea=new this.paper.Path.Rectangle(group.children[0].bounds.point,new this.paper.Size(maxsize,maxsize));var position=new this.paper.Point(recoloredArea.position.x-(maxsize-group.children[0].bounds.width)/2,recoloredArea.position.y-(maxsize-group.children[0].bounds.height)/2);//recoloredArea.point = position;
recoloredArea.position=position;recoloredArea.data={'guid':MPlaza.generateUUID(),'areaGuid':area.data.guid,isAreaForBackground:true};recoloredArea.strokeWidth=0;recoloredArea.visible=true;group.addChild(recoloredArea);this.onItemCreated(recoloredArea);}var designItem=customizer.findDesignItemForItem(recoloredArea);designItem.set('syncGuid',syncGuid);recoloredArea.fillColor=color;var designEffect=this.getDesignEffectForDesignItem(designItem);this.applyDesignEffectToItem(designEffect,recoloredArea);this.onItemUpdated(recoloredArea);this.endDesignOperation();return recoloredArea;},// Get or create background group with area item based on input area (paper obj)
getOrCreateBackgroundGroupItem:function(area){var newGroupItem;function addChildren(item){if(item.children){for(var j=0;j<item.children.length;j++){var child=item.children[j];if(child.data&&child.data.areaGuid===area.data.guid&&child.data.isGroupForBackground){newGroupItem=child;return;}else addChildren(child);}}}addChildren(this.masterGroup);if(!newGroupItem){var newAreaItem=area.clone();newAreaItem.data={'guid':MPlaza.generateUUID(),'areaGuid':area.data.guid,isClippingAreaForBackground:true};newAreaItem.strokeWidth=0;newAreaItem.visible=true;newGroupItem=new this.paper.Group(newAreaItem);newGroupItem.clipped=true;newGroupItem.data={'guid':MPlaza.generateUUID(),'areaGuid':area.data.guid,isGroupForBackground:true};newGroupItem.addChild(newAreaItem);this.masterGroup.addChild(newGroupItem);newGroupItem.sendToBack();}return newGroupItem;},// -------------------------------------------------------------
// Text
// -------------------------------------------------------------
getAllTextItems:function(){var _this_1=this;return this.getAllItems().filter(function(i){return _this_1.getItemIsTextElement(i);});},setEditTextCallback:function(callback){this.editTextCallback=callback;},textInfoModified:function(info){if(!info||!this.mouseStartPos)return;if(!this.element)this.addTextElement(this.mouseStartPos,info);else this.modifyTextElement(this.element,info);this.element=null;},createText:function(event){if(!this.canAddText())return;if(this.editTextCallback){var info={};info.text="";info.strokeColor="#000000";info.strokeWidth=0;info.fillColor="#000000";info.fontFamily="Arial";info.fontSize=12;info.fontWeight="normal";info.justification="left";info.shadowColor=null;info.shadowBlur=0;info.shadowDistance=7;info.shadowAngle=45;var customizer=this;this.editTextCallback(info,function(textInfo){customizer.textInfoModified(textInfo);});}},editText:function(){this.selectElement();if(!this.canEditSelection())return;if(this.element&&this.element instanceof this.paper.TextItem&&this.editTextCallback){var info={};info.text=this.element.content;info.strokeColor=this.element.strokeColor.toCSS(true);info.strokeWidth=this.element.strokeWidth;info.fillColor=this.element.fillColor.toCSS(true);info.fontFamily=this.element.fontFamily;info.fontSize=this.element.fontSize;info.fontWeight=this.element.fontWeight;info.justification=this.element.justification;info.shadowColor=this.element.shadowColor;info.shadowBlur=this.element.shadowBlur;info.shadowDistance=this.getOffsetDistance(this.element.shadowOffset);info.shadowAngle=this.getOffsetAngle(this.element.shadowOffset);var customizer=this;this.editTextCallback(info,function(textInfo){customizer.textInfoModified(textInfo);});}},addTextElement:function(point,info,forceAdding,initialFontSize){if(forceAdding===void 0){forceAdding=false;}if(initialFontSize===void 0){initialFontSize=null;}if(!forceAdding&&!this.canAddText())return null;var text=null;if(this.side){var area=this.side.get("areas").getMaxArea();if(area){var designEffect=this.getDesignEffectForArea(area);if(info&&info.text){this.beginDesignOperation();this.deselectAll();this.updateSelectionState();if(!this.allowShadows())info.shadowColor=null;var originalStrokeColor=info.strokeColor||'#000000';var originalFillColor=info.fillColor||'#000000';var originalShadowColor=info.shadowColor||null;originalStrokeColor=this.forceColorInFixedPalette(null,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(null,originalFillColor);originalShadowColor=this.forceColorInFixedPalette(null,originalShadowColor);info.shadowBlur=this.adjustInputShadowBlur(null,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(null,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(null,info.shadowAngle);if(info.fontSize!=undefined&&info.fontSize!=null&&typeof info.fontSize==="string"){info.fontSize=parseInt(info.fontSize);}text=new this.paper.PointText({rotation:info.rotation||0,content:info.text,strokeColor:this.applyDesignEffectToTextColor(designEffect,originalStrokeColor),strokeWidth:info.strokeWidth!=undefined?info.strokeWidth:0,fillColor:this.applyDesignEffectToTextColor(designEffect,originalFillColor),fontFamily:this.sanitizeFontFamilyName(info.fontFamily)||'Verdana',fontWeight:info.fontWeight||'normal normal',fontStretch:info.fontStretch||'normal',fontStyle:info.fontStyle||"normal",fontSize:info.fontSize||48,justification:info.justification||'center',shadowColor:info.shadowColor||null,shadowBlur:info.shadowBlur||0,shadowOffset:this.getOffsetByDistanceAngle(info.shadowDistance,info.shadowAngle),lineSpacing:info.lineSpacing,letterSpacing:info.letterSpacing});// Test fontSize limitation
text.fontSize=this.adjustTextFontSize(text,text.fontSize);// Help to check if an item is text outside the customizer
text.data={};text.data.isText=true;text.data.originalStrokeColor=originalStrokeColor;text.data.originalFillColor=originalFillColor;text.data.originalShadowColor=originalShadowColor;this.applyDesignEffectToItem(designEffect,text);this.masterGroup.addChild(text);this.onItemCreated(text);this.setItemSelection(text,true);if(point==null){if(area){var areaItem=this.findItemForArea(area);if(areaItem){// Center the text in the area
text.position=areaItem.position;//if the item is outside the area, set the position on an internal point
if(!areaItem.contains(text.position))text.position=areaItem.interiorPoint;if(text.bounds.height>0&&areaItem.bounds.height>0){/*
                                    // If text is too high, reduce it
                                    if (text.bounds.height > areaItem.bounds.height)
                                        text.scale(areaItem.bounds.height / text.bounds.height);

                                    // If text is too small compared to area height, then increase it to 10% of area height
                                    if (text.bounds.height / areaItem.bounds.height < 0.1)
                                        text.scale(areaItem.bounds.height * 0.1 / text.bounds.height);
                                    */ // Test font limits
if(text.bounds.height>areaItem.bounds.height){var newScale=areaItem.bounds.height/text.bounds.height;newScale=this.adjustTextFontScaling(text,newScale);text.scale(newScale);}// If text is too small compared to area height, then increase it to 10% of area height
if(!initialFontSize&&text.bounds.height/areaItem.bounds.height<0.1){var newScale=areaItem.bounds.height*0.1/text.bounds.height;newScale=this.adjustTextFontScaling(text,newScale);text.scale(newScale);}}this.onItemUpdated(text);this.onDesignItemChanged(text);}}else{text.position=this.paper.view.center;}}else{text.position=point;}if(this.isSafari){text.visible=false;var that=this;setTimeout(function(){text.visible=true;that.paper.project.view.update(true);that.updateSelectionState();},2000);}else{this.updateSelectionState();this.paper.project.view.update(true);}//isTextOnPath? 
if(info.isTextOnPath)text=this.convertSelectedTextItemsToTextOnPath();this.endDesignOperation();}}}return text;},modifyTextElement:function(item,info){if(!this.canEditItem(item))return;if(!item)return;this.beginDesignOperation();if(item.data&&item.data.isTextOnPath){this.modifyTextOnPathInfo(item,info);}else if(item.data&&item.data.isTextArea){this.modifyTextAreaInfo(item,info);}else{var designEffect=null;var designItem=this.findDesignItemForItem(item);if(designItem)designEffect=this.getDesignEffectForDesignItem(designItem);var constraints=this.getItemConstraints(item);item.content=this.adjustInputTextByConstraints(item,info.text)||item.content;if(!constraints||constraints.get("canChangeFontColor")){var originalStrokeColor=info.strokeColor||this.convertColorToHex(item.strokeColor);var originalFillColor=info.fillColor||this.convertColorToHex(item.fillColor);originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(item,originalFillColor);item.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);item.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;}if(!constraints||constraints.get("canChangeShadowColor")){var originalShadowColor=info.shadowColor||this.convertColorToHex(item.shadowColor);originalShadowColor=this.forceColorInFixedPalette(item,originalShadowColor);item.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);item.data.originalShadowColor=originalShadowColor;}if(!this.allowShadows())item.shadowColor=null;item.shadowBlur=this.adjustInputShadowBlur(item,info.shadowBlur);item.shadowOffset=this.getOffsetByDistanceAngle(this.adjustInputShadowDistance(item,info.shadowDistance),this.adjustInputShadowAngle(item,info.shadowAngle));item.strokeWidth=info.strokeWidth!=undefined?info.strokeWidth:item.strokeWidth;if(!constraints||constraints.get("canChangeFontFamily"))item.fontFamily=this.sanitizeFontFamilyName(info.fontFamily||item.fontFamily);item.fontWeight=this.adjustInputFontWeightByConstraints(item,info.fontWeight,constraints);if(!constraints||constraints.get("canChangeFontSize"))item.fontSize=info.fontSize||item.fontSize;if(!constraints||constraints.get("canChangeJustification"))item.justification=info.justification||item.justification;if(info.scaling)item.scaling=info.scaling;if(info.rotation)item.rotation=info.rotation;}this.onItemUpdated(item);this.onDesignItemChanged(item);this.setItemSelection(item,true);this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();},modifyTextElements:function(items,info){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElement(items[i],info);}}else{this.modifyTextElement(items,info);}},modifyTextElementContentByGuid:function(guid,content){var item=this.findItemByGuid(guid);if(item)this.modifyTextElementContent(item,content);},modifyTextElementContent:function(item,content){if(!this.canEditItem(item))return;if(this.sameTextElementContent(item,content))return;var info=null;this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.content=this.adjustInputTextByConstraints(item,content);item.data.needsTransformsDataUpdate=true;this.updateSelectionState();this.paper.project.view.update();this.onItemUpdated(item);this.onDesignItemChanged(item);}else if(item&&item.data&&item.data.isTextOnPath){info={text:content};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.onDesignItemChanged(item);}else if(item&&item.data&&item.data.isTextArea){info={text:content};this.modifyTextAreaInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.onDesignItemChanged(item);}this.endDesignOperation();},modifyTextElementsContent:function(items,content){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementContent(items[i],content);}}else{this.modifyTextElementContent(items,content);}},setIsPlaceHolderItem:function(item,value){item.data.isPlaceHolder=value;var designItem=this.findDesignItemByGuid(item.data.guid);var json=item.exportJSON({asString:true});designItem.set("json",json);},setIsPlaceHolderItems:function(items,content){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.setIsPlaceHolderItems(items[i],content);}}else{this.setIsPlaceHolderItem(items,content);}},sameTextElementContent:function(item,content){var itemInfo=this.getTextItemInfo(item);if(itemInfo){var newText=this.adjustInputTextByConstraints(item,content);if(itemInfo.text===newText)return true;}return false;},modifyTextElementFillColorByGuid:function(guid,content){var item=this.findItemByGuid(guid);if(item)this.modifyTextElementFillColor(item,content);},modifyTextElementFillColor:function(item,color){if(!this.canChangeItemFontColor(item))return;var currentColor=undefined;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.fillColor){if(itemInfo.fillColor instanceof this.paper.Color)currentColor=itemInfo.fillColor.toCSS(true);else if(typeof itemInfo.fillColor==="string")currentColor=itemInfo.fillColor;}if(currentColor&&currentColor===color)return;var info=null;this.beginDesignOperation();var designEffect=null;var designItem=this.findDesignItemForItem(item);if(designItem)designEffect=this.getDesignEffectForDesignItem(designItem);if(item&&item instanceof this.paper.TextItem){var originalColor=color;originalColor=this.forceColorInFixedPalette(item,originalColor,currentColor);var newColor=this.applyDesignEffectToTextColor(designEffect,originalColor);item.fillColor=newColor;item.data.needsTransformsDataUpdate=true;item.data.originalFillColor=originalColor;this.paper.project.view.update();this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextOnPath){info={fillColor:color};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={fillColor:color};this.modifyTextAreaInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();},modifyTextElementsFillColor:function(items,color){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementFillColor(items[i],color);}}else{this.modifyTextElementFillColor(items,color);}},// Shadow Color
modifyTextElementShadowColorByGuid:function(guid,color){var item=this.findItemByGuid(guid);if(item)this.modifyTextElementShadowColor(item,color);},modifyTextElementShadowColor:function(item,color){if(!this.canChangeItemShadowColor(item))return;if(!this.allowShadows())color=null;var currentColor=undefined;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.shadowColor){if(itemInfo.shadowColor instanceof this.paper.Color)currentColor=itemInfo.shadowColor.toCSS(true);else if(typeof itemInfo.shadowColor==="string")currentColor=itemInfo.shadowColor;}if(currentColor&&currentColor===color)return;var info=null;this.beginDesignOperation();var designEffect=null;var designItem=this.findDesignItemForItem(item);if(designItem)designEffect=this.getDesignEffectForDesignItem(designItem);if(item&&item instanceof this.paper.TextItem){var originalColor=color;originalColor=this.forceColorInFixedPalette(item,originalColor,currentColor);var newColor=this.applyDesignEffectToTextColor(designEffect,originalColor);item.shadowColor=newColor;item.data.needsTransformsDataUpdate=true;item.data.originalShadowColor=originalColor;this.paper.project.view.update();this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextOnPath){info={shadowColor:color};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={shadowColor:color};this.modifyTextAreaInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();},modifyTextElementsShadowColor:function(items,color){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementShadowColor(items[i],color);}}else{this.modifyTextElementShadowColor(items,color);}},// Shadow Blur
modifyTextElementShadowBlur:function(item,blur){if(!this.canChangeItemShadowBlur(item))return;blur=this.adjustInputShadowBlur(item,blur);var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.shadowBlur=blur;item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();}else if(item&&item.data&&item.data.isTextOnPath){info={shadowBlur:blur};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={shadowBlur:blur};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsShadowBlur:function(items,blur){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementShadowBlur(items[i],blur);}}else{this.modifyTextElementShadowBlur(items,blur);}},// Shadow Distance
modifyTextElementShadowDistance:function(item,distance){if(!this.canChangeItemShadowDistance(item))return;distance=this.adjustInputShadowDistance(item,distance);var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){var angle=this.getOffsetAngle(item.shadowOffset);item.shadowOffset=this.getOffsetByDistanceAngle(distance,angle);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();}else if(item&&item.data&&item.data.isTextOnPath){info={shadowDistance:distance};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={shadowDistance:distance};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsShadowDistance:function(items,distance){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementShadowDistance(items[i],distance);}}else{this.modifyTextElementShadowDistance(items,distance);}},// Shadow Angle
modifyTextElementShadowAngle:function(item,angle){if(!this.canChangeItemShadowAngle(item))return;angle=this.adjustInputShadowAngle(item,angle);var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){var distance=this.getOffsetDistance(item.shadowOffset);item.shadowOffset=this.getOffsetByDistanceAngle(distance,angle);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();}else if(item&&item.data&&item.data.isTextOnPath){info={shadowAngle:angle};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={shadowAngle:angle};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsShadowAngle:function(items,angle){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementShadowAngle(items[i],angle);}}else{this.modifyTextElementShadowAngle(items,angle);}},resetTextElementShadow:function(item){if(item&&item.data&&item.data.guid){var designItem=this.findDesignItemForItem(item);var info=this.getTextItemInfo(item);if(designItem&&info){var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(!this.allowShadows())info.shadowColor=null;info.shadowBlur=this.adjustInputShadowBlur(item,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(item,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(item,info.shadowAngle);if(item instanceof this.paper.TextItem){var designEffect=this.getDesignEffectForDesignItem(designItem);var originalColor=info.shadowColor;originalColor=this.forceColorInFixedPalette(item,originalColor);info.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalColor);item.shadowColor=info.shadowColor;item.shadowBlur=info.shadowBlur;item.shadowDistance=info.shadowDistance;item.shadowAngle=info.shadowAngle;item.data.needsTransformsDataUpdate=true;item.data.originalShadowColor=originalColor;this.paper.project.view.update();this.onItemUpdated(item);}else if(item.data.isTextOnPath){info={shadowColor:info.shadowColor,shadowBlur:info.shadowBlur,shadowDistance:info.shadowDistance,shadowAngle:info.shadowAngle};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item.data.isTextArea){info={shadowColor:info.shadowColor,shadowBlur:info.shadowBlur,shadowDistance:info.shadowDistance,shadowAngle:info.shadowAngle};this.modifyTextAreaInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);}}},sanitizeFontFamilyName:function(fontFamily){return'"'+fontFamily.replace(/"/g,"")+'"';},modifyTextElementFontFamilyByGuid:function(guid,fontFamily){var item=this.findItemByGuid(guid);if(item)this.modifyTextElementFontFamily(item,fontFamily);},modifyTextElementFontFamily:function(item,fontFamily){if(!this.canChangeItemFontFamily(item))return;if(this.sameTextElementFontFamily(item,fontFamily))return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.fontFamily=this.sanitizeFontFamilyName(fontFamily);item.data.needsTransformsDataUpdate=true;if(this.isSafari){item.visible=false;var that=this;setTimeout(function(){item.visible=true;that.paper.project.view.update(true);that.onItemUpdated(item);that.updateSelectionState();},2000);}else{this.paper.project.view.update(true);this.onItemUpdated(item);this.updateSelectionState();}}else if(item&&item.data&&item.data.isTextOnPath){info={fontFamily:fontFamily};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={fontFamily:fontFamily};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsFontFamily:function(items,fontFamily){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementFontFamily(items[i],fontFamily);}}else{this.modifyTextElementFontFamily(items,fontFamily);}},sameTextElementFontFamily:function(item,fontFamily){var itemInfo=this.getTextItemInfo(item);if(itemInfo){var currentFontFamily=this.sanitizeFontFamilyName(itemInfo.fontFamily);var newFontFamily=this.sanitizeFontFamilyName(fontFamily);if(currentFontFamily===newFontFamily)return true;}return false;},modifyTextElementFontSize:function(item,fontSize){if(!this.canChangeItemFontSize(item))return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.fontSize=fontSize;item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();}else if(item&&item.data&&item.data.isTextOnPath){info={fontSize:fontSize};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={fontSize:fontSize};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsFontSize:function(items,fontSize){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementFontSize(items[i],fontSize);}}else{this.modifyTextElementFontSize(items,fontSize);}},modifyTextElementFontWeight:function(item,fontWeight){if(!this.canChangeItemFontWeight(item))return;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.fontWeight===fontWeight)return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.fontWeight=fontWeight;item.data.needsTransformsDataUpdate=true;this.paper.project.view.update();this.onItemUpdated(item);this.updateSelectionState();}else if(item&&item.data&&item.data.isTextOnPath){info={fontWeight:fontWeight};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={fontWeight:fontWeight};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsFontWeight:function(items,fontWeight){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementFontWeight(items[i],fontWeight);}}else{this.modifyTextElementFontWeight(items,fontWeight);}},modifyTextElementFontStretch:function(item,fontStretch){var info=null;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.fontStretch===fontStretch)return;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){item.fontStretch=fontStretch;item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();}else if(item&&item.data&&item.data.isTextOnPath){info={fontStretch:fontStretch};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={fontStretch:fontStretch};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsFontStretch:function(items,fontStretch){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementFontStretch(items[i],fontStretch);}}else{this.modifyTextElementFontStretch(items,fontStretch);}},modifyTextElementJustification:function(item,justification){if(!this.canChangeItemJustification(item))return;this.beginDesignOperation();var info=null;var textInfo=this.getTextItemInfo(item);if(textInfo.justification&&textInfo.justification==justification)return;if(item&&item instanceof this.paper.TextItem)item=this.fromTextToTextArea(item);if(item&&item.data&&item.data.isTextOnPath){info={justification:justification};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={justification:justification};var oldBounds=item.bounds.clone();this.modifyTextAreaInfo(item,info);if(!item.data.isTextBox){//Restore item position to fix small unwanted movements
item.position.x=oldBounds.x+oldBounds.width/2;if(Math.abs(item.children[0].rotation)<=90)item.position.y=oldBounds.y+item.bounds.height/2;else item.position.y=oldBounds.bottom-item.bounds.height/2;}this.updateSelectionState();item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();},modifyTextElementsJustification:function(items,justification){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementJustification(items[i],justification);}}else{this.modifyTextElementJustification(items,justification);}},// Vertical align Text
modifyTextElementVerticalAlign:function(item,verticalAlignment){if(!this.canChangeItemVerticalAlignment(item))return;this.beginDesignOperation();var info=null;var textInfo=this.getTextItemInfo(item);if(textInfo.verticalAlignment&&textInfo.verticalAlignment==verticalAlignment)return;if(item&&item instanceof this.paper.TextItem)item=this.fromTextToTextArea(item);if(item&&item.data&&item.data.isTextOnPath){info={verticalAlignment:verticalAlignment};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={verticalAlignment:verticalAlignment};var oldBounds=item.bounds.clone();this.modifyTextAreaInfo(item,info);if(!item.data.isTextBox){//Restore item position to fix small unwanted movements
item.position.x=oldBounds.x+oldBounds.width/2;if(Math.abs(item.children[0].rotation)<=90)item.position.y=oldBounds.y+item.bounds.height/2;else item.position.y=oldBounds.bottom-item.bounds.height/2;}this.updateSelectionState();item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();},modifyTextElementsVerticalAlign:function(items,verticalAlignment){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementVerticalAlign(items[i],verticalAlignment);}}else{this.modifyTextElementVerticalAlign(items,verticalAlignment);}},// AdaptText
modifyTextElementAdaptText:function(item,adaptText){if(!this.canChangeItemAdaptText(item))return;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.adaptText!=undefined&&itemInfo.adaptText===adaptText)return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){// Non applicabile al testo normale
}else if(item&&item.data&&item.data.isTextOnPath){// Non applicabile al textOnPath
}else if(item&&item.data&&item.data.isTextArea){info={adaptText:adaptText};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&!item.data.adaptText&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsAdaptText:function(items,adaptText){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementAdaptText(items[i],adaptText);}}else{this.modifyTextElementAdaptText(items,adaptText);}},// Letter-spacing
modifyTextElementLetterSpacing:function(item,letterSpacing){if(!this.canChangeItemLetterSpacing(item))return;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.letterSpacing!=undefined&&itemInfo.letterSpacing===letterSpacing)return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){// Non applicabile al testo normale
}else if(item&&item.data&&item.data.isTextOnPath){info={letterSpacing:letterSpacing};this.modifyTextOnPathInfo(item,info);item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}else if(item&&item.data&&item.data.isTextArea){info={letterSpacing:letterSpacing};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&!item.data.adaptText&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsLetterSpacing:function(items,letterSpacing){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementLetterSpacing(items[i],letterSpacing);}}else{this.modifyTextElementLetterSpacing(items,letterSpacing);}},// Line-spacing
modifyTextElementLineSpacing:function(item,lineSpacing){if(!this.canChangeItemLineSpacing(item))return;var itemInfo=this.getTextItemInfo(item);if(itemInfo&&itemInfo.lineSpacing!=undefined&&itemInfo.lineSpacing===lineSpacing)return;var info=null;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){// Non applicabile al testo normale
}else if(item&&item.data&&item.data.isTextOnPath){// Non applicabile al textOnPath
}else if(item&&item.data&&item.data.isTextArea){info={lineSpacing:lineSpacing};this.modifyTextAreaInfo(item,info);// Se il testo non entra più nella casella, adatto le dimensioni del font per far entrare almeno un carattere
if(item.data.isTextBox&&!item.data.adaptText&&item.children&&item.children.length==0){this.adaptTextBoxFontSize(item);}item.data.needsTransformsDataUpdate=true;this.onItemUpdated(item);}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},modifyTextElementsLineSpacing:function(items,lineSpacing){if(Object.prototype.toString.call(items)==='[object Array]'){for(var i=0;i<items.length;i++){this.modifyTextElementLineSpacing(items[i],lineSpacing);}}else{this.modifyTextElementLineSpacing(items,lineSpacing);}},// Methods related to text font settings. The actual font size of an element is given by two factors item.fontSize (in pixel) and item.scaling.
// The following methods allow to get and set the actual font size in px and pt. The methods also checks eventual min max constraints on font size.
// The scaling is assumed to always be uniform
// Modify the font scaling according to the eventual min/max constraints
adjustTextFontScaling:function(item,scale){var newScale=scale;if(item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var min=this.getItemMinFontSize(item);// by constraints
var max=this.getItemMaxFontSize(item);// by constraints
if(min!=undefined||min!=null||max!=undefined||max!=null){var info=this.getTextItemInfo(item);if(info){if(min!=undefined&&min!=null)newScale=Math.min(newScale,min/(info.fontSize*info.scaling.x*4/3));if(max!=undefined&&max!=null)newScale=Math.max(newScale,max/(info.fontSize*info.scaling.x*4/3));}}}return newScale;},// Modify the font size (the item.fontSize factor) according to the min/max constraints
adjustTextFontSize:function(item,fontSizePx){var newSize=fontSizePx;if(item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var min=this.getItemMinFontSize(item);// by constraints
var max=this.getItemMaxFontSize(item);// by constraints
if(min!=undefined||min!=null||max!=undefined||max!=null){var info=this.getTextItemInfo(item);if(info){if(min!=undefined&&min!=null)newSize=Math.max(newSize,min/(info.scaling.x*4/3));if(max!=undefined&&max!=null)newSize=Math.min(newSize,max/(info.scaling.x*4/3));}}}return newSize;},// Checks that the font scaling is within the allowed limits
canScaleSelectedTextFont:function(sx,sy){var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(!this.canScaleTextFont(item,sx,sy))return false;}return true;},// Returns the actual new font size that would be obtained after applying input scaling
getScaledTextFontSizePt:function(item,sx,sy){if(this.getItemIsTextElement(item)){var min=this.getItemMinFontSize(item);// by constraints
var max=this.getItemMaxFontSize(item);// by constraints
if(min!=undefined||min!=null||max!=undefined||max!=null){var info=this.getTextItemInfo(item);if(info){var scale=Math.max(sx,sy);var currentSize=info.fontSize*info.scaling.x;var newSize=currentSize*scale;var pt=newSize*4/3;return pt;}}}return 0;},// Checks that input scaling can be applied
canScaleTextFont:function(item,sx,sy){if(item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var min=this.getItemMinFontSize(item);// by constraints
var max=this.getItemMaxFontSize(item);// by constraints
if(min!=undefined||min!=null||max!=undefined||max!=null){var info=this.getTextItemInfo(item);if(info){var scale=Math.max(sx,sy);var currentSize=info.fontSize*info.scaling.x;var newSize=currentSize*scale;var pt=newSize*4/3;if(min!=undefined&&min!=null&&pt<min)return false;if(max!=undefined&&max!=null&&pt>max)return false;}}}return true;},// Checks that the font size (item.fontSize factor) of the selected text elements can be changed with the input one
canSetSelectedTextFontSizePx:function(fontSizePx){var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(!this.canSetTextFontSizePx(item,fontSizePx))return false;}return true;},// Checks that the font size (item.fontSize factor) of the text item can be changed with the input one
canSetTextFontSizePx:function(item,fontSizePx){if(item&&item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var min=this.getItemMinFontSize(item);// by constraints
var max=this.getItemMaxFontSize(item);// by constraints
if(min!=undefined||min!=null||max!=undefined||max!=null){var info=this.getTextItemInfo(item);if(info){var currentSize=info.fontSize*info.scaling.x;var newSize=fontSizePx;var pt=newSize*4/3;if(min!=undefined&&min!=null&&pt<min)return false;if(max!=undefined&&max!=null&&pt>max)return false;}}}return true;},// Checks that the font size (item.fontSize factor) of the selected text items can be changed with the input one (in pt)
canSetSelectedTextFontSizePt:function(fontSizePt){var px=fontSizePt*3/4;return this.canSetSelectedTextFontSizePx(px);},// Checks that the font size (item.fontSize factor) of the text items can be changed with the input one (in pt)
canSetTextFontSizePt:function(item,fontSizePt){var px=fontSizePt*3/4;return this.canSetTextFontSizePx(item,fontSizePt);},// Computes the actual font size in pt, given the two factors (fontSize in px and scaling)
computeTotalFontSizePt:function(fontSizePx,scaling){return fontSizePx*scaling*4/3;},// Get the text item actual font size in pixel
getTextItemTotalFontSizePx:function(item){if(item&&item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var info=this.getTextItemInfo(item);if(info){return info.fontSize*info.scaling.x;}}return 0;},// Get the text item actual font size in pt
getTextItemTotalFontSizePt:function(item){var px=this.getTextItemTotalFontSizePx(item);return px*4/3;},// Changes the selected text items actual font size with the input one (in points)
modifySelectedTextItemsTotalFontSizePt:function(fontSizePt){var px=fontSizePt*3/4;this.modifySelectedTextItemsTotalFontSizePx(px);},// Changes the text item actual font size with the input one (in points)
modifyTextItemTotalFontSizePt:function(item,fontSizePt){var px=fontSizePt*3/4;this.modifyTextItemTotalFontSizePx(item,px);},// Changes the selected text items actual font size with the input one (in px)
modifySelectedTextItemsTotalFontSizePx:function(fontSizePx){var items=this.getSelectedTextItems();if(items&&items.length>0){var item=items[0];this.modifyTextItemTotalFontSizePx(item,fontSizePx);}},// Changes the text item actual font size with the input one (in px)
modifyTextItemTotalFontSizePx:function(item,fontSizePx){if(!item||!this.canEditItem(item)||!this.canResizeItem(item)||!this.canChangeItemFontSize(item))return;if(!this.canSetTextFontSizePx(item,fontSizePx))return;if(item.data&&(item instanceof this.paper.TextItem||item.data.isTextOnPath||item.data.isTextArea)){var info=this.getTextItemInfo(item);if(info){var currentSize=info.fontSize*info.scaling.x;if(currentSize>0){var scale=fontSizePx/currentSize;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();this.scaleItem(item,scale,scale,null);this.onItemUpdated(item);this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);}}}},// -----------------------------------------------------------------
// TEXT ON PATH
// -----------------------------------------------------------------
addTextOnPathElement:function(point,info,forceAdding){if(forceAdding===void 0){forceAdding=false;}if(!forceAdding&&!this.canAddText())return;var item=null;if(this.side){var area=this.side.get("areas").getMaxArea();if(area){var designEffect=this.getDesignEffectForArea(area);this.beginDesignOperation();var centerOnArea=false;if(!point){point=this.paper.view.center;centerOnArea=true;}if(info&&info.text){this.deselectAll();this.updateSelectionState();if(!this.allowShadows())info.shadowColor=null;var originalStrokeColor=info.strokeColor||'#000000';var originalFillColor=info.fillColor||'#000000';var originalShadowColor=info.shadowColor||null;originalStrokeColor=this.forceColorInFixedPalette(null,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(null,originalFillColor);originalShadowColor=this.forceColorInFixedPalette(null,originalShadowColor);info.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);info.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);info.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);info.shadowBlur=this.adjustInputShadowBlur(null,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(null,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(null,info.shadowAngle);var text=new this.paper.PointText({point:point,content:info.text,strokeColor:info.strokeColor,strokeWidth:info.strokeWidth!=undefined?info.strokeWidth:0,fillColor:info.fillColor,fontFamily:this.sanitizeFontFamilyName(info.fontFamily||'Verdana'),fontWeight:info.fontWeight||'normal',fontSize:info.fontSize||12,justification:info.justification||'center',shadowColor:info.shadowColor||null,shadowBlur:info.shadowBlur,shadowOffset:this.getOffsetByDistanceAngle(info.shadowDistance,info.shadowAngle)});var textRect=text.bounds;text.remove();var areaBounds=textRect.clone();// centro l'elemento all'interno dell'area
var areaItem=this.findItemForArea(area);if(areaItem){areaBounds=areaItem.bounds.expand(-50);}if(!centerOnArea)areaBounds.center=point;var w=Math.min(areaBounds.width,areaBounds.height);var rect=new this.paper.Rectangle(areaBounds.x+(areaBounds.width-w)/2,areaBounds.y+(areaBounds.height-w)/2,w,w);// determino i punti che caratterizzano l'arco
var a=new this.paper.Point(rect.left,rect.top+w/2);var b=new this.paper.Point(rect.center.x,rect.topLeft.y);var c=new this.paper.Point(rect.right,rect.top+w/2);var path=new this.paper.Path.Arc(a,b,c);path.remove();if(info.rotation){path.rotation=info.rotation;a=path.getPointAt(0.0*path.length);b=path.getPointAt(0.5*path.length);c=path.getPointAt(1.0*path.length);}item=new this.paper.Group();item.addChildren(this.createAlignedText(path,info));item.data.isTextOnPath=true;item.data.points=[a,b,c];item.data.text=info.text;item.data.inside=info.inside||false;item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.originalShadowColor=originalShadowColor;item.data.letterSpacing=this.adjustInputLetterSpacingByConstraints(item,info.letterSpacing);this.masterGroup.addChild(item);this.adaptPathToText(item);var delta=areaBounds.center.subtract(item.position);item.position=areaBounds.center;item.data.needsTransformsDataUpdate=true;this.applyDesignEffectToItem(designEffect,item);this.updateTransformsData(item);this.onTextOnPathMoved(item,delta);this.onItemCreated(item);this.setItemSelection(item,true);}this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();}}return item;},getAllImageItems:function(){var imageItems=[];var items=this.getAllItems();for(var i=0;i<items.length;i++){var item=items[i];var raster=this.getMaskedImageRasterItem(item);if(item&&raster&&item.data&&item.data.guid&&!item.data.isArea){imageItems.push(item);}}return imageItems;},getAllDesignImageItems:function(){return this.design.get("designItems").models.filter(function(item){return item.get("imageFormat")!=="";});},getAllTextOnPathItems:function(){var items=[];var customizer=this;function addChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide&&child.data&&child.data.isTextOnPath)items.push(child);addChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)addChildren(layer);}return items;},setGrids:function(grids){this.grids=grids;},updateGrids:function(){return __awaiter(this,void 0,void 0,function(){var map,grid;var _this_1=this;return __generator(this,function(_a){switch(_a.label){case 0:map=this.design.get("areasGrids")&&this.design.get("areasGrids").models.find(function(x){return x.get("modelID")==_this_1.getCurrentModel().id&&x.get("sideID")==_this_1.side.id;});if(!map)return[3/*break*/,2];grid=this.grids.find(function(x){return x.id==map.get("gridID");});if(!grid)return[3/*break*/,2];return[4/*yield*/,this.createGridItem(grid)];case 1:_a.sent();_a.label=2;case 2:return[2/*return*/];}});});},addImageToGridBox:function(image,box,boxID){this.beginDesignOperation();// Image potrebbe essere una raster oppure una masked raster (maskedImage)
// Remove grid icon (if exists)
var gridIcon=box.children.find(function(x){return x.data&&x.data.isGridIcon;});if(gridIcon)gridIcon.remove();var itemBounds=this.getItemBounds(image);var boxBounds=box.bounds;var targetBounds=boxBounds.clone();targetBounds.width*=1.1;targetBounds.height*=1.1;var sx=1.0;var sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;var signx=sx>0?1:-1;var signy=sy>0?1:-1;sx=sy=Math.max(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;if(!image.data.isGridImage){image.position=box.position;image.scale(sx,sy);image.data.initialScaleX=sx;image.data.initialScaleY=sy;image.data.originalBounds=new this.paper.Rectangle(0,0,this.getImageWidth(image),this.getImageHeight(image));image.data.originalMatrix=image.matrix.clone();}image.visible=true;image.data.isGridImage=true;if(box>=0)image.data.gridBoxID=boxID;else image.data.gridBoxID=box.parent.children.indexOf(box);if(!this.isViewer){this.updateSelectionState();this.onItemUpdated(image);this.onDesignItemChanged(image);}for(var _i=0,_a=box.children;_i<_a.length;_i++){var child=_a[_i];if(child.data&&child.data.isGridBorderPath)child.fillColor=new paper.Color(1,1,1,0);}box.addChild(image);image.sendToBack();this.endDesignOperation();},insertImageInGrid:function(image,colorMappings){return __awaiter(this,void 0,void 0,function(){var item,grid,area,box,url,originalUrl,designEffect;var _this_1=this;return __generator(this,function(_a){switch(_a.label){case 0:item=null;if(!image||!(image instanceof MPlaza.Image))return[2/*return*/,item];if(!this.canAddImage())return[2/*return*/,item];grid=this.getAllGridItems()[0];if(!grid)return[2/*return*/,item];if(!this.side||this.side.get("areas".length==0))return[2/*return*/,item];area=this.side.get("areas").at(0);this.beginDesignOperation();box=grid.children.find(function(x){return x.data&&x.data.isBoxSelected;})||grid.children.find(function(x){return x.children&&x.children.find(function(y){return y.data&&y.data.isGridIcon;});})||grid.children[0];url="";if(!this.isImageScalingEnabled&&image.get("format").toLowerCase()!="svg"&&image.get("type").toLowerCase()!="vector"&&["png","jpg","jpeg"].find(function(x){return x==image.get("format").toLowerCase();}))url=image.get("url");if(!url)url=image.get("previewUrl");if(!url)return[2/*return*/,item];originalUrl=url;designEffect=this.getDesignEffectForArea(area);return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,null)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:return[4/*yield*/,this.createRasterItem(url,false)];case 6:// ----------------------------------------
item=_a.sent();item.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);item.data.originalImageID=image.id;item.data.areaGuid=box.data.areaGuid;// Remove old image from group
box.children.forEach(function(x){if(x.data.isGridImage){x.remove();_this_1.onItemRemoved(x);}});this.onItemCreated(item,image);this.addImageToGridBox(item,box,grid.children.indexOf(box));this.onGridImageSelected(item);this.updateItemsIndexes();this.onItemUpdated(item);this.onDesignItemChanged(item);this.fireImageLoadedEvent();this.endDesignOperation();return[2/*return*/,item];}});});},onGridImageSelected:function(image){this.deselectGridBoxes();var raster=this.getMaskedImageRasterItem(image);if(image&&raster&&image.data&&(image.data.isGridImage||image.data.isGridIcon)){this.selectGridBox(image.parent);this.fireGridImageSelectedEvent(image);}},createGridBoxIcon:function(){return __awaiter(this,void 0,void 0,function(){var _this_1=this;return __generator(this,function(_a){return[2/*return*/,new Promise(function(resolve){var item=new _this_1.paper.Raster({crossOrigin:"anonymous",source:Zakeke.config.baseUrl+"/images/other/camera_image_grids.png",onMouseEnter:function(){return _this_1.paper.project.view.element.style.setProperty('cursor','pointer');},onMouseLeave:function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);}});item.onLoad=function(){item.onLoad=undefined;resolve(item);};})];});});},deselectGridBoxes:function(){this.getAllGridItems().forEach(function(grid){grid.children.forEach(function(box){if(box.data&&box.data.isGridPathGroup){var path=box.children.find(function(x){return x.data&&x.data.isGridBorderPath;});if(path){path.strokeWidth=0;box.data.isBoxSelected=false;}}});});},selectGridBox:function(box){if(box&&box.data&&box.data.isGridPathGroup){var path=box.children.find(function(x){return x.data&&x.data.isGridBorderPath;});if(path){this.createPathDashes(path);box.data.isBoxSelected=true;if(box.children.find(function(x){return x.data&&x.data.isGridImage;}))path.bringToFront();}}},getAllGridItems:function(){var items=[];var customizer=this;function addChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide&&child.data&&child.data.isGridGroup)items.push(child);addChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)addChildren(layer);}return items;},removeAllGridItems:function(){var created=false;if(!this.currentDesignOperation){created=true;this.beginDesignOperation();}for(var _i=0,_a=this.getAllGridItems();_i<_a.length;_i++){var grid=_a[_i];grid.remove();// Add all eventual images to the mastergroup
for(var _b=0,_c=grid.children;_b<_c.length;_b++){var box=_c[_b];for(var _d=0,_e=box.children;_d<_e.length;_d++){var child=_e[_d];if(child.data&&child.data.isGridImage){child.data.isGridImage=false;this.masterGroup.addChild(child);this.onItemUpdated(child);}}}}this.paper.project.view.update();if(created)this.endDesignOperation();},createGridItem:function(grid){return __awaiter(this,void 0,void 0,function(){var that,areaItem,item,cameraIcon,cameraIcons,smallestCameraIconDim,_i,_a,box,borderPath,icon_1,newIconDim,_b,cameraIcons_1,icon,images,_loop_3,this_2,i;var _this_1=this;return __generator(this,function(_c){switch(_c.label){case 0:that=this;this.beginDesignOperation();this.removeAllGridItems();areaItem=this.findItemForArea(this.side.get("areas").at(0));if(!grid||!grid.get("json")||!areaItem)return[2/*return*/];item=this.paper.project.activeLayer.importJSON(grid.get("json"));item.visible=false;return[4/*yield*/,this.createGridBoxIcon()];case 1:cameraIcon=_c.sent();// Adapt to area
item.scale(areaItem.bounds.width/item.bounds.width,areaItem.bounds.height/item.bounds.height);item.position.x=areaItem.position.x;item.position.y=areaItem.position.y;this.masterGroup.addChild(item);cameraIcons=[];smallestCameraIconDim=-1;// Add placeholder icons
for(_i=0,_a=item.children;_i<_a.length;_i++){box=_a[_i];if(box.children.length>1){borderPath=box.children.find(function(x){return x.data&&x.data.isGridBorderPath;});if(borderPath){borderPath.strokeWidth=0;borderPath.strokeColor="#000000";if(!that.isViewer){borderPath.fillColor=new paper.Color(1,1,1,0.9);icon_1=cameraIcon.clone();icon_1.data.isGridIcon=true;icon_1.onMouseEnter=function(){return _this_1.paper.project.view.element.style.setProperty('cursor','pointer');};icon_1.onMouseLeave=function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);};icon_1.position.x=box.position.x;icon_1.position.y=box.position.y;newIconDim=0;newIconDim=this.isMobile?Math.min(Math.min(box.bounds.width,box.bounds.height),180):Math.min(Math.min(box.bounds.width,box.bounds.height)*0.8,66);if(smallestCameraIconDim==-1||newIconDim<smallestCameraIconDim)smallestCameraIconDim=this.isMobile?Math.max(newIconDim,60):Math.max(newIconDim,30);cameraIcons.push(icon_1);box.addChild(icon_1);}}}}for(_b=0,cameraIcons_1=cameraIcons;_b<cameraIcons_1.length;_b++){icon=cameraIcons_1[_b];icon.scale(smallestCameraIconDim/icon.bounds.width,smallestCameraIconDim/icon.bounds.height);}cameraIcon.remove();images=this.getAllImageItems();_loop_3=function(){var image=images[i];var box_2=null;var boxID=-1;if(image.data&&image.data.gridBoxID!=null){box_2=item.children[image.data.gridBoxID];if(box_2)boxID=image.data.gridBoxID;}if(!box_2){if(i>=item.children.length||image.data.gridBoxID>=item.children.length){image.remove();this_2.onItemRemoved(image);return"continue";}box_2=item.children[i];boxID=i;}var constraints=null;var designItem=this_2.findDesignItemForItem(image);if(designItem)constraints=designItem.get("constraints");if(!constraints||(constraints.get("canEdit")||constraints.get("canMove")||constraints.get("canRotate")||constraints.get("canResize")||constraints.get("canDelete"))&&image.data&&!image.data.isGridIcon){if(!image.loaded){var onLoadCb_1=image.onLoad||function(){};image.onLoad=function(){onLoadCb_1();_this_1.addImageToGridBox(image,box_2,boxID);};}else{this_2.addImageToGridBox(image,box_2,boxID);}}else if(image.data&&image.data.gridBoxID!=null){image.data.isGridImage=false;image.data.gridBoxID=null;if(!this_2.isViewer){this_2.onItemUpdated(image);this_2.onDesignItemChanged(image);}}};this_2=this;for(i=0;i<images.length;i++){_loop_3();}item.visible=true;this.updateItemsIndexes();this.paper.project.view.update();this.endDesignOperation();this.resetUndoRedo();return[2/*return*/];}});});},updateTextOnPathGuides:function(items){if(!items)items=this.getAllTextOnPathItems();for(var i=0;i<items.length;i++){var item=items[i];this.updateTextOnPathGuide(item);}},updateTextOnPathGuide:function(item){if(item.data.selected){this.drawTextOnPathGuide(item);this.drawTextOnPathHandles(item);}else{this.removeTextOnPathGuide(item);this.removeTextOnPathHandles(item);}},createPathDashes:function(path,colors){if(colors===void 0){colors=[];}if(path){if(!colors||colors.length==0){//colors = ["black", "transparent", "white", "transparent"];
colors=["black","white"];}var stops=[];var lastColorIdx=colors.length-1;var stopLength=0.03;for(var i=0;i<1;i=Math.round((i+stopLength)*100)/100){var stopEnd=Math.min(Math.round((i+stopLength)*100)/100,1);lastColorIdx=(lastColorIdx+1)%colors.length;var newColor=colors[lastColorIdx];stops=__spreadArrays(stops,[[newColor,i],[newColor,stopEnd]]);}var maxSize=Math.max(path.bounds.width,path.bounds.height);path.strokeColor={gradient:{stops:stops},origin:path.bounds.topLeft,destination:new paper.Point(path.bounds.topLeft.x+maxSize,path.bounds.topLeft.y+maxSize)};path.strokeWidth=1.5/this.paper.view.zoom;path.dashArray=[];}},drawTextOnPathGuide:function(item){this.removeTextOnPathGuide(item);// Disegno prima la curva guida
if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var path=new this.paper.Path.Arc(item.data.points[0],item.data.points[1],item.data.points[2]);//path.strokeColor = this.getContrastedColor(path.bounds);
path.data.isTextOnPathGuide=true;path.strokeWidth=2.0/this.paper.view.zoom;path.dashOffset=0.5/this.paper.view.zoom;path.dashArray=[1.0/this.paper.view.zoom,1.0/this.paper.view.zoom];path.guide=true;path.data.itemGuid=item.data.guid;if(!this.isViewer)this.createPathDashes(path);}},findTextOnPathGuide:function(item){if(item&&item.data&&item.data.isTextOnPath&&item.data.guid){var upperGuid=item.data.guid.toUpperCase();var findChildByGuid=function(parent,guid){if(parent.data&&parent.data.isTextOnPathGuide&&parent.data.itemGuid&&parent.data.itemGuid.toUpperCase()==guid){return parent;}if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];var element=findChildByGuid(child,upperGuid);if(element){return element;}}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;var element=findChildByGuid(layer,upperGuid);if(element){return element;}}}return null;},removeTextOnPathGuide:function(item){var path=this.findTextOnPathGuide(item);if(path)path.remove();},drawTextOnPathHandles:function(item){this.removeTextOnPathHandles(item);if(!this.canEditItem(item))return;if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var rect=new this.paper.Rectangle(a,new this.paper.Point(c.x,b.y));var strokeColor=this.getContrastedColor(rect);var handleCircleDimension=this.selectionLateralResizeDimension/this.paper.view.zoom;var endHandle1=new this.paper.Path.Circle(a,handleCircleDimension);endHandle1.data.isTextOnPathHandle=true;endHandle1.data.isTextOnPathFirstEndHandle=true;endHandle1.strokeColor=new this.paper.Color(1,1,1,0.5);endHandle1.strokeWidth=1;endHandle1.fillColor=new this.paper.Color(0,0,0,0.5);endHandle1.data.itemGuid=item.data.guid;var middleHandle=new this.paper.Path.Circle(b,handleCircleDimension);middleHandle.data.isTextOnPathHandle=true;middleHandle.data.isTextOnPathMiddleEndHandle=true;middleHandle.strokeColor=new this.paper.Color(1,1,1,0.5);middleHandle.strokeWidth=1;middleHandle.fillColor=new this.paper.Color(0,0,0,0.5);middleHandle.data.itemGuid=item.data.guid;var endHandle2=new this.paper.Path.Circle(c,handleCircleDimension);endHandle2.data.isTextOnPathHandle=true;endHandle2.data.isTextOnPathLastEndHandle=true;endHandle2.strokeColor=new this.paper.Color(1,1,1,0.5);endHandle2.strokeWidth=1;endHandle2.fillColor=new this.paper.Color(0,0,0,0.5);endHandle2.data.itemGuid=item.data.guid;if(this.isViewer){endHandle1.visible=false;middleHandle.visible=false;endHandle2.visible=false;}}},findTextOnPathHandles:function(item){var handles=[];if(item&&item.data&&item.data.isTextOnPath&&item.data.guid){var upperGuid=item.data.guid.toUpperCase();var findChildByGuid=function(parent,guid){if(parent.data&&parent.data.isTextOnPathHandle&&parent.data.itemGuid&&parent.data.itemGuid.toUpperCase()==guid){handles.push(parent);}if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];findChildByGuid(child,upperGuid);}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;findChildByGuid(layer,upperGuid);}}return handles;},removeTextOnPathHandles:function(item){var handles=this.findTextOnPathHandles(item);for(var i=0;i<handles.length;i++){var handle=handles[i];handle.remove();}},onTextOnPathMoved:function(item,delta){if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var path=new this.paper.Path.Arc(a,b,c);path.remove();path.position.x+=delta.x;path.position.y+=delta.y;item.data.points[0]=path.getPointAt(0.0*path.length);item.data.points[1]=path.getPointAt(0.5*path.length);item.data.points[2]=path.getPointAt(1.0*path.length);}},onTextOnPathRotated:function(item,deg,pivot){if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var path=new this.paper.Path.Arc(a,b,c);path.remove();path.rotate(deg,pivot);item.data.points[0]=path.getPointAt(0.0*path.length);item.data.points[1]=path.getPointAt(0.5*path.length);item.data.points[2]=path.getPointAt(1.0*path.length);}},onTextOnPathScaled:function(item,sx,sy,pivot){if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var path=new this.paper.Path.Arc(a,b,c);path.remove();path.scale(sx,sy,pivot);item.data.points[0]=path.getPointAt(0.0*path.length);item.data.points[1]=path.getPointAt(0.5*path.length);item.data.points[2]=path.getPointAt(1.0*path.length);}},moveTextOnPathFirstEnd:function(info){if(this.frozen)return;if(!info.delta)return;var delta=info.delta;this.hideCenterLines();this.removeSelectionAlertItems();var selected=this.getSelectedTextOnPathItems();if(selected&&selected.length>0){var item=selected[0];if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){item.data.points[0].x+=delta.x;item.data.points[0].y+=delta.y;item.data.needsTransformsDataUpdate=true;this.drawTextOnPathGuide(item);this.drawTextOnPathHandles(item);this.updateTextOnPath(item);}}},moveTextOnPathMiddleEnd:function(info){if(this.frozen)return;if(!info.delta)return;var delta=info.delta;this.hideCenterLines();this.removeSelectionAlertItems();var selected=this.getSelectedTextOnPathItems();if(selected&&selected.length>0){var item=selected[0];if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){item.data.points[1].x+=delta.x;item.data.points[1].y+=delta.y;item.data.needsTransformsDataUpdate=true;this.drawTextOnPathGuide(item);this.drawTextOnPathHandles(item);this.updateTextOnPath(item);}}},moveTextOnPathLastEnd:function(info){if(this.frozen)return;if(!info.delta)return;var delta=info.delta;this.hideCenterLines();this.removeSelectionAlertItems();var selected=this.getSelectedTextOnPathItems();if(selected&&selected.length>0){var item=selected[0];if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){item.data.points[2].x+=delta.x;item.data.points[2].y+=delta.y;item.data.needsTransformsDataUpdate=true;this.drawTextOnPathGuide(item);this.drawTextOnPathHandles(item);this.updateTextOnPath(item);}}},modifyTextOnPathInfo:function(item,newInfo){if(newInfo){newInfo.text=this.adjustInputTextByConstraints(item,newInfo.text!=null?newInfo.text:item.data.text);newInfo.letterSpacing=this.adjustInputLetterSpacingByConstraints(item,newInfo.letterSpacing?parseInt(newInfo.letterSpacing):undefined);}this.removeAllAlertItems();this.updateTextOnPath(item,newInfo);this.adaptPathToText(item);this.updateTextOnPath(item,null);this.checkAllAlertItems();this.checkImagesSizeLimit();},updateTextOnPath:function(item,info){this.beginDesignOperation();if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){if(item.children.length>0){var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){str+=item.children[i].content;}}// Edited by Mauro:
// I Have changed the info.fontWeight || item.children[0].fontWeight; (and others lines) to this
// because an empty string used with info.fontWeight || is interpreted as false.
// So when we add for e.g the font weight BOLD, it works BUT when we remove it, the string is empty so 
// it became false in the expression and then the item.children is used... "bold"... then he reapply the bold
// and we can't remove the bold effect anymore. With this it works!
var constraints=this.getItemConstraints(item);var designEffect=null;var designItem=this.findDesignItemForItem(item);if(designItem)designEffect=this.getDesignEffectForDesignItem(designItem);var originalStrokeColor=null;var originalFillColor=null;var originalShadowColor=null;info=info||{};info.text=info.text||str;if(!this.allowShadows())info.shadowColor=null;if(!constraints||constraints.get("canChangeFontColor")){if(info.strokeColor!=undefined){originalStrokeColor=info.strokeColor;}if(info.fillColor!=undefined){originalFillColor=info.fillColor;}originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(item,originalFillColor);info.strokeColor=info.strokeColor!=undefined?this.applyDesignEffectToTextColor(designEffect,originalStrokeColor):item.children[0].strokeColor;info.fillColor=info.fillColor!=undefined?this.applyDesignEffectToTextColor(designEffect,originalFillColor):item.children[0].fillColor;}else{info.strokeColor=item.children[0].strokeColor;info.fillColor=item.children[0].fillColor;}if(!constraints||constraints.get("canChangeShadowColor")){if(info.shadowColor!==undefined){originalShadowColor=info.shadowColor;}originalShadowColor=this.forceColorInFixedPalette(item,originalShadowColor);info.shadowColor=this.allowShadows()?info.shadowColor!==undefined?this.applyDesignEffectToTextColor(designEffect,originalShadowColor):item.children[0].shadowColor:null;}else{info.shadowColor=this.allowShadows()?item.children[0].shadowColor:null;}info.strokeWidth=info.strokeWidth!=undefined?info.strokeWidth:item.children[0].strokeWidth;info.shadowBlur=info.shadowBlur!=undefined?info.shadowBlur:item.children[0].shadowBlur;info.shadowDistance=info.shadowDistance!=undefined?info.shadowDistance:this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=info.shadowAngle!=undefined?info.shadowAngle:this.getOffsetAngle(item.children[0].shadowOffset);info.shadowBlur=this.adjustInputShadowBlur(item,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(item,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(item,info.shadowAngle);if(!constraints||constraints.get("canChangeFontFamily"))info.fontFamily=info.fontFamily!=undefined?info.fontFamily:item.children[0].fontFamily;else info.fontFamily=item.children[0].fontFamily;info.fontFamily=this.sanitizeFontFamilyName(info.fontFamily);var inputFontWeight=info.fontWeight!=undefined?info.fontWeight:item.children[0].fontWeight;info.fontWeight=this.adjustInputFontWeightByConstraints(item.children[0].fontWeight,inputFontWeight,constraints);info.fontStretch=info.fontStretch!=undefined?info.fontStretch:item.children[0].fontStretch;/*
                if (!constraints || constraints.get("canChangeFontWeight"))
                    info.fontWeight = info.fontWeight != undefined ? info.fontWeight : item.children[0].fontWeight;
                else
                    info.fontWeight = item.children[0].fontWeight;
                */if(!constraints||constraints.get("canChangeFontSize"))info.fontSize=info.fontSize!=undefined?info.fontSize:item.children[0].fontSize;else info.fontSize=item.children[0].fontSize;info.scaling=info.scaling!=undefined?info.scaling:item.children[0].scaling;item.data.text=info.text;if(originalStrokeColor)item.data.originalStrokeColor=originalStrokeColor;if(originalFillColor)item.data.originalFillColor=originalFillColor;if(originalShadowColor)item.data.originalShadowColor=originalShadowColor;info.letterSpacing=info.letterSpacing!=undefined?info.letterSpecing:item.data.letterSpacing!=undefined?item.data.letterSpacing:0;item.data.letterSpacing=info.letterSpacing;item.removeChildren();var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var path=new this.paper.Path.Arc(a,b,c);path.remove();// Move the B point in the middle of the arc to avoid some strnage flipping when they are near
var offset=path.getPointAt(0.5*path.length);item.data.points[1]=offset;item.addChildren(this.createAlignedText(path,info,null));this.applyDesignEffectToItem(designEffect,item);this.updateSelectionState();this.paper.project.view.update();}}this.endDesignOperation();},adaptPathToText:function(item){var t0=performance.now();if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3){var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){str+=item.children[i].content;}}var a=item.data.points[0];var c=item.data.points[1];var b=item.data.points[2];var path=new this.paper.Path.Arc(a,c,b);path.remove();var info={};info.text=str;info.strokeColor=item.children[0].strokeColor;info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor;info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.letterSpacing=item.data.letterSpacing!=undefined?item.data.letterSpacing:0;info.shadowColor=item.children[0].shadowColor;info.shadowBlur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);var textLength=0;if(!this.isLetterSpacingSpecified(info)){var totalPointText=this.createPointText(str,info);totalPointText.remove();textLength=totalPointText.bounds.width;}else{var extraSpace=this.getTextExtraSpace(info);var gliph=null;for(var i=0;i<str.length;i++){if(i>0)textLength+=extraSpace;gliph=this.createPointText(str.substring(i,i+1),info);textLength+=gliph.bounds.width;gliph.remove();}}if(Math.abs(textLength-path.length)<0.001){var t1=performance.now();return;}// devo allungare o restringere l'arco in modo che contenga tutto il testo
var center=this.getCircleCenter(a,b,c);var radius=a.getDistance(center);var circ=2*Math.PI*radius;var angle=path.length/circ*360;// angolo al centro
var deltaLength=textLength-path.length;var deltaAngle=deltaLength/circ*360;var a1=this.getCircleAngleAtPoint(center.x,center.y,radius,a.x,a.y);var a2=this.getCircleAngleAtPoint(center.x,center.y,radius,b.x,b.y);var a3=this.getCircleAngleAtPoint(center.x,center.y,radius,c.x,c.y);a1=this.getNormalizedAngle(a1);a2=this.getNormalizedAngle(a2);a3=this.getNormalizedAngle(a3);var alfa1=0;var alfa2=0;if(a1>a2){alfa2=a1-a2;alfa1=360-alfa2;}else{alfa1=a2-a1;alfa2=360-alfa1;}if(a3<a1){if(deltaAngle+alfa2>359)deltaAngle=359-alfa2;a1+=deltaAngle/2;a2-=deltaAngle/2;}else{if(deltaAngle+alfa1>359)deltaAngle=359-alfa1;a1-=deltaAngle/2;a2+=deltaAngle/2;}a1=this.getNormalizedAngle(a1);a2=this.getNormalizedAngle(a2);var p1=this.getCirclePointAtAngle(center.x,center.y,radius,a1);var p2=this.getCirclePointAtAngle(center.x,center.y,radius,a2);item.data.points[0]=p1;item.data.points[2]=p2;this.updateSelectionState();this.paper.project.view.update();}var t1=performance.now();},createAlignedText:function(path,info,startOffset){var t0=performance.now();var showed=[];var glyphTexts=[];var inside=info.inside||false;if(info&&info.text&&info.text.length>0&&path){var str=info.text;var spaceWidth=this.getSpaceWidth(info);var extraSpace=this.getTextExtraSpace(info);// create PointText object for each glyph
var totalPointText=this.createPointText(str,info);totalPointText.remove();var textLength=totalPointText.bounds.width;var gliphsLength=0;for(var i=0;i<str.length;i++){if(i>0)gliphsLength+=extraSpace;glyphTexts[i]=this.createPointText(str.substring(i,i+1),info);glyphTexts[i].justification="center";gliphsLength+=glyphTexts[i].bounds.width;}//Added half of the first char width to fix issue with alignment
var totalLength=!this.isLetterSpacingSpecified(info)?textLength:gliphsLength;if(!startOffset){if(totalLength<path.length){startOffset=(path.length-totalLength)/2+glyphTexts[0].bounds.width/2;}else{startOffset=0;}}// for each glyph find center xOffset
var xOffsets=[startOffset];for(var i=1;i<str.length;i++){var pairText=this.createPointText(str.substring(i-1,i+1),info);pairText.remove();if(inside){xOffsets[i]=xOffsets[i-1]-(pairText.bounds.width-glyphTexts[i-1].bounds.width/2-glyphTexts[i].bounds.width/2+extraSpace);}else{xOffsets[i]=xOffsets[i-1]+(pairText.bounds.width-glyphTexts[i-1].bounds.width/2-glyphTexts[i].bounds.width/2+extraSpace);}}// set point for each glyph and rotate glyph aorund the point
for(var i=0;i<str.length;i++){var centerOffs=xOffsets[i];if(centerOffs<0&&path.closed)centerOffs=path.length+centerOffs;if(path.length<centerOffs){if(path.closed){centerOffs=centerOffs%path.length;}else{centerOffs=undefined;}}if(centerOffs===undefined){glyphTexts[i].remove();}else{showed.push(glyphTexts[i]);var pathPoint=path.getPointAt(centerOffs);glyphTexts[i].point=pathPoint;var tan=path.getTangentAt(centerOffs);if(tan){var angle=tan.angle;if(inside)angle-=180;glyphTexts[i].rotate(angle,pathPoint);}}}}var t1=performance.now();return showed;},// create a PointText object for a string and a style
createPointText:function(str,info){var text=new this.paper.PointText();text.content=str;if(info){text.strokeColor=info.strokeColor||'black';text.strokeWidth=info.strokeWidth!=undefined?info.strokeWidth:0;text.fillColor=info.fillColor||'black';text.fontFamily=info.fontFamily||'Verdana';text.fontWeight=info.fontWeight||'normal';text.fontSize=info.fontSize||12;if(info.scaling)text.scaling=info.scaling;text.shadowColor=info.shadowColor;text.shadowBlur=info.shadowBlur;text.shadowOffset=this.getOffsetByDistanceAngle(info.shadowDistance,info.shadowAngle);}return text;},getCircleCenter:function(b,c,d){var temp=Math.pow(c.x,2)+Math.pow(c.y,2);var bc=(Math.pow(b.x,2)+Math.pow(b.y,2)-temp)/2;var cd=(temp-Math.pow(d.x,2)-Math.pow(d.y,2))/2;var det=(b.x-c.x)*(c.y-d.y)-(c.x-d.x)*(b.y-c.y);if(Math.abs(det)<1e-14)return false;var center=new this.paper.Point((bc*(c.y-d.y)-cd*(b.y-c.y))/det,((b.x-c.x)*cd-(c.x-d.x)*bc)/det);return center;},getCirclePointAtAngle:function(x0,y0,r,t){var rad=t*Math.PI/180;var x1=r*Math.cos(rad)+x0;var y1=r*Math.sin(rad)+y0;return new paper.Point(x1,y1);},// La funzione restituisce l'angolo t corrispondente al punto P(x1,y1) del cerchio
// con centro (x0,y0) e raggio r
getCircleAngleAtPoint:function(x0,y0,r,x1,y1){if(r==0)return 0;return(Math.atan2(y1-y0,x1-x0)*180/Math.PI+360.0)%360.0;},getNormalizedAngle:function(a){if(a<0)a=360+a;if(a>360)a-=360;return a;},// ---------------------------------------------------
// -----------------------------------------------------------------
// TEXT AREA
// -----------------------------------------------------------------
// Una text area è un elemento di testo caratterizzato da un rettangolo che lo racchiude.
// Nella versione più semplice, il rettangolo è semplicemente il bounding box del testo specificato che si adatta automaticamente
// ad ogni modifica del testo. Quindi in sostanza nella versione più semplice la text area consente di gestire il multilinea.
// Una text area viene identificata con il metadata isTextArea = true.
// Nella versione più avanzata, chiamata text box, il testo si adatta ai margini dati dal rettangolo che caratterizza la text area.
// Tale rettangolo può essere ridimensionato dall'utente finale comportando un riadattamento automatico del testo. Ogni paragrafo del testo
// verrà spezzato in tante linee quante ne occorrono per racchiudere il testo all'interno del rettangolo. Se un'unica parola è troppo lunga
// allora questa verrà spezzata in sottoparole in modo da non superare i limiti dell'area. Il testo viene anche limitato verticalmente
// andando a rappresentare solo le linee che rientrano nel rettangolo.
addTextAreaElement:function(rect,info,forceAdding){if(forceAdding===void 0){forceAdding=true;}if(!forceAdding&&!this.canAddText())return;var item=null;if(this.side){var area=this.side.get("areas").getMaxArea();if(area){this.beginDesignOperation();if(!rect&&this.side){var area=this.side.get("areas").getMaxArea();var areaItem=this.findItemForArea(area);if(areaItem){rect=areaItem.bounds.expand(-50);}}if(!rect)return;if(info&&info.text){var designEffect=this.getDesignEffectForArea(area);if(!this.allowShadows())info.shadowColor=null;var originalStrokeColor=info.strokeColor||'#000000';var originalFillColor=info.fillColor||'#000000';var originalShadowColor=info.shadowColor||null;originalStrokeColor=this.forceColorInFixedPalette(null,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(null,originalFillColor);originalShadowColor=this.forceColorInFixedPalette(null,originalShadowColor);info.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);info.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);info.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);info.shadowBlur=this.adjustInputShadowBlur(null,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(null,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(null,info.shadowAngle);info.letterSpacing=info.letterSpacing!=undefined?info.letterSpacing:0;info.lineSpacing=info.lineSpacing!=undefined?info.lineSpacing:0;this.deselectAll();this.updateSelectionState();item=new this.paper.Group();item.addChildren(this.createWrappedText(rect,info,false).textItems);this.applyDesignEffectToItem(designEffect,item);rect=item.bounds;item.data.rect=rect;item.data.isTextArea=true;item.data.text=info.text;item.data.justification=info.justification!=undefined?info.justification:"justify";item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.originalShadowColor=originalShadowColor;item.data.letterSpacing=info.letterSpacing;item.data.lineSpacing=info.lineSpacing;item.rotation=info.rotation;this.masterGroup.addChild(item);var delta=rect.center.subtract(item.position);item.position=rect.center;item.data.needsTransformsDataUpdate=true;this.updateTransformsData(item);this.onTextAreaMoved(item,delta);this.forceTextAreaToBounds(item);this.onItemCreated(item);this.setItemSelection(item,true);}this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();}}return item;},isItemTextArea:function(item){return item&&item.data&&item.data.isTextArea;},isItemTextBox:function(item){return this.isItemTextArea(item)&&item.data.isTextBox;},isSimpleTextArea:function(item){return item&&item.data&&item.data.isTextArea&&!item.data.isTextBox;},convertSelectedTextAreaToTextBox:function(){var _this_1=this;var selected=this.getSelectedTextAreaItems();selected.forEach(function(item){return _this_1.convertTextAreaToTextBox(item);});},convertSelectedTextBoxToTextArea:function(){var _this_1=this;var selected=this.getSelectedTextAreaItems();selected.forEach(function(item){return _this_1.convertTextBoxToTextArea(item);});},toggleSelectedTextArea:function(){var _this_1=this;var selected=this.getSelectedTextAreaItems();selected.forEach(function(item){if(item.data.isTextBox)_this_1.convertTextBoxToTextArea(item);else _this_1.convertTextAreaToTextBox(item);});},convertTextAreaToTextBox:function(item){if(!this.canChangeItemTextBoxMode(item))return;if(this.isSimpleTextArea(item)){var operationId=this.getLastUndoOperationId();this.beginDesignOperation();item.data.isTextBox=true;this.updateTextArea(item,null);this.onItemUpdated(item);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
//this.mergeAllUndoItemsOperations(item);
}},convertTextBoxToTextArea:function(item){if(!this.canChangeItemTextBoxMode(item))return;if(this.isItemTextBox(item)){var operationId=this.getLastUndoOperationId();this.beginDesignOperation();item.data.isTextBox=false;this.updateTextArea(item,null);this.onItemUpdated(item);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
//this.mergeAllUndoItemsOperations(item);
}},getAllTextAreaItems:function(){var items=[];var customizer=this;function addChildren(item){if(item.children){for(var j=item.children.length-1;j>=0;j--){var child=item.children[j];if(!child.guide&&child.data&&child.data.isTextArea)items.push(child);addChildren(child);}}}for(var i=0,l=customizer.paper.project.layers.length;i<l;i++){var layer=customizer.paper.project.layers[i];if(!layer.guide)addChildren(layer);}return items;},updateTextAreaGuides:function(items){if(!items)items=this.getAllTextAreaItems();for(var i=0;i<items.length;i++){var item=items[i];this.updateTextAreaGuide(item);}},updateTextAreaGuide:function(item){if(item.data.selected&&this.canEditItem(item)){this.drawTextAreaGuide(item);this.drawTextAreaHandles(item);}else{this.removeTextAreaGuide(item);this.removeTextAreaHandles(item);}},drawTextAreaGuide:function(item){this.removeTextAreaGuide(item);if(item&&item.data&&item.data.isTextArea&&item.data.isTextBox&&item.data.rect){var path=new this.paper.Path.Rectangle(item.data.rect);path.data.isTextAreaGuide=true;path.strokeWidth=1.0/this.paper.view.zoom;path.dashOffset=1.0/this.paper.view.zoom;path.dashArray=[2.0/this.paper.view.zoom,2.0/this.paper.view.zoom];path.guide=true;path.data.itemGuid=item.data.guid;path.strokeColor=this.getContrastedColor(item.data.rect);if(item.children&&item.children.length>0){path.rotation=item.children[0].rotation;}else if(item.data.textInfo&&item.data.textInfo.rotation!=undefined){path.rotation=item.data.textInfo.rotation;}}},findTextAreaGuide:function(item){if(item&&item.data&&item.data.isTextArea&&item.data.guid){var upperGuid=item.data.guid.toUpperCase();var findChildByGuid=function(parent,guid){if(parent.data&&parent.data.isTextAreaGuide&&parent.data.itemGuid&&parent.data.itemGuid.toUpperCase()==guid){return parent;}if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];var element=findChildByGuid(child,upperGuid);if(element){return element;}}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;var element=findChildByGuid(layer,upperGuid);if(element){return element;}}}return null;},removeTextAreaGuide:function(item){var guide=this.findTextAreaGuide(item);if(guide)guide.remove();},drawTextAreaHandles:function(item){this.removeTextAreaHandles(item);if(!this.canResizeTextBoxItem(item))return;if(item&&item.data&&item.data.isTextArea&&item.data.isTextBox&&item.data.rect){var handleCircleDimension=this.selectionLateralResizeDimension/this.paper.view.zoom;var path=new this.paper.Path.Rectangle(item.data.rect);if(item.children&&item.children.length>0){path.rotation=item.children[0].rotation;}else if(item.data.textInfo&&item.data.textInfo.rotation!=undefined){path.rotation=item.data.textInfo.rotation;}path.remove();var segments=path.segments;if(segments.length==4){var bottomLeft=segments[0].point;var topLeft=segments[1].point;var topRight=segments[2].point;var bottomRight=segments[3].point;var top=topLeft.add(topRight.subtract(topLeft).divide(2));var bottom=bottomLeft.add(bottomRight.subtract(bottomLeft).divide(2));var left=bottomLeft.add(topLeft.subtract(bottomLeft).divide(2));var right=bottomRight.add(topRight.subtract(bottomRight).divide(2));var d=handleCircleDimension*1.2;var vect=top.subtract(bottom).normalize(d);top=top.add(vect);bottom=bottom.subtract(vect);vect=right.subtract(left).normalize(d);right=right.add(vect);left=left.subtract(vect);var topHandle=new this.paper.Path.Circle(top,handleCircleDimension);topHandle.data.isTextAreaHandle=true;topHandle.data.isTextAreaTopEndHandle=true;topHandle.strokeColor=new this.paper.Color(1,1,1,0.5);topHandle.strokeWidth=1;topHandle.fillColor=new this.paper.Color(0,0,0,0.5);topHandle.data.itemGuid=item.data.guid;var rightHandle=new this.paper.Path.Circle(right,handleCircleDimension);rightHandle.data.isTextAreaHandle=true;rightHandle.data.isTextAreaRightEndHandle=true;rightHandle.strokeColor=new this.paper.Color(1,1,1,0.5);rightHandle.strokeWidth=1;rightHandle.fillColor=new this.paper.Color(0,0,0,0.5);rightHandle.data.itemGuid=item.data.guid;var bottomHandle=new this.paper.Path.Circle(bottom,handleCircleDimension);bottomHandle.data.isTextAreaHandle=true;bottomHandle.data.isTextAreaBottomEndHandle=true;bottomHandle.strokeColor=new this.paper.Color(1,1,1,0.5);bottomHandle.strokeWidth=1;bottomHandle.fillColor=new this.paper.Color(0,0,0,0.5);bottomHandle.data.itemGuid=item.data.guid;var leftHandle=new this.paper.Path.Circle(left,handleCircleDimension);leftHandle.data.isTextAreaHandle=true;leftHandle.data.isTextAreaLeftEndHandle=true;leftHandle.strokeColor=new this.paper.Color(1,1,1,0.5);leftHandle.strokeWidth=1;leftHandle.fillColor=new this.paper.Color(0,0,0,0.5);leftHandle.data.itemGuid=item.data.guid;}}},findTextAreaHandles:function(item){var handles=[];if(item&&item.data&&item.data.isTextArea&&item.data.guid){var upperGuid=item.data.guid.toUpperCase();var findChildByGuid=function(parent,guid){if(parent.data&&parent.data.isTextAreaHandle&&parent.data.itemGuid&&parent.data.itemGuid.toUpperCase()==guid){handles.push(parent);}if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];findChildByGuid(child,upperGuid);}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;findChildByGuid(layer,upperGuid);}}return handles;},removeTextAreaHandles:function(item){var handles=this.findTextAreaHandles(item);for(var i=0;i<handles.length;i++){var handle=handles[i];handle.remove();}},onTextAreaMoved:function(item,delta){if(item&&item.data&&item.data.isTextArea&&item.data.rect){var rect=item.data.rect.clone();rect.x+=delta.x;rect.y+=delta.y;item.data.rect=rect;}},onTextAreaRotated:function(item,deg,pivot){if(item&&item.data&&item.data.isTextBox){this.updateTextArea(item,null);}},onTextAreaScaled:function(item,sx,sy,pivot){if(item&&item.data&&item.data.isTextArea&&item.data.rect){if(!item.data.isTextBox){var path=new this.paper.Path.Rectangle(item.data.rect);path.remove();path.scale(sx,sy,pivot);item.data.rect=path.bounds.clone();}else{this.updateTextArea(item,null);}}},// Utile per verificare se il testo scalato supererebbe il limiti dell'area TextBox fino a scomparire
canResizeSelectedTextAreas:function(sx,sy,pivot){var selected=this.getSelectedItems();for(var i=0;i<selected.length;i++){var item=selected[i];if(!this.canResizeTextArea(item,sx,sy,pivot)){return false;}}return true;},// Utile per verificare se il testo scalato supererebbe il limiti dell'area TextBox fino a scomparire
canResizeTextArea:function(item,sx,sy,pivot){if(item&&item.data&&item.data.isTextArea&&item.data.isTextBox&&item.data.rect&&item.children&&item.children.length>0){var clone=item.children[0].clone();clone.scale(sx,sy,pivot);var newScaling=clone.scaling;clone.remove();var info=this.getTextAreaItemInfo(item,null);info.scaling=newScaling;var children=this.createWrappedText(item.data.rect.clone(),info,true).textItems;console.log("children count: "+children.length);if(children.length==0)return false;else{children.forEach(function(element){element.remove();});}}return true;},moveTextAreaTopEnd:function(info){this.moveTextAreaEnd(info,"top");},moveTextAreaRightEnd:function(info){this.moveTextAreaEnd(info,"right");},moveTextAreaBottomEnd:function(info){this.moveTextAreaEnd(info,"bottom");},moveTextAreaLeftEnd:function(info){this.moveTextAreaEnd(info,"left");},moveTextAreaEnd:function(info,direction){if(this.frozen)return;if(!info.delta)return;var delta=info.delta;this.hideCenterLines();this.removeSelectionAlertItems();var selected=this.getSelectedTextAreaItems();if(selected&&selected.length>0){var item=selected[0];if(item&&item.data&&item.data.isTextArea&&item.data.rect){var oldRect=item.data.rect.clone();var alignment="bottom";if(direction=="top"){item.data.rect.top+=delta.y;alignment="bottom";}else if(direction=="right"){item.data.rect.right+=delta.x;alignment="left";}else if(direction=="bottom"){item.data.rect.bottom+=delta.y;alignment="top";}else if(direction=="left"){item.data.rect.left+=delta.x;alignment="right";}this.correctTextBoxRectRotationError(item,oldRect,alignment);item.data.needsTransformsDataUpdate=true;this.drawTextAreaGuide(item);this.drawTextAreaHandles(item);this.updateTextArea(item,null);// Per gestire il caso in cui l'area venga rimpicciolita troppo da nascondere tutti gli elementi di testo
if(item.children.length==0&&item.data.text){item.data.rect=oldRect.clone();item.data.needsTransformsDataUpdate=true;this.drawTextAreaGuide(item);this.drawTextAreaHandles(item);this.updateTextArea(item,null);}}}},// Il metodo è utile per correggere i diseallineamenti del rettangolo contenitore dovuti a rotazione e ridimensionamento del box contenitore
// Per la correzione del disallinemaento si disegna il path relativo al rettangolo prima e dopo il ridimensionamento e si calcola lo spostamento.
correctTextBoxRectRotationError:function(item,oldRect,alignment){if(item&&item.data&&item.data.isTextBox&&item.data.rect){var rotation=0;if(item.children&&item.children.length>0){rotation=item.children[0].rotation;}else if(item.data.textInfo&&item.data.textInfo.rotation!=undefined){rotation=item.data.textInfo.rotation;}if(rotation!=0){var pathBefore=new this.paper.Path.Rectangle(oldRect);pathBefore.rotate(rotation);pathBefore.remove();var segmentsBefore=pathBefore.segments;var topBefore=null;var bottomBefore=null;var leftBefore=null;var rightBefore=null;if(segmentsBefore.length==4){var bottomLeftBefore=segmentsBefore[0].point;var topLeftBefore=segmentsBefore[1].point;var topRightBefore=segmentsBefore[2].point;var bottomRightBefore=segmentsBefore[3].point;topBefore=topLeftBefore.add(topRightBefore.subtract(topLeftBefore).divide(2));bottomBefore=bottomLeftBefore.add(bottomRightBefore.subtract(bottomLeftBefore).divide(2));leftBefore=bottomLeftBefore.add(topLeftBefore.subtract(bottomLeftBefore).divide(2));rightBefore=bottomRightBefore.add(topRightBefore.subtract(bottomRightBefore).divide(2));}var pathAfter=new this.paper.Path.Rectangle(item.data.rect);pathAfter.rotate(rotation);pathAfter.remove();var segmentsAfter=pathAfter.segments;var topAfter=null;var bottomAfter=null;var leftAfter=null;var rightAfter=null;if(segmentsAfter.length==4){var bottomLeftAfter=segmentsAfter[0].point;var topLeftAfter=segmentsAfter[1].point;var topRightAfter=segmentsAfter[2].point;var bottomRightAfter=segmentsAfter[3].point;topAfter=topLeftAfter.add(topRightAfter.subtract(topLeftAfter).divide(2));bottomAfter=bottomLeftAfter.add(bottomRightAfter.subtract(bottomLeftAfter).divide(2));leftAfter=bottomLeftAfter.add(topLeftAfter.subtract(bottomLeftAfter).divide(2));rightAfter=bottomRightAfter.add(topRightAfter.subtract(bottomRightAfter).divide(2));}var pointBefore=null;var pointAfter=null;if(alignment=="bottom"){pointBefore=bottomBefore;pointAfter=bottomAfter;}else if(alignment=="top"){pointBefore=topBefore;pointAfter=topAfter;}else if(alignment=="right"){pointBefore=rightBefore;pointAfter=rightAfter;}else if(alignment=="left"){pointBefore=leftBefore;pointAfter=leftAfter;}if(pointBefore&&pointAfter){// Correzione
var displ=pointAfter.subtract(pointBefore);item.data.rect.x-=displ.x;item.data.rect.y-=displ.y;}}// .........................     
}},// Se lo spazio non è sufficiente per visualizzare il testo decrementa le dimensioni del font e riprova
adaptTextBoxFontSize:function(item){if(this.isItemTextBox(item)){var constraints=this.getItemConstraints(item);if(constraints&&!constraints.get("canChangeFontSize"))return;var info=this.getTextAreaItemInfo(item,null);if(info.adaptText)return;var fontSize=info.fontSize;while(info.text&&item.children.length==0&&fontSize>=1){fontSize-=1;this.updateTextArea(item,{fontSize:fontSize});}}},modifyTextAreaInfo:function(item,newInfo){if(newInfo){newInfo.text=this.adjustInputTextByConstraints(item,newInfo.text!=null?newInfo.text:item.data.text);newInfo.letterSpacing=this.adjustInputLetterSpacingByConstraints(item,newInfo.letterSpacing?parseInt(newInfo.letterSpacing):undefined);newInfo.lineSpacing=this.adjustInputLineSpacingByConstraints(item,newInfo.lineSpacing?parseInt(newInfo.lineSpacing):undefined);}this.removeAllAlertItems();this.updateTextArea(item,newInfo);this.checkImagesSizeLimit();},// Restituisce le informazioni del TextArea tenendo presente anche le info in input che agiscono come modificatori.
getTextAreaItemInfo:function(item,info){if(item&&item.data&&item.data.isTextArea){// Le informazioni sul testo vengono recuperate utilizzando le seguenti sorgenti:
// info in input, item.children[0] se item.children.length > 0 oppure item.data.textInfo
var childInfo=null;if(item.children.length>0){var child=item.children[0];childInfo={};childInfo.strokeColor=typeof child.strokeColor==='string'||child.strokeColor instanceof String?child.strokeColor:child.strokeColor.toCSS(true);childInfo.fillColor=typeof child.fillColor==='string'||child.fillColor instanceof String?child.fillColor:child.fillColor.toCSS(true);childInfo.strokeWidth=child.strokeWidth;childInfo.fontFamily=child.fontFamily;childInfo.fontWeight=child.fontWeight;childInfo.fontStretch=child.fontStretch;childInfo.fontSize=child.fontSize;childInfo.scaling=child.scaling;childInfo.rotation=child.rotation;childInfo.shadowColor=null;if(child.shadowColor)childInfo.shadowColor=typeof child.shadowColor==='string'||child.shadowColor instanceof String?child.shadowColor:child.shadowColor.toCSS(true);childInfo.shadowBlur=child.shadowBlur;childInfo.shadowDistance=this.getOffsetDistance(child.shadowOffset);childInfo.shadowAngle=this.getOffsetAngle(child.shadowOffset);}childInfo=childInfo||{};var constraints=this.getItemConstraints(item);info=info||{};info.text=info.text||item.data.text;var textInfo=item.data.textInfo||{};if(!constraints||constraints.get("canChangeFontColor")){info.strokeColor=info.strokeColor!=undefined?info.strokeColor:childInfo.strokeColor!=undefined?childInfo.strokeColor:textInfo.strokeColor;info.fillColor=info.fillColor!=undefined?info.fillColor:childInfo.fillColor!=undefined?childInfo.fillColor:textInfo.fillColor;}else{info.strokeColor=childInfo.strokeColor!=undefined?childInfo.strokeColor:textInfo.strokeColor;info.fillColor=childInfo.fillColor!=undefined?childInfo.fillColor:textInfo.fillColor;}info.strokeWidth=info.strokeWidth!=undefined?info.strokeWidth:childInfo.strokeWidth!=undefined?childInfo.strokeWidth:textInfo.strokeWidth;if(!constraints||constraints.get("canChangeFontFamily"))info.fontFamily=info.fontFamily!=undefined?info.fontFamily:childInfo.fontFamily!=undefined?childInfo.fontFamily:textInfo.fontFamily;else info.fontFamily=childInfo.fontFamily!=undefined?childInfo.fontFamily:textInfo.fontFamily;info.fontFamily=this.sanitizeFontFamilyName(info.fontFamily);var inputFontWeight=info.fontWeight!=undefined?info.fontWeight:childInfo.fontWeight!=undefined?childInfo.fontWeight:textInfo.fontWeight;info.fontWeight=this.adjustInputFontWeightByConstraints(childInfo.fontWeight!=undefined?childInfo.fontWeight:textInfo.fontWeight,inputFontWeight,constraints);info.fontStretch=info.fontStretch!=undefined?info.fontStretch:childInfo.fontStretch!=undefined?childInfo.fontStretch:textInfo.fontStretch;if(!constraints||constraints.get("canChangeFontSize"))info.fontSize=info.fontSize!=undefined?info.fontSize:childInfo.fontSize!=undefined?childInfo.fontSize:textInfo.fontSize;else info.fontSize=childInfo.fontSize!=undefined?childInfo.fontSize:textInfo.fontSize;info.scaling=info.scaling!=undefined?info.scaling:childInfo.scaling!=undefined?childInfo.scaling:textInfo.scaling;info.scaling=info.scaling||1;info.justification=info.justification!=undefined?info.justification:item.data.justification!=undefined?item.data.justification:"justify";info.rotation=childInfo.rotation!=undefined?childInfo.rotation:textInfo.rotation;info.rotation=info.rotation||0;info.isTextBox=item.data&&item.data.isTextBox;info.adaptText=info.adaptText!=undefined?info.adaptText:item.data.adaptText!=undefined?item.data.adaptText:false;if(!constraints||constraints.get("canChangeVerticalAlignment"))info.verticalAlignment=info.verticalAlignment!=undefined?info.verticalAlignment:item.data.verticalAlignment!=undefined?item.data.verticalAlignment:"top";else info.verticalAlignment=item.data.verticalAlignment!=undefined?item.data.verticalAlignment:"top";var inputLetterSpacing=info.letterSpacing!=undefined?info.letterSpacing:item.data.letterSpacing!=undefined?item.data.letterSpacing:0;info.letterSpacing=this.adjustInputLetterSpacingByConstraints(item,info.letterSpacing);var inputLineSpacing=info.lineSpacing!=undefined?info.lineSpacing:item.data.lineSpacing!=undefined?item.data.lineSpacing:0;info.lineSpacing=this.adjustInputLineSpacingByConstraints(item,info.lineSpacing);if(!constraints||constraints.get("canChangeShadowColor"))info.shadowColor=info.shadowColor!==undefined?info.shadowColor:childInfo.shadowColor!==undefined?childInfo.shadowColor:textInfo.shadowColor;else info.shadowColor=childInfo.shadowColor!==undefined?childInfo.shadowColor:textInfo.shadowColor;if(!constraints||constraints.get("canChangeShadowBlur"))info.shadowBlur=info.shadowBlur!==undefined?info.shadowBlur:childInfo.shadowBlur!=undefined?childInfo.shadowBlur:textInfo.shadowBlur;else info.shadowBlur=childInfo.shadowBlur!==undefined?childInfo.shadowBlur:textInfo.shadowBlur;if(!constraints||constraints.get("canChangeShadowDistance"))info.shadowDistance=info.shadowDistance!==undefined?info.shadowDistance:childInfo.shadowDistance!=undefined?childInfo.shadowDistance:textInfo.shadowDistance;else info.shadowDistance=childInfo.shadowDistance!==undefined?childInfo.shadowDistance:textInfo.shadowDistance;if(!constraints||constraints.get("canChangeShadowAngle"))info.shadowAngle=info.shadowAngle!==undefined?info.shadowAngle:childInfo.shadowAngle!=undefined?childInfo.shadowAngle:textInfo.shadowAngle;else info.shadowAngle=childInfo.shadowAngle!==undefined?childInfo.shadowAngle:textInfo.shadowAngle;if(!this.allowShadows())info.shadowColor=null;info.shadowBlur=this.adjustInputShadowBlur(item,info.shadowBlur);info.shadowDistance=this.adjustInputShadowDistance(item,info.shadowDistance);info.shadowAngle=this.adjustInputShadowAngle(item,info.shadowAngle);return info;}return null;},setTextAreaItemInfo:function(item,info){if(item){item.data.textInfo=info;}},// Rivisto il metodo per, tra le altre cose, far fronte alla mancanza di children nel caso TextBox con area troppo piccola
// Nel caso di mancanza di children, si utilizzano le informazioni sul testo salvate nei metadata
updateTextArea:function(item,info){if(item&&item.data&&item.data.isTextArea&&item.data.rect){var originalText=item.data.text||info.text;var currentInfo=this.getTextAreaItemInfo(item);var designEffect=null;var designItem=this.findDesignItemForItem(item);if(designItem)designEffect=this.getDesignEffectForDesignItem(designItem);var originalStrokeColor=null;var originalFillColor=null;var originalShadowColor=null;if(info&&info.strokeColor!=undefined){originalStrokeColor=info.strokeColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor,currentInfo.strokeColor);info.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);item.data.originalStrokeColor=originalStrokeColor;}if(info&&info.fillColor!=undefined){originalFillColor=info.fillColor;originalFillColor=this.forceColorInFixedPalette(item,originalFillColor,currentInfo.fillColor);info.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);item.data.originalFillColor=originalFillColor;}if(info&&info.shadowColor!==undefined){originalShadowColor=info.shadowColor;originalShadowColor=this.forceColorInFixedPalette(item,originalShadowColor,currentInfo.shadowColor);info.shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);item.data.originalShadowColor=originalShadowColor;}this.beginDesignOperation();var oldBounds=item.bounds.clone();info=this.getTextAreaItemInfo(item,info);if(info){var str=info.text;item.data.justification=info.justification;item.data.text=info.text;item.data.adaptText=info.adaptText;item.data.letterSpacing=info.letterSpacing;item.data.lineSpacing=info.lineSpacing;item.data.verticalAlignment=info.verticalAlignment;var oldRotation=info.rotation;var oldFlipX=info.scaling.x<0?-1:1;var oldFlipY=info.scaling.y<0?-1:1;var oldMatrix=item.matrix.clone();if(!item.data.isTextBox)item.rotate(0-oldRotation);else{var pivot=item.data.rect.center.clone();item.rotate(-oldRotation,pivot);}var itemBounds=item.bounds.clone();item.removeChildren();if(!item.data.isTextBox){//item.addChildren(this.createWrappedText(item.data.rect.clone(), info, false).textItems);
item.addChildren(this.createWrappedText(itemBounds,info,false).textItems);}else{if(item.data.adaptText){// Per cercare di ottimizzare il processo, nel caso in cui il numero di caratteri sia tanto diverso da quello attuale
// cerco di partire da una grandezza iniziale di font più vicina possibile a quella richiesta per adattare il font
var result=null;if(originalText&&originalText.length>0&&info.text&&Math.abs(originalText.length-info.text.length)>5){var charDiff=Math.abs(originalText.length-info.text.length);// Eseguo una ricerca di tipo binario. Scelgo i limiti.
var minFs=info.fontSize;var maxFs=info.fontSize;if(originalText.length<info.text.length){maxFs=info.fontSize;minFs=this.adjustTextFontSize(item,maxFs-charDiff*4);if(minFs<1)minFs=1;}else{minFs=info.fontSize;maxFs=this.adjustTextFontSize(item,minFs+charDiff*4);}info.fontSize=Math.round(minFs+(maxFs-minFs)/2);while(info.fontSize-minFs>0&&maxFs-info.fontSize>0){if(result)result.textItems.forEach(function(i){return i.remove();});result=this.createWrappedText(item.data.rect,info,true);if(result.limitsExceeded){// Troppo grande
maxFs=info.fontSize;}else{// Troppo piccolo
minFs=info.fontSize;}info.fontSize=Math.round(minFs+(maxFs-minFs)/2);}}if(!result)result=this.createWrappedText(item.data.rect,info,true);// Aumento il font fino al superamento dei limiti
while(!result.limitsExceeded&&this.canSetTextFontSizePx(item,info.fontSize+1)){result.textItems.forEach(function(i){return i.remove();});info.fontSize+=1;result=this.createWrappedText(item.data.rect,info,true);}// Diminuisco il font fino al non superamento dei limiti
while(result.limitsExceeded&&info.fontSize>1&&this.canSetTextFontSizePx(item,info.fontSize-1)){result.textItems.forEach(function(i){return i.remove();});info.fontSize-=1;result=this.createWrappedText(item.data.rect,info,true);}item.addChildren(result.textItems);}else{item.addChildren(this.createWrappedText(item.data.rect.clone(),info,true).textItems);}}this.applyDesignEffectToItem(designEffect,item);//item.scale(oldFlipX, oldFlipY);
if(!item.data.isTextBox){item.rotate(oldRotation);}else{var pivot=item.data.rect.center.clone();item.rotate(oldRotation,pivot);}if(!item.data.isTextBox)this.alignTextAreaItem(item,oldRotation,info.justification,oldBounds,str);if(!item.data.isTextBox)item.data.rect=item.bounds.clone();this.setTextAreaItemInfo(item,info);this.updateSelectionState();this.paper.project.view.update();}this.endDesignOperation();}},alignTextAreaItem:function(item,rotation,justification,oldBounds,oldText){if(oldText==null)return;var newPosition=new this.paper.Point(oldBounds.x+oldBounds.width/2,oldBounds.y+oldBounds.height/2);if(justification!="center"&&justification!="justify"){var topLeft=new this.paper.Point(oldBounds.left+item.bounds.width/2,oldBounds.top+item.bounds.height/2);var topRight=new this.paper.Point(oldBounds.right-item.bounds.width/2,oldBounds.top+item.bounds.height/2);var bottomLeft=new this.paper.Point(oldBounds.left+item.bounds.width/2,oldBounds.bottom-item.bounds.height/2);var bottomRight=new this.paper.Point(oldBounds.right-item.bounds.width/2,oldBounds.bottom-item.bounds.height/2);//Find the point where the actual bounds should anchor to the old bounds
if(rotation>=0&&rotation<=90)newPosition=justification=="left"?topLeft:bottomRight;else if(rotation>90&&rotation<=180)newPosition=justification=="left"?topRight:bottomLeft;else if(rotation>=-90&&rotation<0)newPosition=justification=="left"?bottomLeft:topRight;else if(rotation>-180&&rotation<-90)newPosition=justification=="left"?bottomRight:topLeft;item.position=newPosition;var lines=item.data.text.split("\n");var oldLines=oldText.split("\n");var deltaLines=lines.length-oldLines.length;if(lines.length!=oldLines.length){var clonedWord=item.children[0].clone();clonedWord.visible=false;clonedWord.rotate(0-rotation);var anchorItem=new this.paper.Path.Circle(justification=="left"?clonedWord.bounds.topLeft.clone():clonedWord.bounds.topRight.clone(),1);anchorItem.visible=false;anchorItem.pivot=new this.paper.Point(clonedWord.position.x,clonedWord.position.y);anchorItem.rotate(rotation);anchorItem.pivot=null;//If a new line is added or removed, place the text so that the first line is in the same position as before
//It is made by calculating the horizontal/vertical delta needed to compensate the temp wrong movement
//The bounds of the first word (with a rotation of 0 degrees) help with the calculation
if(rotation>=0&&rotation<=90){if(justification=="left")newPosition.x-=(anchorItem.position.x-item.children[0].bounds.left)*deltaLines;else newPosition.y+=(item.children[0].bounds.bottom-anchorItem.position.y)*deltaLines;}else if(rotation>90&&rotation<=180){if(justification=="left")newPosition.y-=(anchorItem.position.y-item.children[0].bounds.top)*deltaLines;else newPosition.x-=(anchorItem.position.x-item.children[0].bounds.left)*deltaLines;}else if(rotation>=-90&&rotation<0){if(justification=="left")newPosition.y+=(item.children[0].bounds.bottom-anchorItem.position.y)*deltaLines;else newPosition.x+=(item.children[0].bounds.right-anchorItem.position.x)*deltaLines;}else if(rotation>-180&&rotation<-90){if(justification=="left")newPosition.x+=(item.children[0].bounds.right-anchorItem.position.x)*deltaLines;else newPosition.y-=(anchorItem.position.y-item.children[0].bounds.top)*deltaLines;}anchorItem.remove();clonedWord.remove();}}item.position=newPosition;},onTextAreaGuidesUpdated:function(interactionMode){var items=this.getSelectedItems();var item=items[0];if(item&&item.data&&item.data.isTextArea){this.updateSelectionState();this.updateTextArea(item,null);if(!item.data.isTextBox)item.data.rect=this.findTextAreaGuide(item).bounds.clone();}},forceSelectedTextAreasToBounds:function(){var items=this.getSelectedTextAreaItems();for(var i=0;i<items.length;i++){this.forceTextAreaToBounds(items[i]);}},forceTextAreaToBounds:function(item){if(item&&item.data&&item.data.isTextArea&&item.data.rect&&!item.data.isTextBox){var bounds=item.bounds.clone();if(!bounds.isEmpty()){item.data.rect=bounds;}}},// Revisione per Letter-Spacing - Line Spacing
// Il metodo si occupa di rapppresentare il testo nel rettengolo fornito in input. 
// Il supporto per RTL è piuttosto basico. Dopo aver sistemato i caratteri su tutte linee di testo, le parole che compongono un'intera linea
// vengono invertite di posizione. Per ogni parola del testo, c'è un minimo di gestione di contenuti bidirezionali. Ogni parola viene suddivisa
// in una parte iniziale rtl e in una finale ltr e ricomposta come ltr + rtl. E' gestito infine il caso in cui una parola termini con uno o più 
// segni di punteggiatura, nel qual caso i segni finali vengono posit alla sinistra della parola.
createWrappedText:function(rect,info,isTextBox){var _this_1=this;var _this=this;var limitsExceeded=false;var textItems=[];// Elenco completo dei PointText relativi al testo
var str=info.text;var isRtl=/[\u0590-\u05ff\u0600-\u06ff]/.test(str);var justification=info.justification!=undefined?info.justification:"justify";if(isTextBox){var refPT=this.createPointText(".",info);refPT.remove();if(refPT.bounds.width>rect.width+0.001){Logger.info("text area too small for even a single text char");limitsExceeded=true;return{limitsExceeded:limitsExceeded,textItems:textItems};}}var lineHeight=this.getLineHeight(info);if(lineHeight>rect.height+0.001){Logger.info("text area too small for even a single text char");limitsExceeded=true;return{limitsExceeded:limitsExceeded,textItems:textItems};}var spaceWidth=this.getSpaceWidth(info);var extraSpace=this.getTextExtraSpace(info);var word=null;// una parola è rappresentata da un insieme di PointText che riesce a stare nei limiti del rettangolo e separata da un'altra parola da uno spazio
var line=[];// una linea è composta di una o più parole
var paragraph=[];// insieme di linee
var paragraphs=[];// insieme di paragrafi
var maxLineWidth=rect.width;var xMax=rect.x+rect.width;var yMax=rect.y+rect.height;if(!isTextBox)xMax=Number.MAX_VALUE;if(!isTextBox)yMax=Number.MAX_VALUE;var dx=rect.x;// inizio parola corrente
var dy=rect.y+lineHeight;// inizio linea corrente
var verticalLimitsReached=false;var getWordWidth=function(word){if(word===null||word.length===0)return 0;if(word instanceof _this.paper.PointText){return word.bounds.width;}else{var x1=word[0].bounds.x;var x2=word[word.length-1].bounds.right;return Math.abs(x2-x1);}};var getNextCharStartX=function(word,ch){// Funzione utile solo nel caso di costruzione carattere per carattere
if(!_this.isLetterSpacingSpecified(info))return 0;// Determino la posizione naturale del prossimo carattere nella parola
var xOffset=0;var gliph=_this.createPointText(ch,info);gliph.justification="center";gliph.remove();if(word===null||word.length===0)xOffset=dx+gliph.bounds.width/2;var prevCh=word[word.length-1];var pairText=_this.createPointText(prevCh.content+ch,info);pairText.remove();xOffset=prevCh.point.x+(pairText.bounds.width-prevCh.bounds.width/2-gliph.bounds.width/2);// Letter-spacing
xOffset+=extraSpace;// controllo che il carattere non vada più indietro di quello precedente
xOffset=Math.max(xOffset,prevCh.point.x);return xOffset;};var addCharToWord=function(word,ch){if(!word)return;if(!_this.isLetterSpacingSpecified(info)){word.content+=ch;}else if(word&&word.length>=0){var gliph=_this.createPointText(ch,info);gliph.justification="center";var x=getNextCharStartX(word,ch);gliph.point=new _this.paper.Point(x,dy);word.push(gliph);textItems.push(gliph);}};var moveWord=function(word,startX,y){if(!word)return;if(!_this.isLetterSpacingSpecified(info)){word.point=new _this.paper.Point(startX,y);}else if(word.length>0){var x=word[0].bounds.x;var deltaX=x-startX;for(var i=0;i<word.length;i++){word[i].point=new _this.paper.Point(word[i].point.x-deltaX,y);}}};var removeWord=function(word){if(!word)return;if(!_this.isLetterSpacingSpecified(info)){word.remove();textItems.pop();}else if(word.length>0){for(var i=0;i<word.length;i++){word[i].remove();textItems.pop();}}};var getLineWidth=function(line){if(line&&line.length>0){var word1=line[0];var word2=line[line.length-1];var x1=0;var x2=0;if(!_this.isLetterSpacingSpecified(info)){x1=word1.bounds.x;x2=word2.bounds.right;}else{if(word1.length==0)return 0;if(word2.length==0)return 0;x1=word1[0].bounds.x;x2=word2[word2.length-1].bounds.right;}return Math.abs(x2-x1);}return 0;};var moveToNextLine=function(){dx=rect.x;dy+=lineHeight+_this.getLineExtraSpace(info);if(dy>yMax){verticalLimitsReached=true;limitsExceeded=true;}};var endOfParagraph=function(){endOfLine();paragraph=[];// resetto il paragrafo corrente
};var endOfLine=function(){word=null;// resetto la parola corrente
line=[];// resetto la linea corrente
moveToNextLine();// sposto i puntatori all'inizio della riga successiva
};var endOfWord=function(){if(word)dx+=getWordWidth(word);word=null;// resetto la parola corrente
if(dx+spaceWidth<=xMax){dx+=spaceWidth+extraSpace;}else{endOfLine();}};var addWordToLine=function(){// aggiungo alla linea corrente
line.push(word);if(line.length===1){// aggiungo la linea al paragrafo corrente
paragraph.push(line);if(paragraph.length===1)paragraphs.push(paragraph);}};var beginWord=function(ch){// provo ad iniziare una nuova parola
var tempWord=_this.createPointText(ch,info);if(_this.isLetterSpacingSpecified(info))tempWord.justification="center";var wordWidth=tempWord.bounds.width;// se vado oltre i limiti vado a capo
if(dx+wordWidth>xMax){if(line&&line.length>0)endOfLine();else limitsExceeded=true;}if(!verticalLimitsReached&&!limitsExceeded){// La parola può essere aggiunta
if(!_this.isLetterSpacingSpecified(info))tempWord.point=new _this.paper.Point(dx,dy);else tempWord.point=new _this.paper.Point(dx+tempWord.bounds.width/2,dy);if(paragraphs.length==0&&tempWord.bounds.bottom>dy){// correggo il dy per tener conto della effettiva baseline
var delta=tempWord.bounds.bottom-dy;dy-=delta;yMax-=delta;if(!_this.isLetterSpacingSpecified(info))tempWord.point=new _this.paper.Point(dx,dy);else tempWord.point=new _this.paper.Point(dx+tempWord.bounds.width/2,dy);}if(!_this.isLetterSpacingSpecified(info))word=tempWord;else word=[tempWord];textItems.push(tempWord);// aggiungo alla linea corrente
addWordToLine();}else{tempWord.remove();}};var extendWord=function(ch){// provo ad estendere la parola corrente, se rientro nei limiti
//word.content += ch;            
addCharToWord(word,ch);if(dx+getWordWidth(word)>xMax+0.0001){// Se è l'unica parola della linea allora posso solo spezzare la parola su più linee
// altrimenti assegno la parola alla linea successiva
if(line.length==1){if(!info.adaptText){// elimino l'ultimo carattere ed inizio una nuova parola su una nuova linea
if(!_this.isLetterSpacingSpecified(info)){word.content=word.content.substring(0,word.content.length-1);}else{var lastGliph=word.pop();lastGliph.remove();textItems.pop();}endOfLine();beginWord(ch);}else{// non posso inserire la parola. La rimuovo e imposto il limite raggiunto
line.pop();removeWord(word);limitsExceeded=true;}}else{// tutta la parola corrente va portata su la linea successiva se possibile                    
var tempWord=word;line.pop();endOfLine();word=tempWord;if(!verticalLimitsReached){// Posso spostare la parola sulla linea successiva
moveWord(word,dx,dy);addWordToLine();}else{// limiti verticali superati, elimino la parola corrente
removeWord(word);}}}};var addNewChar=function(ch){if(!word||word.length===0){beginWord(ch);}else{extendWord(ch);}};// carattere per carattere compongo la parola corrente, linea corrente, paragrafo corrente
for(var i=0;i<str.length&&!verticalLimitsReached&&!limitsExceeded;i++){var ch=str[i];if(ch=="\n"){endOfParagraph();}else if(ch===" "){endOfWord();}else{addNewChar(ch);}}var minY=undefined;var maxY=undefined;for(var i=0;i<paragraphs.length;i++){var parag=paragraphs[i];for(var j=0;j<parag.length;j++){var textLine=parag[j];if(textLine.length===0)continue;for(var k=0;k<textLine.length;k++){var word_1=textLine[k];if(word_1 instanceof _this.paper.PointText){minY=minY==undefined?word_1.bounds.top:Math.min(minY,word_1.bounds.top);maxY=maxY==undefined?word_1.bounds.bottom:Math.max(maxY,word_1.bounds.bottom);}else if(word_1.length>0){word_1.forEach(function(letter){minY=minY==undefined?letter.bounds.top:Math.min(minY,letter.bounds.top);maxY=maxY==undefined?letter.bounds.bottom:Math.max(maxY,letter.bounds.bottom);});}}if(justification=="justify"&&j==parag.length-1)continue;// nel caso di "justify" l'ultima linea del paragrafo non si giustifica mai
var lineWidth=getLineWidth(textLine);if(lineWidth>maxLineWidth)maxLineWidth=lineWidth;if(isRtl)this.invertLineRtlWords(textLine,rect.x,rect.x+rect.width,spaceWidth,info);this.justifyLine(textLine,rect,rect.x+lineWidth,justification,info);}}var deltaY=minY==undefined||maxY==undefined?0:rect.height-Math.abs(maxY-minY);if(isTextBox&&deltaY>0&&(info.verticalAlignment=="middle"||info.verticalAlignment=="bottom")){if(info.verticalAlignment=="middle")deltaY/=2;for(var i=0;i<paragraphs.length;i++){var parag=paragraphs[i];for(var j=0;j<parag.length;j++){var textLine=parag[j];if(textLine.length===0)continue;for(var k=0;k<textLine.length;k++){var word_2=textLine[k];if(word_2 instanceof _this.paper.PointText){word_2.point=new this.paper.Point(word_2.point.x,word_2.point.y+deltaY);}else if(word_2.length>0){word_2.forEach(function(letter){letter.point=new _this_1.paper.Point(letter.point.x,letter.point.y+deltaY);});}}}}}if(!isTextBox)rect.width=maxLineWidth;return{limitsExceeded:limitsExceeded||verticalLimitsReached,textItems:textItems};//return textItems;
},// Funzione che esegue l'allineamento delle parole presenti in line (ogni parola è un PointText)
justifyLine:function(line,rect,dx,justification,info){var _this=this;var getWordWidth=function(word){if(word===null||word.length===0)return 0;if(word instanceof _this.paper.PointText)return word.bounds.width;else{// Le lettere della parola potrebbero non essere nel giusto ordine di visualizzazione (rtl)
var minX_1=Number.MAX_VALUE;var maxRight_1=Number.MIN_VALUE;word.forEach(function(p){if(p.bounds.x<minX_1)minX_1=p.point.x;if(p.bounds.right>maxRight_1)maxRight_1=p.bounds.right;});return Math.abs(maxRight_1-minX_1);}};var moveWord=function(word,startX,y){if(!word)return;if(word instanceof _this.paper.PointText){word.point=new _this.paper.Point(startX,y);}else if(word.length>0){var x=word[0].bounds.x;var deltaX=x-startX;for(var i=0;i<word.length;i++){word[i].point=new _this.paper.Point(word[i].point.x-deltaX,y);}}};if(line.length>0){var lineWidth=dx-rect.x;var extraWidth=rect.width-lineWidth;if(justification=="justify"){// spazio extra distribuito tra le parole
if(line.length>1){var extraRoom=extraWidth/(line.length-1);for(var j=1;j<line.length;j++){var lineText=line[j];if(lineText instanceof _this.paper.PointText){lineText.point=new this.paper.Point(lineText.point.x+extraRoom*j,lineText.point.y);}else{var x=lineText[0].bounds.x;var y=lineText[0].point.y;moveWord(lineText,x+extraRoom*j,y);}}}}else if(justification=="right"){// tutto lo spazio extra a sinistra
for(var j=0;j<line.length;j++){var lineText=line[j];if(lineText instanceof _this.paper.PointText){lineText.point=new this.paper.Point(lineText.point.x+extraWidth,lineText.point.y);}else{var x=lineText[0].bounds.x;var y=lineText[0].point.y;moveWord(lineText,x+extraWidth,y);}}}else if(justification=="center"){// metà spazio extra a sinistra e metà a destra
for(var j=0;j<line.length;j++){var lineText=line[j];if(lineText instanceof _this.paper.PointText){lineText.point=new this.paper.Point(lineText.point.x+extraWidth/2,lineText.point.y);}else{var x=lineText[0].bounds.x;var y=lineText[0].point.y;moveWord(lineText,x+extraWidth/2,y);}}}}},// Inverte l'ordine delle parole in una linea di testo e controlla se è composta da una parte rtl e ltr, nel qual caso la ricompone come ltr + rtl.
invertLineRtlWords:function(textLine,xMin,xMax,spaceWidth,info){var _this=this;var spaceWidth=this.getSpaceWidth(info);var extraSpace=this.getTextExtraSpace(info);var getWordWidth=function(word){if(word===null||word.length===0)return 0;if(word instanceof _this.paper.PointText)return word.bounds.width;var newWord=[];for(var i=0;i<word.length;i++)newWord[i]=word[i];newWord.sort(function(a,b){return a.point.x>b.point.x?1:b.point.x>a.point.x?-1:0;});var x1=newWord[0].bounds.x;var x2=newWord[newWord.length-1].bounds.right;return Math.abs(x2-x1);};var moveWordX=function(word,sortedWord,startX){if(!word||!sortedWord)return;if(word instanceof _this.paper.PointText){word.point=new _this.paper.Point(startX,word.point.y);}else if(sortedWord&&sortedWord.length>0){var x=sortedWord[0].bounds.x;var deltaX=x-startX;for(var i=0;i<sortedWord.length;i++){sortedWord[i].point=new _this.paper.Point(sortedWord[i].point.x-deltaX,sortedWord[i].point.y);}}};var getWordContent=function(word){var content="";if(!word||word.length==0)return content;if(word instanceof _this.paper.PointText)return word.content;for(var i=0;i<word.length;i++){content+=word[i].content;}return content;};var isRtl=function(str){return /[\u0590-\u05ff\u0600-\u06ff]/.test(str);};var hasPuctuation=function(str){return /[!,.:;?]/g.test(str);};// cambia il contenuto di una parola ponendone la parte ltr a sinistra e la rtl a destra 
var adjustBidrectionalContent=function(word){var content=getWordContent(word);var startPart=content;var endPart="";var testPart="";if(isRtl(content)){// La parte finale non rtl la porto all'inizio
for(var i=content.length-1;i>=0;i--){testPart=content.substring(i);if(isRtl(testPart))break;endPart=testPart;startPart=content.substring(0,i);}if(startPart&&endPart){word.content=endPart+startPart;}}else{// se la string termina con un carattere di punteggiatura (testati solo i più comuni) inverto la posizione
for(var i=content.length-1;i>=0;i--){testPart=content[i];if(!hasPuctuation(testPart))break;endPart=content.substring(i);startPart=content.substring(0,i);}if(startPart&&endPart){word.content=endPart+startPart;}}return word;};// Da utilizzare per il caso letter-spacing
// cambia il contenuto di una parola ponendone la parte ltr a sinistra e la rtl a destra 
// Inoltre, per la parte rtl vengono invertite le posizione dei caratteri
// Restituisce un nuovo array con i PointText ordinati correttamente
var adjustBidrectionalContentLS=function(word){var content=getWordContent(word);var startPart=content;var endPart="";var rtlIdx=-1;if(isRtl(content)){// La parte finale non rtl la porto all'inizio
for(var i=word.length-1;i>=0;i--){if(isRtl(getWordContent(word.slice(i)))){rtlIdx=i+1;break;}}}else{// se la string termina con un carattere di punteggiatura (testati solo i più comuni) inverto la posizione
for(var i=word.length-1;i>=0;i--){if(!hasPuctuation(word[i].content)){rtlIdx=i+1;break;}}}var newWord=word.slice(0);if(rtlIdx>=0){newWord=[];for(var i=rtlIdx;i<word.length;i++){newWord[i-rtlIdx]=word[i];}for(var i=0;i<rtlIdx&&i<word.length;i++){newWord[word.length-1-i]=word[i];}// Cambio la posizione di ogni PointText in base all'ordine in newWord
// Devo rifare tutto il ragionamento del kerning, partendo solo dal punto iniziale
var dx_1=word[0].bounds.x;var xOffset=dx_1;var gliph=null;var prevGliph=null;for(var i=0;i<newWord.length;i++){gliph=newWord[i];if(i==0)xOffset=dx_1+gliph.bounds.width/2;else{prevGliph=newWord[i-1];var pairText=_this.createPointText(prevGliph.content+gliph.content,info);pairText.remove();xOffset=prevGliph.point.x+(pairText.bounds.width-prevGliph.bounds.width/2-gliph.bounds.width/2);// Provo ad aumentare di un tot (simulando il letter-spacing)
xOffset+=spaceWidth*extraSpace;// controllo che il carattere non vada più indietro di quello precedente
xOffset=Math.max(xOffset,prevGliph.point.x);}gliph.point.x=xOffset;}}return newWord;};if(textLine.length>1){var xCoords=[];var dx=xMin;for(var i=textLine.length-1;i>=0;i--){var word=textLine[i];var sortedWord=word;if(!_this.isLetterSpacingSpecified(info)&&word instanceof _this.paper.PointText)sortedWord=adjustBidrectionalContent(word);else sortedWord=adjustBidrectionalContentLS(word);if(i<textLine.length-1){dx+=spaceWidth+extraSpace;}moveWordX(word,sortedWord,dx);//word.point = new this.paper.Point(dx, word.point.y);
//dx += word.bounds.width;
dx+=getWordWidth(sortedWord);}}else if(textLine.length==1){if(!_this.isLetterSpacingSpecified(info))adjustBidrectionalContent(textLine[0]);else adjustBidrectionalContentLS(textLine[0]);}},getLineHeight:function(info){var lineHeightText=this.createPointText("abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",info);lineHeightText.remove();var lineHeight=lineHeightText.bounds.height;return lineHeight;},getLineWidth:function(content,info){var lineWidthText=this.createPointText(content,info);lineWidthText.remove();var lineWidth=lineWidthText.bounds.width;return lineWidth;},getSpaceWidth:function(info){var spaceText=this.createPointText(" ",info);spaceText.remove();var spaceWidth=spaceText.bounds.width;return spaceWidth;},// Restituisce l'altezza della parte al di sopra della baseline
// Allo stato attuale il metodo che trovo più preciso è quello di misurare direttamente
// l'altezza dopo aver disegnato il carattere su un canvas offset
getFontAscent:function(info){var fontStyle=this.getShortcutFontProperty(info);var result=this.fontAscentCache.hasOwnProperty(fontStyle)?this.fontAscentCache[fontStyle]:null;// ricavo le dimensioni del canvas da creare
var refPointText=this.createPointText("M",info);var bounds=refPointText.bounds;refPointText.remove();var canvasWidth=Math.floor(bounds.width)+1;var canvasHeight=Math.floor(bounds.height)+1;if(!result){// creo un offset canvas su cui eseguire il disegno
var $canvas=$("<canvas>",{id:Math.floor(99999*Math.random()+1)}).attr({width:canvasWidth,height:canvasHeight});var fontDraw=$canvas[0];var ctx=fontDraw.getContext("2d");ctx.fillRect(0,0,fontDraw.width,fontDraw.height);ctx.textBaseline='top';ctx.fillStyle='white';ctx.font=fontStyle;//ctx.fillText('gM', 0, 0);
ctx.fillText('M',0,0);var pixels=ctx.getImageData(0,0,fontDraw.width,fontDraw.height).data;var start=-1;var end=-1;for(var row=0;row<fontDraw.height;row++){for(var column=0;column<fontDraw.width;column++){var index=(row*fontDraw.width+column)*4;if(pixels[index]===0){if(column===fontDraw.width-1&&start!==-1){end=row;row=fontDraw.height;break;}continue;}else{if(start===-1){start=row;}break;}}}result=end-start;this.fontAscentCache[fontStyle]=result;// put in cache
}return result;},getShortcutFontProperty:function(info){// font-style font-weight font-variant font-size/line-height font-family
var font=info.fontSize+"px "+info.fontFamily;if(info.fontStretch&&info.fontStretch!="normal")font=info.fontStretch+" "+font;if(info.fontWeight&&info.fontWeight!="normal")font=info.fontWeight+" "+font;if(info.fontStyle&&info.fontStyle!="normal")font=info.fontStyle+" "+font;return font;},getTextExtraSpace:function(info){return info.letterSpacing!=undefined?info.letterSpacing*0.75:0;},isLetterSpacingSpecified:function(info){return info.letterSpacing!=undefined&&info.letterSpacing!=0;},getLineExtraSpace:function(info){return info.lineSpacing!=undefined?info.lineSpacing*0.75:0;},isLineSpacingSpecified:function(info){return info.lineSpacing!=undefined&&info.lineSpacing!=0;},// -----------------------------------------------------------------
// -----------------------------------------------------------------
// Conversioni tra i vari tipi di elementi di testo
// (alcuni di questi metodi hanno mantenuto il vecchio nome che prevedeva solo
//  text e textOnPath, ma il funzionamento è stato allargato anche a textArea.
// I metodi nuovi sono tutti stati introdotti per i tre tipi: text, textOnPath e textArea.
// -----------------------------------------------------------------
toggleSelectionTextOnPath:function(){var newItems=[];var items=this.getSelectedTextItems();for(var i=0;i<items.length;i++){var newItem=this.toggleItemTextOnPath(items[i]);if(newItem)newItems.push(newItem);}return newItems;},convertSelectedTextItemsToTextOnPath:function(){return this.convertSelectionToTextOnPath();},convertSelectedTextOnPathItemsToText:function(){return this.convertSelectionToText();},convertSelectionToText:function(){var newItems=[];var items=this.getSelectedTextItems();for(var i=0;i<items.length;i++){var newItem=this.convertToText(items[i]);if(newItem)newItems.push(newItem);}return newItems;},convertSelectionToTextOnPath:function(){var newItems=[];var items=this.getSelectedTextItems();for(var i=0;i<items.length;i++){var newItem=this.convertToTextOnPath(items[i]);if(newItem){newItem.data.isTemplateElement=items[i].data&&items[i].data.isTemplateElement;newItems.push(newItem);}}return newItems;},convertSelectionToTextArea:function(){var newItems=[];var items=this.getSelectedTextItems();for(var i=0;i<items.length;i++){var newItem=this.convertToTextArea(items[i]);if(newItem)newItems.push(newItem);}return newItems;},// text -> textOnPath -> textArea
toggleItemTextOnPath:function(item){if(!item)return null;if(item instanceof this.paper.TextItem||item&&item.data&&item.data.isTextArea)return this.convertToTextOnPath(item);else if(item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0)return this.convertToTextArea(item);else return this.convertToText(item);},convertToTextOnPath:function(item){if(!this.canChangeItemTextPathMode(item)||item.data&&item.data.isTextOnPath)return null;if(item&&item instanceof this.paper.TextItem)return this.fromTextToTextOnPath(item);else if(item&&item.data&&item.data.isTextArea&&item.data.rect)return this.fromTextAreaToTextOnPath(item);},convertToText:function(item){if(!this.getItemIsTextArea(item)&&!this.canChangeItemTextPathMode(item)||this.getItemIsTextArea(item)&&!this.canChangeItemTextAreaMode(item)||item instanceof this.paper.TextItem)return null;if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0)return this.fromTextOnPathToText(item);else if(item&&item.data&&item.data.isTextArea&&item.data.rect)return this.fromTextAreaToText(item);},convertToTextArea:function(item){if(!this.canChangeItemTextAreaMode(item)||item.data&&item.data.isTextArea)return null;if(item&&item instanceof this.paper.TextItem)return this.fromTextToTextArea(item);else if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0)return this.fromTextOnPathToTextArea(item);},fromTextToTextOnPath:function(item){if(!this.canChangeItemTextPathMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}item.remove();this.onItemRemoved(item);var shadowColor=null;if(item.shadowColor)shadowColor=typeof item.shadowColor==='string'||item.shadowColor instanceof String?item.shadowColor:item.shadowColor.toCSS(true);var info={};info.text=item.content;info.strokeColor=item.strokeColor;info.strokeWidth=item.strokeWidth;info.fillColor=item.fillColor;info.fontFamily=item.fontFamily;info.fontWeight=item.fontWeight;info.fontSize=item.fontSize;info.scaling=item.scaling;info.rotation=item.rotation;info.shadowColor=shadowColor;info.shadowBlur=item.shadowBlur;info.shadowDistance=this.getOffsetDistance(item.shadowOffset);info.shadowAngle=this.getOffsetAngle(item.shadowOffset);if(item.data){if(item.data.hasOwnProperty("originalStrokeColor"))info.strokeColor=item.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))info.fillColor=item.data.originalFillColor;if(item.data.hasOwnProperty("originalShadowColor"))info.shadowColor=item.data.originalShadowColor;}newItem=this.addTextOnPathElement(item.position,info,true);var deltaPosition=newItem.position.clone();newItem.position.y=item.bounds.top+newItem.bounds.height/2;deltaPosition.x=0-deltaPosition.x+newItem.position.x;deltaPosition.y=0-deltaPosition.y+newItem.position.y;this.onTextOnPathMoved(newItem,deltaPosition);this.updateTextOnPathGuide(newItem);if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem)newDesignItem.setConstraintsFromSource(constraints);}this.onItemUpdated(newItem);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},fromTextToTextArea:function(item){if(!this.canChangeItemTextAreaMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item instanceof this.paper.TextItem){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}var rect=item.bounds.clone();rect.bottom=rect.bottom;rect.bottom+=rect.height*5;item.remove();this.onItemRemoved(item);var shadowColor=null;if(item.shadowColor)shadowColor=typeof item.shadowColor==='string'||item.shadowColor instanceof String?item.shadowColor:item.shadowColor.toCSS(true);var info={};info.text=item.content;info.strokeWidth=item.strokeWidth;info.strokeColor=typeof item.strokeColor==='string'||item.strokeColor instanceof String?item.strokeColor:item.strokeColor.toCSS(true);info.fillColor=typeof item.fillColor==='string'||item.fillColor instanceof String?item.fillColor:item.fillColor.toCSS(true);info.fontFamily=item.fontFamily;info.fontWeight=item.fontWeight;info.fontSize=item.fontSize;info.scaling=item.scaling;info.rotation=item.rotation;info.justification=item.data&&item.data.justification?item.data.justification:item.justification!==undefined?item.justification:"justify";info.shadowColor=shadowColor;info.shadowBlur=item.shadowBlur;info.shadowDistance=this.getOffsetDistance(item.shadowOffset);info.shadowAngle=this.getOffsetAngle(item.shadowOffset);info.lineSpacing=item.lineSpacing;info.letterSpacing=item.letterSpacing;if(item.data){if(item.data.hasOwnProperty("originalStrokeColor"))info.strokeColor=item.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))info.fillColor=item.data.originalFillColor;if(item.data.hasOwnProperty("originalShadowColor"))info.shadowColor=item.data.originalShadowColor;}rect.left=item.bounds.left;rect.right=item.bounds.right;rect.top=item.bounds.top;newItem=this.addTextAreaElement(rect,info,true);newItem.position.y=rect.top+newItem.bounds.height/2;newItem.position.x=rect.left+item.bounds.width/2;newItem.data.rect=newItem.bounds.clone();this.updateTextAreaGuide(newItem);if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem)newDesignItem.setConstraintsFromSource(constraints);}this.onItemUpdated(newItem);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},fromTextOnPathToText:function(item){if(!this.canChangeItemTextPathMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}item.remove();this.onItemRemoved(item);var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){str+=item.children[i].content;}}var shadowColor=null;var itemShadowColor=item.children[0].shadowColor;if(itemShadowColor)shadowColor=typeof itemShadowColor==='string'||itemShadowColor instanceof String?itemShadowColor:itemShadowColor.toCSS(true);var info={};info.text=str;info.strokeColor=item.children[0].strokeColor;info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor;info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontStretch=item.children[0].fontStretch;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.shadowColor=shadowColor;info.shadowBlur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);if(item.data){if(item.data.hasOwnProperty("originalStrokeColor"))info.strokeColor=item.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))info.fillColor=item.data.originalFillColor;if(item.data.hasOwnProperty("originalShadowColor"))info.shadowColor=item.data.originalShadowColor;}var a=item.data.points[0];var b=item.data.points[1];var c=item.data.points[2];var v=c.subtract(a);var point=a.add(v.divide(2));info.rotation=v.angle;newItem=this.addTextElement(point,info,true);if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem){newDesignItem.setConstraintsFromSource(constraints);this.updateSelectionState();this.paper.project.view.update();}}this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},fromTextOnPathToTextArea:function(item){if(!this.canChangeItemTextAreaMode(item)||!this.canChangeItemTextPathMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}var rect=item.bounds.clone();rect.bottom=rect.bottom;rect.bottom+=rect.height*5;item.remove();this.onItemRemoved(item);var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){str+=item.children[i].content;}}var shadowColor=null;var itemShadowColor=item.children[0].shadowColor;if(itemShadowColor)shadowColor=typeof itemShadowColor==='string'||itemShadowColor instanceof String?itemShadowColor:itemShadowColor.toCSS(true);var info={};info.text=str;info.strokeColor=item.children[0].strokeColor;info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor;info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontStretch=item.children[0].fontStretch;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.justification=item.data&&item.data.justification?item.data.justification:"justify";info.shadowColor=shadowColor;info.shadowBlur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);var originalStrokeColor=null;var originalFillColor=null;var hasOriginalShadowColor=false;var originalShadowColor=null;if(item.data){if(item.data.hasOwnProperty("originalStrokeColor")){info.strokeColor=item.data.originalStrokeColor;originalStrokeColor=item.data.originalStrokeColor;}if(item.data.hasOwnProperty("originalFillColor")){info.fillColor=item.data.originalFillColor;originalFillColor=item.data.originalFillColor;}if(item.data.hasOwnProperty("originalShadowColor")){hasOriginalShadowColor=true;info.shadowColor=item.data.originalShadowColor;originalShadowColor=item.data.originalShadowColor;}}rect.left=item.bounds.left;rect.right=item.bounds.right;rect.top=item.bounds.top;newItem=this.addTextAreaElement(rect,info,true);if(originalStrokeColor)newItem.data.originalStrokeColor=originalStrokeColor;if(originalFillColor)newItem.data.originalFillColor=originalFillColor;if(hasOriginalShadowColor)newItem.data.originalShadowColor=originalShadowColor;newItem.position.y=rect.top+newItem.bounds.height/2;newItem.position.x=rect.left+item.bounds.width/2;newItem.data.rect=newItem.bounds.clone();newItem.data.isTemplateElement=item.data&&item.data.isTemplateElement;this.updateTextAreaGuide(newItem);if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem)newDesignItem.setConstraintsFromSource(constraints);}this.onItemUpdated(newItem);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},fromTextAreaToText:function(item){if(!this.canChangeItemTextAreaMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item.data&&item.data.isTextArea&&item.data.rect){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}item.remove();this.onItemRemoved(item);var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){if(i>0)str+=" ";str+=item.children[i].content;}}var shadowColor=null;var itemShadowColor=item.children[0].shadowColor;if(itemShadowColor)shadowColor=typeof itemShadowColor==='string'||itemShadowColor instanceof String?itemShadowColor:itemShadowColor.toCSS(true);var info={};info.text=str;info.strokeColor=item.children[0].strokeColor;info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor;info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontStretch=item.children[0].fontStretch;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.shadowColor=shadowColor;info.shadowBlur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);var originalStrokeColor=null;var originalFillColor=null;var hasOriginalShadowColor=false;var originalShadowColor=null;if(item.data){if(item.data.hasOwnProperty("originalStrokeColor")){info.strokeColor=item.data.originalStrokeColor;originalStrokeColor=item.data.originalStrokeColor;}if(item.data.hasOwnProperty("originalFillColor")){info.fillColor=item.data.originalFillColor;originalFillColor=item.data.originalFillColor;}if(item.data.hasOwnProperty("originalShadowColor")){hasOriginalShadowColor=true;info.shadowColor=item.data.originalShadowColor;originalShadowColor=item.data.originalShadowColor;}}var point=item.children[0].point;newItem=this.addTextElement(point,info,true);if(originalStrokeColor)newItem.data.strokeColor=originalStrokeColor;if(originalFillColor)newItem.data.fillColor=originalFillColor;if(hasOriginalShadowColor)newItem.data.originalShadowColor=originalShadowColor;if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem){newDesignItem.setConstraintsFromSource(constraints);this.updateSelectionState();this.paper.project.view.update();}}this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},fromTextAreaToTextOnPath:function(item){if(!this.canChangeItemTextPathMode(item)||!this.canChangeItemTextAreaMode(item))return null;var newItem=null;this.beginDesignOperation();if(item&&item.data&&item.data.isTextArea&&item.data.rect){var designItem=this.findDesignItemForItem(item);var constraints=null;var syncGuid=null;if(designItem){constraints=designItem.get("constraints");syncGuid=designItem.get("syncGuid");}item.remove();this.onItemRemoved(item);var str=item.data.text;if(!str){for(var i=0;i<item.children.length;i++){if(i>0)str+=" ";str+=item.children[i].content;}}var shadowColor=null;var itemShadowColor=item.children[0].shadowColor;if(itemShadowColor)shadowColor=typeof itemShadowColor==='string'||itemShadowColor instanceof String?itemShadowColor:itemShadowColor.toCSS(true);var info={};info.text=str;info.strokeColor=item.children[0].strokeColor.toCSS(true);info.strokeWidth=item.children[0].strokeWidth;info.fillColor=item.children[0].fillColor.toCSS(true);info.fontFamily=item.children[0].fontFamily;info.fontWeight=item.children[0].fontWeight;info.fontStretch=item.children[0].fontStretch;info.fontSize=item.children[0].fontSize;info.scaling=item.children[0].scaling;info.shadowColor=shadowColor;info.shadowBlur=item.children[0].shadowBlur;info.shadowDistance=this.getOffsetDistance(item.children[0].shadowOffset);info.shadowAngle=this.getOffsetAngle(item.children[0].shadowOffset);var originalStrokeColor=null;var originalFillColor=null;var hasOriginalShadowColor=false;var originalShadowColor=null;if(item.data){if(item.data.hasOwnProperty("originalStrokeColor")){info.strokeColor=item.data.originalStrokeColor;originalStrokeColor=item.data.originalStrokeColor;}if(item.data.hasOwnProperty("originalFillColor")){info.fillColor=item.data.originalFillColor;originalFillColor=item.data.originalFillColor;}if(item.data.hasOwnProperty("originalShadowColor")){hasOriginalShadowColor=true;info.shadowColor=item.data.originalShadowColor;originalShadowColor=item.data.originalShadowColor;}}var oldBounds=this.getItemRealBounds(item);var point=new this.paper.Point(oldBounds.x+oldBounds.width/2,item.children[0].point.y);newItem=this.addTextOnPathElement(point,info,true);if(originalStrokeColor)newItem.data.originalStrokeColor=originalStrokeColor;if(originalFillColor)newItem.data.originalFillColor=originalFillColor;if(hasOriginalShadowColor)newItem.data.originalShadowColor=originalShadowColor;if(item.data&&item.data.justification)newItem.data.justification=item.data.justification;var deltaPosition=newItem.position.clone();newItem.position.y=item.bounds.top+newItem.bounds.height/2;deltaPosition.x=0-deltaPosition.x+newItem.position.x;deltaPosition.y=0-deltaPosition.y+newItem.position.y;this.onTextOnPathMoved(newItem,deltaPosition);this.updateTextOnPathGuide(newItem);if(constraints){var newDesignItem=this.findDesignItemForItem(newItem);if(newDesignItem)newDesignItem.setConstraintsFromSource(constraints);}this.onItemUpdated(newItem);this.fireSelectionChangedEvent();this.updateSelectionState();this.paper.project.view.update();this.updateItemSyncGuid(newItem,syncGuid);}this.endDesignOperation();// Unisco le catene di join per fare in modo che la cancellazione dell'item e la creazione del nuovo
// avvenga nello stessa operazione di undo
this.mergeAllUndoItemsOperations(newItem);this.joinUndoChains(item,newItem);return newItem;},// Fine funzione di conversione fra vari tipi
// -----------------------------------------------------------------
removeSideBackColor:function(){if(this.side&&this.design){var designSide=this.design.getDesignSide(this.side);if(designSide){this.design.get("sides").remove(designSide);}//this.refresh();
var customizer=this;this.updateImageItem(function(){if(!customizer.isViewer)customizer.updateAreaItemsColor();customizer.updateSelectionState();});}},// Accetta un colore nella forma esadecimale RRGGBB
setSideBackColor:function(hexColor){if(this.side&&this.design){var designSide=this.design.getDesignSide(this.side);if(!designSide){designSide=new MPlaza.DesignSide();designSide.set("modelID",this.design.get("modelID"));designSide.set("colorID",this.side.getColorID());designSide.set("sideID",this.side.getSideID());this.design.get("sides").add(designSide);}designSide.set("fillColor",hexColor);var customizer=this;this.updateImageItem(function(){if(!customizer.isViewer)customizer.updateAreaItemsColor();customizer.updateSelectionState();});//this.refresh();
}},adjustInputFontWeightByConstraints:function(itemFontWeight,inputFontWeight,constraints){// fontWeight contiene sia bold che italic
var newFontWeight=inputFontWeight||itemFontWeight;if(constraints&&(!constraints.get("canChangeFontWeight")||!constraints.get("canChangeFontItalic"))){if(typeof itemFontWeight==="number")return itemFontWeight;else newFontWeight=newFontWeight=newFontWeight+"";var oldBold=itemFontWeight&&itemFontWeight.indexOf("bold")!=-1;var oldItalic=itemFontWeight&&itemFontWeight.indexOf("italic")!=-1;var newBold=constraints.get("canChangeFontWeight")?newFontWeight.indexOf("bold")!=-1:oldBold;var newItalic=constraints.get("canChangeFontItalic")?newFontWeight.indexOf("italic")!=-1:oldItalic;var fontWeight=[];fontWeight.push(newItalic?"italic":"normal");fontWeight.push(newBold?"bold":"normal");newFontWeight=fontWeight.join(" ");}return newFontWeight;},adjustInputTextByConstraints:function(item,text){var newText=text;if(item&&text!=undefined&&text!=null){var constraints=this.getItemConstraints(item);if(constraints&&constraints.get("canEdit")&&(constraints.get("keepNrChars")||constraints.get("minNrChars")>0||constraints.get("maxNrChars")>0)){// Ricavo il testo attuale
var currentText="";if(item.data&&item.data.isTextOnPath&&item.data.points&&Object.prototype.toString.call(item.data.points)==='[object Array]'&&item.data.points.length==3&&item.children.length>0){currentText=item.data.text;if(!currentText){for(var i=0;i<item.children.length;i++){currentText+=item.children[i].content;}}}else if(item instanceof this.paper.TextItem){currentText=item.content;}else if(item.data&&item.data.isTextArt){currentText=this.getTextArtItemText(item);}var length=currentText.length;var minLength=constraints.get("minNrChars");var maxLength=constraints.get("maxNrChars");if(constraints.get("keepNrChars")){minLength=length;maxLength=length;}if(minLength>0&&text.length<minLength){// Eseguo il padding
var paddingString=constraints.get("paddingString");if(constraints.get("paddingTypeID")==MPlaza.PaddingType.Start){newText=text.padStart(minLength,paddingString);}else if(constraints.get("paddingTypeID")==MPlaza.PaddingType.End){newText=text.padEnd(minLength,paddingString);}else if(constraints.get("paddingTypeID")==MPlaza.PaddingType.StartEnd){newText=text.padStartEnd(minLength,paddingString);}}/*
                if (maxLength > 0 && text.length > maxLength) {
                    newText = text.substring(0, maxLength);
                }
 
                if (text.length == 0 && constraints.get("canDelete") == false) {
                    newText = currentText.substring(0, 1);
                }
                */if(maxLength>0&&newText.length>maxLength){newText=newText.substring(0,maxLength);}if(newText.length==0&&constraints.get("canDelete")==false){newText=this.isConfigurator?'⠀':currentText.substring(0,1);}//if (length <= text.length) {
//    newText = text.substring(0, length);
//} else {
//    // Eseguo il padding
//    var paddingString = constraints.get("paddingString");
//    if (constraints.get("paddingTypeID") == MPlaza.PaddingType.Start) {
//        newText = text.padStart(length, paddingString);
//    } else if (constraints.get("paddingTypeID") == MPlaza.PaddingType.End) {
//        newText = text.padEnd(length, paddingString);
//    } else if (constraints.get("paddingTypeID") == MPlaza.PaddingType.StartEnd) {
//        newText = text.padStartEnd(length, paddingString);
//    }
//}
}}// In the configurator we need a empty text area
// If we return an empty string, the updateTextArea
// will keep the last character again.
// So we need to return an empty char
// In the customizer this will not happen because
// The item is deleted if text is empty in the application.ts
if(this.isConfigurator&&newText=="")newText='⠀';return newText;},adjustInputLetterSpacingByConstraints:function(item,letterSpacing){var newLetterSpacing=letterSpacing;if(item){var oldLetterSpacing=item.data.letterSpacing!=undefined?item.data.letterSpacing:0;if(newLetterSpacing==undefined)newLetterSpacing=oldLetterSpacing;var constraints=this.getItemConstraints(item);if(constraints){if(!constraints.get("canEdit")||!constraints.get("canChangeLetterSpacing")||typeof letterSpacing!='number')newLetterSpacing=oldLetterSpacing;else{if(constraints.get("minLetterSpacing")!=undefined&&constraints.get("minLetterSpacing")!=null){newLetterSpacing=Math.max(newLetterSpacing,constraints.get("minLetterSpacing"));}if(constraints.get("maxLetterSpacing")!=undefined&&constraints.get("maxLetterSpacing")!=null){newLetterSpacing=Math.min(newLetterSpacing,constraints.get("maxLetterSpacing"));}}}}return newLetterSpacing;},adjustInputLineSpacingByConstraints:function(item,lineSpacing){var newLineSpacing=lineSpacing;if(item){var oldLineSpacing=item.data.lineSpacing!=undefined?item.data.lineSpacing:0;if(newLineSpacing==undefined)newLineSpacing=oldLineSpacing;var constraints=this.getItemConstraints(item);if(constraints){if(!constraints.get("canEdit")||!constraints.get("canChangeLineSpacing")||typeof lineSpacing!='number')newLineSpacing=oldLineSpacing;else{if(constraints.get("minLineSpacing")!=undefined&&constraints.get("minLineSpacing")!=null){newLineSpacing=Math.max(newLineSpacing,constraints.get("minLineSpacing"));}if(constraints.get("maxLineSpacing")!=undefined&&constraints.get("maxLineSpacing")!=null){newLineSpacing=Math.min(newLineSpacing,constraints.get("maxLineSpacing"));}}}}return newLineSpacing;},highlightsCanvasItemFromDesignItems:function(designItems){var that=this;designItems.forEach(function(x){var item=that.findItemByGuid(x.get('itemGuid'));if(item){that.createMaskAlertForItem(item);}});},// -------------------------------------------------------
// UNDO - REDO
// -------------------------------------------------------
undoRedoSupported:function(){var countGrids=this.getAllGridItems();return countGrids.length==0;},beginDesignOperation:function(){if(this.undoRedoSupported()){if(this.currentDesignOperation&&this.currentDesignOperation.itemOperations.length>0)this.undoStack.push(this.currentDesignOperation);this.currentDesignOperation={operationId:MPlaza.generateUUID(),itemOperations:[]};}},endDesignOperation:function(){if(this.undoRedoSupported()){if(this.currentDesignOperation&&this.currentDesignOperation.itemOperations.length>0){this.undoStack.push(this.currentDesignOperation);this.resetRedo();this.currentDesignOperation=null;}}},registerItemOperation:function(type,itemGuid,oldDesignItem,newDesignItem){if(!this.undoRedoSupported())return;if(this.executingUndoRedo)return;if(oldDesignItem&&newDesignItem){var colorsChanged_1=false;if(oldDesignItem.get('colors').length!=newDesignItem.get('colors').length)colorsChanged_1=true;newDesignItem.get('colors').each(function(color,index){var newColor=oldDesignItem.get('colors').find(function(c){return c.get('colorID')==color.get('colorID');});if(newColor){if(newColor.get('colorCode')!=color.get('colorCode'))colorsChanged_1=true;}else{colorsChanged_1=true;}});var indexChanged=oldDesignItem.get('index')!=newDesignItem.get('index');if(oldDesignItem.get("json")==newDesignItem.get("json")&&!colorsChanged_1&&!indexChanged)return;}var newItemOperation={itemGuid:itemGuid,type:type,oldDesignItem:oldDesignItem,newDesignItem:newDesignItem};var created=false;if(!this.currentDesignOperation){this.beginDesignOperation();created=true;}this.updateDesignOperation(this.currentDesignOperation,newItemOperation);if(created)this.endDesignOperation();},updateDesignOperation:function(designOperation,itemOperation){var existingOperation=null;var idx=-1;for(var i=0;i<designOperation.itemOperations.length;i++){var op=designOperation.itemOperations[i];if(op.itemGuid==itemOperation.itemGuid){idx=i;existingOperation=op;break;}}if(existingOperation&&idx>=0){var merged=this.mergeItemOperations(existingOperation,itemOperation);if(!merged)designOperation.itemOperations[idx]=itemOperation;else designOperation.itemOperations[idx]=merged;}else{designOperation.itemOperations.push(itemOperation);}},mergeItemOperations:function(existingOperation,itemOperation){var newItemOperation=null;if(existingOperation.type==="create"){if(itemOperation.type==="update"){newItemOperation={type:"create",itemGuid:existingOperation.itemGuid,oldDesignItem:null,newDesignItem:itemOperation.newDesignItem};}}else if(existingOperation.type==="update"){if(itemOperation.type==="update"){newItemOperation={type:"update",itemGuid:existingOperation.itemGuid,oldDesignItem:existingOperation.oldDesignItem,newDesignItem:itemOperation.newDesignItem};}}return newItemOperation;},undo:function(){return __awaiter(this,void 0,void 0,function(){var designOperation,i,itemOperation;return __generator(this,function(_a){switch(_a.label){case 0:if(!(this.undoStack.count()>0))return[3/*break*/,7];this.executingUndoRedo=true;_a.label=1;case 1:_a.trys.push([1,,6,7]);designOperation=this.undoStack.pop();i=0;_a.label=2;case 2:if(!(i<designOperation.itemOperations.length))return[3/*break*/,5];itemOperation=designOperation.itemOperations[i];return[4/*yield*/,this.undoItemOperation(itemOperation)];case 3:_a.sent();_a.label=4;case 4:i++;return[3/*break*/,2];case 5:this.redoStack.push(designOperation);return[3/*break*/,7];case 6:this.executingUndoRedo=false;return[7/*endfinally*/];case 7:return[2/*return*/];}});});},redo:function(){return __awaiter(this,void 0,void 0,function(){var designOperation,i,itemOperation;return __generator(this,function(_a){switch(_a.label){case 0:if(!(this.redoStack.count()>0))return[3/*break*/,7];this.executingUndoRedo=true;_a.label=1;case 1:_a.trys.push([1,,6,7]);designOperation=this.redoStack.pop();i=0;_a.label=2;case 2:if(!(i<designOperation.itemOperations.length))return[3/*break*/,5];itemOperation=designOperation.itemOperations[i];return[4/*yield*/,this.redoItemOperation(itemOperation)];case 3:_a.sent();_a.label=4;case 4:i++;return[3/*break*/,2];case 5:this.undoStack.push(designOperation);return[3/*break*/,7];case 6:this.executingUndoRedo=false;return[7/*endfinally*/];case 7:return[2/*return*/];}});});},undoItemOperation:function(itemOperation){return __awaiter(this,void 0,void 0,function(){var selectedGuids,newItem,item,designItem,newDesignItem;return __generator(this,function(_a){switch(_a.label){case 0:selectedGuids=this.getSelectedItems().map(function(i){return i.data.guid;});newItem=null;if(!(itemOperation.type=="create"))return[3/*break*/,1];item=this.findItemByGuid(itemOperation.itemGuid);if(item){item.remove();this._onItemRemovedInternal(item);}return[3/*break*/,6];case 1:if(!(itemOperation.type==="update"))return[3/*break*/,4];designItem=this.findDesignItemByGuid(itemOperation.itemGuid);if(!designItem)return[3/*break*/,3];designItem.copyAttributes(itemOperation.oldDesignItem);designItem.set('colors',itemOperation.oldDesignItem.get('colors').clone());return[4/*yield*/,this.createItemForDesignItem(designItem)];case 2:newItem=_a.sent();_a.label=3;case 3:return[3/*break*/,6];case 4:if(!(itemOperation.type==="delete"))return[3/*break*/,6];newDesignItem=itemOperation.oldDesignItem.clone();this.design.get("designItems").add(newDesignItem);return[4/*yield*/,this.createItemForDesignItem(newDesignItem)];case 5://newItem = await new Promise<any>(resolve => this.createItemForDesignItem(newDesignItem, resolve));
newItem=_a.sent();_a.label=6;case 6:// Reorder items by index
this.updateItemsIndexes();if(newItem&&this.isItemSelected(newItem)){this.selectItems([newItem]);}this.paper.project.view.update();return[2/*return*/];}});});},redoItemOperation:function(itemOperation){return __awaiter(this,void 0,void 0,function(){var newItem,newDesignItem,designItem,item;return __generator(this,function(_a){switch(_a.label){case 0:newItem=null;if(!(itemOperation.type=="create"))return[3/*break*/,2];newDesignItem=itemOperation.newDesignItem.clone();this.design.get("designItems").add(newDesignItem);return[4/*yield*/,this.createItemForDesignItem(newDesignItem)];case 1://newItem = await new Promise(resolve => this.createItemForDesignItem(newDesignItem, resolve));
newItem=_a.sent();return[3/*break*/,6];case 2:if(!(itemOperation.type==="update"))return[3/*break*/,5];designItem=this.findDesignItemByGuid(itemOperation.itemGuid);if(!designItem)return[3/*break*/,4];designItem.copyAttributes(itemOperation.newDesignItem);designItem.set('colors',itemOperation.newDesignItem.get('colors').clone());return[4/*yield*/,this.createItemForDesignItem(designItem)];case 3://newItem = await new Promise(resolve => this.createItemForDesignItem(designItem, resolve));
newItem=_a.sent();_a.label=4;case 4:return[3/*break*/,6];case 5:if(itemOperation.type==="delete"){item=this.findItemByGuid(itemOperation.itemGuid);if(item){item.remove();this._onItemRemovedInternal(item);}}_a.label=6;case 6:// Reorder items by index
this.updateItemsIndexes();if(newItem&&this.isItemSelected(newItem))this.selectItems([newItem]);this.paper.project.view.update();return[2/*return*/];}});});},hasUndo:function(){return this.undoRedoSupported()&&this.undoStack.count()>0;},hasRedo:function(){return this.undoRedoSupported()&&this.redoStack.count()>0;},resetUndoRedo:function(){this.detachUndoRedoEvents();this.undoStack.clear();this.redoStack.clear();this.attachUndoRedoEvents();this.fireUndoChangedEvent();this.fireRedoChangedEvent();},resetUndo:function(){this.detachUndoRedoEvents();this.undoStack.clear();this.attachUndoRedoEvents();this.fireUndoChangedEvent();},resetRedo:function(){this.detachUndoRedoEvents();this.redoStack.clear();this.attachUndoRedoEvents();this.fireRedoChangedEvent();},removeLastUndoItemOperation:function(){if(this.undoStack.count()>0)return this.undoStack.pop();},removeFirstRedoItemOperation:function(){if(this.redoStack.count()>0)return this.redoStack.pop();},setupUndoRedoStacks:function(){this.attachUndoRedoEvents();},attachUndoRedoEvents:function(){this.undoStack.addChangedEventListener(this.bindedUndoStackChanged);this.redoStack.addChangedEventListener(this.bindedRedoStackChanged);},detachUndoRedoEvents:function(){this.undoStack.removeChangedEventListener(this.bindedUndoStackChanged);this.redoStack.removeChangedEventListener(this.bindedRedoStackChanged);},onUndoStackChanged:function(){this.fireUndoChangedEvent();},onRedoStackChanged:function(){this.fireRedoChangedEvent();},getUndoCount:function(){return this.undoStack.count();},getRedoCount:function(){return this.redoStack.count();},clearUndoForItem:function(item){this.clearOperationsStackForItem(this.undoStack,item);},clearRedoForItem:function(item){this.clearOperationsStackForItem(this.redoStack,item);},clearOperationsStackForItem:function(stack,item){if(stack&&item){var allDesignOperations=stack.getAllData();var operationsToRemove=[];for(var i=0;i<allDesignOperations.length;i++){var designOperation=allDesignOperations[i];for(var j=0;j<designOperation.itemOperations.length;j++){var itemOperation=designOperation.itemOperations[j];if(itemOperation.itemGuid===item.data.guid){designOperation.itemOperations.splice(j--,1);}}if(designOperation.itemOperations.length==0)operationsToRemove.push(designOperation);}if(operationsToRemove.length>0)stack.removeDataArray(operationsToRemove);}},// Fonde tutte gli itemOperation in undo relativi all'item passato in un'unica operazione
mergeAllUndoItemsOperations:function(item){if(item){var getItemOperation=function(designOperation,item){for(var i=0;i<designOperation.itemOperations.length;i++){if(designOperation.itemOperations[i].itemGuid==item.data.guid)return designOperation.itemOperations[i];}return null;};var removeItemOperation=function(designOperation,item){for(var i=0;i<designOperation.itemOperations.length;i++){if(designOperation.itemOperations[i].itemGuid===item.data.guid)designOperation.itemOperations.splice(i--,1);}};var allDesignOperations=this.undoStack.getAllData();var operationsToRemove=[];var lastDesignOperation=null;var lastItemOperation=null;// schiaccio ogni itemOperation con la precedente
for(var i=allDesignOperations.length-1;i>=0;i--){var designOperation=allDesignOperations[i];var itemOperation=getItemOperation(designOperation,item);if(itemOperation){if(lastDesignOperation&&lastItemOperation){this.updateDesignOperation(designOperation,lastItemOperation);removeItemOperation(lastDesignOperation,item);if(lastDesignOperation.itemOperations.length==0)operationsToRemove.push(lastDesignOperation);}lastDesignOperation=designOperation;lastItemOperation=itemOperation;}}if(operationsToRemove.length>0)this.undoStack.removeDataArray(operationsToRemove);}},// La prima operazione relativa ad item2 viene inserita nell'ultima operazione relativa ad item1
// in modo che l'operazione di undo esegua contemporaneamente le due operazioni
joinUndoChains:function(item1,item2){var containsItemOperation=function(designOperation,item){for(var i=0;i<designOperation.itemOperations.length;i++){if(designOperation.itemOperations[i].itemGuid===item.data.guid)return true;}return false;};var getItemOperation=function(designOperation,item){for(var i=0;i<designOperation.itemOperations.length;i++){if(designOperation.itemOperations[i].itemGuid==item.data.guid)return designOperation.itemOperations[i];}return null;};var removeItemOperation=function(designOperation,item){for(var i=0;i<designOperation.itemOperations.length;i++){if(designOperation.itemOperations[i].itemGuid===item.data.guid)designOperation.itemOperations.splice(i--,1);}};var allDesignOperations=this.undoStack.getAllData();var designOperationItem1=null;var designOperationItem2=null;for(var i=0;i<allDesignOperations.length;i++){var designOperation=allDesignOperations[i];if(containsItemOperation(designOperation,item1))designOperationItem1=designOperation;if(containsItemOperation(designOperation,item2)&&!designOperationItem2)designOperationItem2=designOperation;}if(designOperationItem1&&designOperationItem2&&designOperationItem1!==designOperationItem2){// porto la prima operazione di item2 insieme all'ultima di item1
var item2Operation=getItemOperation(designOperationItem2,item2);this.updateDesignOperation(designOperationItem1,item2Operation);removeItemOperation(designOperationItem2,item2);if(designOperationItem2.itemOperations.length==0)this.undoStack.removeData(designOperationItem2);}},getLastUndoOperationId:function(){var designOperation=this.undoStack.getLastData();if(designOperation)return designOperation.operationId;return null;},mergeAllUndoOperationsAfterId:function(operationId){var designOperations=null;if(operationId){var designOperation=this.undoStack.getLastData(function(data){return data.operationId===operationId;});designOperations=this.undoStack.getAllDataAfter(designOperation);}else{designOperations=this.undoStack.getAllData();}if(designOperations){this.mergeUndoDesignOperations(designOperations);}},mergeUndoDesignOperations:function(designOperations){var operationsToRemove=[];if(designOperations.length>1){var firstDesignOperation=designOperations[0];for(var i=1;i<designOperations.length;i++){var designOperation=designOperations[i];for(var j=0;j<designOperation.itemOperations.length;j++){var itemOperation=designOperation.itemOperations[j];this.updateDesignOperation(firstDesignOperation,itemOperation);designOperation.itemOperations.splice(j--,1);}operationsToRemove.push(designOperation);}}if(operationsToRemove.length>0)this.undoStack.removeDataArray(operationsToRemove);},// -------------------------------------------------------
// Fine UNDO - REDO
// -------------------------------------------------------
// -------------------------------------------------------
// Image recoloring
// -------------------------------------------------------
// Returns all the colors used in the design for the selected side. For text items and shape items it takes StrokeColor and FillColor.
// For image items it takes the ColorMappings array, if it exists.
getUsedColorsWithCount:function(){var colors=new Map();// Used when changing print type, we don't have to check the current colors because they are problably wrong.
if(this.ignoreUsedColorsOnColorCheck)return colors;var items=this.usedColorsItemsToCheck||this.getAllItems();for(var i=0;i<items.length;i++){var item=items[i];var designItem=this.findDesignItemForItem(item);if(designItem&&designItem.get("colorMappings")&&designItem.get("colorMappings").length>0){var colorMappings=designItem.get("colorMappings").toJSON();// Group by colors to avoid multiple count for same element
colorMappings.filter(function(x){return Boolean(x.dest);}).reduce(function(arr,val){return arr.add(val.dest);},new Set()).forEach(function(color){return colors.set(color,colors.has(color)?colors.get(color)+1:1);});}if(this.getItemIsTextElement(item)){var info=this.getTextItemInfo(item);if(info.strokeColor&&info.strokeWidth>0)colors.set(info.strokeColor,colors.has(info.strokeColor)?colors.get(info.strokeColor)+1:1);if(info.fillColor)colors.set(info.fillColor,colors.has(info.fillColor)?colors.get(info.fillColor)+1:1);if(info.shadowColor)colors.set(info.shadowColor,colors.has(info.shadowColor)?colors.get(info.shadowColor)+1:1);}if(this.getItemIsTextArt(item)){var info=this.getTextArtItemInfo(item);if(info.style.strokeColor&&info.style.strokeWidth>0)colors.set(info.style.strokeColor,colors.has(info.style.strokeColor)?colors.get(info.style.strokeColor)+1:1);if(info.style.fillColor)colors.set(info.style.fillColor,colors.has(info.style.fillColor)?colors.get(info.style.fillColor)+1:1);if(info.style.shadowColor)colors.set(info.style.shadowColor,colors.has(info.style.shadowColor)?colors.get(info.style.shadowColor)+1:1);}if(this.isShape(item)||this.isMaskedImage(item)){var shapeStyle=this.getShapeItemStyle(item);if(shapeStyle){if(shapeStyle.strokeColor&&shapeStyle.strokeWidth>0)colors.set(shapeStyle.strokeColor,colors.has(shapeStyle.strokeColor)?colors.get(shapeStyle.strokeColor)+1:1);if(shapeStyle.fillColor)colors.set(shapeStyle.fillColor,colors.has(shapeStyle.fillColor)?colors.get(shapeStyle.fillColor)+1:1);}}if(item.data.isGroupForBackground){var area=item.children.find(function(x){return x.data.isAreaForBackground;});if(area){if(area.strokeColor&&area.strokeWidth>0){var color=area.strokeColor instanceof paper.Color?area.strokeColor.toCSS(true):area.strokeColor;colors.set(color,colors.has(color)?colors.get(color)+1:1);}if(area.fillColor){var color=area.fillColor instanceof paper.Color?area.fillColor.toCSS(true):area.fillColor;colors.set(color,colors.has(color)?colors.get(color)+1:1);}}}// For svg use the colors if no color mapping is specified
if(designItem&&designItem.get('colors').length>0&&(!designItem.get("colorMappings")||designItem.get("colorMappings").length==0)){designItem.get('colors').forEach(function(color){var code=color.get('colorCode');colors.set(code,colors.has(code)?colors.get(code)+1:1);});}}return colors;},getUsedColors:function(){return Array.from(this.getUsedColorsWithCount().keys());},// Il metodo restituisce un oggetto del tipo {maxColors, palette} ottenuti in base al tipo di stampa selezionato
_getPrintTypeColorLimits:function(item){var result={maxColors:undefined,palette:[]};if(!this.side||!this.design)return result;var designItem=this.findDesignItemForItem(item);var selectedPrintType=null;var area=null;if(designItem&&designItem instanceof MPlaza.DesignItem&&designItem.get("areas").length>0){var designItemArea=designItem.get("areas").at(0);area=this.side.findAreaByID(designItemArea.get("areaID"));}else{area=this.side.get("areas").getMaxArea();}if(area)selectedPrintType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(area));if(!selectedPrintType)return result;var predefinedPalette=selectedPrintType.get("paletteColors");var maxColors=undefined;if(selectedPrintType.get("maxColors")!=undefined&&selectedPrintType.get("maxColors")!=null&&selectedPrintType.get("maxColors")>0)maxColors=selectedPrintType.get("maxColors");if(predefinedPalette&&predefinedPalette.length>0){if(maxColors)maxColors=Math.min(maxColors,predefinedPalette.length);else maxColors=predefinedPalette.length;}if(!maxColors)return result;result.maxColors=maxColors;result.palette=predefinedPalette||[];return result;},// Restituisce i possibili colori selezionabili per testo/immagini. Nel caso di risultato undefined, tutti i colori sono selezionabili.
// Nel caso in cui l'item sia definito, considera come tipo di stampa quello relativo alla prima area a cui l'item è collegato.
// Nel caso in cui l'item non sia definito, considera come tipo di stampa quello legato all'area più grande.
getSelectableColors:function(item){if(!this.side||!this.design)return undefined;var printTypeLimits=this._getPrintTypeColorLimits(item);if(printTypeLimits.maxColors===undefined||printTypeLimits.maxColor===null)return undefined;var maxColors=printTypeLimits.maxColors;var predefinedPalette=printTypeLimits.palette;var usedColors=this.getUsedColors();if(usedColors.length<maxColors)return predefinedPalette.length>0?predefinedPalette:undefined;return usedColors;},// Restituisce il mapping proposto per una immagine. Il risultato sarà un ColorMapping[].
// Come palette sorgente verrà usatat imagePalette, se definita, oppure verrà ricavata direttamente dall'immagine.
// Ogni ColorMapping è del tipo {src: #......, dest: #......}
getImageDefaultColorMappings:function(url,item,imagePalette){return __awaiter(this,void 0,void 0,function(){var printTypeLimits,maxColors,predefinedPalette,usedColors,colorMappings,_loop_4,i;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.side||!this.design)return[2/*return*/,[]];printTypeLimits=this._getPrintTypeColorLimits(item);maxColors=printTypeLimits.maxColors;predefinedPalette=printTypeLimits.palette;if(maxColors==undefined||maxColors==null)return[2/*return*/,[]];usedColors=this.getUsedColors();if(!!imagePalette)return[3/*break*/,2];return[4/*yield*/,Zakeke.Customizer.ImageProcessor.getImagePalette(url,10)];case 1:imagePalette=_a.sent();_a.label=2;case 2:colorMappings=[];_loop_4=function(){var sourceColor=imagePalette[i];var targetColor=sourceColor;if(!usedColors.find(function(c){return c===sourceColor;})){// Colore non utilizzato - devo provare ad aggiungerlo tra i colori utilizzati.
if(usedColors.length<maxColors){// Posso aggiungere un colore ad hoc per il color in questione
if(predefinedPalette.length>0){// Scelgo il colore più vicino nella palette predefinita
targetColor=Zakeke.Customizer.ImageProcessor.remapColor(sourceColor,predefinedPalette);}if(!usedColors.find(function(c){return c===targetColor;}))usedColors.push(targetColor);}else{// Il colore va scelto tra i colori giù utilizzati
targetColor=Zakeke.Customizer.ImageProcessor.remapColor(sourceColor,usedColors);}}colorMappings.push({src:sourceColor,dest:targetColor});};for(i=0;i<imagePalette.length;i++){_loop_4();}return[2/*return*/,colorMappings];}});});},_getColorMappingSourcePalette:function(colorMappings){return colorMappings.map(function(m){return m.src;}).join(',');},_getColorMappingDestPalette:function(colorMappings){return colorMappings.map(function(m){return m.dest;}).join(',');},createDesignEffectForRecoloring:function(colorMappings){var effect=new MPlaza.DesignEffect();effect.set("blendMode","normal");effect.set("opacity",1);effect.set("imageEffectTypeName","reduce colors");var par=new MPlaza.ImageEffectParameterValue();par.set("name","palette");par.set("value",this._getColorMappingSourcePalette(colorMappings));effect.get("imageEffectParameterValues").add(par);par=new MPlaza.ImageEffectParameterValue();par.set("name","replacementPalette");par.set("value",this._getColorMappingDestPalette(colorMappings));effect.get("imageEffectParameterValues").add(par);return effect;},recolorImage:function(url,colorMappings){return __awaiter(this,void 0,void 0,function(){var recolorEffect;return __generator(this,function(_a){switch(_a.label){case 0:recolorEffect=this.createDesignEffectForRecoloring(colorMappings);return[4/*yield*/,this.applyDesignEffectToImageUrl(recolorEffect,url)];case 1:return[2/*return*/,_a.sent()];}});});},changeColorMapping:function(oldColor,newColor){return __awaiter(this,void 0,void 0,function(){var operationId,items,i,item,info,info,info,shape,style,area,strokeColor,fillColor;return __generator(this,function(_a){switch(_a.label){case 0:operationId=this.getLastUndoOperationId();this.beginDesignOperation();items=this.getAllItems();// Used for multiple elements and 1 max color
// Example: If we have two red text and we try to change the red to green, when changing the first text the internal code
// will check that the single available color is the red (in the 2nd text) so it will refuse to change the color from red to green
// as we would have two used colors (more than the 1 available).
// With that code, it will ignore the other elements as we are sure that we want change the color.
this.usedColorsItemsToCheck=[];i=0;_a.label=1;case 1:if(!(i<items.length))return[3/*break*/,5];item=items[i];if(this.getItemIsTextArt(item)){info=this.getTextArtItemInfo(item);if(info.style.strokeColor==oldColor)info.style.strokeColor=newColor;if(info.style.fillColor==oldColor)info.style.fillColor=newColor;if(info.style.shadowColor==oldColor)info.style.shadowColor=newColor;this.changeTextArtStyle(item,info.style);}if(this.getItemIsTextOnPath(item)){info=this.getTextItemInfo(item);if(info.strokeColor==oldColor)info.strokeColor=newColor;if(info.fillColor==oldColor)info.fillColor=newColor;if(info.shadowColor==oldColor)info.shadowColor=newColor;this.modifyTextOnPathInfo(item,{strokeColor:info.strokeColor,fillColor:info.fillColor,shadowColor:info.shadowColor});}if(this.getItemIsTextArea(item)){info=this.getTextItemInfo(item);if(info.strokeColor==oldColor)info.strokeColor=newColor;if(info.fillColor==oldColor)info.fillColor=newColor;if(info.shadowColor==oldColor)info.shadowColor=newColor;this.modifyTextAreaInfo(item,{strokeColor:info.strokeColor,fillColor:info.fillColor,shadowColor:info.shadowColor});}if(!(item instanceof this.paper.Raster||this.isMaskedImage(item)))return[3/*break*/,3];return[4/*yield*/,this.changeImageItemColorMapping(item,null,oldColor,newColor)];case 2:_a.sent();_a.label=3;case 3:if(this.isShape(item)||this.isMaskedImage(item)){shape=this.isShape(item)?item:this.getMaskedImageShapeItem(item);style=this.getShapeItemStyle(shape);if(style.strokeColor==oldColor)style.strokeColor=newColor;if(style.fillColor==oldColor)style.fillColor=newColor;this.changeShapeStyle(item,style);}if(item.data.isGroupForBackground){area=item.children.find(function(x){return x.data.isAreaForBackground;});if(area){strokeColor=area.strokeColor instanceof paper.Color?area.strokeColor.toCSS(true):area.strokeColor;if(strokeColor==oldColor){area.strokeColor=newColor;}fillColor=area.fillColor instanceof paper.Color?area.fillColor.toCSS(true):area.fillColor;if(fillColor==oldColor){area.fillColor=newColor;}this.onItemUpdated(area);}}this.usedColorsItemsToCheck.push(item);_a.label=4;case 4:i++;return[3/*break*/,1];case 5:this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);return[2/*return*/];}});});},changeImageItemColorMapping:function(item,originalColor,oldMappedolor,newColor){var _a,_b;return __awaiter(this,void 0,void 0,function(){var imageItemInfo,designItem,raster,changed,url,designEffect,originalUrl,colorMappings,_i,colorMappings_1,mapping,case1,case2,recolorEffect,image,shape;return __generator(this,function(_c){switch(_c.label){case 0:if(!item)return[3/*break*/,4];imageItemInfo=this.getImageItemInfo(item);designItem=this.findDesignItemByGuid(item.data.guid);raster=this.getMaskedImageRasterItem(item);changed=false;if(!(imageItemInfo&&designItem&&raster))return[3/*break*/,4];this.beginDesignOperation();url=imageItemInfo.url;designEffect=this.getDesignEffectForDesignItem(designItem);originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_c.sent();colorMappings=(_b=(_a=designItem.get("colorMappings"))===null||_a===void 0?void 0:_a.toJSON())!==null&&_b!==void 0?_b:[];for(_i=0,colorMappings_1=colorMappings;_i<colorMappings_1.length;_i++){mapping=colorMappings_1[_i];case1=originalColor&&mapping.src==originalColor&&mapping.dest!=newColor;case2=oldMappedolor&&mapping.dest==oldMappedolor;if(case1||case2){mapping.dest=newColor;changed=true;}}if(!changed)return[2/*return*/,item];recolorEffect=this.createDesignEffectForRecoloring(colorMappings);return[4/*yield*/,this.applyDesignEffectToImageUrl(recolorEffect,url)];case 2:url=_c.sent();return[4/*yield*/,this.changeRasterItem(raster,url)];case 3:_c.sent();// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);this.updateDesignItemColorMappings(designItem,colorMappings);this.endDesignOperation();image=this.createDummyImageFromDesignItem(designItem);shape=this.createDummyShapeFromDesignItem(designItem);this.onImageItemUpdated(item,image,shape);this.updateSelectionState();this.paper.project.view.update();_c.label=4;case 4:return[2/*return*/,item];}});});},forceColorInFixedPalette:function(item,newColor,currentColor){if(!newColor)return newColor;if(!currentColor)currentColor=newColor;if(newColor instanceof this.paper.Color)newColor=newColor.toCSS(true);if(currentColor instanceof this.paper.Color)currentColor=newColor.toCSS(true);var resultColor=newColor;var selectableColors=this.getSelectableColors(item);var usedColors=this.getUsedColorsWithCount();var currentColorIsUsedOnce=selectableColors?usedColors.has(currentColor)&&usedColors.get(currentColor)<=1&&selectableColors.indexOf(currentColor)!==-1:true;if(selectableColors&&selectableColors.length>0&&!currentColorIsUsedOnce){if(!selectableColors.find(function(c){return c===newColor;})){resultColor=Zakeke.Customizer.ImageProcessor.remapColor(newColor,selectableColors);}}return resultColor;},resetRecoloring:function(){return __awaiter(this,void 0,void 0,function(){var operationId,items,i,item,info,info,info,shape,style;return __generator(this,function(_a){switch(_a.label){case 0:operationId=this.getLastUndoOperationId();this.beginDesignOperation();this.usedColorsItemsToCheck=[];items=this.getAllItems();i=0;_a.label=1;case 1:if(!(i<items.length))return[3/*break*/,5];item=items[i];if(this.getItemIsTextArt(item)){info=this.getTextArtItemInfo(item);if(info.style.strokeColor)info.style.strokeColor=this.forceColorInFixedPalette(item,info.style.strokeColor);if(info.style.fillColor)info.style.fillColor=this.forceColorInFixedPalette(item,info.style.fillColor);if(info.style.shadowColor)info.style.shadowColor=this.forceColorInFixedPalette(item,info.style.shadowColor);this.changeTextArtStyle(item,info.style);}if(this.getItemIsTextOnPath(item)){info=this.getTextItemInfo(item);if(info.strokeColor)info.strokeColor=this.forceColorInFixedPalette(item,info.strokeColor);if(info.fillColor)info.fillColor=this.forceColorInFixedPalette(item,info.fillColor);if(info.shadowColor)info.shadowColor=this.forceColorInFixedPalette(item,info.shadowColor);this.modifyTextOnPathInfo(item,{strokeColor:info.strokeColor,fillColor:info.fillColor,shadowColor:info.shadowColor});}if(this.getItemIsTextArea(item)){info=this.getTextItemInfo(item);if(info.strokeColor)info.strokeColor=this.forceColorInFixedPalette(item,info.strokeColor);if(info.fillColor)info.fillColor=this.forceColorInFixedPalette(item,info.fillColor);if(info.shadowColor)info.shadowColor=this.forceColorInFixedPalette(item,info.shadowColor);this.modifyTextAreaInfo(item,{strokeColor:info.strokeColor,fillColor:info.fillColor,shadowColor:info.shadowColor});}if(!(item instanceof this.paper.Raster||this.isMaskedImage(item)))return[3/*break*/,3];return[4/*yield*/,this.resetImageColorMapping(item)];case 2:_a.sent();_a.label=3;case 3:if(this.isShape(item)||this.isMaskedImage(item)){shape=this.isShape(item)?item:this.getMaskedImageShapeItem(item);style=this.getShapeItemStyle(shape);if(style.strokeColor)style.strokeColor=this.forceColorInFixedPalette(item,style.strokeColor);if(style.fillColor)style.fillColor=this.forceColorInFixedPalette(item,style.fillColor);this.changeShapeStyle(item,style);}this.onItemUpdated(item);this.usedColorsItemsToCheck.push(item);_a.label=4;case 4:i++;return[3/*break*/,1];case 5:this.usedColorsItemsToCheck=null;this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);return[2/*return*/];}});});},resetImageColorMapping:function(item,colorMappings){return __awaiter(this,void 0,void 0,function(){var imageItemInfo,designItem,raster,url,designEffect,originalUrl,image,shape;return __generator(this,function(_a){switch(_a.label){case 0:if(!item)return[3/*break*/,7];imageItemInfo=this.getImageItemInfo(item);designItem=this.findDesignItemByGuid(item.data.guid);raster=this.getMaskedImageRasterItem(item);if(!(imageItemInfo&&designItem&&raster))return[3/*break*/,7];this.beginDesignOperation();url=imageItemInfo.url;designEffect=this.getDesignEffectForDesignItem(designItem);originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,item)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:return[4/*yield*/,this.changeRasterItem(raster,url)];case 6:_a.sent();// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);this.updateDesignItemColorMappings(designItem,colorMappings);this.endDesignOperation();image=this.createDummyImageFromDesignItem(designItem);shape=this.createDummyShapeFromDesignItem(designItem);this.onImageItemUpdated(item,image,shape);this.updateSelectionState();this.paper.project.view.update();_a.label=7;case 7:return[2/*return*/,item];}});});},// -------------------------------------------------------
// Design Effects
// -------------------------------------------------------
getDesignEffectForArea:function(area){var selectedPrintType=this.getModelPrintType(this.design.getSelectedPrintTypeForArea(area));if(selectedPrintType)return selectedPrintType.get("previewDesignEffect");},applyDesignEffectToImageUrl:function(effect,url){return __awaiter(this,void 0,void 0,function(){var resultUrl,cachedResult,blob,hexColor,color,halftone,halftoneType,invert,hexDarkColor,darkColor,hexLightColor,lightColor,imageEffect,_a,colors,palette,replacementPalette;return __generator(this,function(_b){switch(_b.label){case 0:resultUrl=url;if(!(effect&&effect instanceof MPlaza.DesignEffect&&effect.get("imageEffectTypeName")))return[3/*break*/,21];cachedResult=this._getCachedImageEffectResult(url,effect);if(!cachedResult)return[3/*break*/,1];resultUrl=cachedResult;return[3/*break*/,21];case 1:blob=null;hexColor=effect.get("imageEffectParameterValues").getValue("overlay color");color=undefined;if(hexColor)color=this.hex2rgb(hexColor);halftone=effect.get("imageEffectParameterValues").getValue("halftone");halftoneType=Zakeke.Customizer.HalfoneType.None;if(halftone){switch(halftone.toLowerCase()){case"errordiffusion":halftoneType=Zakeke.Customizer.HalfoneType.ErrorDiffusion;break;case"dithering":halftoneType=Zakeke.Customizer.HalfoneType.Dithering;break;default:halftoneType=Zakeke.Customizer.HalfoneType.None;break;}}invert=effect.get("imageEffectParameterValues").getValueBoolean("invert");hexDarkColor=effect.get("imageEffectParameterValues").getValue("dark color");darkColor={red:0,green:0,blue:0};if(hexDarkColor)darkColor=this.hex2rgb(hexDarkColor);hexLightColor=effect.get("imageEffectParameterValues").getValue("light color");lightColor={red:255,green:255,blue:255};if(hexLightColor)lightColor=this.hex2rgb(hexLightColor);imageEffect=effect.get("imageEffectTypeName").toLowerCase();_a=imageEffect;switch(_a){case"greyscale":return[3/*break*/,2];case"contrasted greyscale":return[3/*break*/,4];case"soft greyscale":return[3/*break*/,6];case"hard greyscale":return[3/*break*/,8];case"black and white":return[3/*break*/,10];case"black and transparent":return[3/*break*/,12];case"dark and light":return[3/*break*/,14];case"silhouette":return[3/*break*/,16];case"reduce colors":return[3/*break*/,18];}return[3/*break*/,20];case 2:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.greyScale(url,halftoneType,invert,color)];case 3:blob=_b.sent();return[3/*break*/,20];case 4:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.greyScalePlus(url,halftoneType,invert,color)];case 5:blob=_b.sent();return[3/*break*/,20];case 6:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.desaturate(url,halftoneType,invert,color)];case 7:blob=_b.sent();return[3/*break*/,20];case 8:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.blackAndWhite(url,halftoneType,invert,color)];case 9:blob=_b.sent();return[3/*break*/,20];case 10:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.thresholding(url,invert,color)];case 11:blob=_b.sent();return[3/*break*/,20];case 12:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.thresholdingTransparentWhite(url,invert,color)];case 13:blob=_b.sent();return[3/*break*/,20];case 14:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.thresholdingDarkAndLight(url,invert,darkColor,lightColor)];case 15:blob=_b.sent();return[3/*break*/,20];case 16:return[4/*yield*/,Zakeke.Customizer.ImageProcessor.overlapColor(url,color)];case 17:blob=_b.sent();return[3/*break*/,20];case 18:colors=effect.get("imageEffectParameterValues").getValueNumber("colors");palette=effect.get("imageEffectParameterValues").getValue("palette");replacementPalette=effect.get("imageEffectParameterValues").getValue("replacementPalette");return[4/*yield*/,Zakeke.Customizer.ImageProcessor.reduce(url,colors,palette,replacementPalette)];case 19:blob=_b.sent();return[3/*break*/,20];case 20:if(blob)resultUrl=URL.createObjectURL(blob);this._cacheImageEffectResult(url,effect,resultUrl);_b.label=21;case 21:return[2/*return*/,resultUrl];}});});},applyDesignEffectToTextColor:function(effect,textColor){if(textColor&&effect&&effect.get("textColor"))return effect.get("textColor");return textColor;},applyDesignEffectToShapeColor:function(effect,shapeColor){// Ore il colore del testo viene usato anche per gli shape
if(shapeColor&&effect&&effect.get("textColor"))return effect.get("textColor");return shapeColor;},applyDesignEffectToItem:function(effect,item,isMaskedImage){if(isMaskedImage===void 0){isMaskedImage=false;}var isFirefox=navigator.userAgent.indexOf("Firefox")!=-1;if(item){var blendMode="normal";var enhanceBlendMode=false;var opacity=1;if(effect&&effect instanceof MPlaza.DesignEffect){var effectBlendMode_1=effect.get("blendMode")||"normal";blendMode=this.supportedBlendModes.find(function(m){return m==effectBlendMode_1.toLowerCase();})||'normal';// Firefox has some problem with clipping and blend modes
if(isMaskedImage&&isFirefox)blendMode='normal';enhanceBlendMode=effect.get("enhanceBlendMode");opacity=effect.get("opacity");if(opacity==undefined||opacity==null)opacity=1;opacity=Math.max(Math.min(1,opacity),0);}item.blendMode=blendMode;item.enhanceBlendMode=enhanceBlendMode;item.opacity=opacity;if(this.isMaskedImage(item)){var shape=this.getMaskedImageShapeItem(item);var raster=this.getMaskedImageRasterItem(item);this.applyDesignEffectToItem(effect,shape,isMaskedImage);this.applyDesignEffectToItem(effect,raster,isMaskedImage);}}},hex2rgb:function(str){var _a=String(str).match(this.RGB_HEX)||[],short=_a[1],long=_a[2];var arr=[0,0,0];if(long){var value=Number.parseInt(long,16);arr=[value>>16,value>>8&0xFF,value&0xFF];}else if(short){arr=Array.from(short,function(s){return Number.parseInt(s,16);}).map(function(n){return n<<4|n;});}return{red:arr[0],green:arr[1],blue:arr[2]};},// Da aggiornare con le modifiche su MaskedImages e da rivdere completamente per la complessità del parsing
// Il metodo seguente ha lo scopo di recuperare il JSON del designItem in input, applicare gli eventuali effetti,
// e creare l'item (o gli item) Paper JS per il canvas. Il modo di eseguire il parsing è abbastanza grossolano e andrebbe organizzato meglio
getOrCreateItemFromDesignItem:function(designItem){var _a,_b,_c,_d;return __awaiter(this,void 0,void 0,function(){var item,itemGuid,designEffect,json,parseColorComponents,parsedJson,originalUrl,newUrl,colorMappings,shapePart,parsedShapeJson,originalStrokeColor,strokeColor,newStrokeColor,clipGroupPart,parsedClipGroupJson,rasterPart,rasterParsedJson,originalUrl,newUrl,colorMappings,originalStrokeColor,originalFillColor,originalShadowColor,strokeColor,fillColor,shadowColor,newStrokeColor,newFillColor,newShadowColor,originalStrokeColor,pointTextItem,originalFillColor,pointTextItem,originalShadowColor,pointTextItem,strokeColor,fillColor,shadowColor,newStrokeColor_1,newFillColor_1,newShadowColor_1;var _this_1=this;return __generator(this,function(_e){switch(_e.label){case 0:item=null;itemGuid=designItem.get("itemGuid");designEffect=null;json="";parseColorComponents=function(colorObject){if(Object.prototype.toString.call(colorObject)==='[object Array]'&&colorObject.length>0){if(colorObject.length==4&&colorObject[0]=="Color")return colorObject.slice(1,4);}return colorObject;};if(!(designItem&&designItem instanceof MPlaza.DesignItem))return[3/*break*/,11];// design effect
json=designItem.get("json");designEffect=this.getDesignEffectForDesignItem(designItem);parsedJson=JSON.parse(json);if(!(designItem.get("imageID")>0))return[3/*break*/,10];if(!(Object.prototype.toString.call(parsedJson)==='[object Array]'&&parsedJson.length==2&&parsedJson[0]=="Raster"&&parsedJson[1].source))return[3/*break*/,4];originalUrl=parsedJson[1].source;if(parsedJson[1].data&&parsedJson[1].data.originalUrl)originalUrl=parsedJson[1].data.originalUrl;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,originalUrl)];case 1:newUrl=_e.sent();colorMappings=(_b=(_a=designItem.get("colorMappings"))===null||_a===void 0?void 0:_a.toJSON())!==null&&_b!==void 0?_b:[];if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,3];return[4/*yield*/,this.recolorImage(newUrl,colorMappings)];case 2:newUrl=_e.sent();_e.label=3;case 3:parsedJson[1].source=newUrl;json=JSON.stringify(parsedJson);return[3/*break*/,9];case 4:if(!(Object.prototype.toString.call(parsedJson)==='[object Array]'&&parsedJson.length==2&&parsedJson[0]=="Group"&&parsedJson[1].data&&parsedJson[1].data.isMaskedImageMainGroup))return[3/*break*/,9];shapePart=parsedJson[1].children.filter(function(c){return Object.prototype.toString.call(c)==='[object Array]'&&c.length==2&&c[0]=="CompoundPath";});if(shapePart){parsedShapeJson=shapePart[0];originalStrokeColor=parsedShapeJson[1].strokeColor;if(originalStrokeColor){originalStrokeColor=new this.paper.Color(originalStrokeColor).toCSS(true);}if(parsedShapeJson[1].data){if(parsedShapeJson[1].data.originalStrokeColor){originalStrokeColor=parsedShapeJson[1].data.originalStrokeColor;}}strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);if(parsedShapeJson[1].data){parsedShapeJson[1].data.originalStrokeColor=new this.paper.Color(originalStrokeColor).toCSS(true);}newStrokeColor=undefined;if(strokeColor){newStrokeColor=new this.paper.Color(strokeColor).components;}parsedShapeJson[1].strokeColor=newStrokeColor;}clipGroupPart=parsedJson[1].children.filter(function(c){return Object.prototype.toString.call(c)==='[object Array]'&&c.length==2&&c[0]=="Group";});if(!clipGroupPart)return[3/*break*/,8];parsedClipGroupJson=clipGroupPart[0];rasterPart=parsedClipGroupJson[1].children.filter(function(c){return Object.prototype.toString.call(c)==='[object Array]'&&c.length==2&&c[0]=="Raster";});rasterParsedJson=rasterPart[0];originalUrl=rasterParsedJson[1].source;if(rasterParsedJson[1].data&&rasterParsedJson[1].data.originalUrl)originalUrl=rasterParsedJson[1].data.originalUrl;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,originalUrl)];case 5:newUrl=_e.sent();colorMappings=(_d=(_c=designItem.get("colorMappings"))===null||_c===void 0?void 0:_c.toJSON())!==null&&_d!==void 0?_d:[];if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,7];return[4/*yield*/,this.recolorImage(newUrl,colorMappings)];case 6:newUrl=_e.sent();_e.label=7;case 7:rasterParsedJson[1].source=newUrl;_e.label=8;case 8:json=JSON.stringify(parsedJson);_e.label=9;case 9:return[3/*break*/,11];case 10:// Text Art or Shape
if(Object.prototype.toString.call(parsedJson)==='[object Array]'&&parsedJson.length==2&&parsedJson[0]=="CompoundPath"){originalStrokeColor=parsedJson[1].strokeColor;originalFillColor=parsedJson[1].fillColor;originalShadowColor=parsedJson[1].shadowColor;if(originalStrokeColor){originalStrokeColor=new this.paper.Color(originalStrokeColor).toCSS(true);}if(originalFillColor){originalFillColor=new this.paper.Color(originalFillColor).toCSS(true);}if(originalShadowColor){originalShadowColor=new this.paper.Color(originalShadowColor).toCSS(true);}if(parsedJson[1].data){if(parsedJson[1].data.originalStrokeColor){originalStrokeColor=parsedJson[1].data.originalStrokeColor;}if(parsedJson[1].data.originalFillColor){originalFillColor=parsedJson[1].data.originalFillColor;}if(parsedJson[1].data.originalShadowColor){originalShadowColor=parsedJson[1].data.originalShadowColor;}}strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);if(parsedJson[1].data){parsedJson[1].data.originalStrokeColor=new this.paper.Color(originalStrokeColor).toCSS(true);parsedJson[1].data.originalFillColor=new this.paper.Color(originalFillColor).toCSS(true);parsedJson[1].data.originalShadowColor=new this.paper.Color(originalShadowColor).toCSS(true);}newStrokeColor=undefined;newFillColor=undefined;newShadowColor=undefined;if(strokeColor){newStrokeColor=new this.paper.Color(strokeColor).components;}if(fillColor){newFillColor=new this.paper.Color(fillColor).components;}if(shadowColor){newShadowColor=new this.paper.Color(shadowColor).components;}parsedJson[1].strokeColor=newStrokeColor;parsedJson[1].fillColor=newFillColor;parsedJson[1].shadowColor=newShadowColor;json=JSON.stringify(parsedJson);}else if(Object.prototype.toString.call(parsedJson)==='[object Array]'&&parsedJson.length==2&&parsedJson[0]=="Group"&&parsedJson[1].data&&(parsedJson[1].data.isTextArea||parsedJson[1].data.isTextOnPath)){originalStrokeColor=null;if(parsedJson[1].data&&parsedJson[1].data.hasOwnProperty("originalStrokeColor")){originalStrokeColor=parsedJson[1].data["originalStrokeColor"];}else if(parsedJson[1].data&&parsedJson[1].data.textInfo&&parsedJson[1].data.textInfo.hasOwnProperty("strokeColor")){originalStrokeColor=new this.paper.Color(parseColorComponents(parsedJson[1].data.textInfo.strokeColor)).toCSS(true);}else if(parsedJson[1].children&&Object.prototype.toString.call(parsedJson[1].children)==='[object Array]'&&parsedJson[1].children.length>0){pointTextItem=parsedJson[1].children[0];if(pointTextItem&&Object.prototype.toString.call(pointTextItem)==='[object Array]'&&pointTextItem.length==2&&pointTextItem[0]=="PointText"&&pointTextItem[1].strokeColor){originalStrokeColor=new this.paper.Color(pointTextItem[1].strokeColor).toCSS(true);}}originalFillColor=null;if(parsedJson[1].data&&parsedJson[1].data.hasOwnProperty("originalFillColor")){originalFillColor=parsedJson[1].data["originalFillColor"];}else if(parsedJson[1].data&&parsedJson[1].data.textInfo&&parsedJson[1].data.textInfo.hasOwnProperty("fillColor")){originalFillColor=new this.paper.Color(parseColorComponents(parsedJson[1].data.textInfo.fillColor)).toCSS(true);}else if(parsedJson[1].children&&Object.prototype.toString.call(parsedJson[1].children)==='[object Array]'&&parsedJson[1].children.length>0){pointTextItem=parsedJson[1].children[0];if(pointTextItem&&Object.prototype.toString.call(pointTextItem)==='[object Array]'&&pointTextItem.length==2&&pointTextItem[0]=="PointText"&&pointTextItem[1].fillColor){originalFillColor=new this.paper.Color(pointTextItem[1].fillColor).toCSS(true);}}originalShadowColor=null;if(parsedJson[1].data&&parsedJson[1].data.hasOwnProperty("originalShadowColor")){originalShadowColor=parsedJson[1].data["originalShadowColor"];}else if(parsedJson[1].data&&parsedJson[1].data.textInfo&&parsedJson[1].data.textInfo.hasOwnProperty("shadowColor")){originalShadowColor=new this.paper.Color(parseColorComponents(parsedJson[1].data.textInfo.shadowColor)).toCSS(true);}else if(parsedJson[1].children&&Object.prototype.toString.call(parsedJson[1].children)==='[object Array]'&&parsedJson[1].children.length>0){pointTextItem=parsedJson[1].children[0];if(pointTextItem&&Object.prototype.toString.call(pointTextItem)==='[object Array]'&&pointTextItem.length==2&&pointTextItem[0]=="PointText"&&pointTextItem[1].shadowColor){originalShadowColor=new this.paper.Color(pointTextItem[1].shadowColor).toCSS(true);}}strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);shadowColor=this.applyDesignEffectToTextColor(designEffect,originalShadowColor);if(parsedJson[1].data){parsedJson[1].data.originalStrokeColor=new this.paper.Color(originalStrokeColor).toCSS(true);parsedJson[1].data.originalFillColor=new this.paper.Color(originalFillColor).toCSS(true);if(originalShadowColor){parsedJson[1].data.originalShadowColor=new this.paper.Color(originalShadowColor).toCSS(true);}}newStrokeColor_1=undefined;newFillColor_1=undefined;newShadowColor_1=undefined;if(strokeColor){newStrokeColor_1=new this.paper.Color(strokeColor).components;}if(fillColor){newFillColor_1=new this.paper.Color(fillColor).components;}if(shadowColor){newShadowColor_1=new this.paper.Color(shadowColor).components;}// don't show the shadow on the 3d preview due to a bug in the visualization
if(this.isViewer){newShadowColor_1=null;}if(parsedJson[1].data.textInfo){parsedJson[1].data.textInfo.strokeColor=newStrokeColor_1;parsedJson[1].data.textInfo.fillColor=newFillColor_1;parsedJson[1].data.textInfo.shadowColor=newShadowColor_1;}if(parsedJson[1].children&&Object.prototype.toString.call(parsedJson[1].children)==='[object Array]'&&parsedJson[1].children.length>0){parsedJson[1].children.forEach(function(pointTextItem){if(Object.prototype.toString.call(pointTextItem)==='[object Array]'&&pointTextItem.length==2&&pointTextItem[0]=="PointText"){pointTextItem[1].strokeColor=newStrokeColor_1;pointTextItem[1].fillColor=newFillColor_1;pointTextItem[1].shadowColor=newShadowColor_1;}});}// shadow
//parsedJson[1].shadowColor = newShadowColor;
json=JSON.stringify(parsedJson);}_e.label=11;case 11:return[4/*yield*/,new Promise(function(resolve){var item=_this_1.findItemByGuid(itemGuid);if(!item&&json){item=_this_1.paper.project.activeLayer.importJSON(json);item.data.guid=itemGuid;}var imageItem=null;if(item){if(item instanceof _this_1.paper.Raster)imageItem=item;if(_this_1.isMaskedImage(item)||_this_1.isFilledShape(item)){imageItem=_this_1.getMaskedImageRasterItem(item);// Fix stroke width if stroke color is null (paper put 1 as default width)
var shape=_this_1.getMaskedImageShapeItem(item);if(!shape.strokeColor)shape.strokeWidth=0;}if(_this_1.isShape(item)&&_this_1.isImagePlaceholder(item)){_this_1.updateShapeImagePlaceholder(item);// Force a refresh of the camera icon, etc...
}if(imageItem){imageItem.onLoad=function(){resolve(item);};}else{resolve(item);}}else{resolve(item);}})];case 12:// Importo il json creando l'item (se non esiste)
item=_e.sent();this.applyDesignEffectToItem(designEffect,item);return[2/*return*/,item];}});});},getDesignEffectForDesignItem:function(designItem){var designEffect=null;if(this.side&&designItem&&designItem instanceof MPlaza.DesignItem&&designItem.get("areas").length>0){var designItemArea=designItem.get("areas").at(0);var area=this.side.findAreaByID(designItemArea.get("areaID"));designEffect=this.getDesignEffectForArea(area);}return designEffect;},createRasterItem:function(url,visible){var _this_1=this;if(visible===void 0){visible=true;}return new Promise(function(resolve){var item=new _this_1.paper.Raster({crossOrigin:"anonymous",source:url,visibile:visible});item.onLoad=function(){item.onLoad=undefined;resolve(item);};});},changeRasterItem:function(item,newUrl){return new Promise(function(resolve){item.crossOrigin="anonymous";item.source=newUrl;item.onLoad=function(){item.onLoad=undefined;resolve();};});},convertColorToHex:function(color){var hexColor=undefined;if(color&&color instanceof this.paper.Color){hexColor=color.toCSS(true);}return hexColor;},_getImageEffectCacheKey:function(url,effect){var key="image_effect_"+url;var json=JSON.stringify(effect.toJSON());var hash=CryptoJS.SHA1(json).toString();key+="_"+hash;return key;},_emptyImageEffectCache:function(){window.imageEffectCache={};},_getCachedImageEffectResult:function(url,effect){// Per ora evito di usare la cache perché altrimenti l'immagine del design verrebbe visualizzata
// dopo l'immagine del lato. Andrebbe risolto prima il problema del ritardo del caricamento
// dell'immagine del lato e poi riattivata la cache.
//return null;
var key=this._getImageEffectCacheKey(url,effect);if(window.imageEffectCache.hasOwnProperty(key))return window.imageEffectCache[key];return null;},_cacheImageEffectResult:function(url,effect,result){if(url&&effect&&result){var key=this._getImageEffectCacheKey(url,effect);window.imageEffectCache[key]=result;}},// -------------------------------------------------------
// Fine Design Effects
// -------------------------------------------------------    
// -------------------------------------------------------
// Masked Images
// -------------------------------------------------------
// Una Masked Image è costituita da un gruppo principale (MainGroup) che racchiude una shape corrispondente alla maschera per dare un effetto sul bordo
// e un gruppo di ritaglio contenente la maschera e l'immagine da mascherare.
// Per spostare, ruotare e ridimensionare solo l'immagine, viene utilizzata un'immagine guida (Guide Raster) oltre alla raster clippata
isMaskedImage:function(item){return item&&item instanceof this.paper.Group&&item.data&&item.data.isMaskedImageMainGroup;},isMaskedImageRasterItem:function(item){return this.isImage(item)&&this.isMaskedImageClipGroup(item.parent);},isImage:function(item){return item&&item instanceof this.paper.Raster;},isMaskedImageClipGroup:function(item){return item&&item instanceof this.paper.Group&&item.data&&item.data.isMaskedImageClipGroup;},isMaskedImageGuideRaster:function(item){return item&&item instanceof this.paper.Raster&&item.data&&item.data.isMaskedImageGuideRaster;},isMaskedImageSelected:function(){var _this_1=this;return this.getSelectedItems().some(function(item){return _this_1.isMaskedImage(item);});},isMaskedImageShapeItem:function(item){return item&&item.data&&item.data.isMaskedImageShape;},isMaskedImageMaskItem:function(item){return item&&item.data&&item.data.isMaskedImageMask;},// Dato un item (che può essere un Raster semplice o una MaskedImage) applica la maschera.
// Se l'elemento è già una maschera, questa verrà sostituita con la nuova.
// Se l'elemento è una MaskedImage e la maschera passata è vuota allora la maschera verrà eliminata
// e l'elemento ritornerà ad essere un semplice Raster
applyMaskToImageItemAsync:function(item,shape,options){return __awaiter(this,void 0,void 0,function(){var operationId,newItem,pathd;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.canEditItem(item))return[2/*return*/,item];if(this.isImage(item)&&!this.canMaskImages())return[2/*return*/,item];if(this.isImage(item)&&!this.canAddMask(item))return[2/*return*/,item];if(this.isMaskedImage(item)&&!this.canReplaceMask(item))return[2/*return*/,item];if(this.isMaskedImage(item)&&!shape&&!this.canDeleteMask(item))return[2/*return*/,item];operationId=this.getLastUndoOperationId();this.beginDesignOperation();newItem=item;if(!!shape)return[3/*break*/,1];newItem=this.removeMaskFromImage(item);return[3/*break*/,3];case 1:return[4/*yield*/,this._loadShapePathDataAsync(shape)];case 2:pathd=_a.sent();// TEST fixed style
//options.strokeColor = '#000000'
//options.strokeWidth = 2;
if(item){if(this.isMaskedImage(item))newItem=this.updateMaskedImage(item,shape,pathd,options);else if(item instanceof this.paper.Raster)newItem=this.createMaskedImage(item,shape,pathd,options);}_a.label=3;case 3:this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);return[2/*return*/,newItem];}});});},getMaskedImageRasterItem:function(item){var _this_1=this;// Caso di immagine non mascherata
if(item&&item instanceof this.paper.Raster)return item;// Gruppo principale
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){// gruppo di ritaglio
var clippedGroup=item.children.find(function(c){return c instanceof _this_1.paper.Group;});if(clippedGroup){var raster=clippedGroup.children.find(function(c){return c instanceof _this_1.paper.Raster;});return raster;}}// Gruppo di ritaglio
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageClipGroup){var raster=item.children.find(function(c){return c instanceof _this_1.paper.Raster;});return raster;}return null;},getMaskedImageShapeItem:function(item){if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){return item.children.find(function(c){return c.data&&c.data.isMaskedImageShape;});}return null;},getMaskedImageMaskItem:function(item){var _this_1=this;// Gruppo principale
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){// gruppo di ritaglio
var clippedGroup=item.children.find(function(c){return c instanceof _this_1.paper.Group;});if(clippedGroup){var mask=clippedGroup.children.find(function(c){return c&&c.data&&c.data.isMaskedImageMask;});return mask;}}// Gruppo di ritaglio
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageClipGroup){var mask=item.children.find(function(c){return c&&c.data&&c.data.isMaskedImageMask;});return mask;}return null;},getMaskedImageClipGroupItem:function(item){var _this_1=this;// Gruppo principale
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){return item.children.find(function(c){return c instanceof _this_1.paper.Group;});}// Gruppo di ritaglio
if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageClipGroup){return item;}return null;},getMaskedImageGuideRasterItem:function(item){if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){return item.children.find(function(c){return c.data&&c.data.isMaskedImageGuideRaster;});}return null;},getMaskedImageFromGuideRasterItem:function(guideRasterItem){if(guideRasterItem&&guideRasterItem instanceof this.paper.Raster&&guideRasterItem.data.isMaskedImageGuideRaster){var parent_1=guideRasterItem.parent;if(parent_1&&parent_1 instanceof this.paper.Group&&parent_1.data&&parent_1.data.isMaskedImageMainGroup)return parent_1;}return null;},getMaskedImageGuideShapeItem:function(item){if(item&&item instanceof this.paper.Group&&item.data.isMaskedImageMainGroup){return item.children.find(function(c){return c.data&&c.data.isMaskedImageGuideShape;});}return null;},getMaskedImageFromGuideShapeItem:function(guideShapeItem){if(guideShapeItem&&guideShapeItem instanceof this.paper.CompoundPath&&guideShapeItem.data.isMaskedImageGuideShapeItem){var parent_2=guideShapeItem.parent;if(parent_2&&parent_2 instanceof this.paper.Group&&parent_2.data&&parent_2.data.isMaskedImageMainGroup)return parent_2;}return null;},getMaskedImageMaskPathStyle:function(item){var style=undefined;if(item){var shape=this.getMaskedImageShapeItem(item);if(shape){style={strokeColor:shape.strokeColor?shape.strokeColor.toCSS(true):undefined,strokeWidth:shape.strokeWidth,strokeCap:shape.strokeCap,strokeJoin:shape.strokeJoin,dashArray:shape.dashArray,dashOffset:shape.dashOffset};if(shape.data.hasOwnProperty("originalStrokeColor"))style.strokeColor=shape.data.originalStrokeColor;}}return style;},// Crea una nuova Masked Image. Qui mi aspetto che l'item sia davvero un semplice Raster di Paper JS
// pathd sono i dati del path (attributo d) relativi allo shape model
createMaskedImage:function(item,shapeModel,pathd,options){if(!this.canMaskImages()||!this.canAddMask(item))return item;if(item&&item instanceof this.paper.Raster&&pathd){var designItem=this.findDesignItemForItem(item);if(designItem){// Modifico i colori in base all'eventuale effetto
var designEffect=this.getDesignEffectForDesignItem(designItem);var selected=this.isItemSelected(item);var itemParent=item.parent;var width=item.bounds.width;var height=item.bounds.height;// Clear selection
delete item.data.selected;// Rapporto il path al box
var path_str=this.boundPath(pathd,width,height);// Creo la maschera (CompoundPath)
var mask=new this.paper.CompoundPath(path_str);mask.position=item.position;mask.data.isMaskedImageMask=true;// Creo la shape che servirà esclusivamente per il contorno
var shape=mask.clone();shape.data.originalBounds=shape.bounds;shape.data.originalMatrix=new this.paper.Matrix();// Riporta tutte le trasformazioni applicate direttamente allo shape
shape.data.originalParentMatrix=new this.paper.Matrix();// Riporta tutte le trasformazioni applicate tramite il gruppo principale (padre)
shape.data.isMaskedImageShape=true;// Applico eventualmente l'effetto al contorno
var originalStrokeColor=options.strokeColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);options.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);this.applyStyleToMaskShape(shape,options);shape.data.originalStrokeColor=originalStrokeColor;// Definisco il gruppo di clipping (maschera + raster)
var clipGroup=new this.paper.Group(mask,item);clipGroup.clipped=true;clipGroup.data.isMaskedImageClipGroup=true;// Definisco il gruppo principale (shape contorno + clipping group)
var mainGroup=new this.paper.Group(clipGroup,shape);mainGroup.applyMatrix=false;mainGroup.data.guid=item.data.guid;delete item.data.guid;mainGroup.data.isMaskedImageMainGroup=true;mainGroup.data.originalBounds=shape.bounds;mainGroup.data.originalMatrix=new this.paper.Matrix();if(item.data.maskPath)item.data.maskPath.remove();if(item.data.maskAlertPath)item.data.maskAlertPath.remove();// Se l'immagine da mascherare è all'interno di una cella di una griglia
// faccio diventare il gruppo principale come figlio diretto della cella
if(item.data.hasOwnProperty("isGridImage")){mainGroup.data.isGridImage=item.data.isGridImage;delete item.data.isGridImage;}if(item.data.hasOwnProperty("gridBoxID")){mainGroup.data.gridBoxID=item.data.gridBoxID;delete item.data.gridBoxID;}this.applyDesignEffectToItem(designEffect,mainGroup,true);itemParent.addChild(mainGroup);// Aggiorno il design item associato al raster (che ora diverrà associato al gruppo)
var imageModel=this.createDummyImageFromDesignItem(designItem);this.onImageItemUpdated(mainGroup,imageModel,shapeModel);item.data.selected=false;mainGroup.data.selected=selected;this.updateSelectionState();return mainGroup;}}return item;},// Aggiorna la MaskedImage. Qui mi aspetto che l'item sia una MaskedImage.
// pathd sono i dati del path (attriuto d) relativi allo shape model.
updateMaskedImage:function(item,shapeModel,pathd,options){if(!this.canReplaceMask(item))return item;if(item&&this.isMaskedImage(item)){var designItem=this.findDesignItemForItem(item);if(designItem){var designEffect=this.getDesignEffectForDesignItem(designItem);// devo sostituire il path con quello in input. Ricavo gli elementi correnti
var shape=this.getMaskedImageShapeItem(item);var mask=this.getMaskedImageMaskItem(item);var raster=this.getMaskedImageRasterItem(item);if(shape&&mask&&raster){delete raster.data.selected;// Applico i limiti allo stile
var maskPathStyle=options;var currentPathStyle=this.getMaskedImageMaskPathStyle(item);if(!this.canChangeMaskStrokeColor(item)||!maskPathStyle.strokeColor){maskPathStyle.strokeColor=currentPathStyle.strokeColor;}if(!this.canChangeMaskStrokeWidth(item)||!maskPathStyle.strokeWidth){maskPathStyle.strokeWidth=currentPathStyle.strokeWidth;}// Applico l'eventuale effetto
var originalStrokeColor=maskPathStyle.strokeColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);maskPathStyle.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);// Cerco di manternermi all'interno dello stesso bounds della maschera di partenza
var bounds=shape.bounds;if(shape.data.originalBounds&&shape.data.originalMatrix){// Questo è il caso normale perché la shape viene creata con le informazioni relative alla bounds iniziale
bounds=shape.data.originalBounds;var boundsItem=new this.paper.Path.Rectangle(0,0,bounds.width,bounds.height);boundsItem.visible=false;boundsItem.matrix=shape.data.originalMatrix.clone();var oldSize=this.getRectangleItemSize(boundsItem);boundsItem.remove();bounds=new this.paper.Rectangle(0,0,oldSize.width,oldSize.height);}else{// Nel caso non avessi le informazioni delle dimensioni iniziali dello shape utilizzo quelle dell'immagine
var rectItem=new this.paper.Path.Rectangle(0,0,raster.width,raster.height);rectItem.remove();rectItem.scale(raster.scaling);bounds=rectItem.bounds;}var position=raster.position;var matrix=shape.data.originalParentMatrix?shape.data.originalParentMatrix:shape.matrix;// Dimensioni prima della sostituzione
var width=bounds.width;var height=bounds.height;// Rapporto il path al box
var path_str=this.boundPath(pathd,width,height);var newMask=new this.paper.CompoundPath(path_str);var newShape=newMask.clone();this.applyStyleToItem(newShape,maskPathStyle);mask.removeChildren();mask.copyContent(newMask);shape.removeChildren();shape.copyContent(newShape);shape.data.originalStrokeColor=originalStrokeColor;newMask.remove();newShape.remove();shape.matrix=matrix.clone();shape.position=position.clone();mask.matrix=matrix.clone();mask.position=position.clone();var imageModel=this.createDummyImageFromDesignItem(designItem);this.onImageItemUpdated(item,imageModel,shapeModel);this.updateSelectionState();}}}},// Aggiorna solo lo stile del bordo della maschera
updateMakedImageMaskStyle:function(item,options){if(item&&this.isMaskedImage(item)){var designItem=this.findDesignItemForItem(item);if(designItem){var designEffect=this.getDesignEffectForDesignItem(designItem);var shape=this.getMaskedImageShapeItem(item);if(shape){this.beginDesignOperation();// sottopongo lo stile ai vincoli
var currentStyle=this.getMaskedImageMaskPathStyle(item);var newStrokeColor=currentStyle.strokeColor;if(this.canChangeMaskStrokeColor(item)&&options.strokeColor!=undefined)newStrokeColor=options.strokeColor;options.strokeColor=newStrokeColor;var newStrokeWidth=currentStyle.strokeWidth;if(this.canChangeMaskStrokeWidth(item)&&options.strokeWidth!=undefined&&options.strokeWidth!=null)newStrokeWidth=options.strokeWidth;options.strokeWidth=newStrokeWidth;// e applico l'eventuale effetto
shape.data.originalStrokeColor=options["strokeWidth"]!=undefined?options.strokeColor:undefined;shape.data.originalStrokeColor=this.forceColorInFixedPalette(item,shape.data.originalStrokeColor);options.strokeColor=this.applyDesignEffectToTextColor(designEffect,shape.data.originalStrokeColor);this.applyStyleToItem(shape,options);var imageModel=this.createDummyImageFromDesignItem(designItem);var shapeModel=this.createDummyShapeFromDesignItem(designItem);this.onImageItemUpdated(item,imageModel,shapeModel);this.endDesignOperation();}}}},// Elimina la maschera dalla MaskedImage, restituendo quindi una semplice Raster di Paper JS
removeMaskFromImage:function(item){var newItem=item;if(item&&this.isMaskedImage(item)&&!this.isFilledShape(item)){var selected=this.isItemSelected(item);var itemParent=item.parent;var designItem=this.findDesignItemForItem(item);var raster=this.getMaskedImageRasterItem(item);if(designItem&&raster){var matrix=item.matrix;newItem=raster;newItem.data.guid=item.data.guid;itemParent.addChild(newItem);item.remove();newItem.matrix.prepend(matrix);if(newItem.data.originalMatrix)newItem.data.originalMatrix.prepend(matrix);var imageModel=this.createDummyImageFromDesignItem(designItem);this.onImageItemUpdated(newItem,imageModel,null);item.data.selected=false;newItem.data.selected=selected;this.updateSelectionState();}}return newItem;},boundPath:function(pathd,w,h){var box=Raphael.pathBBox(pathd);var sx=w/box.width;var sy=h/box.height;var s=Math.min(sx,sy);if(s===0)s=1;var r="s"+s+","+s+",0,0";var newPathd=Raphael.transformPath(pathd,"t"+-box.x+","+(h/s-box.y));newPathd=Raphael.transformPath(newPathd,r);var path_str=newPathd.toString();return path_str;},applyStyleToMaskShape:function(item,style){if(item&&item instanceof this.paper.Item){if(style["strokeColor"]!=undefined)item.strokeColor=style["strokeColor"];if(style["strokeWidth"]!=undefined)item.strokeWidth=style["strokeWidth"];if(style["strokeCap"])item.strokeCap=style["strokeCap"];if(style["strokeJoin"])item.strokeJoin=style["strokeJoin"];if(style["dashOffset"]!=undefined)item.dashOffset=style["dashOffset"];if(style["dashArray"])item.dashArray=style["dashArray"];}},// Restituisce l'elemento di riferimento per la selezione di un elemento.
// Nel caso di MaskedImage (e quindi anche di FilledShape) l'elemento di riferimento dipende
// dalla modalità di selezione attiva, che può essere Raster (modifica solo immagine mascherata)
// Mask (modifica solo maschera) oppure Element (modifca entrambe, il default).
getReferenceItemForSelectedItem:function(item){if(this.isMaskedImage(item)){var refItem=item;if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster){refItem=this.getMaskedImageGuideRasterItem(item);}else if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask){refItem=this.getMaskedImageGuideShapeItem(item);}return refItem;}else{return item;}},// Restituisce il bounds di un item. Normalmente si tratta del bounds restituito da Paper JS.
// Nel caso di un MaskedImage (e quindi di un FilledShape), il bounds dipende dallo stato di selezione.
// Nel caso Raster, sarà visibile l'immagine guida e il bounds sarà proprio quello dell'immagine guida, soggetta a modifica.
// Nel caso Mask, il bounds sarà quello della shape guida. Nel caso Element, il bounds sarà quello della shape
// che rappresenta il bordo della maschera.
getItemBounds:function(item){var bounds=item.bounds;if(this.isMaskedImage(item)){var boundsItem=this.getMaskedImageShapeItem(item);if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster){var raster=this.getMaskedImageGuideRasterItem(item);if(raster)boundsItem=raster;}else if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask){var shape=this.getMaskedImageGuideShapeItem(item);if(shape)boundsItem=shape;}if(boundsItem){if(!item.applyMatrix){var clone=boundsItem.clone();clone.remove();clone.matrix=clone.matrix.prepend(item.matrix);bounds=clone.strokeBounds;}else{bounds=boundsItem.bounds;}}}return bounds;},getImageWidth:function(item){if(this.isMaskedImage(item)){var shape=this.getMaskedImageShapeItem(item);if(shape){if(!item.applyMatrix){var clone=shape.clone();clone.remove();clone.matrix=clone.matrix.prepend(item.matrix);return clone.bounds.width;}return shape.bounds.width;}}else if(this.isImage(item)){return item.width;}return 0;},getImageHeight:function(item){if(this.isMaskedImage(item)){var shape=this.getMaskedImageShape(item);if(shape){if(!item.applyMatrix){var clone=shape.clone();clone.remove();clone.matrix=clone.matrix.prepend(item.matrix);return clone.bounds.height;}return shape.bounds.height;}}else if(this.isImage(item)){return item.height;}return 0;},// metodo di utilità per caricare i path data di una shape
_loadShapePathDataAsync:function(shape){return __awaiter(this,void 0,void 0,function(){var url;return __generator(this,function(_a){switch(_a.label){case 0:if(!(shape&&shape instanceof MPlaza.Shape))return[3/*break*/,2];url=shape.get("pathDataUrl");if(!url)return[3/*break*/,2];return[4/*yield*/,this._loadFileAsync(url,false)];case 1:return[2/*return*/,_a.sent()];case 2:return[2/*return*/];}});});},// metodo di utilità per scaricare un file dato un url
_loadFileAsync:function(url,useArrayBuffer){if(useArrayBuffer===void 0){useArrayBuffer=true;}return new Promise(function(resolve,reject){FileTools.LoadFile(url,function(data){resolve(data);},undefined,undefined,useArrayBuffer,function(request,exception){reject(exception);});});},// Carica una shape a caso nel range 1 - 3000 (utile per debug)
_loadRandomShapeAsync:function(){return __awaiter(this,void 0,void 0,function(){var id;return __generator(this,function(_a){switch(_a.label){case 0:id=Math.floor(Math.random()*3000)+1;return[4/*yield*/,this._loadShapeByIdAsync(id)];case 1:return[2/*return*/,_a.sent()];}});});},// Metodo di utilità per scaricare una shape dato un id
_loadShapeByIdAsync:function(id){var _this_1=this;return new Promise(function(resolve,reject){var that=_this_1;var model=new MPlaza.Shape({shapeID:id});model.fetch({success:function(model,response,options){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(_a){resolve(model);return[2/*return*/];});});},error:function(model,response,options){Logger.info("Error while loading shape");reject();},data:{}});});},// Metodo utile per creare l'immagine guida per la selezione di una MaskedShape
// nella modalità Raster.
createMaskedImageGuideRaster:function(item){if(this.isMaskedImage(item)){var guideRaster=this.getMaskedImageGuideRasterItem(item);if(guideRaster)return guideRaster;var raster=this.getMaskedImageRasterItem(item);if(raster){guideRaster=raster.clone();if(raster.data.originalBounds)guideRaster.data.originalBounds=raster.data.originalBounds.clone();if(raster.data.originalMatrix)guideRaster.data.originalMatrix=raster.data.originalMatrix.clone();guideRaster.parent=item;guideRaster.sendToBack();guideRaster.opacity=0.3;guideRaster.data.isMaskedImageGuideRaster=true;}return guideRaster;}},// Metodo utile per creare il path guida pe rla selezione di una MaskedShape
// nella modalità Mask.
createMaskedImageGuideShape:function(item){if(this.isMaskedImage(item)){var guideShape=this.getMaskedImageGuideShapeItem(item);if(guideShape)return guideShape;var shape=this.getMaskedImageShapeItem(item);if(shape){guideShape=shape.clone();guideShape.blendMode="normal";guideShape.opacity=1;if(shape.data.originalBounds)guideShape.data.originalBounds=shape.data.originalBounds.clone();if(shape.data.originalMatrix)guideShape.data.originalMatrix=shape.data.originalMatrix.clone();guideShape.parent=item;guideShape.bringToFront();var strokeColor="red";if(shape.strokeWidth>0&&shape.strokeColor)strokeColor=MPlaza.getContrastYIQ(shape.strokeColor.red*255,shape.strokeColor.green*255,shape.strokeColor.blue*255);else strokeColor=this.getContrastedColor(shape.bounds);guideShape.strokeColor=strokeColor;guideShape.strokeWidth=2;//guideShape.strokeWidth = 1.0 / this.paper.view.zoom;
//guideShape.dashOffset = 0.5 / this.paper.view.zoom;
//guideShape.dashArray = [1.0 / this.paper.view.zoom, 1.0 / this.paper.view.zoom];
guideShape.dashArray=[4,10];guideShape.data.isMaskedImageGuideShape=true;}return guideShape;}},removeMaskedImageGuideRaster:function(item){var guideRaster=this.getMaskedImageGuideRasterItem(item);if(guideRaster)guideRaster.remove();},removeMaskedImageGuideShape:function(item){var guideShape=this.getMaskedImageGuideShapeItem(item);if(guideShape)guideShape.remove();},// Aggiorna le guide (shape o raster) della selezione di un MaskedImage
updateMaskedImageGuides:function(item){var items=this.getAllImageItems();for(var i=0;i<items.length;i++){var item=items[i];if(this.isItemSelected(item)){if(this.isMaskedImage(item)){if(this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){this.createMaskedImageGuideRaster(item);this.createMaskedImageGuideShape(item);}else{this.removeMaskedImageGuideRaster(item);this.removeMaskedImageGuideShape(item);}}}else{this.removeMaskedImageGuideRaster(item);this.removeMaskedImageGuideShape(item);}}},// Restituisce gli elementi da modificare a fronte di una modifica della selezione di un elemento.
// Nel caso di MaskedImage, gli elementi su cui si ripercuote la modifica dipendono dalla modalità 
// di selezione attiva. Nel caso Element l'elemento è il MaskedShape stesso (main group). Nel caso
// Raster gli elementi da modificare sono l'immagine guida e l'immagine mascherata.
// Nel caso Mask gli elementi sono la shape guida, la shape per il bordo e la maschera.
getSubItemsToChange:function(item){var itemsToChange=[];if(item){if(this.isMaskedImage(item)&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Raster){// Devo modificare solo l'immagine (e la guida)
var guideRaster=this.getMaskedImageGuideRasterItem(item);if(guideRaster)itemsToChange.push(guideRaster);var raster=this.getMaskedImageRasterItem(item);if(raster)itemsToChange.push(raster);}else if(this.maskedImageSelectionMode==MaskedImageSelectionMode.Mask){var guideShape=this.getMaskedImageGuideShapeItem(item);if(guideShape)itemsToChange.push(guideShape);var shape=this.getMaskedImageShapeItem(item);if(shape)itemsToChange.push(shape);var mask=this.getMaskedImageMaskItem(item);if(mask)itemsToChange.push(mask);}}else{itemsToChange.push(item);}}return itemsToChange;},// Cambia la modalità di selezione basandosi sui tasti Alt e Ctrl tenuti premuti durante il click
switchMaskedImageSelectionMode:function(event){this.hitTest(event.point);if(this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element){this.setMaskedImageSelectionMode(MaskedImageSelectionMode.Element);}else if(this.hitItem==this.selectionMaskMoveShape){this.setMaskedImageSelectionMode(MaskedImageSelectionMode.Mask);}else if(this.hitItem==this.selectionMaskMoveImage){this.setMaskedImageSelectionMode(MaskedImageSelectionMode.Raster);}},// Imposta una specifica modalità di selezione della MaskedImage
setMaskedImageSelectionMode:function(mode){var selectedMaskedImages=this.getSelectedMaskedImageItems();if(selectedMaskedImages.length>0){var item=selectedMaskedImages[0];var canChangeMode=true;if(!this.canEditItem(item))canChangeMode=false;else{if(mode===MaskedImageSelectionMode.Mask&&!this.canEditMask(item))canChangeMode=false;if(mode===MaskedImageSelectionMode.Raster&&!this.canEditMaskedImage(item))canChangeMode=false;}if(canChangeMode){this.applyTransformationsToMaskImageSubItems();this.maskedImageSelectionMode=mode;this.updateSelectionState();}else{this.maskedImageSelectionMode=MaskedImageSelectionMode.Element;}}else{this.maskedImageSelectionMode=MaskedImageSelectionMode.Element;}},// Per una MaskedImage (e quindi FilledShape) ripercuote le modifiche fatte sull'elemento principale (main group)
// sugli elementi figli, in modo che questi siano allienati con tutte le trasformazioni e che il padre abbia quindi
// matice Identity
applyTransformationsToMaskImageSubItems:function(){var _this_1=this;var selectedMaskedImages=this.getSelectedImageItems().filter(function(i){return _this_1.isMaskedImage(i);});for(var i=0;i<selectedMaskedImages.length;i++){var item=selectedMaskedImages[i];if(!item.applyMatrix){var parentMatrix=item.matrix.clone();item.matrix=new this.paper.Matrix();var subItems=[];subItems.push(this.getMaskedImageShapeItem(item));subItems.push(this.getMaskedImageMaskItem(item));subItems.push(this.getMaskedImageRasterItem(item));subItems.forEach(function(si){si.matrix.prepend(parentMatrix);if(si.data.originalMatrix){si.data.originalMatrix.prepend(parentMatrix);}if(si.data.originalPosition){si.data.originalPosition=si.data.originalPosition.transform(parentMatrix);}if(si.data.originalParentMatrix){si.data.originalParentMatrix.prepend(parentMatrix);}});}}},// -------------------------------------------------------------
// Shapes
// -------------------------------------------------------------
// Una shape è caratterizzata da un Path SVG. Nella forma più semplice sarà rappresentata da un CompoundPath di Paper JS.
// Una shape può essere utilizzata per 2 scopi fondamentali: semplice forma e forma riempita con immagine.
// Il secondo caso verrà trattato come caso particolare di MaskedImage, avendono le stesse caratteristiche, chiamato FilledShape.
// Una fomra semplice, in un template, potrà essere indicato come "image placeholder". In tal caso il riempimento della forma
// sarà un colore quasi bianco e comparirà l'icona di una macchina fotografica ad indicare la scelta dell'immagine per il contenuto.
// Metodo di utilità per inserire una shape casuale
insertRandomShape:function(options){return __awaiter(this,void 0,void 0,function(){var opts,shape;return __generator(this,function(_a){switch(_a.label){case 0:opts=options||{isImagePlaceholder:true,style:{strokeColor:"black",strokeWidth:2,fillColor:"darkred"}};return[4/*yield*/,this._loadRandomShapeAsync()];case 1:shape=_a.sent();return[4/*yield*/,this.insertShape(shape,opts)];case 2:return[2/*return*/,_a.sent()];}});});},// Metodo per l'inserimento di una nuova shape
insertShape:function(shape,options){return __awaiter(this,void 0,void 0,function(){var item,path_str,area,designEffect,originalStrokeColor,originalFillColor,designItem,areaItem,delta,matrix,itemBounds,areaBounds,targetBounds,sx,sy,signx,signy;return __generator(this,function(_a){switch(_a.label){case 0:item=null;if(!options)return[2/*return*/];if(!this.canAddShape())return[2/*return*/,item];this.beginDesignOperation();return[4/*yield*/,this._loadShapePathDataAsync(shape)];case 1:path_str=_a.sent();if(path_str){if(this.side){area=this.side.get("areas").getMaxArea();if(area){designEffect=this.getDesignEffectForArea(area);originalStrokeColor=options.style.strokeColor;originalFillColor=options.style.fillColor;originalStrokeColor=this.forceColorInFixedPalette(null,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(null,originalFillColor);options.style.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);options.style.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);item=new this.paper.CompoundPath(path_str);this.applyStyleToItem(item,options.style);item.data={};item.data.isShape=true;item.data.originalBounds=item.bounds;item.data.originalMatrix=new this.paper.Matrix();item.data.originalPosition=item.position;// Salvo i colori originali in modo da riapplicare l'effetto su questi colori
item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.isImagePlaceholder=options.isImagePlaceholder;this.applyDesignEffectToItem(designEffect,item);designItem=this.onShapeItemCreated(item,shape,options);areaItem=this.findItemForArea(area);if(areaItem){delta=areaItem.position.subtract(item.position);item.position.x+=delta.x;item.position.y+=delta.y;matrix=new this.paper.Matrix().translate(delta.x,delta.y);item.data.originalMatrix.prepend(matrix);item.data.originalPosition=item.data.originalPosition.transform(matrix);itemBounds=item.bounds;areaBounds=areaItem.bounds;if(areaBounds.intersects(itemBounds)||itemBounds.contains(areaBounds)){targetBounds=areaBounds.clone();targetBounds.width*=0.8;targetBounds.height*=0.8;sx=1.0;sy=1.0;if(Math.abs(targetBounds.width)>0.0000001)sx=targetBounds.width/itemBounds.width;if(Math.abs(targetBounds.height)>0.0000001)sy=targetBounds.height/itemBounds.height;signx=sx>0?1:-1;signy=sy>0?1:-1;sx=sy=Math.min(Math.abs(sx),Math.abs(sy));sx*=signx;sy*=signy;item.scale(sx,sy);matrix=new this.paper.Matrix().scale(sx,sy);item.data.originalMatrix.prepend(matrix);item.data.originalPosition=item.data.originalPosition.transform(matrix);this.masterGroup.addChild(item);this.onItemUpdated(item);this.updateItemsIndexes();this.onDesignItemChanged(item);this.fireShapeLoadedEvent();if(this.mask)this.mask.bringToFront();}}}}}this.endDesignOperation();return[2/*return*/,item];}});});},// Sostituisce la shape selezionata con quella in input
replaceSelectedShape:function(shape,options){return __awaiter(this,void 0,void 0,function(){var items,item;return __generator(this,function(_a){switch(_a.label){case 0:if(!options||!this.design)return[2/*return*/];items=this.getSelectedShapeItems();if(!(items&&items.length>0))return[3/*break*/,2];item=items[0];if(!this.canEditItem(item))return[2/*return*/];return[4/*yield*/,this.replaceShape(item,shape,options)];case 1:_a.sent();_a.label=2;case 2:return[2/*return*/];}});});},replaceShapeByGuid:function(guid,shape,options){return __awaiter(this,void 0,void 0,function(){var item;return __generator(this,function(_a){switch(_a.label){case 0:item=this.findItemByGuid(guid);if(!item)return[3/*break*/,2];return[4/*yield*/,this.replaceShape(item,shape,options)];case 1:return[2/*return*/,_a.sent()];case 2:return[2/*return*/,null];}});});},// Sostituisce la shape indicata (item) con quella in input (shape)
replaceShape:function(item,shape,options){return __awaiter(this,void 0,void 0,function(){var shapeItem,path_str,designItem,designEffect,currentStyle,newStrokeColor,newStrokeWidth,newFillColor,originalStrokeColor,originalFillColor,oldWidth,oldHeight,newItem,data,newWidth,newHeight,sx,sy,matrix,imageModel;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.canEditItem(item))return[2/*return*/,item];this.beginDesignOperation();shapeItem=this.isShape(item)?item:this.getMaskedImageShapeItem(item);if(!shapeItem)return[2/*return*/,item];return[4/*yield*/,this._loadShapePathDataAsync(shape)];case 1:path_str=_a.sent();if(path_str){designItem=this.findDesignItemByGuid(item.data.guid);if(designItem){designEffect=this.getDesignEffectForDesignItem(designItem);currentStyle=this.getShapeItemStyle(shapeItem);newStrokeColor=currentStyle.strokeColor;if(this.canChangeShapeStrokeColor(item)&&options.style.strokeColor!=undefined)newStrokeColor=options.style.strokeColor;options.style.strokeColor=newStrokeColor;newStrokeWidth=currentStyle.strokeWidth;if(this.canChangeShapeStrokeWidth(item)&&options.style.strokeWidth!=undefined&&options.style.strokeWidth!=null)newStrokeWidth=options.style.strokeWidth;options.style.strokeWidth=newStrokeWidth;newFillColor=currentStyle.fillColor;if(this.canChangeShapeFillColor(item)&&options.style.fillColor!=undefined)newFillColor=options.style.fillColor;options.style.fillColor=newFillColor;originalStrokeColor=options.style["strokeWidth"]!=undefined?options.style.strokeColor:undefined;originalFillColor=options.style.fillColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(item,originalFillColor);options.style.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);options.style.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);oldWidth=item.bounds.width;oldHeight=item.bounds.height;newItem=new this.paper.CompoundPath(path_str);newItem.visible=false;this.applyStyleToItem(newItem,options.style);newItem.transform(item.data.originalMatrix);newItem.position=item.position;item.removeChildren();item.copyContent(newItem);data=item.data;item.copyAttributes(newItem);item.data=data;item.visible=true;item.data.originalStrokeColor=originalStrokeColor;item.data.originalFillColor=originalFillColor;item.data.isImagePlaceholder=options.isImagePlaceholder;newItem.remove();newWidth=item.bounds.width;newHeight=item.bounds.height;sx=1.0;sy=1.0;if(newWidth>0&&Math.abs(oldWidth)>0.0000001)sx=oldWidth/newWidth;if(newHeight>0&&Math.abs(oldHeight)>0.0000001)sy=oldHeight/newHeight;item.scale(sx,sy);matrix=new this.paper.Matrix().scale(sx,sy);item.data.originalMatrix.prepend(matrix);imageModel=this.createDummyImageFromDesignItem(designItem);this.onShapeItemUpdated(item,shape,imageModel);this.updateSelectionState();this.paper.project.view.update();this.fireShapeLoadedEvent();}}this.endDesignOperation();return[2/*return*/];}});});},// Modifica esclusivamente lo stile del contorno e riempimento della shape
changeShapeStyle:function(item,style){if(!this.canEditItem(item))return;if(!this.isShape(item)&&!this.isFilledShape(item))return;var shape=this.isShape(item)?item:this.getMaskedImageShapeItem(item);if(!shape)return;// sottopongo lo stile ai vincoli
var currentStyle=this.getShapeItemStyle(shape);var newStrokeColor=currentStyle.strokeColor;if(this.canChangeShapeStrokeColor(item)&&style.strokeColor!=undefined)newStrokeColor=style.strokeColor;style.strokeColor=newStrokeColor;var newStrokeWidth=currentStyle.strokeWidth;if(this.canChangeShapeStrokeWidth(item)&&style.strokeWidth!=undefined&&style.strokeWidth!=null)newStrokeWidth=style.strokeWidth;style.strokeWidth=newStrokeWidth;var newFillColor=currentStyle.fillColor;if(this.canChangeShapeFillColor(item)&&style.fillColor!=undefined)newFillColor=style.fillColor;style.fillColor=newFillColor;if(item&&item instanceof this.paper.Item){this.beginDesignOperation();var designItem=this.findDesignItemByGuid(item.data.guid);// Modifico i colori in base all'eventuale effetto
var designEffect=this.getDesignEffectForDesignItem(designItem);var originalStrokeColor=style.strokeColor;var originalFillColor=style.fillColor;originalStrokeColor=this.forceColorInFixedPalette(item,originalStrokeColor);originalFillColor=this.forceColorInFixedPalette(item,originalFillColor);style.strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);style.fillColor=this.applyDesignEffectToTextColor(designEffect,originalFillColor);this.applyStyleToItem(item,style);shape.data.originalStrokeColor=originalStrokeColor;shape.data.originalFillColor=originalFillColor;this.onItemUpdated(item);this.endDesignOperation();}},updateShapeImagePlaceholders:function(items){var _this_1=this;items.forEach(function(item){_this_1.updateShapeImagePlaceholder(item);});},_removeShapesReferenceBounds:function(){if(this.shapesReferenceBounds)this.shapesReferenceBounds.forEach(function(b){return b.remove();});this.shapesReferenceBounds=[];},// Metodo di debug per visualizzare i bounding box relativi alle shapes
_updateShapesReferenceBounds:function(){this.removeShapesReferenceBounds();var items=this.getAllShapeItems();for(var i=0;i<items.length;i++){var item=items[i];var shape=null;if(this.isFilledShape(item)){shape=this.getMaskedImageShapeItem(item);}else if(this.isShape(item)){shape=item;}if(shape&&shape.data&&shape.data.originalBounds&&shape.data.originalMatrix&&shape.data.originalPosition){var shapeBounds=new this.paper.Path.Rectangle(shape.data.originalBounds);shapeBounds.strokeColor="red";shapeBounds.strokeWidth=3;shapeBounds.matrix=shape.data.originalMatrix;shapeBounds.position=shape.data.originalPosition.clone();this.shapesReferenceBounds.push(shapeBounds);var shapeCenter=new this.paper.Path.Circle(shape.data.originalPosition,5);shapeCenter.fillColor="red";this.shapesReferenceBounds.push(shapeCenter);var shapeClone=shape.clone();var rotationPoint=shapeClone.position.clone();shapeClone.rotate(-shape.data.originalMatrix.rotation,rotationPoint);var bbox=shapeClone.bounds;shapeClone.remove();var boundingBox=new this.paper.Path.Rectangle(bbox);boundingBox.strokeColor="blue";boundingBox.strokeWidth=3;boundingBox.rotate(shape.data.originalMatrix.rotation,rotationPoint);this.shapesReferenceBounds.push(boundingBox);}}},// Ridisegna il placeholder di una shape indicata come "image placeholder"
updateShapeImagePlaceholder:function(item){var _this_1=this;this.removeShapeImagePlaceholder(item);if(item instanceof this.paper.CompoundPath&&item.data&&item.data.isShape&&item.data.isImagePlaceholder&&!item.data.isMaskedImageShape){// Costruisco un path equivalente ma riempito di bianco
var clone=item.clone();delete clone.data.guid;clone.data.isShapePlaceholderPath=true;clone.guide=true;clone.data.shapeGuid=item.data.guid;clone.opacity=1;clone.blendMode="normal";clone.strokeColor="none";clone.strokeWidth=0;clone.fillColor="#ededed";clone.onMouseEnter=function(){return _this_1.paper.project.view.element.style.setProperty('cursor','pointer');};clone.onMouseLeave=function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);};var iconPosition=clone.interiorPoint;var iconFiller=new this.paper.Path.Circle(iconPosition,this.shapeImagePlaceholderIconFillerSize);iconFiller.fillColor="#ededed";iconFiller.data.isShapePlaceholderIcon=true;iconFiller.data.shapeGuid=item.data.guid;iconFiller.onMouseEnter=function(){return _this_1.paper.project.view.element.style.setProperty('cursor','pointer');};iconFiller.onMouseLeave=function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);};iconFiller.onMouseUp=function(){return _this_1.fireFillShapeRequestedEvent({itemGuid:item.data.guid});};// icona
var icon=new this.paper.CompoundPath(this.shapeImagePlaceholderIconPathd);// Calculate the size of the camera icon based on the size of the shape
// this is to avoid a really small camera on a large shape
// but the camera icon is still resized based on zoom
var itemWidth=clone.bounds.width;var percentage=itemWidth/icon.bounds.width;var scale=percentage>6?2:1;icon.data.isShapePlaceholderIcon=true;icon.data.shapeGuid=item.data.guid;icon.fillColor="#222222";var zoomValue=this.paper.view.zoom>0.25?this.paper.view.zoom:3*this.paper.view.zoom;icon.scaling=new this.paper.Size(scale/zoomValue,scale/zoomValue);icon.onMouseEnter=function(){return _this_1.paper.project.view.element.style.setProperty('cursor','pointer');};icon.onMouseLeave=function(){return _this_1.paper.project.view.element.style.setProperty('cursor',null);};icon.onMouseUp=function(){return _this_1.fireFillShapeRequestedEvent({itemGuid:item.data.guid});};icon.position=iconPosition;clone.insertAbove(item);icon.insertAbove(clone);iconFiller.insertAbove(clone);}},removeShapeImagePlaceholder:function(item){var items=this.getShapeImagePlaceholderElements(item);items.forEach(function(i){return i.remove();});},getShapeImagePlaceholderElements:function(item){var items=[];if(item&&item.data&&item.data.guid){var addChildren=function(parent){if(parent.data&&(parent.data.isShapePlaceholderPath||parent.data.isShapePlaceholderIcon)&&parent.data.shapeGuid==item.data.guid)items.push(parent);if(parent.children){for(var j=parent.children.length-1;j>=0;j--){var child=parent.children[j];addChildren(child);}}};for(var i=0;i<this.paper.project.layers.length;i++){var layer=this.paper.project.layers[i];if(layer.guide)continue;addChildren(layer);}}return items;},isShape:function(item){return item&&item.data&&item.data.isShape;},getShapeItemStyle:function(item){var style=undefined;if(!item)return style;var shapeItem=this.isShape(item)?item:this.getMaskedImageShapeItem(item);if(shapeItem){style={};if(item.strokeColor)style.strokeColor=shapeItem.strokeColor.toCSS(true);style.strokeWidth=shapeItem.strokeWidth;style.strokeCap=shapeItem.strokeCap;style.strokeJoin=shapeItem.strokeJoin;style.dashArray=shapeItem.dashArray;style.dashOffset=shapeItem.dashOffset;if(shapeItem.fillColor)style.fillColor=shapeItem.fillColor.toCSS(true);if(shapeItem.data.hasOwnProperty("originalStrokeColor"))style.strokeColor=shapeItem.data.originalStrokeColor;if(item.data.hasOwnProperty("originalFillColor"))style.fillColor=shapeItem.data.originalFillColor;}return style;},// -------------------------------------------------------
// Filles Shapes
// -------------------------------------------------------
// Una Filled Shape viene trattata come caso particolare di Masked Image
isFilledShape:function(item){return this.isMaskedImage(item)&&item.data&&item.data.isFilledShape;},isImagePlaceholder:function(item){return this.isShape(item)&&!this.isFilledShape(item)&&item.data&&item.data.isImagePlaceholder;},// Metodo per riempire una shape con un immagine. Nel caso in cui l'elemento sia una già una Filled Shape
// l'immagine di riempimento viene sostituita con quella in input. E' possibile anche specificare un mapping dei colori
// per forzare una riduzione dei colori dell'immagine.
fillShapeItemWithImageAsync:function(shapeItem,image,colorMappings){return __awaiter(this,void 0,void 0,function(){var operationId,newItem;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.canEditItem(shapeItem))return[2/*return*/,shapeItem];if(!this.isShape(shapeItem)&&!this.isFilledShape(shapeItem))return[2/*return*/,shapeItem];if(this.isImagePlaceholder(shapeItem))this.changeShapeImagePlaceholder(shapeItem,false);operationId=this.getLastUndoOperationId();this.beginDesignOperation();newItem=shapeItem;if(!!image)return[3/*break*/,1];newItem=this.removeImageFromShape(shapeItem);return[3/*break*/,5];case 1:if(!this.isFilledShape(shapeItem))return[3/*break*/,3];return[4/*yield*/,this.updateFilledShapeAsync(shapeItem,image,colorMappings)];case 2:newItem=_a.sent();return[3/*break*/,5];case 3:if(!this.isShape(shapeItem))return[3/*break*/,5];return[4/*yield*/,this.createFilledShapeAsync(shapeItem,image,colorMappings)];case 4:newItem=_a.sent();_a.label=5;case 5:this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);return[2/*return*/,newItem];}});});},// Metodo per creare una nuova filled shape. Qui l'item deve essere una shape semplice
createFilledShapeAsync:function(shapeItem,image,colorMappings){return __awaiter(this,void 0,void 0,function(){var url,designItem,designEffect,selected,itemParent,originalUrl,rasterItem,targetBounds,rotationMatrix_1,position,shapeClone,rotationPoint,bbox,boundingBox,sx,sy,mask,originalStrokeColor,strokeColor,clipGroup,mainGroup,shapeModel;return __generator(this,function(_a){switch(_a.label){case 0:if(!this.isShape(shapeItem))return[2/*return*/,shapeItem];if(!image||!(image instanceof MPlaza.Image))return[2/*return*/,shapeItem];// Devo avere anche il permesso di aggiungere immagini
// Commentata perché una fillable shape deve essere riempibile a prescindere dal valore di canAddImage
//if (!this.canAddImage())
//  return shapeItem;
// Se non è un placeholder allora il riempimento della shape con immagini deve essere abilitato
if(!(shapeItem.data&&shapeItem.data.isImagePlaceholder)&&!this.canFillShape(shapeItem))return[2/*return*/,shapeItem];url="";if(!this.isImageScalingEnabled&&image.get("format").toLowerCase()!="svg"&&image.get("type").toLowerCase()!="vector"&&["png","jpg","jpeg"].find(function(x){return x==image.get("format").toLowerCase();}))url=image.get("url");if(!url)url=image.get("previewUrl");if(!url)return[2/*return*/,shapeItem];if(!(shapeItem&&shapeItem instanceof this.paper.CompoundPath&&shapeItem.data&&shapeItem.data.isShape))return[3/*break*/,7];designItem=this.findDesignItemForItem(shapeItem);if(!designItem)return[3/*break*/,7];designEffect=this.getDesignEffectForDesignItem(designItem);selected=this.isItemSelected(shapeItem);itemParent=shapeItem.parent;originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,shapeItem)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:return[4/*yield*/,this.createRasterItem(url,false)];case 6:rasterItem=_a.sent();rasterItem.data.originalUrl=originalUrl;this.applyDesignEffectToItem(designEffect,rasterItem);targetBounds=shapeItem.bounds.clone();rotationMatrix_1=new this.paper.Matrix();position=shapeItem.position;if(shapeItem.data.originalBounds&&shapeItem.data.originalMatrix&&shapeItem.data.originalPosition){shapeClone=shapeItem.clone();rotationPoint=shapeClone.position.clone();shapeClone.rotate(-shapeItem.data.originalMatrix.rotation,rotationPoint);bbox=shapeClone.bounds;targetBounds=bbox.clone();shapeClone.remove();boundingBox=new this.paper.Path.Rectangle(bbox);boundingBox.rotate(shapeItem.data.originalMatrix.rotation,rotationPoint);position=boundingBox.position;boundingBox.remove();// mantengo la rotazione applicata alla shape
rotationMatrix_1.rotate(shapeItem.data.originalMatrix.rotation);if(shapeItem.data.flips)// Flips salvati a parte perché coinvolgono anche lo scaling
shapeItem.data.flips.forEach(function(f){return f=="X"?rotationMatrix_1.scale(-1,-1):rotationMatrix_1.scale(1,-1);});}sx=1.0;sy=1.0;if(targetBounds.width>0.0000001&&rasterItem.bounds.width>0)sx=targetBounds.width/rasterItem.bounds.width;if(targetBounds.height>0.0000001&&rasterItem.bounds.height>0)sy=targetBounds.height/rasterItem.bounds.height;sx=sy=Math.max(Math.abs(sx),Math.abs(sy));rasterItem.scale(sx,sy);rasterItem.matrix.prepend(rotationMatrix_1);rasterItem.position=position;rasterItem.data.originalBounds=new this.paper.Rectangle(0,0,rasterItem.width,rasterItem.height);rasterItem.data.originalMatrix=rasterItem.matrix.clone();// Ora ho tutti gli elementi per costruire una MaskedImage
shapeItem.fillColor=null;shapeItem.originalParentMatrix=new this.paper.Matrix();shapeItem.data.isMaskedImageShape=true;mask=shapeItem.clone();mask.data={};mask.position=shapeItem.position;mask.data.isMaskedImageMask=true;originalStrokeColor=shapeItem.data.originalStrokeColor!=undefined?shapeItem.data.originalStrokeColor:undefined;originalStrokeColor=this.forceColorInFixedPalette(shapeItem,originalStrokeColor);strokeColor=this.applyDesignEffectToTextColor(designEffect,originalStrokeColor);shapeItem.strokeColor=strokeColor;shapeItem.data.originalStrokeColor=originalStrokeColor;clipGroup=new this.paper.Group(mask,rasterItem);clipGroup.clipped=true;clipGroup.data.isMaskedImageClipGroup=true;rasterItem.visibile=true;mainGroup=new this.paper.Group(clipGroup,shapeItem);mainGroup.applyMatrix=false;mainGroup.data.guid=shapeItem.data.guid;delete shapeItem.data.guid;mainGroup.data.isMaskedImageMainGroup=true;mainGroup.data.isFilledShape=true;mainGroup.data.originalBounds=shapeItem.bounds;mainGroup.data.originalMatrix=new this.paper.Matrix();if(shapeItem.data.maskPath)shapeItem.data.maskPath.remove();if(shapeItem.data.maskAlertPath)shapeItem.data.maskAlertPath.remove();this.applyDesignEffectToItem(designEffect,mainGroup,true);itemParent.addChild(mainGroup);shapeModel=this.createDummyShapeFromDesignItem(designItem);this.onImageItemUpdated(mainGroup,image,shapeModel);shapeItem.data.selected=false;mainGroup.data.selected=selected;this.updateSelectionState();this.updateShapeImagePlaceholder(mainGroup);this.updateItemsIndexes();this.updateDesignItemColorMappings(designItem,colorMappings);return[2/*return*/,mainGroup];case 7:return[2/*return*/,shapeItem];}});});},// Metodo per sostituire una filled shape con l'immagine 
updateFilledShapeAsync:function(item,image,colorMappings){return __awaiter(this,void 0,void 0,function(){var shape,raster,url,designItem,currentImageID,designEffect,originalUrl,targetBounds,rotationMatrix_2,position,shapeClone,rotationPoint,bbox,boundingBox,sx,sy;return __generator(this,function(_a){switch(_a.label){case 0:if(!image||!(image instanceof MPlaza.Image))return[2/*return*/,item];if(!this.isFilledShape(item))return[2/*return*/,item];shape=this.getMaskedImageShapeItem(item);raster=this.getMaskedImageRasterItem(item);// Se non è un placeholder allora il riempimento della shape con immagini deve essere abilitato
if(!(shape.data&&shape.data.isImagePlaceholder)&&!this.canReplaceShapeFilling(item))return[2/*return*/,item];url="";if(!this.isImageScalingEnabled&&image.get("format").toLowerCase()!="svg"&&image.get("type").toLowerCase()!="vector"&&["png","jpg","jpeg"].find(function(x){return x==image.get("format").toLowerCase();}))url=image.get("url");if(!url)url=image.get("previewUrl");if(!url)return[2/*return*/,item];this.applyTransformationsToMaskImageSubItems(item);designItem=this.findDesignItemByGuid(item.data.guid);if(!designItem)return[3/*break*/,7];currentImageID=designItem.get("imageID");if(!(currentImageID!==image.get("imageID")))return[3/*break*/,7];if(!raster)return[3/*break*/,7];designEffect=this.getDesignEffectForDesignItem(designItem);originalUrl=url;return[4/*yield*/,this.applyDesignEffectToImageUrl(designEffect,url)];case 1:url=_a.sent();if(!!colorMappings)return[3/*break*/,3];return[4/*yield*/,this.getImageDefaultColorMappings(url,item)];case 2:colorMappings=_a.sent();_a.label=3;case 3:if(!(colorMappings&&colorMappings.length>0))return[3/*break*/,5];return[4/*yield*/,this.recolorImage(url,colorMappings)];case 4:url=_a.sent();_a.label=5;case 5:// ---------------
return[4/*yield*/,this.changeRasterItem(raster,url)];case 6:// ---------------
_a.sent();raster.matrix=new this.paper.Matrix();raster.data.originalUrl=originalUrl;// Test Design Effect on item
this.applyDesignEffectToItem(designEffect,item);targetBounds=item.bounds.clone();rotationMatrix_2=new this.paper.Matrix();position=item.position;if(shape.data.originalBounds&&shape.data.originalMatrix&&shape.data.originalPosition){shapeClone=shape.clone();rotationPoint=shapeClone.position.clone();shapeClone.rotate(-shape.data.originalMatrix.rotation,rotationPoint);bbox=shapeClone.bounds;targetBounds=bbox.clone();shapeClone.remove();boundingBox=new this.paper.Path.Rectangle(bbox);boundingBox.rotate(shape.data.originalMatrix.rotation,rotationPoint);position=boundingBox.position;boundingBox.remove();// mantengo la rotazione applicata alla shape
rotationMatrix_2.rotate(shape.data.originalMatrix.rotation);if(shape.data.flips)shape.data.flips.forEach(function(f){return f=="X"?rotationMatrix_2.scale(-1,-1):rotationMatrix_2.scale(1,-1);});}sx=1.0;sy=1.0;if(targetBounds.width>0.0000001&&raster.bounds.width>0)sx=targetBounds.width/raster.bounds.width;if(targetBounds.height>0.0000001&&raster.bounds.height>0)sy=targetBounds.height/raster.bounds.height;sx=sy=Math.max(Math.abs(sx),Math.abs(sy));raster.scale(sx,sy);raster.matrix.prepend(rotationMatrix_2);raster.position=position;raster.data.originalBounds=new this.paper.Rectangle(0,0,raster.width,raster.height);raster.data.originalMatrix=raster.matrix.clone();this.onImageItemUpdated(item,image,this.createDummyShapeFromDesignItem(designItem));this.updateDesignItemColorMappings(designItem,colorMappings);this.updateSelectionState();this.paper.project.view.update();this.fireImageLoadedEvent();_a.label=7;case 7:return[2/*return*/,item];}});});},// Se l'elemento è una Filled Shape, elimina l'immagine di riempimento e restitusice la shape semplice
removeImageFromShape:function(item,image){var newItem=item;if(item&&this.isFilledShape(item)){var selected=this.isItemSelected(item);var itemParent=item.parent;var designItem=this.findDesignItemForItem(item);var shapeItem=this.getMaskedImageShapeItem(item);// se non si tratta di un placeholder la cancellazione dell'immagine dalla shape deve essere abilitata
if(!(shapeItem.data&&shapeItem.data.isImagePlaceholder)&&!this.canDeleteShapeFilling(item))return item;if(designItem&&shapeItem){var designEffect=this.getDesignEffectForDesignItem(designItem);var matrix=item.matrix;newItem=shapeItem;newItem.data.guid=item.data.guid;itemParent.addChild(newItem);item.remove();var strokeColor=shapeItem.data.originalStrokeColor||shapeItem.strokeColor;var fillColor=shapeItem.data.originalFillColor||shapeItem.fillColor;strokeColor=this.forceColorInFixedPalette(item,strokeColor);fillColor=this.forceColorInFixedPalette(item,fillColor);shapeItem.data.originalStrokeColor=strokeColor;shapeItem.data.originalFillColor=fillColor;strokeColor=this.applyDesignEffectToTextColor(designEffect,strokeColor);fillColor=this.applyDesignEffectToTextColor(designEffect,fillColor);newItem.strokeColor=strokeColor;newItem.fillColor=fillColor;newItem.data.isMaskedImageShape=false;this.applyDesignEffectToItem(designEffect,shapeItem);newItem.matrix.prepend(matrix);if(newItem.data.originalMatrix)newItem.data.originalMatrix.prepend(matrix);var shapeModel=this.createDummyShapeFromDesignItem(designItem);this.onShapeItemUpdated(newItem,shapeModel,null);this.updateDesignItemColorMappings(designItem,[]);if(selected&&this.maskedImageSelectionMode!=MaskedImageSelectionMode.Element)this.maskedImageSelectionMode=MaskedImageSelectionMode.Element;item.data.selected=false;newItem.data.selected=selected;this.updateSelectionState();this.changeShapeImagePlaceholder(newItem,true);}}return newItem;},changeShapeImagePlaceholder:function(item,isImagePlaceholder){if(isImagePlaceholder){this.setImagePlaceholder(item);}else{this.unsetImagePlaceholder(item);}},setImagePlaceholder:function(item){if(!this.isShape(item)&&!this.isFilledShape(item))return;var designItem=this.findDesignItemForItem(item);if(!designItem)return;var operationId=this.getLastUndoOperationId();this.beginDesignOperation();var shapeItem=this.isShape(item)?item:this.removeImageFromShape(item);if(shapeItem){shapeItem.data.isImagePlaceholder=true;var imageModel=this.createDummyImageFromDesignItem(designItem);var shapeModel=this.createDummyShapeFromDesignItem(designItem);this.onShapeItemUpdated(item,shapeModel,imageModel);this.updateSelectionState();this.paper.project.view.update();}this.endDesignOperation();this.mergeAllUndoOperationsAfterId(operationId);},unsetImagePlaceholder:function(item){if(!this.isShape(item))return;if(!item.data.isImagePlaceholder)return;var designItem=this.findDesignItemForItem(item);if(!designItem)return;this.beginDesignOperation();item.data.isImagePlaceholder=false;var imageModel=this.createDummyImageFromDesignItem(designItem);var shapeModel=this.createDummyShapeFromDesignItem(designItem);this.onShapeItemUpdated(item,shapeModel,imageModel);this.updateSelectionState();this.paper.project.view.update();this.endDesignOperation();},// ShadowOffset - Distance - Angle converters
getOffsetDistance:function(offset){if(offset&&offset instanceof paper.Point)return Math.round(offset.length);return 0;},getOffsetAngle:function(offset){if(offset&&offset instanceof paper.Point){var angle=offset.angle;if(angle<0)angle+=360;angle=Math.round(angle);return angle;}return 0;},getOffsetByDistanceAngle:function(distance,angle){if(distance===undefined||distance===null||angle===undefined||angle===null)return new this.paper.Point(0,0);return new this.paper.Point({length:distance,angle:angle});},updateTemplateItem:function(designItem){var json=JSON.parse(designItem.get('json'));json[1].data.isTemplateElement=true;if(json[1].data.isTextArea&&json[1].data.text)json[1].data.defaultPlaceHolderText=json[1].data.text;if(json[1].data.isTextArt){var textArt=designItem.get('textArt');json[1].data.defaultPlaceHolderText=textArt.attributes.text;}designItem.set('json',JSON.stringify(json));}};var Zakeke=Zakeke||{};Zakeke.generateUUID=function(){var d=new Date().getTime();var uuid='xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=(d+Math.random()*16)%16|0;d=Math.floor(d/16);return(c==='x'?r:r&0x7|0x8).toString(16);});return uuid;};Zakeke.getEmptyUUID=function(){return'00000000-0000-0000-0000-000000000000';};Zakeke.makeID=function(length){var text="";var possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(var i=0;i<length;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text;};Zakeke.ShaderInputType={Float:1,Int:2,Texture:3,Array2:4,Array3:5,Color3:6,Color4:7,Matrix:8,Matrix2x2:9,Matrix3x3:10,Vector2:11,Vector3:12,Vector4:13};Zakeke.ShaderOptionType={Attribute:1,Uniform:2,Sampler:3};Zakeke.IncrementalFileInfo=function(){this.name="";this.data=null;this.isScene=false;this.dracoEncoded=false;};Zakeke.TextureUsage={Any:0,Desktop:1,Mobile:2};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneCameraConfig
// -----------------------------------------------------------
Zakeke.SceneCameraConfig=Backbone.AssociatedModel.extend({defaults:{/*
        autoRotate: bool
        contrast: number // 1.6 by default
        exposure: float // 0.8 by default
        toneMappingEnabled: bool
        positionScale: float
        limitLowerRadius: bool
        zoomEnabled: bool
        useMinZoomPerc: bool
        minZoomPerc: float
        useMaxZoomPerc: bool
        maxZoomPerc: float
        fixedAlphaAngle: float
        fixedBetaAngle: float
        useLowerAlphaLimit: bool
        lowerAlphaLimit: float
        useUpperAlphaLimit: bool
        upperAlphaLimit: float
        useLowerBetaLimit: bool
        lowerBetaLimit: float
        useUpperBetaLimit: bool
        upperBetaLimit: float
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneGroundConfig
// -----------------------------------------------------------
Zakeke.SceneGroundConfig=Backbone.AssociatedModel.extend({defaults:{createGround:false/*
        size: number
        texture: string
        color: string
        opacity: number
        enableShadow: bool
        shadowLevel: number // 0.5 by default
        enableMirror: bool
        mirrorBlurKernel: number // 64 by default
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneSkyboxConfig
// -----------------------------------------------------------
Zakeke.SceneSkyboxConfig=Backbone.AssociatedModel.extend({defaults:{createSkybox:false/*
        size: number
        texture: string
        extensions: string[]
        files: string[]
        color: string
        blur: number
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneEnvironmentConfig
// -----------------------------------------------------------
Zakeke.SceneEnvironmentConfig=Backbone.AssociatedModel.extend({defaults:{skybox:null,ground:null/*
        sizeAuto: bool
        mainColor: string
        */},initialize:function(){if(this.get("skybox"))this.get("skybox").parentModel=this;if(this.get("ground"))this.get("ground").parentModel=this;},relations:[{type:Backbone.One,key:'skybox',relatedModel:Zakeke.SceneSkyboxConfig},{type:Backbone.One,key:'ground',relatedModel:Zakeke.SceneGroundConfig}],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneGeneralConfig
// -----------------------------------------------------------
Zakeke.SceneGeneralConfig=Backbone.AssociatedModel.extend({defaults:{/*
        backgroundAlpha: number
        backgroundColor: string
        environmentTexture: string
        matchSameNameTextures: bool
        antialiasEnabled: bool
        arEnabled: bool
        arScale: bool
        infoPointsEnabled: bool
        useDelayedTextureLoading: bool
        useDelayedMaterialLoading: bool
        useMaterialOffloading: bool
        prefetchMeshes: bool
        prefetchMaterials: bool
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneGlowConfig
// -----------------------------------------------------------
Zakeke.SceneGlowConfig=Backbone.AssociatedModel.extend({defaults:{/*
        enabled: bool
        intensity: number
        blurSize: number
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneInfoPointsStyleConfig
// -----------------------------------------------------------
Zakeke.SceneInfoPointsStyleConfig=Backbone.AssociatedModel.extend({defaults:{/*
        borderColor: string
        innerPointColor: string
        color: string
        highlightColor: string
        */},initialize:function(){},relations:[],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneInfoPointsConfig
// -----------------------------------------------------------
Zakeke.SceneInfoPointsConfig=Backbone.AssociatedModel.extend({defaults:{pointsStyle:null/*
        enabled: bool
        */},initialize:function(){if(this.get("pointsStyle"))this.get("pointsStyle").parentModel=this;},relations:[{type:Backbone.One,key:'pointsStyle',relatedModel:Zakeke.SceneInfoPointsStyleConfig}],getParentModel:function(){return this.parentModel;},toString:function(){}});// -----------------------------------------------------------
// SceneConfig
// -----------------------------------------------------------
Zakeke.SceneConfig=Backbone.AssociatedModel.extend({defaults:{general:null,environment:null,camera:null,glow:null,infoPoints:null},initialize:function(){if(this.get("general"))this.get("general").parentModel=this;if(this.get("environment"))this.get("environment").parentModel=this;if(this.get("camera"))this.get("camera").parentModel=this;if(this.get("glow"))this.get("glow").parentModel=this;if(this.get("infoPoints"))this.get("infoPoints").parentModel=this;},relations:[{type:Backbone.One,key:'general',relatedModel:Zakeke.SceneGeneralConfig},{type:Backbone.One,key:'environment',relatedModel:Zakeke.SceneEnvironmentConfig},{type:Backbone.One,key:'camera',relatedModel:Zakeke.SceneCameraConfig},{type:Backbone.One,key:'glow',relatedModel:Zakeke.SceneGlowConfig},{type:Backbone.One,key:'infoPoints',relatedModel:Zakeke.SceneInfoPointsConfig}],getParentModel:function(){return this.parentModel;},toString:function(){}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneSourceTexture
// -----------------------------------------------------------
Zakeke.SceneSourceTexture=Backbone.AssociatedModel.extend({defaults:{fileObjectID:-1,url:""},idAttribute:"textureID",initialize:function(){},relations:[],getTextureID:function(){return this.get("textureID");},getSourceID:function(){if(this.collection&&this.collection.getSourceID){return this.collection.getSourceID();}return null;},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneSourceTextures
// -----------------------------------------------------------
Zakeke.SceneSourceTextures=Backbone.Collection.extend({model:Zakeke.SceneSourceTexture,getSourceID:function(){if(this.parentModel&&this.parentModel.getSourceID){return this.parentModel.getSourceID();}return null;},getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findTexture:function(textureID){for(var i=0;i<this.length;i++){var texture=this.at(i);if(texture.get("textureID")==textureID)return texture;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneSource
// -----------------------------------------------------------
Zakeke.SceneSource=Backbone.AssociatedModel.extend({defaults:{fileObjectID:-1,url:"",rootUrl:"",sceneFileName:"",textures:[]},idAttribute:"sourceID",initialize:function(){this.get("textures").parentModel=this;},relations:[{type:Backbone.Many,key:'textures',collectionType:Zakeke.SceneSourceTextures}],getSourceID:function(){return this.get("sourceID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneSources
// -----------------------------------------------------------
Zakeke.SceneSources=Backbone.Collection.extend({model:Zakeke.SceneSource,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findSource:function(sourceID){for(var i=0;i<this.length;i++){var sceneSource=this.at(i);if(sceneSource.get("sourceID")==sourceID)return sceneSource;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneShaderMaterial
// -----------------------------------------------------------
Zakeke.SceneShaderMaterial=Backbone.AssociatedModel.extend({defaults:{materialID:"",name:"",vertex:"",fragment:""},idAttribute:"materialID",initialize:function(){},relations:[],getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneShaderMaterials
// -----------------------------------------------------------
Zakeke.SceneShaderMaterials=Backbone.Collection.extend({model:Zakeke.SceneShaderMaterial,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findShaderMaterial:function(materialID){for(var i=0;i<this.length;i++){var shaderMaterial=this.at(i);if(shaderMaterial.get("materialID")==materialID)return shaderMaterial;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneTexture
// -----------------------------------------------------------
Zakeke.SceneTexture=Backbone.AssociatedModel.extend({defaults:{materialID:"",isDefaultEnvironment:false,fileObjectID:-1,url:"",usage:Zakeke.TextureUsage.Any},idAttribute:"textureID",initialize:function(){},relations:[],getTextureID:function(){return this.get("textureID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneTextures
// -----------------------------------------------------------
Zakeke.SceneTextures=Backbone.Collection.extend({model:Zakeke.SceneTexture,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findTexture:function(textureID){for(var i=0;i<this.length;i++){var texture=this.at(i);if(texture.get("textureID")==textureID)return texture;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneMaterialPhoto
// -----------------------------------------------------------
Zakeke.SceneMaterialPhoto=Backbone.AssociatedModel.extend({defaults:{materialID:"",displayOrder:0,fileObjectID:-1,url:""},idAttribute:"photoID",initialize:function(){},relations:[],getMaterialPhotoID:function(){return this.get("photoID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneMaterialPhotos
// -----------------------------------------------------------
Zakeke.SceneMaterialPhotos=Backbone.Collection.extend({model:Zakeke.SceneMaterialPhoto,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findMaterialPhoto:function(photoID){for(var i=0;i<this.length;i++){var photo=this.at(i);if(photo.get("photoID")===photoID)return photo;}return null;},getMaterialPhotoUrls:function(materialID){var urls=[];for(var i=0;i<this.length;i++){if(this.at(i).get("materialID")===materialID)urls.push(this.at(i).get("url"));}return urls;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneCameraLocation
// -----------------------------------------------------------
Zakeke.SceneCameraLocation=Backbone.AssociatedModel.extend({defaults:{name:"",px:0,py:0,pz:0,tx:0,ty:0,tz:0},idAttribute:"locationID",initialize:function(){if(!this.get("locationID")){this.set("locationID",Zakeke.generateUUID());}},relations:[],getLocationID:function(){return this.get("locationID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneCameraLocations
// -----------------------------------------------------------
Zakeke.SceneCameraLocations=Backbone.Collection.extend({model:Zakeke.SceneCameraLocation,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findCameraLocation:function(locationID){for(var i=0;i<this.length;i++){var cameraLocation=this.at(i);if(cameraLocation.get("locationID")==locationID)return cameraLocation;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneMeshLocation
// -----------------------------------------------------------
Zakeke.SceneMeshLocation=Backbone.AssociatedModel.extend({defaults:{name:"",tempImageFileKey:"",imageUrl:"",displayOrder:0,isCollapsed:false,isExploded:false,adjustCamera:true,data:[]},idAttribute:"locationID",initialize:function(){if(!this.get("locationID")){this.set("locationID",Zakeke.generateUUID());}},relations:[],getLocationID:function(){return this.get("locationID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneMeshLocations
// -----------------------------------------------------------
Zakeke.SceneMeshLocations=Backbone.Collection.extend({model:Zakeke.SceneMeshLocation,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findMeshLocation:function(locationID){for(var i=0;i<this.length;i++){var meshLocation=this.at(i);if(meshLocation.get("locationID")==locationID)return meshLocation;}return null;},getFirstExplodedMeshLocation:function(){for(var i=0;i<this.length;i++){var meshLocation=this.at(i);if(meshLocation.get("isExploded"))return meshLocation;}return null;},getFirstCollapsedMeshLocation:function(){for(var i=0;i<this.length;i++){var meshLocation=this.at(i);if(meshLocation.get("isCollapsed"))return meshLocation;}return null;},getOrCreateExplodedMeshLocation:function(){var meshLocation=this.getFirstExplodedMeshLocation();if(!meshLocation){meshLocation=new Zakeke.SceneMeshLocation();meshLocation.set("name","exploded");meshLocation.set("isExploded",true);this.push(meshLocation);}return meshLocation;},getOrCreateCollapsedMeshLocation:function(){var meshLocation=this.getFirstCollapsedMeshLocation();if(!meshLocation){meshLocation=new Zakeke.SceneMeshLocation();meshLocation.set("name","collapsed");meshLocation.set("isCollapsed",true);this.push(meshLocation);}return meshLocation;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneMaterialMapping
// -----------------------------------------------------------
Zakeke.SceneMaterialMapping=Backbone.AssociatedModel.extend({defaults:{libraryMaterialID:"",sceneMaterialID:""},initialize:function(){},relations:[],getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneMaterialMappings
// -----------------------------------------------------------
Zakeke.SceneMaterialMappings=Backbone.Collection.extend({model:Zakeke.SceneMaterialMapping,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},getMappingForSceneMaterial:function(sceneMaterialID){for(var i=0;i<this.length;i++){var mapping=this.at(i);if(mapping.get("sceneMaterialID")==sceneMaterialID)return mapping;}},getMappingsForLibraryMaterial:function(libraryMaterialID){var mappings=[];for(var i=0;i<this.length;i++){var mapping=this.at(i);if(mapping.get("libraryMaterialID")==libraryMaterialID)mappings.push(mapping);}return mappings;},getLibraryMaterialIDs:function(){var ids=[];var hash={};for(var i=0;i<this.length;i++){hash[this.at(i).get("libraryMaterialID")]=true;}for(var key in hash){ids.push(key);}return ids;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// SceneARFile
// -----------------------------------------------------------
Zakeke.SceneARFile=Backbone.AssociatedModel.extend({defaults:{fileType:"",url:""},idAttribute:"fileID",initialize:function(){if(!this.get("fileID")){this.set("fileID",Zakeke.generateUUID());}},getFileID:function(){return this.get("fileID");},getSceneID:function(){if(this.collection&&this.collection.getSceneID){return this.collection.getSceneID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// SceneARFiles
// -----------------------------------------------------------
Zakeke.SceneARFiles=Backbone.Collection.extend({model:Zakeke.SceneARFile,getSceneID:function(){if(this.parentModel&&this.parentModel.getSceneID){return this.parentModel.getSceneID();}return null;},findFile:function(fileID){for(var i=0;i<this.length;i++){var file=this.at(i);if(file.get("fileID")===fileID)return file;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Scene
// -----------------------------------------------------------
Zakeke.Scene=Backbone.AssociatedModel.extend({defaults:{name:"",//sceneJson: "",
fileObjectID:-1,url:"",rootUrl:"",sceneFileName:"",manifestFileObjectID:-1,sellerID:-1,imageData:null,imageUrl:"",useDefaultEnvironmentTexture:false,// cameraPositionScale: null,
cameraLimitLowerRadius:true,version:0,config:null,usedTextureUrls:null,sources:[],cameraLocations:[],materialMappings:[],textures:[],materialPhotos:[],shaderMaterials:[],meshLocations:[],arFiles:[]},idAttribute:"sceneID",getSceneID:function(){if(this.id!=undefined&&this.id!=null)return this.id;return this.get("tempSceneID");},initialize:function(){if(!this.get("tempSceneID"))this.set("tempSceneID",Zakeke.generateUUID());var scene=this;if(this.get("config"))this.get("config").parentModel=this;this.get("sources").parentModel=this;this.get('sources').url=function(){return scene.url()+'/'+scene.getSceneID()+'/sources';};this.get("cameraLocations").parentModel=this;this.get('cameraLocations').url=function(){return scene.url()+'/'+scene.getSceneID()+'/cameraLocations';};this.get("meshLocations").parentModel=this;this.get('meshLocations').url=function(){return scene.url()+'/'+scene.getSceneID()+'/meshLocations';};this.get("materialMappings").parentModel=this;this.get("textures").parentModel=this;this.get("materialPhotos").parentModel=this;this.get("shaderMaterials").parentModel=this;this.get("arFiles").parentModel=this;},relations:[{type:Backbone.One,key:'config',relatedModel:Zakeke.SceneConfig},{type:Backbone.Many,key:'sources',collectionType:Zakeke.SceneSources},{type:Backbone.Many,key:'cameraLocations',collectionType:Zakeke.SceneCameraLocations},{type:Backbone.Many,key:'meshLocations',collectionType:Zakeke.SceneMeshLocations},{type:Backbone.Many,key:'materialMappings',collectionType:Zakeke.SceneMaterialMappings},{type:Backbone.Many,key:'textures',collectionType:Zakeke.SceneTextures},{type:Backbone.Many,key:'materialPhotos',collectionType:Zakeke.SceneMaterialPhotos},{type:Backbone.Many,key:'shaderMaterials',collectionType:Zakeke.SceneShaderMaterials},{type:Backbone.Many,key:'arFiles',collectionType:Zakeke.SceneARFiles}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'scenes';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},toString:function(){// todo.......
},getSceneFileUploadUrl:function(){return Zakeke.config.baseApiUrl+'scenes/'+this.getSceneID()+'/scenefile';},getSceneRootUrlApiUrl:function(){return Zakeke.config.baseApiUrl+'scenes/'+this.getSceneID()+'/rooturl';},getSceneIncrementalFileUploadUrl:function(){var url=this.getSceneFileUploadUrl();url+="?incremental=true";return url;},getSourceUrl:function(sourceID){return Zakeke.config.baseApiUrl+'scenes/'+this.getSceneID()+'/sources/'+sourceID;},getSourceTasksUrl:function(){return Zakeke.config.baseImagesUploadApiUrl+'scenes/'+this.getSceneID()+'/sourcetasks';},getSourceTaskResultUrl:function(taskID){return Zakeke.config.baseImagesUploadApiUrl+'scenes/'+this.getSceneID()+'/sourcetaskresult/'+taskID;},getTexturesUrl:function(materialID){return Zakeke.config.baseApiUrl+'scenes/'+this.getSceneID()+'/textures/'+materialID;},getMaterialPhotosUrl:function(materialID){return Zakeke.config.baseApiUrl+'scenes/'+this.getSceneID()+'/materialphotos/'+materialID;},getSourcesIDs:function(){var ids=[];for(var i=0;i<this.get("sources").length;i++){var source=this.get("sources").at(i);ids.push(source.getSourceID());}return ids;},getMappingForSceneMaterial:function(sceneMaterialID){return this.get("materialMappings").getMappingForSceneMaterial(sceneMaterialID);},getMappingsForLibraryMaterial:function(libraryMaterialID){return this.get("materialMappings").getMappingsForLibraryMaterial(libraryMaterialID);},getLibraryMaterialIDs:function(){return this.get("materialMappings").getLibraryMaterialIDs();},mapLibraryMaterial:function(libraryMaterialID,sceneMaterialID){var mapping=new Zakeke.SceneMaterialMapping();mapping.set("libraryMaterialID",libraryMaterialID);mapping.set("sceneMaterialID",sceneMaterialID);this.get("materialMappings").push(mapping);},removeMappingForSceneMaterial:function(sceneMaterialID){var mapping=this.get("materialMappings").getMappingForSceneMaterial(sceneMaterialID);if(mapping)this.get("materialMappings").remove(mapping);},registerShaderMaterial:function(libraryMaterialID,shaderName,vertex,fragment){var shaderMaterial=this.get("shaderMaterials").findWhere({materialID:libraryMaterialID});if(!shaderMaterial){shaderMaterial=new Zakeke.SceneShaderMaterial();shaderMaterial.set("materialID",libraryMaterialID);shaderMaterial.set("name",shaderName);shaderMaterial.set("vertex",vertex);shaderMaterial.set("fragment",fragment);this.get("shaderMaterials").push(shaderMaterial);}},getLibraryShaderMaterialIDForSceneMaterial:function(materialID){var mapping=this.getMappingForSceneMaterial(materialID);if(mapping){var libraryMaterialID=mapping.get("libraryMaterialID");for(var i=0;i<this.get("shaderMaterials").length;i++){if(this.get("shaderMaterials").at(i).get("materialID")===libraryMaterialID)return libraryMaterialID;}}return null;},unregisterShaderMaterial:function(libraryMaterialID){var shaderMaterial=this.get("shaderMaterials").findWhere({materialID:libraryMaterialID});if(shaderMaterial)this.get("shaderMaterials").remove(shaderMaterial);},getCameraLocation:function(locationID){var locations=this.get("cameraLocations");return locations.findCameraLocation(locationID);},getMeshLocation:function(locationID){return this.get("meshLocations").findMeshLocation(locationID);},getSceneConfig:function(){return this.get("config");},getOrCreateSceneConfig:function(){var sceneConfig=this.getSceneConfig();if(!sceneConfig){sceneConfig=new Zakeke.SceneConfig();this.set("config",sceneConfig);}return sceneConfig;},getGeneralConfig:function(){var sceneConfig=this.getSceneConfig();if(sceneConfig&&sceneConfig.get("general")&&sceneConfig.get("general")instanceof Zakeke.SceneGeneralConfig)return sceneConfig.get("general");return null;},getOrCreateGeneralConfig:function(){var sceneConfig=this.getOrCreateSceneConfig();var generalConfig=sceneConfig.get("general");if(!generalConfig){generalConfig=new Zakeke.SceneGeneralConfig();sceneConfig.set("general",generalConfig);}return generalConfig;},// Helper functions for config values get and set
getMatchSameNameTextures:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("matchSameNameTextures");return undefined;},setMatchSameNameTextures:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("matchSameNameTextures",value);},// Helper functions for config values get and set
getAntialiasEnabled:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("antialiasEnabled");return undefined;},setAntialiasEnabled:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("antialiasEnabled",value);},getAREnabled:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("arEnabled");return undefined;},setAREnabled:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("arEnabled",value);},getARScale:function(){var generalConfig=this.getGeneralConfig();if(generalConfig){var value=generalConfig.get("arScale");if(value===null||value===undefined)return true;else return value;}return true;},setARScale:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("arScale",value);},getUseDelayedTextureLoading:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("useDelayedTextureLoading");return undefined;},setUseDelayedTextureLoading:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("useDelayedTextureLoading",value);},getUseDelayedMaterialLoading:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("useDelayedMaterialLoading");return undefined;},setUseDelayedMaterialLoading:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("useDelayedMaterialLoading",value);},getUseMaterialOffloading:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("useMaterialOffloading");return undefined;},setUseMaterialOffloading:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("useMaterialOffloading",value);},getPrefetchMeshes:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("prefetchMeshes");return undefined;},setPrefetchMeshes:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("prefetchMeshes",value);},getPrefetchMaterials:function(){var generalConfig=this.getGeneralConfig();if(generalConfig)return generalConfig.get("prefetchMaterials");return undefined;},setPrefetchMaterials:function(value){var generalConfig=this.getOrCreateGeneralConfig();generalConfig.set("prefetchMaterials",value);},getEnvironmentConfig:function(){var sceneConfig=this.getSceneConfig();if(sceneConfig&&sceneConfig.get("environment")&&sceneConfig.get("environment")instanceof Zakeke.SceneEnvironmentConfig)return sceneConfig.get("environment");return null;},getOrCreateEnvironmentConfig:function(){var sceneConfig=this.getOrCreateSceneConfig();var environmentConfig=sceneConfig.get("environment");if(!environmentConfig){environmentConfig=new Zakeke.SceneEnvironmentConfig();sceneConfig.set("environment",environmentConfig);}return environmentConfig;},getSkyboxConfig:function(){var environmentConfig=this.getEnvironmentConfig();if(environmentConfig&&environmentConfig.get("skybox")&&environmentConfig.get("skybox")instanceof Zakeke.SceneSkyboxConfig)return environmentConfig.get("skybox");return null;},getOrCreateSkyboxConfig:function(){var environmentConfig=this.getOrCreateEnvironmentConfig();var skyboxConfig=environmentConfig.get("skybox");if(!skyboxConfig){skyboxConfig=new Zakeke.SceneSkyboxConfig();environmentConfig.set("skybox",skyboxConfig);}return skyboxConfig;},getGroundConfig:function(){var environmentConfig=this.getEnvironmentConfig();if(environmentConfig&&environmentConfig.get("ground")&&environmentConfig.get("ground")instanceof Zakeke.SceneGroundConfig)return environmentConfig.get("ground");return null;},getOrCreateGroundConfig:function(){var environmentConfig=this.getOrCreateEnvironmentConfig();var groundConfig=environmentConfig.get("ground");if(!groundConfig){groundConfig=new Zakeke.SceneGroundConfig();environmentConfig.set("ground",groundConfig);}return groundConfig;},getCameraConfig:function(){var sceneConfig=this.getSceneConfig();if(sceneConfig&&sceneConfig.get("camera")&&sceneConfig.get("camera")instanceof Zakeke.SceneCameraConfig)return sceneConfig.get("camera");return null;},getOrCreateCameraConfig:function(){var sceneConfig=this.getOrCreateSceneConfig();var cameraConfig=sceneConfig.get("camera");if(!cameraConfig){cameraConfig=new Zakeke.SceneCameraConfig();sceneConfig.set("camera",cameraConfig);}return cameraConfig;},// Helper functions for config values get and set
getCameraPositionScale:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("positionScale");return undefined;},setCameraPositionScale:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("positionScale",value);},getCameraLimitLowerRadius:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("limitLowerRadius");return undefined;},setCameraLimitLowerRadius:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("limitLowerRadius",value);},getCameraZoomEnabled:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("zoomEnabled");return undefined;},setCameraZoomEnabled:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("zoomEnabled",value);},getCameraUseMinZoomPerc:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("useMinZoomPerc");return undefined;},setCameraUseMinZoomPerc:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("useMinZoomPerc",value);},getCameraMinZoomPerc:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("minZoomPerc");return undefined;},setCameraMinZoomPerc:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("minZoomPerc",value);},getCameraUseMaxZoomPerc:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("useMaxZoomPerc");return undefined;},setCameraUseMaxZoomPerc:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("useMaxZoomPerc",value);},getCameraMaxZoomPerc:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("maxZoomPerc");return undefined;},setCameraMaxZoomPerc:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("maxZoomPerc",value);},getCameraLowerAlphaLimit:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("lowerAlphaLimit");return undefined;},setCameraLowerAlphaLimit:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("lowerAlphaLimit",value);},getCameraUpperAlphaLimit:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("upperAlphaLimit");return undefined;},setCameraUpperAlphaLimit:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("upperAlphaLimit",value);},getCameraLowerBetaLimit:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("lowerBetaLimit");return undefined;},setCameraLowerBetaLimit:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("lowerBetaLimit",value);},getCameraUpperBetaLimit:function(){var cameraConfig=this.getCameraConfig();if(cameraConfig)return cameraConfig.get("upperBetaLimit");return undefined;},setCameraUpperBetaLimit:function(value){var cameraConfig=this.getOrCreateCameraConfig();cameraConfig.set("upperBetaLimit",value);},getGlowConfig:function(){var sceneConfig=this.getSceneConfig();if(sceneConfig&&sceneConfig.get("glow")&&sceneConfig.get("glow")instanceof Zakeke.SceneGlowConfig)return sceneConfig.get("glow");return null;},getOrCreateGlowConfig:function(){var sceneConfig=this.getOrCreateSceneConfig();var glowConfig=sceneConfig.get("glow");if(!glowConfig){glowConfig=new Zakeke.SceneGlowConfig();sceneConfig.set("glow",glowConfig);}return glowConfig;},getInfoPointsConfig:function(){var sceneConfig=this.getSceneConfig();if(sceneConfig&&sceneConfig.get("infoPoints")&&sceneConfig.get("infoPoints")instanceof Zakeke.SceneInfoPointsConfig)return sceneConfig.get("infoPoints");return null;},getOrCreateInfoPointsConfig:function(){var sceneConfig=this.getOrCreateSceneConfig();var infoPointsConfig=sceneConfig.get("infoPoints");if(!infoPointsConfig){infoPointsConfig=new Zakeke.SceneInfoPointsConfig();sceneConfig.set("infoPoints",infoPointsConfig);}return infoPointsConfig;},getInfoPointsEnabled:function(){var result=false;var infoPointsConfig=this.getInfoPointsConfig();if(infoPointsConfig)result=infoPointsConfig.get("enabled");if(result===undefined||result===null)result=false;return result;},setInfoPointsEnabled:function(value){var infoPointsConfig=this.getOrCreateInfoPointsConfig();infoPointsConfig.set("enabled",value);},getInfoPointsStyleConfig:function(){var infoPointsConfig=this.getInfoPointsConfig();if(infoPointsConfig&&infoPointsConfig.get("pointsStyle")&&infoPointsConfig.get("pointsStyle")instanceof Zakeke.SceneInfoPointsStyleConfig)return infoPointsConfig.get("pointsStyle");return null;},getOrCreateInfoPointsStyleConfig:function(){var infoPointsConfig=this.getOrCreateInfoPointsConfig();var pointsStyleConfig=infoPointsConfig.get("pointsStyle");if(!pointsStyleConfig){pointsStyleConfig=new Zakeke.SceneInfoPointsStyleConfig();infoPointsConfig.set("pointsStyle",pointsStyleConfig);}return pointsStyleConfig;},getInfoPointsBorderColor:function(){var result="#ffffff";var pointsStyleConfig=this.getInfoPointsStyleConfig();if(pointsStyleConfig)result=pointsStyleConfig.get("borderColor");if(!result)result="#ffffff";return result;},setInfoPointsBorderColor:function(value){var pointsStyleConfig=this.getOrCreateInfoPointsStyleConfig();pointsStyleConfig.set("borderColor",value);},getInfoPointsInnerPointColor:function(){var result="#ffffff";var pointsStyleConfig=this.getInfoPointsStyleConfig();if(pointsStyleConfig)result=pointsStyleConfig.get("innerPointColor");if(!result)result="#ffffff";return result;},setInfoPointsInnerPointColor:function(value){var pointsStyleConfig=this.getOrCreateInfoPointsStyleConfig();pointsStyleConfig.set("innerPointColor",value);},getInfoPointsColor:function(){var result="#a01c20";var pointsStyleConfig=this.getInfoPointsStyleConfig();if(pointsStyleConfig)result=pointsStyleConfig.get("color");if(!result)result="#a01c20";return result;},setInfoPointsColor:function(value){var pointsStyleConfig=this.getOrCreateInfoPointsStyleConfig();pointsStyleConfig.set("color",value);},getInfoPointsHighlightColor:function(){var result="#bb2025";var pointsStyleConfig=this.getInfoPointsStyleConfig();if(pointsStyleConfig)result=pointsStyleConfig.get("highlightColor");if(!result)result="#bb2025";return result;},setInfoPointsHighlightColor:function(value){var pointsStyleConfig=this.getOrCreateInfoPointsStyleConfig();pointsStyleConfig.set("highlightColor",value);},getFirstExplodedMeshLocation:function(){return this.get("meshLocations").getFirstExplodedMeshLocation();},getFirstCollapsedMeshLocation:function(){return this.get("meshLocations").getFirstCollapsedMeshLocation();},getOrCreateExplodedMeshLocation:function(){return this.get("meshLocations").getOrCreateExplodedMeshLocation();},getOrCreateCollapsedMeshLocation:function(){return this.get("meshLocations").getOrCreateCollapsedMeshLocation();}});// -----------------------------------------------------------
// Scenes
// -----------------------------------------------------------
Zakeke.Scenes=Backbone.Collection.extend({model:Zakeke.Scene,url:function(){return Zakeke.config.baseApiUrl+'scenes';},getScene:function(sceneID){for(var i=0;i<this.length;i++){var scene=this.at(i);if(scene.get("sceneID")==sceneID)return scene;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MaterialSourceTextureImage
// -----------------------------------------------------------
Zakeke.MaterialSourceTextureImage=Backbone.AssociatedModel.extend({defaults:{sceneID:null,sourceID:null,materialID:null,fileObjectID:-1},initialize:function(){},relations:[],getMaterialID:function(){if(this.collection&&this.collection.getMaterialID){return this.collection.getMaterialID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// MaterialSourceTextureImages
// -----------------------------------------------------------
Zakeke.MaterialSourceTextureImages=Backbone.Collection.extend({model:Zakeke.MaterialSourceTextureImage,getMaterialID:function(){if(this.parentModel&&this.parentModel.getMaterialID){return this.parentModel.getMaterialID();}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MaterialTextureImage
// -----------------------------------------------------------
Zakeke.MaterialTextureImage=Backbone.AssociatedModel.extend({defaults:{fileObjectID:-1,imageUrl:""},idAttribute:"textureImageID",initialize:function(){},relations:[],getTextureImageID:function(){return this.get("textureImageID");},getMaterialID:function(){if(this.collection&&this.collection.getMaterialID){return this.collection.getMaterialID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// MaterialTextureImages
// -----------------------------------------------------------
Zakeke.MaterialTextureImages=Backbone.Collection.extend({model:Zakeke.MaterialTextureImage,getMaterialID:function(){if(this.parentModel&&this.parentModel.getMaterialID){return this.parentModel.getMaterialID();}return null;},findTextureImage:function(textureImageID){for(var i=0;i<this.length;i++){var textureImage=this.at(i);if(textureImage.get("textureImageID")==textureImageID)return textureImage;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MaterialShaderOption
// -----------------------------------------------------------
Zakeke.MaterialShaderOption=Backbone.AssociatedModel.extend({defaults:{name:"",shaderOptionTypeID:Zakeke.ShaderOptionType.Attribute},idAttribute:"optionID",initialize:function(){if(!this.get("optionID")){this.set("optionID",Zakeke.generateUUID());}},relations:[],getMaterialID:function(){if(this.collection&&this.collection.getMaterialID){return this.collection.getMaterialID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// MaterialShaderOptions
// -----------------------------------------------------------
Zakeke.MaterialShaderOptions=Backbone.Collection.extend({model:Zakeke.MaterialShaderOption,getMaterialID:function(){if(this.parentModel&&this.parentModel.getMaterialID){return this.parentModel.getMaterialID();}return null;},findShaderOption:function(optionID){for(var i=0;i<this.length;i++){var shaderOption=this.at(i);if(shaderOption.get("optionID")==optionID)return shaderOption;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MaterialShaderInput
// -----------------------------------------------------------
Zakeke.MaterialShaderInput=Backbone.AssociatedModel.extend({defaults:{name:"",shaderInputTypeID:Zakeke.ShaderInputType.Float},idAttribute:"inputID",initialize:function(){if(!this.get("inputID")){this.set("inputID",Zakeke.generateUUID());}},relations:[],getMaterialID:function(){if(this.collection&&this.collection.getMaterialID){return this.collection.getMaterialID();}return null;},getParentModel:function(){if(this.collection&&this.collection.parentModel){return this.collection.parentModel;}return null;},toString:function(){// todo.......
}});// -----------------------------------------------------------
// MaterialShaderInputs
// -----------------------------------------------------------
Zakeke.MaterialShaderInputs=Backbone.Collection.extend({model:Zakeke.MaterialShaderInput,getMaterialID:function(){if(this.parentModel&&this.parentModel.getMaterialID){return this.parentModel.getMaterialID();}return null;},findShaderInput:function(inputID){for(var i=0;i<this.length;i++){var shaderInput=this.at(i);if(shaderInput.get("inputID")==inputID)return shaderInput;}return null;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// MaterialShader
// -----------------------------------------------------------
Zakeke.MaterialShader=Backbone.AssociatedModel.extend({defaults:{name:"",vertex:"",fragment:""},idAttribute:"materialID",initialize:function(){},relations:[],getMaterialID:function(){if(this.collection&&this.collection.getModelID){return this.collection.getMaterialID();}return null;},getParentModel:function(){if(this.parentModel)return this.parentModel;return null;},toString:function(){// todo.......
}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// Material
// -----------------------------------------------------------
Zakeke.Material=Backbone.AssociatedModel.extend({defaults:{name:"",JSON:"",url:"",rootUrl:"",materialFileName:"",sellerID:-1,imageData:null,imageUrl:"",sourceTextureImages:[],textureImages:[],shaders:null,shaderInputs:[],shaderOptions:[]},idAttribute:"materialID",getMaterialID:function(){if(this.id!=undefined&&this.id!=null)return this.id;return this.get("tempMaterialID");},initialize:function(){this.set("tempMaterialID",Zakeke.generateUUID());var material=this;this.get("textureImages").parentModel=this;this.get('textureImages').url=function(){return material.url()+'/'+material.getMaterialID()+'/textures';};this.get("sourceTextureImages").parentModel=this;if(this.get('shaders'))this.get('shaders').parentModel=this;this.get("shaderInputs").parentModel=this;this.get("shaderOptions").parentModel=this;},relations:[{type:Backbone.Many,key:'sourceTextureImages',collectionType:Zakeke.MaterialSourceTextureImages},{type:Backbone.Many,key:'textureImages',collectionType:Zakeke.MaterialTextureImages},{type:Backbone.One,key:'shaders',relatedModel:Zakeke.MaterialShader},{type:Backbone.Many,key:'shaderInputs',collectionType:Zakeke.MaterialShaderInputs},{type:Backbone.Many,key:'shaderOptions',collectionType:Zakeke.MaterialShaderOptions}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'materials';if(this.id!=undefined&&this.id!=null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;},toString:function(){// todo.......
},getTexturesUrl:function(){return Zakeke.config.baseApiUrl+'materials/'+this.getMaterialID()+'/textures';},getClonedContentForSceneUrl:function(sceneID){return Zakeke.config.baseApiUrl+'materials/'+this.getMaterialID()+'/clonedContentForScene/'+sceneID;},getShaderAttributeOptions:function(type){var options=[];for(var i=0;i<this.get("shaderOptions").length;i++){var shaderOption=this.get("shaderOptions").at(i);if(shaderOption.get("shaderOptionTypeID")===type)options.push(shaderOption.get("name"));}return options;}});// -----------------------------------------------------------
// Materials
// -----------------------------------------------------------
Zakeke.Materials=Backbone.Collection.extend({model:Zakeke.Material,url:function(){return Zakeke.config.baseApiUrl+'materials';},getMaterial:function(materialID){for(var i=0;i<this.length;i++){var material=this.at(i);if(material.get("materialID")==materialID)return material;}return null;},comparator:function(model){return model.get('name');}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
var Zakeke=Zakeke||{};// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// -----------------------------------------------------------
// ComposerModels
// -----------------------------------------------------------
Zakeke.ComposerModels=Backbone.AssociatedModel.extend({defaults:{model:null,scene:null},idAttribute:"modelID",initialize:function(){},relations:[{type:Backbone.One,key:'model',relatedModel:MPlaza.Model},{type:Backbone.One,key:'scene',relatedModel:Zakeke.Scene}],url:function(){var urlRoot=Zakeke.config.baseApiUrl+'composermodels';if(this.id!==undefined&&this.id!==null){urlRoot=urlRoot+"/"+this.id;}return urlRoot;}});// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
// xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
var Zakeke=Zakeke||{};// -----------------------------------------------------------
// OptionSelection
// -----------------------------------------------------------
Zakeke.OptionSelection=Backbone.Model.extend({defaults:{optionID:-1,attributeID:-1,// risulta comodo mantenere un riferimento diretto all'attributo padre
optionGuid:"",optionCode:"",name:"",selected:false,enabled:true},idAttribute:"optionID",initialize:function(){}});// -----------------------------------------------------------
// OptionSelectionCollection
// -----------------------------------------------------------
Zakeke.OptionSelectionCollection=Backbone.Collection.extend({model:Zakeke.OptionSelection});// -----------------------------------------------------------
// AttributeSelection
// -----------------------------------------------------------
Zakeke.AttributeSelection=Backbone.Model.extend({idAttribute:"attributeID",initialize:function(){myDefaults={attributeID:-1,attributeGuid:"",attributeCode:"",attributeTypeID:MPlaza.AttributeType.Options,groupID:-1,// risulta comodo mantenere un riferimento diretto al gruppo padre
name:"",enabled:true,selectedValue:null,optionPreviewShapeID:MPlaza.AttributeOptionPreviewShape.Rectangle,options:new Zakeke.OptionSelectionCollection()};this.set(myDefaults);},getOptionSelection:function(optionID){return this.get("options").findWhere({optionID:optionID});},getOptionSelectionByGuid:function(optionGuid){return this.get("options").findWhere({optionGuid:optionGuid});},getOptionSelectionsByName:function(name){var options=[];for(var i=0;i<this.get("options").length;i++)if(this.get("options").at(i).get("name")==name)options.push(this.get("options").at(i));return options;},getOptionIDsByName:function(name){var ids=[];for(var i=0;i<this.get("options").length;i++)if(this.get("options").at(i).get("name")==name)ids.push(this.get("options").at(i).get("optionID"));return ids;},getSelectedOption:function(){return this.get("options").findWhere({selected:true});},getUnselectedOptions:function(){return this.get("options").where({selected:false});},getUnselectedEnabledOptions:function(){return this.get("options").where({selected:false,enabled:true});},getEnabledOptions:function(){return this.get("options").where({enabled:true});}});// -----------------------------------------------------------
// AttributeSelectionCollection
// -----------------------------------------------------------
Zakeke.AttributeSelectionCollection=Backbone.Collection.extend({model:Zakeke.AttributeSelection});// -----------------------------------------------------------
// AttributeGroupSelection
// -----------------------------------------------------------
Zakeke.AttributeGroupSelection=Backbone.Model.extend({idAttribute:"groupID",initialize:function(){myDefaults={groupID:-1,groupGuid:"",name:"",attributes:new Zakeke.AttributeSelectionCollection()};this.set(myDefaults);},containsAttributeSelection:function(attributeID){var attributeSelection=this.get("attributes").findWhere({attributeID:attributeID});if(attributeSelection)return true;return false;},countEnabledAttributeSelections:function(){var enabled=this.get("attributes").where({enabled:true});return enabled.length;}});// -----------------------------------------------------------
// AttributeGroupSelectionCollection
// -----------------------------------------------------------
Zakeke.AttributeGroupSelectionCollection=Backbone.Collection.extend({model:Zakeke.AttributeGroupSelection});// -----------------------------------------------------------
// ComposerSelection
// -----------------------------------------------------------
Zakeke.ComposerSelection=Backbone.Model.extend({initialize:function(){myDefaults={zkModel:null,groups:new Zakeke.AttributeGroupSelectionCollection(),attributeDependencies:{},// mappa ad ogni attributo quelli direttamente dipendenti {guid: [guid1, guid2, ...]}
optionDependencies:{},// mappa ad ogni attributo le opzioni direttamente dipendenti {guid: [guid1, guid2, ...]}
suggestions:{},// mappa per uno o più attributi quali sono le opzioni papabili per la selezione
// Quando viene selezionata l'opzione di un attributo, vengono cercati
// gli attributi disabilitati che si chiamano allo stesso modo e le relative opzioni che
// si chiamano allo stesso modo. Queste opzioni diverranno suggerimenti per 
// la selezione automatica nel momento in cui l'attributo viene abilitato.
currentModelColorID:null//rappresenta l'attuale colore del modello corrispondente alla selezione
};this.set(myDefaults);},// costruisce la mappa di dipendenze tra gli attributi, in base alle espressioni.
// Quando cambia la selezione di un attributo, o la sua abilitazione, vanno
// verificati anche gli attributi dipendenti
buildDependencies:function(){var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){for(var i=0;i<zkModel.get("attributes").length;i++){var zkAttribute=zkModel.get("attributes").at(i);var expression=zkAttribute.get("constraintExpression");if(expression){// Determino tutti gli attributi che influiscono sull'espressione
// e dai quali quindi l'attributo in questione dipende
var dependentGuid=zkAttribute.get("attributeGuid");var guids=expression.getAllAttributeGuids();// guid che influiscono
for(var j=0;j<guids.length;j++){var guid=guids[j];// guid dell'attributo influente
if(this.get("attributeDependencies").hasOwnProperty(guid)){// aggiungo l'attributo in questione tra quelli dipendenti dal guid
var dependents=this.get("attributeDependencies")[guid];if(!Zakeke.arrayContains(dependents,dependentGuid))dependents.push(dependentGuid);}else{// l'attributo in questione è il primo a dipendere da guid
this.get("attributeDependencies")[guid]=[dependentGuid];}}}// opzioni
for(var o=0;o<zkAttribute.get("options").length;o++){var zkOption=zkAttribute.get("options").at(o);var expression=zkOption.get("constraintExpression");if(expression){// Determino tutti gli attributi che influiscono sull'espressione
// e dai quali quindi l'opzione in questione dipende
var dependentGuid=zkOption.get("optionGuid");var guids=expression.getAllAttributeGuids();// guid che influiscono
for(var k=0;k<guids.length;k++){var guid=guids[k];// guid dell'attributo influente
if(this.get("optionDependencies").hasOwnProperty(guid)){// aggiungo l'attributo in questione tra quelli dipendenti dal guid
var dependents=this.get("optionDependencies")[guid];if(!Zakeke.arrayContains(dependents,dependentGuid))dependents.push(dependentGuid);}else{// l'attributo in questione è il primo a dipendere da guid
this.get("optionDependencies")[guid]=[dependentGuid];}}}}}}},// Per ogni attributo e per ogni opzione, valuta l'eventuale espressione di abilitazione
// se l'espressione è verificata l'attributo sarà abilitato per la composizione
// altrimenti verrà disabilitato. Lo stesso viene fatto per l'abilitazione delle opzioni.
// Importante. Qui sto assumendo che gli attributi dipendenti siano nella giusta sequenza
checkAllConstraintExpressions:function(){var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){//var attributeSelections = this.getAllAttributeSelections();
var attributeSelections=this.getDependenceAwareAttributeSelections();var optionSelections=[];// Verifico prima gli attributi
for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];var zkAttribute=zkModel.getAttribute(attributeSelection.get("attributeID"));this.checkConstraintExpression(attributeSelection);for(var j=0;j<attributeSelection.get("options").length;j++){var optionSelection=attributeSelection.get("options").at(j);var zkOption=zkAttribute.getOption(optionSelection.get("optionID"));if(zkOption.get("constraintExpression"))optionSelections.push(optionSelection);}}// e poi le opzioni
for(var i=0;i<optionSelections.length;i++){var optionSelection=optionSelections[i];this.checkOptionConstraintExpression(optionSelection);}}},// Controlla l'espressione per un singolo attributo
checkConstraintExpression:function(attributeSelection){var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){var zkAttribute=zkModel.getAttribute(attributeSelection.get("attributeID"));var expression=zkAttribute.get("constraintExpression");if(expression){var enabled=this.evaluateAttributeExpression(expression);attributeSelection.set("enabled",enabled);}}},// Controlla le espressioni di tutti gli attributi o delle espressioni che dipendono dall'attributo in input,
// cioè di tutti gli attributi o le opzioni che hanno un'espressione che si basa sull'attibuto in input.
checkDependentConstraintExpressions:function(attributeID){var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection){var attributeGuid=attributeSelection.get("attributeGuid");// Attributi dipendenti
var attributeDependencies=this.get("attributeDependencies");if(attributeDependencies.hasOwnProperty(attributeGuid)){var guids=attributeDependencies[attributeGuid];for(var i=0;i<guids.length;i++){var depGuid=guids[i];var depAttributeSelection=this.getAttributeSelectionByGuid(depGuid);this.checkConstraintExpression(depAttributeSelection);}}// Opzioni dipendenti
var attrbutesToCheck=[];// Attributi per cui controllare se l'elemento selezionato non è più abilitato
var optionDependencies=this.get("optionDependencies");if(optionDependencies.hasOwnProperty(attributeGuid)){var guids=optionDependencies[attributeGuid];for(var i=0;i<guids.length;i++){var depGuid=guids[i];var depOptionSelection=this.getOptionSelectionByGuid(depGuid);this.checkOptionConstraintExpression(depOptionSelection);var optionAttrID=depOptionSelection.get("attributeID");if(!Zakeke.arrayContains(attrbutesToCheck,optionAttrID))attrbutesToCheck.push(optionAttrID);}}// è possibile che un attributo abbia un elemento selezionato non più
// abilitato. in questo caso seleziono il primo elemento abilitato disponibile
for(var i=0;i<attrbutesToCheck.length;i++){var attrID=attrbutesToCheck[i];var attrSelection=this.getAttributeSelection(attrID);var selectedOption=attrSelection.getSelectedOption();if(!selectedOption.get("enabled"))this.selectFirstEnabledOption(attrID);}}},// Controlla l'espressione per una singola opzione di un attributo
checkOptionConstraintExpression:function(optionSelection){var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){var zkOption=zkModel.getOption(optionSelection.get("optionID"));var expression=zkOption.get("constraintExpression");if(expression){var enabled=this.evaluateAttributeExpression(expression);optionSelection.set("enabled",enabled);// Questo controllo è stato spostato alla fine del controllo per tutte le opzioni
/*
                if (!enabled && optionSelection.get("selected")) {
                    var optionToUnselect = optionSelection;
                    var optionToSelect = null;
                    // Seleziono la prima opzione disponnibile per l'attributo
                    var attributeID = optionSelection.get("attributeID");
                    var attributeSelection = this.getAttributeSelection(attributeID);
                    for (var i = 0; i < attributeSelection.get("options").length; i++) {
                        var opt = attributeSelection.get("options").at(i);
                        if (opt.get("optionID") != optionSelection.get("optionID") &&
                            opt.get("enabled")) {
                            optionToSelect = opt;
                            break;
                        }
                    }
                    optionToUnselect.set("selected", false);
                    if (optionToSelect != null)
                        optionToSelect.set("selected", true);
                }
                */}}},// Dell'attributo in input seleziona la prima opzione abilitata
selectFirstEnabledOption:function(attributeID){var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection){var options=attributeSelection.getEnabledOptions();var optionToSelect=null;if(options&&options.length>0){optionToSelect=options[0];}var optionToUnselect=attributeSelection.getSelectedOption();if(optionToSelect&&(optionToUnselect==null||optionToUnselect.get("optionID")!=optionToSelect.get("optionID"))){if(optionToUnselect!=null)optionToUnselect.set("selected",false);optionToSelect.set("selected",true);}}},// Per la valutazione delle espressioni, sono necessarie due funzioni, una per l'espressione
// principale e una per le espressione figlie. Questo perché l'espressione principale è un
// modello Backbone JS e quelle secondarie risultano come semplici oggetti javascript.
// Valuta l'espressione principale (modello backbone js)
evaluateAttributeExpression:function(expression){if(!expression||!(expression instanceof MPlaza.AttributeExpression))return false;var op=expression.get("op");var result=op==MPlaza.LogicalOperator.AND?true:false;for(var i=0;i<expression.get("propositions").length;i++){var proposition=expression.get("propositions")[i];var partial=this.evaluateAttributeProposition(proposition);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}for(var i=0;i<expression.get("expressions").length;i++){var childExpression=expression.get("expressions")[i];var partial=this.evaluateChildAttributeExpression(childExpression);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}return result;},// Valuta un'espressione figlia (oggetto plain javascript object)
evaluateChildAttributeExpression:function(expression){var op=expression.op;var result=op==MPlaza.LogicalOperator.AND?true:false;for(var i=0;i<expression.propositions.length;i++){var proposition=expression.propositions[i];var partial=this.evaluateAttributeProposition(proposition);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}for(var i=0;i<expression.expressions.length;i++){var childExpression=expression.expressions[i];var partial=this.evaluateChildAttributeExpression(childExpression);if(op==MPlaza.LogicalOperator.AND){result=result&&partial;if(!result)return false;}else{result=result||partial;if(result)return true;}}return result;},// Valuta una singola proposizione (semplice oggetto javascript)
evaluateAttributeProposition:function(proposition){if(proposition&&proposition.hasOwnProperty("attributeGuid")&&proposition.hasOwnProperty("op")&&proposition.hasOwnProperty("value")){var guid=proposition.attributeGuid;var attributeSelection=this.getAttributeSelectionByGuid(guid);// se l'attributo non è abilitato la proposizione deve essere falsa
if(attributeSelection&&attributeSelection.get("enabled")){var selectedValue=attributeSelection.get("selectedValue");if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){// Nel caso di attributi con opzioni, deve essere considerato il guid dell'opzione selezionata
var selectedOption=attributeSelection.getSelectedOption();if(selectedOption){selectedValue=selectedOption.get("optionGuid");}}var result=false;if(proposition.op==MPlaza.ComparisonOperator.Equal)result=selectedValue==proposition.value;else if(proposition.op==MPlaza.ComparisonOperator.NotEqual)result=selectedValue!=proposition.value;else if(proposition.op==MPlaza.ComparisonOperator.In||proposition.op==MPlaza.ComparisonOperator.NotIn){var parts=proposition.value.split(';');if(proposition.op==MPlaza.ComparisonOperator.In)result=Zakeke.arrayContains(parts,selectedValue);else result=!Zakeke.arrayContains(parts,selectedValue);}return result;}}return false;},getAttributeGroupSelection:function(attributeID){var zkModel=this.get("zkModel");if(zkModel){var zkAttribute=zkModel.get("attributes").findWhere({attributeID:attributeID});if(zkAttribute){var groupID=zkAttribute.get("groupID");var groupSelection=this.get("groups").findWhere({groupID:groupID});return groupSelection;}}return null;},getAttributeSelection:function(attributeID){var zkModel=this.get("zkModel");if(zkModel){var zkAttribute=zkModel.get("attributes").findWhere({attributeID:attributeID});if(zkAttribute){var groupID=zkAttribute.get("groupID");var groupSelection=this.get("groups").findWhere({groupID:groupID});if(groupSelection){var attribute=groupSelection.get("attributes").findWhere({attributeID:attributeID});return attribute;}}}return null;},getAttributeSelectionByGuid:function(attributeGuid){var zkModel=this.get("zkModel");if(zkModel){var zkAttribute=zkModel.get("attributes").findWhere({attributeGuid:attributeGuid});if(zkAttribute){var groupID=zkAttribute.get("groupID");var groupSelection=this.get("groups").findWhere({groupID:groupID});if(groupSelection){var attribute=groupSelection.get("attributes").findWhere({attributeGuid:attributeGuid});return attribute;}}}return null;},getAttributeSelectionByOptionID:function(optionID){var optionSelection=this.getOptionSelection(optionID);if(optionSelection){var attributeID=optionSelection.get("attributeID");return this.getAttributeSelection(attributeID);}return null;},getAllAttributeSelections:function(){var attributes=[];for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);attributes.push(attribute);}}return attributes;},// Restituisce gli attributi in un ordine tale che possa essere verificata
// la interdipendenza attraverso i vincoli. In pratica ci saranno prima
// gli attributi che dipendono da meno altri attributi e poi quelli che dipendono
// da più attributi. In questo modo gli attributi più in basso nell'albero
// delle dipendenze staranno in fondo alla lista
getDependenceAwareAttributeSelections:function(){var dependencies={};// hash del tipo guid: number
var attributeSelections=this.getAllAttributeSelections();for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];var attributeGuid=attributeSelection.get("attributeGuid");if(!dependencies.hasOwnProperty(attributeGuid))dependencies[attributeGuid]=0;// Attributi dipendenti
var guids=this.getFullDependencyChain(attributeGuid);for(var k=0;k<guids.length;k++){var depGuid=guids[k];if(dependencies.hasOwnProperty(depGuid))dependencies[depGuid]+=1;else dependencies[depGuid]=1;}}// ora ordino l'array in modo crescente in base al numero di occorrenze in dependencies
attributeSelections.sort(function(a,b){var aNum=dependencies[a.get("attributeGuid")];var bNum=dependencies[b.get("attributeGuid")];if(aNum<bNum)return-1;if(aNum>bNum)return 1;return 0;});return attributeSelections;},getFullDependencyChain:function(attributeGuid){var attributeDependencies=this.get("attributeDependencies");var addDependencies=function(guid,guids){if(guid!==attributeGuid&&!Zakeke.arrayContains(guids,guid))guids.push(guid);if(attributeDependencies.hasOwnProperty(guid)){var firstLevelGuids=attributeDependencies[guid];for(var j=0;j<firstLevelGuids.length;j++){addDependencies(firstLevelGuids[j],guids);}}};var guids=[];if(attributeDependencies.hasOwnProperty(attributeGuid)){guids=attributeDependencies[attributeGuid].slice(0);for(var k=0;k<guids.length;k++){addDependencies(guids[k],guids);}}return guids;},getAllAttributeIDs:function(){var ids=[];for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);ids.push(attribute.get("attributeID"));}}return ids;},getEnabledAttributeSelections:function(){var attributes=[];for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);if(attribute.get("enabled"))attributes.push(attribute);}}return attributes;},getEnabledAttributeIDs:function(){var ids=[];for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);if(attribute.get("enabled"))ids.push(attribute.get("attributeID"));}}return ids;},getDisabledAttributeSelections:function(){var attributes=[];for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);if(!attribute.get("enabled"))attributes.push(attribute);}}return attributes;},getAttributeOptionSelection:function(attributeID,optionID){var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection){return attributeSelection.getOptionSelection(optionID);}return null;},getOptionSelection:function(optionID){for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);for(var k=0;k<attribute.get("options").length;k++){var option=attribute.get("options").at(k);if(option.get("optionID")==optionID)return option;}}}return null;},getOptionSelectionByGuid:function(optionGuid){for(var i=0;i<this.get("groups").length;i++){var group=this.get("groups").at(i);for(var j=0;j<group.get("attributes").length;j++){var attribute=group.get("attributes").at(j);for(var k=0;k<attribute.get("options").length;k++){var option=attribute.get("options").at(k);if(option.get("optionGuid")==optionGuid)return option;}}}return null;},getAllAttributeTransformationScript:function(){var script=[];var attributeSelections=this.getAllAttributeSelections();for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];if(attributeSelection.get("enabled")){var attributeScript=this.getAttributeTransformationScript(attributeSelection.get("attributeID"));if(attributeScript)script.push(attributeScript);}}return script;},getAttributeTransformationScript:function(attributeID){var script=null;var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection&&attributeSelection.get("enabled")){script={attributeID:attributeID,selectedValue:"",actions:this.getAttributeSceneActions(attributeID)};if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){var selectedOption=attributeSelection.getSelectedOption();if(selectedOption&&selectedOption.get("enabled")){script.selectedValue=selectedOption.get("optionID").toString();}else{script=null;}}else{script.selectedValue=attributeSelection.get("selectedValue");}}return script;},// Restituisce le azioni relative all'opzione selezionata per l'attributo
getAttributeSceneActions:function(attributeID){var actions=[];var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){var zkAttribute=zkModel.getAttribute(attributeID);var attributeSelection=this.getAttributeSelection(attributeID);// Pre actions
var preActions=zkAttribute.get("preActions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,preActions);// Azioni realtive al valore selezionato
if(attributeSelection&&zkAttribute){if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){var optionSelection=attributeSelection.getSelectedOption();if(optionSelection){var zkOption=zkAttribute.get("options").findWhere({optionID:optionSelection.get("optionID")});if(zkOption){var optionActions=zkOption.get("actions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,optionActions);}}}else{var valueActions=zkAttribute.get("valueActions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,valueActions);}}// Post Actions
var postActions=zkAttribute.get("postActions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,postActions);}return actions;},// Restituisce tutte le azioni legate alle opzioni non selezionate per l'attributo
getAttributeUnselectedOptionsSceneActions:function(attributeID){var actions=[];var zkModel=this.get("zkModel");if(zkModel&&zkModel instanceof MPlaza.Model){var zkAttribute=zkModel.getAttribute(attributeID);var attributeSelection=this.getAttributeSelection(attributeID);// Pre actions
var preActions=zkAttribute.get("preActions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,preActions);// Azioni realtive al valore non selezionato
if(attributeSelection&&zkAttribute){if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){var unselectedOptions=attributeSelection.getUnselectedEnabledOptions();for(var i=0;i<unselectedOptions.length;i++){var optionSelection=unselectedOptions[i];var zkOption=zkAttribute.get("options").findWhere({optionID:optionSelection.get("optionID")});if(zkOption){var optionActions=zkOption.get("actions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,optionActions);}}}}// Post Actions
var postActions=zkAttribute.get("postActions").sortBy(function(item){return item.get("execOrder");});Array.prototype.push.apply(actions,postActions);}return actions;},getAllAttributesUnselectedOptionsSceneActions:function(){var actions=[];var attributeSelections=this.getEnabledAttributeSelections();for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];var partialActions=this.getAttributeUnselectedOptionsSceneActions(attributeSelection.get("attributeID"));Array.prototype.push.apply(actions,partialActions);}return actions;},detachEvents:function(){var _this=this;var attributes=this.getAllAttributeSelections();for(var i=0;i<attributes.length;i++){var attribute=attributes[i];var attributeID=attribute.get("attributeID");attribute.off("change:selectedValue");attribute.off("change:enabled");for(var j=0;j<attribute.get("options").length;j++){var option=attribute.get("options").at(j);var optionID=option.get("optionID");option.off("change:selected");option.off("change:enabled");}}},attachEvents:function(){var _this=this;var attributes=this.getAllAttributeSelections();for(var i=0;i<attributes.length;i++){var attribute=attributes[i];var attributeID=attribute.get("attributeID");attribute.on("change:selectedValue",function(){_this.onAttributeSelectedValueChanged(this.get("attributeID"));});attribute.on("change:enabled",function(){_this.onAttributeEnablingChanged(this.get("attributeID"));});for(var j=0;j<attribute.get("options").length;j++){var option=attribute.get("options").at(j);var optionID=option.get("optionID");option.on("change:selected",function(){_this.onAttributeSelectedOptionChanged(this.get("attributeID"),this.get("optionID"));});option.on("change:enabled",function(){_this.onAttributeOptionEnablingChanged(this.get("attributeID"),this.get("optionID"));});}}},onAttributeSelectedValueChanged:function(attributeID){var attributeSelection=this.getAttributeSelection(attributeID);var actions=this.getAttributeSceneActions(attributeID);var evt={attributeID:attributeID,selectedValue:attributeSelection.get("selectedValue"),actions:actions};this.trigger("attributeSelectionChanged",evt);this.checkCurrentModelColor();this.checkDependentConstraintExpressions(attributeID);},onAttributeSelectedOptionChanged:function(attributeID,optionID){var attributeSelection=this.getAttributeSelection(attributeID);var optionSelection=this.getAttributeOptionSelection(attributeID,optionID);if(optionSelection&&optionSelection.get("selected")){var actions=this.getAttributeSceneActions(attributeID);var evt={attributeID:attributeID,selectedValue:optionID.toString(),actions:actions};this.trigger("attributeSelectionChanged",evt);this.checkCurrentModelColor();this.checkDependentConstraintExpressions(attributeID);}},onAttributeEnablingChanged:function(attributeID){var evt={attributeID:attributeID};var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection.get("enabled"))this.trigger("attributeEnabled",evt);else this.trigger("attributeDisabled",evt);// Se un attributo è stato abilitato simulo la selezione dell'opzione/valore
// in modo che vengano eseguite le azione corrispondenti
if(attributeSelection.get("enabled")){var selectedValue=attributeSelection.get("selectedValue");if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){// Verifico se posso selezionare un'opzione suggerita
var suggestedSelected=false;var suggestedOptionIDs=this.getSuggestions(attributeID);if(suggestedOptionIDs){this.removeSuggestions(attributeID);for(var i=0;i<suggestedOptionIDs.length;i++){var suggestedOptionID=suggestedOptionIDs[i];var suggestedSelectedOption=attributeSelection.getOptionSelection(suggestedOptionID);if(suggestedSelectedOption&&suggestedSelectedOption.get("enabled")){suggestedSelected=true;this.selectAttributeValue(attributeID,suggestedOptionID);break;}}}if(!suggestedSelected){var selectedOption=attributeSelection.getSelectedOption();if(selectedOption){this.onAttributeSelectedOptionChanged(attributeID,selectedOption.get("optionID"));}else{this.onAttributeSelectedValueChanged(attributeID);}}}}this.checkDependentConstraintExpressions(attributeID);},onAttributeOptionEnablingChanged:function(attributeID,optionID){var optionSelection=this.getAttributeOptionSelection(attributeID,optionID);var evt={attributeID:attributeID,optionID:optionID};var enabled=false;var selected=false;if(optionSelection){enabled=optionSelection.get("enabled");selected=optionSelection.get("selected");}if(enabled)this.trigger("attributeOptionEnabled",evt);else this.trigger("attributeOptionDisabled",evt);if(selected&&enabled)this.onAttributeSelectedOptionChanged(attributeID,optionID);this.checkDependentConstraintExpressions(attributeID);},selectAttributeOptionByGuid:function(attributeGuid,optionGuid){// L'attributo deve essere di tipo "elenco opzioni"
var attributeSelection=this.getAttributeSelectionByGuid(attributeGuid);if(attributeSelection){if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){// Vale solo nel caso di elenco opzioni
var optionToSelect=attributeSelection.getOptionSelectionByGuid(optionGuid);if(optionToSelect){this._selectAttributeOption(attributeSelection,optionToSelect);}}}},selectAttributeValue:function(attributeID,value){var attributeSelection=this.getAttributeSelection(attributeID);if(attributeSelection){if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){// Nel caso di attributo di tipo opzioni, il valore passato è da intendersi
// come OptionID
var selID=-1;if(value&&!isNaN(value)){selID=parseInt(value);var optionToSelect=attributeSelection.getOptionSelection(selID);//if (optionToSelect && !optionToSelect.get("selected")) {
if(optionToSelect){this._selectAttributeOption(attributeSelection,optionToSelect);}}}else{// Negli altri casi imposto solo il valore selezionato 
attributeSelection.set("selectedValue",value);}}},_selectAttributeOption:function(attributeSelection,optionToSelect){if(attributeSelection&&optionToSelect){// TEST Suggerimenti
if(attributeSelection.get("attributeID")!==-1){this.saveSuggestionsForSelectedOption(attributeSelection.get("attributeID"),optionToSelect.get("optionID"));}// Deseleziono l'opzione corrente
var optionToUnselect=attributeSelection.getSelectedOption();if(optionToUnselect)optionToUnselect.set("selected",false);// Seleziono la nuova opzione
optionToSelect.set("selected",true);}},checkCurrentModelColor:function(){var colorID=this.getModelColorIDForSelection();var colorID_HasValue=colorID!=null&&colorID!=undefined;var currentColorID_HasValue=this.currentModelColorID!=null&&this.currentModelColorID!=undefined;var changed=colorID_HasValue&&currentColorID_HasValue&&colorID!=this.currentModelColorID||!colorID_HasValue&&currentColorID_HasValue||colorID_HasValue&&!currentColorID_HasValue;if(changed){var evt={colorID:colorID};this.trigger("modelColorChanged",evt);}},// dato l'attributo e l'opzione selezionata, salva in suggestions le eventuali opzioni
// di altri attributi (al momento non abilitati) 
saveSuggestionsForSelectedOption:function(attributeID,optionID){this.get("suggestions")[attributeID]=[optionID];/*
        var attributeSelection = this.getAttributeSelection(attributeID);
        if (attributeSelection) {
            var optionSelection = attributeSelection.getOptionSelection(optionID);
            if (optionSelection) {
                // Per ora mi baso solo sul nome dell'attributo e dell'opzione
                var disabledAttributes = this.getDisabledAttributeSelections();
                for (var i = 0; i < disabledAttributes.length; i++) {
                    var disabledAttribute = disabledAttributes[i];
                    if (disabledAttribute.get("attributeID") != attributeID &&
                        disabledAttribute.get("name") == attributeSelection.get("name")) {

                        var suggestedOptionIDs = disabledAttribute.getOptionIDsByName(optionSelection.get("name"));
                        if (suggestedOptionIDs && suggestedOptionIDs.length > 0) {
                            this.get("suggestions")[disabledAttribute.get("attributeID")] = suggestedOptionIDs;
                        } else {
                            this.removeSuggestions(disabledAttribute.get("attributeID"));
                        }

                    }
                }
            }
        }
        */},getSuggestions:function(attributeID){if(this.get("suggestions").hasOwnProperty(attributeID))return this.get("suggestions")[attributeID];return null;},removeSuggestions:function(attributeID){if(this.get("suggestions").hasOwnProperty(attributeID))delete this.get("suggestions")[attributeID];},setupOnComposition:function(zkComposition){var zkModel=this.get("zkModel");if(zkModel&&zkComposition&&zkModel.get("modelID")==zkComposition.get("modelID")){this.detachEvents();for(var i=0;i<zkComposition.get("compositionItems").length;i++){var item=zkComposition.get("compositionItems").at(i);// Imposto la selezione per l'attributo
var attributeID=item.get("attributeID");var value=item.get("selectedValue");if(item.get("attributeTypeID")==MPlaza.AttributeType.Options&&item.get("selectedOptionID")!=null&&item.get("selectedOptionID")!=undefined){value=item.get("selectedOptionID");}this.selectAttributeValue(attributeID,value);}this.buildDependencies();this.checkAllConstraintExpressions();this.attachEvents();}},buildComposition:function(){var zkComposition=new MPlaza.Composition();this.updateComposition(zkComposition);return zkComposition;},updateComposition:function(zkComposition){var zkModel=this.get("zkModel");zkComposition.set("modelID",zkModel.get("modelID"));zkComposition.set("modelName",zkModel.get("name"));zkComposition.set("modelPrice",zkModel.get("price"));this.updateCompositionItems(zkComposition);},updateCompositionItems:function(zkComposition){var itemsToRemove=[];// Aggiorno gli item già esistenti e verifico se vanno eliminati
for(var i=0;i<zkComposition.get("compositionItems").length;i++){var item=zkComposition.get("compositionItems").at(i);// Verifico se l'attributo è ancora abilitato (altrimenti va eliminato)
var attributeSelection=this.getAttributeSelection(item.get("attributeID"));if(attributeSelection&&attributeSelection.get("enabled")){this.updateCompositionItem(item,attributeSelection);}else{itemsToRemove.push(item);}}// Verifico se ci sono attributi da aggiungere
var attributeSelections=this.getEnabledAttributeSelections();for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];var item=zkComposition.getCompositionItemByAttributeID(attributeSelection.get("attributeID"));if(!item){// Aggiungo il nuovo item
item=new MPlaza.CompositionItem();this.updateCompositionItem(item,attributeSelection);zkComposition.get("compositionItems").push(item);}}if(itemsToRemove.length>0)zkComposition.get("compositionItems").remove(itemsToRemove);},updateCompositionItem:function(zkCompositionItem,attributeSelection){zkCompositionItem.set("attributeID",attributeSelection.get("attributeID"));zkCompositionItem.set("attributeGuid",attributeSelection.get("attributeGuid"));zkCompositionItem.set("attributeTypeID",attributeSelection.get("attributeTypeID"));zkCompositionItem.set("attributeName",attributeSelection.get("name"));zkCompositionItem.set("attributeCode",attributeSelection.get("attributeCode"));if(attributeSelection.get("attributeTypeID")==MPlaza.AttributeType.Options){var selectedOption=attributeSelection.getSelectedOption();if(selectedOption){zkCompositionItem.set("selectedOptionID",selectedOption.get("optionID"));zkCompositionItem.set("selectedOptionGuid",selectedOption.get("optionGuid"));zkCompositionItem.set("selectedOptionCode",selectedOption.get("optionCode"));zkCompositionItem.set("selectedOptionName",selectedOption.get("name"));zkCompositionItem.set("selectedValue",null);}else{// errore Opzione non valida
}}else{var selectedValue=attributeSelection.get("selectedValue");zkCompositionItem.set("selectedOptionID",null);zkCompositionItem.set("selectedOptionGuid",null);zkCompositionItem.set("selectedOptionCode",null);zkCompositionItem.set("selectedValue",selectedValue);}},getModelColorIDForSelection:function(){// Recupera l'eventuale colorID corrispondente alla selezione
if(this.get("zkModel")){var zkModel=this.get("zkModel");var attributeSelectionColors=zkModel.get("attributeSelectionColors");if(attributeSelectionColors){for(var i=0;i<attributeSelectionColors.length;i++){var attributeSelectionColor=attributeSelectionColors[i];var expression=attributeSelectionColor.get("selectionExpression");var colorID=attributeSelectionColor.get("colorID");if(expression&&this.evaluateAttributeExpression(expression))return colorID;}}}return null;},getCompositionBaseJSON:function(){var composition={items:[]};var attributeSelections=this.getAllAttributeSelections();for(var i=0;i<attributeSelections.length;i++){var attributeSelection=attributeSelections[i];var attributeID=attributeSelection.get("attributeID");var item={code:attributeID,value:""};if(attributeSelection.get("enabled")){if(attributeSelection.get("attributeTypeID")===MPlaza.AttributeType.Options){var selectedOption=attributeSelection.getSelectedOption();if(selectedOption){item.value=selectedOption.get("optionID").toString();}}else{item.value=attributeSelection.get("selectedValue");}}else{item.value="disabled";}composition.items.push(item);}return JSON.stringify(composition);},getCompositionHashCode:function(){var json=this.getCompositionBaseJSON();//var hash = Zakeke.getStringHashCode(json);
var hash=CryptoJS.SHA1(json);return hash.toString();},refresh:function(){this.detachEvents();this._resetProperties();var zkModel=this.get("zkModel");var selection=this;if(zkModel&&zkModel instanceof MPlaza.Model){// function che crea un attributSelecton corrispondente ad un attribute
// e lo aggiunge al gruppo indicato
var addAttributeToGroup=function(zkAttribute,group){var attribute=new Zakeke.AttributeSelection();attribute.set("attributeID",zkAttribute.get("attributeID"));attribute.set("attributeGuid",zkAttribute.get("attributeGuid"));attribute.set("attributeCode",zkAttribute.get("attributeCode"));attribute.set("attributeTypeID",zkAttribute.get("attributeTypeID"));attribute.set("groupID",group.get("groupID"));attribute.set("name",zkAttribute.get("name"));attribute.set("optionPreviewShapeID",zkAttribute.get("optionPreviewShapeID"));group.get("attributes").add(attribute);// Opzioni
// Il valore di default impostato sull'attributo è da utilizzare solo nel caso
// di attributo a valore (numero, colore, ecc.).
// Nel caso di elenco opzioni, per ogni opzione c'è l'indicazione se si tratta
// dell'opzione di default.
var defaultValue=zkAttribute.get("defaultValue");if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Options){var zkOptions=zkAttribute.get("options").sortBy(function(item){return item.get("displayOrder");});var selectedOption=null;for(var j=0;j<zkOptions.length;j++){var zkOption=zkOptions[j];var selected=zkOption.get("isDefault")&&selectedOption==null;var option=new Zakeke.OptionSelection();option.set("optionID",zkOption.get("optionID"));option.set("optionGuid",zkOption.get("optionGuid"));option.set("optionCode",zkOption.get("optionCode"));option.set("attributeID",zkAttribute.get("attributeID"));option.set("name",zkOption.get("name"));option.set("selected",selected);option.set("enabled",true);if(selected)selectedOption=option;attribute.get("options").add(option);}// se non ci sono elementi selezionati di default, seleziono il primo (se c'è)
if(selectedOption==null&&attribute.get("options").length>0)attribute.get("options").at(0).set("selected",true);}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Color){if(defaultValue)attribute.set("selectedValue",defaultValue);else attribute.selectedValue="#ffffff";}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Number){if(defaultValue&&!isNaN(defaultValue))attribute.set("selectedValue",defaultValue);else attribute.selectedValue=0;}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Number){if(defaultValue)attribute.set("selectedValue",defaultValue);else attribute.selectedValue="";}};;// Creo i gruppi di attributi in corrispondenza a quelli del prodotto
// Recupero i gruppi di attributi ordinati per display order
var zkGroups=zkModel.get("attributeGroups").sortBy(function(item){return item.get("displayOrder");});zkGroups.forEach(function(zkGroup){// recupero gli attributi che hanno lo stesso gruppo
var groupID=zkGroup.get("groupID");var group=new Zakeke.AttributeGroupSelection();group.set("groupID",zkGroup.get("groupID"));group.set("groupGuid",zkGroup.get("groupGuid"));group.set("name",zkGroup.get("name"));selection.get("groups").add(group);// Attributi
var zkAttributes=zkModel.get("attributes").where({groupID:groupID}).sort(function(a1,a2){return a1.get("displayOrder")-a2.get("displayOrder");});for(var i=0;i<zkAttributes.length;i++){var zkAttribute=zkAttributes[i];addAttributeToGroup(zkAttribute,group);}});// Recupero gli attributi non associati a nessun gruppo e li inserisco in un gruppo di default
var zkOtherAttributes=zkModel.getAttributesWithoutGroup();if(zkOtherAttributes.length>0){var group=new Zakeke.AttributeGroupSelection();group.set("groupID",-1);group.set("groupGuid","");group.set("name","default");selection.get("groups").add(group);for(var i=0;i<zkOtherAttributes.length;i++){var zkAttribute=zkOtherAttributes[i];addAttributeToGroup(zkAttribute,group);}}}this.buildDependencies();this.checkAllConstraintExpressions();this.attachEvents();},_resetProperties:function(){this.set("groups",new Zakeke.AttributeGroupSelectionCollection());this.set("attributeDependencies",{});this.set("optionDependencies",{});this.set("suggestions",{});this.set("currentModelColorID",null);}},// Static methods
{CreateComposerSelection:function(zkModel){var selection=new Zakeke.ComposerSelection();selection.set("zkModel",zkModel);// Costruisce la selezione di base a partire dai valori di default degli attributi
if(zkModel&&zkModel instanceof MPlaza.Model){// function che crea un attributSelecton corrispondente ad un attribute
// e lo aggiunge al gruppo indicato
var addAttributeToGroup=function(zkAttribute,group){var attribute=new Zakeke.AttributeSelection();attribute.set("attributeID",zkAttribute.get("attributeID"));attribute.set("attributeGuid",zkAttribute.get("attributeGuid"));attribute.set("attributeCode",zkAttribute.get("attributeCode"));attribute.set("attributeTypeID",zkAttribute.get("attributeTypeID"));attribute.set("groupID",group.get("groupID"));attribute.set("name",zkAttribute.get("name"));attribute.set("optionPreviewShapeID",zkAttribute.get("optionPreviewShapeID"));group.get("attributes").add(attribute);// Opzioni
// Il valore di default impostato sull'attributo è da utilizzare solo nel caso
// di attributo a valore (numero, colore, ecc.).
// Nel caso di elenco opzioni, per ogni opzione c'è l'indicazione se si tratta
// dell'opzione di default.
var defaultValue=zkAttribute.get("defaultValue");if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Options){var zkOptions=zkAttribute.get("options").sortBy(function(item){return item.get("displayOrder");});var selectedOption=null;for(var j=0;j<zkOptions.length;j++){var zkOption=zkOptions[j];var selected=zkOption.get("isDefault")&&selectedOption==null;var option=new Zakeke.OptionSelection();option.set("optionID",zkOption.get("optionID"));option.set("optionGuid",zkOption.get("optionGuid"));option.set("optionCode",zkOption.get("optionCode"));option.set("attributeID",zkAttribute.get("attributeID"));option.set("name",zkOption.get("name"));option.set("selected",selected);option.set("enabled",true);if(selected)selectedOption=option;attribute.get("options").add(option);}// se non ci sono elementi selezionati di default, seleziono il primo (se c'è)
if(selectedOption==null&&attribute.get("options").length>0)attribute.get("options").at(0).set("selected",true);}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Color){if(defaultValue)attribute.set("selectedValue",defaultValue);else attribute.selectedValue="#ffffff";}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Number){if(defaultValue&&!isNaN(defaultValue))attribute.set("selectedValue",defaultValue);else attribute.selectedValue=0;}else if(zkAttribute.get("attributeTypeID")==MPlaza.AttributeType.Number){if(defaultValue)attribute.set("selectedValue",defaultValue);else attribute.selectedValue="";}};// Creo i gruppi di attributi in corrispondenza a quelli del prodotto
// Recupero i gruppi di attributi ordinati per display order
var zkGroups=zkModel.get("attributeGroups").sortBy(function(item){return item.get("displayOrder");});zkGroups.forEach(function(zkGroup){// recupero gli attributi che hanno lo stesso gruppo
var groupID=zkGroup.get("groupID");var group=new Zakeke.AttributeGroupSelection();group.set("groupID",zkGroup.get("groupID"));group.set("groupGuid",zkGroup.get("groupGuid"));group.set("name",zkGroup.get("name"));selection.get("groups").add(group);// Attributi
var zkAttributes=zkModel.get("attributes").where({groupID:groupID}).sort(function(a1,a2){return a1.get("displayOrder")-a2.get("displayOrder");});for(var i=0;i<zkAttributes.length;i++){var zkAttribute=zkAttributes[i];addAttributeToGroup(zkAttribute,group);}});// Recupero gli attributi non associati a nessun gruppo e li inserisco in un gruppo di default
var zkOtherAttributes=zkModel.getAttributesWithoutGroup();if(zkOtherAttributes.length>0){var group=new Zakeke.AttributeGroupSelection();group.set("groupID",-1);group.set("groupGuid","");group.set("name","default");selection.get("groups").add(group);for(var i=0;i<zkOtherAttributes.length;i++){var zkAttribute=zkOtherAttributes[i];addAttributeToGroup(zkAttribute,group);}}}selection.buildDependencies();selection.checkAllConstraintExpressions();selection.attachEvents();return selection;}});BABYLON.Tmp=BABYLON.TmpColors;var _0xc101=["\x73\x65\x74\x50\x72\x6F\x74\x6F\x74\x79\x70\x65\x4F\x66","\x5F\x5F\x70\x72\x6F\x74\x6F\x5F\x5F","\x68\x61\x73\x4F\x77\x6E\x50\x72\x6F\x70\x65\x72\x74\x79","\x63\x6F\x6E\x73\x74\x72\x75\x63\x74\x6F\x72","\x70\x72\x6F\x74\x6F\x74\x79\x70\x65","\x63\x72\x65\x61\x74\x65","\x6C\x65\x6E\x67\x74\x68","\x67\x65\x74\x4F\x77\x6E\x50\x72\x6F\x70\x65\x72\x74\x79\x44\x65\x73\x63\x72\x69\x70\x74\x6F\x72","\x6F\x62\x6A\x65\x63\x74","\x64\x65\x63\x6F\x72\x61\x74\x65","\x66\x75\x6E\x63\x74\x69\x6F\x6E","\x64\x65\x66\x69\x6E\x65\x50\x72\x6F\x70\x65\x72\x74\x79","\x54\x6F\x6F\x6C\x73","\x49\x6E\x69\x74","\x53\x65\x74\x75\x70\x43\x75\x73\x74\x6F\x6D\x53\x68\x61\x64\x65\x72\x73","\x49\x6E\x63\x6C\x75\x64\x65\x73\x53\x68\x61\x64\x65\x72\x73\x53\x74\x6F\x72\x65","\x45\x66\x66\x65\x63\x74","\x53\x68\x61\x64\x65\x72\x73\x53\x74\x6F\x72\x65","\x44\x65\x66\x69\x6E\x65\x50\x42\x52\x4D\x61\x74\x65\x72\x69\x61\x6C","\x63\x61\x6C\x6C","\x70\x37\x48\x35\x42\x65\x4E\x6F","\x47\x73\x36\x32\x48\x63\x67\x34","\x61\x39\x45\x52\x6E\x35\x32\x57","\x45\x78\x34\x38\x48\x79\x62\x37","\x5A\x6E\x32\x6D\x38\x53\x54\x64","\x58\x79\x35\x66\x33\x46\x4D\x62","\x4E\x7A\x35\x32\x51\x63\x67\x39","\x54\x61\x36\x33\x41\x63\x66\x37","\x48\x70\x34\x6D\x32\x42\x57\x66","\x51\x73\x33\x62\x39\x57\x32\x54","\x6F\x36\x47\x41\x63\x39\x73\x37","\x6F\x36\x50\x4A\x77\x39\x38\x44","\x61\x32\x53\x42\x6A\x38\x79\x33","\x50\x6E\x34\x6D\x38\x57\x39\x45","\x6E\x37\x44\x33\x45\x6A\x58\x6D","\x47\x66\x34\x69\x33\x59\x38\x53","\x6F\x33\x4A\x5A\x6A\x32\x79\x38","\x59\x6A\x39\x38\x46\x77\x5A\x6E","\x77\x39\x43\x33\x59\x65\x6E\x34","\x74\x37\x50\x57\x65\x32\x77\x36","\x6A\x32\x57\x42\x79\x35\x39\x5A","\x72\x36\x59\x57\x79\x32\x33\x4A","\x64\x35\x51\x38\x4E\x73\x77\x39","\x50\x61\x36\x73\x33\x57\x47\x71","\x6A\x35\x41\x48\x62\x38\x67\x36","\x51\x74\x33\x36\x43\x66\x44\x79","\x45\x63\x34\x32\x43\x64\x59\x7A","\x49\x4E\x53\x54\x41\x4E\x43\x45\x53","\x62\x38\x57\x34\x46\x79\x71\x39","\x44\x61\x39\x69\x34\x5A\x58\x74","\x42\x73\x32\x37\x4A\x69\x57\x71","\x4E\x55\x4D\x5F\x42\x4F\x4E\x45\x5F\x49\x4E\x46\x4C\x55\x45\x4E\x43\x45\x52\x53","\x42\x6F\x6E\x65\x73\x50\x65\x72\x4D\x65\x73\x68","\x72\x65\x62\x75\x69\x6C\x64","\x5F\x61\x6C\x62\x65\x64\x6F\x43\x6F\x6C\x6F\x72","\x5F\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x43\x6F\x6C\x6F\x72","\x5F\x73\x70\x65\x63\x75\x6C\x61\x72\x43\x6F\x6C\x6F\x72","\x5F\x67\x6C\x6F\x73\x73\x69\x6E\x65\x73\x73","\x5F\x61\x6D\x62\x69\x65\x6E\x74\x4C\x69\x67\x68\x74","\x5F\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79","\x5F\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65","\x5F\x61\x6F\x50\x6F\x77\x65\x72","\x5F\x72\x69\x6D\x43\x6F\x6C\x6F\x72","\x5F\x72\x69\x6D\x50\x6F\x77\x65\x72","\x5F\x72\x69\x6D\x42\x69\x61\x73","\x5F\x61\x6F\x45\x78\x70\x6F\x73\x75\x72\x65","\x5F\x63\x61\x6D\x65\x72\x61\x43\x6F\x6E\x74\x72\x61\x73\x74","\x5F\x63\x61\x6D\x65\x72\x61\x45\x78\x70\x6F\x73\x75\x72\x65","\x5F\x65\x6E\x61\x62\x6C\x65\x45\x6E\x76\x43\x61\x70","\x5F\x75\x73\x65\x41\x4F\x54\x65\x78\x74\x75\x72\x65\x41\x73\x4C\x69\x67\x68\x74\x6D\x61\x70","\x5F\x75\x73\x65\x41\x6C\x70\x68\x61\x46\x72\x6F\x6D\x41\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65","\x5F\x64\x69\x73\x61\x62\x6C\x65\x4C\x69\x67\x68\x74\x69\x6E\x67","\x5F\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73","\x5F\x72\x65\x6E\x64\x65\x72\x54\x61\x72\x67\x65\x74\x73","\x5F\x67\x72\x61\x79\x57\x65\x69\x67\x68\x74\x73","\x5F\x6C\x75\x6D\x43\x6F\x65\x66\x66","\x5F\x72\x65\x6E\x64\x65\x72\x4D\x61\x74\x72\x69\x78","\x65\x6E\x61\x62\x6C\x65\x4D\x61\x74\x43\x61\x70","\x61\x70\x70\x6C\x79","\x5F\x6D\x61\x72\x6B\x41\x6C\x6C\x53\x75\x62\x4D\x65\x73\x68\x65\x73\x41\x73\x54\x65\x78\x74\x75\x72\x65\x73\x44\x69\x72\x74\x79","\x5F\x6D\x61\x72\x6B\x41\x6C\x6C\x53\x75\x62\x4D\x65\x73\x68\x65\x73\x41\x73\x4C\x69\x67\x68\x74\x73\x44\x69\x72\x74\x79","\x65\x6E\x61\x62\x6C\x65\x45\x6E\x76\x43\x61\x70","\x5F\x73\x68\x6F\x75\x6C\x64\x55\x73\x65\x41\x6C\x70\x68\x61\x46\x72\x6F\x6D\x41\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65","\x5F\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65","\x68\x61\x73\x41\x6C\x70\x68\x61","\x5F\x62\x75\x69\x6C\x64\x4C\x69\x67\x68\x74\x55\x6E\x69\x66\x6F\x72\x6D\x4C\x61\x79\x6F\x75\x74","\x5F\x70\x62\x72\x55\x6E\x69\x66\x6F\x72\x6D\x42\x75\x66\x66\x65\x72","\x67\x65\x74\x45\x6E\x67\x69\x6E\x65","\x51\x6E\x36\x35\x54\x62\x71\x34","\x61\x64\x64\x55\x6E\x69\x66\x6F\x72\x6D","\x59\x70\x33\x32\x42\x6A\x54\x79","\x66\x33\x4A\x46\x6E\x36\x39\x44","\x5F\x70\x72\x65\x70\x61\x72\x65\x44\x65\x66\x69\x6E\x65\x73\x46\x6F\x72\x4C\x69\x67\x68\x74\x73","\x5F\x6C\x69\x67\x68\x74\x53\x6F\x75\x72\x63\x65\x73","\x64\x32\x45\x4B\x7A\x36\x35\x58","\x67\x65\x74\x54\x79\x70\x65\x49\x44","\x47\x6F\x38\x39\x57\x71\x43\x6E","\x54\x78\x36\x32\x4E\x74\x6F\x37","\x47\x66\x37\x38\x54\x6F\x6A\x36","\x58\x66\x33\x36\x43\x67\x65\x32","\x51\x72\x38\x6A\x33\x4D\x37\x42","\x57\x6E\x39\x79\x38\x45\x51\x72","\x50\x6F\x33\x32\x4A\x74\x62\x39","\x48\x6A\x36\x6D\x37\x50\x35\x44","\x4C\x49\x4E\x45\x41\x52\x44\x45\x50\x54\x48","\x72\x65\x63\x65\x69\x76\x65\x53\x68\x61\x64\x6F\x77\x73","\x73\x68\x61\x64\x6F\x77\x73\x45\x6E\x61\x62\x6C\x65\x64","\x73\x68\x61\x64\x6F\x77\x45\x6E\x61\x62\x6C\x65\x64","\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x47\x65\x6E\x65\x72\x61\x74\x6F\x72","\x44\x69\x72\x65\x63\x74\x69\x6F\x6E\x61\x6C\x4C\x69\x67\x68\x74","\x67\x65\x74\x43\x61\x70\x73","\x74\x65\x78\x74\x75\x72\x65\x46\x6C\x6F\x61\x74\x52\x65\x6E\x64\x65\x72","\x74\x65\x78\x74\x75\x72\x65\x46\x6C\x6F\x61\x74\x4C\x69\x6E\x65\x61\x72\x46\x69\x6C\x74\x65\x72\x69\x6E\x67","\x74\x65\x78\x74\x75\x72\x65\x48\x61\x6C\x66\x46\x6C\x6F\x61\x74\x52\x65\x6E\x64\x65\x72","\x74\x65\x78\x74\x75\x72\x65\x48\x61\x6C\x66\x46\x6C\x6F\x61\x74\x4C\x69\x6E\x65\x61\x72\x46\x69\x6C\x74\x65\x72\x69\x6E\x67","\x5F\x70\x72\x65\x70\x61\x72\x65\x55\x6E\x69\x66\x6F\x72\x6D\x73\x41\x6E\x64\x53\x61\x6D\x70\x6C\x65\x72\x73\x4C\x69\x73\x74","\x47\x77\x38\x34\x51\x64\x52\x6F","\x74\x36\x4D\x38\x4B\x73\x50\x71","\x67\x32\x41\x53\x61\x34\x70\x39","\x7A\x32\x4A\x38\x44\x65\x6B\x34","\x66\x36\x54\x35\x52\x62\x4C\x61","\x4A\x61\x38\x34\x52\x6D\x50\x63","\x78\x39\x52\x34\x44\x63\x6E\x37","\x64\x38\x41\x39\x51\x78\x4C\x65","\x4B\x64\x36\x61\x35\x44\x45\x6B","\x70\x75\x73\x68","\x69\x35\x50\x42\x71\x36\x64\x34","\x64\x33\x54\x38\x4D\x65\x62\x37","\x45\x7A\x32\x67\x39\x4C\x33\x4B","\x71\x36\x45\x34\x5A\x6D\x57\x61","\x5F\x62\x69\x6E\x64\x4C\x69\x67\x68\x74\x53\x68\x61\x64\x6F\x77","\x67\x65\x74\x54\x72\x61\x6E\x73\x66\x6F\x72\x6D\x4D\x61\x74\x72\x69\x78","\x73\x65\x74\x4D\x61\x74\x72\x69\x78","\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x4D\x61\x70","\x73\x65\x74\x54\x65\x78\x74\x75\x72\x65","","\x69\x6E\x66\x6F","\x5F\x62\x69\x6E\x64\x4C\x69\x67\x68\x74\x50\x72\x6F\x70\x65\x72\x74\x69\x65\x73","\x50\x6F\x69\x6E\x74\x4C\x69\x67\x68\x74","\x63\x6F\x6D\x70\x75\x74\x65\x54\x72\x61\x6E\x73\x66\x6F\x72\x6D\x65\x64\x49\x6E\x66\x6F\x72\x6D\x61\x74\x69\x6F\x6E","\x78","\x74\x72\x61\x6E\x73\x66\x6F\x72\x6D\x65\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E","\x79","\x7A","\x75\x70\x64\x61\x74\x65\x46\x6C\x6F\x61\x74\x33","\x70\x6F\x73\x69\x74\x69\x6F\x6E","\x74\x72\x61\x6E\x73\x66\x6F\x72\x6D\x65\x64\x44\x69\x72\x65\x63\x74\x69\x6F\x6E","\x64\x69\x72\x65\x63\x74\x69\x6F\x6E","\x50\x42\x52\x4D\x61\x74\x65\x72\x69\x61\x6C\x3A\x20\x41\x74\x74\x65\x6D\x70\x74\x20\x74\x6F\x20\x62\x69\x6E\x64\x20\x6C\x69\x67\x68\x74\x20\x70\x72\x6F\x70\x65\x72\x74\x69\x65\x73\x20\x66\x6F\x72\x20\x61\x6E\x20\x75\x6E\x68\x61\x6E\x64\x6C\x65\x64\x20\x6C\x69\x67\x68\x74\x20\x74\x79\x70\x65\x2E\x20\x50\x42\x52\x20\x6F\x6E\x6C\x79\x20\x73\x75\x70\x70\x6F\x72\x74\x73\x20\x50\x6F\x69\x6E\x74\x6C\x69\x67\x68\x74\x20\x61\x6E\x64\x20\x44\x69\x72\x65\x63\x74\x69\x6F\x6E\x61\x6C\x4C\x69\x67\x68\x74\x2E","\x5F\x62\x69\x6E\x64\x4C\x69\x67\x68\x74\x73","\x62\x69\x6E\x64\x54\x6F\x45\x66\x66\x65\x63\x74","\x69\x6E\x74\x65\x6E\x73\x69\x74\x79","\x43\x6F\x6C\x6F\x72\x33","\x54\x6D\x70","\x73\x63\x61\x6C\x65\x54\x6F\x52\x65\x66","\x64\x69\x66\x66\x75\x73\x65","\x75\x70\x64\x61\x74\x65\x43\x6F\x6C\x6F\x72\x33","\x73\x70\x65\x63\x75\x6C\x61\x72","\x75\x70\x64\x61\x74\x65","\x5F\x64\x6F\x4E\x6F\x74\x68\x69\x6E\x67","\x67\x65\x74\x43\x6C\x61\x73\x73\x4E\x61\x6D\x65","\x5A\x61\x6B\x65\x6B\x65\x2E\x50\x42\x52\x4D\x61\x74\x65\x72\x69\x61\x6C","\x67\x65\x74\x52\x65\x6E\x64\x65\x72\x54\x61\x72\x67\x65\x74\x54\x65\x78\x74\x75\x72\x65\x73","\x72\x65\x73\x65\x74","\x5F\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x54\x65\x78\x74\x75\x72\x65","\x69\x73\x52\x65\x6E\x64\x65\x72\x54\x61\x72\x67\x65\x74","\x6E\x65\x65\x64\x41\x6C\x70\x68\x61\x42\x6C\x65\x6E\x64\x69\x6E\x67","\x61\x6C\x70\x68\x61","\x5F\x6F\x70\x61\x63\x69\x74\x79\x54\x65\x78\x74\x75\x72\x65","\x5F\x6F\x70\x61\x63\x69\x74\x79\x46\x72\x65\x73\x6E\x65\x6C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x73","\x69\x73\x45\x6E\x61\x62\x6C\x65\x64","\x6E\x65\x65\x64\x41\x6C\x70\x68\x61\x54\x65\x73\x74\x69\x6E\x67","\x67\x65\x74\x41\x6C\x70\x68\x61\x54\x65\x73\x74\x54\x65\x78\x74\x75\x72\x65","\x69\x73\x52\x65\x61\x64\x79\x46\x6F\x72\x53\x75\x62\x4D\x65\x73\x68","\x69\x73\x46\x72\x6F\x7A\x65\x6E","\x5F\x77\x61\x73\x50\x72\x65\x76\x69\x6F\x75\x73\x6C\x79\x52\x65\x61\x64\x79","\x65\x66\x66\x65\x63\x74","\x5F\x6D\x61\x74\x65\x72\x69\x61\x6C\x44\x65\x66\x69\x6E\x65\x73","\x67\x65\x74\x53\x63\x65\x6E\x65","\x63\x68\x65\x63\x6B\x52\x65\x61\x64\x79\x4F\x6E\x45\x76\x65\x72\x79\x43\x61\x6C\x6C","\x5F\x72\x65\x6E\x64\x65\x72\x49\x64","\x67\x65\x74\x52\x65\x6E\x64\x65\x72\x49\x64","\x5F\x61\x72\x65\x4C\x69\x67\x68\x74\x73\x44\x69\x72\x74\x79","\x6C\x69\x67\x68\x74\x73\x45\x6E\x61\x62\x6C\x65\x64","\x5F\x6E\x65\x65\x64\x4E\x6F\x72\x6D\x61\x6C\x73","\x5F\x61\x72\x65\x54\x65\x78\x74\x75\x72\x65\x73\x44\x69\x72\x74\x79","\x5F\x6E\x65\x65\x64\x55\x56\x73","\x74\x65\x78\x74\x75\x72\x65\x73\x45\x6E\x61\x62\x6C\x65\x64","\x74\x65\x78\x74\x75\x72\x65\x4C\x4F\x44","\x69\x73\x52\x65\x61\x64\x79\x4F\x72\x4E\x6F\x74\x42\x6C\x6F\x63\x6B\x69\x6E\x67","\x73\x74\x61\x6E\x64\x61\x72\x64\x44\x65\x72\x69\x76\x61\x74\x69\x76\x65\x73","\x5F\x62\x75\x6D\x70\x54\x65\x78\x74\x75\x72\x65","\x5F\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x54\x65\x78\x74\x75\x72\x65","\x5F\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x54\x65\x78\x74\x75\x72\x65","\x5F\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x43\x65\x6E\x74\x65\x72","\x5F\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x42\x42\x6F\x78\x4D\x69\x6E","\x5F\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x42\x42\x6F\x78\x4D\x61\x78","\x67\x65\x74\x41\x6C\x70\x68\x61\x46\x72\x6F\x6D\x52\x47\x42","\x5F\x61\x6F\x54\x65\x78\x74\x75\x72\x65","\x5F\x61\x6D\x62\x69\x65\x6E\x74\x54\x65\x78\x74\x75\x72\x65","\x5F\x6D\x61\x74\x43\x61\x70\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x54\x65\x78\x74\x75\x72\x65","\x5F\x62\x61\x63\x6B\x46\x61\x63\x65\x43\x75\x6C\x6C\x69\x6E\x67","\x5F\x61\x72\x65\x46\x72\x65\x73\x6E\x65\x6C\x44\x69\x72\x74\x79","\x5F\x61\x72\x65\x4D\x69\x73\x63\x44\x69\x72\x74\x79","\x5F\x61\x72\x65\x41\x74\x74\x72\x69\x62\x75\x74\x65\x73\x44\x69\x72\x74\x79","\x5F\x6E\x6F\x72\x6D\x61\x6C\x73","\x5F\x75\x76\x73","\x56\x65\x72\x74\x65\x78\x42\x75\x66\x66\x65\x72","\x69\x73\x56\x65\x72\x74\x69\x63\x65\x73\x44\x61\x74\x61\x50\x72\x65\x73\x65\x6E\x74","\x75\x73\x65\x42\x6F\x6E\x65\x73","\x63\x6F\x6D\x70\x75\x74\x65\x42\x6F\x6E\x65\x73\x55\x73\x69\x6E\x67\x53\x68\x61\x64\x65\x72\x73","\x6E\x75\x6D\x42\x6F\x6E\x65\x49\x6E\x66\x6C\x75\x65\x6E\x63\x65\x72\x73","\x62\x6F\x6E\x65\x73","\x73\x6B\x65\x6C\x65\x74\x6F\x6E","\x6D\x61\x72\x6B\x41\x73\x55\x6E\x70\x72\x6F\x63\x65\x73\x73\x65\x64","\x69\x73\x44\x69\x72\x74\x79","\x6D\x61\x72\x6B\x41\x73\x50\x72\x6F\x63\x65\x73\x73\x65\x64","\x72\x65\x73\x65\x74\x43\x61\x63\x68\x65\x64\x4D\x61\x74\x65\x72\x69\x61\x6C","\x45\x66\x66\x65\x63\x74\x46\x61\x6C\x6C\x62\x61\x63\x6B\x73","\x4D\x61\x74\x65\x72\x69\x61\x6C\x48\x65\x6C\x70\x65\x72","\x50\x6F\x73\x69\x74\x69\x6F\x6E\x4B\x69\x6E\x64","\x7A\x6B\x5F\x70\x62\x72","\x5F\x63\x61\x63\x68\x65\x64\x44\x65\x66\x69\x6E\x65\x73","\x6E\x61\x6D\x65","\x77\x6F\x72\x6C\x64","\x76\x69\x65\x77","\x76\x69\x65\x77\x50\x72\x6F\x6A\x65\x63\x74\x69\x6F\x6E","\x76\x45\x79\x65\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57","\x4C\x6B\x38\x78\x35\x54\x33\x47","\x4A\x69\x32\x33\x4B\x7A\x4D\x64","\x58\x6F\x38\x71\x34\x41\x32\x52","\x57\x72\x35\x69\x38\x52\x33\x53","\x4C\x6A\x37\x71\x38\x48\x32\x4B","\x47\x72\x32\x70\x33\x53\x34\x54","\x71\x34\x41\x35\x44\x69\x79\x38","\x66\x38\x45\x32\x57\x78\x63\x33","\x69\x35\x4C\x45\x70\x33\x65\x38","\x45\x7A\x34\x67\x36\x50\x48\x63","\x74\x33\x47\x51\x6E\x34\x6D\x38","\x72\x38\x54\x4C\x61\x33\x74\x35","\x66\x32\x54\x48\x77\x38\x73\x35","\x6E\x35\x4A\x38\x41\x66\x79\x32","\x4C\x72\x34\x35\x4A\x62\x45\x69","\x63\x39\x46\x34\x58\x6D\x44\x69","\x78\x34\x53\x36\x4C\x6A\x74\x32","\x44\x79\x38\x34\x42\x72\x77\x36","\x58\x6D\x38\x36\x42\x79\x65\x37","\x48\x65\x39\x63\x34\x58\x32\x4D","\x45\x6D\x39\x34\x5A\x78\x73\x37","\x6A\x32\x4E\x34\x44\x66\x4B\x70","\x7A\x39\x45\x38\x44\x72\x65\x33","\x6F\x39\x45\x44\x74\x38\x37\x48","\x45\x77\x34\x36\x4B\x65\x73\x33","\x62\x34\x4D\x33\x48\x63\x53\x69","\x47\x6B\x39\x37\x57\x71\x64\x35","\x42\x74\x35\x32\x5A\x6E\x78\x38","\x7A\x39\x4C\x47\x71\x33\x35\x50","\x4A\x69\x36\x78\x38\x4B\x59\x7A","\x62\x36\x42\x39\x57\x6A\x66\x32","\x47\x65\x36\x39\x50\x69\x72\x37","\x6D\x42\x6F\x6E\x65\x73","\x57\x71\x36\x74\x34\x44\x42\x65","\x67\x38\x47\x32\x57\x66\x63\x34","\x7A\x39\x43\x38\x42\x73\x6E\x33","\x67\x33\x42\x5A\x78\x35\x65\x39","\x71\x36\x4B\x57\x74\x39\x37\x43","\x48\x77\x34\x33\x4A\x79\x61\x36","\x45\x69\x35\x62\x37\x41\x44\x79","\x4E\x7A\x32\x6E\x33\x44\x5A\x73","\x4E\x64\x37\x6D\x33\x57\x58\x6E","\x44\x67\x36\x38\x43\x70\x4D\x62","\x46\x77\x36\x34\x52\x6E\x69\x32","\x6D\x37\x4D\x48\x6B\x33\x62\x34","\x4D\x61\x74\x65\x72\x69\x61\x6C","\x53\x63\x65\x6E\x65","\x6F\x6E\x43\x6F\x6D\x70\x69\x6C\x65\x64","\x6F\x6E\x45\x72\x72\x6F\x72","\x63\x72\x65\x61\x74\x65\x45\x66\x66\x65\x63\x74","\x73\x65\x74\x45\x66\x66\x65\x63\x74","\x62\x75\x69\x6C\x64\x55\x6E\x69\x66\x6F\x72\x6D\x4C\x61\x79\x6F\x75\x74","\x69\x73\x52\x65\x61\x64\x79","\x5F\x75\x6E\x69\x66\x6F\x72\x6D\x42\x75\x66\x66\x65\x72","\x75\x6E\x62\x69\x6E\x64","\x5F\x61\x63\x74\x69\x76\x65\x45\x66\x66\x65\x63\x74","\x62\x69\x6E\x64\x46\x6F\x72\x53\x75\x62\x4D\x65\x73\x68","\x62\x69\x6E\x64\x4F\x6E\x6C\x79\x57\x6F\x72\x6C\x64\x4D\x61\x74\x72\x69\x78","\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79","\x62\x69\x6E\x64\x56\x69\x65\x77\x50\x72\x6F\x6A\x65\x63\x74\x69\x6F\x6E","\x75\x73\x65\x55\x62\x6F","\x69\x73\x53\x79\x6E\x63","\x74\x6F\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65","\x6C\x65\x66\x74\x43\x6F\x6C\x6F\x72","\x72\x69\x67\x68\x74\x43\x6F\x6C\x6F\x72","\x62\x69\x61\x73","\x70\x6F\x77\x65\x72","\x75\x70\x64\x61\x74\x65\x43\x6F\x6C\x6F\x72\x34","\x63\x6F\x6F\x72\x64\x69\x6E\x61\x74\x65\x73\x49\x6E\x64\x65\x78","\x6C\x65\x76\x65\x6C","\x75\x70\x64\x61\x74\x65\x46\x6C\x6F\x61\x74\x32","\x67\x65\x74\x54\x65\x78\x74\x75\x72\x65\x4D\x61\x74\x72\x69\x78","\x75\x70\x64\x61\x74\x65\x4D\x61\x74\x72\x69\x78","\x75\x70\x64\x61\x74\x65\x46\x6C\x6F\x61\x74","\x77\x69\x64\x74\x68","\x67\x65\x74\x53\x69\x7A\x65","\x6C\x6F\x67","\x4C\x4F\x47\x32\x45","\x72\x6F\x75\x6E\x64","\x75\x70\x64\x61\x74\x65\x56\x65\x63\x74\x6F\x72\x33","\x61\x63\x74\x69\x76\x65\x43\x61\x6D\x65\x72\x61","\x73\x65\x74\x56\x65\x63\x74\x6F\x72\x33","\x62\x69\x6E\x64\x56\x69\x65\x77","\x64\x69\x73\x70\x6F\x73\x65","\x67\x65\x74\x41\x63\x74\x69\x76\x65\x54\x65\x78\x74\x75\x72\x65\x73","\x68\x61\x73\x54\x65\x78\x74\x75\x72\x65","\x63\x6C\x6F\x6E\x65","\x53\x65\x72\x69\x61\x6C\x69\x7A\x61\x74\x69\x6F\x6E\x48\x65\x6C\x70\x65\x72","\x69\x64","\x63\x72\x65\x61\x74\x65\x50\x42\x52\x42\x6C\x65\x6E\x64\x4D\x61\x74\x65\x72\x69\x61\x6C","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65","\x63\x75\x73\x74\x6F\x6D\x54\x79\x70\x65","\x50\x61\x72\x73\x65","\x61\x6C\x62\x65\x64\x6F\x43\x6F\x6C\x6F\x72","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65\x41\x73\x43\x6F\x6C\x6F\x72\x33","\x65\x78\x70\x61\x6E\x64\x54\x6F\x50\x72\x6F\x70\x65\x72\x74\x79","\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x43\x6F\x6C\x6F\x72","\x73\x70\x65\x63\x75\x6C\x61\x72\x43\x6F\x6C\x6F\x72","\x67\x6C\x6F\x73\x73\x69\x6E\x65\x73\x73","\x61\x6D\x62\x69\x65\x6E\x74\x4C\x69\x67\x68\x74","\x69\x6E\x64\x69\x72\x65\x63\x74\x4C\x69\x67\x68\x74\x50\x6F\x77\x65\x72","\x72\x69\x6D\x43\x6F\x6C\x6F\x72","\x72\x69\x6D\x42\x69\x61\x73","\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65\x41\x73\x54\x65\x78\x74\x75\x72\x65","\x62\x75\x6D\x70\x54\x65\x78\x74\x75\x72\x65","\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x54\x65\x78\x74\x75\x72\x65","\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79","\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x54\x65\x78\x74\x75\x72\x65","\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65","\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x54\x65\x78\x74\x75\x72\x65","\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x43\x65\x6E\x74\x65\x72","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65\x41\x73\x56\x65\x63\x74\x6F\x72\x33","\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x42\x42\x6F\x78\x4D\x69\x6E","\x70\x61\x72\x61\x6C\x6C\x61\x78\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x42\x42\x6F\x78\x4D\x61\x78","\x6F\x70\x61\x63\x69\x74\x79\x54\x65\x78\x74\x75\x72\x65","\x61\x6F\x54\x65\x78\x74\x75\x72\x65","\x41\x4F\x54\x65\x78\x74\x75\x72\x65","\x61\x6F\x50\x6F\x77\x65\x72","\x41\x4F\x50\x6F\x77\x65\x72","\x61\x6F\x45\x78\x70\x6F\x73\x75\x72\x65","\x41\x4F\x45\x78\x70\x6F\x73\x75\x72\x65","\x6D\x61\x74\x43\x61\x70\x41\x6D\x62\x69\x65\x6E\x74\x54\x65\x78\x74\x75\x72\x65","\x61\x6D\x62\x69\x65\x6E\x74\x54\x65\x78\x74\x75\x72\x65","\x6D\x61\x74\x43\x61\x70\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x54\x65\x78\x74\x75\x72\x65","\x75\x73\x65\x41\x4F\x54\x65\x78\x74\x75\x72\x65\x41\x73\x4C\x69\x67\x68\x74\x6D\x61\x70","\x75\x73\x65\x41\x6C\x70\x68\x61\x46\x72\x6F\x6D\x41\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65","\x6F\x70\x61\x63\x69\x74\x79\x46\x72\x65\x73\x6E\x65\x6C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x73","\x73\x65\x72\x69\x61\x6C\x69\x7A\x65\x41\x73\x46\x72\x65\x73\x6E\x65\x6C\x50\x61\x72\x61\x6D\x65\x74\x65\x72\x73","\x5F\x6D\x61\x72\x6B\x41\x6C\x6C\x53\x75\x62\x4D\x65\x73\x68\x65\x73\x41\x73\x46\x72\x65\x73\x6E\x65\x6C\x44\x69\x72\x74\x79","\x72\x69\x6D\x50\x6F\x77\x65\x72","\x5F\x6D\x61\x72\x6B\x41\x6C\x6C\x53\x75\x62\x4D\x65\x73\x68\x65\x73\x41\x73\x4D\x69\x73\x63\x44\x69\x72\x74\x79","\x63\x61\x6D\x65\x72\x61\x43\x6F\x6E\x74\x72\x61\x73\x74","\x63\x61\x6D\x65\x72\x61\x45\x78\x70\x6F\x73\x75\x72\x65","\x64\x69\x73\x61\x62\x6C\x65\x4C\x69\x67\x68\x74\x69\x6E\x67","\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73","\x50\x42\x52\x4D\x61\x74\x65\x72\x69\x61\x6C","\x50\x42\x52\x4D\x61\x74\x65\x72\x69\x61\x6C\x44\x65\x66\x69\x6E\x65\x73","\x44\x65\x66\x69\x6E\x65\x43\x75\x73\x74\x6F\x6D\x4D\x61\x74\x65\x72\x69\x61\x6C\x73","\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x23\x65\x78\x74\x65\x6E\x73\x69\x6F\x6E\x20\x47\x4C\x5F\x4F\x45\x53\x5F\x73\x74\x61\x6E\x64\x61\x72\x64\x5F\x64\x65\x72\x69\x76\x61\x74\x69\x76\x65\x73\x20\x3A\x20\x65\x6E\x61\x62\x6C\x65\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x4E\x7A\x35\x32\x51\x63\x67\x39\x0A\x23\x65\x78\x74\x65\x6E\x73\x69\x6F\x6E\x20\x47\x4C\x5F\x45\x58\x54\x5F\x73\x68\x61\x64\x65\x72\x5F\x74\x65\x78\x74\x75\x72\x65\x5F\x6C\x6F\x64\x20\x3A\x20\x65\x6E\x61\x62\x6C\x65\x0A\x23\x65\x6E\x64\x69\x66\x0A\x70\x72\x65\x63\x69\x73\x69\x6F\x6E\x20\x68\x69\x67\x68\x70\x20\x66\x6C\x6F\x61\x74\x3B\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x5F\x5F\x64\x65\x63\x6C\x5F\x5F\x7A\x6B\x5F\x70\x62\x72\x46\x72\x61\x67\x6D\x65\x6E\x74\x3E\x0A\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x50\x49\x3D\x33\x2E\x31\x34\x31\x35\x39\x32\x36\x35\x33\x35\x38\x39\x37\x39\x33\x32\x33\x38\x34\x36\x32\x36\x34\x33\x33\x38\x33\x32\x37\x39\x35\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x6B\x52\x6F\x75\x67\x6E\x68\x65\x73\x73\x54\x6F\x41\x6C\x70\x68\x61\x53\x63\x61\x6C\x65\x20\x3D\x20\x30\x2E\x31\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x6B\x52\x6F\x75\x67\x6E\x68\x65\x73\x73\x54\x6F\x41\x6C\x70\x68\x61\x4F\x66\x66\x73\x65\x74\x20\x3D\x20\x30\x2E\x32\x39\x32\x34\x38\x31\x32\x35\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x6B\x4D\x69\x6E\x69\x6D\x75\x6D\x56\x61\x72\x69\x61\x6E\x63\x65\x20\x3D\x20\x30\x2E\x30\x30\x30\x35\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x66\x61\x63\x74\x5F\x31\x3D\x31\x2E\x30\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x66\x61\x63\x74\x5F\x32\x3D\x30\x2E\x30\x3B\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x70\x37\x48\x35\x42\x65\x4E\x6F\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x5F\x5F\x64\x65\x63\x6C\x5F\x5F\x7A\x6B\x5F\x70\x62\x72\x4C\x69\x67\x68\x74\x46\x72\x61\x67\x6D\x65\x6E\x74\x3E\x5B\x30\x2E\x2E\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73\x5D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x67\x33\x42\x5A\x78\x35\x65\x39\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x4B\x57\x74\x39\x37\x43\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x48\x77\x34\x33\x4A\x79\x61\x36\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x45\x69\x35\x62\x37\x41\x44\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x50\x4A\x77\x39\x38\x44\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x43\x75\x62\x65\x20\x4E\x64\x37\x6D\x33\x57\x58\x6E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x46\x77\x36\x34\x52\x6E\x69\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x59\x6A\x39\x38\x46\x77\x5A\x6E\x29\x20\x7C\x7C\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x47\x66\x34\x69\x33\x59\x38\x53\x29\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x6D\x37\x4D\x48\x6B\x33\x62\x34\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x74\x37\x50\x57\x65\x32\x77\x36\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x44\x67\x36\x38\x43\x70\x4D\x62\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6A\x32\x57\x42\x79\x35\x39\x5A\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x4E\x7A\x32\x6E\x33\x44\x5A\x73\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x6C\x66\x5F\x31\x20\x3D\x20\x31\x2E\x30\x3B\x0A\x63\x6F\x6E\x73\x74\x20\x66\x6C\x6F\x61\x74\x20\x6C\x66\x5F\x32\x20\x3D\x20\x30\x2E\x30\x3B\x0A\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x76\x45\x79\x65\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x3B\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x6A\x39\x46\x35\x4D\x6D\x77\x37\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x48\x67\x33\x32\x4E\x6B\x7A\x36\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x77\x39\x43\x33\x59\x65\x6E\x34\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x61\x33\x58\x34\x53\x70\x48\x71\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x48\x6F\x37\x65\x35\x4D\x36\x4E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x42\x70\x34\x71\x33\x53\x38\x45\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x5A\x6A\x32\x36\x41\x62\x79\x34\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x5A\x61\x39\x72\x34\x58\x4D\x6E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x6E\x39\x52\x4D\x77\x37\x62\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x77\x38\x4E\x5A\x67\x33\x34\x4D\x79\x4A\x78\x35\x39\x47\x65\x42\x3E\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x67\x39\x58\x34\x51\x64\x7A\x32\x4C\x4A\x62\x36\x37\x4D\x79\x54\x3E\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x41\x72\x32\x77\x34\x46\x52\x73\x35\x38\x4A\x70\x63\x33\x57\x36\x3E\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x6E\x38\x51\x32\x42\x7A\x69\x39\x4C\x58\x63\x35\x70\x36\x52\x47\x3E\x0A\x0A\x76\x6F\x69\x64\x20\x6D\x61\x69\x6E\x28\x76\x6F\x69\x64\x29\x0A\x7B\x0A\x76\x65\x63\x33\x20\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x3D\x76\x65\x63\x33\x28\x31\x2E\x30\x2C\x31\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x76\x65\x63\x33\x20\x56\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x76\x45\x79\x65\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x2D\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x6C\x70\x68\x61\x3D\x4C\x6B\x38\x78\x35\x54\x33\x47\x2E\x61\x3B\x0A\x76\x65\x63\x33\x20\x61\x6C\x62\x65\x64\x6F\x42\x6C\x65\x6E\x64\x3D\x4C\x6B\x38\x78\x35\x54\x33\x47\x2E\x72\x67\x62\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x76\x65\x63\x34\x20\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65\x43\x6F\x6C\x6F\x72\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x67\x33\x42\x5A\x78\x35\x65\x39\x2C\x6A\x39\x46\x35\x4D\x6D\x77\x37\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x45\x63\x34\x32\x43\x64\x59\x7A\x0A\x69\x66\x20\x28\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65\x43\x6F\x6C\x6F\x72\x2E\x61\x3C\x7A\x39\x43\x38\x42\x73\x6E\x33\x5B\x33\x5D\x5B\x31\x5D\x29\x7B\x64\x69\x73\x63\x61\x72\x64\x3B\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x72\x36\x59\x57\x79\x32\x33\x4A\x0A\x61\x6C\x70\x68\x61\x2A\x3D\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65\x43\x6F\x6C\x6F\x72\x2E\x61\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x61\x6C\x62\x65\x64\x6F\x42\x6C\x65\x6E\x64\x2A\x3D\x61\x6C\x62\x65\x64\x6F\x54\x65\x78\x74\x75\x72\x65\x43\x6F\x6C\x6F\x72\x2E\x72\x67\x62\x2A\x4A\x69\x32\x33\x4B\x7A\x4D\x64\x2E\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x23\x69\x66\x64\x65\x66\x20\x6E\x37\x44\x33\x45\x6A\x58\x6D\x0A\x76\x65\x63\x33\x20\x6F\x70\x43\x6F\x6C\x6F\x72\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x46\x77\x36\x34\x52\x6E\x69\x32\x2C\x5A\x6A\x32\x36\x41\x62\x79\x34\x29\x2E\x72\x67\x62\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3D\x64\x6F\x74\x28\x57\x71\x36\x74\x34\x44\x42\x65\x2C\x6F\x70\x43\x6F\x6C\x6F\x72\x29\x3B\x0A\x61\x6C\x70\x68\x61\x2A\x3D\x6C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2A\x78\x34\x53\x36\x4C\x6A\x74\x32\x2E\x79\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x70\x61\x63\x69\x74\x79\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x46\x77\x36\x34\x52\x6E\x69\x32\x2C\x5A\x6A\x32\x36\x41\x62\x79\x34\x29\x2E\x61\x3B\x0A\x61\x6C\x70\x68\x61\x2A\x3D\x6F\x70\x61\x63\x69\x74\x79\x2A\x78\x34\x53\x36\x4C\x6A\x74\x32\x2E\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x76\x65\x63\x33\x20\x4E\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x4E\x64\x6F\x74\x56\x3D\x64\x6F\x74\x28\x4E\x2C\x56\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x76\x65\x63\x32\x20\x76\x76\x5F\x31\x20\x3D\x20\x76\x65\x63\x32\x28\x66\x61\x63\x74\x5F\x31\x2C\x20\x66\x61\x63\x74\x5F\x31\x29\x3B\x0A\x76\x65\x63\x32\x20\x76\x76\x5F\x32\x20\x3D\x20\x76\x65\x63\x32\x28\x66\x61\x63\x74\x5F\x32\x2C\x20\x66\x61\x63\x74\x5F\x32\x29\x3B\x0A\x4E\x3D\x70\x65\x72\x74\x75\x72\x62\x4E\x6F\x72\x6D\x61\x6C\x28\x56\x2C\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x2C\x20\x76\x76\x5F\x31\x2C\x20\x76\x76\x5F\x32\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x0A\x76\x65\x63\x33\x20\x4E\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x76\x65\x63\x33\x28\x31\x2E\x30\x29\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x64\x35\x51\x38\x4E\x73\x77\x39\x0A\x4E\x3D\x67\x6C\x5F\x46\x72\x6F\x6E\x74\x46\x61\x63\x69\x6E\x67\x20\x3F\x20\x4E\x20\x3A\x20\x2D\x4E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x61\x36\x73\x33\x57\x47\x71\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x70\x61\x63\x69\x74\x79\x46\x72\x65\x73\x6E\x65\x6C\x54\x65\x72\x6D\x3D\x63\x6C\x61\x6D\x70\x28\x70\x6F\x77\x28\x4A\x69\x36\x78\x38\x4B\x59\x7A\x2E\x7A\x2B\x61\x62\x73\x28\x4E\x64\x6F\x74\x56\x29\x2C\x4A\x69\x36\x78\x38\x4B\x59\x7A\x2E\x77\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x61\x6C\x70\x68\x61\x2B\x3D\x4A\x69\x36\x78\x38\x4B\x59\x7A\x2E\x78\x2A\x28\x31\x2E\x30\x2D\x6F\x70\x61\x63\x69\x74\x79\x46\x72\x65\x73\x6E\x65\x6C\x54\x65\x72\x6D\x29\x2B\x6F\x70\x61\x63\x69\x74\x79\x46\x72\x65\x73\x6E\x65\x6C\x54\x65\x72\x6D\x2A\x4A\x69\x36\x78\x38\x4B\x59\x7A\x2E\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x42\x6C\x65\x6E\x64\x3D\x47\x72\x32\x70\x33\x53\x34\x54\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x56\x61\x6C\x75\x65\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x48\x77\x34\x33\x4A\x79\x61\x36\x2C\x48\x6F\x37\x65\x35\x4D\x36\x4E\x29\x2E\x72\x2A\x71\x34\x41\x35\x44\x69\x79\x38\x2E\x79\x3B\x0A\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x42\x6C\x65\x6E\x64\x2A\x3D\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x56\x61\x6C\x75\x65\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x76\x65\x63\x33\x20\x73\x70\x65\x63\x75\x6C\x61\x72\x42\x6C\x65\x6E\x64\x3D\x62\x36\x42\x39\x57\x6A\x66\x32\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x73\x70\x65\x63\x75\x6C\x61\x72\x42\x6C\x65\x6E\x64\x2A\x3D\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x56\x61\x6C\x75\x65\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x66\x6C\x6F\x61\x74\x20\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x3D\x69\x35\x4C\x45\x70\x33\x65\x38\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x2A\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x45\x69\x35\x62\x37\x41\x44\x79\x2C\x42\x70\x34\x71\x33\x53\x38\x45\x29\x2E\x72\x2A\x45\x7A\x34\x67\x36\x50\x48\x63\x2E\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x6A\x32\x57\x42\x79\x35\x39\x5A\x29\x20\x7C\x7C\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x6F\x36\x50\x4A\x77\x39\x38\x44\x29\x0A\x2F\x2F\x20\x47\x6F\x20\x6D\x61\x74\x20\x2D\x3E\x20\x2E\x2E\x2E\x0A\x23\x69\x66\x64\x65\x66\x20\x4E\x7A\x35\x32\x51\x63\x67\x39\x0A\x2F\x2F\x20\x41\x64\x61\x70\x74\x20\x2E\x2E\x2E\x0A\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x3D\x63\x6C\x61\x6D\x70\x28\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x2C\x30\x2E\x2C\x31\x2E\x29\x2A\x30\x2E\x39\x38\x3B\x0A\x2F\x2F\x20\x43\x6F\x6D\x70\x75\x74\x65\x20\x2E\x2E\x2E\x0A\x66\x6C\x6F\x61\x74\x20\x72\x6F\x75\x67\x68\x6E\x65\x73\x73\x3D\x63\x6C\x61\x6D\x70\x28\x31\x2E\x2D\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x2C\x20\x30\x2E\x30\x30\x30\x30\x30\x31\x2C\x20\x31\x2E\x30\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x6C\x70\x68\x61\x47\x3D\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x2A\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x2B\x6B\x4D\x69\x6E\x69\x6D\x75\x6D\x56\x61\x72\x69\x61\x6E\x63\x65\x3B\x0A\x2F\x2F\x42\x65\x63\x6B\x61\x6D\x6D\x20\x72\x6F\x75\x67\x68\x6E\x65\x73\x73\x20\x74\x6F\x20\x42\x6C\x69\x6E\x6E\x20\x65\x78\x70\x6F\x6E\x65\x6E\x74\x0A\x66\x6C\x6F\x61\x74\x20\x6D\x61\x78\x4D\x69\x70\x4C\x65\x76\x65\x6C\x3D\x47\x65\x36\x39\x50\x69\x72\x37\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x6F\x64\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x3D\x6B\x52\x6F\x75\x67\x6E\x68\x65\x73\x73\x54\x6F\x41\x6C\x70\x68\x61\x4F\x66\x66\x73\x65\x74\x2B\x6D\x61\x78\x4D\x69\x70\x4C\x65\x76\x65\x6C\x2B\x28\x6D\x61\x78\x4D\x69\x70\x4C\x65\x76\x65\x6C\x2A\x6B\x52\x6F\x75\x67\x6E\x68\x65\x73\x73\x54\x6F\x41\x6C\x70\x68\x61\x53\x63\x61\x6C\x65\x2A\x6C\x6F\x67\x32\x28\x61\x6C\x70\x68\x61\x47\x29\x29\x3B\x0A\x6C\x6F\x64\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x20\x3D\x20\x63\x6C\x61\x6D\x70\x28\x6C\x6F\x64\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x2C\x20\x30\x2E\x2C\x20\x6D\x61\x78\x4D\x69\x70\x4C\x65\x76\x65\x6C\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x66\x6C\x6F\x61\x74\x20\x62\x69\x61\x73\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x3D\x28\x47\x65\x36\x39\x50\x69\x72\x37\x2B\x32\x2E\x30\x29\x2A\x6D\x69\x63\x72\x6F\x73\x75\x72\x66\x61\x63\x65\x42\x6C\x65\x6E\x64\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x59\x6A\x39\x38\x46\x77\x5A\x6E\x29\x20\x7C\x7C\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x47\x66\x34\x69\x33\x59\x38\x53\x29\x0A\x66\x6C\x6F\x61\x74\x20\x41\x4F\x53\x68\x61\x64\x6F\x77\x54\x65\x78\x65\x6C\x3D\x31\x2E\x30\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x76\x65\x63\x33\x20\x41\x4F\x56\x61\x6C\x75\x65\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x6D\x37\x4D\x48\x6B\x33\x62\x34\x2C\x5A\x61\x39\x72\x34\x58\x4D\x6E\x29\x2E\x72\x67\x62\x2A\x48\x65\x39\x63\x34\x58\x32\x4D\x2E\x79\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x33\x4A\x5A\x6A\x32\x79\x38\x0A\x66\x6C\x6F\x61\x74\x20\x61\x6F\x47\x72\x61\x79\x4C\x65\x76\x65\x6C\x3D\x64\x6F\x74\x28\x67\x38\x47\x32\x57\x66\x63\x34\x2C\x41\x4F\x56\x61\x6C\x75\x65\x29\x3B\x0A\x69\x66\x20\x28\x61\x6F\x47\x72\x61\x79\x4C\x65\x76\x65\x6C\x3C\x58\x6D\x38\x36\x42\x79\x65\x37\x29\x7B\x41\x4F\x56\x61\x6C\x75\x65\x2F\x3D\x58\x6D\x38\x36\x42\x79\x65\x37\x3B\x7D\x65\x6C\x73\x65\x7B\x41\x4F\x56\x61\x6C\x75\x65\x2D\x3D\x58\x6D\x38\x36\x42\x79\x65\x37\x3B\x41\x4F\x56\x61\x6C\x75\x65\x2F\x3D\x31\x2E\x30\x2D\x58\x6D\x38\x36\x42\x79\x65\x37\x3B\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x76\x65\x63\x33\x20\x41\x4F\x4C\x69\x67\x68\x74\x54\x65\x78\x65\x6C\x3D\x6D\x69\x78\x28\x76\x65\x63\x33\x28\x31\x2E\x30\x29\x2C\x41\x4F\x56\x61\x6C\x75\x65\x2C\x48\x65\x39\x63\x34\x58\x32\x4D\x2E\x7A\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x76\x65\x63\x32\x20\x73\x63\x72\x65\x65\x6E\x43\x6F\x6F\x72\x64\x69\x6E\x61\x74\x65\x73\x3D\x76\x65\x63\x32\x28\x30\x2E\x30\x29\x3B\x0A\x73\x63\x72\x65\x65\x6E\x43\x6F\x6F\x72\x64\x69\x6E\x61\x74\x65\x73\x3D\x6E\x39\x52\x4D\x77\x37\x62\x32\x2E\x78\x79\x2F\x6E\x39\x52\x4D\x77\x37\x62\x32\x2E\x7A\x2F\x32\x2E\x30\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x29\x3B\x0A\x41\x4F\x53\x68\x61\x64\x6F\x77\x54\x65\x78\x65\x6C\x3D\x6D\x69\x78\x28\x31\x2E\x30\x2C\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x6D\x37\x4D\x48\x6B\x33\x62\x34\x2C\x73\x63\x72\x65\x65\x6E\x43\x6F\x6F\x72\x64\x69\x6E\x61\x74\x65\x73\x29\x2E\x72\x2C\x6A\x32\x4E\x34\x44\x66\x4B\x70\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x41\x4F\x4C\x69\x67\x68\x74\x54\x65\x78\x65\x6C\x3D\x6D\x69\x78\x28\x31\x2E\x30\x2C\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x6D\x37\x4D\x48\x6B\x33\x62\x34\x2C\x73\x63\x72\x65\x65\x6E\x43\x6F\x6F\x72\x64\x69\x6E\x61\x74\x65\x73\x29\x2E\x67\x2C\x6A\x32\x4E\x34\x44\x66\x4B\x70\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x77\x39\x43\x33\x59\x65\x6E\x34\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x76\x65\x63\x32\x20\x61\x33\x58\x34\x53\x70\x48\x71\x3D\x76\x65\x63\x32\x28\x76\x69\x65\x77\x2A\x76\x65\x63\x34\x28\x4E\x2C\x30\x2E\x30\x29\x29\x2A\x30\x2E\x35\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x2C\x30\x2E\x35\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x3D\x61\x6C\x62\x65\x64\x6F\x42\x6C\x65\x6E\x64\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6A\x32\x57\x42\x79\x35\x39\x5A\x0A\x2F\x2F\x20\x46\x6F\x72\x20\x74\x79\x70\x69\x63\x61\x6C\x20\x69\x6E\x63\x69\x64\x65\x6E\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x20\x72\x61\x6E\x67\x65\x20\x28\x62\x65\x74\x77\x65\x65\x6E\x20\x34\x25\x20\x74\x6F\x20\x31\x30\x30\x25\x29\x20\x73\x65\x74\x20\x74\x68\x65\x20\x67\x72\x61\x7A\x69\x6E\x67\x20\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x20\x74\x6F\x20\x31\x30\x30\x25\x20\x66\x6F\x72\x20\x74\x79\x70\x69\x63\x61\x6C\x20\x66\x72\x65\x73\x6E\x65\x6C\x20\x65\x66\x66\x65\x63\x74\x2E\x0A\x2F\x2F\x20\x46\x6F\x72\x20\x76\x65\x72\x79\x20\x6C\x6F\x77\x20\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x20\x72\x61\x6E\x67\x65\x20\x6F\x6E\x20\x68\x69\x67\x68\x6C\x79\x20\x64\x69\x66\x66\x75\x73\x65\x20\x6F\x62\x6A\x65\x63\x74\x73\x20\x28\x62\x65\x6C\x6F\x77\x20\x34\x25\x29\x2C\x20\x69\x6E\x63\x72\x65\x6D\x65\x6E\x74\x61\x6C\x6C\x79\x20\x72\x65\x64\x75\x63\x65\x20\x67\x72\x61\x7A\x69\x6E\x67\x20\x72\x65\x66\x6C\x65\x63\x61\x6E\x63\x65\x20\x74\x6F\x20\x30\x25\x2E\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x30\x3D\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x42\x6C\x65\x6E\x64\x3B\x20\x2F\x2F\x20\x6E\x6F\x72\x6D\x61\x6C\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x39\x30\x3D\x63\x6C\x61\x6D\x70\x28\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x42\x6C\x65\x6E\x64\x2A\x32\x35\x2E\x30\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x20\x2F\x2F\x20\x67\x72\x61\x7A\x69\x6E\x67\x0A\x66\x6C\x6F\x61\x74\x20\x73\x63\x68\x6C\x69\x63\x6B\x3D\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x30\x2B\x28\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x39\x30\x2D\x72\x65\x66\x6C\x65\x63\x74\x61\x6E\x63\x65\x30\x29\x2A\x70\x6F\x77\x28\x63\x6C\x61\x6D\x70\x28\x31\x2E\x30\x2D\x4E\x64\x6F\x74\x56\x2C\x30\x2E\x2C\x31\x2E\x29\x2C\x20\x35\x2E\x30\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x4E\x7A\x35\x32\x51\x63\x67\x39\x0A\x76\x65\x63\x33\x20\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x4C\x6F\x64\x45\x58\x54\x28\x4E\x7A\x32\x6E\x33\x44\x5A\x73\x2C\x61\x33\x58\x34\x53\x70\x48\x71\x2C\x6C\x6F\x64\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x29\x2E\x72\x67\x62\x2A\x72\x38\x54\x4C\x61\x33\x74\x35\x2A\x6F\x39\x45\x44\x74\x38\x37\x48\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x76\x65\x63\x33\x20\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x4E\x7A\x32\x6E\x33\x44\x5A\x73\x2C\x61\x33\x58\x34\x53\x70\x48\x71\x2C\x62\x69\x61\x73\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x29\x2E\x72\x67\x62\x2A\x72\x38\x54\x4C\x61\x33\x74\x35\x2A\x6F\x39\x45\x44\x74\x38\x37\x48\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x31\x2E\x30\x2D\x73\x63\x68\x6C\x69\x63\x6B\x3B\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2B\x3D\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x2A\x73\x63\x68\x6C\x69\x63\x6B\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x74\x37\x50\x57\x65\x32\x77\x36\x0A\x76\x65\x63\x33\x20\x61\x6D\x62\x69\x65\x6E\x74\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x44\x67\x36\x38\x43\x70\x4D\x62\x2C\x61\x33\x58\x34\x53\x70\x48\x71\x29\x2E\x72\x67\x62\x2A\x7A\x39\x45\x38\x44\x72\x65\x33\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x6C\x62\x65\x64\x6F\x4C\x65\x76\x65\x6C\x3D\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x72\x2A\x4C\x6B\x38\x78\x35\x54\x33\x47\x2E\x72\x2B\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x67\x2A\x4C\x6B\x38\x78\x35\x54\x33\x47\x2E\x67\x2B\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x62\x2A\x4C\x6B\x38\x78\x35\x54\x33\x47\x2E\x62\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3D\x6D\x69\x78\x28\x30\x2E\x38\x35\x2C\x30\x2E\x39\x39\x2C\x70\x6F\x77\x28\x61\x6C\x62\x65\x64\x6F\x4C\x65\x76\x65\x6C\x2C\x32\x2E\x30\x29\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x6D\x62\x69\x65\x6E\x74\x47\x72\x65\x79\x4C\x65\x76\x65\x6C\x3D\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x72\x2A\x61\x6D\x62\x69\x65\x6E\x74\x2E\x72\x2B\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x67\x2A\x61\x6D\x62\x69\x65\x6E\x74\x2E\x67\x2B\x67\x38\x47\x32\x57\x66\x63\x34\x2E\x62\x2A\x61\x6D\x62\x69\x65\x6E\x74\x2E\x62\x3B\x0A\x69\x66\x20\x28\x61\x6D\x62\x69\x65\x6E\x74\x47\x72\x65\x79\x4C\x65\x76\x65\x6C\x3C\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x29\x7B\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x61\x6D\x62\x69\x65\x6E\x74\x2F\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3B\x7D\x0A\x65\x6C\x73\x65\x7B\x0A\x61\x6D\x62\x69\x65\x6E\x74\x2D\x3D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3B\x61\x6D\x62\x69\x65\x6E\x74\x2F\x3D\x31\x2E\x30\x2D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3B\x61\x6D\x62\x69\x65\x6E\x74\x47\x72\x65\x79\x4C\x65\x76\x65\x6C\x2D\x3D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3B\x61\x6D\x62\x69\x65\x6E\x74\x47\x72\x65\x79\x4C\x65\x76\x65\x6C\x2F\x3D\x31\x2E\x30\x2D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x3B\x0A\x76\x65\x63\x33\x20\x64\x65\x73\x61\x74\x41\x6D\x62\x69\x65\x6E\x74\x3D\x6D\x69\x78\x28\x76\x65\x63\x33\x28\x61\x6D\x62\x69\x65\x6E\x74\x47\x72\x65\x79\x4C\x65\x76\x65\x6C\x29\x2C\x61\x6D\x62\x69\x65\x6E\x74\x2C\x31\x2E\x31\x2D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x29\x3B\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2B\x3D\x64\x65\x73\x61\x74\x41\x6D\x62\x69\x65\x6E\x74\x2A\x63\x6C\x61\x6D\x70\x28\x33\x2E\x30\x2A\x28\x31\x2E\x30\x2D\x6C\x69\x67\x68\x74\x45\x78\x70\x6F\x73\x75\x72\x65\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x41\x4F\x4C\x69\x67\x68\x74\x54\x65\x78\x65\x6C\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x41\x4F\x53\x68\x61\x64\x6F\x77\x54\x65\x78\x65\x6C\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x50\x4A\x77\x39\x38\x44\x0A\x76\x65\x63\x33\x20\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x3D\x32\x2E\x30\x2A\x4E\x64\x6F\x74\x56\x2A\x4E\x2D\x56\x3B\x20\x0A\x23\x69\x66\x64\x65\x66\x20\x61\x32\x53\x42\x6A\x38\x79\x33\x0A\x76\x65\x63\x33\x20\x66\x69\x72\x73\x74\x50\x6C\x61\x6E\x65\x49\x6E\x74\x65\x72\x73\x65\x63\x74\x3D\x28\x63\x39\x46\x34\x58\x6D\x44\x69\x2D\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x29\x2F\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x3B\x0A\x76\x65\x63\x33\x20\x73\x65\x63\x6F\x6E\x64\x50\x6C\x61\x6E\x65\x49\x6E\x74\x65\x72\x73\x65\x63\x74\x3D\x28\x4C\x72\x34\x35\x4A\x62\x45\x69\x2D\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x29\x2F\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x3B\x0A\x76\x65\x63\x33\x20\x66\x75\x72\x74\x68\x65\x73\x74\x50\x6C\x61\x6E\x65\x3D\x6D\x61\x78\x28\x66\x69\x72\x73\x74\x50\x6C\x61\x6E\x65\x49\x6E\x74\x65\x72\x73\x65\x63\x74\x2C\x73\x65\x63\x6F\x6E\x64\x50\x6C\x61\x6E\x65\x49\x6E\x74\x65\x72\x73\x65\x63\x74\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x69\x73\x74\x61\x6E\x63\x65\x3D\x6D\x69\x6E\x28\x6D\x69\x6E\x28\x66\x75\x72\x74\x68\x65\x73\x74\x50\x6C\x61\x6E\x65\x2E\x78\x2C\x66\x75\x72\x74\x68\x65\x73\x74\x50\x6C\x61\x6E\x65\x2E\x79\x29\x2C\x66\x75\x72\x74\x68\x65\x73\x74\x50\x6C\x61\x6E\x65\x2E\x7A\x29\x3B\x0A\x76\x65\x63\x33\x20\x69\x6E\x74\x65\x72\x73\x65\x63\x74\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x3D\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x2B\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x2A\x64\x69\x73\x74\x61\x6E\x63\x65\x3B\x0A\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x3D\x69\x6E\x74\x65\x72\x73\x65\x63\x74\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x2D\x6E\x35\x4A\x38\x41\x66\x79\x32\x3B\x0A\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x2E\x79\x3D\x2D\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x2E\x79\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x4E\x7A\x35\x32\x51\x63\x67\x39\x0A\x76\x65\x63\x33\x20\x65\x6E\x76\x69\x72\x6F\x6E\x6D\x65\x6E\x74\x52\x61\x64\x69\x61\x6E\x63\x65\x3D\x74\x65\x78\x74\x75\x72\x65\x43\x75\x62\x65\x4C\x6F\x64\x45\x58\x54\x28\x4E\x64\x37\x6D\x33\x57\x58\x6E\x2C\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x2C\x6C\x6F\x64\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x29\x2E\x72\x67\x62\x2A\x72\x38\x54\x4C\x61\x33\x74\x35\x2A\x66\x32\x54\x48\x77\x38\x73\x35\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x76\x65\x63\x33\x20\x65\x6E\x76\x69\x72\x6F\x6E\x6D\x65\x6E\x74\x52\x61\x64\x69\x61\x6E\x63\x65\x3D\x74\x65\x78\x74\x75\x72\x65\x43\x75\x62\x65\x28\x4E\x64\x37\x6D\x33\x57\x58\x6E\x2C\x76\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x55\x56\x57\x2C\x62\x69\x61\x73\x52\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x29\x2E\x72\x67\x62\x2A\x72\x38\x54\x4C\x61\x33\x74\x35\x2A\x66\x32\x54\x48\x77\x38\x73\x35\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x76\x65\x63\x33\x20\x64\x69\x72\x65\x63\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x46\x61\x63\x74\x6F\x72\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x69\x72\x65\x63\x74\x44\x69\x66\x66\x75\x73\x65\x46\x61\x63\x74\x6F\x72\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x70\x37\x48\x35\x42\x65\x4E\x6F\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x73\x36\x32\x48\x63\x67\x34\x0A\x66\x6C\x6F\x61\x74\x20\x73\x68\x61\x64\x6F\x77\x54\x6F\x74\x61\x6C\x3D\x31\x2E\x30\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x44\x70\x38\x34\x50\x78\x6A\x32\x4D\x54\x72\x37\x71\x36\x46\x57\x3E\x5B\x30\x2E\x2E\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73\x5D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x76\x65\x63\x33\x20\x66\x69\x6E\x61\x6C\x44\x69\x66\x66\x75\x73\x65\x3D\x61\x6C\x62\x65\x64\x6F\x42\x6C\x65\x6E\x64\x3B\x0A\x76\x65\x63\x33\x20\x65\x6E\x65\x72\x67\x79\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x50\x4A\x77\x39\x38\x44\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x50\x6F\x77\x65\x72\x3D\x63\x6C\x61\x6D\x70\x28\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x42\x6C\x65\x6E\x64\x2A\x32\x2E\x30\x2D\x4E\x64\x6F\x74\x56\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x65\x6E\x65\x72\x67\x79\x3D\x76\x65\x63\x33\x28\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x50\x6F\x77\x65\x72\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x65\x6E\x65\x72\x67\x79\x2B\x3D\x28\x64\x69\x72\x65\x63\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x46\x61\x63\x74\x6F\x72\x2A\x73\x70\x65\x63\x75\x6C\x61\x72\x42\x6C\x65\x6E\x64\x29\x2E\x72\x3B\x0A\x65\x6E\x65\x72\x67\x79\x3D\x63\x6C\x61\x6D\x70\x28\x65\x6E\x65\x72\x67\x79\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x66\x69\x6E\x61\x6C\x44\x69\x66\x66\x75\x73\x65\x2A\x3D\x76\x65\x63\x33\x28\x31\x2E\x30\x29\x2D\x65\x6E\x65\x72\x67\x79\x3B\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x3D\x66\x69\x6E\x61\x6C\x44\x69\x66\x66\x75\x73\x65\x3B\x0A\x76\x65\x63\x33\x20\x66\x69\x6E\x61\x6C\x53\x70\x65\x63\x75\x6C\x61\x72\x3D\x64\x69\x72\x65\x63\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x46\x61\x63\x74\x6F\x72\x2A\x73\x70\x65\x63\x75\x6C\x61\x72\x42\x6C\x65\x6E\x64\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x50\x4A\x77\x39\x38\x44\x0A\x66\x69\x6E\x61\x6C\x53\x70\x65\x63\x75\x6C\x61\x72\x2B\x3D\x65\x6E\x76\x69\x72\x6F\x6E\x6D\x65\x6E\x74\x52\x61\x64\x69\x61\x6E\x63\x65\x2A\x72\x65\x66\x6C\x65\x63\x74\x69\x6F\x6E\x50\x6F\x77\x65\x72\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2B\x3D\x66\x69\x6E\x61\x6C\x53\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x76\x65\x63\x33\x20\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x3D\x64\x69\x72\x65\x63\x74\x44\x69\x66\x66\x75\x73\x65\x46\x61\x63\x74\x6F\x72\x3B\x0A\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x59\x6A\x39\x38\x46\x77\x5A\x6E\x29\x20\x7C\x7C\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x47\x66\x34\x69\x33\x59\x38\x53\x29\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x73\x36\x32\x48\x63\x67\x34\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2B\x3D\x7A\x39\x4C\x47\x71\x33\x35\x50\x2A\x6D\x69\x78\x28\x31\x2E\x30\x2C\x41\x4F\x53\x68\x61\x64\x6F\x77\x54\x65\x78\x65\x6C\x2C\x31\x2E\x30\x2D\x73\x68\x61\x64\x6F\x77\x54\x6F\x74\x61\x6C\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2B\x3D\x7A\x39\x4C\x47\x71\x33\x35\x50\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2A\x3D\x41\x4F\x4C\x69\x67\x68\x74\x54\x65\x78\x65\x6C\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2B\x3D\x7A\x39\x4C\x47\x71\x33\x35\x50\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x74\x33\x36\x43\x66\x44\x79\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x3D\x70\x6F\x77\x28\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2C\x76\x65\x63\x33\x28\x47\x6B\x39\x37\x57\x71\x64\x35\x2E\x78\x29\x29\x3B\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2B\x3D\x47\x6B\x39\x37\x57\x71\x64\x35\x2E\x79\x2D\x31\x2E\x30\x3B\x0A\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x3D\x63\x6C\x61\x6D\x70\x28\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2C\x30\x2E\x30\x2C\x32\x2E\x30\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x33\x4A\x5A\x6A\x32\x79\x38\x0A\x69\x66\x20\x28\x61\x6F\x47\x72\x61\x79\x4C\x65\x76\x65\x6C\x3C\x58\x6D\x38\x36\x42\x79\x65\x37\x29\x7B\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x3B\x7D\x0A\x65\x6C\x73\x65\x20\x7B\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2B\x3D\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x2A\x63\x6C\x61\x6D\x70\x28\x33\x2E\x30\x2A\x28\x31\x2E\x30\x2D\x58\x6D\x38\x36\x42\x79\x65\x37\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x7D\x0A\x23\x65\x6C\x73\x65\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2A\x3D\x66\x69\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x6A\x35\x41\x48\x62\x38\x67\x36\x0A\x66\x6C\x6F\x61\x74\x20\x72\x69\x6D\x50\x6F\x77\x65\x72\x3D\x62\x34\x4D\x33\x48\x63\x53\x69\x2E\x78\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x69\x6D\x42\x69\x61\x73\x3D\x62\x34\x4D\x33\x48\x63\x53\x69\x2E\x79\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x69\x6D\x46\x61\x63\x74\x6F\x72\x3D\x63\x6C\x61\x6D\x70\x28\x72\x69\x6D\x42\x69\x61\x73\x2A\x32\x2E\x30\x2D\x4E\x64\x6F\x74\x56\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x72\x69\x6D\x46\x61\x63\x74\x6F\x72\x2A\x3D\x72\x65\x66\x6C\x65\x63\x74\x69\x76\x69\x74\x79\x56\x61\x6C\x75\x65\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x2B\x3D\x45\x77\x34\x36\x4B\x65\x73\x33\x2A\x72\x69\x6D\x46\x61\x63\x74\x6F\x72\x2A\x72\x69\x6D\x50\x6F\x77\x65\x72\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x67\x6C\x5F\x46\x72\x61\x67\x43\x6F\x6C\x6F\x72\x3D\x76\x65\x63\x34\x28\x76\x65\x63\x33\x28\x66\x69\x6E\x61\x6C\x43\x6F\x6C\x6F\x72\x29\x2C\x61\x6C\x70\x68\x61\x29\x3B\x0A\x7D","\x70\x72\x65\x63\x69\x73\x69\x6F\x6E\x20\x68\x69\x67\x68\x70\x20\x66\x6C\x6F\x61\x74\x3B\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x5F\x5F\x64\x65\x63\x6C\x5F\x5F\x7A\x6B\x5F\x70\x62\x72\x56\x65\x72\x74\x65\x78\x3E\x0A\x0A\x61\x74\x74\x72\x69\x62\x75\x74\x65\x20\x76\x65\x63\x33\x20\x70\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x61\x74\x74\x72\x69\x62\x75\x74\x65\x20\x76\x65\x63\x33\x20\x6E\x6F\x72\x6D\x61\x6C\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x44\x61\x39\x69\x34\x5A\x58\x74\x0A\x61\x74\x74\x72\x69\x62\x75\x74\x65\x20\x76\x65\x63\x32\x20\x75\x76\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x42\x73\x32\x37\x4A\x69\x57\x71\x0A\x61\x74\x74\x72\x69\x62\x75\x74\x65\x20\x76\x65\x63\x32\x20\x75\x76\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x62\x6F\x6E\x65\x73\x44\x65\x63\x6C\x61\x72\x61\x74\x69\x6F\x6E\x3E\x0A\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x69\x6E\x73\x74\x61\x6E\x63\x65\x73\x44\x65\x63\x6C\x61\x72\x61\x74\x69\x6F\x6E\x3E\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x70\x37\x48\x35\x42\x65\x4E\x6F\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x5F\x5F\x64\x65\x63\x6C\x5F\x5F\x7A\x6B\x5F\x70\x62\x72\x4C\x69\x67\x68\x74\x46\x72\x61\x67\x6D\x65\x6E\x74\x3E\x5B\x30\x2E\x2E\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73\x5D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x6A\x39\x46\x35\x4D\x6D\x77\x37\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x48\x67\x33\x32\x4E\x6B\x7A\x36\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x77\x39\x43\x33\x59\x65\x6E\x34\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x61\x33\x58\x34\x53\x70\x48\x71\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x48\x6F\x37\x65\x35\x4D\x36\x4E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x42\x70\x34\x71\x33\x53\x38\x45\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x5A\x6A\x32\x36\x41\x62\x79\x34\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x32\x20\x5A\x61\x39\x72\x34\x58\x4D\x6E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x6E\x39\x52\x4D\x77\x37\x62\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x76\x6F\x69\x64\x20\x6D\x61\x69\x6E\x28\x76\x6F\x69\x64\x29\x0A\x7B\x0A\x76\x65\x63\x33\x20\x70\x6F\x73\x69\x74\x69\x6F\x6E\x55\x70\x64\x61\x74\x65\x64\x3D\x70\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x76\x65\x63\x33\x20\x6E\x6F\x72\x6D\x61\x6C\x55\x70\x64\x61\x74\x65\x64\x3D\x6E\x6F\x72\x6D\x61\x6C\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x69\x6E\x73\x74\x61\x6E\x63\x65\x73\x56\x65\x72\x74\x65\x78\x3E\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x62\x6F\x6E\x65\x73\x56\x65\x72\x74\x65\x78\x3E\x0A\x76\x65\x63\x34\x20\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3D\x66\x69\x6E\x61\x6C\x57\x6F\x72\x6C\x64\x2A\x76\x65\x63\x34\x28\x70\x6F\x73\x69\x74\x69\x6F\x6E\x55\x70\x64\x61\x74\x65\x64\x2C\x31\x2E\x30\x29\x3B\x0A\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x3D\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x2E\x78\x79\x7A\x3B\x0A\x76\x65\x63\x34\x20\x66\x69\x6E\x61\x6C\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3D\x76\x69\x65\x77\x50\x72\x6F\x6A\x65\x63\x74\x69\x6F\x6E\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x6E\x39\x52\x4D\x77\x37\x62\x32\x3D\x66\x69\x6E\x61\x6C\x50\x6F\x73\x69\x74\x69\x6F\x6E\x2E\x78\x79\x77\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x67\x6C\x5F\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3D\x66\x69\x6E\x61\x6C\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x62\x38\x57\x34\x46\x79\x71\x39\x0A\x76\x65\x63\x34\x20\x77\x6F\x72\x6C\x64\x4E\x6F\x72\x6D\x61\x6C\x3D\x66\x69\x6E\x61\x6C\x57\x6F\x72\x6C\x64\x2A\x76\x65\x63\x34\x28\x6E\x6F\x72\x6D\x61\x6C\x55\x70\x64\x61\x74\x65\x64\x2C\x30\x2E\x30\x29\x3B\x0A\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x77\x6F\x72\x6C\x64\x4E\x6F\x72\x6D\x61\x6C\x2E\x78\x79\x7A\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x6E\x64\x65\x66\x20\x44\x61\x39\x69\x34\x5A\x58\x74\x0A\x76\x65\x63\x32\x20\x75\x76\x3D\x76\x65\x63\x32\x28\x30\x2E\x30\x2C\x30\x2E\x30\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x6E\x64\x65\x66\x20\x42\x73\x32\x37\x4A\x69\x57\x71\x0A\x76\x65\x63\x32\x20\x75\x76\x32\x3D\x76\x65\x63\x32\x28\x30\x2E\x30\x2C\x30\x2E\x30\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x69\x66\x20\x28\x4A\x69\x32\x33\x4B\x7A\x4D\x64\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x6A\x39\x46\x35\x4D\x6D\x77\x37\x3D\x76\x65\x63\x32\x28\x58\x6F\x38\x71\x34\x41\x32\x52\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x6A\x39\x46\x35\x4D\x6D\x77\x37\x3D\x76\x65\x63\x32\x28\x58\x6F\x38\x71\x34\x41\x32\x52\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x69\x66\x20\x28\x57\x72\x35\x69\x38\x52\x33\x53\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x48\x67\x33\x32\x4E\x6B\x7A\x36\x3D\x76\x65\x63\x32\x28\x4C\x6A\x37\x71\x38\x48\x32\x4B\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x48\x67\x33\x32\x4E\x6B\x7A\x36\x3D\x76\x65\x63\x32\x28\x4C\x6A\x37\x71\x38\x48\x32\x4B\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x77\x39\x43\x33\x59\x65\x6E\x34\x0A\x61\x33\x58\x34\x53\x70\x48\x71\x3D\x76\x65\x63\x32\x28\x76\x69\x65\x77\x2A\x76\x65\x63\x34\x28\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x2C\x30\x2E\x30\x29\x29\x2A\x30\x2E\x35\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x2C\x30\x2E\x35\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x69\x66\x20\x28\x71\x34\x41\x35\x44\x69\x79\x38\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x48\x6F\x37\x65\x35\x4D\x36\x4E\x3D\x76\x65\x63\x32\x28\x66\x38\x45\x32\x57\x78\x63\x33\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x48\x6F\x37\x65\x35\x4D\x36\x4E\x3D\x76\x65\x63\x32\x28\x66\x38\x45\x32\x57\x78\x63\x33\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x69\x66\x20\x28\x45\x7A\x34\x67\x36\x50\x48\x63\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x42\x70\x34\x71\x33\x53\x38\x45\x3D\x76\x65\x63\x32\x28\x74\x33\x47\x51\x6E\x34\x6D\x38\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x42\x70\x34\x71\x33\x53\x38\x45\x3D\x76\x65\x63\x32\x28\x74\x33\x47\x51\x6E\x34\x6D\x38\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x69\x66\x20\x28\x78\x34\x53\x36\x4C\x6A\x74\x32\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x5A\x6A\x32\x36\x41\x62\x79\x34\x3D\x76\x65\x63\x32\x28\x44\x79\x38\x34\x42\x72\x77\x36\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x5A\x6A\x32\x36\x41\x62\x79\x34\x3D\x76\x65\x63\x32\x28\x44\x79\x38\x34\x42\x72\x77\x36\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x69\x66\x20\x28\x48\x65\x39\x63\x34\x58\x32\x4D\x2E\x78\x20\x3D\x3D\x20\x30\x2E\x30\x29\x0A\x7B\x0A\x5A\x61\x39\x72\x34\x58\x4D\x6E\x3D\x76\x65\x63\x32\x28\x45\x6D\x39\x34\x5A\x78\x73\x37\x2A\x76\x65\x63\x34\x28\x75\x76\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x5A\x61\x39\x72\x34\x58\x4D\x6E\x3D\x76\x65\x63\x32\x28\x45\x6D\x39\x34\x5A\x78\x73\x37\x2A\x76\x65\x63\x34\x28\x75\x76\x32\x2C\x31\x2E\x30\x2C\x30\x2E\x30\x29\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x73\x36\x32\x48\x63\x67\x34\x0A\x23\x69\x6E\x63\x6C\x75\x64\x65\x3C\x7A\x6B\x5F\x47\x69\x33\x39\x41\x64\x54\x67\x37\x79\x35\x42\x32\x4A\x66\x4C\x3E\x5B\x30\x2E\x2E\x6D\x61\x78\x53\x69\x6D\x75\x6C\x74\x61\x6E\x65\x6F\x75\x73\x4C\x69\x67\x68\x74\x73\x5D\x0A\x23\x65\x6E\x64\x69\x66\x0A\x7D","\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x6D\x61\x74\x33\x20\x63\x6F\x74\x61\x6E\x67\x65\x6E\x74\x5F\x66\x72\x61\x6D\x65\x28\x76\x65\x63\x33\x20\x6E\x6F\x72\x6D\x2C\x76\x65\x63\x33\x20\x70\x6F\x73\x73\x2C\x76\x65\x63\x32\x20\x75\x76\x6D\x61\x70\x70\x69\x6E\x67\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x65\x66\x66\x5F\x31\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x65\x66\x66\x5F\x32\x29\x0A\x7B\x0A\x76\x65\x63\x33\x20\x64\x70\x31\x3D\x63\x6F\x65\x66\x66\x5F\x31\x2A\x64\x46\x64\x78\x28\x70\x6F\x73\x73\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x70\x32\x3D\x63\x6F\x65\x66\x66\x5F\x31\x2A\x64\x46\x64\x79\x28\x70\x6F\x73\x73\x29\x3B\x0A\x76\x65\x63\x32\x20\x64\x75\x76\x31\x3D\x64\x46\x64\x78\x28\x75\x76\x6D\x61\x70\x70\x69\x6E\x67\x29\x2B\x76\x65\x63\x32\x28\x63\x6F\x65\x66\x66\x5F\x32\x2C\x20\x63\x6F\x65\x66\x66\x5F\x32\x29\x3B\x0A\x76\x65\x63\x32\x20\x64\x75\x76\x32\x3D\x64\x46\x64\x79\x28\x75\x76\x6D\x61\x70\x70\x69\x6E\x67\x29\x2B\x76\x65\x63\x32\x28\x63\x6F\x65\x66\x66\x5F\x32\x2C\x20\x63\x6F\x65\x66\x66\x5F\x32\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x70\x32\x70\x65\x72\x70\x3D\x63\x72\x6F\x73\x73\x28\x64\x70\x32\x2C\x6E\x6F\x72\x6D\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x70\x31\x70\x65\x72\x70\x3D\x63\x72\x6F\x73\x73\x28\x6E\x6F\x72\x6D\x2C\x64\x70\x31\x29\x3B\x0A\x76\x65\x63\x33\x20\x54\x3D\x64\x70\x32\x70\x65\x72\x70\x2A\x64\x75\x76\x31\x2E\x78\x2B\x64\x70\x31\x70\x65\x72\x70\x2A\x64\x75\x76\x32\x2E\x78\x3B\x0A\x76\x65\x63\x33\x20\x42\x3D\x64\x70\x32\x70\x65\x72\x70\x2A\x64\x75\x76\x31\x2E\x79\x2B\x64\x70\x31\x70\x65\x72\x70\x2A\x64\x75\x76\x32\x2E\x79\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x69\x6E\x76\x6D\x61\x78\x3D\x69\x6E\x76\x65\x72\x73\x65\x73\x71\x72\x74\x28\x6D\x61\x78\x28\x64\x6F\x74\x28\x54\x2C\x54\x29\x2C\x64\x6F\x74\x28\x42\x2C\x42\x29\x29\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x6D\x61\x74\x33\x28\x54\x20\x2A\x20\x69\x6E\x76\x6D\x61\x78\x2C\x20\x42\x20\x2A\x20\x69\x6E\x76\x6D\x61\x78\x2C\x20\x6E\x6F\x72\x6D\x29\x3B\x0A\x7D\x0A\x76\x65\x63\x33\x20\x70\x65\x72\x74\x75\x72\x62\x4E\x6F\x72\x6D\x61\x6C\x28\x76\x65\x63\x33\x20\x76\x69\x65\x77\x44\x69\x72\x2C\x76\x65\x63\x33\x20\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x2C\x20\x76\x65\x63\x32\x20\x76\x76\x31\x2C\x20\x76\x65\x63\x32\x20\x76\x76\x32\x29\x0A\x7B\x0A\x76\x65\x63\x33\x20\x6D\x61\x70\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x71\x36\x4B\x57\x74\x39\x37\x43\x2C\x48\x67\x33\x32\x4E\x6B\x7A\x36\x29\x2E\x78\x79\x7A\x2A\x57\x72\x35\x69\x38\x52\x33\x53\x2E\x79\x3B\x0A\x6D\x61\x70\x20\x3D\x20\x28\x6D\x61\x70\x2A\x28\x32\x35\x35\x2E\x30\x2F\x31\x32\x37\x2E\x30\x29\x29\x2D\x28\x31\x32\x38\x2E\x30\x2F\x31\x32\x37\x2E\x30\x29\x3B\x0A\x6D\x61\x74\x33\x20\x54\x42\x4E\x3D\x63\x6F\x74\x61\x6E\x67\x65\x6E\x74\x5F\x66\x72\x61\x6D\x65\x28\x76\x4E\x6F\x72\x6D\x61\x6C\x57\x2C\x76\x69\x65\x77\x44\x69\x72\x2C\x48\x67\x33\x32\x4E\x6B\x7A\x36\x2C\x20\x76\x76\x31\x2E\x78\x2C\x20\x76\x76\x32\x2E\x79\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x54\x42\x4E\x2A\x6D\x61\x70\x29\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66","\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x77\x39\x43\x33\x59\x65\x6E\x34\x29\x20\x26\x26\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x48\x70\x34\x6D\x32\x42\x57\x66\x29\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x76\x69\x65\x77\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x34\x20\x4C\x6B\x38\x78\x35\x54\x33\x47\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x72\x38\x54\x4C\x61\x33\x74\x35\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x62\x36\x42\x39\x57\x6A\x66\x32\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x47\x72\x32\x70\x33\x53\x34\x54\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x69\x35\x4C\x45\x70\x33\x65\x38\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x42\x74\x35\x32\x5A\x6E\x78\x38\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x39\x4C\x47\x71\x33\x35\x50\x3B\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x4A\x69\x32\x33\x4B\x7A\x4D\x64\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x57\x72\x35\x69\x38\x52\x33\x53\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x45\x7A\x34\x67\x36\x50\x48\x63\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x50\x4A\x77\x39\x38\x44\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x66\x32\x54\x48\x77\x38\x73\x35\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x47\x65\x36\x39\x50\x69\x72\x37\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x61\x32\x53\x42\x6A\x38\x79\x33\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x6E\x35\x4A\x38\x41\x66\x79\x32\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x4C\x72\x34\x35\x4A\x62\x45\x69\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x63\x39\x46\x34\x58\x6D\x44\x69\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x71\x34\x41\x35\x44\x69\x79\x38\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x48\x65\x39\x63\x34\x58\x32\x4D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x33\x4A\x5A\x6A\x32\x79\x38\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x58\x6D\x38\x36\x42\x79\x65\x37\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x59\x6A\x39\x38\x46\x77\x5A\x6E\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x6A\x32\x4E\x34\x44\x66\x4B\x70\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x74\x37\x50\x57\x65\x32\x77\x36\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x39\x45\x38\x44\x72\x65\x33\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6A\x32\x57\x42\x79\x35\x39\x5A\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x6F\x39\x45\x44\x74\x38\x37\x48\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x47\x65\x36\x39\x50\x69\x72\x37\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x78\x34\x53\x36\x4C\x6A\x74\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x61\x36\x73\x33\x57\x47\x71\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x34\x20\x4A\x69\x36\x78\x38\x4B\x59\x7A\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x57\x71\x36\x74\x34\x44\x42\x65\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x67\x38\x47\x32\x57\x66\x63\x34\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x7A\x39\x43\x38\x42\x73\x6E\x33\x3B\x0A\x0A\x23\x69\x66\x64\x65\x66\x20\x6A\x35\x41\x48\x62\x38\x67\x36\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x45\x77\x34\x36\x4B\x65\x73\x33\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x62\x34\x4D\x33\x48\x63\x53\x69\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x74\x33\x36\x43\x66\x44\x79\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x47\x6B\x39\x37\x57\x71\x64\x35\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x64\x32\x45\x4B\x7A\x36\x35\x58\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x51\x6E\x36\x35\x54\x62\x71\x34\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x59\x70\x33\x32\x42\x6A\x54\x79\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x66\x33\x4A\x46\x6E\x36\x39\x44\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x37\x38\x54\x6F\x6A\x36\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x58\x66\x33\x36\x43\x67\x65\x32\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x32\x4A\x38\x44\x65\x6B\x34\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x43\x75\x62\x65\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x72\x38\x6A\x33\x4D\x37\x42\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x0A\x23\x65\x6C\x73\x65\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x6E\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x45\x7A\x32\x67\x39\x4C\x33\x4B\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x78\x39\x52\x34\x44\x63\x6E\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x64\x38\x41\x39\x51\x78\x4C\x65\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x4A\x61\x38\x34\x52\x6D\x50\x63\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x66\x36\x54\x35\x52\x62\x4C\x61\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x32\x4A\x38\x44\x65\x6B\x34\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x4B\x64\x36\x61\x35\x44\x45\x6B\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x66\x6C\x6F\x61\x74\x20\x71\x38\x4E\x4C\x6D\x32\x62\x34\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x70\x37\x48\x35\x42\x65\x4E\x6F\x0A\x73\x74\x72\x75\x63\x74\x20\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x7B\x0A\x76\x65\x63\x33\x20\x64\x69\x66\x66\x75\x73\x65\x3B\x0A\x76\x65\x63\x33\x20\x73\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x7D\x3B\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x67\x65\x74\x50\x6F\x69\x6E\x74\x4C\x69\x67\x68\x74\x69\x6E\x67\x28\x76\x65\x63\x33\x20\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x2C\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x50\x6F\x73\x69\x74\x69\x6F\x6E\x2C\x76\x65\x63\x33\x20\x4E\x2C\x76\x65\x63\x33\x20\x56\x2C\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x44\x69\x66\x66\x75\x73\x65\x2C\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x2C\x66\x6C\x6F\x61\x74\x20\x42\x74\x35\x32\x5A\x6E\x78\x38\x2C\x20\x66\x6C\x6F\x61\x74\x20\x70\x6C\x69\x67\x68\x74\x31\x2C\x20\x66\x6C\x6F\x61\x74\x20\x70\x6C\x69\x67\x68\x74\x32\x29\x0A\x7B\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x72\x65\x73\x75\x6C\x74\x3B\x0A\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x44\x69\x72\x3D\x6C\x69\x67\x68\x74\x50\x6F\x73\x69\x74\x69\x6F\x6E\x2D\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x76\x65\x63\x33\x20\x4C\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x6C\x69\x67\x68\x74\x44\x69\x72\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x69\x73\x74\x61\x6E\x63\x65\x3D\x6C\x65\x6E\x67\x74\x68\x28\x6C\x69\x67\x68\x74\x44\x69\x72\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x69\x67\x68\x74\x41\x74\x74\x65\x6E\x75\x61\x74\x69\x6F\x6E\x3D\x73\x71\x72\x74\x28\x31\x2E\x30\x2F\x64\x69\x73\x74\x61\x6E\x63\x65\x20\x2B\x20\x28\x70\x6C\x69\x67\x68\x74\x31\x2A\x70\x6C\x69\x67\x68\x74\x32\x29\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x69\x66\x66\x75\x73\x65\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x4E\x64\x6F\x74\x4C\x20\x3D\x20\x64\x6F\x74\x28\x4E\x2C\x4C\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x69\x67\x68\x74\x50\x6F\x77\x65\x72\x3D\x63\x6C\x61\x6D\x70\x28\x4E\x64\x6F\x74\x4C\x2C\x20\x30\x2E\x30\x2C\x20\x31\x2E\x30\x29\x3B\x0A\x64\x69\x66\x66\x75\x73\x65\x3D\x6C\x69\x67\x68\x74\x50\x6F\x77\x65\x72\x2A\x6C\x69\x67\x68\x74\x50\x6F\x77\x65\x72\x2A\x6C\x69\x67\x68\x74\x41\x74\x74\x65\x6E\x75\x61\x74\x69\x6F\x6E\x2A\x6C\x69\x67\x68\x74\x44\x69\x66\x66\x75\x73\x65\x3B\x0A\x72\x65\x73\x75\x6C\x74\x2E\x64\x69\x66\x66\x75\x73\x65\x3D\x64\x69\x66\x66\x75\x73\x65\x3B\x0A\x76\x65\x63\x33\x20\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x76\x65\x63\x33\x20\x48\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x56\x2B\x4C\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x4E\x64\x6F\x74\x48\x3D\x6D\x61\x78\x28\x64\x6F\x74\x28\x4E\x2C\x48\x29\x2C\x30\x2E\x30\x29\x3B\x0A\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x28\x70\x6F\x77\x28\x4E\x64\x6F\x74\x48\x2C\x6D\x61\x78\x28\x31\x2E\x30\x20\x2C\x42\x74\x35\x32\x5A\x6E\x78\x38\x29\x29\x2A\x32\x2E\x30\x29\x2A\x6C\x69\x67\x68\x74\x41\x74\x74\x65\x6E\x75\x61\x74\x69\x6F\x6E\x2A\x6C\x69\x67\x68\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x72\x65\x73\x75\x6C\x74\x2E\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x73\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x72\x65\x73\x75\x6C\x74\x3B\x0A\x7D\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x67\x65\x74\x44\x69\x72\x65\x63\x74\x69\x6F\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x28\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x44\x69\x72\x2C\x76\x65\x63\x33\x20\x4E\x2C\x76\x65\x63\x33\x20\x56\x2C\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x44\x69\x66\x66\x75\x73\x65\x2C\x76\x65\x63\x33\x20\x6C\x69\x67\x68\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x2C\x66\x6C\x6F\x61\x74\x20\x42\x74\x35\x32\x5A\x6E\x78\x38\x2C\x20\x66\x6C\x6F\x61\x74\x20\x64\x6C\x69\x67\x68\x74\x31\x2C\x20\x66\x6C\x6F\x61\x74\x20\x64\x6C\x69\x67\x68\x74\x32\x29\x0A\x7B\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x72\x65\x73\x75\x6C\x74\x3B\x0A\x76\x65\x63\x33\x20\x4C\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x6C\x69\x67\x68\x74\x44\x69\x72\x29\x3B\x0A\x76\x65\x63\x33\x20\x64\x69\x66\x66\x75\x73\x65\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x4E\x64\x6F\x74\x4C\x20\x3D\x20\x64\x6F\x74\x28\x4E\x2C\x4C\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x69\x67\x68\x74\x50\x6F\x77\x65\x72\x3D\x63\x6C\x61\x6D\x70\x28\x4E\x64\x6F\x74\x4C\x2C\x20\x30\x2E\x30\x2C\x20\x31\x2E\x30\x29\x3B\x0A\x64\x69\x66\x66\x75\x73\x65\x3D\x28\x6C\x69\x67\x68\x74\x50\x6F\x77\x65\x72\x2A\x6C\x69\x67\x68\x74\x44\x69\x66\x66\x75\x73\x65\x29\x2B\x28\x64\x6C\x69\x67\x68\x74\x31\x2A\x64\x6C\x69\x67\x68\x74\x32\x29\x3B\x0A\x72\x65\x73\x75\x6C\x74\x2E\x64\x69\x66\x66\x75\x73\x65\x3D\x64\x69\x66\x66\x75\x73\x65\x3B\x0A\x76\x65\x63\x33\x20\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x76\x65\x63\x33\x20\x48\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x56\x2B\x4C\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x4E\x64\x6F\x74\x48\x3D\x6D\x61\x78\x28\x64\x6F\x74\x28\x4E\x2C\x48\x29\x2C\x30\x2E\x30\x29\x3B\x0A\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x28\x70\x6F\x77\x28\x4E\x64\x6F\x74\x48\x2C\x6D\x61\x78\x28\x31\x2E\x30\x20\x2C\x42\x74\x35\x32\x5A\x6E\x78\x38\x29\x29\x2A\x32\x2E\x30\x29\x2A\x6C\x69\x67\x68\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x72\x65\x73\x75\x6C\x74\x2E\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x73\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x72\x65\x73\x75\x6C\x74\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x64\x32\x45\x4B\x7A\x36\x35\x58\x7B\x58\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x65\x66\x5F\x64\x79\x6E\x62\x5F\x33\x7B\x58\x7D\x3D\x31\x2E\x30\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x76\x65\x63\x33\x20\x4C\x7B\x58\x7D\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x2D\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x51\x6E\x36\x35\x54\x62\x71\x34\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x76\x65\x63\x33\x20\x4C\x7B\x58\x7D\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x51\x6E\x36\x35\x54\x62\x71\x34\x2D\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x76\x65\x63\x33\x20\x48\x7B\x58\x7D\x3D\x6E\x6F\x72\x6D\x61\x6C\x69\x7A\x65\x28\x56\x2B\x4C\x7B\x58\x7D\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x6F\x38\x39\x57\x71\x43\x6E\x7B\x58\x7D\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x3D\x67\x65\x74\x50\x6F\x69\x6E\x74\x4C\x69\x67\x68\x74\x69\x6E\x67\x28\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x2C\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x51\x6E\x36\x35\x54\x62\x71\x34\x2C\x4E\x2C\x56\x2C\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x59\x70\x33\x32\x42\x6A\x54\x79\x2C\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x66\x33\x4A\x46\x6E\x36\x39\x44\x2C\x42\x74\x35\x32\x5A\x6E\x78\x38\x2C\x6C\x66\x5F\x31\x2C\x6C\x66\x5F\x32\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x3D\x67\x65\x74\x44\x69\x72\x65\x63\x74\x69\x6F\x6E\x61\x6C\x4C\x69\x67\x68\x74\x69\x6E\x67\x28\x4C\x7B\x58\x7D\x2C\x4E\x2C\x56\x2C\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x59\x70\x33\x32\x42\x6A\x54\x79\x2C\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x66\x33\x4A\x46\x6E\x36\x39\x44\x2C\x42\x74\x35\x32\x5A\x6E\x78\x38\x2C\x6C\x66\x5F\x31\x2C\x6C\x66\x5F\x32\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x6C\x69\x67\x68\x74\x69\x6E\x67\x49\x6E\x66\x6F\x20\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x3B\x0A\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x64\x69\x66\x66\x75\x73\x65\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x73\x70\x65\x63\x75\x6C\x61\x72\x3D\x76\x65\x63\x33\x28\x30\x2E\x30\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x37\x38\x54\x6F\x6A\x36\x7B\x58\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x31\x2E\x30\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x65\x66\x5F\x64\x79\x6E\x62\x5F\x32\x7B\x58\x7D\x3D\x30\x2E\x30\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x3D\x63\x6F\x6D\x70\x75\x74\x65\x44\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x28\x7A\x32\x4A\x38\x44\x65\x6B\x34\x7B\x58\x7D\x2C\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x2C\x63\x6F\x65\x66\x5F\x64\x79\x6E\x62\x5F\x32\x7B\x58\x7D\x2C\x63\x6F\x65\x66\x5F\x64\x79\x6E\x62\x5F\x33\x7B\x58\x7D\x2C\x4E\x2C\x4C\x7B\x58\x7D\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x6A\x36\x6D\x37\x50\x35\x44\x7B\x58\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x3D\x30\x2E\x30\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x3D\x31\x2E\x30\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x4C\x49\x4E\x45\x41\x52\x44\x45\x50\x54\x48\x7B\x58\x7D\x0A\x0A\x64\x65\x70\x74\x68\x7B\x58\x7D\x3D\x6C\x65\x6E\x67\x74\x68\x28\x76\x50\x6F\x73\x69\x74\x69\x6F\x6E\x57\x2D\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x51\x6E\x36\x35\x54\x62\x71\x34\x29\x3B\x0A\x64\x65\x70\x74\x68\x7B\x58\x7D\x3D\x28\x64\x65\x70\x74\x68\x7B\x58\x7D\x2D\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2E\x78\x29\x2F\x28\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2E\x79\x2D\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2E\x78\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x64\x65\x70\x74\x68\x7B\x58\x7D\x3D\x30\x2E\x35\x2A\x28\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x7A\x2F\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x77\x29\x2B\x30\x2E\x35\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x58\x66\x33\x36\x43\x67\x65\x32\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x72\x65\x63\x6F\x6D\x70\x75\x74\x65\x64\x50\x43\x53\x53\x5F\x46\x46\x43\x75\x62\x65\x28\x6C\x69\x67\x68\x74\x7B\x58\x7D\x2E\x51\x6E\x36\x35\x54\x62\x71\x34\x2C\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x2C\x2D\x4C\x7B\x58\x7D\x2C\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x29\x3B\x0A\x0A\x23\x65\x6C\x73\x65\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x30\x2E\x30\x3B\x0A\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x76\x65\x63\x32\x20\x75\x76\x7B\x58\x7D\x3D\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x78\x79\x2F\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x77\x3B\x0A\x75\x76\x7B\x58\x7D\x3D\x30\x2E\x35\x2A\x75\x76\x7B\x58\x7D\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x72\x65\x63\x6F\x6D\x70\x75\x74\x65\x64\x50\x43\x53\x53\x28\x64\x65\x70\x74\x68\x7B\x58\x7D\x2C\x75\x76\x7B\x58\x7D\x2C\x0A\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x2C\x0A\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x0A\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x2C\x0A\x74\x72\x75\x65\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x72\x65\x63\x6F\x6D\x70\x75\x74\x65\x64\x50\x43\x53\x53\x28\x64\x65\x70\x74\x68\x7B\x58\x7D\x2C\x75\x76\x7B\x58\x7D\x2C\x0A\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x2C\x0A\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x0A\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x2C\x0A\x66\x61\x6C\x73\x65\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x72\x38\x6A\x33\x4D\x37\x42\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x30\x2E\x30\x3B\x0A\x0A\x23\x65\x6C\x73\x65\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x30\x2E\x30\x3B\x0A\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x76\x65\x63\x32\x20\x75\x76\x7B\x58\x7D\x3D\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x78\x79\x2F\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x77\x3B\x0A\x75\x76\x7B\x58\x7D\x3D\x30\x2E\x35\x2A\x75\x76\x7B\x58\x7D\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x29\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x7B\x58\x7D\x2C\x0A\x64\x65\x70\x74\x68\x7B\x58\x7D\x2C\x75\x76\x7B\x58\x7D\x2C\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x2C\x0A\x78\x39\x52\x34\x44\x63\x6E\x37\x7B\x58\x7D\x2C\x64\x38\x41\x39\x51\x78\x4C\x65\x7B\x58\x7D\x2C\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2C\x4A\x61\x38\x34\x52\x6D\x50\x63\x7B\x58\x7D\x2C\x0A\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x2C\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x2C\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x2C\x0A\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x2C\x0A\x74\x72\x75\x65\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x7B\x58\x7D\x2C\x0A\x64\x65\x70\x74\x68\x7B\x58\x7D\x2C\x75\x76\x7B\x58\x7D\x2C\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x2C\x0A\x78\x39\x52\x34\x44\x63\x6E\x37\x7B\x58\x7D\x2C\x64\x38\x41\x39\x51\x78\x4C\x65\x7B\x58\x7D\x2C\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x2C\x4A\x61\x38\x34\x52\x6D\x50\x63\x7B\x58\x7D\x2C\x0A\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x2C\x45\x7A\x32\x67\x39\x4C\x33\x4B\x7B\x58\x7D\x2C\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x2C\x0A\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x7B\x58\x7D\x2C\x0A\x66\x61\x6C\x73\x65\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x63\x6F\x6D\x70\x75\x74\x65\x53\x68\x61\x64\x6F\x77\x28\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2C\x0A\x71\x38\x4E\x4C\x6D\x32\x62\x34\x7B\x58\x7D\x2C\x0A\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x74\x72\x75\x65\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3D\x63\x6F\x6D\x70\x75\x74\x65\x53\x68\x61\x64\x6F\x77\x28\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2C\x0A\x71\x38\x4E\x4C\x6D\x32\x62\x34\x7B\x58\x7D\x2C\x0A\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x7B\x58\x7D\x2C\x66\x61\x6C\x73\x65\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x64\x69\x66\x66\x75\x73\x65\x2A\x3D\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3B\x0A\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x73\x70\x65\x63\x75\x6C\x61\x72\x2A\x3D\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3B\x0A\x73\x68\x61\x64\x6F\x77\x54\x6F\x74\x61\x6C\x2A\x3D\x73\x68\x61\x64\x6F\x77\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x64\x69\x72\x65\x63\x74\x44\x69\x66\x66\x75\x73\x65\x46\x61\x63\x74\x6F\x72\x2B\x3D\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x64\x69\x66\x66\x75\x73\x65\x3B\x0A\x64\x69\x72\x65\x63\x74\x53\x70\x65\x63\x75\x6C\x61\x72\x46\x61\x63\x74\x6F\x72\x2B\x3D\x51\x62\x34\x36\x54\x78\x42\x6F\x7B\x58\x7D\x2E\x73\x70\x65\x63\x75\x6C\x61\x72\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x64\x32\x45\x4B\x7A\x36\x35\x58\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x69\x35\x50\x42\x71\x36\x64\x34\x7B\x58\x7D\x0A\x7B\x0A\x76\x65\x63\x33\x20\x51\x6E\x36\x35\x54\x62\x71\x34\x3B\x0A\x76\x65\x63\x33\x20\x59\x70\x33\x32\x42\x6A\x54\x79\x3B\x0A\x76\x65\x63\x33\x20\x66\x33\x4A\x46\x6E\x36\x39\x44\x3B\x0A\x7D\x20\x6C\x69\x67\x68\x74\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x37\x38\x54\x6F\x6A\x36\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x58\x66\x33\x36\x43\x67\x65\x32\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x32\x4A\x38\x44\x65\x6B\x34\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x43\x75\x62\x65\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x72\x38\x6A\x33\x4D\x37\x42\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x0A\x0A\x0A\x0A\x0A\x0A\x23\x65\x6C\x73\x65\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x7B\x58\x7D\x3B\x0A\x23\x69\x66\x6E\x64\x65\x66\x20\x50\x6F\x33\x32\x4A\x74\x62\x39\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x45\x7A\x32\x67\x39\x4C\x33\x4B\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x78\x39\x52\x34\x44\x63\x6E\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x64\x38\x41\x39\x51\x78\x4C\x65\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x4A\x61\x38\x34\x52\x6D\x50\x63\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x66\x36\x54\x35\x52\x62\x4C\x61\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x66\x6C\x6F\x61\x74\x20\x7A\x32\x4A\x38\x44\x65\x6B\x34\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x33\x20\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x33\x54\x38\x4D\x65\x62\x37\x7B\x58\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x4B\x64\x36\x61\x35\x44\x45\x6B\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x76\x65\x63\x34\x20\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3B\x0A\x76\x61\x72\x79\x69\x6E\x67\x20\x66\x6C\x6F\x61\x74\x20\x71\x38\x4E\x4C\x6D\x32\x62\x34\x7B\x58\x7D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x47\x73\x36\x32\x48\x63\x67\x34\x0A\x0A\x23\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x61\x39\x45\x52\x6E\x35\x32\x57\x29\x0A\x63\x6F\x6E\x73\x74\x20\x69\x6E\x74\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3D\x34\x3B\x0A\x76\x65\x63\x32\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x5D\x3B\x0A\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x39\x34\x32\x30\x31\x36\x32\x34\x2C\x2D\x30\x2E\x33\x39\x39\x30\x36\x32\x31\x36\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x34\x35\x35\x38\x36\x30\x39\x2C\x2D\x30\x2E\x37\x36\x38\x39\x30\x37\x32\x35\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x39\x34\x31\x38\x34\x31\x30\x31\x2C\x2D\x30\x2E\x39\x32\x39\x33\x38\x38\x37\x30\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x33\x34\x34\x39\x35\x39\x33\x38\x2C\x30\x2E\x32\x39\x33\x38\x37\x37\x36\x30\x29\x3B\x0A\x0A\x23\x65\x6C\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x45\x78\x34\x38\x48\x79\x62\x37\x29\x0A\x63\x6F\x6E\x73\x74\x20\x69\x6E\x74\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3D\x31\x36\x3B\x0A\x76\x65\x63\x32\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x5D\x3B\x0A\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x39\x34\x32\x30\x31\x36\x32\x34\x2C\x2D\x30\x2E\x33\x39\x39\x30\x36\x32\x31\x36\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x34\x35\x35\x38\x36\x30\x39\x2C\x2D\x30\x2E\x37\x36\x38\x39\x30\x37\x32\x35\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x39\x34\x31\x38\x34\x31\x30\x31\x2C\x2D\x30\x2E\x39\x32\x39\x33\x38\x38\x37\x30\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x33\x34\x34\x39\x35\x39\x33\x38\x2C\x30\x2E\x32\x39\x33\x38\x37\x37\x36\x30\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x39\x31\x35\x38\x38\x35\x38\x31\x2C\x30\x2E\x34\x35\x37\x37\x31\x34\x33\x32\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x31\x35\x34\x34\x32\x33\x32\x2C\x2D\x30\x2E\x38\x37\x39\x31\x32\x34\x36\x34\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x38\x32\x37\x37\x35\x34\x33\x2C\x30\x2E\x32\x37\x36\x37\x36\x38\x34\x35\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x37\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x37\x34\x38\x34\x33\x39\x38\x2C\x30\x2E\x37\x35\x36\x34\x38\x33\x37\x39\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x38\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x34\x34\x33\x32\x33\x33\x32\x35\x2C\x2D\x30\x2E\x39\x37\x35\x31\x31\x35\x35\x34\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x39\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x35\x33\x37\x34\x32\x39\x38\x31\x2C\x2D\x30\x2E\x34\x37\x33\x37\x33\x34\x32\x30\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x32\x36\x34\x39\x36\x39\x31\x31\x2C\x2D\x30\x2E\x34\x31\x38\x39\x33\x30\x32\x33\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x31\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x37\x39\x31\x39\x37\x35\x31\x34\x2C\x30\x2E\x31\x39\x30\x39\x30\x31\x38\x38\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x32\x34\x31\x38\x38\x38\x34\x30\x2C\x30\x2E\x39\x39\x37\x30\x36\x35\x30\x37\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x33\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x31\x34\x30\x39\x39\x35\x35\x2C\x30\x2E\x39\x31\x34\x33\x37\x35\x39\x30\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x34\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x31\x39\x39\x38\x34\x31\x32\x36\x2C\x30\x2E\x37\x38\x36\x34\x31\x33\x36\x37\x20\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x35\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x31\x34\x33\x38\x33\x31\x36\x31\x2C\x2D\x30\x2E\x31\x34\x31\x30\x30\x37\x39\x30\x20\x29\x3B\x0A\x0A\x23\x65\x6C\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x5A\x6E\x32\x6D\x38\x53\x54\x64\x29\x20\x0A\x63\x6F\x6E\x73\x74\x20\x69\x6E\x74\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3D\x32\x35\x3B\x0A\x76\x65\x63\x32\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x5D\x3B\x0A\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x39\x37\x38\x36\x39\x38\x2C\x2D\x30\x2E\x30\x38\x38\x34\x31\x32\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x34\x31\x31\x32\x31\x2C\x30\x2E\x35\x32\x31\x31\x36\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x31\x37\x34\x36\x2C\x2D\x30\x2E\x35\x30\x33\x32\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x30\x32\x39\x33\x33\x2C\x30\x2E\x39\x30\x33\x31\x33\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x36\x33\x31\x39\x38\x2C\x30\x2E\x31\x35\x34\x38\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x34\x39\x35\x31\x30\x32\x2C\x2D\x30\x2E\x32\x33\x32\x38\x38\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x36\x34\x32\x33\x38\x2C\x2D\x30\x2E\x39\x36\x31\x37\x39\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x37\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x34\x35\x38\x36\x36\x2C\x2D\x30\x2E\x35\x36\x34\x33\x37\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x38\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x32\x35\x36\x36\x33\x2C\x30\x2E\x36\x34\x30\x33\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x39\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x38\x32\x37\x31\x34\x2C\x30\x2E\x33\x32\x31\x33\x32\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x34\x32\x36\x31\x33\x2C\x2D\x30\x2E\x30\x32\x32\x37\x33\x36\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x31\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x35\x36\x34\x32\x38\x37\x2C\x2D\x30\x2E\x33\x36\x37\x32\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x31\x38\x35\x38\x35\x38\x2C\x30\x2E\x39\x31\x38\x38\x38\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x30\x33\x38\x31\x37\x38\x37\x2C\x2D\x30\x2E\x37\x32\x38\x39\x39\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x34\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x31\x36\x35\x39\x39\x2C\x30\x2E\x30\x39\x33\x31\x31\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x35\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x32\x35\x33\x36\x33\x39\x2C\x30\x2E\x37\x31\x39\x35\x33\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x36\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x33\x36\x39\x35\x34\x39\x2C\x2D\x30\x2E\x36\x35\x35\x30\x31\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x37\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x34\x32\x33\x36\x32\x37\x2C\x30\x2E\x34\x32\x39\x39\x37\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x38\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x35\x33\x30\x37\x34\x37\x2C\x2D\x30\x2E\x33\x36\x34\x39\x37\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x39\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x35\x36\x36\x30\x32\x37\x2C\x2D\x30\x2E\x39\x34\x30\x34\x38\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x30\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x36\x33\x39\x33\x33\x32\x2C\x30\x2E\x30\x32\x38\x34\x31\x32\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x31\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x36\x35\x32\x30\x38\x39\x2C\x30\x2E\x36\x36\x39\x36\x36\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x32\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x37\x37\x33\x37\x39\x37\x2C\x30\x2E\x33\x34\x35\x30\x31\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x36\x38\x38\x37\x31\x2C\x30\x2E\x38\x34\x30\x34\x34\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x34\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x39\x31\x38\x38\x32\x2C\x2D\x30\x2E\x36\x35\x37\x33\x33\x38\x29\x3B\x0A\x0A\x23\x65\x6C\x69\x66\x20\x64\x65\x66\x69\x6E\x65\x64\x28\x58\x79\x35\x66\x33\x46\x4D\x62\x29\x0A\x63\x6F\x6E\x73\x74\x20\x69\x6E\x74\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3D\x36\x34\x3B\x0A\x76\x65\x63\x32\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x5D\x3B\x0A\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x31\x33\x33\x39\x32\x2C\x20\x30\x2E\x36\x31\x37\x34\x38\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x31\x37\x30\x30\x31\x39\x2C\x20\x2D\x30\x2E\x30\x34\x30\x32\x35\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x32\x39\x39\x34\x31\x37\x2C\x20\x30\x2E\x37\x39\x31\x39\x32\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x34\x35\x36\x38\x30\x2C\x20\x30\x2E\x34\x39\x33\x32\x31\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x35\x31\x37\x38\x34\x2C\x20\x30\x2E\x37\x31\x37\x38\x38\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x34\x32\x31\x30\x30\x33\x2C\x20\x30\x2E\x30\x32\x37\x30\x37\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x31\x37\x31\x39\x34\x2C\x20\x2D\x30\x2E\x32\x37\x31\x30\x39\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x30\x35\x33\x37\x34\x2C\x20\x2D\x30\x2E\x36\x36\x38\x32\x30\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x39\x37\x37\x30\x35\x30\x2C\x20\x2D\x30\x2E\x31\x30\x38\x36\x31\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x36\x33\x33\x32\x36\x2C\x20\x30\x2E\x31\x34\x32\x33\x36\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x32\x30\x33\x35\x32\x38\x2C\x20\x30\x2E\x32\x31\x34\x33\x33\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x36\x37\x35\x33\x31\x2C\x20\x30\x2E\x33\x32\x36\x30\x39\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x39\x38\x34\x32\x32\x2C\x20\x2D\x30\x2E\x32\x39\x35\x37\x35\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x38\x35\x39\x32\x32\x2C\x20\x30\x2E\x32\x31\x35\x33\x36\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x35\x36\x36\x36\x33\x37\x2C\x20\x30\x2E\x36\x30\x35\x32\x31\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x33\x39\x37\x36\x36\x2C\x20\x2D\x30\x2E\x33\x39\x36\x31\x30\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x37\x35\x31\x39\x34\x36\x2C\x20\x30\x2E\x34\x35\x33\x33\x35\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x37\x38\x37\x30\x37\x2C\x20\x2D\x30\x2E\x37\x31\x35\x33\x32\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x37\x35\x38\x33\x38\x2C\x20\x2D\x30\x2E\x35\x32\x39\x33\x34\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x37\x32\x34\x34\x37\x39\x2C\x20\x2D\x30\x2E\x35\x38\x30\x37\x39\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x32\x32\x32\x39\x39\x39\x2C\x20\x2D\x30\x2E\x32\x31\x35\x31\x32\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x34\x36\x37\x35\x37\x34\x2C\x20\x2D\x30\x2E\x34\x30\x35\x34\x33\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x32\x34\x38\x32\x36\x38\x2C\x20\x2D\x30\x2E\x38\x31\x34\x37\x35\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x33\x35\x34\x34\x31\x31\x2C\x20\x2D\x30\x2E\x38\x38\x37\x35\x37\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x31\x37\x35\x38\x31\x37\x2C\x20\x30\x2E\x33\x38\x32\x33\x36\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x34\x38\x37\x34\x37\x32\x2C\x20\x2D\x30\x2E\x30\x36\x33\x30\x38\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x38\x34\x30\x37\x38\x2C\x20\x30\x2E\x38\x39\x38\x33\x31\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x34\x38\x38\x38\x37\x36\x2C\x20\x2D\x30\x2E\x37\x38\x33\x34\x34\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x34\x37\x30\x30\x31\x36\x2C\x20\x30\x2E\x32\x31\x37\x39\x33\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x39\x36\x38\x39\x30\x2C\x20\x2D\x30\x2E\x35\x34\x39\x37\x39\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x34\x39\x36\x39\x33\x2C\x20\x30\x2E\x36\x30\x35\x37\x36\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x33\x34\x32\x31\x31\x2C\x20\x30\x2E\x39\x37\x39\x39\x38\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x35\x30\x33\x30\x39\x38\x2C\x20\x2D\x30\x2E\x33\x30\x38\x38\x37\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x31\x36\x32\x30\x35\x2C\x20\x2D\x30\x2E\x38\x37\x32\x39\x32\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x33\x38\x35\x37\x38\x34\x2C\x20\x2D\x30\x2E\x33\x39\x33\x39\x30\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x34\x36\x38\x38\x36\x2C\x20\x2D\x30\x2E\x38\x35\x39\x32\x34\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x34\x33\x33\x36\x31\x2C\x20\x30\x2E\x31\x36\x34\x30\x39\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x33\x34\x33\x38\x38\x2C\x20\x2D\x30\x2E\x30\x34\x39\x34\x37\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x38\x38\x38\x39\x34\x2C\x20\x30\x2E\x30\x30\x37\x38\x34\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x34\x36\x34\x30\x33\x34\x2C\x20\x2D\x30\x2E\x31\x38\x38\x38\x31\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x34\x34\x30\x38\x34\x30\x2C\x20\x30\x2E\x31\x33\x37\x34\x38\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x33\x36\x34\x34\x38\x33\x2C\x20\x30\x2E\x35\x31\x31\x37\x30\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x33\x34\x30\x32\x38\x2C\x20\x30\x2E\x33\x32\x35\x39\x36\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x39\x39\x30\x39\x34\x2C\x20\x2D\x30\x2E\x33\x30\x38\x30\x32\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x39\x33\x39\x36\x30\x2C\x20\x2D\x30\x2E\x33\x36\x36\x32\x35\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x37\x38\x38\x38\x34\x2C\x20\x2D\x30\x2E\x32\x30\x34\x36\x38\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x30\x31\x38\x30\x31\x2C\x20\x30\x2E\x37\x38\x30\x33\x32\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x31\x34\x35\x31\x37\x37\x2C\x20\x2D\x30\x2E\x38\x39\x38\x39\x38\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x30\x36\x32\x36\x35\x35\x2C\x20\x2D\x30\x2E\x36\x31\x31\x38\x36\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x33\x31\x35\x32\x32\x36\x2C\x20\x2D\x30\x2E\x36\x30\x34\x32\x39\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x38\x30\x31\x34\x35\x2C\x20\x30\x2E\x34\x38\x36\x32\x35\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x37\x31\x38\x36\x38\x2C\x20\x30\x2E\x38\x38\x32\x31\x33\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x32\x30\x30\x34\x37\x36\x2C\x20\x30\x2E\x34\x39\x34\x34\x33\x30\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x34\x39\x34\x35\x35\x32\x2C\x20\x2D\x30\x2E\x37\x31\x31\x30\x35\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x34\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x36\x31\x32\x34\x37\x36\x2C\x20\x30\x2E\x37\x30\x35\x32\x35\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x35\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x35\x37\x38\x38\x34\x35\x2C\x20\x2D\x30\x2E\x37\x36\x38\x37\x39\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x36\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x37\x32\x34\x35\x34\x2C\x20\x2D\x30\x2E\x30\x39\x30\x39\x37\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x37\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x35\x30\x34\x34\x34\x30\x2C\x20\x30\x2E\x33\x37\x32\x32\x39\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x38\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x31\x35\x35\x37\x33\x36\x2C\x20\x30\x2E\x30\x36\x35\x31\x35\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x39\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x33\x39\x31\x35\x32\x32\x2C\x20\x30\x2E\x38\x34\x39\x36\x30\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x30\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x32\x30\x31\x30\x36\x2C\x20\x2D\x30\x2E\x33\x32\x38\x31\x30\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x31\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x30\x2E\x37\x38\x39\x32\x33\x39\x2C\x20\x2D\x30\x2E\x34\x31\x39\x39\x36\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x32\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x35\x34\x35\x33\x39\x36\x2C\x20\x30\x2E\x35\x33\x38\x31\x33\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x33\x5D\x20\x3D\x20\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x37\x38\x35\x36\x34\x2C\x20\x2D\x30\x2E\x35\x39\x36\x30\x35\x37\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x0A\x63\x6F\x6E\x73\x74\x20\x69\x6E\x74\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3D\x32\x35\x3B\x0A\x76\x65\x63\x32\x20\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x5D\x3B\x0A\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x39\x37\x38\x36\x39\x38\x2C\x2D\x30\x2E\x30\x38\x38\x34\x31\x32\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x38\x34\x31\x31\x32\x31\x2C\x30\x2E\x35\x32\x31\x31\x36\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x31\x37\x34\x36\x2C\x2D\x30\x2E\x35\x30\x33\x32\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x33\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x37\x30\x32\x39\x33\x33\x2C\x30\x2E\x39\x30\x33\x31\x33\x34\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x34\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x36\x36\x33\x31\x39\x38\x2C\x30\x2E\x31\x35\x34\x38\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x35\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x34\x39\x35\x31\x30\x32\x2C\x2D\x30\x2E\x32\x33\x32\x38\x38\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x36\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x36\x34\x32\x33\x38\x2C\x2D\x30\x2E\x39\x36\x31\x37\x39\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x37\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x34\x35\x38\x36\x36\x2C\x2D\x30\x2E\x35\x36\x34\x33\x37\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x38\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x33\x32\x35\x36\x36\x33\x2C\x30\x2E\x36\x34\x30\x33\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x39\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x38\x32\x37\x31\x34\x2C\x30\x2E\x33\x32\x31\x33\x32\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x30\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x31\x34\x32\x36\x31\x33\x2C\x2D\x30\x2E\x30\x32\x32\x37\x33\x36\x33\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x31\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x35\x36\x34\x32\x38\x37\x2C\x2D\x30\x2E\x33\x36\x37\x32\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x32\x5D\x3D\x76\x65\x63\x32\x28\x2D\x30\x2E\x30\x31\x38\x35\x38\x35\x38\x2C\x30\x2E\x39\x31\x38\x38\x38\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x30\x33\x38\x31\x37\x38\x37\x2C\x2D\x30\x2E\x37\x32\x38\x39\x39\x36\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x34\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x31\x36\x35\x39\x39\x2C\x30\x2E\x30\x39\x33\x31\x31\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x35\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x32\x35\x33\x36\x33\x39\x2C\x30\x2E\x37\x31\x39\x35\x33\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x36\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x33\x36\x39\x35\x34\x39\x2C\x2D\x30\x2E\x36\x35\x35\x30\x31\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x37\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x34\x32\x33\x36\x32\x37\x2C\x30\x2E\x34\x32\x39\x39\x37\x35\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x38\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x35\x33\x30\x37\x34\x37\x2C\x2D\x30\x2E\x33\x36\x34\x39\x37\x31\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x31\x39\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x35\x36\x36\x30\x32\x37\x2C\x2D\x30\x2E\x39\x34\x30\x34\x38\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x30\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x36\x33\x39\x33\x33\x32\x2C\x30\x2E\x30\x32\x38\x34\x31\x32\x37\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x31\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x36\x35\x32\x30\x38\x39\x2C\x30\x2E\x36\x36\x39\x36\x36\x38\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x32\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x37\x37\x33\x37\x39\x37\x2C\x30\x2E\x33\x34\x35\x30\x31\x32\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x33\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x36\x38\x38\x37\x31\x2C\x30\x2E\x38\x34\x30\x34\x34\x39\x29\x3B\x0A\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x32\x34\x5D\x3D\x76\x65\x63\x32\x28\x30\x2E\x39\x39\x31\x38\x38\x32\x2C\x2D\x30\x2E\x36\x35\x37\x33\x33\x38\x29\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x0A\x23\x65\x6E\x64\x69\x66","\x23\x69\x66\x64\x65\x66\x20\x47\x73\x36\x32\x48\x63\x67\x34\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x52\x61\x6E\x64\x6F\x6D\x4E\x75\x6D\x62\x65\x72\x28\x76\x65\x63\x33\x20\x73\x65\x65\x64\x2C\x20\x69\x6E\x74\x20\x69\x6E\x70\x75\x74\x49\x29\x7B\x0A\x76\x65\x63\x34\x20\x73\x65\x65\x64\x34\x20\x3D\x20\x76\x65\x63\x34\x28\x73\x65\x65\x64\x2C\x69\x6E\x70\x75\x74\x49\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x6F\x74\x5F\x70\x72\x6F\x64\x75\x63\x74\x20\x3D\x20\x64\x6F\x74\x28\x73\x65\x65\x64\x34\x2C\x20\x76\x65\x63\x34\x28\x31\x32\x2E\x39\x38\x39\x38\x2C\x37\x38\x2E\x32\x33\x33\x2C\x34\x35\x2E\x31\x36\x34\x2C\x39\x34\x2E\x36\x37\x33\x29\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x66\x72\x61\x63\x74\x28\x73\x69\x6E\x28\x64\x6F\x74\x5F\x70\x72\x6F\x64\x75\x63\x74\x29\x20\x2A\x20\x34\x33\x37\x35\x38\x2E\x35\x34\x35\x33\x29\x3B\x0A\x7D\x0A\x62\x6F\x6F\x6C\x20\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x28\x75\x76\x2E\x78\x3C\x30\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x78\x3E\x31\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x79\x3C\x30\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x79\x3E\x31\x2E\x30\x20\x7C\x7C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x3C\x30\x2E\x30\x29\x3B\x7D\x0A\x62\x6F\x6F\x6C\x20\x69\x73\x55\x56\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x76\x65\x63\x32\x20\x75\x76\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x28\x75\x76\x2E\x78\x3C\x30\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x78\x3E\x31\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x79\x3C\x30\x2E\x30\x20\x7C\x7C\x20\x75\x76\x2E\x79\x3E\x31\x2E\x30\x29\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x75\x74\x65\x44\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x28\x66\x6C\x6F\x61\x74\x20\x62\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x62\x5F\x31\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x62\x5F\x32\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x62\x5F\x33\x2C\x76\x65\x63\x33\x20\x4E\x2C\x76\x65\x63\x33\x20\x4C\x29\x20\x0A\x7B\x0A\x76\x65\x63\x33\x20\x4E\x5F\x31\x20\x3D\x20\x64\x79\x6E\x62\x5F\x31\x2A\x4E\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x73\x54\x68\x65\x74\x61\x3D\x63\x6C\x61\x6D\x70\x28\x64\x6F\x74\x28\x4E\x2C\x4C\x29\x2B\x64\x79\x6E\x62\x5F\x32\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x3D\x62\x69\x61\x73\x2A\x74\x61\x6E\x28\x61\x63\x6F\x73\x28\x63\x6F\x73\x54\x68\x65\x74\x61\x29\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2A\x64\x79\x6E\x62\x5F\x33\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6E\x76\x65\x72\x74\x46\x72\x6F\x6D\x53\x63\x72\x65\x65\x6E\x54\x6F\x56\x69\x65\x77\x53\x70\x61\x63\x65\x28\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x53\x2C\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x29\x0A\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x4E\x44\x43\x3D\x64\x65\x70\x74\x68\x53\x2A\x32\x2E\x30\x2D\x31\x2E\x30\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x2D\x32\x2E\x30\x2A\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x78\x2A\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x79\x2F\x28\x64\x65\x70\x74\x68\x4E\x44\x43\x2A\x28\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x79\x2D\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x78\x29\x2D\x28\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x79\x2B\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x78\x29\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x75\x6E\x70\x61\x63\x6B\x32\x34\x42\x69\x74\x73\x28\x76\x65\x63\x33\x20\x63\x6F\x6C\x6F\x72\x29\x0A\x7B\x0A\x63\x6F\x6E\x73\x74\x20\x76\x65\x63\x33\x20\x62\x69\x74\x5F\x73\x68\x69\x66\x74\x3D\x76\x65\x63\x33\x28\x31\x2E\x30\x2F\x28\x32\x35\x35\x2E\x30\x2A\x32\x35\x35\x2E\x30\x29\x2C\x31\x2E\x30\x2F\x32\x35\x35\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x64\x6F\x74\x28\x63\x6F\x6C\x6F\x72\x2C\x62\x69\x74\x5F\x73\x68\x69\x66\x74\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x75\x6E\x70\x61\x63\x6B\x28\x76\x65\x63\x34\x20\x63\x6F\x6C\x6F\x72\x29\x0A\x7B\x0A\x63\x6F\x6E\x73\x74\x20\x76\x65\x63\x34\x20\x62\x69\x74\x5F\x73\x68\x69\x66\x74\x3D\x76\x65\x63\x34\x28\x31\x2E\x30\x2F\x28\x32\x35\x35\x2E\x30\x2A\x32\x35\x35\x2E\x30\x2A\x32\x35\x35\x2E\x30\x29\x2C\x31\x2E\x30\x2F\x28\x32\x35\x35\x2E\x30\x2A\x32\x35\x35\x2E\x30\x29\x2C\x31\x2E\x30\x2F\x32\x35\x35\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x64\x6F\x74\x28\x63\x6F\x6C\x6F\x72\x2C\x62\x69\x74\x5F\x73\x68\x69\x66\x74\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x69\x6E\x73\x74\x65\x70\x28\x66\x6C\x6F\x61\x74\x20\x6C\x6F\x77\x2C\x66\x6C\x6F\x61\x74\x20\x68\x69\x67\x68\x2C\x66\x6C\x6F\x61\x74\x20\x76\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x63\x6C\x61\x6D\x70\x28\x28\x76\x2D\x6C\x6F\x77\x29\x2F\x28\x68\x69\x67\x68\x2D\x6C\x6F\x77\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x65\x70\x74\x68\x73\x2C\x20\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x0A\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x75\x76\x29\x2E\x72\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x73\x74\x65\x70\x28\x63\x6F\x6D\x70\x61\x72\x65\x2C\x20\x64\x65\x70\x74\x68\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x53\x68\x61\x64\x6F\x77\x4C\x65\x72\x70\x28\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x65\x70\x74\x68\x73\x2C\x20\x76\x65\x63\x32\x20\x73\x69\x7A\x65\x2C\x20\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x0A\x7B\x0A\x76\x65\x63\x32\x20\x74\x65\x78\x65\x6C\x53\x69\x7A\x65\x20\x3D\x20\x76\x65\x63\x32\x28\x31\x2E\x30\x29\x2F\x73\x69\x7A\x65\x3B\x0A\x76\x65\x63\x32\x20\x66\x20\x3D\x20\x66\x72\x61\x63\x74\x28\x75\x76\x2A\x73\x69\x7A\x65\x2B\x30\x2E\x35\x29\x3B\x0A\x76\x65\x63\x32\x20\x63\x65\x6E\x74\x72\x6F\x69\x64\x55\x56\x20\x3D\x20\x66\x6C\x6F\x6F\x72\x28\x75\x76\x2A\x73\x69\x7A\x65\x2B\x30\x2E\x35\x29\x2F\x73\x69\x7A\x65\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x62\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x63\x65\x6E\x74\x72\x6F\x69\x64\x55\x56\x2B\x74\x65\x78\x65\x6C\x53\x69\x7A\x65\x2A\x76\x65\x63\x32\x28\x30\x2E\x30\x2C\x20\x30\x2E\x30\x29\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6C\x74\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x63\x65\x6E\x74\x72\x6F\x69\x64\x55\x56\x2B\x74\x65\x78\x65\x6C\x53\x69\x7A\x65\x2A\x76\x65\x63\x32\x28\x30\x2E\x30\x2C\x20\x31\x2E\x30\x29\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x62\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x63\x65\x6E\x74\x72\x6F\x69\x64\x55\x56\x2B\x74\x65\x78\x65\x6C\x53\x69\x7A\x65\x2A\x76\x65\x63\x32\x28\x31\x2E\x30\x2C\x20\x30\x2E\x30\x29\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x74\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x63\x65\x6E\x74\x72\x6F\x69\x64\x55\x56\x2B\x74\x65\x78\x65\x6C\x53\x69\x7A\x65\x2A\x76\x65\x63\x32\x28\x31\x2E\x30\x2C\x20\x31\x2E\x30\x29\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x20\x3D\x20\x6D\x69\x78\x28\x6C\x62\x2C\x20\x6C\x74\x2C\x20\x66\x2E\x79\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x62\x20\x3D\x20\x6D\x69\x78\x28\x72\x62\x2C\x20\x72\x74\x2C\x20\x66\x2E\x79\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x63\x20\x3D\x20\x6D\x69\x78\x28\x61\x2C\x20\x62\x2C\x20\x66\x2E\x78\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x63\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x50\x65\x72\x63\x65\x6E\x74\x61\x67\x65\x43\x6C\x6F\x73\x65\x72\x46\x69\x6C\x74\x65\x72\x69\x6E\x67\x28\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x65\x70\x74\x68\x73\x2C\x20\x76\x65\x63\x32\x20\x73\x69\x7A\x65\x2C\x20\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x73\x75\x6C\x74\x20\x3D\x20\x30\x2E\x30\x3B\x0A\x66\x6F\x72\x28\x69\x6E\x74\x20\x78\x3D\x2D\x32\x3B\x20\x78\x3C\x3D\x32\x3B\x20\x78\x2B\x2B\x29\x7B\x0A\x66\x6F\x72\x28\x69\x6E\x74\x20\x79\x3D\x2D\x32\x3B\x20\x79\x3C\x3D\x32\x3B\x20\x79\x2B\x2B\x29\x7B\x0A\x76\x65\x63\x32\x20\x6F\x66\x66\x20\x3D\x20\x76\x65\x63\x32\x28\x78\x2C\x79\x29\x2F\x73\x69\x7A\x65\x3B\x0A\x72\x65\x73\x75\x6C\x74\x20\x2B\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x43\x6F\x6D\x70\x61\x72\x65\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x75\x76\x2B\x6F\x66\x66\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x7D\x0A\x7D\x0A\x72\x65\x74\x75\x72\x6E\x20\x72\x65\x73\x75\x6C\x74\x2F\x32\x35\x2E\x30\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x49\x6E\x74\x65\x72\x70\x6F\x6C\x61\x74\x65\x64\x50\x65\x72\x63\x65\x6E\x74\x61\x67\x65\x43\x6C\x6F\x73\x65\x72\x46\x69\x6C\x74\x65\x72\x69\x6E\x67\x28\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x65\x70\x74\x68\x73\x2C\x20\x76\x65\x63\x32\x20\x73\x69\x7A\x65\x2C\x20\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x72\x65\x73\x75\x6C\x74\x20\x3D\x20\x30\x2E\x30\x3B\x0A\x66\x6F\x72\x28\x69\x6E\x74\x20\x78\x3D\x2D\x31\x3B\x20\x78\x3C\x3D\x31\x3B\x20\x78\x2B\x2B\x29\x7B\x0A\x66\x6F\x72\x28\x69\x6E\x74\x20\x79\x3D\x2D\x31\x3B\x20\x79\x3C\x3D\x31\x3B\x20\x79\x2B\x2B\x29\x7B\x0A\x76\x65\x63\x32\x20\x6F\x66\x66\x20\x3D\x20\x76\x65\x63\x32\x28\x78\x2C\x79\x29\x2F\x73\x69\x7A\x65\x3B\x0A\x72\x65\x73\x75\x6C\x74\x20\x2B\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x53\x68\x61\x64\x6F\x77\x4C\x65\x72\x70\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x73\x69\x7A\x65\x2C\x20\x75\x76\x2B\x6F\x66\x66\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x3B\x0A\x7D\x0A\x7D\x0A\x72\x65\x74\x75\x72\x6E\x20\x72\x65\x73\x75\x6C\x74\x2F\x39\x2E\x30\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x56\x53\x4D\x28\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x65\x70\x74\x68\x73\x2C\x20\x76\x65\x63\x32\x20\x75\x76\x2C\x20\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x61\x72\x65\x29\x7B\x0A\x76\x65\x63\x32\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x20\x3D\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x64\x65\x70\x74\x68\x73\x2C\x20\x75\x76\x29\x2E\x78\x79\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x70\x20\x3D\x20\x73\x6D\x6F\x6F\x74\x68\x73\x74\x65\x70\x28\x63\x6F\x6D\x70\x61\x72\x65\x2D\x30\x2E\x30\x32\x2C\x20\x63\x6F\x6D\x70\x61\x72\x65\x2C\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x76\x61\x72\x69\x61\x6E\x63\x65\x20\x3D\x20\x6D\x61\x78\x28\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x79\x20\x2D\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x2A\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x2C\x20\x2D\x30\x2E\x30\x30\x31\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x20\x3D\x20\x63\x6F\x6D\x70\x61\x72\x65\x20\x2D\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x70\x5F\x6D\x61\x78\x20\x3D\x20\x6C\x69\x6E\x73\x74\x65\x70\x28\x30\x2E\x32\x2C\x20\x31\x2E\x30\x2C\x20\x76\x61\x72\x69\x61\x6E\x63\x65\x20\x2F\x20\x28\x76\x61\x72\x69\x61\x6E\x63\x65\x20\x2B\x20\x64\x2A\x64\x29\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x63\x6C\x61\x6D\x70\x28\x6D\x61\x78\x28\x70\x2C\x20\x70\x5F\x6D\x61\x78\x29\x2C\x20\x30\x2E\x30\x2C\x20\x31\x2E\x30\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x63\x68\x65\x62\x79\x73\x68\x65\x76\x28\x76\x65\x63\x32\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x2C\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x29\x0A\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x3D\x64\x65\x70\x74\x68\x3B\x20\x66\x6C\x6F\x61\x74\x20\x70\x3D\x30\x2E\x30\x3B\x0A\x70\x3D\x73\x6D\x6F\x6F\x74\x68\x73\x74\x65\x70\x28\x64\x2D\x30\x2E\x30\x32\x2C\x64\x2C\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x76\x61\x72\x69\x61\x6E\x63\x65\x3D\x6D\x61\x78\x28\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x79\x2D\x28\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x2A\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x29\x2C\x20\x30\x2E\x30\x30\x30\x30\x30\x31\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x64\x69\x66\x66\x3D\x28\x64\x2D\x6D\x6F\x6D\x65\x6E\x74\x73\x2E\x78\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x70\x5F\x6D\x61\x78\x3D\x76\x61\x72\x69\x61\x6E\x63\x65\x2F\x28\x76\x61\x72\x69\x61\x6E\x63\x65\x2B\x64\x69\x66\x66\x2A\x64\x69\x66\x66\x29\x3B\x0A\x70\x5F\x6D\x61\x78\x3D\x6C\x69\x6E\x73\x74\x65\x70\x28\x30\x2E\x31\x2C\x31\x2E\x30\x2C\x70\x5F\x6D\x61\x78\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x63\x6C\x61\x6D\x70\x28\x6D\x61\x78\x28\x70\x2C\x70\x5F\x6D\x61\x78\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x65\x78\x70\x6F\x6E\x65\x6E\x74\x69\x61\x6C\x28\x66\x6C\x6F\x61\x74\x20\x4A\x61\x38\x34\x52\x6D\x50\x63\x2C\x66\x6C\x6F\x61\x74\x20\x6D\x6F\x6D\x65\x6E\x74\x2C\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x63\x6C\x61\x6D\x70\x28\x65\x78\x70\x28\x4A\x61\x38\x34\x52\x6D\x50\x63\x2A\x28\x6D\x6F\x6D\x65\x6E\x74\x2D\x64\x65\x70\x74\x68\x29\x29\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x7D\x0A\x76\x65\x63\x34\x20\x67\x65\x74\x54\x65\x78\x65\x6C\x28\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x61\x6D\x70\x6C\x65\x72\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x73\x61\x6D\x70\x6C\x65\x72\x2C\x75\x76\x29\x3B\x7D\x0A\x76\x65\x63\x32\x20\x67\x65\x74\x4D\x6F\x6D\x65\x6E\x74\x73\x28\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x61\x6D\x70\x6C\x65\x72\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x65\x63\x6F\x6E\x64\x53\x61\x6D\x70\x6C\x65\x72\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x76\x65\x63\x34\x20\x74\x65\x78\x65\x6C\x3D\x67\x65\x74\x54\x65\x78\x65\x6C\x28\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x29\x3B\x69\x66\x28\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x74\x65\x78\x65\x6C\x2E\x78\x79\x3B\x7D\x20\x65\x6C\x73\x65\x20\x7B\x76\x65\x63\x34\x20\x73\x65\x63\x6F\x6E\x64\x54\x65\x78\x65\x6C\x3D\x67\x65\x74\x54\x65\x78\x65\x6C\x28\x75\x76\x2C\x73\x65\x63\x6F\x6E\x64\x53\x61\x6D\x70\x6C\x65\x72\x29\x3B\x20\x72\x65\x74\x75\x72\x6E\x20\x76\x65\x63\x32\x28\x75\x6E\x70\x61\x63\x6B\x28\x74\x65\x78\x65\x6C\x29\x2C\x75\x6E\x70\x61\x63\x6B\x28\x73\x65\x63\x6F\x6E\x64\x54\x65\x78\x65\x6C\x29\x29\x3B\x7D\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x50\x43\x53\x53\x56\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x28\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x61\x6D\x70\x6C\x65\x72\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x76\x65\x63\x34\x20\x74\x65\x78\x65\x6C\x3D\x67\x65\x74\x54\x65\x78\x65\x6C\x28\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x29\x3B\x20\x69\x66\x28\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x74\x65\x78\x65\x6C\x2E\x67\x3B\x7D\x20\x65\x6C\x73\x65\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x74\x65\x78\x65\x6C\x2E\x61\x3B\x7D\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x28\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x61\x6D\x70\x6C\x65\x72\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x76\x65\x63\x34\x20\x74\x65\x78\x65\x6C\x3D\x67\x65\x74\x54\x65\x78\x65\x6C\x28\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x29\x3B\x20\x69\x66\x28\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x74\x65\x78\x65\x6C\x2E\x72\x3B\x7D\x20\x65\x6C\x73\x65\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x75\x6E\x70\x61\x63\x6B\x32\x34\x42\x69\x74\x73\x28\x74\x65\x78\x65\x6C\x2E\x72\x67\x62\x29\x3B\x7D\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x72\x65\x63\x6F\x6D\x70\x75\x74\x65\x64\x50\x43\x53\x53\x28\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x69\x66\x28\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x2C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x50\x43\x53\x53\x56\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x62\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3D\x67\x65\x74\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x69\x66\x20\x28\x62\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x2B\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x3E\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x31\x2E\x30\x3B\x7D\x0A\x72\x65\x74\x75\x72\x6E\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x43\x53\x53\x28\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x76\x65\x63\x33\x20\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2C\x76\x65\x63\x32\x20\x78\x39\x52\x34\x44\x63\x6E\x37\x2C\x76\x65\x63\x32\x20\x64\x38\x41\x39\x51\x78\x4C\x65\x2C\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x69\x66\x28\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x2C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x62\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3D\x67\x65\x74\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x61\x76\x67\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3D\x30\x2E\x30\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6E\x75\x6D\x42\x6C\x6F\x63\x6B\x65\x72\x73\x3D\x30\x2E\x30\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x62\x6C\x6F\x63\x6B\x65\x72\x53\x75\x6D\x3D\x30\x2E\x30\x3B\x0A\x76\x65\x63\x32\x20\x6C\x69\x67\x68\x74\x53\x69\x7A\x65\x55\x56\x3D\x78\x39\x52\x34\x44\x63\x6E\x37\x2F\x64\x38\x41\x39\x51\x78\x4C\x65\x3B\x0A\x76\x65\x63\x32\x20\x73\x65\x61\x72\x63\x68\x52\x65\x67\x69\x6F\x6E\x52\x61\x64\x69\x75\x73\x55\x56\x3D\x6C\x69\x67\x68\x74\x53\x69\x7A\x65\x55\x56\x2A\x28\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2E\x7A\x2D\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x78\x29\x2F\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2E\x7A\x3B\x0A\x66\x6F\x72\x20\x28\x69\x6E\x74\x20\x69\x3D\x30\x3B\x20\x69\x3C\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3B\x20\x69\x2B\x2B\x29\x20\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3D\x67\x65\x74\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x28\x75\x76\x2B\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x69\x5D\x2A\x73\x65\x61\x72\x63\x68\x52\x65\x67\x69\x6F\x6E\x52\x61\x64\x69\x75\x73\x55\x56\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3D\x63\x6F\x6E\x76\x65\x72\x74\x46\x72\x6F\x6D\x53\x63\x72\x65\x65\x6E\x54\x6F\x56\x69\x65\x77\x53\x70\x61\x63\x65\x28\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x2C\x67\x32\x41\x53\x61\x34\x70\x39\x29\x3B\x0A\x69\x66\x20\x28\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3C\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2E\x7A\x29\x20\x7B\x0A\x62\x6C\x6F\x63\x6B\x65\x72\x53\x75\x6D\x2B\x3D\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3B\x0A\x6E\x75\x6D\x42\x6C\x6F\x63\x6B\x65\x72\x73\x2B\x2B\x3B\x0A\x7D\x0A\x7D\x0A\x61\x76\x67\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3D\x62\x6C\x6F\x63\x6B\x65\x72\x53\x75\x6D\x2F\x6E\x75\x6D\x42\x6C\x6F\x63\x6B\x65\x72\x73\x3B\x0A\x69\x66\x20\x28\x6E\x75\x6D\x42\x6C\x6F\x63\x6B\x65\x72\x73\x3C\x31\x2E\x30\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x31\x2E\x30\x3B\x7D\x0A\x65\x6C\x73\x65\x0A\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x70\x65\x6E\x75\x6D\x62\x72\x61\x52\x61\x74\x69\x6F\x3D\x28\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2E\x7A\x2D\x61\x76\x67\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x29\x2F\x61\x76\x67\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x56\x3B\x0A\x76\x65\x63\x32\x20\x66\x69\x6C\x74\x65\x72\x52\x61\x64\x69\x75\x73\x55\x56\x3D\x70\x65\x6E\x75\x6D\x62\x72\x61\x52\x61\x74\x69\x6F\x2A\x6C\x69\x67\x68\x74\x53\x69\x7A\x65\x55\x56\x2A\x67\x32\x41\x53\x61\x34\x70\x39\x2E\x78\x2F\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2E\x7A\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x73\x75\x6D\x3D\x30\x2E\x30\x3B\x0A\x66\x6F\x72\x20\x28\x69\x6E\x74\x20\x69\x3D\x30\x3B\x20\x69\x3C\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x3B\x20\x69\x2B\x2B\x29\x20\x7B\x0A\x76\x65\x63\x32\x20\x6F\x66\x66\x73\x65\x74\x3D\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x5B\x69\x5D\x2A\x66\x69\x6C\x74\x65\x72\x52\x61\x64\x69\x75\x73\x55\x56\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3D\x67\x65\x74\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x28\x75\x76\x2B\x6F\x66\x66\x73\x65\x74\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x69\x66\x20\x28\x6F\x74\x68\x65\x72\x42\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3C\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x20\x7B\x0A\x73\x75\x6D\x2B\x3D\x31\x2E\x30\x3B\x0A\x7D\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x64\x61\x72\x6B\x6E\x65\x73\x73\x3D\x73\x75\x6D\x2F\x66\x6C\x6F\x61\x74\x28\x70\x6F\x69\x73\x73\x6F\x6E\x44\x69\x73\x6B\x53\x69\x7A\x65\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x31\x2E\x30\x2D\x64\x61\x72\x6B\x6E\x65\x73\x73\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3B\x0A\x7D\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x45\x78\x70\x6F\x6E\x65\x6E\x74\x69\x61\x6C\x28\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x66\x6C\x6F\x61\x74\x20\x4A\x61\x38\x34\x52\x6D\x50\x63\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x65\x63\x6F\x6E\x64\x53\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x69\x66\x20\x28\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x2C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x6D\x6F\x6D\x65\x6E\x74\x3D\x67\x65\x74\x4D\x6F\x6D\x65\x6E\x74\x73\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x73\x65\x63\x6F\x6E\x64\x53\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x2E\x78\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x65\x78\x70\x6F\x6E\x65\x6E\x74\x69\x61\x6C\x28\x4A\x61\x38\x34\x52\x6D\x50\x63\x2C\x6D\x6F\x6D\x65\x6E\x74\x2C\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x56\x53\x4D\x28\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x65\x63\x6F\x6E\x64\x53\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x69\x66\x20\x28\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x2C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x29\x7B\x72\x65\x74\x75\x72\x6E\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3B\x7D\x0A\x76\x65\x63\x32\x20\x6D\x6F\x6D\x65\x6E\x74\x73\x3D\x67\x65\x74\x4D\x6F\x6D\x65\x6E\x74\x73\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x73\x65\x63\x6F\x6E\x64\x53\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x0A\x72\x65\x74\x75\x72\x6E\x20\x63\x68\x65\x62\x79\x73\x68\x65\x76\x28\x6D\x6F\x6D\x65\x6E\x74\x73\x2C\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x48\x61\x72\x64\x53\x68\x61\x64\x6F\x77\x28\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x69\x66\x20\x28\x69\x73\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x2C\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x62\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x3D\x67\x65\x74\x4D\x6F\x6D\x65\x6E\x74\x73\x28\x75\x76\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x2E\x78\x3B\x0A\x69\x66\x28\x62\x6C\x6F\x63\x6B\x65\x72\x44\x65\x70\x74\x68\x2B\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x3E\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x29\x20\x72\x65\x74\x75\x72\x6E\x20\x31\x2E\x30\x3B\x20\x65\x6C\x73\x65\x20\x72\x65\x74\x75\x72\x6E\x20\x30\x2E\x30\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x28\x66\x6C\x6F\x61\x74\x20\x66\x36\x54\x35\x52\x62\x4C\x61\x2C\x66\x6C\x6F\x61\x74\x20\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x76\x65\x63\x32\x20\x75\x76\x2C\x76\x65\x63\x33\x20\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2C\x76\x65\x63\x32\x20\x78\x39\x52\x34\x44\x63\x6E\x37\x2C\x76\x65\x63\x32\x20\x64\x38\x41\x39\x51\x78\x4C\x65\x2C\x76\x65\x63\x32\x20\x67\x32\x41\x53\x61\x34\x70\x39\x2C\x66\x6C\x6F\x61\x74\x20\x4A\x61\x38\x34\x52\x6D\x50\x63\x2C\x0A\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x64\x33\x54\x38\x4D\x65\x62\x37\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x45\x7A\x32\x67\x39\x4C\x33\x4B\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x71\x36\x45\x34\x5A\x6D\x57\x61\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x66\x6C\x6F\x61\x74\x20\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x0A\x7B\x0A\x66\x6C\x6F\x61\x74\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x31\x2E\x30\x3B\x0A\x69\x66\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x3C\x31\x2E\x30\x29\x20\x7B\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x48\x61\x72\x64\x53\x68\x61\x64\x6F\x77\x28\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x75\x76\x2C\x64\x33\x54\x38\x4D\x65\x62\x37\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x7D\x0A\x65\x6C\x73\x65\x20\x69\x66\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x3C\x32\x2E\x30\x29\x20\x7B\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x45\x78\x70\x6F\x6E\x65\x6E\x74\x69\x61\x6C\x28\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x75\x76\x2C\x4A\x61\x38\x34\x52\x6D\x50\x63\x2C\x64\x33\x54\x38\x4D\x65\x62\x37\x2C\x45\x7A\x32\x67\x39\x4C\x33\x4B\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x7D\x0A\x65\x6C\x73\x65\x20\x69\x66\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x3C\x33\x2E\x30\x29\x20\x7B\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x56\x53\x4D\x28\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x75\x76\x2C\x64\x33\x54\x38\x4D\x65\x62\x37\x2C\x45\x7A\x32\x67\x39\x4C\x33\x4B\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x7D\x0A\x65\x6C\x73\x65\x20\x69\x66\x28\x66\x36\x54\x35\x52\x62\x4C\x61\x3C\x34\x2E\x30\x29\x20\x7B\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x72\x65\x63\x6F\x6D\x70\x75\x74\x65\x64\x50\x43\x53\x53\x28\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x75\x76\x2C\x71\x36\x45\x34\x5A\x6D\x57\x61\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x7D\x0A\x65\x6C\x73\x65\x20\x7B\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3D\x67\x65\x74\x53\x68\x61\x64\x6F\x77\x46\x72\x6F\x6D\x50\x43\x53\x53\x28\x72\x65\x63\x65\x69\x76\x65\x72\x44\x65\x70\x74\x68\x2C\x75\x76\x2C\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x56\x2C\x78\x39\x52\x34\x44\x63\x6E\x37\x2C\x64\x38\x41\x39\x51\x78\x4C\x65\x2C\x67\x32\x41\x53\x61\x34\x70\x39\x2C\x64\x33\x54\x38\x4D\x65\x62\x37\x2C\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x6F\x75\x74\x73\x69\x64\x65\x4C\x75\x6D\x69\x6E\x61\x6E\x63\x65\x2C\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x3B\x7D\x0A\x72\x65\x74\x75\x72\x6E\x20\x76\x69\x73\x69\x62\x69\x6C\x69\x74\x79\x3B\x0A\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x63\x6F\x6D\x70\x75\x74\x65\x53\x68\x61\x64\x6F\x77\x28\x76\x65\x63\x34\x20\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x2C\x66\x6C\x6F\x61\x74\x20\x64\x65\x70\x74\x68\x4D\x65\x74\x72\x69\x63\x2C\x73\x61\x6D\x70\x6C\x65\x72\x32\x44\x20\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x66\x6C\x6F\x61\x74\x20\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x2C\x62\x6F\x6F\x6C\x20\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x20\x0A\x7B\x0A\x76\x65\x63\x33\x20\x64\x65\x70\x74\x68\x3D\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x2E\x78\x79\x7A\x2F\x70\x6F\x73\x69\x74\x69\x6F\x6E\x46\x72\x6F\x6D\x4C\x69\x67\x68\x74\x2E\x77\x3B\x0A\x76\x65\x63\x32\x20\x75\x76\x3D\x30\x2E\x35\x2A\x64\x65\x70\x74\x68\x2E\x78\x79\x2B\x76\x65\x63\x32\x28\x30\x2E\x35\x29\x3B\x0A\x69\x66\x20\x28\x69\x73\x55\x56\x4F\x75\x74\x4C\x69\x6D\x69\x74\x73\x28\x75\x76\x29\x29\x20\x7B\x72\x65\x74\x75\x72\x6E\x20\x31\x2E\x30\x3B\x7D\x0A\x66\x6C\x6F\x61\x74\x20\x73\x68\x61\x64\x6F\x77\x50\x69\x78\x65\x6C\x44\x65\x70\x74\x68\x3D\x63\x6C\x61\x6D\x70\x28\x64\x65\x70\x74\x68\x4D\x65\x74\x72\x69\x63\x2C\x30\x2E\x30\x2C\x31\x2E\x30\x29\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x73\x68\x61\x64\x6F\x77\x3D\x30\x3B\x0A\x69\x66\x20\x28\x69\x73\x46\x75\x6C\x6C\x46\x6C\x6F\x61\x74\x29\x20\x7B\x73\x68\x61\x64\x6F\x77\x3D\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x75\x76\x29\x2E\x72\x3B\x7D\x20\x65\x6C\x73\x65\x20\x7B\x73\x68\x61\x64\x6F\x77\x3D\x75\x6E\x70\x61\x63\x6B\x28\x74\x65\x78\x74\x75\x72\x65\x32\x44\x28\x73\x68\x61\x64\x6F\x77\x53\x61\x6D\x70\x6C\x65\x72\x2C\x75\x76\x29\x29\x3B\x7D\x0A\x69\x66\x20\x28\x73\x68\x61\x64\x6F\x77\x50\x69\x78\x65\x6C\x44\x65\x70\x74\x68\x3E\x73\x68\x61\x64\x6F\x77\x2B\x64\x79\x6E\x61\x6D\x69\x63\x42\x69\x61\x73\x29\x7B\x72\x65\x74\x75\x72\x6E\x20\x30\x2E\x30\x3B\x7D\x20\x0A\x72\x65\x74\x75\x72\x6E\x20\x31\x2E\x30\x3B\x0A\x7D\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x23\x69\x66\x64\x65\x66\x20\x64\x32\x45\x4B\x7A\x36\x35\x58\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x37\x38\x54\x6F\x6A\x36\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x58\x66\x33\x36\x43\x67\x65\x32\x7B\x58\x7D\x0A\x23\x69\x66\x64\x65\x66\x20\x57\x6E\x39\x79\x38\x45\x51\x72\x7B\x58\x7D\x0A\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3D\x76\x65\x63\x33\x28\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3D\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x72\x38\x6A\x33\x4D\x37\x42\x7B\x58\x7D\x0A\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3D\x47\x77\x38\x34\x51\x64\x52\x6F\x7B\x58\x7D\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x71\x32\x45\x4E\x67\x38\x6E\x39\x7B\x58\x7D\x3D\x76\x65\x63\x33\x28\x74\x36\x4D\x38\x4B\x73\x50\x71\x7B\x58\x7D\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x29\x3B\x0A\x23\x65\x6C\x73\x65\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x78\x36\x32\x4E\x74\x6F\x37\x7B\x58\x7D\x0A\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x3D\x4B\x64\x36\x61\x35\x44\x45\x6B\x7B\x58\x7D\x2A\x77\x6F\x72\x6C\x64\x50\x6F\x73\x69\x74\x69\x6F\x6E\x3B\x0A\x71\x38\x4E\x4C\x6D\x32\x62\x34\x7B\x58\x7D\x3D\x61\x33\x57\x46\x6D\x38\x37\x52\x7B\x58\x7D\x2E\x7A\x2A\x30\x2E\x35\x2B\x30\x2E\x35\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x76\x69\x65\x77\x50\x72\x6F\x6A\x65\x63\x74\x69\x6F\x6E\x3B\x0A\x23\x69\x66\x64\x65\x66\x20\x77\x39\x43\x33\x59\x65\x6E\x34\x0A\x23\x69\x66\x6E\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x76\x69\x65\x77\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x54\x61\x36\x33\x41\x63\x66\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x58\x6F\x38\x71\x34\x41\x32\x52\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x4A\x69\x32\x33\x4B\x7A\x4D\x64\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x48\x70\x34\x6D\x32\x42\x57\x66\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x4C\x6A\x37\x71\x38\x48\x32\x4B\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x57\x72\x35\x69\x38\x52\x33\x53\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x51\x73\x33\x62\x39\x57\x32\x54\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x66\x38\x45\x32\x57\x78\x63\x33\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x71\x34\x41\x35\x44\x69\x79\x38\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x6F\x36\x47\x41\x63\x39\x73\x37\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x74\x33\x47\x51\x6E\x34\x6D\x38\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x45\x7A\x34\x67\x36\x50\x48\x63\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x50\x6E\x34\x6D\x38\x57\x39\x45\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x44\x79\x38\x34\x42\x72\x77\x36\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x32\x20\x78\x34\x53\x36\x4C\x6A\x74\x32\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A\x23\x69\x66\x64\x65\x66\x20\x47\x66\x34\x69\x33\x59\x38\x53\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x6D\x61\x74\x34\x20\x45\x6D\x39\x34\x5A\x78\x73\x37\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x76\x65\x63\x33\x20\x48\x65\x39\x63\x34\x58\x32\x4D\x3B\x0A\x23\x65\x6E\x64\x69\x66\x0A","\x6C\x61\x79\x6F\x75\x74\x28\x73\x74\x64\x31\x34\x30\x2C\x63\x6F\x6C\x75\x6D\x6E\x5F\x6D\x61\x6A\x6F\x72\x29\x20\x75\x6E\x69\x66\x6F\x72\x6D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x4D\x61\x74\x65\x72\x69\x61\x6C\x20\x7B\x0A\x76\x65\x63\x32\x20\x4A\x69\x32\x33\x4B\x7A\x4D\x64\x3B\x0A\x76\x65\x63\x32\x20\x57\x72\x35\x69\x38\x52\x33\x53\x3B\x0A\x76\x65\x63\x32\x20\x71\x34\x41\x35\x44\x69\x79\x38\x3B\x0A\x76\x65\x63\x32\x20\x45\x7A\x34\x67\x36\x50\x48\x63\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x66\x32\x54\x48\x77\x38\x73\x35\x3B\x0A\x76\x65\x63\x32\x20\x78\x34\x53\x36\x4C\x6A\x74\x32\x3B\x0A\x76\x65\x63\x33\x20\x48\x65\x39\x63\x34\x58\x32\x4D\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6A\x32\x4E\x34\x44\x66\x4B\x70\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x7A\x39\x45\x38\x44\x72\x65\x33\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x6F\x39\x45\x44\x74\x38\x37\x48\x3B\x0A\x6D\x61\x74\x34\x20\x58\x6F\x38\x71\x34\x41\x32\x52\x3B\x0A\x6D\x61\x74\x34\x20\x4C\x6A\x37\x71\x38\x48\x32\x4B\x3B\x0A\x6D\x61\x74\x34\x20\x66\x38\x45\x32\x57\x78\x63\x33\x3B\x0A\x6D\x61\x74\x34\x20\x74\x33\x47\x51\x6E\x34\x6D\x38\x3B\x0A\x6D\x61\x74\x34\x20\x44\x79\x38\x34\x42\x72\x77\x36\x3B\x0A\x6D\x61\x74\x34\x20\x45\x6D\x39\x34\x5A\x78\x73\x37\x3B\x0A\x76\x65\x63\x34\x20\x4C\x6B\x38\x78\x35\x54\x33\x47\x3B\x0A\x76\x65\x63\x33\x20\x72\x38\x54\x4C\x61\x33\x74\x35\x3B\x0A\x76\x65\x63\x33\x20\x62\x36\x42\x39\x57\x6A\x66\x32\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x47\x72\x32\x70\x33\x53\x34\x54\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x69\x35\x4C\x45\x70\x33\x65\x38\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x42\x74\x35\x32\x5A\x6E\x78\x38\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x7A\x39\x4C\x47\x71\x33\x35\x50\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x58\x6D\x38\x36\x42\x79\x65\x37\x3B\x0A\x66\x6C\x6F\x61\x74\x20\x47\x65\x36\x39\x50\x69\x72\x37\x3B\x0A\x76\x65\x63\x33\x20\x45\x77\x34\x36\x4B\x65\x73\x33\x3B\x0A\x76\x65\x63\x32\x20\x62\x34\x4D\x33\x48\x63\x53\x69\x3B\x0A\x76\x65\x63\x32\x20\x47\x6B\x39\x37\x57\x71\x64\x35\x3B\x0A\x76\x65\x63\x33\x20\x6E\x35\x4A\x38\x41\x66\x79\x32\x3B\x0A\x76\x65\x63\x33\x20\x4C\x72\x34\x35\x4A\x62\x45\x69\x3B\x0A\x76\x65\x63\x33\x20\x63\x39\x46\x34\x58\x6D\x44\x69\x3B\x0A\x76\x65\x63\x34\x20\x4A\x69\x36\x78\x38\x4B\x59\x7A\x3B\x0A\x76\x65\x63\x33\x20\x57\x71\x36\x74\x34\x44\x42\x65\x3B\x0A\x76\x65\x63\x33\x20\x67\x38\x47\x32\x57\x66\x63\x34\x3B\x0A\x6D\x61\x74\x34\x20\x7A\x39\x43\x38\x42\x73\x6E\x33\x3B\x0A\x7D\x3B\x0A\x75\x6E\x69\x66\x6F\x72\x6D\x20\x53\x63\x65\x6E\x65\x20\x7B\x0A\x6D\x61\x74\x34\x20\x76\x69\x65\x77\x50\x72\x6F\x6A\x65\x63\x74\x69\x6F\x6E\x3B\x0A\x6D\x61\x74\x34\x20\x76\x69\x65\x77\x3B\x0A\x7D\x3B"];var extendStatics=function(_0xe494x2,_0xe494x3){extendStatics=Object[_0xc101[0]]||{__proto__:[]}instanceof Array&&function(_0xe494x2,_0xe494x3){_0xe494x2[_0xc101[1]]=_0xe494x3;}||function(_0xe494x2,_0xe494x3){for(var _0xe494x4 in _0xe494x3){if(_0xe494x3[_0xc101[2]](_0xe494x4)){_0xe494x2[_0xe494x4]=_0xe494x3[_0xe494x4];}}};return extendStatics(_0xe494x2,_0xe494x3);};function __extends(_0xe494x2,_0xe494x3){extendStatics(_0xe494x2,_0xe494x3);function _0xe494x6(){this[_0xc101[3]]=_0xe494x2;}_0xe494x2[_0xc101[4]]=_0xe494x3===null?Object[_0xc101[5]](_0xe494x3):(_0xe494x6[_0xc101[4]]=_0xe494x3[_0xc101[4]],new _0xe494x6());}function __decorate(_0xe494x8,_0xe494x9,_0xe494xa,_0xe494xb){var _0xe494xc=arguments[_0xc101[6]],_0xe494xd=_0xe494xc<3?_0xe494x9:_0xe494xb===null?_0xe494xb=Object[_0xc101[7]](_0xe494x9,_0xe494xa):_0xe494xb,_0xe494x2;if(typeof Reflect===_0xc101[8]&&typeof Reflect[_0xc101[9]]===_0xc101[10]){_0xe494xd=Reflect[_0xc101[9]](_0xe494x8,_0xe494x9,_0xe494xa,_0xe494xb);}else{for(var _0xe494xe=_0xe494x8[_0xc101[6]]-1;_0xe494xe>=0;_0xe494xe--){if(_0xe494x2=_0xe494x8[_0xe494xe]){_0xe494xd=(_0xe494xc<3?_0xe494x2(_0xe494xd):_0xe494xc>3?_0xe494x2(_0xe494x9,_0xe494xa,_0xe494xd):_0xe494x2(_0xe494x9,_0xe494xa))||_0xe494xd;}}};return _0xe494xc>3&&_0xe494xd&&Object[_0xc101[11]](_0xe494x9,_0xe494xa,_0xe494xd),_0xe494xd;}var Zakeke=Zakeke||{};Zakeke[_0xc101[12]]={};Zakeke[_0xc101[12]][_0xc101[13]]=function(){Zakeke[_0xc101[12]].SetupCustomShaders();Zakeke[_0xc101[12]].DefineCustomMaterials();};Zakeke[_0xc101[12]][_0xc101[14]]=function(){if(Zakeke[_0xc101[15]]){for(var _0xe494x10 in Zakeke[_0xc101[15]]){BABYLON[_0xc101[16]][_0xc101[15]][_0xe494x10]=Zakeke[_0xc101[15]][_0xe494x10];}};if(Zakeke[_0xc101[17]]){for(var _0xe494x10 in Zakeke[_0xc101[17]]){BABYLON[_0xc101[16]][_0xc101[17]][_0xe494x10]=Zakeke[_0xc101[17]][_0xe494x10];}}};!function(_0xe494x11){_0xe494x11[_0xc101[12]][_0xc101[18]]=function(){var _0xe494x12=function(_0xe494x11){function _0xe494x12(){var _0xe494x12=_0xe494x11[_0xc101[19]](this)||this;return _0xe494x12[_0xc101[20]]=false,_0xe494x12[_0xc101[21]]=false,_0xe494x12[_0xc101[22]]=false,_0xe494x12[_0xc101[23]]=false,_0xe494x12[_0xc101[24]]=true,_0xe494x12[_0xc101[25]]=false,_0xe494x12[_0xc101[26]]=false,_0xe494x12[_0xc101[27]]=false,_0xe494x12[_0xc101[28]]=false,_0xe494x12[_0xc101[29]]=false,_0xe494x12[_0xc101[30]]=false,_0xe494x12[_0xc101[31]]=false,_0xe494x12[_0xc101[32]]=false,_0xe494x12[_0xc101[33]]=false,_0xe494x12[_0xc101[34]]=false,_0xe494x12[_0xc101[35]]=false,_0xe494x12[_0xc101[36]]=false,_0xe494x12[_0xc101[37]]=false,_0xe494x12[_0xc101[38]]=false,_0xe494x12[_0xc101[39]]=false,_0xe494x12[_0xc101[40]]=false,_0xe494x12[_0xc101[41]]=false,_0xe494x12[_0xc101[42]]=false,_0xe494x12[_0xc101[43]]=false,_0xe494x12[_0xc101[44]]=false,_0xe494x12[_0xc101[45]]=false,_0xe494x12[_0xc101[46]]=false,_0xe494x12[_0xc101[47]]=false,_0xe494x12[_0xc101[48]]=false,_0xe494x12[_0xc101[49]]=false,_0xe494x12[_0xc101[50]]=false,_0xe494x12[_0xc101[51]]=0,_0xe494x12[_0xc101[52]]=0,_0xe494x12[_0xc101[53]](),_0xe494x12;}return __extends(_0xe494x12,_0xe494x11),_0xe494x12;}(BABYLON.MaterialDefines),_0xe494x13=function(_0xe494x13){function _0xe494xe(_0xe494x12,_0xe494xe){var _0xe494xd=_0xe494x13[_0xc101[19]](this,_0xe494x12,_0xe494xe)||this;return _0xe494xd[_0xc101[54]]=new BABYLON.Color3(1,1,1),_0xe494xd[_0xc101[55]]=new BABYLON.Color3(1,1,1),_0xe494xd[_0xc101[56]]=new BABYLON.Color3(0,0,0),_0xe494xd[_0xc101[57]]=50,_0xe494xd[_0xc101[58]]=0.6,_0xe494xd[_0xc101[59]]=0.5,_0xe494xd[_0xc101[60]]=0,_0xe494xd[_0xc101[61]]=1,_0xe494xd[_0xc101[62]]=new BABYLON.Color3(1,1,1),_0xe494xd[_0xc101[63]]=0,_0xe494xd[_0xc101[64]]=0.5,_0xe494xd[_0xc101[65]]=0,_0xe494xd[_0xc101[66]]=1,_0xe494xd[_0xc101[67]]=1,_0xe494xd[_0xc101[68]]=false,_0xe494xd[_0xc101[69]]=false,_0xe494xd[_0xc101[70]]=false,_0xe494xd[_0xc101[71]]=false,_0xe494xd[_0xc101[72]]=4,_0xe494xd[_0xc101[73]]=new BABYLON.SmartArray(16),_0xe494xd[_0xc101[74]]=new BABYLON.Vector3(0.3,0.59,0.11),_0xe494xd[_0xc101[75]]=new BABYLON.Vector3(0.2125,0.7154,0.0721),_0xe494xd[_0xc101[76]]=new BABYLON.Matrix(0.3,0.59,0.11,0.4,0.2125,0.7154,0.0721,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,0.0),_0xe494xd;}return __extends(_0xe494xe,_0xe494x13),Object[_0xc101[11]](_0xe494xe[_0xc101[4]],_0xc101[77],{get:function(){return this[_0xc101[68]];},set:function(_0xe494x14){this[_0xc101[68]]!==_0xe494x14&&(this[_0xc101[68]]=_0xe494x14,this[_0xc101[79]][_0xc101[78]](this),this[_0xc101[80]][_0xc101[78]](this));},enumerable:true,configurable:true}),Object[_0xc101[11]](_0xe494xe[_0xc101[4]],_0xc101[81],{get:function(){return this[_0xc101[68]];},set:function(_0xe494x14){this[_0xc101[68]]!==_0xe494x14&&(this[_0xc101[68]]=_0xe494x14,this[_0xc101[79]][_0xc101[78]](this),this[_0xc101[80]][_0xc101[78]](this));},enumerable:true,configurable:true}),_0xe494xe[_0xc101[4]][_0xc101[82]]=function(){return this[_0xc101[83]]&&this[_0xc101[83]][_0xc101[84]]&&this[_0xc101[70]];},_0xe494xe[_0xc101[4]][_0xc101[85]]=function(_0xe494x11,_0xe494x12){_0xe494x11[_0xc101[86]]||(_0xe494x11[_0xc101[86]]=new BABYLON.UniformBuffer(_0xe494x12[_0xc101[87]]())),_0xe494x11[_0xc101[86]][_0xc101[89]](_0xc101[88],3),_0xe494x11[_0xc101[86]][_0xc101[89]](_0xc101[90],3),_0xe494x11[_0xc101[86]][_0xc101[89]](_0xc101[91],3),_0xe494x11[_0xc101[86]][_0xc101[5]]();},_0xe494xe[_0xc101[4]][_0xc101[92]]=function(_0xe494x12,_0xe494x13,_0xe494xe,_0xe494x15){void 0===_0xe494x15&&(_0xe494x15=4);for(var _0xe494xd=0,_0xe494x16=false,_0xe494x17=false,_0xe494x18=false,_0xe494xc=0,_0xe494x19=_0xe494x13[_0xc101[93]];_0xe494xc<_0xe494x19[_0xc101[6]];_0xe494xc++){var _0xe494x2=_0xe494x19[_0xe494xc];if(!(void 0===_0xe494xe[_0xc101[94]+_0xe494xd]&&(_0xe494x16=true),_0xe494x2[_0xc101[95]]()>1)){switch(_0xe494x17=true,_0xe494xe[_0xc101[94]+_0xe494xd]=true,_0xe494xe[_0xc101[96]+_0xe494xd]=false,_0xe494xe[_0xc101[97]+_0xe494xd]=false,_0xe494x2[_0xc101[95]]()){case 0:_0xe494xe[_0xc101[96]+_0xe494xd]=true;break;case 1:_0xe494xe[_0xc101[97]+_0xe494xd]=true;break;default:};if(_0xe494xe[_0xc101[98]+_0xe494xd]=false,_0xe494xe[_0xc101[99]+_0xe494xd]=false,_0xe494xe[_0xc101[100]+_0xe494xd]=false,_0xe494xe[_0xc101[101]+_0xe494xd]=false,_0xe494xe[_0xc101[102]+_0xe494xd]=false,_0xe494xe[_0xc101[103]+_0xe494xd]=false,_0xe494xe[_0xc101[104]+_0xe494xd]=false,_0xe494x13&&_0xe494x13[_0xc101[105]]&&_0xe494x12[_0xc101[106]]&&_0xe494x2[_0xc101[107]]){var _0xe494x1a=_0xe494x2[_0xc101[108]]();if(_0xe494x1a){if(_0xe494x2 instanceof BABYLON[_0xc101[109]]){var _0xe494x1b=_0xe494x12[_0xc101[87]]()[_0xc101[110]]();_0xe494xe[_0xc101[98]+_0xe494xd]=true,_0xe494xe[_0xc101[102]+_0xe494xd]=!(!_0xe494x1b[_0xc101[111]]||!_0xe494x1b[_0xc101[112]])||!(!_0xe494x1b[_0xc101[113]]||!_0xe494x1b[_0xc101[114]]),_0xe494x18=true;}}};if(this._buildLightUniformLayout(_0xe494x2,_0xe494x12),_0xe494xd++,_0xe494xd===_0xe494x15){break;}}};_0xe494xe[_0xc101[20]]=_0xe494x17,_0xe494xe[_0xc101[21]]=_0xe494x18;for(var _0xe494x4=_0xe494xd;_0xe494x15>_0xe494x4;_0xe494x4++){void 0!==_0xe494xe[_0xc101[94]+_0xe494x4]&&(_0xe494xe[_0xc101[94]+_0xe494x4]=false);};_0xe494x16&&_0xe494xe[_0xc101[53]]();},_0xe494xe[_0xc101[4]][_0xc101[115]]=function(_0xe494x11,_0xe494x12,_0xe494x13,_0xe494xe,_0xe494x15){void 0===_0xe494x15&&(_0xe494x15=4);for(var _0xe494xd=0;_0xe494x15>_0xe494xd&&_0xe494xe[_0xc101[94]+_0xe494xd];_0xe494xd++){_0xe494x11[_0xc101[125]](_0xc101[88]+_0xe494xd,_0xc101[90]+_0xe494xd,_0xc101[91]+_0xe494xd,_0xc101[116]+_0xe494xd,_0xc101[117]+_0xe494xd,_0xc101[118]+_0xe494xd,_0xc101[119]+_0xe494xd,_0xc101[120]+_0xe494xd,_0xc101[121]+_0xe494xd,_0xc101[122]+_0xe494xd,_0xc101[123]+_0xe494xd,_0xc101[124]+_0xe494xd),_0xe494x12&&_0xe494x12[_0xc101[125]](_0xc101[126]+_0xe494xd),_0xe494x13[_0xc101[125]](_0xc101[127]+_0xe494xd),_0xe494x13[_0xc101[125]](_0xc101[128]+_0xe494xd),_0xe494x13[_0xc101[125]](_0xc101[129]+_0xe494xd);}},_0xe494xe[_0xc101[4]][_0xc101[130]]=function(_0xe494x12,_0xe494x13,_0xe494xe,_0xe494x15,_0xe494xd){if(_0xe494xe[_0xc101[105]]&&_0xe494x12[_0xc101[107]]){var _0xe494x16=_0xe494x12[_0xc101[108]]();_0xe494x16&&(_0xe494x12 instanceof BABYLON[_0xc101[109]]?(_0xe494xd[_0xc101[132]](_0xc101[124]+_0xe494x15,_0xe494x16[_0xc101[131]]()),_0xe494xd[_0xc101[134]](_0xc101[127]+_0xe494x15,_0xe494x16[_0xc101[133]]())):Logger[_0xc101[136]](_0xc101[135]));}},_0xe494xe[_0xc101[4]][_0xc101[137]]=function(_0xe494x12,_0xe494x13,_0xe494xe){_0xe494x12 instanceof BABYLON[_0xc101[138]]?_0xe494x12[_0xc101[139]]()?_0xe494x12[_0xc101[86]][_0xc101[144]](_0xc101[88],_0xe494x12[_0xc101[141]][_0xc101[140]],_0xe494x12[_0xc101[141]][_0xc101[142]],_0xe494x12[_0xc101[141]][_0xc101[143]],_0xe494xe):_0xe494x12[_0xc101[86]][_0xc101[144]](_0xc101[88],_0xe494x12[_0xc101[145]][_0xc101[140]],_0xe494x12[_0xc101[145]][_0xc101[142]],_0xe494x12[_0xc101[145]][_0xc101[143]],_0xe494xe):_0xe494x12 instanceof BABYLON[_0xc101[109]]?_0xe494x12[_0xc101[139]]()?_0xe494x12[_0xc101[86]][_0xc101[144]](_0xc101[88],_0xe494x12[_0xc101[146]][_0xc101[140]],_0xe494x12[_0xc101[146]][_0xc101[142]],_0xe494x12[_0xc101[146]][_0xc101[143]],_0xe494xe):_0xe494x12[_0xc101[86]][_0xc101[144]](_0xc101[88],_0xe494x12[_0xc101[147]][_0xc101[140]],_0xe494x12[_0xc101[147]][_0xc101[142]],_0xe494x12[_0xc101[147]][_0xc101[143]],_0xe494xe):Logger[_0xc101[136]](_0xc101[148]);},_0xe494xe[_0xc101[4]][_0xc101[149]]=function(_0xe494x11,_0xe494x12,_0xe494x13,_0xe494xe,_0xe494x15){void 0===_0xe494xe&&(_0xe494xe=4);for(var _0xe494xd=0,_0xe494x16=0,_0xe494x17=_0xe494x12[_0xc101[93]];_0xe494x16<_0xe494x17[_0xc101[6]];_0xe494x16++){var _0xe494x18=_0xe494x17[_0xe494x16];if(!(_0xe494x18[_0xc101[95]]()>1)&&(_0xe494x18[_0xc101[86]][_0xc101[150]](_0xe494x13,_0xc101[126]+_0xe494xd),this._bindLightProperties(_0xe494x18,_0xe494x13,_0xe494xd),_0xe494x18[_0xc101[155]][_0xc101[154]](_0xe494x18[_0xc101[151]],BABYLON[_0xc101[153]][_0xc101[152]][0]),_0xe494x18[_0xc101[86]][_0xc101[156]](_0xc101[90],BABYLON[_0xc101[153]][_0xc101[152]][0],_0xe494xd+_0xc101[135]),_0xe494x18[_0xc101[157]][_0xc101[154]](_0xe494x18[_0xc101[151]],BABYLON[_0xc101[153]][_0xc101[152]][1]),_0xe494x18[_0xc101[86]][_0xc101[156]](_0xc101[91],BABYLON[_0xc101[153]][_0xc101[152]][1],_0xe494xd+_0xc101[135]),_0xe494x15[_0xc101[21]]&&_0xe494x15[_0xc101[98]+_0xe494xd]&&this._bindLightShadow(_0xe494x18,_0xe494x11,_0xe494x12,_0xe494xd+_0xc101[135],_0xe494x13),_0xe494x18[_0xc101[86]][_0xc101[158]](),_0xe494xd++,_0xe494xd===_0xe494xe)){break;}}},_0xe494xe[_0xc101[4]][_0xc101[159]]=function(){},_0xe494xe[_0xc101[4]][_0xc101[160]]=function(){return _0xc101[161];},_0xe494xe[_0xc101[4]][_0xc101[162]]=function(){return this[_0xc101[73]][_0xc101[163]](),this[_0xc101[164]]&&this[_0xc101[164]][_0xc101[165]]&&this[_0xc101[73]][_0xc101[125]](this._reflectionTexture),this[_0xc101[73]];},_0xe494xe[_0xc101[4]][_0xc101[166]]=function(){return this[_0xc101[167]]<1||this[_0xc101[168]]||this._shouldUseAlphaFromAlbedoTexture()||this[_0xc101[169]]&&this[_0xc101[169]][_0xc101[170]];},_0xe494xe[_0xc101[4]][_0xc101[171]]=function(){return this[_0xc101[83]]&&this[_0xc101[83]][_0xc101[84]];},_0xe494xe[_0xc101[4]][_0xc101[172]]=function(){return this[_0xc101[83]];},_0xe494xe[_0xc101[4]][_0xc101[173]]=function(_0xe494x13,_0xe494xe,_0xe494x15){if(this[_0xc101[174]]&&this[_0xc101[175]]&&_0xe494xe[_0xc101[176]]){return true;};_0xe494xe[_0xc101[177]]?_0xe494xe[_0xc101[177]]instanceof _0xe494x12||(Logger[_0xc101[136]](_0xc101[135]),_0xe494xe[_0xc101[177]]=new _0xe494x12()):_0xe494xe[_0xc101[177]]=new _0xe494x12();var _0xe494xd=this[_0xc101[178]](),_0xe494x16=_0xe494xe[_0xc101[177]],_0xe494x17=_0xe494xd[_0xc101[87]]();if(!this[_0xc101[179]]&&_0xe494xe[_0xc101[176]]&&_0xe494x16[_0xc101[180]]===_0xe494xd[_0xc101[181]]()){return true;};if(_0xe494x16[_0xc101[182]]){if(!_0xe494xd[_0xc101[183]]||this[_0xc101[71]]||this[_0xc101[68]]){_0xe494x16[_0xc101[20]]=false,_0xe494x16[_0xc101[21]]=false;for(var _0xe494x18=0;_0xe494x18<this[_0xc101[72]];_0xe494x18++){void 0!==_0xe494x16[_0xc101[94]+_0xe494x18]&&(_0xe494x16[_0xc101[94]+_0xe494x18]=false);}}else{_0xe494x16[_0xc101[184]]=true,this._prepareDefinesForLights(_0xe494xd,_0xe494x13,_0xe494x16,this._maxSimultaneousLights);}};if(_0xe494x16[_0xc101[185]]){if(_0xe494x16[_0xc101[186]]=false,_0xe494xd[_0xc101[187]]){if(_0xe494x16[_0xc101[26]]=_0xe494x17[_0xc101[110]]()[_0xc101[188]]?true:false,this[_0xc101[83]]){if(!this[_0xc101[83]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[27]]=true;}else{_0xe494x16[_0xc101[27]]=false;};if(_0xe494x17[_0xc101[110]]()[_0xc101[190]]&&this[_0xc101[191]]){if(!this[_0xc101[191]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[184]]=true,_0xe494x16[_0xc101[28]]=true;}else{_0xe494x16[_0xc101[28]]=false;};if(this[_0xc101[192]]&&this[_0xc101[59]]){if(!this[_0xc101[192]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[29]]=true;}else{_0xe494x16[_0xc101[29]]=false;};if(this[_0xc101[193]]&&this[_0xc101[60]]){if(!this[_0xc101[193]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[30]]=true;}else{_0xe494x16[_0xc101[30]]=false;};if(this[_0xc101[164]]&&!this[_0xc101[68]]&&this[_0xc101[59]]){if(!this[_0xc101[164]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[184]]=true,_0xe494x16[_0xc101[31]]=true,_0xe494x16[_0xc101[32]]=this[_0xc101[194]]&&this[_0xc101[195]]&&this[_0xc101[196]];}else{_0xe494x16[_0xc101[31]]=false,_0xe494x16[_0xc101[32]]=false;};if(this[_0xc101[168]]){if(!this[_0xc101[168]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[33]]=true,_0xe494x16[_0xc101[34]]=this[_0xc101[168]][_0xc101[197]];}else{_0xe494x16[_0xc101[33]]=false,_0xe494x16[_0xc101[34]]=false;};if(this[_0xc101[198]]&&this[_0xc101[61]]){if(!this[_0xc101[198]][_0xc101[189]]()){return false;};this[_0xc101[69]]?(_0xe494x16[_0xc101[186]]=true,_0xe494x16[_0xc101[35]]=true,_0xe494x16[_0xc101[37]]=false,_0xe494x16[_0xc101[36]]=!!(this[_0xc101[65]]&&this[_0xc101[65]]-1)):(_0xe494x16[_0xc101[37]]=true,_0xe494x16[_0xc101[35]]=false,_0xe494x16[_0xc101[36]]=false);}else{_0xe494x16[_0xc101[35]]=false,_0xe494x16[_0xc101[37]]=false,_0xe494x16[_0xc101[36]]=false;};if(this[_0xc101[68]]){if(_0xe494x16[_0xc101[38]]=true,_0xe494x16[_0xc101[184]]=true,this[_0xc101[199]]){if(!this[_0xc101[199]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[39]]=true;}else{_0xe494x16[_0xc101[39]]=false;};if(this[_0xc101[200]]){if(!this[_0xc101[200]][_0xc101[189]]()){return false;};_0xe494x16[_0xc101[40]]=true;}else{_0xe494x16[_0xc101[40]]=false;}}else{_0xe494x16[_0xc101[38]]=false,_0xe494x16[_0xc101[39]]=false,_0xe494x16[_0xc101[40]]=false;};_0xe494x16[_0xc101[41]]=this._shouldUseAlphaFromAlbedoTexture(),_0xe494x16[_0xc101[42]]=!this[_0xc101[201]];}else{_0xe494x16[_0xc101[26]]=false,_0xe494x16[_0xc101[27]]=false,_0xe494x16[_0xc101[28]]=false,_0xe494x16[_0xc101[29]]=false,_0xe494x16[_0xc101[30]]=false,_0xe494x16[_0xc101[31]]=false,_0xe494x16[_0xc101[32]]=false,_0xe494x16[_0xc101[33]]=false,_0xe494x16[_0xc101[34]]=false,_0xe494x16[_0xc101[35]]=false,_0xe494x16[_0xc101[37]]=false,_0xe494x16[_0xc101[36]]=false,_0xe494x16[_0xc101[38]]=false,_0xe494x16[_0xc101[39]]=false,_0xe494x16[_0xc101[40]]=false,_0xe494x16[_0xc101[41]]=false,_0xe494x16[_0xc101[42]]=false;}};if(_0xe494x16[_0xc101[202]]&&(this[_0xc101[169]]&&this[_0xc101[169]][_0xc101[170]]?(_0xe494x16[_0xc101[184]]=true,_0xe494x16[_0xc101[43]]=true):_0xe494x16[_0xc101[43]]=false),_0xe494x16[_0xc101[203]]&&(this[_0xc101[63]]?(_0xe494x16[_0xc101[44]]=true,_0xe494x16[_0xc101[184]]=true):_0xe494x16[_0xc101[44]]=false,_0xe494x16[_0xc101[45]]=1!==this[_0xc101[66]]||1!==this[_0xc101[67]]),(_0xe494x16[_0xc101[204]]||_0xe494x16[_0xc101[184]]===_0xe494x16[_0xc101[205]]||_0xe494x16[_0xc101[186]]===_0xe494x16[_0xc101[206]])&&(_0xe494x16[_0xc101[205]]=_0xe494x16[_0xc101[184]],_0xe494x16[_0xc101[206]]=_0xe494x16[_0xc101[186]],_0xe494x16[_0xc101[184]]?(_0xe494x16[_0xc101[48]]=_0xe494x13[_0xc101[208]](BABYLON[_0xc101[207]].NormalKind))||(Logger[_0xc101[136]](_0xc101[135]),_0xe494x16[_0xc101[28]]=false,_0xe494x16[_0xc101[31]]=false,_0xe494x16[_0xc101[32]]=false,_0xe494x16[_0xc101[38]]=false,_0xe494x16[_0xc101[39]]=false,_0xe494x16[_0xc101[43]]=false,_0xe494x16[_0xc101[44]]=false,_0xe494x16[_0xc101[20]]=false,_0xe494x16[_0xc101[21]]=false):_0xe494x16[_0xc101[48]]=false,_0xe494x16[_0xc101[186]]?(_0xe494x16[_0xc101[49]]=_0xe494x13[_0xc101[208]](BABYLON[_0xc101[207]].UVKind),_0xe494x16[_0xc101[50]]=_0xe494x13[_0xc101[208]](BABYLON[_0xc101[207]].UV2Kind)):(_0xe494x16[_0xc101[49]]=false,_0xe494x16[_0xc101[50]]=false),_0xe494x13[_0xc101[209]]&&_0xe494x13[_0xc101[210]]?(_0xe494x16[_0xc101[51]]=_0xe494x13[_0xc101[211]],_0xe494x16[_0xc101[52]]=_0xe494x13[_0xc101[213]][_0xc101[212]][_0xc101[6]]+1):(_0xe494x16[_0xc101[51]]=0,_0xe494x16[_0xc101[52]]=0)),_0xe494x16[_0xc101[46]]!==false&&(_0xe494x16[_0xc101[46]]=!_0xe494x16[_0xc101[46]],_0xe494x16[_0xc101[214]]()),_0xe494x16[_0xc101[47]]!==_0xe494x15&&(_0xe494x16[_0xc101[47]]=_0xe494x15,_0xe494x16[_0xc101[214]]()),_0xe494x16[_0xc101[215]]){_0xe494x16[_0xc101[216]](),_0xe494xd[_0xc101[217]]();var _0xe494xc=new BABYLON[_0xc101[218]]();BABYLON[_0xc101[219]].HandleFallbacksForShadows(_0xe494x16,_0xe494xc,this._maxSimultaneousLights);var _0xe494x19=[BABYLON[_0xc101[207]][_0xc101[220]]];_0xe494x16[_0xc101[48]]&&_0xe494x19[_0xc101[125]](BABYLON[_0xc101[207]].NormalKind),_0xe494x16[_0xc101[49]]&&_0xe494x19[_0xc101[125]](BABYLON[_0xc101[207]].UVKind),_0xe494x16[_0xc101[50]]&&_0xe494x19[_0xc101[125]](BABYLON[_0xc101[207]].UV2Kind),BABYLON[_0xc101[219]].PrepareAttributesForBones(_0xe494x19,_0xe494x13,_0xe494x16,_0xe494xc),BABYLON[_0xc101[219]].PrepareAttributesForInstances(_0xe494x19,_0xe494x16);var _0xe494x2=_0xc101[221],_0xe494x1a=_0xe494x16.toString();if(_0xe494xe[_0xc101[222]]!==_0xe494x1a+this[_0xc101[223]]||!_0xe494xe[_0xc101[176]]){_0xe494xe[_0xc101[222]]=_0xe494x1a+this[_0xc101[223]];var _0xe494x1b=[_0xc101[224],_0xc101[225],_0xc101[226],_0xc101[227],_0xc101[228],_0xc101[229],_0xc101[230],_0xc101[231],_0xc101[232],_0xc101[233],_0xc101[234],_0xc101[235],_0xc101[236],_0xc101[237],_0xc101[238],_0xc101[239],_0xc101[240],_0xc101[241],_0xc101[242],_0xc101[243],_0xc101[244],_0xc101[245],_0xc101[246],_0xc101[247],_0xc101[248],_0xc101[249],_0xc101[250],_0xc101[251],_0xc101[252],_0xc101[253],_0xc101[254],_0xc101[255],_0xc101[256],_0xc101[257],_0xc101[258],_0xc101[259],_0xc101[260],_0xc101[261],_0xc101[262],_0xc101[263]],_0xe494x4=[_0xc101[264],_0xc101[265],_0xc101[266],_0xc101[267],_0xc101[268],_0xc101[269],_0xc101[270],_0xc101[271],_0xc101[272]],_0xe494x1c=[_0xc101[273],_0xc101[274]];this._prepareUniformsAndSamplersList(_0xe494x1b,_0xe494x1c,_0xe494x4,_0xe494x16,this._maxSimultaneousLights),_0xe494xe[_0xc101[278]](_0xe494xd[_0xc101[87]]()[_0xc101[277]](_0xe494x2,{attributes:_0xe494x19,uniformsNames:_0xe494x1b,uniformBuffersNames:_0xe494x1c,samplers:_0xe494x4,defines:_0xe494x1a,fallbacks:_0xe494xc,onCompiled:this[_0xc101[275]],onError:this[_0xc101[276]],indexParameters:{maxSimultaneousLights:this[_0xc101[72]]}},_0xe494x17),_0xe494x16),this[_0xc101[279]]();}};return _0xe494xe[_0xc101[176]][_0xc101[280]]()?(_0xe494x16[_0xc101[180]]=_0xe494xd[_0xc101[181]](),this[_0xc101[175]]=true,true):false;},_0xe494xe[_0xc101[4]][_0xc101[279]]=function(){this[_0xc101[281]][_0xc101[89]](_0xc101[229],2),this[_0xc101[281]][_0xc101[89]](_0xc101[231],2),this[_0xc101[281]][_0xc101[89]](_0xc101[234],2),this[_0xc101[281]][_0xc101[89]](_0xc101[237],2),this[_0xc101[281]][_0xc101[89]](_0xc101[240],1),this[_0xc101[281]][_0xc101[89]](_0xc101[244],2),this[_0xc101[281]][_0xc101[89]](_0xc101[247],3),this[_0xc101[281]][_0xc101[89]](_0xc101[249],1),this[_0xc101[281]][_0xc101[89]](_0xc101[250],1),this[_0xc101[281]][_0xc101[89]](_0xc101[251],1),this[_0xc101[281]][_0xc101[89]](_0xc101[230],16),this[_0xc101[281]][_0xc101[89]](_0xc101[232],16),this[_0xc101[281]][_0xc101[89]](_0xc101[235],16),this[_0xc101[281]][_0xc101[89]](_0xc101[238],16),this[_0xc101[281]][_0xc101[89]](_0xc101[245],16),this[_0xc101[281]][_0xc101[89]](_0xc101[248],16),this[_0xc101[281]][_0xc101[89]](_0xc101[228],4),this[_0xc101[281]][_0xc101[89]](_0xc101[239],3),this[_0xc101[281]][_0xc101[89]](_0xc101[258],3),this[_0xc101[281]][_0xc101[89]](_0xc101[233],1),this[_0xc101[281]][_0xc101[89]](_0xc101[236],1),this[_0xc101[281]][_0xc101[89]](_0xc101[255],1),this[_0xc101[281]][_0xc101[89]](_0xc101[256],1),this[_0xc101[281]][_0xc101[89]](_0xc101[246],1),this[_0xc101[281]][_0xc101[89]](_0xc101[259],1),this[_0xc101[281]][_0xc101[89]](_0xc101[252],3),this[_0xc101[281]][_0xc101[89]](_0xc101[253],2),this[_0xc101[281]][_0xc101[89]](_0xc101[254],2),this[_0xc101[281]][_0xc101[89]](_0xc101[241],3),this[_0xc101[281]][_0xc101[89]](_0xc101[242],3),this[_0xc101[281]][_0xc101[89]](_0xc101[243],3),this[_0xc101[281]][_0xc101[89]](_0xc101[257],4),this[_0xc101[281]][_0xc101[89]](_0xc101[261],3),this[_0xc101[281]][_0xc101[89]](_0xc101[262],3),this[_0xc101[281]][_0xc101[89]](_0xc101[263],16),this[_0xc101[281]][_0xc101[5]]();},_0xe494xe[_0xc101[4]][_0xc101[282]]=function(){this[_0xc101[283]]&&this[_0xc101[164]]&&this[_0xc101[164]][_0xc101[165]]&&this[_0xc101[283]][_0xc101[134]](_0xc101[269],null),_0xe494x13[_0xc101[4]][_0xc101[282]][_0xc101[19]](this);},_0xe494xe[_0xc101[4]][_0xc101[284]]=function(_0xe494x11,_0xe494x12,_0xe494x13){var _0xe494xe=this[_0xc101[178]](),_0xe494x15=_0xe494x13[_0xc101[176]],_0xe494xd=_0xe494x13[_0xc101[177]];_0xe494xd&&(this[_0xc101[283]]=_0xe494x15,this[_0xc101[285]](_0xe494x11),BABYLON[_0xc101[219]].BindBonesParameters(_0xe494x12,_0xe494x15),this._mustRebind(_0xe494xe,_0xe494x15,_0xe494x12[_0xc101[286]])&&(this[_0xc101[281]][_0xc101[150]](_0xe494x15,_0xc101[273]),this[_0xc101[287]](_0xe494x15),this[_0xc101[281]][_0xc101[288]]&&this[_0xc101[174]]&&this[_0xc101[281]][_0xc101[289]]||(_0xe494xd[_0xc101[43]]&&this[_0xc101[281]][_0xc101[295]](_0xc101[257],new BABYLON.Color3(this[_0xc101[169]][_0xc101[291]][_0xc101[290]](),this[_0xc101[169]][_0xc101[292]][_0xc101[290]](),this[_0xc101[169]][_0xc101[293]]),this[_0xc101[169]][_0xc101[294]]),_0xe494xe[_0xc101[187]]&&(_0xe494xd[_0xc101[27]]&&(this[_0xc101[281]][_0xc101[298]](_0xc101[229],this[_0xc101[83]][_0xc101[296]],this[_0xc101[83]][_0xc101[297]]),this[_0xc101[281]][_0xc101[300]](_0xc101[230],this[_0xc101[83]][_0xc101[299]]())),_0xe494xd[_0xc101[28]]&&(this[_0xc101[281]][_0xc101[298]](_0xc101[231],this[_0xc101[191]][_0xc101[296]],1/this[_0xc101[191]][_0xc101[297]]),this[_0xc101[281]][_0xc101[300]](_0xc101[232],this[_0xc101[191]][_0xc101[299]]())),_0xe494xd[_0xc101[29]]&&(this[_0xc101[281]][_0xc101[298]](_0xc101[234],this[_0xc101[192]][_0xc101[296]],this[_0xc101[192]][_0xc101[297]]),this[_0xc101[281]][_0xc101[300]](_0xc101[235],this[_0xc101[192]][_0xc101[299]]())),_0xe494xd[_0xc101[30]]&&(this[_0xc101[281]][_0xc101[298]](_0xc101[237],this[_0xc101[193]][_0xc101[296]],this[_0xc101[193]][_0xc101[297]]),this[_0xc101[281]][_0xc101[300]](_0xc101[238],this[_0xc101[193]][_0xc101[299]]())),_0xe494xd[_0xc101[31]]&&(this[_0xc101[281]][_0xc101[301]](_0xc101[240],this[_0xc101[164]][_0xc101[297]]),this[_0xc101[281]][_0xc101[301]](_0xc101[259],Math[_0xc101[306]](Math[_0xc101[304]](this[_0xc101[164]][_0xc101[303]]()[_0xc101[302]])*Math[_0xc101[305]])),_0xe494xd[_0xc101[32]]&&(this[_0xc101[281]][_0xc101[307]](_0xc101[241],this._parallaxReflectionCenter),this[_0xc101[281]][_0xc101[307]](_0xc101[242],this._parallaxReflectionBBoxMin),this[_0xc101[281]][_0xc101[307]](_0xc101[243],this._parallaxReflectionBBoxMax))),_0xe494xd[_0xc101[33]]&&(this[_0xc101[281]][_0xc101[298]](_0xc101[244],this[_0xc101[168]][_0xc101[296]],this[_0xc101[168]][_0xc101[297]]),this[_0xc101[281]][_0xc101[300]](_0xc101[245],this[_0xc101[168]][_0xc101[299]]())),_0xe494xd[_0xc101[35]]?(this[_0xc101[281]][_0xc101[144]](_0xc101[247],this[_0xc101[198]][_0xc101[296]],this[_0xc101[198]][_0xc101[297]],this._aoPower),this[_0xc101[281]][_0xc101[300]](_0xc101[248],this[_0xc101[198]][_0xc101[299]]()),_0xe494xd[_0xc101[36]]&&this[_0xc101[281]][_0xc101[301]](_0xc101[246],1-this[_0xc101[65]])):_0xe494xd[_0xc101[37]]&&this[_0xc101[281]][_0xc101[301]](_0xc101[249],this._aoPower),_0xe494xd[_0xc101[39]]&&this[_0xc101[281]][_0xc101[301]](_0xc101[250],this[_0xc101[199]][_0xc101[297]]),_0xe494xd[_0xc101[40]]&&(this[_0xc101[281]][_0xc101[301]](_0xc101[251],this[_0xc101[200]][_0xc101[297]]),this[_0xc101[281]][_0xc101[301]](_0xc101[259],Math[_0xc101[306]](Math[_0xc101[304]](this[_0xc101[200]][_0xc101[303]]()[_0xc101[302]])*Math[_0xc101[305]])))),_0xe494xd[_0xc101[44]]&&(this[_0xc101[281]][_0xc101[156]](_0xc101[252],this._rimColor),this[_0xc101[281]][_0xc101[298]](_0xc101[253],this._rimPower,this[_0xc101[64]]||0)),_0xe494xd[_0xc101[45]]&&this[_0xc101[281]][_0xc101[298]](_0xc101[254],this[_0xc101[66]]||1,this[_0xc101[67]]||1),this[_0xc101[281]][_0xc101[295]](_0xc101[228],this._albedoColor,this[_0xc101[167]]*_0xe494x12[_0xc101[286]]),this[_0xc101[281]][_0xc101[156]](_0xc101[239],this._reflectionColor),this[_0xc101[281]][_0xc101[156]](_0xc101[258],this._specularColor),this[_0xc101[281]][_0xc101[301]](_0xc101[233],this._reflectivity),this[_0xc101[281]][_0xc101[301]](_0xc101[236],this._microsurface),this[_0xc101[281]][_0xc101[301]](_0xc101[255],this._glossiness),this[_0xc101[281]][_0xc101[301]](_0xc101[256],this._ambientLight)),this[_0xc101[281]][_0xc101[307]](_0xc101[261],this._grayWeights),this[_0xc101[281]][_0xc101[307]](_0xc101[262],this._lumCoeff),this[_0xc101[281]][_0xc101[300]](_0xc101[263],this._renderMatrix),_0xe494xe[_0xc101[187]]&&(_0xe494xd[_0xc101[27]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[264],this._albedoTexture),_0xe494xd[_0xc101[28]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[265],this._bumpTexture),_0xe494xd[_0xc101[29]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[266],this._reflectivityTexture),_0xe494xd[_0xc101[30]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[267],this._microsurfaceTexture),_0xe494xd[_0xc101[31]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[269],this._reflectionTexture),_0xe494xd[_0xc101[33]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[271],this._opacityTexture),(_0xe494xd[_0xc101[35]]||_0xe494xd[_0xc101[37]])&&this[_0xc101[281]][_0xc101[134]](_0xc101[272],this._aoTexture),_0xe494xd[_0xc101[38]]&&(_0xe494xd[_0xc101[39]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[270],this._ambientTexture),_0xe494xd[_0xc101[40]]&&this[_0xc101[281]][_0xc101[134]](_0xc101[268],this._matCapReflectionTexture))),_0xe494x15[_0xc101[309]](_0xc101[227],_0xe494xe[_0xc101[308]][_0xc101[145]])),(this._mustRebind(_0xe494xe,_0xe494x15)||!this[_0xc101[174]])&&(_0xe494xd[_0xc101[20]]&&this._bindLights(_0xe494xe,_0xe494x12,_0xe494x15,this._maxSimultaneousLights,_0xe494xd),_0xe494xd[_0xc101[38]]&&this[_0xc101[310]](_0xe494x15)),this[_0xc101[281]][_0xc101[158]](),this._afterBind(_0xe494x12,this._activeEffect));},_0xe494xe[_0xc101[4]][_0xc101[311]]=function(_0xe494x11,_0xe494x12){_0xe494x12&&(this[_0xc101[83]]&&(this[_0xc101[83]][_0xc101[311]](),this[_0xc101[83]]=null),this[_0xc101[191]]&&(this[_0xc101[191]][_0xc101[311]](),this[_0xc101[191]]=null),this[_0xc101[192]]&&(this[_0xc101[192]][_0xc101[311]](),this[_0xc101[192]]=null),this[_0xc101[193]]&&(this[_0xc101[193]][_0xc101[311]](),this[_0xc101[193]]=null),this[_0xc101[164]]&&(this[_0xc101[164]][_0xc101[311]](),this[_0xc101[164]]=null),this[_0xc101[168]]&&(this[_0xc101[168]][_0xc101[311]](),this[_0xc101[168]]=null),this[_0xc101[198]]&&(this[_0xc101[198]][_0xc101[311]](),this[_0xc101[198]]=null),this[_0xc101[199]]&&(this[_0xc101[199]][_0xc101[311]](),this[_0xc101[199]]=null),this[_0xc101[200]]&&(this[_0xc101[200]][_0xc101[311]](),this[_0xc101[200]]=null)),_0xe494x13[_0xc101[4]][_0xc101[311]][_0xc101[19]](this,_0xe494x11,_0xe494x12);},_0xe494xe[_0xc101[4]][_0xc101[312]]=function(){var _0xe494x1d=_0xe494x13[_0xc101[4]][_0xc101[312]][_0xc101[19]](this);if(this[_0xc101[83]]){_0xe494x1d[_0xc101[125]](this._albedoTexture);};if(this[_0xc101[191]]){_0xe494x1d[_0xc101[125]](this._bumpTexture);};if(this[_0xc101[192]]){_0xe494x1d[_0xc101[125]](this._reflectivityTexture);};if(this[_0xc101[193]]){_0xe494x1d[_0xc101[125]](this._microsurfaceTexture);};if(this[_0xc101[164]]){_0xe494x1d[_0xc101[125]](this._reflectionTexture);};if(this[_0xc101[168]]){_0xe494x1d[_0xc101[125]](this._opacityTexture);};if(this[_0xc101[198]]){_0xe494x1d[_0xc101[125]](this._aoTexture);};if(this[_0xc101[199]]){_0xe494x1d[_0xc101[125]](this._ambientTexture);};if(this[_0xc101[200]]){_0xe494x1d[_0xc101[125]](this._matCapReflectionTexture);};return _0xe494x1d;},_0xe494xe[_0xc101[4]][_0xc101[313]]=function(_0xe494x1e){if(_0xe494x13[_0xc101[4]][_0xc101[313]][_0xc101[19]](this,_0xe494x1e)){return true;};if(this[_0xc101[83]]===_0xe494x1e){return true;};if(this[_0xc101[191]]===_0xe494x1e){return true;};if(this[_0xc101[192]]===_0xe494x1e){return true;};if(this[_0xc101[193]]===_0xe494x1e){return true;};if(this[_0xc101[164]]===_0xe494x1e){return true;};if(this[_0xc101[168]]===_0xe494x1e){return true;};if(this[_0xc101[198]]===_0xe494x1e){return true;};if(this[_0xc101[199]]===_0xe494x1e){return true;};if(this[_0xc101[200]]===_0xe494x1e){return true;};return false;},_0xe494xe[_0xc101[4]][_0xc101[314]]=function(_0xe494x10){var _0xe494x1f=this;var _0xe494x20=BABYLON[_0xc101[315]].Clone(function(){return new Zakeke.PBRMaterial(_0xe494x10,_0xe494x1f[_0xc101[178]]());},this);_0xe494x20[_0xc101[316]]=_0xe494x10;_0xe494x20[_0xc101[223]]=_0xe494x10;return _0xe494x20;},_0xe494xe[_0xc101[4]][_0xc101[317]]=function(_0xe494x10){var _0xe494x13=this,_0xe494xe=BABYLON[_0xc101[315]].Clone(function(){return new _0xe494x11.PBRBlendMaterial(_0xe494x10,_0xe494x13[_0xc101[178]]());},this);return _0xe494xe[_0xc101[223]]=_0xe494x10,_0xe494xe[_0xc101[316]]=_0xe494x10,_0xe494xe;},_0xe494xe[_0xc101[4]][_0xc101[318]]=function(){var _0xe494x21=BABYLON[_0xc101[315]].Serialize(this);_0xe494x21[_0xc101[319]]=_0xc101[161];return _0xe494x21;},_0xe494xe[_0xc101[320]]=function(_0xe494x22,_0xe494x23,_0xe494x24){return BABYLON[_0xc101[315]].Parse(function(){return new Zakeke.PBRMaterial(_0xe494x22[_0xc101[223]],_0xe494x23);},_0xe494x22,_0xe494x23,_0xe494x24);},_0xe494xe;}(BABYLON.PushMaterial);__decorate([BABYLON[_0xc101[322]](_0xc101[321])],_0xe494x13[_0xc101[4]],_0xc101[54],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[54])],_0xe494x13[_0xc101[4]],_0xc101[321],void 0),__decorate([BABYLON[_0xc101[322]](_0xc101[324])],_0xe494x13[_0xc101[4]],_0xc101[55],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[55])],_0xe494x13[_0xc101[4]],_0xc101[324],void 0),__decorate([BABYLON[_0xc101[322]](_0xc101[325])],_0xe494x13[_0xc101[4]],_0xc101[56],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[56])],_0xe494x13[_0xc101[4]],_0xc101[325],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[326])],_0xe494x13[_0xc101[4]],_0xc101[57],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[57])],_0xe494x13[_0xc101[4]],_0xc101[326],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[327])],_0xe494x13[_0xc101[4]],_0xc101[58],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[58])],_0xe494x13[_0xc101[4]],_0xc101[327],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[58])],_0xe494x13[_0xc101[4]],_0xc101[328],void 0),__decorate([BABYLON[_0xc101[322]](_0xc101[329])],_0xe494x13[_0xc101[4]],_0xc101[62],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[62])],_0xe494x13[_0xc101[4]],_0xc101[329],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[330])],_0xe494x13[_0xc101[4]],_0xc101[64],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[159],_0xc101[64])],_0xe494x13[_0xc101[4]],_0xc101[330],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[81])],_0xe494x13[_0xc101[4]],_0xc101[68],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[331])],_0xe494x13[_0xc101[4]],_0xc101[83],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[83])],_0xe494x13[_0xc101[4]],_0xc101[331],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[333])],_0xe494x13[_0xc101[4]],_0xc101[191],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[191])],_0xe494x13[_0xc101[4]],_0xc101[333],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[334])],_0xe494x13[_0xc101[4]],_0xc101[192],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[192])],_0xe494x13[_0xc101[4]],_0xc101[334],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[335])],_0xe494x13[_0xc101[4]],_0xc101[59],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[59])],_0xe494x13[_0xc101[4]],_0xc101[335],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[336])],_0xe494x13[_0xc101[4]],_0xc101[193],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[193])],_0xe494x13[_0xc101[4]],_0xc101[336],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[337])],_0xe494x13[_0xc101[4]],_0xc101[60],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[60])],_0xe494x13[_0xc101[4]],_0xc101[337],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[338])],_0xe494x13[_0xc101[4]],_0xc101[164],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[164])],_0xe494x13[_0xc101[4]],_0xc101[338],void 0),__decorate([BABYLON[_0xc101[340]](_0xc101[339])],_0xe494x13[_0xc101[4]],_0xc101[194],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[194])],_0xe494x13[_0xc101[4]],_0xc101[339],void 0),__decorate([BABYLON[_0xc101[340]](_0xc101[341])],_0xe494x13[_0xc101[4]],_0xc101[195],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[195])],_0xe494x13[_0xc101[4]],_0xc101[341],void 0),__decorate([BABYLON[_0xc101[340]](_0xc101[342])],_0xe494x13[_0xc101[4]],_0xc101[196],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[196])],_0xe494x13[_0xc101[4]],_0xc101[342],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[343])],_0xe494x13[_0xc101[4]],_0xc101[168],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[168])],_0xe494x13[_0xc101[4]],_0xc101[343],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[344])],_0xe494x13[_0xc101[4]],_0xc101[198],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[198])],_0xe494x13[_0xc101[4]],_0xc101[344],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[198])],_0xe494x13[_0xc101[4]],_0xc101[345],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[346])],_0xe494x13[_0xc101[4]],_0xc101[61],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[61])],_0xe494x13[_0xc101[4]],_0xc101[346],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[61])],_0xe494x13[_0xc101[4]],_0xc101[347],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[348])],_0xe494x13[_0xc101[4]],_0xc101[65],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[65])],_0xe494x13[_0xc101[4]],_0xc101[348],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[65])],_0xe494x13[_0xc101[4]],_0xc101[349],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[350])],_0xe494x13[_0xc101[4]],_0xc101[199],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[199])],_0xe494x13[_0xc101[4]],_0xc101[351],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[199])],_0xe494x13[_0xc101[4]],_0xc101[350],void 0),__decorate([BABYLON[_0xc101[332]](_0xc101[352])],_0xe494x13[_0xc101[4]],_0xc101[200],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[200])],_0xe494x13[_0xc101[4]],_0xc101[352],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[353])],_0xe494x13[_0xc101[4]],_0xc101[69],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[69])],_0xe494x13[_0xc101[4]],_0xc101[353],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[354])],_0xe494x13[_0xc101[4]],_0xc101[70],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[79],_0xc101[70])],_0xe494x13[_0xc101[4]],_0xc101[354],void 0),__decorate([BABYLON[_0xc101[356]](_0xc101[355])],_0xe494x13[_0xc101[4]],_0xc101[169],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[357],_0xc101[169])],_0xe494x13[_0xc101[4]],_0xc101[355],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[358])],_0xe494x13[_0xc101[4]],_0xc101[63],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[359],_0xc101[63])],_0xe494x13[_0xc101[4]],_0xc101[358],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[360])],_0xe494x13[_0xc101[4]],_0xc101[66],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[359],_0xc101[66])],_0xe494x13[_0xc101[4]],_0xc101[360],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[361])],_0xe494x13[_0xc101[4]],_0xc101[67],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[359],_0xc101[67])],_0xe494x13[_0xc101[4]],_0xc101[361],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[362])],_0xe494x13[_0xc101[4]],_0xc101[71],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[80],_0xc101[71])],_0xe494x13[_0xc101[4]],_0xc101[362],void 0),__decorate([BABYLON[_0xc101[318]](_0xc101[363])],_0xe494x13[_0xc101[4]],_0xc101[72],void 0),__decorate([BABYLON[_0xc101[323]](_0xc101[80],_0xc101[72])],_0xe494x13[_0xc101[4]],_0xc101[363],void 0),_0xe494x11[_0xc101[364]]=_0xe494x13,_0xe494x11[_0xc101[365]]=_0xe494x12;};}(Zakeke||(Zakeke={}));!function(_0xe494x11){_0xe494x11[_0xc101[12]][_0xc101[366]]=function(){_0xe494x11[_0xc101[12]].DefinePBRMaterial();};}(Zakeke||(Zakeke={}));Zakeke[_0xc101[17]]={zk_pbrPixelShader:_0xc101[367],zk_pbrVertexShader:_0xc101[368]};Zakeke[_0xc101[15]]={zk_n8Q2Bzi9LXc5p6RG:_0xc101[369],zk_pbrFragmentDeclaration:_0xc101[370],zk_pbrLightFragmentDeclaration:_0xc101[371],zk_w8NZg34MyJx59GeB:_0xc101[372],zk_Dp84Pxj2MTr7q6FW:_0xc101[373],zk_pbrLightUboDeclaration:_0xc101[374],zk_g9X4Qdz2LJb67MyT:_0xc101[375],zk_Ar2w4FRs58Jpc3W6:_0xc101[376],zk_Gi39AdTg7y5B2JfL:_0xc101[377],zk_pbrVertexDeclaration:_0xc101[378],zk_pbrUboDeclaration:_0xc101[379]};